<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.6.0"/>
    <title>NTdatasets.sensory_base API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../NTdatasets.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;NTdatasets</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#SensoryBase">SensoryBase</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SensoryBase.__init__">SensoryBase</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.datadir">datadir</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.filenames">filenames</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.device">device</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.trial_sample">trial_sample</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.num_lags">num_lags</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.stim_dims">stim_dims</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.time_embed">time_embed</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.preload">preload</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.drift_interval">drift_interval</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.SUs">SUs</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.NC">NC</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.block_inds">block_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.block_filemapping">block_filemapping</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.include_MUs">include_MUs</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.SUinds">SUinds</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.MUinds">MUinds</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.cells_out">cells_out</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.robs_out">robs_out</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.dfs_out">dfs_out</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.avRs">avRs</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.test_inds">test_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.val_inds">val_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.train_inds">train_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.test_blks">test_blks</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.val_blks">val_blks</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.train_blks">train_blks</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.used_inds">used_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.speckled">speckled</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.Xdrift">Xdrift</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.stim">stim</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.dfs">dfs</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.robs">robs</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.NT">NT</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.covariates">covariates</a>
                        </li>
                        <li>
                                <a class="variable" href="#SensoryBase.cov_dims">cov_dims</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.add_covariate">add_covariate</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.append_covariates">append_covariates</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.prepare_stim">prepare_stim</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.set_cells">set_cells</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.time_embedding">time_embedding</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.construct_drift_design_matrix">construct_drift_design_matrix</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.trial_psths">trial_psths</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.construct_LVtents">construct_LVtents</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.setup_trial_LVs">setup_trial_LVs</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.setup_LVLayer_input">setup_LVLayer_input</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.design_matrix_drift">design_matrix_drift</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.construct_onehot_design_matrix">construct_onehot_design_matrix</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.avrates">avrates</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.crossval_setup">crossval_setup</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.fold_sample">fold_sample</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.speckledXV_setup">speckledXV_setup</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.set_speckledXV">set_speckledXV</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.make_data_dicts">make_data_dicts</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.get_max_samples">get_max_samples</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.assemble_stimulus">assemble_stimulus</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.is_int">is_int</a>
                        </li>
                        <li>
                                <a class="function" href="#SensoryBase.index_to_array">index_to_array</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../NTdatasets.html">NTdatasets</a><wbr>.sensory_base    </h1>

                
                        <input id="mod-sensory_base-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-sensory_base-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">sio</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">import</span> <span class="nn">NDNT.utils</span> <span class="k">as</span> <span class="nn">utils</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="c1">#from NDNT.utils import download_file, ensure_dir</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">import</span> <span class="nn">h5py</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="k">class</span> <span class="nc">SensoryBase</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Parent class meant to hold standard variables and functions used by general sensory datasets</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="sd">    </span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">    General consistent formatting:</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">    -- self.robs, dfs, and any design matrices are generated as torch vectors on device</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">    -- stimuli are imported separately as dataset-specific numpy arrays, and but then prepared into </span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">        self.stim (tensor) by a function self.prepare_stim, which must be overloaded</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">    -- self.stim_dims gives the dimension of self.stim in 4-dimensional format</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">    -- all tensors are stored on default device (cpu)</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">    General book-keeping variables</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">    -- self.block_inds is empty but must be filled in by specific datasets</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>        <span class="n">filenames</span><span class="p">,</span> <span class="c1"># this could be single filename or list of filenames, to be processed in specific way</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>        <span class="n">datadir</span><span class="p">,</span> 
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>        <span class="c1"># Stim setup</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>        <span class="n">trial_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>        <span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>        <span class="n">time_embed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>        <span class="c1">#maxT = None,</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>        <span class="c1"># other</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>        <span class="n">include_MUs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>        <span class="n">drift_interval</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>        <span class="p">):</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">        Constructor options</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">        </span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">        Args:</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">            filenames: the filenames to use</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">            datadir: the data directory</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">            trial_sample: whether to sample trials</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">            num_lags: the number of lags to use</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">            time_embed: the time embedding to use</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">            include_MUs: whether to include MUs</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">            drift_interval: the drift interval to use</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">            device: the device to use</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">datadir</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="n">filenames</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>        
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trial_sample</span> <span class="o">=</span> <span class="n">trial_sample</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span> <span class="o">=</span> <span class="n">num_lags</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">=</span> <span class="n">time_embed</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preload</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span> <span class="o">=</span> <span class="n">drift_interval</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>        <span class="c1"># Assign standard variables</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_SUs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_MUs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">=</span> <span class="mi">0</span>    
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_filemapping</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span> <span class="o">=</span> <span class="n">include_MUs</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">SUinds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">MUinds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># can be list to output specific cells in get_item</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>        <span class="c1"># Set up to store default train_, val_, test_inds</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">speckled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mval</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>  <span class="c1"># Data-filter masks for speckled XV</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mval_out</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>  <span class="c1"># Data-filter masks for speckled XV</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>        
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>        <span class="c1"># Basic default memory things</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>    
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>        <span class="c1"># Additional covariate list</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cov_dims</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>        <span class="c1"># General file i/o -- this is not general, so taking out</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>        <span class="c1">#self.fhandles = [h5py.File(os.path.join(datadir, sess + &#39;.mat&#39;), &#39;r&#39;) for sess in self.sess_list]</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>            
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>    <span class="c1"># END SensoryBase.__init__</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>    <span class="k">def</span> <span class="nf">add_covariate</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cov_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="sd">        Adds a covariate to the dataset</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a><span class="sd">        Args:</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">            cov_name: name of the covariate</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="sd">            cov: the covariate itself</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">        Returns:</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="sd">            None</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>        <span class="k">assert</span> <span class="n">cov_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need cov_name&quot;</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>        <span class="k">assert</span> <span class="n">cov</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Missing cov&quot;</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>            <span class="n">cov</span> <span class="o">=</span> <span class="n">cov</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>            <span class="n">dims</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>                <span class="n">dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>            <span class="n">cov</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">dims</span><span class="p">)])</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>            <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">==</span> <span class="n">NT</span><span class="p">,</span> <span class="s2">&quot;Wrong number of time points&quot;</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>        <span class="k">if</span> <span class="n">cov_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">:</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Discarding old&#39;</span><span class="p">,</span> <span class="n">cov_name</span><span class="p">)</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">[</span><span class="n">cov_name</span><span class="p">]</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cov_dims</span><span class="p">[</span><span class="n">cov_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dims</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">[</span><span class="n">cov_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">[</span><span class="n">cov_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>    <span class="c1"># END SensoryBase.add_covariate()</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>    <span class="k">def</span> <span class="nf">append_covariates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">idx</span> <span class="p">):</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="sd">        Complements __get_item__ to add covariates to existing dictionary</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="sd">        </span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="sd">        Args:</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="sd">            out: the dictionary to append to</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">            idx: the index to append at</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a><span class="sd">        Returns:</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a><span class="sd">            None</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>        <span class="k">for</span> <span class="n">cov_name</span><span class="p">,</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>            <span class="n">out</span><span class="p">[</span><span class="n">cov_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>        <span class="c1"># Return out, or not?</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>    <span class="k">def</span> <span class="nf">prepare_stim</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a><span class="sd">        This function is meant to be overloaded by child classes</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a><span class="sd">        Returns:</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a><span class="sd">            None</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Default prepare stimulus method.&#39;</span><span class="p">)</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>    <span class="k">def</span> <span class="nf">set_cells</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cell_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a><span class="sd">        Set outputs to potentially limit robs/dfs to certain cells </span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a><span class="sd">        This sets cells_out but also constructs efficient data structures</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a><span class="sd">        </span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a><span class="sd">        Args:</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a><span class="sd">            cell_list: list of cells to output</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a><span class="sd">            verbose: whether to print out the number of cells</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a><span class="sd">        Returns:</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a><span class="sd">            None</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>        <span class="k">if</span> <span class="n">cell_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>            <span class="c1"># Then reset to full list</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Mval_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Reset cells_out to full dataset (</span><span class="si">%d</span><span class="s2"> cells).&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="p">)</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>                <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_int</span><span class="p">(</span><span class="n">cell_list</span><span class="p">):</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>                    <span class="n">cell_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell_list</span><span class="p">]</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>                    <span class="n">cell_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cell_list</span><span class="p">)</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cell_list</span><span class="p">))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="s2">&quot;ERROR: cell_list too high.&quot;</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Output set to </span><span class="si">%d</span><span class="s2"> cells&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">cell_list</span><span class="p">))</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="o">=</span> <span class="n">cell_list</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="n">cell_list</span><span class="p">])</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cell_list</span><span class="p">])</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span><span class="p">[:,</span> <span class="n">cell_list</span><span class="p">])</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mval_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Mval</span><span class="p">[:,</span> <span class="n">cell_list</span><span class="p">])</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>    <span class="c1"># END SensoryBase.set_cells()</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>    <span class="k">def</span> <span class="nf">time_embedding</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a><span class="sd">        Assume all stim dimensions are flattened into single dimension. </span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a><span class="sd">        Will only act on self.stim if &#39;stim&#39; argument is left None</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a><span class="sd">        </span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a><span class="sd">        Args:</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a><span class="sd">            stim: the stimulus to time-embed</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a><span class="sd">            nlags: the number of lags to use</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a><span class="sd">            verbose: whether to print out the time embedding process</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a><span class="sd">        Returns:</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a><span class="sd">            tmp_stim: the time-embedded stimulus</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>        <span class="k">if</span> <span class="n">nlags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>            <span class="n">nlags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>        <span class="k">if</span> <span class="n">stim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to assemble stim before time-embedding.&quot;</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># should only time-embed stim by default, but not all the time</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlags</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>                <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">stim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>                <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a> 
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Time embedding...&quot;</span> <span class="p">)</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>        <span class="n">original_dims</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>            <span class="n">original_dims</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Time embed: flattening stimulus from&quot;</span><span class="p">,</span> <span class="n">original_dims</span><span class="p">)</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>        <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># automatically generates 2-dimensional stim</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>        <span class="c1">#assert self.NT == NT, &quot;TIME EMBEDDING: stim length mismatch&quot;</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>        <span class="c1"># Actual time-embedding itself</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>        <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nlags</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>        <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="o">.</span><span class="n">permute</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Done.&quot;</span><span class="p">)</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>        <span class="k">return</span> <span class="n">tmp_stim</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>    <span class="c1"># END SensoryBase.time_embedding()</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>    <span class="k">def</span> <span class="nf">construct_drift_design_matrix</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">block_anchors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a><span class="sd">        Note this requires self.block_inds, and either uses self.drift_interval or block_anchors</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a><span class="sd">        </span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a><span class="sd">        Args:</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a><span class="sd">            block_anchors: the block anchors to use</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a><span class="sd">            </span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a><span class="sd">        Returns:</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a><span class="sd">            None</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need block_inds defined as an internal variable&quot;</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>        <span class="k">if</span> <span class="n">block_anchors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>            <span class="n">NBL</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>                <span class="k">return</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>            <span class="n">block_anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NBL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span><span class="p">)</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>        <span class="n">Nanchors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">block_anchors</span><span class="p">)</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>        <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>        <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">):</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>            <span class="n">anchors</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">block_anchors</span><span class="p">[</span><span class="n">bb</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>        
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">anchors</span> <span class="o">=</span> <span class="n">anchors</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> 
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>            <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>    <span class="c1"># END SenspryBase.construct_drift_design_matrix()</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>    <span class="k">def</span> <span class="nf">trial_psths</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">trials</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trial_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a><span class="sd">        Computes average firing rate of cells_out at bin-resolution, averaged across trials</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a><span class="sd">        given in block_inds</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a><span class="sd">        </span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a><span class="sd">        Args:</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a><span class="sd">            trials: the trials to compute the PSTHs for</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a><span class="sd">            R: the firing rates to use</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a><span class="sd">            trial_size: the size of the trials</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a><span class="sd">            verbose: whether to print out the trial sizes</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a><span class="sd">        Returns:</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a><span class="sd">            psths: the PSTHs</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>        <span class="n">Ntr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>        <span class="k">assert</span> <span class="n">Ntr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Cannot compute PSTHs without block_inds established in dataset.&quot;</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>            <span class="n">ccs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>            <span class="n">ccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">)</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>        <span class="k">if</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ccs</span><span class="p">):</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">ccs</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Ignoring dfs.&#39;</span><span class="p">)</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>        <span class="k">if</span> <span class="n">R</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1">#then use [internal] Robs</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>            <span class="n">R</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="n">ccs</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="p">)</span>  
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>            <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>         
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>        <span class="n">num_psths</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># otherwise use existing input</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>        <span class="c1"># Compute median trial size</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>        <span class="k">if</span> <span class="n">trial_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>            <span class="c1"># select median trial size, but look at all</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>            <span class="n">tr_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">))</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntr</span><span class="p">):</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>                <span class="n">tr_sizes</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">])</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">tr_sizes</span><span class="p">))</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Trial lengths: Min </span><span class="si">%d</span><span class="s2">, Max </span><span class="si">%d</span><span class="s2">, Median </span><span class="si">%d</span><span class="s2">. Selecting median.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tr_sizes</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tr_sizes</span><span class="p">),</span> <span class="n">T</span><span class="p">))</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>        <span class="k">if</span> <span class="n">trials</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>            <span class="n">trials</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Ntr</span><span class="p">)</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>        <span class="n">psths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">T</span><span class="p">,</span> <span class="n">num_psths</span><span class="p">])</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>        <span class="n">df_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">T</span><span class="p">,</span> <span class="n">num_psths</span><span class="p">])</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">trials</span><span class="p">:</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">T</span><span class="p">:</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>                    <span class="n">trT</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>                <span class="k">else</span><span class="p">:</span> 
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>                    <span class="n">trT</span> <span class="o">=</span> <span class="n">T</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>                <span class="n">psths</span><span class="p">[:</span><span class="n">trT</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">R</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][:</span><span class="n">trT</span><span class="p">],</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][:</span><span class="n">trT</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>                <span class="n">df_count</span><span class="p">[:</span><span class="n">trT</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][:</span><span class="n">trT</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>            
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>            <span class="n">psths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span> <span class="n">psths</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">df_count</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>        <span class="k">return</span> <span class="n">psths</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>    <span class="c1"># END SensoryBase.calculate_psths()</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>    <span class="k">def</span> <span class="nf">construct_LVtents</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">tent_spacing</span><span class="o">=</span><span class="mi">12</span> <span class="p">):</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a><span class="sd">        Constructs tent-basis-style trial-based tent function</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a><span class="sd">        </span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a><span class="sd">        Args: </span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a><span class="sd">            tent_spacing: the spacing of the tent functions</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a><span class="sd">        Returns:</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a><span class="sd">            XLV: the design matrix</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a><span class="sd">            LVdims: the dimensions of the design matrix</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>        
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>            <span class="c1"># Compute minimum and maximum trial size</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>            <span class="n">Ntr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>            <span class="n">min_trial_size</span><span class="p">,</span> <span class="n">max_trial_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">0</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntr</span><span class="p">):</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">min_trial_size</span><span class="p">:</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>                    <span class="n">min_trial_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">max_trial_size</span><span class="p">:</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>                    <span class="n">max_trial_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>                    
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>            <span class="k">if</span> <span class="n">tent_spacing</span> <span class="o">&gt;</span> <span class="n">min_trial_size</span><span class="p">:</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using one LV per trial&#39;</span><span class="p">)</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>                <span class="n">XLV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">Ntr</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>                <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntr</span><span class="p">):</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>                    <span class="n">XLV</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">tr</span><span class="p">],</span> <span class="n">tr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>                <span class="n">LVdims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">Ntr</span><span class="p">]</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>                <span class="c1"># automatically wont have any anchors past min_trial_size</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>                <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_trial_size</span><span class="p">,</span> <span class="n">tent_spacing</span><span class="p">)</span> 
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>                <span class="c1"># Generate master tent_basis</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>                <span class="n">trial_tents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>                    <span class="n">max_trial_size</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zero_right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>                <span class="n">num_tents_tr</span> <span class="o">=</span> <span class="n">trial_tents</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>                <span class="n">num_tents</span> <span class="o">=</span> <span class="n">num_tents_tr</span> <span class="o">*</span> <span class="n">Ntr</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>                <span class="n">LVdims</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ntr</span><span class="p">,</span> <span class="n">num_tents_tr</span><span class="p">]</span> 
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>                <span class="n">XLV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">num_tents</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>                <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntr</span><span class="p">):</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>                    <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">tr</span><span class="p">])</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>                    <span class="n">vslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">L</span><span class="p">,</span> <span class="n">num_tents</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>                    <span class="n">vslice</span><span class="p">[:,</span> <span class="n">tr</span><span class="o">*</span><span class="n">num_tents_tr</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_tents_tr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">trial_tents</span><span class="p">[:</span><span class="n">L</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>                    <span class="n">XLV</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">tr</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">vslice</span><span class="p">)</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>            <span class="c1">#print(&#39;Trial-less LV setup not implemented yet, but should be easy.&#39;</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>            <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">tent_spacing</span><span class="p">)</span> 
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>            <span class="n">XLV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>                <span class="n">max_trial_size</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zero_right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>            <span class="n">num_tents</span> <span class="o">=</span> <span class="n">XLV</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>            <span class="n">LVdims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_tents</span><span class="p">]</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>        <span class="k">return</span> <span class="n">XLV</span><span class="p">,</span> <span class="n">LVdims</span>  <span class="c1"># numpy array</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>    <span class="c1"># END SensoryBase.construct_LVtents()</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>    
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>    <span class="k">def</span> <span class="nf">setup_trial_LVs</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="sd">        Usage: XLV = dataset.setup_trial_LVs()</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a><span class="sd">        </span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a><span class="sd">        This makes design matrix as input for LVlayer (indexed LV for each trial) and outputs X, LVdims </span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a><span class="sd">        to actually figure out which LVs correspond to which trial, once it is done</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a><span class="sd">        Returns:</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a><span class="sd">            X: the design matrix</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>        <span class="n">num_trials</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>        <span class="c1"># LVs indexed 0-num_trials</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_trials</span><span class="p">):</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>            <span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ii</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>        <span class="k">return</span> <span class="n">X</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>    <span class="c1"># END SensoryBase.setup_trial_LVs()</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>    <span class="k">def</span> <span class="nf">setup_LVLayer_input</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">tent_spacing</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">trsize</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a><span class="sd">        Usage: X, filter_dims = data.setup_LVLayer_input( tent_spacing=10, trsize=None)</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a><span class="sd">        Sets up tent-basis-input to LVLayer (part of NDNT code)</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a><span class="sd">        This preserves all data by using multiple effective trials for long trials. </span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a><span class="sd">        Args:</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a><span class="sd">            tent_spacing: the spacing of the tent functions</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a><span class="sd">            trsize: the size of the trials</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>        <span class="c1"># Determine trial_size</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>        <span class="n">Ntr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>        <span class="n">trsizes</span><span class="o">=</span><span class="p">[]</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntr</span><span class="p">):</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>            <span class="n">trsizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>        <span class="k">if</span> <span class="n">trsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>            <span class="n">L0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">trsizes</span><span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>        <span class="n">ramp_down</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tent_spacing</span><span class="p">))</span><span class="o">/</span><span class="n">tent_spacing</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>        <span class="n">NW0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">L0</span><span class="o">/</span><span class="n">tent_spacing</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>  <span class="c1"># how many LVs in standard trial</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Trial size = </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2"> LV indices per trial&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">L0</span><span class="p">,</span> <span class="n">NW0</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>        <span class="n">Ntr_eff</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>        <span class="n">LVindex_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntr</span><span class="p">):</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>            <span class="n">NLVts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">tent_spacing</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># this gets one on edge, given partials are pegged at 1</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>            <span class="n">assigned_LVs_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NLVts</span><span class="p">)</span> <span class="o">+</span> <span class="n">LVindex_count</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>            
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>            <span class="c1"># Map these LVs </span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>            <span class="n">X</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">assigned_LVs_inds</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tent_spacing</span><span class="p">)[:</span><span class="n">L</span><span class="p">]</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>            <span class="n">X</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">assigned_LVs_inds</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">tent_spacing</span><span class="p">)[:</span><span class="n">L</span><span class="p">]</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>            <span class="n">X</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">ramp_down</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">tent_spacing</span><span class="p">)))[:</span><span class="n">L</span><span class="p">]</span>  <span class="c1"># this will leave the last bit ones</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>            
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>            <span class="c1"># Need to do multiples of trial length so that smoothing works</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>            <span class="n">num_trial_blocks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">L0</span><span class="p">))</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>            <span class="n">LVindex_count</span> <span class="o">+=</span> <span class="n">num_trial_blocks</span> <span class="o">*</span> <span class="n">NW0</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>            <span class="n">Ntr_eff</span> <span class="o">+=</span> <span class="n">num_trial_blocks</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>            
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>        <span class="n">filter_dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ntr_eff</span><span class="p">,</span> <span class="n">NW0</span><span class="p">]</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> time points, </span><span class="si">%d</span><span class="s2"> LV indices&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">LVindex_count</span><span class="p">))</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">filter_dims</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>        <span class="c1"># END SensoryBase.setup_LVLayer_input()</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>    <span class="k">def</span> <span class="nf">design_matrix_drift</span><span class="p">(</span> <span class="n">NT</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">zero_right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">to_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a><span class="sd">        Produce a design matrix based on continuous data (s) and anchor points for a tent_basis.</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a><span class="sd">        Here s is a continuous variable (e.g., a stimulus) that is function of time -- single dimension --</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a><span class="sd">        and this will generate apply a tent basis set to s with a basis variable for each anchor point. </span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a><span class="sd">        The end anchor points will be one-sided, but these can be dropped by changing &quot;zero_left&quot; and/or</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a><span class="sd">        &quot;zero_right&quot; into &quot;True&quot;.</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a><span class="sd">        Args: </span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a><span class="sd">            NT: length of design matrix</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a><span class="sd">            anchors: list or array of anchor points for tent-basis set</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a><span class="sd">            zero_left, zero_right: boolean whether to drop the edge bases (default for both is False)</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a><span class="sd">            const_left, const_right: boolean whether to make constant basis on left/right (default for both is False)</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a><span class="sd">            to_plot: whether to plot the design matrix</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a><span class="sd">        </span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a><span class="sd">        Returns:</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a><span class="sd">            X: design matrix that will be NT x the number of anchors left after zeroing out left and right</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>        <span class="n">anchors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>        <span class="k">if</span> <span class="n">anchors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">const_left</span><span class="p">:</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>                <span class="n">anchors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">anchors</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>        <span class="c1">#if anchors[-1] &lt; NT:</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>        <span class="c1">#    anchors = anchors + [NT]</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>        <span class="n">NA</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NT</span><span class="p">,</span> <span class="n">NA</span><span class="p">])</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>        <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NA</span><span class="p">):</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>            <span class="k">if</span> <span class="n">aa</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>                <span class="n">dx</span> <span class="o">=</span> <span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="p">]</span><span class="o">-</span><span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>                <span class="n">X</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="p">]),</span> <span class="n">aa</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>            <span class="k">if</span> <span class="n">aa</span> <span class="o">&lt;</span> <span class="n">NA</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>                <span class="n">dx</span> <span class="o">=</span> <span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="p">]</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>                <span class="n">X</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="p">],</span> <span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span> <span class="n">aa</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>        <span class="k">if</span> <span class="n">zero_left</span><span class="p">:</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>        <span class="k">elif</span> <span class="n">const_left</span><span class="p">:</span>  <span class="c1"># makes constant from first anchor back to origin -- wont work without zero-left</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>            <span class="n">X</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">anchors</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>        <span class="k">if</span> <span class="n">const_right</span><span class="p">:</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>            <span class="n">X</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">anchors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">NT</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>        <span class="k">if</span> <span class="n">zero_right</span><span class="p">:</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>        <span class="k">if</span> <span class="n">to_plot</span><span class="p">:</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>        <span class="k">return</span> <span class="n">X</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>    
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>    <span class="k">def</span> <span class="nf">construct_onehot_design_matrix</span><span class="p">(</span> <span class="n">stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_categories</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a><span class="sd">        Construct one-hot design matrix from stimulus.</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a><span class="sd">        The stimulus should be numpy -- not meant to be used with torch currently.</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a><span class="sd">        </span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a><span class="sd">        Args:</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a><span class="sd">            stim: the stimulus to construct one-hot design matrix from</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a><span class="sd">            return_categories: whether to return the categories</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a><span class="sd">        Returns:</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a><span class="sd">            OHmatrix: the one-hot design matrix</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>        <span class="k">assert</span> <span class="n">stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must pass in stimulus&quot;</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;Stimulus must be one-dimensional&quot;</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">stim</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="p">),</span> <span class="s2">&quot;stim must be a numpy array&quot;</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>        <span class="n">category_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>        <span class="n">NSTIM</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">category_list</span><span class="p">)</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>        <span class="k">assert</span> <span class="n">NSTIM</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;Must have less than 50 classifications in one-hot: something wrong?&quot;</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>        <span class="n">OHmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">NSTIM</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>        <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NSTIM</span><span class="p">):</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>            <span class="n">OHmatrix</span><span class="p">[</span><span class="n">stim</span> <span class="o">==</span> <span class="n">category_list</span><span class="p">[</span><span class="n">ss</span><span class="p">],</span> <span class="n">ss</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>        
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>        <span class="k">if</span> <span class="n">return_categories</span><span class="p">:</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>            <span class="k">return</span> <span class="n">OHmatrix</span><span class="p">,</span> <span class="n">category_list</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>            <span class="k">return</span> <span class="n">OHmatrix</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>    <span class="c1"># END staticmethod.construct_onehot_design_matrix()</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>    <span class="k">def</span> <span class="nf">avrates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a><span class="sd">        Calculates average firing probability across specified inds (or whole dataset)</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a><span class="sd">        -- Note will respect datafilters</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a><span class="sd">        -- will return precalc value to save time if already stored</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a><span class="sd">        Args:</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a><span class="sd">            inds: the indices to calculate the average firing probability across</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a><span class="sd">        Returns:</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a><span class="sd">            avRs: the average firing probability</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>            <span class="n">cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">)</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>            <span class="n">cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>            <span class="c1"># then calculate across whole dataset</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>                <span class="c1"># then precalculated and do not need to do</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span><span class="p">[</span><span class="n">cells</span><span class="p">]</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>        <span class="c1"># Otherwise calculate across all data</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>            <span class="n">Reff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>            <span class="n">Teff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="o">/</span><span class="n">Teff</span><span class="p">)[</span><span class="n">cells</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Still need to implement avRs without preloading&#39;</span><span class="p">)</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>    <span class="c1"># END .avrates()</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>    <span class="k">def</span> <span class="nf">crossval_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test_set</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a><span class="sd">        This sets the cross-validation indices up We can add featuers here. Many ways to do this</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a><span class="sd">        but will stick to some standard for now. It sets the internal indices, which can be read out</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a><span class="sd">        directly or with helper functions. Perhaps helper_functions is the best way....</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a><span class="sd">        </span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a><span class="sd">        Args:</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a><span class="sd">            folds: the number of folds to use</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a><span class="sd">            test_set: whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a><span class="sd">            verbose: whether to print out the number of fixations in each set</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a><span class="sd">        Returns:</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a><span class="sd">            None: sets internal variables test_inds, train_inds, val_inds</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must first specify valid_indices before setting up cross-validation.&quot;</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>        <span class="c1"># Reflect block structure</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>        <span class="n">Nblks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>        <span class="n">val_blk1</span><span class="p">,</span> <span class="n">tr_blk1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="n">Nblks</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>        <span class="k">if</span> <span class="n">test_set</span><span class="p">:</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="n">val_blk1</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>            <span class="n">val_blk2</span><span class="p">,</span> <span class="n">tr_blk2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_blk1</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span><span class="p">[</span><span class="n">val_blk2</span><span class="p">]</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span><span class="p">[</span><span class="n">tr_blk2</span><span class="p">]</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">val_blk1</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Partitioned </span><span class="si">%d</span><span class="s2"> fixations total: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>                <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">)))</span>  
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>        <span class="c1"># Now pull indices from each saccade </span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>        <span class="n">tr_inds</span><span class="p">,</span> <span class="n">te_inds</span><span class="p">,</span> <span class="n">val_inds</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">:</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>            <span class="n">tr_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">:</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>            <span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">:</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>            <span class="n">te_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Pre-valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">te_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>        <span class="c1"># Finally intersect with used_inds</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">val_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">te_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">tr_inds</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">val_inds</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">te_inds</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>            
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>        <span class="c1"># make the inds and blks into numpy arrays</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">)</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">)</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span><span class="p">)</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">)</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">)</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">)</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>        
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>    <span class="c1"># END SensoryBase.crossval_setup</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>    <span class="k">def</span> <span class="nf">fold_sample</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">which_fold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a><span class="sd">        This really should be a general method not associated with self</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a><span class="sd">        </span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a><span class="sd">        Args:</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a><span class="sd">            num_items: the number of items to sample</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a><span class="sd">            folds: the number of folds to use</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a><span class="sd">            which_fold: which fold to use</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a><span class="sd">        Returns:</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a><span class="sd">            val_items: the validation items</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a><span class="sd">            rem_items: the remaining items</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>        <span class="k">if</span> <span class="n">random_gen</span><span class="p">:</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>            <span class="n">num_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_items</span><span class="o">/</span><span class="n">folds</span><span class="p">)</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>            <span class="n">tmp_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">num_items</span><span class="p">)</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[:</span><span class="n">num_val</span><span class="p">])</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[</span><span class="n">num_val</span><span class="p">:])</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>            <span class="k">if</span> <span class="n">which_fold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>                <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">folds</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>                <span class="n">offset</span> <span class="o">=</span> <span class="n">which_fold</span><span class="o">%</span><span class="n">folds</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">val_items</span><span class="p">)</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>        <span class="k">return</span> <span class="n">val_items</span><span class="p">,</span> <span class="n">rem_items</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>    <span class="k">def</span> <span class="nf">speckledXV_setup</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a><span class="sd">        Produce data-filter masks for training and XV speckles</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a><span class="sd">        Will be produced for whole dataset, and must be reduced if cells_out used</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a><span class="sd">        Args:</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a><span class="sd">            folds: the number of folds to use</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a><span class="sd">        Returns:</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a><span class="sd">            None</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a>        <span class="n">Ntr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a>        <span class="c1"># Choose trials to leave out for each unit</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Mval</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a>        <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">):</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>            <span class="n">ival</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span> 
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>                <span class="n">Ntr</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">,</span> <span class="n">which_fold</span><span class="o">=</span><span class="n">cc</span><span class="o">%</span><span class="n">folds</span><span class="p">)</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>            <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">ival</span><span class="p">:</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mval</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">tr</span><span class="p">],</span> <span class="n">cc</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">tr</span><span class="p">],</span> <span class="n">cc</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">])</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Mval_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Mval</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">])</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a>    <span class="c1"># END SensoryBase.speckledXV_setup</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>    
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a>    <span class="k">def</span> <span class="nf">set_speckledXV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a><span class="sd">        Set up speckled cross-validation with data-filter masks</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a><span class="sd">        Args:</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a><span class="sd">            val: whether to set up speckled cross-validation</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a><span class="sd">            folds: the number of folds to use</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a><span class="sd">        Returns:</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a><span class="sd">            None</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">speckled</span> <span class="o">=</span> <span class="n">val</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>        <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">speckledXV_setup</span><span class="p">(</span><span class="n">folds</span><span class="o">=</span><span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span> 
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mval_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mval</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mval_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a>    <span class="c1"># END SensoryBase.set_speckledXV</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a>    <span class="k">def</span> <span class="nf">make_data_dicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a><span class="sd">        Usage: train_ds, val_ds = dataset.make_data_dicts( device=None, all=False )</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a><span class="sd">        </span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a><span class="sd">        Produce generic datasets on device of choice</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a><span class="sd">        device defaults to cuda-0</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a><span class="sd">        If &lt;all&gt; is True, then will make single dataset without XVal</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a><span class="sd">        Args:</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a><span class="sd">            device: the device to put the datasets on</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a><span class="sd">            all: whether to use all data</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a><span class="sd">        </span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a><span class="sd">        Returns:</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a><span class="sd">            train_ds: the training dataset</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a><span class="sd">            val_ds: the validation dataset</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a>        <span class="kn">from</span> <span class="nn">NTdatasets.generic</span> <span class="kn">import</span> <span class="n">GenericDataset</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a>        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Datasets will be on cuda:0&#39;</span><span class="p">)</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speckled</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">:</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a>            <span class="n">trn_inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a>            <span class="n">val_inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_sample</span><span class="p">,</span> <span class="s2">&quot;trial-sample will not work with generic datasets&quot;</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a>            <span class="n">trn_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a>            <span class="n">val_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a>
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a>        <span class="n">ks</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a>        <span class="n">dictTRN</span><span class="p">,</span> <span class="n">dictVAL</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ks</span><span class="p">:</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">,</span> <span class="s1">&#39;Mtrn&#39;</span><span class="p">,</span> <span class="s1">&#39;Mval&#39;</span><span class="p">]):</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a>                <span class="n">dictTRN</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">trn_inds</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a>                <span class="n">dictVAL</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">val_inds</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a>        <span class="k">if</span> <span class="nb">all</span><span class="p">:</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a>            <span class="n">dictTRN</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:][</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speckled</span><span class="p">:</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a>                <span class="k">assert</span> <span class="p">(</span><span class="s1">&#39;Mtrn&#39;</span> <span class="ow">in</span> <span class="n">ks</span><span class="p">),</span> <span class="s2">&quot;speckled not set on dataset&quot;</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a>                <span class="n">dictTRN</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:][</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[:][</span><span class="s1">&#39;Mtrn&#39;</span><span class="p">]</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a>                <span class="n">dictVAL</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:][</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[:][</span><span class="s1">&#39;Mval&#39;</span><span class="p">]</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos">781</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos">782</span></a>                <span class="n">dictTRN</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">trn_inds</span><span class="p">][</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos">783</span></a>                <span class="n">dictVAL</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">val_inds</span><span class="p">][</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos">784</span></a>
</span><span id="L-785"><a href="#L-785"><span class="linenos">785</span></a>        <span class="n">train_ds</span> <span class="o">=</span> <span class="n">GenericDataset</span><span class="p">(</span> <span class="n">dictTRN</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span> <span class="p">)</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos">786</span></a>        <span class="k">if</span> <span class="nb">all</span><span class="p">:</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos">787</span></a>            <span class="k">return</span> <span class="n">train_ds</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos">788</span></a>
</span><span id="L-789"><a href="#L-789"><span class="linenos">789</span></a>        <span class="n">val_ds</span> <span class="o">=</span> <span class="n">GenericDataset</span><span class="p">(</span> <span class="n">dictVAL</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span> <span class="p">)</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos">790</span></a>        <span class="k">return</span> <span class="n">train_ds</span><span class="p">,</span> <span class="n">val_ds</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos">791</span></a>    <span class="c1"># END SensoryBase.make_data_dicts()</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos">792</span></a>
</span><span id="L-793"><a href="#L-793"><span class="linenos">793</span></a>    <span class="k">def</span> <span class="nf">get_max_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpu_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nquad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mf">1.2</span><span class="p">):</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos">794</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos">795</span></a><span class="sd">        get the maximum number of samples that fit in memory -- for GLM/GQM x LBFGS</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos">796</span></a>
</span><span id="L-797"><a href="#L-797"><span class="linenos">797</span></a><span class="sd">        Args:</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos">798</span></a><span class="sd">            gpu_n: the gpu number to use</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos">799</span></a><span class="sd">            history_size: the history size</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos">800</span></a><span class="sd">            nquad: the number of quadrature points</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos">801</span></a><span class="sd">            num_cells: the number of cells to use</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos">802</span></a><span class="sd">            buffer: the buffer to use</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos">803</span></a>
</span><span id="L-804"><a href="#L-804"><span class="linenos">804</span></a><span class="sd">        Returns:</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos">805</span></a><span class="sd">            maxsamples: the maximum number of samples that fit in memory</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos">806</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos">807</span></a>        <span class="k">if</span> <span class="n">gpu_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos">808</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos">809</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos">810</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:1&#39;</span><span class="p">)</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos">811</span></a>
</span><span id="L-812"><a href="#L-812"><span class="linenos">812</span></a>        <span class="k">if</span> <span class="n">num_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos">813</span></a>            <span class="n">num_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos">814</span></a>        
</span><span id="L-815"><a href="#L-815"><span class="linenos">815</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">total_memory</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos">816</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_reserved</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos">817</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_allocated</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos">818</span></a>        <span class="n">free</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos">819</span></a>
</span><span id="L-820"><a href="#L-820"><span class="linenos">820</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos">821</span></a>        <span class="n">mempersample</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos">822</span></a>    
</span><span id="L-823"><a href="#L-823"><span class="linenos">823</span></a>        <span class="n">mempercell</span> <span class="o">=</span> <span class="n">mempersample</span> <span class="o">*</span> <span class="p">(</span><span class="n">nquad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">history_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos">824</span></a>        <span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">*</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos">825</span></a>
</span><span id="L-826"><a href="#L-826"><span class="linenos">826</span></a>        <span class="n">maxsamples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">free</span> <span class="o">-</span> <span class="n">mempercell</span><span class="o">*</span><span class="n">num_cells</span> <span class="o">-</span> <span class="n">buffer_bytes</span><span class="p">)</span> <span class="o">//</span> <span class="n">mempersample</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos">827</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# samples that can fit on device: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxsamples</span><span class="p">))</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos">828</span></a>        <span class="k">return</span> <span class="n">maxsamples</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos">829</span></a>    <span class="c1"># END .get_max_samples</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos">830</span></a>
</span><span id="L-831"><a href="#L-831"><span class="linenos">831</span></a>    <span class="k">def</span> <span class="nf">assemble_stimulus</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">):</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos">832</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos">833</span></a><span class="sd">        This function is meant to be overloaded by child classes</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos">834</span></a>
</span><span id="L-835"><a href="#L-835"><span class="linenos">835</span></a><span class="sd">        Returns:</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos">836</span></a><span class="sd">            None</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos">837</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos">838</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SensoryBase: assemble_stimulus not implemented in class child.&quot;</span><span class="p">)</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos">839</span></a>        <span class="k">return</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos">840</span></a>
</span><span id="L-841"><a href="#L-841"><span class="linenos">841</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos">842</span></a>        <span class="k">return</span> <span class="p">{}</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos">843</span></a>
</span><span id="L-844"><a href="#L-844"><span class="linenos">844</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos">845</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos">846</span></a>
</span><span id="L-847"><a href="#L-847"><span class="linenos">847</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos">848</span></a>    <span class="k">def</span> <span class="nf">is_int</span><span class="p">(</span> <span class="n">val</span> <span class="p">):</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos">849</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos">850</span></a><span class="sd">        Returns a boolean as to whether val is one of many types of integers</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos">851</span></a>
</span><span id="L-852"><a href="#L-852"><span class="linenos">852</span></a><span class="sd">        Returns:</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos">853</span></a><span class="sd">            True if val is an integer, False otherwise</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos">854</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos">855</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> \
</span><span id="L-856"><a href="#L-856"><span class="linenos">856</span></a>            <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="ow">or</span> \
</span><span id="L-857"><a href="#L-857"><span class="linenos">857</span></a>            <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos">858</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos">859</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos">860</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos">861</span></a>
</span><span id="L-862"><a href="#L-862"><span class="linenos">862</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos">863</span></a>    <span class="k">def</span> <span class="nf">index_to_array</span><span class="p">(</span> <span class="n">index</span><span class="p">,</span> <span class="n">max_val</span> <span class="p">):</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos">864</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos">865</span></a><span class="sd">        This converts any for index to dataset, including slices, and plain ints, into numpy array</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos">866</span></a>
</span><span id="L-867"><a href="#L-867"><span class="linenos">867</span></a><span class="sd">        Args:</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos">868</span></a><span class="sd">            index: the index to convert</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos">869</span></a><span class="sd">            max_val: the maximum value to use</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos">870</span></a>
</span><span id="L-871"><a href="#L-871"><span class="linenos">871</span></a><span class="sd">        Returns:</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos">872</span></a><span class="sd">            index: the converted index</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos">873</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos">874</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos">875</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">start</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos">876</span></a>            <span class="n">stop</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">stop</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos">877</span></a>            <span class="n">step</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">step</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos">878</span></a>            <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos">879</span></a>                <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos">880</span></a>            <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos">881</span></a>                <span class="n">stop</span> <span class="o">=</span> <span class="n">max_val</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos">882</span></a>            <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos">883</span></a>                <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos">884</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos">885</span></a>        <span class="k">elif</span> <span class="n">SensoryBase</span><span class="o">.</span><span class="n">is_int</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos">886</span></a>            <span class="k">return</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos">887</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos">888</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos">889</span></a>        <span class="k">return</span> <span class="n">index</span>
</span></pre></div>


            </section>
                <section id="SensoryBase">
                            <input id="SensoryBase-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SensoryBase</span><wbr>(<span class="base">typing.Generic[+T_co]</span>):

                <label class="view-source-button" for="SensoryBase-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase-13"><a href="#SensoryBase-13"><span class="linenos"> 13</span></a><span class="k">class</span> <span class="nc">SensoryBase</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span><span id="SensoryBase-14"><a href="#SensoryBase-14"><span class="linenos"> 14</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Parent class meant to hold standard variables and functions used by general sensory datasets</span>
</span><span id="SensoryBase-15"><a href="#SensoryBase-15"><span class="linenos"> 15</span></a><span class="sd">    </span>
</span><span id="SensoryBase-16"><a href="#SensoryBase-16"><span class="linenos"> 16</span></a><span class="sd">    General consistent formatting:</span>
</span><span id="SensoryBase-17"><a href="#SensoryBase-17"><span class="linenos"> 17</span></a><span class="sd">    -- self.robs, dfs, and any design matrices are generated as torch vectors on device</span>
</span><span id="SensoryBase-18"><a href="#SensoryBase-18"><span class="linenos"> 18</span></a><span class="sd">    -- stimuli are imported separately as dataset-specific numpy arrays, and but then prepared into </span>
</span><span id="SensoryBase-19"><a href="#SensoryBase-19"><span class="linenos"> 19</span></a><span class="sd">        self.stim (tensor) by a function self.prepare_stim, which must be overloaded</span>
</span><span id="SensoryBase-20"><a href="#SensoryBase-20"><span class="linenos"> 20</span></a><span class="sd">    -- self.stim_dims gives the dimension of self.stim in 4-dimensional format</span>
</span><span id="SensoryBase-21"><a href="#SensoryBase-21"><span class="linenos"> 21</span></a><span class="sd">    -- all tensors are stored on default device (cpu)</span>
</span><span id="SensoryBase-22"><a href="#SensoryBase-22"><span class="linenos"> 22</span></a>
</span><span id="SensoryBase-23"><a href="#SensoryBase-23"><span class="linenos"> 23</span></a><span class="sd">    General book-keeping variables</span>
</span><span id="SensoryBase-24"><a href="#SensoryBase-24"><span class="linenos"> 24</span></a><span class="sd">    -- self.block_inds is empty but must be filled in by specific datasets</span>
</span><span id="SensoryBase-25"><a href="#SensoryBase-25"><span class="linenos"> 25</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="SensoryBase-26"><a href="#SensoryBase-26"><span class="linenos"> 26</span></a>
</span><span id="SensoryBase-27"><a href="#SensoryBase-27"><span class="linenos"> 27</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="SensoryBase-28"><a href="#SensoryBase-28"><span class="linenos"> 28</span></a>        <span class="n">filenames</span><span class="p">,</span> <span class="c1"># this could be single filename or list of filenames, to be processed in specific way</span>
</span><span id="SensoryBase-29"><a href="#SensoryBase-29"><span class="linenos"> 29</span></a>        <span class="n">datadir</span><span class="p">,</span> 
</span><span id="SensoryBase-30"><a href="#SensoryBase-30"><span class="linenos"> 30</span></a>        <span class="c1"># Stim setup</span>
</span><span id="SensoryBase-31"><a href="#SensoryBase-31"><span class="linenos"> 31</span></a>        <span class="n">trial_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="SensoryBase-32"><a href="#SensoryBase-32"><span class="linenos"> 32</span></a>        <span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="SensoryBase-33"><a href="#SensoryBase-33"><span class="linenos"> 33</span></a>        <span class="n">time_embed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="SensoryBase-34"><a href="#SensoryBase-34"><span class="linenos"> 34</span></a>        <span class="c1">#maxT = None,</span>
</span><span id="SensoryBase-35"><a href="#SensoryBase-35"><span class="linenos"> 35</span></a>        <span class="c1"># other</span>
</span><span id="SensoryBase-36"><a href="#SensoryBase-36"><span class="linenos"> 36</span></a>        <span class="n">include_MUs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="SensoryBase-37"><a href="#SensoryBase-37"><span class="linenos"> 37</span></a>        <span class="n">drift_interval</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SensoryBase-38"><a href="#SensoryBase-38"><span class="linenos"> 38</span></a>        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</span><span id="SensoryBase-39"><a href="#SensoryBase-39"><span class="linenos"> 39</span></a>        <span class="p">):</span>
</span><span id="SensoryBase-40"><a href="#SensoryBase-40"><span class="linenos"> 40</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-41"><a href="#SensoryBase-41"><span class="linenos"> 41</span></a><span class="sd">        Constructor options</span>
</span><span id="SensoryBase-42"><a href="#SensoryBase-42"><span class="linenos"> 42</span></a><span class="sd">        </span>
</span><span id="SensoryBase-43"><a href="#SensoryBase-43"><span class="linenos"> 43</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase-44"><a href="#SensoryBase-44"><span class="linenos"> 44</span></a><span class="sd">            filenames: the filenames to use</span>
</span><span id="SensoryBase-45"><a href="#SensoryBase-45"><span class="linenos"> 45</span></a><span class="sd">            datadir: the data directory</span>
</span><span id="SensoryBase-46"><a href="#SensoryBase-46"><span class="linenos"> 46</span></a><span class="sd">            trial_sample: whether to sample trials</span>
</span><span id="SensoryBase-47"><a href="#SensoryBase-47"><span class="linenos"> 47</span></a><span class="sd">            num_lags: the number of lags to use</span>
</span><span id="SensoryBase-48"><a href="#SensoryBase-48"><span class="linenos"> 48</span></a><span class="sd">            time_embed: the time embedding to use</span>
</span><span id="SensoryBase-49"><a href="#SensoryBase-49"><span class="linenos"> 49</span></a><span class="sd">            include_MUs: whether to include MUs</span>
</span><span id="SensoryBase-50"><a href="#SensoryBase-50"><span class="linenos"> 50</span></a><span class="sd">            drift_interval: the drift interval to use</span>
</span><span id="SensoryBase-51"><a href="#SensoryBase-51"><span class="linenos"> 51</span></a><span class="sd">            device: the device to use</span>
</span><span id="SensoryBase-52"><a href="#SensoryBase-52"><span class="linenos"> 52</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-53"><a href="#SensoryBase-53"><span class="linenos"> 53</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">datadir</span>
</span><span id="SensoryBase-54"><a href="#SensoryBase-54"><span class="linenos"> 54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="n">filenames</span>
</span><span id="SensoryBase-55"><a href="#SensoryBase-55"><span class="linenos"> 55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
</span><span id="SensoryBase-56"><a href="#SensoryBase-56"><span class="linenos"> 56</span></a>        
</span><span id="SensoryBase-57"><a href="#SensoryBase-57"><span class="linenos"> 57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trial_sample</span> <span class="o">=</span> <span class="n">trial_sample</span>
</span><span id="SensoryBase-58"><a href="#SensoryBase-58"><span class="linenos"> 58</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span> <span class="o">=</span> <span class="n">num_lags</span>
</span><span id="SensoryBase-59"><a href="#SensoryBase-59"><span class="linenos"> 59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase-60"><a href="#SensoryBase-60"><span class="linenos"> 60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">=</span> <span class="n">time_embed</span>
</span><span id="SensoryBase-61"><a href="#SensoryBase-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preload</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SensoryBase-62"><a href="#SensoryBase-62"><span class="linenos"> 62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span> <span class="o">=</span> <span class="n">drift_interval</span>
</span><span id="SensoryBase-63"><a href="#SensoryBase-63"><span class="linenos"> 63</span></a>
</span><span id="SensoryBase-64"><a href="#SensoryBase-64"><span class="linenos"> 64</span></a>        <span class="c1"># Assign standard variables</span>
</span><span id="SensoryBase-65"><a href="#SensoryBase-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_SUs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_MUs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="SensoryBase-66"><a href="#SensoryBase-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase-67"><a href="#SensoryBase-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">=</span> <span class="mi">0</span>    
</span><span id="SensoryBase-68"><a href="#SensoryBase-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase-69"><a href="#SensoryBase-69"><span class="linenos"> 69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_filemapping</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase-70"><a href="#SensoryBase-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span> <span class="o">=</span> <span class="n">include_MUs</span>
</span><span id="SensoryBase-71"><a href="#SensoryBase-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">SUinds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase-72"><a href="#SensoryBase-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">MUinds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase-73"><a href="#SensoryBase-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># can be list to output specific cells in get_item</span>
</span><span id="SensoryBase-74"><a href="#SensoryBase-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase-75"><a href="#SensoryBase-75"><span class="linenos"> 75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase-76"><a href="#SensoryBase-76"><span class="linenos"> 76</span></a>
</span><span id="SensoryBase-77"><a href="#SensoryBase-77"><span class="linenos"> 77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase-78"><a href="#SensoryBase-78"><span class="linenos"> 78</span></a>
</span><span id="SensoryBase-79"><a href="#SensoryBase-79"><span class="linenos"> 79</span></a>        <span class="c1"># Set up to store default train_, val_, test_inds</span>
</span><span id="SensoryBase-80"><a href="#SensoryBase-80"><span class="linenos"> 80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase-81"><a href="#SensoryBase-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase-82"><a href="#SensoryBase-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase-83"><a href="#SensoryBase-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase-84"><a href="#SensoryBase-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase-85"><a href="#SensoryBase-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase-86"><a href="#SensoryBase-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase-87"><a href="#SensoryBase-87"><span class="linenos"> 87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">speckled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SensoryBase-88"><a href="#SensoryBase-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mval</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>  <span class="c1"># Data-filter masks for speckled XV</span>
</span><span id="SensoryBase-89"><a href="#SensoryBase-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mval_out</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>  <span class="c1"># Data-filter masks for speckled XV</span>
</span><span id="SensoryBase-90"><a href="#SensoryBase-90"><span class="linenos"> 90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase-91"><a href="#SensoryBase-91"><span class="linenos"> 91</span></a>        
</span><span id="SensoryBase-92"><a href="#SensoryBase-92"><span class="linenos"> 92</span></a>        <span class="c1"># Basic default memory things</span>
</span><span id="SensoryBase-93"><a href="#SensoryBase-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase-94"><a href="#SensoryBase-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase-95"><a href="#SensoryBase-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase-96"><a href="#SensoryBase-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SensoryBase-97"><a href="#SensoryBase-97"><span class="linenos"> 97</span></a>    
</span><span id="SensoryBase-98"><a href="#SensoryBase-98"><span class="linenos"> 98</span></a>        <span class="c1"># Additional covariate list</span>
</span><span id="SensoryBase-99"><a href="#SensoryBase-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="SensoryBase-100"><a href="#SensoryBase-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cov_dims</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="SensoryBase-101"><a href="#SensoryBase-101"><span class="linenos">101</span></a>        <span class="c1"># General file i/o -- this is not general, so taking out</span>
</span><span id="SensoryBase-102"><a href="#SensoryBase-102"><span class="linenos">102</span></a>        <span class="c1">#self.fhandles = [h5py.File(os.path.join(datadir, sess + &#39;.mat&#39;), &#39;r&#39;) for sess in self.sess_list]</span>
</span><span id="SensoryBase-103"><a href="#SensoryBase-103"><span class="linenos">103</span></a>            
</span><span id="SensoryBase-104"><a href="#SensoryBase-104"><span class="linenos">104</span></a>    <span class="c1"># END SensoryBase.__init__</span>
</span><span id="SensoryBase-105"><a href="#SensoryBase-105"><span class="linenos">105</span></a>
</span><span id="SensoryBase-106"><a href="#SensoryBase-106"><span class="linenos">106</span></a>    <span class="k">def</span> <span class="nf">add_covariate</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cov_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="SensoryBase-107"><a href="#SensoryBase-107"><span class="linenos">107</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-108"><a href="#SensoryBase-108"><span class="linenos">108</span></a><span class="sd">        Adds a covariate to the dataset</span>
</span><span id="SensoryBase-109"><a href="#SensoryBase-109"><span class="linenos">109</span></a>
</span><span id="SensoryBase-110"><a href="#SensoryBase-110"><span class="linenos">110</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase-111"><a href="#SensoryBase-111"><span class="linenos">111</span></a><span class="sd">            cov_name: name of the covariate</span>
</span><span id="SensoryBase-112"><a href="#SensoryBase-112"><span class="linenos">112</span></a><span class="sd">            cov: the covariate itself</span>
</span><span id="SensoryBase-113"><a href="#SensoryBase-113"><span class="linenos">113</span></a>
</span><span id="SensoryBase-114"><a href="#SensoryBase-114"><span class="linenos">114</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase-115"><a href="#SensoryBase-115"><span class="linenos">115</span></a><span class="sd">            None</span>
</span><span id="SensoryBase-116"><a href="#SensoryBase-116"><span class="linenos">116</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-117"><a href="#SensoryBase-117"><span class="linenos">117</span></a>        <span class="k">assert</span> <span class="n">cov_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need cov_name&quot;</span>
</span><span id="SensoryBase-118"><a href="#SensoryBase-118"><span class="linenos">118</span></a>        <span class="k">assert</span> <span class="n">cov</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Missing cov&quot;</span>
</span><span id="SensoryBase-119"><a href="#SensoryBase-119"><span class="linenos">119</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SensoryBase-120"><a href="#SensoryBase-120"><span class="linenos">120</span></a>            <span class="n">cov</span> <span class="o">=</span> <span class="n">cov</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="SensoryBase-121"><a href="#SensoryBase-121"><span class="linenos">121</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="SensoryBase-122"><a href="#SensoryBase-122"><span class="linenos">122</span></a>            <span class="n">dims</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="SensoryBase-123"><a href="#SensoryBase-123"><span class="linenos">123</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="SensoryBase-124"><a href="#SensoryBase-124"><span class="linenos">124</span></a>                <span class="n">dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
</span><span id="SensoryBase-125"><a href="#SensoryBase-125"><span class="linenos">125</span></a>            <span class="n">cov</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">dims</span><span class="p">)])</span>
</span><span id="SensoryBase-126"><a href="#SensoryBase-126"><span class="linenos">126</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-127"><a href="#SensoryBase-127"><span class="linenos">127</span></a>            <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="SensoryBase-128"><a href="#SensoryBase-128"><span class="linenos">128</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SensoryBase-129"><a href="#SensoryBase-129"><span class="linenos">129</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">==</span> <span class="n">NT</span><span class="p">,</span> <span class="s2">&quot;Wrong number of time points&quot;</span>
</span><span id="SensoryBase-130"><a href="#SensoryBase-130"><span class="linenos">130</span></a>
</span><span id="SensoryBase-131"><a href="#SensoryBase-131"><span class="linenos">131</span></a>        <span class="k">if</span> <span class="n">cov_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">:</span>
</span><span id="SensoryBase-132"><a href="#SensoryBase-132"><span class="linenos">132</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Discarding old&#39;</span><span class="p">,</span> <span class="n">cov_name</span><span class="p">)</span>
</span><span id="SensoryBase-133"><a href="#SensoryBase-133"><span class="linenos">133</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">[</span><span class="n">cov_name</span><span class="p">]</span>
</span><span id="SensoryBase-134"><a href="#SensoryBase-134"><span class="linenos">134</span></a>
</span><span id="SensoryBase-135"><a href="#SensoryBase-135"><span class="linenos">135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cov_dims</span><span class="p">[</span><span class="n">cov_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dims</span>
</span><span id="SensoryBase-136"><a href="#SensoryBase-136"><span class="linenos">136</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="SensoryBase-137"><a href="#SensoryBase-137"><span class="linenos">137</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">[</span><span class="n">cov_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
</span><span id="SensoryBase-138"><a href="#SensoryBase-138"><span class="linenos">138</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-139"><a href="#SensoryBase-139"><span class="linenos">139</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">[</span><span class="n">cov_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="SensoryBase-140"><a href="#SensoryBase-140"><span class="linenos">140</span></a>    <span class="c1"># END SensoryBase.add_covariate()</span>
</span><span id="SensoryBase-141"><a href="#SensoryBase-141"><span class="linenos">141</span></a>
</span><span id="SensoryBase-142"><a href="#SensoryBase-142"><span class="linenos">142</span></a>    <span class="k">def</span> <span class="nf">append_covariates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">idx</span> <span class="p">):</span>
</span><span id="SensoryBase-143"><a href="#SensoryBase-143"><span class="linenos">143</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-144"><a href="#SensoryBase-144"><span class="linenos">144</span></a><span class="sd">        Complements __get_item__ to add covariates to existing dictionary</span>
</span><span id="SensoryBase-145"><a href="#SensoryBase-145"><span class="linenos">145</span></a><span class="sd">        </span>
</span><span id="SensoryBase-146"><a href="#SensoryBase-146"><span class="linenos">146</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase-147"><a href="#SensoryBase-147"><span class="linenos">147</span></a><span class="sd">            out: the dictionary to append to</span>
</span><span id="SensoryBase-148"><a href="#SensoryBase-148"><span class="linenos">148</span></a><span class="sd">            idx: the index to append at</span>
</span><span id="SensoryBase-149"><a href="#SensoryBase-149"><span class="linenos">149</span></a>
</span><span id="SensoryBase-150"><a href="#SensoryBase-150"><span class="linenos">150</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase-151"><a href="#SensoryBase-151"><span class="linenos">151</span></a><span class="sd">            None</span>
</span><span id="SensoryBase-152"><a href="#SensoryBase-152"><span class="linenos">152</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-153"><a href="#SensoryBase-153"><span class="linenos">153</span></a>        <span class="k">for</span> <span class="n">cov_name</span><span class="p">,</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="SensoryBase-154"><a href="#SensoryBase-154"><span class="linenos">154</span></a>            <span class="n">out</span><span class="p">[</span><span class="n">cov_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="SensoryBase-155"><a href="#SensoryBase-155"><span class="linenos">155</span></a>        <span class="c1"># Return out, or not?</span>
</span><span id="SensoryBase-156"><a href="#SensoryBase-156"><span class="linenos">156</span></a>
</span><span id="SensoryBase-157"><a href="#SensoryBase-157"><span class="linenos">157</span></a>    <span class="k">def</span> <span class="nf">prepare_stim</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="SensoryBase-158"><a href="#SensoryBase-158"><span class="linenos">158</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-159"><a href="#SensoryBase-159"><span class="linenos">159</span></a><span class="sd">        This function is meant to be overloaded by child classes</span>
</span><span id="SensoryBase-160"><a href="#SensoryBase-160"><span class="linenos">160</span></a>
</span><span id="SensoryBase-161"><a href="#SensoryBase-161"><span class="linenos">161</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase-162"><a href="#SensoryBase-162"><span class="linenos">162</span></a><span class="sd">            None</span>
</span><span id="SensoryBase-163"><a href="#SensoryBase-163"><span class="linenos">163</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-164"><a href="#SensoryBase-164"><span class="linenos">164</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Default prepare stimulus method.&#39;</span><span class="p">)</span>
</span><span id="SensoryBase-165"><a href="#SensoryBase-165"><span class="linenos">165</span></a>
</span><span id="SensoryBase-166"><a href="#SensoryBase-166"><span class="linenos">166</span></a>    <span class="k">def</span> <span class="nf">set_cells</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cell_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="SensoryBase-167"><a href="#SensoryBase-167"><span class="linenos">167</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-168"><a href="#SensoryBase-168"><span class="linenos">168</span></a><span class="sd">        Set outputs to potentially limit robs/dfs to certain cells </span>
</span><span id="SensoryBase-169"><a href="#SensoryBase-169"><span class="linenos">169</span></a><span class="sd">        This sets cells_out but also constructs efficient data structures</span>
</span><span id="SensoryBase-170"><a href="#SensoryBase-170"><span class="linenos">170</span></a><span class="sd">        </span>
</span><span id="SensoryBase-171"><a href="#SensoryBase-171"><span class="linenos">171</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase-172"><a href="#SensoryBase-172"><span class="linenos">172</span></a><span class="sd">            cell_list: list of cells to output</span>
</span><span id="SensoryBase-173"><a href="#SensoryBase-173"><span class="linenos">173</span></a><span class="sd">            verbose: whether to print out the number of cells</span>
</span><span id="SensoryBase-174"><a href="#SensoryBase-174"><span class="linenos">174</span></a>
</span><span id="SensoryBase-175"><a href="#SensoryBase-175"><span class="linenos">175</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase-176"><a href="#SensoryBase-176"><span class="linenos">176</span></a><span class="sd">            None</span>
</span><span id="SensoryBase-177"><a href="#SensoryBase-177"><span class="linenos">177</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-178"><a href="#SensoryBase-178"><span class="linenos">178</span></a>        <span class="k">if</span> <span class="n">cell_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase-179"><a href="#SensoryBase-179"><span class="linenos">179</span></a>            <span class="c1"># Then reset to full list</span>
</span><span id="SensoryBase-180"><a href="#SensoryBase-180"><span class="linenos">180</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase-181"><a href="#SensoryBase-181"><span class="linenos">181</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase-182"><a href="#SensoryBase-182"><span class="linenos">182</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase-183"><a href="#SensoryBase-183"><span class="linenos">183</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase-184"><a href="#SensoryBase-184"><span class="linenos">184</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Mval_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase-185"><a href="#SensoryBase-185"><span class="linenos">185</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="SensoryBase-186"><a href="#SensoryBase-186"><span class="linenos">186</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Reset cells_out to full dataset (</span><span class="si">%d</span><span class="s2"> cells).&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="p">)</span>
</span><span id="SensoryBase-187"><a href="#SensoryBase-187"><span class="linenos">187</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-188"><a href="#SensoryBase-188"><span class="linenos">188</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="SensoryBase-189"><a href="#SensoryBase-189"><span class="linenos">189</span></a>                <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_int</span><span class="p">(</span><span class="n">cell_list</span><span class="p">):</span>
</span><span id="SensoryBase-190"><a href="#SensoryBase-190"><span class="linenos">190</span></a>                    <span class="n">cell_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell_list</span><span class="p">]</span>
</span><span id="SensoryBase-191"><a href="#SensoryBase-191"><span class="linenos">191</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-192"><a href="#SensoryBase-192"><span class="linenos">192</span></a>                    <span class="n">cell_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cell_list</span><span class="p">)</span>
</span><span id="SensoryBase-193"><a href="#SensoryBase-193"><span class="linenos">193</span></a>            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cell_list</span><span class="p">))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="s2">&quot;ERROR: cell_list too high.&quot;</span>
</span><span id="SensoryBase-194"><a href="#SensoryBase-194"><span class="linenos">194</span></a>            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="SensoryBase-195"><a href="#SensoryBase-195"><span class="linenos">195</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Output set to </span><span class="si">%d</span><span class="s2"> cells&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">cell_list</span><span class="p">))</span>
</span><span id="SensoryBase-196"><a href="#SensoryBase-196"><span class="linenos">196</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="o">=</span> <span class="n">cell_list</span>
</span><span id="SensoryBase-197"><a href="#SensoryBase-197"><span class="linenos">197</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="n">cell_list</span><span class="p">])</span>
</span><span id="SensoryBase-198"><a href="#SensoryBase-198"><span class="linenos">198</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cell_list</span><span class="p">])</span>
</span><span id="SensoryBase-199"><a href="#SensoryBase-199"><span class="linenos">199</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase-200"><a href="#SensoryBase-200"><span class="linenos">200</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span><span class="p">[:,</span> <span class="n">cell_list</span><span class="p">])</span>
</span><span id="SensoryBase-201"><a href="#SensoryBase-201"><span class="linenos">201</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mval_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Mval</span><span class="p">[:,</span> <span class="n">cell_list</span><span class="p">])</span>
</span><span id="SensoryBase-202"><a href="#SensoryBase-202"><span class="linenos">202</span></a>    <span class="c1"># END SensoryBase.set_cells()</span>
</span><span id="SensoryBase-203"><a href="#SensoryBase-203"><span class="linenos">203</span></a>
</span><span id="SensoryBase-204"><a href="#SensoryBase-204"><span class="linenos">204</span></a>    <span class="k">def</span> <span class="nf">time_embedding</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="SensoryBase-205"><a href="#SensoryBase-205"><span class="linenos">205</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-206"><a href="#SensoryBase-206"><span class="linenos">206</span></a><span class="sd">        Assume all stim dimensions are flattened into single dimension. </span>
</span><span id="SensoryBase-207"><a href="#SensoryBase-207"><span class="linenos">207</span></a><span class="sd">        Will only act on self.stim if &#39;stim&#39; argument is left None</span>
</span><span id="SensoryBase-208"><a href="#SensoryBase-208"><span class="linenos">208</span></a><span class="sd">        </span>
</span><span id="SensoryBase-209"><a href="#SensoryBase-209"><span class="linenos">209</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase-210"><a href="#SensoryBase-210"><span class="linenos">210</span></a><span class="sd">            stim: the stimulus to time-embed</span>
</span><span id="SensoryBase-211"><a href="#SensoryBase-211"><span class="linenos">211</span></a><span class="sd">            nlags: the number of lags to use</span>
</span><span id="SensoryBase-212"><a href="#SensoryBase-212"><span class="linenos">212</span></a><span class="sd">            verbose: whether to print out the time embedding process</span>
</span><span id="SensoryBase-213"><a href="#SensoryBase-213"><span class="linenos">213</span></a>
</span><span id="SensoryBase-214"><a href="#SensoryBase-214"><span class="linenos">214</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase-215"><a href="#SensoryBase-215"><span class="linenos">215</span></a><span class="sd">            tmp_stim: the time-embedded stimulus</span>
</span><span id="SensoryBase-216"><a href="#SensoryBase-216"><span class="linenos">216</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-217"><a href="#SensoryBase-217"><span class="linenos">217</span></a>
</span><span id="SensoryBase-218"><a href="#SensoryBase-218"><span class="linenos">218</span></a>        <span class="k">if</span> <span class="n">nlags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase-219"><a href="#SensoryBase-219"><span class="linenos">219</span></a>            <span class="n">nlags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="SensoryBase-220"><a href="#SensoryBase-220"><span class="linenos">220</span></a>        <span class="k">if</span> <span class="n">stim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase-221"><a href="#SensoryBase-221"><span class="linenos">221</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to assemble stim before time-embedding.&quot;</span>
</span><span id="SensoryBase-222"><a href="#SensoryBase-222"><span class="linenos">222</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span>
</span><span id="SensoryBase-223"><a href="#SensoryBase-223"><span class="linenos">223</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># should only time-embed stim by default, but not all the time</span>
</span><span id="SensoryBase-224"><a href="#SensoryBase-224"><span class="linenos">224</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlags</span>
</span><span id="SensoryBase-225"><a href="#SensoryBase-225"><span class="linenos">225</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-226"><a href="#SensoryBase-226"><span class="linenos">226</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="SensoryBase-227"><a href="#SensoryBase-227"><span class="linenos">227</span></a>                <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">stim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="SensoryBase-228"><a href="#SensoryBase-228"><span class="linenos">228</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-229"><a href="#SensoryBase-229"><span class="linenos">229</span></a>                <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="SensoryBase-230"><a href="#SensoryBase-230"><span class="linenos">230</span></a> 
</span><span id="SensoryBase-231"><a href="#SensoryBase-231"><span class="linenos">231</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="SensoryBase-232"><a href="#SensoryBase-232"><span class="linenos">232</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Time embedding...&quot;</span> <span class="p">)</span>
</span><span id="SensoryBase-233"><a href="#SensoryBase-233"><span class="linenos">233</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SensoryBase-234"><a href="#SensoryBase-234"><span class="linenos">234</span></a>        <span class="n">original_dims</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase-235"><a href="#SensoryBase-235"><span class="linenos">235</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="SensoryBase-236"><a href="#SensoryBase-236"><span class="linenos">236</span></a>            <span class="n">original_dims</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="o">.</span><span class="n">shape</span>
</span><span id="SensoryBase-237"><a href="#SensoryBase-237"><span class="linenos">237</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="SensoryBase-238"><a href="#SensoryBase-238"><span class="linenos">238</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Time embed: flattening stimulus from&quot;</span><span class="p">,</span> <span class="n">original_dims</span><span class="p">)</span>
</span><span id="SensoryBase-239"><a href="#SensoryBase-239"><span class="linenos">239</span></a>        <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># automatically generates 2-dimensional stim</span>
</span><span id="SensoryBase-240"><a href="#SensoryBase-240"><span class="linenos">240</span></a>
</span><span id="SensoryBase-241"><a href="#SensoryBase-241"><span class="linenos">241</span></a>        <span class="c1">#assert self.NT == NT, &quot;TIME EMBEDDING: stim length mismatch&quot;</span>
</span><span id="SensoryBase-242"><a href="#SensoryBase-242"><span class="linenos">242</span></a>
</span><span id="SensoryBase-243"><a href="#SensoryBase-243"><span class="linenos">243</span></a>        <span class="c1"># Actual time-embedding itself</span>
</span><span id="SensoryBase-244"><a href="#SensoryBase-244"><span class="linenos">244</span></a>        <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nlags</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="SensoryBase-245"><a href="#SensoryBase-245"><span class="linenos">245</span></a>        <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="o">.</span><span class="n">permute</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="SensoryBase-246"><a href="#SensoryBase-246"><span class="linenos">246</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="SensoryBase-247"><a href="#SensoryBase-247"><span class="linenos">247</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Done.&quot;</span><span class="p">)</span>
</span><span id="SensoryBase-248"><a href="#SensoryBase-248"><span class="linenos">248</span></a>        <span class="k">return</span> <span class="n">tmp_stim</span>
</span><span id="SensoryBase-249"><a href="#SensoryBase-249"><span class="linenos">249</span></a>    <span class="c1"># END SensoryBase.time_embedding()</span>
</span><span id="SensoryBase-250"><a href="#SensoryBase-250"><span class="linenos">250</span></a>
</span><span id="SensoryBase-251"><a href="#SensoryBase-251"><span class="linenos">251</span></a>    <span class="k">def</span> <span class="nf">construct_drift_design_matrix</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">block_anchors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="SensoryBase-252"><a href="#SensoryBase-252"><span class="linenos">252</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-253"><a href="#SensoryBase-253"><span class="linenos">253</span></a><span class="sd">        Note this requires self.block_inds, and either uses self.drift_interval or block_anchors</span>
</span><span id="SensoryBase-254"><a href="#SensoryBase-254"><span class="linenos">254</span></a><span class="sd">        </span>
</span><span id="SensoryBase-255"><a href="#SensoryBase-255"><span class="linenos">255</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase-256"><a href="#SensoryBase-256"><span class="linenos">256</span></a><span class="sd">            block_anchors: the block anchors to use</span>
</span><span id="SensoryBase-257"><a href="#SensoryBase-257"><span class="linenos">257</span></a><span class="sd">            </span>
</span><span id="SensoryBase-258"><a href="#SensoryBase-258"><span class="linenos">258</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase-259"><a href="#SensoryBase-259"><span class="linenos">259</span></a><span class="sd">            None</span>
</span><span id="SensoryBase-260"><a href="#SensoryBase-260"><span class="linenos">260</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-261"><a href="#SensoryBase-261"><span class="linenos">261</span></a>
</span><span id="SensoryBase-262"><a href="#SensoryBase-262"><span class="linenos">262</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need block_inds defined as an internal variable&quot;</span>
</span><span id="SensoryBase-263"><a href="#SensoryBase-263"><span class="linenos">263</span></a>
</span><span id="SensoryBase-264"><a href="#SensoryBase-264"><span class="linenos">264</span></a>        <span class="k">if</span> <span class="n">block_anchors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase-265"><a href="#SensoryBase-265"><span class="linenos">265</span></a>            <span class="n">NBL</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="SensoryBase-266"><a href="#SensoryBase-266"><span class="linenos">266</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase-267"><a href="#SensoryBase-267"><span class="linenos">267</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase-268"><a href="#SensoryBase-268"><span class="linenos">268</span></a>                <span class="k">return</span>
</span><span id="SensoryBase-269"><a href="#SensoryBase-269"><span class="linenos">269</span></a>            <span class="n">block_anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NBL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span><span class="p">)</span>
</span><span id="SensoryBase-270"><a href="#SensoryBase-270"><span class="linenos">270</span></a>
</span><span id="SensoryBase-271"><a href="#SensoryBase-271"><span class="linenos">271</span></a>        <span class="n">Nanchors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">block_anchors</span><span class="p">)</span>
</span><span id="SensoryBase-272"><a href="#SensoryBase-272"><span class="linenos">272</span></a>        <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="SensoryBase-273"><a href="#SensoryBase-273"><span class="linenos">273</span></a>        <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">):</span>
</span><span id="SensoryBase-274"><a href="#SensoryBase-274"><span class="linenos">274</span></a>            <span class="n">anchors</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">block_anchors</span><span class="p">[</span><span class="n">bb</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SensoryBase-275"><a href="#SensoryBase-275"><span class="linenos">275</span></a>        
</span><span id="SensoryBase-276"><a href="#SensoryBase-276"><span class="linenos">276</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">anchors</span> <span class="o">=</span> <span class="n">anchors</span>
</span><span id="SensoryBase-277"><a href="#SensoryBase-277"><span class="linenos">277</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> 
</span><span id="SensoryBase-278"><a href="#SensoryBase-278"><span class="linenos">278</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="SensoryBase-279"><a href="#SensoryBase-279"><span class="linenos">279</span></a>            <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="SensoryBase-280"><a href="#SensoryBase-280"><span class="linenos">280</span></a>    <span class="c1"># END SenspryBase.construct_drift_design_matrix()</span>
</span><span id="SensoryBase-281"><a href="#SensoryBase-281"><span class="linenos">281</span></a>
</span><span id="SensoryBase-282"><a href="#SensoryBase-282"><span class="linenos">282</span></a>    <span class="k">def</span> <span class="nf">trial_psths</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">trials</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trial_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="SensoryBase-283"><a href="#SensoryBase-283"><span class="linenos">283</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-284"><a href="#SensoryBase-284"><span class="linenos">284</span></a><span class="sd">        Computes average firing rate of cells_out at bin-resolution, averaged across trials</span>
</span><span id="SensoryBase-285"><a href="#SensoryBase-285"><span class="linenos">285</span></a><span class="sd">        given in block_inds</span>
</span><span id="SensoryBase-286"><a href="#SensoryBase-286"><span class="linenos">286</span></a><span class="sd">        </span>
</span><span id="SensoryBase-287"><a href="#SensoryBase-287"><span class="linenos">287</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase-288"><a href="#SensoryBase-288"><span class="linenos">288</span></a><span class="sd">            trials: the trials to compute the PSTHs for</span>
</span><span id="SensoryBase-289"><a href="#SensoryBase-289"><span class="linenos">289</span></a><span class="sd">            R: the firing rates to use</span>
</span><span id="SensoryBase-290"><a href="#SensoryBase-290"><span class="linenos">290</span></a><span class="sd">            trial_size: the size of the trials</span>
</span><span id="SensoryBase-291"><a href="#SensoryBase-291"><span class="linenos">291</span></a><span class="sd">            verbose: whether to print out the trial sizes</span>
</span><span id="SensoryBase-292"><a href="#SensoryBase-292"><span class="linenos">292</span></a>
</span><span id="SensoryBase-293"><a href="#SensoryBase-293"><span class="linenos">293</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase-294"><a href="#SensoryBase-294"><span class="linenos">294</span></a><span class="sd">            psths: the PSTHs</span>
</span><span id="SensoryBase-295"><a href="#SensoryBase-295"><span class="linenos">295</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-296"><a href="#SensoryBase-296"><span class="linenos">296</span></a>
</span><span id="SensoryBase-297"><a href="#SensoryBase-297"><span class="linenos">297</span></a>        <span class="n">Ntr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="SensoryBase-298"><a href="#SensoryBase-298"><span class="linenos">298</span></a>        <span class="k">assert</span> <span class="n">Ntr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Cannot compute PSTHs without block_inds established in dataset.&quot;</span>
</span><span id="SensoryBase-299"><a href="#SensoryBase-299"><span class="linenos">299</span></a>
</span><span id="SensoryBase-300"><a href="#SensoryBase-300"><span class="linenos">300</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SensoryBase-301"><a href="#SensoryBase-301"><span class="linenos">301</span></a>            <span class="n">ccs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span>
</span><span id="SensoryBase-302"><a href="#SensoryBase-302"><span class="linenos">302</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-303"><a href="#SensoryBase-303"><span class="linenos">303</span></a>            <span class="n">ccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">)</span>
</span><span id="SensoryBase-304"><a href="#SensoryBase-304"><span class="linenos">304</span></a>        <span class="k">if</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ccs</span><span class="p">):</span>
</span><span id="SensoryBase-305"><a href="#SensoryBase-305"><span class="linenos">305</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">ccs</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="SensoryBase-306"><a href="#SensoryBase-306"><span class="linenos">306</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-307"><a href="#SensoryBase-307"><span class="linenos">307</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="SensoryBase-308"><a href="#SensoryBase-308"><span class="linenos">308</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Ignoring dfs.&#39;</span><span class="p">)</span>
</span><span id="SensoryBase-309"><a href="#SensoryBase-309"><span class="linenos">309</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
</span><span id="SensoryBase-310"><a href="#SensoryBase-310"><span class="linenos">310</span></a>
</span><span id="SensoryBase-311"><a href="#SensoryBase-311"><span class="linenos">311</span></a>        <span class="k">if</span> <span class="n">R</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1">#then use [internal] Robs</span>
</span><span id="SensoryBase-312"><a href="#SensoryBase-312"><span class="linenos">312</span></a>            <span class="n">R</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="n">ccs</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="p">)</span>  
</span><span id="SensoryBase-313"><a href="#SensoryBase-313"><span class="linenos">313</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SensoryBase-314"><a href="#SensoryBase-314"><span class="linenos">314</span></a>            <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>         
</span><span id="SensoryBase-315"><a href="#SensoryBase-315"><span class="linenos">315</span></a>        <span class="n">num_psths</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># otherwise use existing input</span>
</span><span id="SensoryBase-316"><a href="#SensoryBase-316"><span class="linenos">316</span></a>
</span><span id="SensoryBase-317"><a href="#SensoryBase-317"><span class="linenos">317</span></a>        <span class="c1"># Compute median trial size</span>
</span><span id="SensoryBase-318"><a href="#SensoryBase-318"><span class="linenos">318</span></a>        <span class="k">if</span> <span class="n">trial_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase-319"><a href="#SensoryBase-319"><span class="linenos">319</span></a>            <span class="c1"># select median trial size, but look at all</span>
</span><span id="SensoryBase-320"><a href="#SensoryBase-320"><span class="linenos">320</span></a>            <span class="n">tr_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">))</span>
</span><span id="SensoryBase-321"><a href="#SensoryBase-321"><span class="linenos">321</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntr</span><span class="p">):</span>
</span><span id="SensoryBase-322"><a href="#SensoryBase-322"><span class="linenos">322</span></a>                <span class="n">tr_sizes</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">])</span>
</span><span id="SensoryBase-323"><a href="#SensoryBase-323"><span class="linenos">323</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">tr_sizes</span><span class="p">))</span>
</span><span id="SensoryBase-324"><a href="#SensoryBase-324"><span class="linenos">324</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="SensoryBase-325"><a href="#SensoryBase-325"><span class="linenos">325</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Trial lengths: Min </span><span class="si">%d</span><span class="s2">, Max </span><span class="si">%d</span><span class="s2">, Median </span><span class="si">%d</span><span class="s2">. Selecting median.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tr_sizes</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tr_sizes</span><span class="p">),</span> <span class="n">T</span><span class="p">))</span>
</span><span id="SensoryBase-326"><a href="#SensoryBase-326"><span class="linenos">326</span></a>
</span><span id="SensoryBase-327"><a href="#SensoryBase-327"><span class="linenos">327</span></a>        <span class="k">if</span> <span class="n">trials</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase-328"><a href="#SensoryBase-328"><span class="linenos">328</span></a>            <span class="n">trials</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Ntr</span><span class="p">)</span>
</span><span id="SensoryBase-329"><a href="#SensoryBase-329"><span class="linenos">329</span></a>
</span><span id="SensoryBase-330"><a href="#SensoryBase-330"><span class="linenos">330</span></a>        <span class="n">psths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">T</span><span class="p">,</span> <span class="n">num_psths</span><span class="p">])</span>
</span><span id="SensoryBase-331"><a href="#SensoryBase-331"><span class="linenos">331</span></a>        <span class="n">df_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">T</span><span class="p">,</span> <span class="n">num_psths</span><span class="p">])</span>
</span><span id="SensoryBase-332"><a href="#SensoryBase-332"><span class="linenos">332</span></a>
</span><span id="SensoryBase-333"><a href="#SensoryBase-333"><span class="linenos">333</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SensoryBase-334"><a href="#SensoryBase-334"><span class="linenos">334</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">trials</span><span class="p">:</span>
</span><span id="SensoryBase-335"><a href="#SensoryBase-335"><span class="linenos">335</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">T</span><span class="p">:</span>
</span><span id="SensoryBase-336"><a href="#SensoryBase-336"><span class="linenos">336</span></a>                    <span class="n">trT</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
</span><span id="SensoryBase-337"><a href="#SensoryBase-337"><span class="linenos">337</span></a>                <span class="k">else</span><span class="p">:</span> 
</span><span id="SensoryBase-338"><a href="#SensoryBase-338"><span class="linenos">338</span></a>                    <span class="n">trT</span> <span class="o">=</span> <span class="n">T</span>
</span><span id="SensoryBase-339"><a href="#SensoryBase-339"><span class="linenos">339</span></a>                <span class="n">psths</span><span class="p">[:</span><span class="n">trT</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">R</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][:</span><span class="n">trT</span><span class="p">],</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][:</span><span class="n">trT</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="SensoryBase-340"><a href="#SensoryBase-340"><span class="linenos">340</span></a>                <span class="n">df_count</span><span class="p">[:</span><span class="n">trT</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][:</span><span class="n">trT</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="SensoryBase-341"><a href="#SensoryBase-341"><span class="linenos">341</span></a>            
</span><span id="SensoryBase-342"><a href="#SensoryBase-342"><span class="linenos">342</span></a>            <span class="n">psths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span> <span class="n">psths</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">df_count</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="p">)</span>
</span><span id="SensoryBase-343"><a href="#SensoryBase-343"><span class="linenos">343</span></a>
</span><span id="SensoryBase-344"><a href="#SensoryBase-344"><span class="linenos">344</span></a>        <span class="k">return</span> <span class="n">psths</span>
</span><span id="SensoryBase-345"><a href="#SensoryBase-345"><span class="linenos">345</span></a>    <span class="c1"># END SensoryBase.calculate_psths()</span>
</span><span id="SensoryBase-346"><a href="#SensoryBase-346"><span class="linenos">346</span></a>
</span><span id="SensoryBase-347"><a href="#SensoryBase-347"><span class="linenos">347</span></a>    <span class="k">def</span> <span class="nf">construct_LVtents</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">tent_spacing</span><span class="o">=</span><span class="mi">12</span> <span class="p">):</span>
</span><span id="SensoryBase-348"><a href="#SensoryBase-348"><span class="linenos">348</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-349"><a href="#SensoryBase-349"><span class="linenos">349</span></a><span class="sd">        Constructs tent-basis-style trial-based tent function</span>
</span><span id="SensoryBase-350"><a href="#SensoryBase-350"><span class="linenos">350</span></a><span class="sd">        </span>
</span><span id="SensoryBase-351"><a href="#SensoryBase-351"><span class="linenos">351</span></a><span class="sd">        Args: </span>
</span><span id="SensoryBase-352"><a href="#SensoryBase-352"><span class="linenos">352</span></a><span class="sd">            tent_spacing: the spacing of the tent functions</span>
</span><span id="SensoryBase-353"><a href="#SensoryBase-353"><span class="linenos">353</span></a>
</span><span id="SensoryBase-354"><a href="#SensoryBase-354"><span class="linenos">354</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase-355"><a href="#SensoryBase-355"><span class="linenos">355</span></a><span class="sd">            XLV: the design matrix</span>
</span><span id="SensoryBase-356"><a href="#SensoryBase-356"><span class="linenos">356</span></a><span class="sd">            LVdims: the dimensions of the design matrix</span>
</span><span id="SensoryBase-357"><a href="#SensoryBase-357"><span class="linenos">357</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-358"><a href="#SensoryBase-358"><span class="linenos">358</span></a>        
</span><span id="SensoryBase-359"><a href="#SensoryBase-359"><span class="linenos">359</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase-360"><a href="#SensoryBase-360"><span class="linenos">360</span></a>            <span class="c1"># Compute minimum and maximum trial size</span>
</span><span id="SensoryBase-361"><a href="#SensoryBase-361"><span class="linenos">361</span></a>            <span class="n">Ntr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="SensoryBase-362"><a href="#SensoryBase-362"><span class="linenos">362</span></a>            <span class="n">min_trial_size</span><span class="p">,</span> <span class="n">max_trial_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">0</span>
</span><span id="SensoryBase-363"><a href="#SensoryBase-363"><span class="linenos">363</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntr</span><span class="p">):</span>
</span><span id="SensoryBase-364"><a href="#SensoryBase-364"><span class="linenos">364</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">min_trial_size</span><span class="p">:</span>
</span><span id="SensoryBase-365"><a href="#SensoryBase-365"><span class="linenos">365</span></a>                    <span class="n">min_trial_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
</span><span id="SensoryBase-366"><a href="#SensoryBase-366"><span class="linenos">366</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">max_trial_size</span><span class="p">:</span>
</span><span id="SensoryBase-367"><a href="#SensoryBase-367"><span class="linenos">367</span></a>                    <span class="n">max_trial_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
</span><span id="SensoryBase-368"><a href="#SensoryBase-368"><span class="linenos">368</span></a>                    
</span><span id="SensoryBase-369"><a href="#SensoryBase-369"><span class="linenos">369</span></a>            <span class="k">if</span> <span class="n">tent_spacing</span> <span class="o">&gt;</span> <span class="n">min_trial_size</span><span class="p">:</span>
</span><span id="SensoryBase-370"><a href="#SensoryBase-370"><span class="linenos">370</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using one LV per trial&#39;</span><span class="p">)</span>
</span><span id="SensoryBase-371"><a href="#SensoryBase-371"><span class="linenos">371</span></a>                <span class="n">XLV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">Ntr</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="SensoryBase-372"><a href="#SensoryBase-372"><span class="linenos">372</span></a>                <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntr</span><span class="p">):</span>
</span><span id="SensoryBase-373"><a href="#SensoryBase-373"><span class="linenos">373</span></a>                    <span class="n">XLV</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">tr</span><span class="p">],</span> <span class="n">tr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="SensoryBase-374"><a href="#SensoryBase-374"><span class="linenos">374</span></a>                <span class="n">LVdims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">Ntr</span><span class="p">]</span>
</span><span id="SensoryBase-375"><a href="#SensoryBase-375"><span class="linenos">375</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-376"><a href="#SensoryBase-376"><span class="linenos">376</span></a>                <span class="c1"># automatically wont have any anchors past min_trial_size</span>
</span><span id="SensoryBase-377"><a href="#SensoryBase-377"><span class="linenos">377</span></a>                <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_trial_size</span><span class="p">,</span> <span class="n">tent_spacing</span><span class="p">)</span> 
</span><span id="SensoryBase-378"><a href="#SensoryBase-378"><span class="linenos">378</span></a>                <span class="c1"># Generate master tent_basis</span>
</span><span id="SensoryBase-379"><a href="#SensoryBase-379"><span class="linenos">379</span></a>                <span class="n">trial_tents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span>
</span><span id="SensoryBase-380"><a href="#SensoryBase-380"><span class="linenos">380</span></a>                    <span class="n">max_trial_size</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zero_right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="SensoryBase-381"><a href="#SensoryBase-381"><span class="linenos">381</span></a>                <span class="n">num_tents_tr</span> <span class="o">=</span> <span class="n">trial_tents</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SensoryBase-382"><a href="#SensoryBase-382"><span class="linenos">382</span></a>                <span class="n">num_tents</span> <span class="o">=</span> <span class="n">num_tents_tr</span> <span class="o">*</span> <span class="n">Ntr</span>
</span><span id="SensoryBase-383"><a href="#SensoryBase-383"><span class="linenos">383</span></a>                <span class="n">LVdims</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ntr</span><span class="p">,</span> <span class="n">num_tents_tr</span><span class="p">]</span> 
</span><span id="SensoryBase-384"><a href="#SensoryBase-384"><span class="linenos">384</span></a>                <span class="n">XLV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">num_tents</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="SensoryBase-385"><a href="#SensoryBase-385"><span class="linenos">385</span></a>                <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntr</span><span class="p">):</span>
</span><span id="SensoryBase-386"><a href="#SensoryBase-386"><span class="linenos">386</span></a>                    <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">tr</span><span class="p">])</span>
</span><span id="SensoryBase-387"><a href="#SensoryBase-387"><span class="linenos">387</span></a>                    <span class="n">vslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">L</span><span class="p">,</span> <span class="n">num_tents</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="SensoryBase-388"><a href="#SensoryBase-388"><span class="linenos">388</span></a>                    <span class="n">vslice</span><span class="p">[:,</span> <span class="n">tr</span><span class="o">*</span><span class="n">num_tents_tr</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_tents_tr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">trial_tents</span><span class="p">[:</span><span class="n">L</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="SensoryBase-389"><a href="#SensoryBase-389"><span class="linenos">389</span></a>                    <span class="n">XLV</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">tr</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">vslice</span><span class="p">)</span>
</span><span id="SensoryBase-390"><a href="#SensoryBase-390"><span class="linenos">390</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-391"><a href="#SensoryBase-391"><span class="linenos">391</span></a>            <span class="c1">#print(&#39;Trial-less LV setup not implemented yet, but should be easy.&#39;</span>
</span><span id="SensoryBase-392"><a href="#SensoryBase-392"><span class="linenos">392</span></a>            <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">tent_spacing</span><span class="p">)</span> 
</span><span id="SensoryBase-393"><a href="#SensoryBase-393"><span class="linenos">393</span></a>            <span class="n">XLV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span>
</span><span id="SensoryBase-394"><a href="#SensoryBase-394"><span class="linenos">394</span></a>                <span class="n">max_trial_size</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zero_right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="SensoryBase-395"><a href="#SensoryBase-395"><span class="linenos">395</span></a>            <span class="n">num_tents</span> <span class="o">=</span> <span class="n">XLV</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SensoryBase-396"><a href="#SensoryBase-396"><span class="linenos">396</span></a>            <span class="n">LVdims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_tents</span><span class="p">]</span>
</span><span id="SensoryBase-397"><a href="#SensoryBase-397"><span class="linenos">397</span></a>        <span class="k">return</span> <span class="n">XLV</span><span class="p">,</span> <span class="n">LVdims</span>  <span class="c1"># numpy array</span>
</span><span id="SensoryBase-398"><a href="#SensoryBase-398"><span class="linenos">398</span></a>    <span class="c1"># END SensoryBase.construct_LVtents()</span>
</span><span id="SensoryBase-399"><a href="#SensoryBase-399"><span class="linenos">399</span></a>    
</span><span id="SensoryBase-400"><a href="#SensoryBase-400"><span class="linenos">400</span></a>    <span class="k">def</span> <span class="nf">setup_trial_LVs</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="SensoryBase-401"><a href="#SensoryBase-401"><span class="linenos">401</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-402"><a href="#SensoryBase-402"><span class="linenos">402</span></a><span class="sd">        Usage: XLV = dataset.setup_trial_LVs()</span>
</span><span id="SensoryBase-403"><a href="#SensoryBase-403"><span class="linenos">403</span></a><span class="sd">        </span>
</span><span id="SensoryBase-404"><a href="#SensoryBase-404"><span class="linenos">404</span></a><span class="sd">        This makes design matrix as input for LVlayer (indexed LV for each trial) and outputs X, LVdims </span>
</span><span id="SensoryBase-405"><a href="#SensoryBase-405"><span class="linenos">405</span></a><span class="sd">        to actually figure out which LVs correspond to which trial, once it is done</span>
</span><span id="SensoryBase-406"><a href="#SensoryBase-406"><span class="linenos">406</span></a>
</span><span id="SensoryBase-407"><a href="#SensoryBase-407"><span class="linenos">407</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase-408"><a href="#SensoryBase-408"><span class="linenos">408</span></a><span class="sd">            X: the design matrix</span>
</span><span id="SensoryBase-409"><a href="#SensoryBase-409"><span class="linenos">409</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-410"><a href="#SensoryBase-410"><span class="linenos">410</span></a>
</span><span id="SensoryBase-411"><a href="#SensoryBase-411"><span class="linenos">411</span></a>        <span class="n">num_trials</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="SensoryBase-412"><a href="#SensoryBase-412"><span class="linenos">412</span></a>
</span><span id="SensoryBase-413"><a href="#SensoryBase-413"><span class="linenos">413</span></a>        <span class="c1"># LVs indexed 0-num_trials</span>
</span><span id="SensoryBase-414"><a href="#SensoryBase-414"><span class="linenos">414</span></a>        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="SensoryBase-415"><a href="#SensoryBase-415"><span class="linenos">415</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_trials</span><span class="p">):</span>
</span><span id="SensoryBase-416"><a href="#SensoryBase-416"><span class="linenos">416</span></a>            <span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ii</span>
</span><span id="SensoryBase-417"><a href="#SensoryBase-417"><span class="linenos">417</span></a>
</span><span id="SensoryBase-418"><a href="#SensoryBase-418"><span class="linenos">418</span></a>        <span class="k">return</span> <span class="n">X</span>
</span><span id="SensoryBase-419"><a href="#SensoryBase-419"><span class="linenos">419</span></a>    <span class="c1"># END SensoryBase.setup_trial_LVs()</span>
</span><span id="SensoryBase-420"><a href="#SensoryBase-420"><span class="linenos">420</span></a>
</span><span id="SensoryBase-421"><a href="#SensoryBase-421"><span class="linenos">421</span></a>    <span class="k">def</span> <span class="nf">setup_LVLayer_input</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">tent_spacing</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">trsize</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="SensoryBase-422"><a href="#SensoryBase-422"><span class="linenos">422</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-423"><a href="#SensoryBase-423"><span class="linenos">423</span></a><span class="sd">        Usage: X, filter_dims = data.setup_LVLayer_input( tent_spacing=10, trsize=None)</span>
</span><span id="SensoryBase-424"><a href="#SensoryBase-424"><span class="linenos">424</span></a>
</span><span id="SensoryBase-425"><a href="#SensoryBase-425"><span class="linenos">425</span></a><span class="sd">        Sets up tent-basis-input to LVLayer (part of NDNT code)</span>
</span><span id="SensoryBase-426"><a href="#SensoryBase-426"><span class="linenos">426</span></a><span class="sd">        This preserves all data by using multiple effective trials for long trials. </span>
</span><span id="SensoryBase-427"><a href="#SensoryBase-427"><span class="linenos">427</span></a>
</span><span id="SensoryBase-428"><a href="#SensoryBase-428"><span class="linenos">428</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase-429"><a href="#SensoryBase-429"><span class="linenos">429</span></a><span class="sd">            tent_spacing: the spacing of the tent functions</span>
</span><span id="SensoryBase-430"><a href="#SensoryBase-430"><span class="linenos">430</span></a><span class="sd">            trsize: the size of the trials</span>
</span><span id="SensoryBase-431"><a href="#SensoryBase-431"><span class="linenos">431</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-432"><a href="#SensoryBase-432"><span class="linenos">432</span></a>        <span class="c1"># Determine trial_size</span>
</span><span id="SensoryBase-433"><a href="#SensoryBase-433"><span class="linenos">433</span></a>        <span class="n">Ntr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="SensoryBase-434"><a href="#SensoryBase-434"><span class="linenos">434</span></a>        <span class="n">trsizes</span><span class="o">=</span><span class="p">[]</span>
</span><span id="SensoryBase-435"><a href="#SensoryBase-435"><span class="linenos">435</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntr</span><span class="p">):</span>
</span><span id="SensoryBase-436"><a href="#SensoryBase-436"><span class="linenos">436</span></a>            <span class="n">trsizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
</span><span id="SensoryBase-437"><a href="#SensoryBase-437"><span class="linenos">437</span></a>        <span class="k">if</span> <span class="n">trsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase-438"><a href="#SensoryBase-438"><span class="linenos">438</span></a>            <span class="n">L0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">trsizes</span><span class="p">)</span>
</span><span id="SensoryBase-439"><a href="#SensoryBase-439"><span class="linenos">439</span></a>
</span><span id="SensoryBase-440"><a href="#SensoryBase-440"><span class="linenos">440</span></a>        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span><span id="SensoryBase-441"><a href="#SensoryBase-441"><span class="linenos">441</span></a>        <span class="n">ramp_down</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tent_spacing</span><span class="p">))</span><span class="o">/</span><span class="n">tent_spacing</span>
</span><span id="SensoryBase-442"><a href="#SensoryBase-442"><span class="linenos">442</span></a>        <span class="n">NW0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">L0</span><span class="o">/</span><span class="n">tent_spacing</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>  <span class="c1"># how many LVs in standard trial</span>
</span><span id="SensoryBase-443"><a href="#SensoryBase-443"><span class="linenos">443</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Trial size = </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2"> LV indices per trial&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">L0</span><span class="p">,</span> <span class="n">NW0</span><span class="p">)</span> <span class="p">)</span>
</span><span id="SensoryBase-444"><a href="#SensoryBase-444"><span class="linenos">444</span></a>
</span><span id="SensoryBase-445"><a href="#SensoryBase-445"><span class="linenos">445</span></a>        <span class="n">Ntr_eff</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SensoryBase-446"><a href="#SensoryBase-446"><span class="linenos">446</span></a>        <span class="n">LVindex_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SensoryBase-447"><a href="#SensoryBase-447"><span class="linenos">447</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntr</span><span class="p">):</span>
</span><span id="SensoryBase-448"><a href="#SensoryBase-448"><span class="linenos">448</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="SensoryBase-449"><a href="#SensoryBase-449"><span class="linenos">449</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
</span><span id="SensoryBase-450"><a href="#SensoryBase-450"><span class="linenos">450</span></a>            <span class="n">NLVts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">tent_spacing</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># this gets one on edge, given partials are pegged at 1</span>
</span><span id="SensoryBase-451"><a href="#SensoryBase-451"><span class="linenos">451</span></a>            <span class="n">assigned_LVs_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NLVts</span><span class="p">)</span> <span class="o">+</span> <span class="n">LVindex_count</span>
</span><span id="SensoryBase-452"><a href="#SensoryBase-452"><span class="linenos">452</span></a>            
</span><span id="SensoryBase-453"><a href="#SensoryBase-453"><span class="linenos">453</span></a>            <span class="c1"># Map these LVs </span>
</span><span id="SensoryBase-454"><a href="#SensoryBase-454"><span class="linenos">454</span></a>            <span class="n">X</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">assigned_LVs_inds</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tent_spacing</span><span class="p">)[:</span><span class="n">L</span><span class="p">]</span>
</span><span id="SensoryBase-455"><a href="#SensoryBase-455"><span class="linenos">455</span></a>            <span class="n">X</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">assigned_LVs_inds</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">tent_spacing</span><span class="p">)[:</span><span class="n">L</span><span class="p">]</span>
</span><span id="SensoryBase-456"><a href="#SensoryBase-456"><span class="linenos">456</span></a>            <span class="n">X</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">ramp_down</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">tent_spacing</span><span class="p">)))[:</span><span class="n">L</span><span class="p">]</span>  <span class="c1"># this will leave the last bit ones</span>
</span><span id="SensoryBase-457"><a href="#SensoryBase-457"><span class="linenos">457</span></a>            
</span><span id="SensoryBase-458"><a href="#SensoryBase-458"><span class="linenos">458</span></a>            <span class="c1"># Need to do multiples of trial length so that smoothing works</span>
</span><span id="SensoryBase-459"><a href="#SensoryBase-459"><span class="linenos">459</span></a>            <span class="n">num_trial_blocks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">L0</span><span class="p">))</span>
</span><span id="SensoryBase-460"><a href="#SensoryBase-460"><span class="linenos">460</span></a>            <span class="n">LVindex_count</span> <span class="o">+=</span> <span class="n">num_trial_blocks</span> <span class="o">*</span> <span class="n">NW0</span>
</span><span id="SensoryBase-461"><a href="#SensoryBase-461"><span class="linenos">461</span></a>            <span class="n">Ntr_eff</span> <span class="o">+=</span> <span class="n">num_trial_blocks</span>
</span><span id="SensoryBase-462"><a href="#SensoryBase-462"><span class="linenos">462</span></a>            
</span><span id="SensoryBase-463"><a href="#SensoryBase-463"><span class="linenos">463</span></a>        <span class="n">filter_dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ntr_eff</span><span class="p">,</span> <span class="n">NW0</span><span class="p">]</span>
</span><span id="SensoryBase-464"><a href="#SensoryBase-464"><span class="linenos">464</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> time points, </span><span class="si">%d</span><span class="s2"> LV indices&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">LVindex_count</span><span class="p">))</span>
</span><span id="SensoryBase-465"><a href="#SensoryBase-465"><span class="linenos">465</span></a>        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">filter_dims</span>
</span><span id="SensoryBase-466"><a href="#SensoryBase-466"><span class="linenos">466</span></a>        <span class="c1"># END SensoryBase.setup_LVLayer_input()</span>
</span><span id="SensoryBase-467"><a href="#SensoryBase-467"><span class="linenos">467</span></a>
</span><span id="SensoryBase-468"><a href="#SensoryBase-468"><span class="linenos">468</span></a>    <span class="nd">@staticmethod</span>
</span><span id="SensoryBase-469"><a href="#SensoryBase-469"><span class="linenos">469</span></a>    <span class="k">def</span> <span class="nf">design_matrix_drift</span><span class="p">(</span> <span class="n">NT</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">zero_right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">to_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="SensoryBase-470"><a href="#SensoryBase-470"><span class="linenos">470</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-471"><a href="#SensoryBase-471"><span class="linenos">471</span></a><span class="sd">        Produce a design matrix based on continuous data (s) and anchor points for a tent_basis.</span>
</span><span id="SensoryBase-472"><a href="#SensoryBase-472"><span class="linenos">472</span></a><span class="sd">        Here s is a continuous variable (e.g., a stimulus) that is function of time -- single dimension --</span>
</span><span id="SensoryBase-473"><a href="#SensoryBase-473"><span class="linenos">473</span></a><span class="sd">        and this will generate apply a tent basis set to s with a basis variable for each anchor point. </span>
</span><span id="SensoryBase-474"><a href="#SensoryBase-474"><span class="linenos">474</span></a><span class="sd">        The end anchor points will be one-sided, but these can be dropped by changing &quot;zero_left&quot; and/or</span>
</span><span id="SensoryBase-475"><a href="#SensoryBase-475"><span class="linenos">475</span></a><span class="sd">        &quot;zero_right&quot; into &quot;True&quot;.</span>
</span><span id="SensoryBase-476"><a href="#SensoryBase-476"><span class="linenos">476</span></a>
</span><span id="SensoryBase-477"><a href="#SensoryBase-477"><span class="linenos">477</span></a><span class="sd">        Args: </span>
</span><span id="SensoryBase-478"><a href="#SensoryBase-478"><span class="linenos">478</span></a><span class="sd">            NT: length of design matrix</span>
</span><span id="SensoryBase-479"><a href="#SensoryBase-479"><span class="linenos">479</span></a><span class="sd">            anchors: list or array of anchor points for tent-basis set</span>
</span><span id="SensoryBase-480"><a href="#SensoryBase-480"><span class="linenos">480</span></a><span class="sd">            zero_left, zero_right: boolean whether to drop the edge bases (default for both is False)</span>
</span><span id="SensoryBase-481"><a href="#SensoryBase-481"><span class="linenos">481</span></a><span class="sd">            const_left, const_right: boolean whether to make constant basis on left/right (default for both is False)</span>
</span><span id="SensoryBase-482"><a href="#SensoryBase-482"><span class="linenos">482</span></a><span class="sd">            to_plot: whether to plot the design matrix</span>
</span><span id="SensoryBase-483"><a href="#SensoryBase-483"><span class="linenos">483</span></a><span class="sd">        </span>
</span><span id="SensoryBase-484"><a href="#SensoryBase-484"><span class="linenos">484</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase-485"><a href="#SensoryBase-485"><span class="linenos">485</span></a><span class="sd">            X: design matrix that will be NT x the number of anchors left after zeroing out left and right</span>
</span><span id="SensoryBase-486"><a href="#SensoryBase-486"><span class="linenos">486</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-487"><a href="#SensoryBase-487"><span class="linenos">487</span></a>        <span class="n">anchors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span>
</span><span id="SensoryBase-488"><a href="#SensoryBase-488"><span class="linenos">488</span></a>        <span class="k">if</span> <span class="n">anchors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SensoryBase-489"><a href="#SensoryBase-489"><span class="linenos">489</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">const_left</span><span class="p">:</span>
</span><span id="SensoryBase-490"><a href="#SensoryBase-490"><span class="linenos">490</span></a>                <span class="n">anchors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">anchors</span>
</span><span id="SensoryBase-491"><a href="#SensoryBase-491"><span class="linenos">491</span></a>        <span class="c1">#if anchors[-1] &lt; NT:</span>
</span><span id="SensoryBase-492"><a href="#SensoryBase-492"><span class="linenos">492</span></a>        <span class="c1">#    anchors = anchors + [NT]</span>
</span><span id="SensoryBase-493"><a href="#SensoryBase-493"><span class="linenos">493</span></a>        <span class="n">NA</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span>
</span><span id="SensoryBase-494"><a href="#SensoryBase-494"><span class="linenos">494</span></a>
</span><span id="SensoryBase-495"><a href="#SensoryBase-495"><span class="linenos">495</span></a>        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NT</span><span class="p">,</span> <span class="n">NA</span><span class="p">])</span>
</span><span id="SensoryBase-496"><a href="#SensoryBase-496"><span class="linenos">496</span></a>        <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NA</span><span class="p">):</span>
</span><span id="SensoryBase-497"><a href="#SensoryBase-497"><span class="linenos">497</span></a>            <span class="k">if</span> <span class="n">aa</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SensoryBase-498"><a href="#SensoryBase-498"><span class="linenos">498</span></a>                <span class="n">dx</span> <span class="o">=</span> <span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="p">]</span><span class="o">-</span><span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SensoryBase-499"><a href="#SensoryBase-499"><span class="linenos">499</span></a>                <span class="n">X</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="p">]),</span> <span class="n">aa</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span>
</span><span id="SensoryBase-500"><a href="#SensoryBase-500"><span class="linenos">500</span></a>            <span class="k">if</span> <span class="n">aa</span> <span class="o">&lt;</span> <span class="n">NA</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="SensoryBase-501"><a href="#SensoryBase-501"><span class="linenos">501</span></a>                <span class="n">dx</span> <span class="o">=</span> <span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="p">]</span>
</span><span id="SensoryBase-502"><a href="#SensoryBase-502"><span class="linenos">502</span></a>                <span class="n">X</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="p">],</span> <span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span> <span class="n">aa</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span>
</span><span id="SensoryBase-503"><a href="#SensoryBase-503"><span class="linenos">503</span></a>
</span><span id="SensoryBase-504"><a href="#SensoryBase-504"><span class="linenos">504</span></a>        <span class="k">if</span> <span class="n">zero_left</span><span class="p">:</span>
</span><span id="SensoryBase-505"><a href="#SensoryBase-505"><span class="linenos">505</span></a>            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
</span><span id="SensoryBase-506"><a href="#SensoryBase-506"><span class="linenos">506</span></a>        <span class="k">elif</span> <span class="n">const_left</span><span class="p">:</span>  <span class="c1"># makes constant from first anchor back to origin -- wont work without zero-left</span>
</span><span id="SensoryBase-507"><a href="#SensoryBase-507"><span class="linenos">507</span></a>            <span class="n">X</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">anchors</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="SensoryBase-508"><a href="#SensoryBase-508"><span class="linenos">508</span></a>
</span><span id="SensoryBase-509"><a href="#SensoryBase-509"><span class="linenos">509</span></a>        <span class="k">if</span> <span class="n">const_right</span><span class="p">:</span>
</span><span id="SensoryBase-510"><a href="#SensoryBase-510"><span class="linenos">510</span></a>            <span class="n">X</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">anchors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">NT</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="SensoryBase-511"><a href="#SensoryBase-511"><span class="linenos">511</span></a>
</span><span id="SensoryBase-512"><a href="#SensoryBase-512"><span class="linenos">512</span></a>        <span class="k">if</span> <span class="n">zero_right</span><span class="p">:</span>
</span><span id="SensoryBase-513"><a href="#SensoryBase-513"><span class="linenos">513</span></a>            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SensoryBase-514"><a href="#SensoryBase-514"><span class="linenos">514</span></a>
</span><span id="SensoryBase-515"><a href="#SensoryBase-515"><span class="linenos">515</span></a>        <span class="k">if</span> <span class="n">to_plot</span><span class="p">:</span>
</span><span id="SensoryBase-516"><a href="#SensoryBase-516"><span class="linenos">516</span></a>            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span id="SensoryBase-517"><a href="#SensoryBase-517"><span class="linenos">517</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
</span><span id="SensoryBase-518"><a href="#SensoryBase-518"><span class="linenos">518</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="SensoryBase-519"><a href="#SensoryBase-519"><span class="linenos">519</span></a>
</span><span id="SensoryBase-520"><a href="#SensoryBase-520"><span class="linenos">520</span></a>        <span class="k">return</span> <span class="n">X</span>
</span><span id="SensoryBase-521"><a href="#SensoryBase-521"><span class="linenos">521</span></a>    
</span><span id="SensoryBase-522"><a href="#SensoryBase-522"><span class="linenos">522</span></a>    <span class="nd">@staticmethod</span>
</span><span id="SensoryBase-523"><a href="#SensoryBase-523"><span class="linenos">523</span></a>    <span class="k">def</span> <span class="nf">construct_onehot_design_matrix</span><span class="p">(</span> <span class="n">stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_categories</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="SensoryBase-524"><a href="#SensoryBase-524"><span class="linenos">524</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-525"><a href="#SensoryBase-525"><span class="linenos">525</span></a><span class="sd">        Construct one-hot design matrix from stimulus.</span>
</span><span id="SensoryBase-526"><a href="#SensoryBase-526"><span class="linenos">526</span></a>
</span><span id="SensoryBase-527"><a href="#SensoryBase-527"><span class="linenos">527</span></a><span class="sd">        The stimulus should be numpy -- not meant to be used with torch currently.</span>
</span><span id="SensoryBase-528"><a href="#SensoryBase-528"><span class="linenos">528</span></a><span class="sd">        </span>
</span><span id="SensoryBase-529"><a href="#SensoryBase-529"><span class="linenos">529</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase-530"><a href="#SensoryBase-530"><span class="linenos">530</span></a><span class="sd">            stim: the stimulus to construct one-hot design matrix from</span>
</span><span id="SensoryBase-531"><a href="#SensoryBase-531"><span class="linenos">531</span></a><span class="sd">            return_categories: whether to return the categories</span>
</span><span id="SensoryBase-532"><a href="#SensoryBase-532"><span class="linenos">532</span></a>
</span><span id="SensoryBase-533"><a href="#SensoryBase-533"><span class="linenos">533</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase-534"><a href="#SensoryBase-534"><span class="linenos">534</span></a><span class="sd">            OHmatrix: the one-hot design matrix</span>
</span><span id="SensoryBase-535"><a href="#SensoryBase-535"><span class="linenos">535</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-536"><a href="#SensoryBase-536"><span class="linenos">536</span></a>        <span class="k">assert</span> <span class="n">stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must pass in stimulus&quot;</span>
</span><span id="SensoryBase-537"><a href="#SensoryBase-537"><span class="linenos">537</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;Stimulus must be one-dimensional&quot;</span>
</span><span id="SensoryBase-538"><a href="#SensoryBase-538"><span class="linenos">538</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">stim</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="p">),</span> <span class="s2">&quot;stim must be a numpy array&quot;</span>
</span><span id="SensoryBase-539"><a href="#SensoryBase-539"><span class="linenos">539</span></a>
</span><span id="SensoryBase-540"><a href="#SensoryBase-540"><span class="linenos">540</span></a>        <span class="n">category_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="SensoryBase-541"><a href="#SensoryBase-541"><span class="linenos">541</span></a>        <span class="n">NSTIM</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">category_list</span><span class="p">)</span>
</span><span id="SensoryBase-542"><a href="#SensoryBase-542"><span class="linenos">542</span></a>        <span class="k">assert</span> <span class="n">NSTIM</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;Must have less than 50 classifications in one-hot: something wrong?&quot;</span>
</span><span id="SensoryBase-543"><a href="#SensoryBase-543"><span class="linenos">543</span></a>        <span class="n">OHmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">NSTIM</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="SensoryBase-544"><a href="#SensoryBase-544"><span class="linenos">544</span></a>        <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NSTIM</span><span class="p">):</span>
</span><span id="SensoryBase-545"><a href="#SensoryBase-545"><span class="linenos">545</span></a>            <span class="n">OHmatrix</span><span class="p">[</span><span class="n">stim</span> <span class="o">==</span> <span class="n">category_list</span><span class="p">[</span><span class="n">ss</span><span class="p">],</span> <span class="n">ss</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="SensoryBase-546"><a href="#SensoryBase-546"><span class="linenos">546</span></a>        
</span><span id="SensoryBase-547"><a href="#SensoryBase-547"><span class="linenos">547</span></a>        <span class="k">if</span> <span class="n">return_categories</span><span class="p">:</span>
</span><span id="SensoryBase-548"><a href="#SensoryBase-548"><span class="linenos">548</span></a>            <span class="k">return</span> <span class="n">OHmatrix</span><span class="p">,</span> <span class="n">category_list</span>
</span><span id="SensoryBase-549"><a href="#SensoryBase-549"><span class="linenos">549</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-550"><a href="#SensoryBase-550"><span class="linenos">550</span></a>            <span class="k">return</span> <span class="n">OHmatrix</span>
</span><span id="SensoryBase-551"><a href="#SensoryBase-551"><span class="linenos">551</span></a>    <span class="c1"># END staticmethod.construct_onehot_design_matrix()</span>
</span><span id="SensoryBase-552"><a href="#SensoryBase-552"><span class="linenos">552</span></a>
</span><span id="SensoryBase-553"><a href="#SensoryBase-553"><span class="linenos">553</span></a>    <span class="k">def</span> <span class="nf">avrates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="SensoryBase-554"><a href="#SensoryBase-554"><span class="linenos">554</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-555"><a href="#SensoryBase-555"><span class="linenos">555</span></a><span class="sd">        Calculates average firing probability across specified inds (or whole dataset)</span>
</span><span id="SensoryBase-556"><a href="#SensoryBase-556"><span class="linenos">556</span></a><span class="sd">        -- Note will respect datafilters</span>
</span><span id="SensoryBase-557"><a href="#SensoryBase-557"><span class="linenos">557</span></a><span class="sd">        -- will return precalc value to save time if already stored</span>
</span><span id="SensoryBase-558"><a href="#SensoryBase-558"><span class="linenos">558</span></a>
</span><span id="SensoryBase-559"><a href="#SensoryBase-559"><span class="linenos">559</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase-560"><a href="#SensoryBase-560"><span class="linenos">560</span></a><span class="sd">            inds: the indices to calculate the average firing probability across</span>
</span><span id="SensoryBase-561"><a href="#SensoryBase-561"><span class="linenos">561</span></a>
</span><span id="SensoryBase-562"><a href="#SensoryBase-562"><span class="linenos">562</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase-563"><a href="#SensoryBase-563"><span class="linenos">563</span></a><span class="sd">            avRs: the average firing probability</span>
</span><span id="SensoryBase-564"><a href="#SensoryBase-564"><span class="linenos">564</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-565"><a href="#SensoryBase-565"><span class="linenos">565</span></a>        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase-566"><a href="#SensoryBase-566"><span class="linenos">566</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="SensoryBase-567"><a href="#SensoryBase-567"><span class="linenos">567</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SensoryBase-568"><a href="#SensoryBase-568"><span class="linenos">568</span></a>            <span class="n">cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">)</span>
</span><span id="SensoryBase-569"><a href="#SensoryBase-569"><span class="linenos">569</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-570"><a href="#SensoryBase-570"><span class="linenos">570</span></a>            <span class="n">cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span>
</span><span id="SensoryBase-571"><a href="#SensoryBase-571"><span class="linenos">571</span></a>
</span><span id="SensoryBase-572"><a href="#SensoryBase-572"><span class="linenos">572</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="SensoryBase-573"><a href="#SensoryBase-573"><span class="linenos">573</span></a>            <span class="c1"># then calculate across whole dataset</span>
</span><span id="SensoryBase-574"><a href="#SensoryBase-574"><span class="linenos">574</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase-575"><a href="#SensoryBase-575"><span class="linenos">575</span></a>                <span class="c1"># then precalculated and do not need to do</span>
</span><span id="SensoryBase-576"><a href="#SensoryBase-576"><span class="linenos">576</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span><span class="p">[</span><span class="n">cells</span><span class="p">]</span>
</span><span id="SensoryBase-577"><a href="#SensoryBase-577"><span class="linenos">577</span></a>
</span><span id="SensoryBase-578"><a href="#SensoryBase-578"><span class="linenos">578</span></a>        <span class="c1"># Otherwise calculate across all data</span>
</span><span id="SensoryBase-579"><a href="#SensoryBase-579"><span class="linenos">579</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="SensoryBase-580"><a href="#SensoryBase-580"><span class="linenos">580</span></a>            <span class="n">Reff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="SensoryBase-581"><a href="#SensoryBase-581"><span class="linenos">581</span></a>            <span class="n">Teff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="SensoryBase-582"><a href="#SensoryBase-582"><span class="linenos">582</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="o">/</span><span class="n">Teff</span><span class="p">)[</span><span class="n">cells</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="SensoryBase-583"><a href="#SensoryBase-583"><span class="linenos">583</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-584"><a href="#SensoryBase-584"><span class="linenos">584</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Still need to implement avRs without preloading&#39;</span><span class="p">)</span>
</span><span id="SensoryBase-585"><a href="#SensoryBase-585"><span class="linenos">585</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="SensoryBase-586"><a href="#SensoryBase-586"><span class="linenos">586</span></a>    <span class="c1"># END .avrates()</span>
</span><span id="SensoryBase-587"><a href="#SensoryBase-587"><span class="linenos">587</span></a>
</span><span id="SensoryBase-588"><a href="#SensoryBase-588"><span class="linenos">588</span></a>    <span class="k">def</span> <span class="nf">crossval_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test_set</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="SensoryBase-589"><a href="#SensoryBase-589"><span class="linenos">589</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-590"><a href="#SensoryBase-590"><span class="linenos">590</span></a><span class="sd">        This sets the cross-validation indices up We can add featuers here. Many ways to do this</span>
</span><span id="SensoryBase-591"><a href="#SensoryBase-591"><span class="linenos">591</span></a><span class="sd">        but will stick to some standard for now. It sets the internal indices, which can be read out</span>
</span><span id="SensoryBase-592"><a href="#SensoryBase-592"><span class="linenos">592</span></a><span class="sd">        directly or with helper functions. Perhaps helper_functions is the best way....</span>
</span><span id="SensoryBase-593"><a href="#SensoryBase-593"><span class="linenos">593</span></a><span class="sd">        </span>
</span><span id="SensoryBase-594"><a href="#SensoryBase-594"><span class="linenos">594</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase-595"><a href="#SensoryBase-595"><span class="linenos">595</span></a><span class="sd">            folds: the number of folds to use</span>
</span><span id="SensoryBase-596"><a href="#SensoryBase-596"><span class="linenos">596</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="SensoryBase-597"><a href="#SensoryBase-597"><span class="linenos">597</span></a><span class="sd">            test_set: whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</span>
</span><span id="SensoryBase-598"><a href="#SensoryBase-598"><span class="linenos">598</span></a><span class="sd">            verbose: whether to print out the number of fixations in each set</span>
</span><span id="SensoryBase-599"><a href="#SensoryBase-599"><span class="linenos">599</span></a>
</span><span id="SensoryBase-600"><a href="#SensoryBase-600"><span class="linenos">600</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase-601"><a href="#SensoryBase-601"><span class="linenos">601</span></a><span class="sd">            None: sets internal variables test_inds, train_inds, val_inds</span>
</span><span id="SensoryBase-602"><a href="#SensoryBase-602"><span class="linenos">602</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-603"><a href="#SensoryBase-603"><span class="linenos">603</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must first specify valid_indices before setting up cross-validation.&quot;</span>
</span><span id="SensoryBase-604"><a href="#SensoryBase-604"><span class="linenos">604</span></a>
</span><span id="SensoryBase-605"><a href="#SensoryBase-605"><span class="linenos">605</span></a>        <span class="c1"># Reflect block structure</span>
</span><span id="SensoryBase-606"><a href="#SensoryBase-606"><span class="linenos">606</span></a>        <span class="n">Nblks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="SensoryBase-607"><a href="#SensoryBase-607"><span class="linenos">607</span></a>        <span class="n">val_blk1</span><span class="p">,</span> <span class="n">tr_blk1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="n">Nblks</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="SensoryBase-608"><a href="#SensoryBase-608"><span class="linenos">608</span></a>
</span><span id="SensoryBase-609"><a href="#SensoryBase-609"><span class="linenos">609</span></a>        <span class="k">if</span> <span class="n">test_set</span><span class="p">:</span>
</span><span id="SensoryBase-610"><a href="#SensoryBase-610"><span class="linenos">610</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="n">val_blk1</span>
</span><span id="SensoryBase-611"><a href="#SensoryBase-611"><span class="linenos">611</span></a>            <span class="n">val_blk2</span><span class="p">,</span> <span class="n">tr_blk2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_blk1</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="SensoryBase-612"><a href="#SensoryBase-612"><span class="linenos">612</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span><span class="p">[</span><span class="n">val_blk2</span><span class="p">]</span>
</span><span id="SensoryBase-613"><a href="#SensoryBase-613"><span class="linenos">613</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span><span class="p">[</span><span class="n">tr_blk2</span><span class="p">]</span>
</span><span id="SensoryBase-614"><a href="#SensoryBase-614"><span class="linenos">614</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-615"><a href="#SensoryBase-615"><span class="linenos">615</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">val_blk1</span>
</span><span id="SensoryBase-616"><a href="#SensoryBase-616"><span class="linenos">616</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span>
</span><span id="SensoryBase-617"><a href="#SensoryBase-617"><span class="linenos">617</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase-618"><a href="#SensoryBase-618"><span class="linenos">618</span></a>
</span><span id="SensoryBase-619"><a href="#SensoryBase-619"><span class="linenos">619</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="SensoryBase-620"><a href="#SensoryBase-620"><span class="linenos">620</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Partitioned </span><span class="si">%d</span><span class="s2"> fixations total: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span>
</span><span id="SensoryBase-621"><a href="#SensoryBase-621"><span class="linenos">621</span></a>                <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">)))</span>  
</span><span id="SensoryBase-622"><a href="#SensoryBase-622"><span class="linenos">622</span></a>
</span><span id="SensoryBase-623"><a href="#SensoryBase-623"><span class="linenos">623</span></a>        <span class="c1"># Now pull indices from each saccade </span>
</span><span id="SensoryBase-624"><a href="#SensoryBase-624"><span class="linenos">624</span></a>        <span class="n">tr_inds</span><span class="p">,</span> <span class="n">te_inds</span><span class="p">,</span> <span class="n">val_inds</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="SensoryBase-625"><a href="#SensoryBase-625"><span class="linenos">625</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">:</span>
</span><span id="SensoryBase-626"><a href="#SensoryBase-626"><span class="linenos">626</span></a>            <span class="n">tr_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="SensoryBase-627"><a href="#SensoryBase-627"><span class="linenos">627</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">:</span>
</span><span id="SensoryBase-628"><a href="#SensoryBase-628"><span class="linenos">628</span></a>            <span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="SensoryBase-629"><a href="#SensoryBase-629"><span class="linenos">629</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">:</span>
</span><span id="SensoryBase-630"><a href="#SensoryBase-630"><span class="linenos">630</span></a>            <span class="n">te_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="SensoryBase-631"><a href="#SensoryBase-631"><span class="linenos">631</span></a>
</span><span id="SensoryBase-632"><a href="#SensoryBase-632"><span class="linenos">632</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="SensoryBase-633"><a href="#SensoryBase-633"><span class="linenos">633</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Pre-valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">te_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="SensoryBase-634"><a href="#SensoryBase-634"><span class="linenos">634</span></a>
</span><span id="SensoryBase-635"><a href="#SensoryBase-635"><span class="linenos">635</span></a>        <span class="c1"># Finally intersect with used_inds</span>
</span><span id="SensoryBase-636"><a href="#SensoryBase-636"><span class="linenos">636</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SensoryBase-637"><a href="#SensoryBase-637"><span class="linenos">637</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="SensoryBase-638"><a href="#SensoryBase-638"><span class="linenos">638</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">val_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="SensoryBase-639"><a href="#SensoryBase-639"><span class="linenos">639</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">te_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="SensoryBase-640"><a href="#SensoryBase-640"><span class="linenos">640</span></a>
</span><span id="SensoryBase-641"><a href="#SensoryBase-641"><span class="linenos">641</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="SensoryBase-642"><a href="#SensoryBase-642"><span class="linenos">642</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="SensoryBase-643"><a href="#SensoryBase-643"><span class="linenos">643</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-644"><a href="#SensoryBase-644"><span class="linenos">644</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">tr_inds</span>
</span><span id="SensoryBase-645"><a href="#SensoryBase-645"><span class="linenos">645</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">val_inds</span>
</span><span id="SensoryBase-646"><a href="#SensoryBase-646"><span class="linenos">646</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">te_inds</span>
</span><span id="SensoryBase-647"><a href="#SensoryBase-647"><span class="linenos">647</span></a>            
</span><span id="SensoryBase-648"><a href="#SensoryBase-648"><span class="linenos">648</span></a>        <span class="c1"># make the inds and blks into numpy arrays</span>
</span><span id="SensoryBase-649"><a href="#SensoryBase-649"><span class="linenos">649</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">)</span>
</span><span id="SensoryBase-650"><a href="#SensoryBase-650"><span class="linenos">650</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">)</span>
</span><span id="SensoryBase-651"><a href="#SensoryBase-651"><span class="linenos">651</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span><span class="p">)</span>
</span><span id="SensoryBase-652"><a href="#SensoryBase-652"><span class="linenos">652</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">)</span>
</span><span id="SensoryBase-653"><a href="#SensoryBase-653"><span class="linenos">653</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">)</span>
</span><span id="SensoryBase-654"><a href="#SensoryBase-654"><span class="linenos">654</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">)</span>
</span><span id="SensoryBase-655"><a href="#SensoryBase-655"><span class="linenos">655</span></a>        
</span><span id="SensoryBase-656"><a href="#SensoryBase-656"><span class="linenos">656</span></a>    <span class="c1"># END SensoryBase.crossval_setup</span>
</span><span id="SensoryBase-657"><a href="#SensoryBase-657"><span class="linenos">657</span></a>
</span><span id="SensoryBase-658"><a href="#SensoryBase-658"><span class="linenos">658</span></a>    <span class="k">def</span> <span class="nf">fold_sample</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">which_fold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="SensoryBase-659"><a href="#SensoryBase-659"><span class="linenos">659</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-660"><a href="#SensoryBase-660"><span class="linenos">660</span></a><span class="sd">        This really should be a general method not associated with self</span>
</span><span id="SensoryBase-661"><a href="#SensoryBase-661"><span class="linenos">661</span></a><span class="sd">        </span>
</span><span id="SensoryBase-662"><a href="#SensoryBase-662"><span class="linenos">662</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase-663"><a href="#SensoryBase-663"><span class="linenos">663</span></a><span class="sd">            num_items: the number of items to sample</span>
</span><span id="SensoryBase-664"><a href="#SensoryBase-664"><span class="linenos">664</span></a><span class="sd">            folds: the number of folds to use</span>
</span><span id="SensoryBase-665"><a href="#SensoryBase-665"><span class="linenos">665</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="SensoryBase-666"><a href="#SensoryBase-666"><span class="linenos">666</span></a><span class="sd">            which_fold: which fold to use</span>
</span><span id="SensoryBase-667"><a href="#SensoryBase-667"><span class="linenos">667</span></a>
</span><span id="SensoryBase-668"><a href="#SensoryBase-668"><span class="linenos">668</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase-669"><a href="#SensoryBase-669"><span class="linenos">669</span></a><span class="sd">            val_items: the validation items</span>
</span><span id="SensoryBase-670"><a href="#SensoryBase-670"><span class="linenos">670</span></a><span class="sd">            rem_items: the remaining items</span>
</span><span id="SensoryBase-671"><a href="#SensoryBase-671"><span class="linenos">671</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-672"><a href="#SensoryBase-672"><span class="linenos">672</span></a>        <span class="k">if</span> <span class="n">random_gen</span><span class="p">:</span>
</span><span id="SensoryBase-673"><a href="#SensoryBase-673"><span class="linenos">673</span></a>            <span class="n">num_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_items</span><span class="o">/</span><span class="n">folds</span><span class="p">)</span>
</span><span id="SensoryBase-674"><a href="#SensoryBase-674"><span class="linenos">674</span></a>            <span class="n">tmp_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">num_items</span><span class="p">)</span>
</span><span id="SensoryBase-675"><a href="#SensoryBase-675"><span class="linenos">675</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[:</span><span class="n">num_val</span><span class="p">])</span>
</span><span id="SensoryBase-676"><a href="#SensoryBase-676"><span class="linenos">676</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[</span><span class="n">num_val</span><span class="p">:])</span>
</span><span id="SensoryBase-677"><a href="#SensoryBase-677"><span class="linenos">677</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-678"><a href="#SensoryBase-678"><span class="linenos">678</span></a>            <span class="k">if</span> <span class="n">which_fold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase-679"><a href="#SensoryBase-679"><span class="linenos">679</span></a>                <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">folds</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SensoryBase-680"><a href="#SensoryBase-680"><span class="linenos">680</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-681"><a href="#SensoryBase-681"><span class="linenos">681</span></a>                <span class="n">offset</span> <span class="o">=</span> <span class="n">which_fold</span><span class="o">%</span><span class="n">folds</span>
</span><span id="SensoryBase-682"><a href="#SensoryBase-682"><span class="linenos">682</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="SensoryBase-683"><a href="#SensoryBase-683"><span class="linenos">683</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">val_items</span><span class="p">)</span>
</span><span id="SensoryBase-684"><a href="#SensoryBase-684"><span class="linenos">684</span></a>        <span class="k">return</span> <span class="n">val_items</span><span class="p">,</span> <span class="n">rem_items</span>
</span><span id="SensoryBase-685"><a href="#SensoryBase-685"><span class="linenos">685</span></a>
</span><span id="SensoryBase-686"><a href="#SensoryBase-686"><span class="linenos">686</span></a>    <span class="k">def</span> <span class="nf">speckledXV_setup</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="SensoryBase-687"><a href="#SensoryBase-687"><span class="linenos">687</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-688"><a href="#SensoryBase-688"><span class="linenos">688</span></a><span class="sd">        Produce data-filter masks for training and XV speckles</span>
</span><span id="SensoryBase-689"><a href="#SensoryBase-689"><span class="linenos">689</span></a><span class="sd">        Will be produced for whole dataset, and must be reduced if cells_out used</span>
</span><span id="SensoryBase-690"><a href="#SensoryBase-690"><span class="linenos">690</span></a>
</span><span id="SensoryBase-691"><a href="#SensoryBase-691"><span class="linenos">691</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase-692"><a href="#SensoryBase-692"><span class="linenos">692</span></a><span class="sd">            folds: the number of folds to use</span>
</span><span id="SensoryBase-693"><a href="#SensoryBase-693"><span class="linenos">693</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="SensoryBase-694"><a href="#SensoryBase-694"><span class="linenos">694</span></a>
</span><span id="SensoryBase-695"><a href="#SensoryBase-695"><span class="linenos">695</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase-696"><a href="#SensoryBase-696"><span class="linenos">696</span></a><span class="sd">            None</span>
</span><span id="SensoryBase-697"><a href="#SensoryBase-697"><span class="linenos">697</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-698"><a href="#SensoryBase-698"><span class="linenos">698</span></a>        <span class="n">Ntr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="SensoryBase-699"><a href="#SensoryBase-699"><span class="linenos">699</span></a>
</span><span id="SensoryBase-700"><a href="#SensoryBase-700"><span class="linenos">700</span></a>        <span class="c1"># Choose trials to leave out for each unit</span>
</span><span id="SensoryBase-701"><a href="#SensoryBase-701"><span class="linenos">701</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Mval</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="SensoryBase-702"><a href="#SensoryBase-702"><span class="linenos">702</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="SensoryBase-703"><a href="#SensoryBase-703"><span class="linenos">703</span></a>        <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">):</span>
</span><span id="SensoryBase-704"><a href="#SensoryBase-704"><span class="linenos">704</span></a>            <span class="n">ival</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span> 
</span><span id="SensoryBase-705"><a href="#SensoryBase-705"><span class="linenos">705</span></a>                <span class="n">Ntr</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">,</span> <span class="n">which_fold</span><span class="o">=</span><span class="n">cc</span><span class="o">%</span><span class="n">folds</span><span class="p">)</span>
</span><span id="SensoryBase-706"><a href="#SensoryBase-706"><span class="linenos">706</span></a>            <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">ival</span><span class="p">:</span>
</span><span id="SensoryBase-707"><a href="#SensoryBase-707"><span class="linenos">707</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mval</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">tr</span><span class="p">],</span> <span class="n">cc</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="SensoryBase-708"><a href="#SensoryBase-708"><span class="linenos">708</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">tr</span><span class="p">],</span> <span class="n">cc</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="SensoryBase-709"><a href="#SensoryBase-709"><span class="linenos">709</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase-710"><a href="#SensoryBase-710"><span class="linenos">710</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">])</span>
</span><span id="SensoryBase-711"><a href="#SensoryBase-711"><span class="linenos">711</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Mval_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Mval</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">])</span>
</span><span id="SensoryBase-712"><a href="#SensoryBase-712"><span class="linenos">712</span></a>    <span class="c1"># END SensoryBase.speckledXV_setup</span>
</span><span id="SensoryBase-713"><a href="#SensoryBase-713"><span class="linenos">713</span></a>    
</span><span id="SensoryBase-714"><a href="#SensoryBase-714"><span class="linenos">714</span></a>    <span class="k">def</span> <span class="nf">set_speckledXV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="SensoryBase-715"><a href="#SensoryBase-715"><span class="linenos">715</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-716"><a href="#SensoryBase-716"><span class="linenos">716</span></a><span class="sd">        Set up speckled cross-validation with data-filter masks</span>
</span><span id="SensoryBase-717"><a href="#SensoryBase-717"><span class="linenos">717</span></a>
</span><span id="SensoryBase-718"><a href="#SensoryBase-718"><span class="linenos">718</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase-719"><a href="#SensoryBase-719"><span class="linenos">719</span></a><span class="sd">            val: whether to set up speckled cross-validation</span>
</span><span id="SensoryBase-720"><a href="#SensoryBase-720"><span class="linenos">720</span></a><span class="sd">            folds: the number of folds to use</span>
</span><span id="SensoryBase-721"><a href="#SensoryBase-721"><span class="linenos">721</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="SensoryBase-722"><a href="#SensoryBase-722"><span class="linenos">722</span></a>
</span><span id="SensoryBase-723"><a href="#SensoryBase-723"><span class="linenos">723</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase-724"><a href="#SensoryBase-724"><span class="linenos">724</span></a><span class="sd">            None</span>
</span><span id="SensoryBase-725"><a href="#SensoryBase-725"><span class="linenos">725</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-726"><a href="#SensoryBase-726"><span class="linenos">726</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">speckled</span> <span class="o">=</span> <span class="n">val</span>
</span><span id="SensoryBase-727"><a href="#SensoryBase-727"><span class="linenos">727</span></a>        <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
</span><span id="SensoryBase-728"><a href="#SensoryBase-728"><span class="linenos">728</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase-729"><a href="#SensoryBase-729"><span class="linenos">729</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">speckledXV_setup</span><span class="p">(</span><span class="n">folds</span><span class="o">=</span><span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span> 
</span><span id="SensoryBase-730"><a href="#SensoryBase-730"><span class="linenos">730</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SensoryBase-731"><a href="#SensoryBase-731"><span class="linenos">731</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mval_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mval</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="SensoryBase-732"><a href="#SensoryBase-732"><span class="linenos">732</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="SensoryBase-733"><a href="#SensoryBase-733"><span class="linenos">733</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-734"><a href="#SensoryBase-734"><span class="linenos">734</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mval_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase-735"><a href="#SensoryBase-735"><span class="linenos">735</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase-736"><a href="#SensoryBase-736"><span class="linenos">736</span></a>    <span class="c1"># END SensoryBase.set_speckledXV</span>
</span><span id="SensoryBase-737"><a href="#SensoryBase-737"><span class="linenos">737</span></a>
</span><span id="SensoryBase-738"><a href="#SensoryBase-738"><span class="linenos">738</span></a>    <span class="k">def</span> <span class="nf">make_data_dicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="SensoryBase-739"><a href="#SensoryBase-739"><span class="linenos">739</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-740"><a href="#SensoryBase-740"><span class="linenos">740</span></a><span class="sd">        Usage: train_ds, val_ds = dataset.make_data_dicts( device=None, all=False )</span>
</span><span id="SensoryBase-741"><a href="#SensoryBase-741"><span class="linenos">741</span></a><span class="sd">        </span>
</span><span id="SensoryBase-742"><a href="#SensoryBase-742"><span class="linenos">742</span></a><span class="sd">        Produce generic datasets on device of choice</span>
</span><span id="SensoryBase-743"><a href="#SensoryBase-743"><span class="linenos">743</span></a><span class="sd">        device defaults to cuda-0</span>
</span><span id="SensoryBase-744"><a href="#SensoryBase-744"><span class="linenos">744</span></a><span class="sd">        If &lt;all&gt; is True, then will make single dataset without XVal</span>
</span><span id="SensoryBase-745"><a href="#SensoryBase-745"><span class="linenos">745</span></a>
</span><span id="SensoryBase-746"><a href="#SensoryBase-746"><span class="linenos">746</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase-747"><a href="#SensoryBase-747"><span class="linenos">747</span></a><span class="sd">            device: the device to put the datasets on</span>
</span><span id="SensoryBase-748"><a href="#SensoryBase-748"><span class="linenos">748</span></a><span class="sd">            all: whether to use all data</span>
</span><span id="SensoryBase-749"><a href="#SensoryBase-749"><span class="linenos">749</span></a><span class="sd">        </span>
</span><span id="SensoryBase-750"><a href="#SensoryBase-750"><span class="linenos">750</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase-751"><a href="#SensoryBase-751"><span class="linenos">751</span></a><span class="sd">            train_ds: the training dataset</span>
</span><span id="SensoryBase-752"><a href="#SensoryBase-752"><span class="linenos">752</span></a><span class="sd">            val_ds: the validation dataset</span>
</span><span id="SensoryBase-753"><a href="#SensoryBase-753"><span class="linenos">753</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-754"><a href="#SensoryBase-754"><span class="linenos">754</span></a>        <span class="kn">from</span> <span class="nn">NTdatasets.generic</span> <span class="kn">import</span> <span class="n">GenericDataset</span>
</span><span id="SensoryBase-755"><a href="#SensoryBase-755"><span class="linenos">755</span></a>
</span><span id="SensoryBase-756"><a href="#SensoryBase-756"><span class="linenos">756</span></a>        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase-757"><a href="#SensoryBase-757"><span class="linenos">757</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Datasets will be on cuda:0&#39;</span><span class="p">)</span>
</span><span id="SensoryBase-758"><a href="#SensoryBase-758"><span class="linenos">758</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
</span><span id="SensoryBase-759"><a href="#SensoryBase-759"><span class="linenos">759</span></a>
</span><span id="SensoryBase-760"><a href="#SensoryBase-760"><span class="linenos">760</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speckled</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">:</span>
</span><span id="SensoryBase-761"><a href="#SensoryBase-761"><span class="linenos">761</span></a>            <span class="n">trn_inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</span><span id="SensoryBase-762"><a href="#SensoryBase-762"><span class="linenos">762</span></a>            <span class="n">val_inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</span><span id="SensoryBase-763"><a href="#SensoryBase-763"><span class="linenos">763</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-764"><a href="#SensoryBase-764"><span class="linenos">764</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_sample</span><span class="p">,</span> <span class="s2">&quot;trial-sample will not work with generic datasets&quot;</span>
</span><span id="SensoryBase-765"><a href="#SensoryBase-765"><span class="linenos">765</span></a>            <span class="n">trn_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span>
</span><span id="SensoryBase-766"><a href="#SensoryBase-766"><span class="linenos">766</span></a>            <span class="n">val_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span>
</span><span id="SensoryBase-767"><a href="#SensoryBase-767"><span class="linenos">767</span></a>
</span><span id="SensoryBase-768"><a href="#SensoryBase-768"><span class="linenos">768</span></a>        <span class="n">ks</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="SensoryBase-769"><a href="#SensoryBase-769"><span class="linenos">769</span></a>        <span class="n">dictTRN</span><span class="p">,</span> <span class="n">dictVAL</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
</span><span id="SensoryBase-770"><a href="#SensoryBase-770"><span class="linenos">770</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ks</span><span class="p">:</span>
</span><span id="SensoryBase-771"><a href="#SensoryBase-771"><span class="linenos">771</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">,</span> <span class="s1">&#39;Mtrn&#39;</span><span class="p">,</span> <span class="s1">&#39;Mval&#39;</span><span class="p">]):</span>
</span><span id="SensoryBase-772"><a href="#SensoryBase-772"><span class="linenos">772</span></a>                <span class="n">dictTRN</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">trn_inds</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>
</span><span id="SensoryBase-773"><a href="#SensoryBase-773"><span class="linenos">773</span></a>                <span class="n">dictVAL</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">val_inds</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>
</span><span id="SensoryBase-774"><a href="#SensoryBase-774"><span class="linenos">774</span></a>
</span><span id="SensoryBase-775"><a href="#SensoryBase-775"><span class="linenos">775</span></a>        <span class="k">if</span> <span class="nb">all</span><span class="p">:</span>
</span><span id="SensoryBase-776"><a href="#SensoryBase-776"><span class="linenos">776</span></a>            <span class="n">dictTRN</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:][</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span>
</span><span id="SensoryBase-777"><a href="#SensoryBase-777"><span class="linenos">777</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-778"><a href="#SensoryBase-778"><span class="linenos">778</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speckled</span><span class="p">:</span>
</span><span id="SensoryBase-779"><a href="#SensoryBase-779"><span class="linenos">779</span></a>                <span class="k">assert</span> <span class="p">(</span><span class="s1">&#39;Mtrn&#39;</span> <span class="ow">in</span> <span class="n">ks</span><span class="p">),</span> <span class="s2">&quot;speckled not set on dataset&quot;</span>
</span><span id="SensoryBase-780"><a href="#SensoryBase-780"><span class="linenos">780</span></a>                <span class="n">dictTRN</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:][</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[:][</span><span class="s1">&#39;Mtrn&#39;</span><span class="p">]</span>
</span><span id="SensoryBase-781"><a href="#SensoryBase-781"><span class="linenos">781</span></a>                <span class="n">dictVAL</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:][</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[:][</span><span class="s1">&#39;Mval&#39;</span><span class="p">]</span>
</span><span id="SensoryBase-782"><a href="#SensoryBase-782"><span class="linenos">782</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-783"><a href="#SensoryBase-783"><span class="linenos">783</span></a>                <span class="n">dictTRN</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">trn_inds</span><span class="p">][</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span>
</span><span id="SensoryBase-784"><a href="#SensoryBase-784"><span class="linenos">784</span></a>                <span class="n">dictVAL</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">val_inds</span><span class="p">][</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span>
</span><span id="SensoryBase-785"><a href="#SensoryBase-785"><span class="linenos">785</span></a>
</span><span id="SensoryBase-786"><a href="#SensoryBase-786"><span class="linenos">786</span></a>        <span class="n">train_ds</span> <span class="o">=</span> <span class="n">GenericDataset</span><span class="p">(</span> <span class="n">dictTRN</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span> <span class="p">)</span>
</span><span id="SensoryBase-787"><a href="#SensoryBase-787"><span class="linenos">787</span></a>        <span class="k">if</span> <span class="nb">all</span><span class="p">:</span>
</span><span id="SensoryBase-788"><a href="#SensoryBase-788"><span class="linenos">788</span></a>            <span class="k">return</span> <span class="n">train_ds</span>
</span><span id="SensoryBase-789"><a href="#SensoryBase-789"><span class="linenos">789</span></a>
</span><span id="SensoryBase-790"><a href="#SensoryBase-790"><span class="linenos">790</span></a>        <span class="n">val_ds</span> <span class="o">=</span> <span class="n">GenericDataset</span><span class="p">(</span> <span class="n">dictVAL</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span> <span class="p">)</span>
</span><span id="SensoryBase-791"><a href="#SensoryBase-791"><span class="linenos">791</span></a>        <span class="k">return</span> <span class="n">train_ds</span><span class="p">,</span> <span class="n">val_ds</span>
</span><span id="SensoryBase-792"><a href="#SensoryBase-792"><span class="linenos">792</span></a>    <span class="c1"># END SensoryBase.make_data_dicts()</span>
</span><span id="SensoryBase-793"><a href="#SensoryBase-793"><span class="linenos">793</span></a>
</span><span id="SensoryBase-794"><a href="#SensoryBase-794"><span class="linenos">794</span></a>    <span class="k">def</span> <span class="nf">get_max_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpu_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nquad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mf">1.2</span><span class="p">):</span>
</span><span id="SensoryBase-795"><a href="#SensoryBase-795"><span class="linenos">795</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-796"><a href="#SensoryBase-796"><span class="linenos">796</span></a><span class="sd">        get the maximum number of samples that fit in memory -- for GLM/GQM x LBFGS</span>
</span><span id="SensoryBase-797"><a href="#SensoryBase-797"><span class="linenos">797</span></a>
</span><span id="SensoryBase-798"><a href="#SensoryBase-798"><span class="linenos">798</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase-799"><a href="#SensoryBase-799"><span class="linenos">799</span></a><span class="sd">            gpu_n: the gpu number to use</span>
</span><span id="SensoryBase-800"><a href="#SensoryBase-800"><span class="linenos">800</span></a><span class="sd">            history_size: the history size</span>
</span><span id="SensoryBase-801"><a href="#SensoryBase-801"><span class="linenos">801</span></a><span class="sd">            nquad: the number of quadrature points</span>
</span><span id="SensoryBase-802"><a href="#SensoryBase-802"><span class="linenos">802</span></a><span class="sd">            num_cells: the number of cells to use</span>
</span><span id="SensoryBase-803"><a href="#SensoryBase-803"><span class="linenos">803</span></a><span class="sd">            buffer: the buffer to use</span>
</span><span id="SensoryBase-804"><a href="#SensoryBase-804"><span class="linenos">804</span></a>
</span><span id="SensoryBase-805"><a href="#SensoryBase-805"><span class="linenos">805</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase-806"><a href="#SensoryBase-806"><span class="linenos">806</span></a><span class="sd">            maxsamples: the maximum number of samples that fit in memory</span>
</span><span id="SensoryBase-807"><a href="#SensoryBase-807"><span class="linenos">807</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-808"><a href="#SensoryBase-808"><span class="linenos">808</span></a>        <span class="k">if</span> <span class="n">gpu_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SensoryBase-809"><a href="#SensoryBase-809"><span class="linenos">809</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
</span><span id="SensoryBase-810"><a href="#SensoryBase-810"><span class="linenos">810</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-811"><a href="#SensoryBase-811"><span class="linenos">811</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:1&#39;</span><span class="p">)</span>
</span><span id="SensoryBase-812"><a href="#SensoryBase-812"><span class="linenos">812</span></a>
</span><span id="SensoryBase-813"><a href="#SensoryBase-813"><span class="linenos">813</span></a>        <span class="k">if</span> <span class="n">num_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase-814"><a href="#SensoryBase-814"><span class="linenos">814</span></a>            <span class="n">num_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span>
</span><span id="SensoryBase-815"><a href="#SensoryBase-815"><span class="linenos">815</span></a>        
</span><span id="SensoryBase-816"><a href="#SensoryBase-816"><span class="linenos">816</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">total_memory</span>
</span><span id="SensoryBase-817"><a href="#SensoryBase-817"><span class="linenos">817</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_reserved</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="SensoryBase-818"><a href="#SensoryBase-818"><span class="linenos">818</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_allocated</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="SensoryBase-819"><a href="#SensoryBase-819"><span class="linenos">819</span></a>        <span class="n">free</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">r</span><span class="p">)</span>
</span><span id="SensoryBase-820"><a href="#SensoryBase-820"><span class="linenos">820</span></a>
</span><span id="SensoryBase-821"><a href="#SensoryBase-821"><span class="linenos">821</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SensoryBase-822"><a href="#SensoryBase-822"><span class="linenos">822</span></a>        <span class="n">mempersample</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span>
</span><span id="SensoryBase-823"><a href="#SensoryBase-823"><span class="linenos">823</span></a>    
</span><span id="SensoryBase-824"><a href="#SensoryBase-824"><span class="linenos">824</span></a>        <span class="n">mempercell</span> <span class="o">=</span> <span class="n">mempersample</span> <span class="o">*</span> <span class="p">(</span><span class="n">nquad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">history_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SensoryBase-825"><a href="#SensoryBase-825"><span class="linenos">825</span></a>        <span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">*</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span>
</span><span id="SensoryBase-826"><a href="#SensoryBase-826"><span class="linenos">826</span></a>
</span><span id="SensoryBase-827"><a href="#SensoryBase-827"><span class="linenos">827</span></a>        <span class="n">maxsamples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">free</span> <span class="o">-</span> <span class="n">mempercell</span><span class="o">*</span><span class="n">num_cells</span> <span class="o">-</span> <span class="n">buffer_bytes</span><span class="p">)</span> <span class="o">//</span> <span class="n">mempersample</span>
</span><span id="SensoryBase-828"><a href="#SensoryBase-828"><span class="linenos">828</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# samples that can fit on device: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxsamples</span><span class="p">))</span>
</span><span id="SensoryBase-829"><a href="#SensoryBase-829"><span class="linenos">829</span></a>        <span class="k">return</span> <span class="n">maxsamples</span>
</span><span id="SensoryBase-830"><a href="#SensoryBase-830"><span class="linenos">830</span></a>    <span class="c1"># END .get_max_samples</span>
</span><span id="SensoryBase-831"><a href="#SensoryBase-831"><span class="linenos">831</span></a>
</span><span id="SensoryBase-832"><a href="#SensoryBase-832"><span class="linenos">832</span></a>    <span class="k">def</span> <span class="nf">assemble_stimulus</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">):</span>
</span><span id="SensoryBase-833"><a href="#SensoryBase-833"><span class="linenos">833</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-834"><a href="#SensoryBase-834"><span class="linenos">834</span></a><span class="sd">        This function is meant to be overloaded by child classes</span>
</span><span id="SensoryBase-835"><a href="#SensoryBase-835"><span class="linenos">835</span></a>
</span><span id="SensoryBase-836"><a href="#SensoryBase-836"><span class="linenos">836</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase-837"><a href="#SensoryBase-837"><span class="linenos">837</span></a><span class="sd">            None</span>
</span><span id="SensoryBase-838"><a href="#SensoryBase-838"><span class="linenos">838</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-839"><a href="#SensoryBase-839"><span class="linenos">839</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SensoryBase: assemble_stimulus not implemented in class child.&quot;</span><span class="p">)</span>
</span><span id="SensoryBase-840"><a href="#SensoryBase-840"><span class="linenos">840</span></a>        <span class="k">return</span>
</span><span id="SensoryBase-841"><a href="#SensoryBase-841"><span class="linenos">841</span></a>
</span><span id="SensoryBase-842"><a href="#SensoryBase-842"><span class="linenos">842</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="SensoryBase-843"><a href="#SensoryBase-843"><span class="linenos">843</span></a>        <span class="k">return</span> <span class="p">{}</span>
</span><span id="SensoryBase-844"><a href="#SensoryBase-844"><span class="linenos">844</span></a>
</span><span id="SensoryBase-845"><a href="#SensoryBase-845"><span class="linenos">845</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SensoryBase-846"><a href="#SensoryBase-846"><span class="linenos">846</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SensoryBase-847"><a href="#SensoryBase-847"><span class="linenos">847</span></a>
</span><span id="SensoryBase-848"><a href="#SensoryBase-848"><span class="linenos">848</span></a>    <span class="nd">@staticmethod</span>
</span><span id="SensoryBase-849"><a href="#SensoryBase-849"><span class="linenos">849</span></a>    <span class="k">def</span> <span class="nf">is_int</span><span class="p">(</span> <span class="n">val</span> <span class="p">):</span>
</span><span id="SensoryBase-850"><a href="#SensoryBase-850"><span class="linenos">850</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-851"><a href="#SensoryBase-851"><span class="linenos">851</span></a><span class="sd">        Returns a boolean as to whether val is one of many types of integers</span>
</span><span id="SensoryBase-852"><a href="#SensoryBase-852"><span class="linenos">852</span></a>
</span><span id="SensoryBase-853"><a href="#SensoryBase-853"><span class="linenos">853</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase-854"><a href="#SensoryBase-854"><span class="linenos">854</span></a><span class="sd">            True if val is an integer, False otherwise</span>
</span><span id="SensoryBase-855"><a href="#SensoryBase-855"><span class="linenos">855</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-856"><a href="#SensoryBase-856"><span class="linenos">856</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> \
</span><span id="SensoryBase-857"><a href="#SensoryBase-857"><span class="linenos">857</span></a>            <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="ow">or</span> \
</span><span id="SensoryBase-858"><a href="#SensoryBase-858"><span class="linenos">858</span></a>            <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
</span><span id="SensoryBase-859"><a href="#SensoryBase-859"><span class="linenos">859</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="SensoryBase-860"><a href="#SensoryBase-860"><span class="linenos">860</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase-861"><a href="#SensoryBase-861"><span class="linenos">861</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="SensoryBase-862"><a href="#SensoryBase-862"><span class="linenos">862</span></a>
</span><span id="SensoryBase-863"><a href="#SensoryBase-863"><span class="linenos">863</span></a>    <span class="nd">@staticmethod</span>
</span><span id="SensoryBase-864"><a href="#SensoryBase-864"><span class="linenos">864</span></a>    <span class="k">def</span> <span class="nf">index_to_array</span><span class="p">(</span> <span class="n">index</span><span class="p">,</span> <span class="n">max_val</span> <span class="p">):</span>
</span><span id="SensoryBase-865"><a href="#SensoryBase-865"><span class="linenos">865</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase-866"><a href="#SensoryBase-866"><span class="linenos">866</span></a><span class="sd">        This converts any for index to dataset, including slices, and plain ints, into numpy array</span>
</span><span id="SensoryBase-867"><a href="#SensoryBase-867"><span class="linenos">867</span></a>
</span><span id="SensoryBase-868"><a href="#SensoryBase-868"><span class="linenos">868</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase-869"><a href="#SensoryBase-869"><span class="linenos">869</span></a><span class="sd">            index: the index to convert</span>
</span><span id="SensoryBase-870"><a href="#SensoryBase-870"><span class="linenos">870</span></a><span class="sd">            max_val: the maximum value to use</span>
</span><span id="SensoryBase-871"><a href="#SensoryBase-871"><span class="linenos">871</span></a>
</span><span id="SensoryBase-872"><a href="#SensoryBase-872"><span class="linenos">872</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase-873"><a href="#SensoryBase-873"><span class="linenos">873</span></a><span class="sd">            index: the converted index</span>
</span><span id="SensoryBase-874"><a href="#SensoryBase-874"><span class="linenos">874</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase-875"><a href="#SensoryBase-875"><span class="linenos">875</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
</span><span id="SensoryBase-876"><a href="#SensoryBase-876"><span class="linenos">876</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">start</span>
</span><span id="SensoryBase-877"><a href="#SensoryBase-877"><span class="linenos">877</span></a>            <span class="n">stop</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">stop</span>
</span><span id="SensoryBase-878"><a href="#SensoryBase-878"><span class="linenos">878</span></a>            <span class="n">step</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">step</span>
</span><span id="SensoryBase-879"><a href="#SensoryBase-879"><span class="linenos">879</span></a>            <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase-880"><a href="#SensoryBase-880"><span class="linenos">880</span></a>                <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SensoryBase-881"><a href="#SensoryBase-881"><span class="linenos">881</span></a>            <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase-882"><a href="#SensoryBase-882"><span class="linenos">882</span></a>                <span class="n">stop</span> <span class="o">=</span> <span class="n">max_val</span>
</span><span id="SensoryBase-883"><a href="#SensoryBase-883"><span class="linenos">883</span></a>            <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase-884"><a href="#SensoryBase-884"><span class="linenos">884</span></a>                <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="SensoryBase-885"><a href="#SensoryBase-885"><span class="linenos">885</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="SensoryBase-886"><a href="#SensoryBase-886"><span class="linenos">886</span></a>        <span class="k">elif</span> <span class="n">SensoryBase</span><span class="o">.</span><span class="n">is_int</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
</span><span id="SensoryBase-887"><a href="#SensoryBase-887"><span class="linenos">887</span></a>            <span class="k">return</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="SensoryBase-888"><a href="#SensoryBase-888"><span class="linenos">888</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="SensoryBase-889"><a href="#SensoryBase-889"><span class="linenos">889</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="SensoryBase-890"><a href="#SensoryBase-890"><span class="linenos">890</span></a>        <span class="k">return</span> <span class="n">index</span>
</span></pre></div>


            <div class="docstring"><p>Parent class meant to hold standard variables and functions used by general sensory datasets</p>

<p>General consistent formatting:
-- self.robs, dfs, and any design matrices are generated as torch vectors on device
-- stimuli are imported separately as dataset-specific numpy arrays, and but then prepared into 
    self.stim (tensor) by a function self.prepare_stim, which must be overloaded
-- self.stim_dims gives the dimension of self.stim in 4-dimensional format
-- all tensors are stored on default device (cpu)</p>

<p>General book-keeping variables
-- self.block_inds is empty but must be filled in by specific datasets</p>
</div>


                            <div id="SensoryBase.__init__" class="classattr">
                                        <input id="SensoryBase.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SensoryBase</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">filenames</span>,</span><span class="param">	<span class="n">datadir</span>,</span><span class="param">	<span class="n">trial_sample</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span>,</span><span class="param">	<span class="n">time_embed</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">include_MUs</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">drift_interval</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span></span>)</span>

                <label class="view-source-button" for="SensoryBase.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.__init__-27"><a href="#SensoryBase.__init__-27"><span class="linenos"> 27</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="SensoryBase.__init__-28"><a href="#SensoryBase.__init__-28"><span class="linenos"> 28</span></a>        <span class="n">filenames</span><span class="p">,</span> <span class="c1"># this could be single filename or list of filenames, to be processed in specific way</span>
</span><span id="SensoryBase.__init__-29"><a href="#SensoryBase.__init__-29"><span class="linenos"> 29</span></a>        <span class="n">datadir</span><span class="p">,</span> 
</span><span id="SensoryBase.__init__-30"><a href="#SensoryBase.__init__-30"><span class="linenos"> 30</span></a>        <span class="c1"># Stim setup</span>
</span><span id="SensoryBase.__init__-31"><a href="#SensoryBase.__init__-31"><span class="linenos"> 31</span></a>        <span class="n">trial_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="SensoryBase.__init__-32"><a href="#SensoryBase.__init__-32"><span class="linenos"> 32</span></a>        <span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="SensoryBase.__init__-33"><a href="#SensoryBase.__init__-33"><span class="linenos"> 33</span></a>        <span class="n">time_embed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="SensoryBase.__init__-34"><a href="#SensoryBase.__init__-34"><span class="linenos"> 34</span></a>        <span class="c1">#maxT = None,</span>
</span><span id="SensoryBase.__init__-35"><a href="#SensoryBase.__init__-35"><span class="linenos"> 35</span></a>        <span class="c1"># other</span>
</span><span id="SensoryBase.__init__-36"><a href="#SensoryBase.__init__-36"><span class="linenos"> 36</span></a>        <span class="n">include_MUs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="SensoryBase.__init__-37"><a href="#SensoryBase.__init__-37"><span class="linenos"> 37</span></a>        <span class="n">drift_interval</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SensoryBase.__init__-38"><a href="#SensoryBase.__init__-38"><span class="linenos"> 38</span></a>        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</span><span id="SensoryBase.__init__-39"><a href="#SensoryBase.__init__-39"><span class="linenos"> 39</span></a>        <span class="p">):</span>
</span><span id="SensoryBase.__init__-40"><a href="#SensoryBase.__init__-40"><span class="linenos"> 40</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.__init__-41"><a href="#SensoryBase.__init__-41"><span class="linenos"> 41</span></a><span class="sd">        Constructor options</span>
</span><span id="SensoryBase.__init__-42"><a href="#SensoryBase.__init__-42"><span class="linenos"> 42</span></a><span class="sd">        </span>
</span><span id="SensoryBase.__init__-43"><a href="#SensoryBase.__init__-43"><span class="linenos"> 43</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase.__init__-44"><a href="#SensoryBase.__init__-44"><span class="linenos"> 44</span></a><span class="sd">            filenames: the filenames to use</span>
</span><span id="SensoryBase.__init__-45"><a href="#SensoryBase.__init__-45"><span class="linenos"> 45</span></a><span class="sd">            datadir: the data directory</span>
</span><span id="SensoryBase.__init__-46"><a href="#SensoryBase.__init__-46"><span class="linenos"> 46</span></a><span class="sd">            trial_sample: whether to sample trials</span>
</span><span id="SensoryBase.__init__-47"><a href="#SensoryBase.__init__-47"><span class="linenos"> 47</span></a><span class="sd">            num_lags: the number of lags to use</span>
</span><span id="SensoryBase.__init__-48"><a href="#SensoryBase.__init__-48"><span class="linenos"> 48</span></a><span class="sd">            time_embed: the time embedding to use</span>
</span><span id="SensoryBase.__init__-49"><a href="#SensoryBase.__init__-49"><span class="linenos"> 49</span></a><span class="sd">            include_MUs: whether to include MUs</span>
</span><span id="SensoryBase.__init__-50"><a href="#SensoryBase.__init__-50"><span class="linenos"> 50</span></a><span class="sd">            drift_interval: the drift interval to use</span>
</span><span id="SensoryBase.__init__-51"><a href="#SensoryBase.__init__-51"><span class="linenos"> 51</span></a><span class="sd">            device: the device to use</span>
</span><span id="SensoryBase.__init__-52"><a href="#SensoryBase.__init__-52"><span class="linenos"> 52</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.__init__-53"><a href="#SensoryBase.__init__-53"><span class="linenos"> 53</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">datadir</span>
</span><span id="SensoryBase.__init__-54"><a href="#SensoryBase.__init__-54"><span class="linenos"> 54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="n">filenames</span>
</span><span id="SensoryBase.__init__-55"><a href="#SensoryBase.__init__-55"><span class="linenos"> 55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
</span><span id="SensoryBase.__init__-56"><a href="#SensoryBase.__init__-56"><span class="linenos"> 56</span></a>        
</span><span id="SensoryBase.__init__-57"><a href="#SensoryBase.__init__-57"><span class="linenos"> 57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trial_sample</span> <span class="o">=</span> <span class="n">trial_sample</span>
</span><span id="SensoryBase.__init__-58"><a href="#SensoryBase.__init__-58"><span class="linenos"> 58</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span> <span class="o">=</span> <span class="n">num_lags</span>
</span><span id="SensoryBase.__init__-59"><a href="#SensoryBase.__init__-59"><span class="linenos"> 59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase.__init__-60"><a href="#SensoryBase.__init__-60"><span class="linenos"> 60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">=</span> <span class="n">time_embed</span>
</span><span id="SensoryBase.__init__-61"><a href="#SensoryBase.__init__-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preload</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SensoryBase.__init__-62"><a href="#SensoryBase.__init__-62"><span class="linenos"> 62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span> <span class="o">=</span> <span class="n">drift_interval</span>
</span><span id="SensoryBase.__init__-63"><a href="#SensoryBase.__init__-63"><span class="linenos"> 63</span></a>
</span><span id="SensoryBase.__init__-64"><a href="#SensoryBase.__init__-64"><span class="linenos"> 64</span></a>        <span class="c1"># Assign standard variables</span>
</span><span id="SensoryBase.__init__-65"><a href="#SensoryBase.__init__-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_SUs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_MUs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="SensoryBase.__init__-66"><a href="#SensoryBase.__init__-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase.__init__-67"><a href="#SensoryBase.__init__-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">=</span> <span class="mi">0</span>    
</span><span id="SensoryBase.__init__-68"><a href="#SensoryBase.__init__-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase.__init__-69"><a href="#SensoryBase.__init__-69"><span class="linenos"> 69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_filemapping</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase.__init__-70"><a href="#SensoryBase.__init__-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span> <span class="o">=</span> <span class="n">include_MUs</span>
</span><span id="SensoryBase.__init__-71"><a href="#SensoryBase.__init__-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">SUinds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase.__init__-72"><a href="#SensoryBase.__init__-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">MUinds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase.__init__-73"><a href="#SensoryBase.__init__-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># can be list to output specific cells in get_item</span>
</span><span id="SensoryBase.__init__-74"><a href="#SensoryBase.__init__-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase.__init__-75"><a href="#SensoryBase.__init__-75"><span class="linenos"> 75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase.__init__-76"><a href="#SensoryBase.__init__-76"><span class="linenos"> 76</span></a>
</span><span id="SensoryBase.__init__-77"><a href="#SensoryBase.__init__-77"><span class="linenos"> 77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase.__init__-78"><a href="#SensoryBase.__init__-78"><span class="linenos"> 78</span></a>
</span><span id="SensoryBase.__init__-79"><a href="#SensoryBase.__init__-79"><span class="linenos"> 79</span></a>        <span class="c1"># Set up to store default train_, val_, test_inds</span>
</span><span id="SensoryBase.__init__-80"><a href="#SensoryBase.__init__-80"><span class="linenos"> 80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase.__init__-81"><a href="#SensoryBase.__init__-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase.__init__-82"><a href="#SensoryBase.__init__-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase.__init__-83"><a href="#SensoryBase.__init__-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase.__init__-84"><a href="#SensoryBase.__init__-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase.__init__-85"><a href="#SensoryBase.__init__-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase.__init__-86"><a href="#SensoryBase.__init__-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase.__init__-87"><a href="#SensoryBase.__init__-87"><span class="linenos"> 87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">speckled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SensoryBase.__init__-88"><a href="#SensoryBase.__init__-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mval</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>  <span class="c1"># Data-filter masks for speckled XV</span>
</span><span id="SensoryBase.__init__-89"><a href="#SensoryBase.__init__-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mval_out</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>  <span class="c1"># Data-filter masks for speckled XV</span>
</span><span id="SensoryBase.__init__-90"><a href="#SensoryBase.__init__-90"><span class="linenos"> 90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase.__init__-91"><a href="#SensoryBase.__init__-91"><span class="linenos"> 91</span></a>        
</span><span id="SensoryBase.__init__-92"><a href="#SensoryBase.__init__-92"><span class="linenos"> 92</span></a>        <span class="c1"># Basic default memory things</span>
</span><span id="SensoryBase.__init__-93"><a href="#SensoryBase.__init__-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase.__init__-94"><a href="#SensoryBase.__init__-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase.__init__-95"><a href="#SensoryBase.__init__-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase.__init__-96"><a href="#SensoryBase.__init__-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SensoryBase.__init__-97"><a href="#SensoryBase.__init__-97"><span class="linenos"> 97</span></a>    
</span><span id="SensoryBase.__init__-98"><a href="#SensoryBase.__init__-98"><span class="linenos"> 98</span></a>        <span class="c1"># Additional covariate list</span>
</span><span id="SensoryBase.__init__-99"><a href="#SensoryBase.__init__-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="SensoryBase.__init__-100"><a href="#SensoryBase.__init__-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cov_dims</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="SensoryBase.__init__-101"><a href="#SensoryBase.__init__-101"><span class="linenos">101</span></a>        <span class="c1"># General file i/o -- this is not general, so taking out</span>
</span><span id="SensoryBase.__init__-102"><a href="#SensoryBase.__init__-102"><span class="linenos">102</span></a>        <span class="c1">#self.fhandles = [h5py.File(os.path.join(datadir, sess + &#39;.mat&#39;), &#39;r&#39;) for sess in self.sess_list]</span>
</span></pre></div>


            <div class="docstring"><p>Constructor options</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>filenames:</strong>  the filenames to use</li>
<li><strong>datadir:</strong>  the data directory</li>
<li><strong>trial_sample:</strong>  whether to sample trials</li>
<li><strong>num_lags:</strong>  the number of lags to use</li>
<li><strong>time_embed:</strong>  the time embedding to use</li>
<li><strong>include_MUs:</strong>  whether to include MUs</li>
<li><strong>drift_interval:</strong>  the drift interval to use</li>
<li><strong>device:</strong>  the device to use</li>
</ul>
</div>


                            </div>
                            <div id="SensoryBase.datadir" class="classattr">
                                <div class="attr variable">
            <span class="name">datadir</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.datadir"></a>
    
    

                            </div>
                            <div id="SensoryBase.filenames" class="classattr">
                                <div class="attr variable">
            <span class="name">filenames</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.filenames"></a>
    
    

                            </div>
                            <div id="SensoryBase.device" class="classattr">
                                <div class="attr variable">
            <span class="name">device</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.device"></a>
    
    

                            </div>
                            <div id="SensoryBase.trial_sample" class="classattr">
                                <div class="attr variable">
            <span class="name">trial_sample</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.trial_sample"></a>
    
    

                            </div>
                            <div id="SensoryBase.num_lags" class="classattr">
                                <div class="attr variable">
            <span class="name">num_lags</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.num_lags"></a>
    
    

                            </div>
                            <div id="SensoryBase.stim_dims" class="classattr">
                                <div class="attr variable">
            <span class="name">stim_dims</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.stim_dims"></a>
    
    

                            </div>
                            <div id="SensoryBase.time_embed" class="classattr">
                                <div class="attr variable">
            <span class="name">time_embed</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.time_embed"></a>
    
    

                            </div>
                            <div id="SensoryBase.preload" class="classattr">
                                <div class="attr variable">
            <span class="name">preload</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.preload"></a>
    
    

                            </div>
                            <div id="SensoryBase.drift_interval" class="classattr">
                                <div class="attr variable">
            <span class="name">drift_interval</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.drift_interval"></a>
    
    

                            </div>
                            <div id="SensoryBase.SUs" class="classattr">
                                <div class="attr variable">
            <span class="name">SUs</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.SUs"></a>
    
    

                            </div>
                            <div id="SensoryBase.NC" class="classattr">
                                <div class="attr variable">
            <span class="name">NC</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.NC"></a>
    
    

                            </div>
                            <div id="SensoryBase.block_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">block_inds</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.block_inds"></a>
    
    

                            </div>
                            <div id="SensoryBase.block_filemapping" class="classattr">
                                <div class="attr variable">
            <span class="name">block_filemapping</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.block_filemapping"></a>
    
    

                            </div>
                            <div id="SensoryBase.include_MUs" class="classattr">
                                <div class="attr variable">
            <span class="name">include_MUs</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.include_MUs"></a>
    
    

                            </div>
                            <div id="SensoryBase.SUinds" class="classattr">
                                <div class="attr variable">
            <span class="name">SUinds</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.SUinds"></a>
    
    

                            </div>
                            <div id="SensoryBase.MUinds" class="classattr">
                                <div class="attr variable">
            <span class="name">MUinds</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.MUinds"></a>
    
    

                            </div>
                            <div id="SensoryBase.cells_out" class="classattr">
                                <div class="attr variable">
            <span class="name">cells_out</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.cells_out"></a>
    
    

                            </div>
                            <div id="SensoryBase.robs_out" class="classattr">
                                <div class="attr variable">
            <span class="name">robs_out</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.robs_out"></a>
    
    

                            </div>
                            <div id="SensoryBase.dfs_out" class="classattr">
                                <div class="attr variable">
            <span class="name">dfs_out</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.dfs_out"></a>
    
    

                            </div>
                            <div id="SensoryBase.avRs" class="classattr">
                                <div class="attr variable">
            <span class="name">avRs</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.avRs"></a>
    
    

                            </div>
                            <div id="SensoryBase.test_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">test_inds</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.test_inds"></a>
    
    

                            </div>
                            <div id="SensoryBase.val_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">val_inds</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.val_inds"></a>
    
    

                            </div>
                            <div id="SensoryBase.train_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">train_inds</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.train_inds"></a>
    
    

                            </div>
                            <div id="SensoryBase.test_blks" class="classattr">
                                <div class="attr variable">
            <span class="name">test_blks</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.test_blks"></a>
    
    

                            </div>
                            <div id="SensoryBase.val_blks" class="classattr">
                                <div class="attr variable">
            <span class="name">val_blks</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.val_blks"></a>
    
    

                            </div>
                            <div id="SensoryBase.train_blks" class="classattr">
                                <div class="attr variable">
            <span class="name">train_blks</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.train_blks"></a>
    
    

                            </div>
                            <div id="SensoryBase.used_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">used_inds</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.used_inds"></a>
    
    

                            </div>
                            <div id="SensoryBase.speckled" class="classattr">
                                <div class="attr variable">
            <span class="name">speckled</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.speckled"></a>
    
    

                            </div>
                            <div id="SensoryBase.Xdrift" class="classattr">
                                <div class="attr variable">
            <span class="name">Xdrift</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.Xdrift"></a>
    
    

                            </div>
                            <div id="SensoryBase.stim" class="classattr">
                                <div class="attr variable">
            <span class="name">stim</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.stim"></a>
    
    

                            </div>
                            <div id="SensoryBase.dfs" class="classattr">
                                <div class="attr variable">
            <span class="name">dfs</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.dfs"></a>
    
    

                            </div>
                            <div id="SensoryBase.robs" class="classattr">
                                <div class="attr variable">
            <span class="name">robs</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.robs"></a>
    
    

                            </div>
                            <div id="SensoryBase.NT" class="classattr">
                                <div class="attr variable">
            <span class="name">NT</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.NT"></a>
    
    

                            </div>
                            <div id="SensoryBase.covariates" class="classattr">
                                <div class="attr variable">
            <span class="name">covariates</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.covariates"></a>
    
    

                            </div>
                            <div id="SensoryBase.cov_dims" class="classattr">
                                <div class="attr variable">
            <span class="name">cov_dims</span>

        
    </div>
    <a class="headerlink" href="#SensoryBase.cov_dims"></a>
    
    

                            </div>
                            <div id="SensoryBase.add_covariate" class="classattr">
                                        <input id="SensoryBase.add_covariate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_covariate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">cov_name</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">cov</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.add_covariate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.add_covariate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.add_covariate-106"><a href="#SensoryBase.add_covariate-106"><span class="linenos">106</span></a>    <span class="k">def</span> <span class="nf">add_covariate</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cov_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="SensoryBase.add_covariate-107"><a href="#SensoryBase.add_covariate-107"><span class="linenos">107</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.add_covariate-108"><a href="#SensoryBase.add_covariate-108"><span class="linenos">108</span></a><span class="sd">        Adds a covariate to the dataset</span>
</span><span id="SensoryBase.add_covariate-109"><a href="#SensoryBase.add_covariate-109"><span class="linenos">109</span></a>
</span><span id="SensoryBase.add_covariate-110"><a href="#SensoryBase.add_covariate-110"><span class="linenos">110</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase.add_covariate-111"><a href="#SensoryBase.add_covariate-111"><span class="linenos">111</span></a><span class="sd">            cov_name: name of the covariate</span>
</span><span id="SensoryBase.add_covariate-112"><a href="#SensoryBase.add_covariate-112"><span class="linenos">112</span></a><span class="sd">            cov: the covariate itself</span>
</span><span id="SensoryBase.add_covariate-113"><a href="#SensoryBase.add_covariate-113"><span class="linenos">113</span></a>
</span><span id="SensoryBase.add_covariate-114"><a href="#SensoryBase.add_covariate-114"><span class="linenos">114</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase.add_covariate-115"><a href="#SensoryBase.add_covariate-115"><span class="linenos">115</span></a><span class="sd">            None</span>
</span><span id="SensoryBase.add_covariate-116"><a href="#SensoryBase.add_covariate-116"><span class="linenos">116</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.add_covariate-117"><a href="#SensoryBase.add_covariate-117"><span class="linenos">117</span></a>        <span class="k">assert</span> <span class="n">cov_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need cov_name&quot;</span>
</span><span id="SensoryBase.add_covariate-118"><a href="#SensoryBase.add_covariate-118"><span class="linenos">118</span></a>        <span class="k">assert</span> <span class="n">cov</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Missing cov&quot;</span>
</span><span id="SensoryBase.add_covariate-119"><a href="#SensoryBase.add_covariate-119"><span class="linenos">119</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SensoryBase.add_covariate-120"><a href="#SensoryBase.add_covariate-120"><span class="linenos">120</span></a>            <span class="n">cov</span> <span class="o">=</span> <span class="n">cov</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="SensoryBase.add_covariate-121"><a href="#SensoryBase.add_covariate-121"><span class="linenos">121</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="SensoryBase.add_covariate-122"><a href="#SensoryBase.add_covariate-122"><span class="linenos">122</span></a>            <span class="n">dims</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="SensoryBase.add_covariate-123"><a href="#SensoryBase.add_covariate-123"><span class="linenos">123</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="SensoryBase.add_covariate-124"><a href="#SensoryBase.add_covariate-124"><span class="linenos">124</span></a>                <span class="n">dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
</span><span id="SensoryBase.add_covariate-125"><a href="#SensoryBase.add_covariate-125"><span class="linenos">125</span></a>            <span class="n">cov</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">dims</span><span class="p">)])</span>
</span><span id="SensoryBase.add_covariate-126"><a href="#SensoryBase.add_covariate-126"><span class="linenos">126</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.add_covariate-127"><a href="#SensoryBase.add_covariate-127"><span class="linenos">127</span></a>            <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="SensoryBase.add_covariate-128"><a href="#SensoryBase.add_covariate-128"><span class="linenos">128</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SensoryBase.add_covariate-129"><a href="#SensoryBase.add_covariate-129"><span class="linenos">129</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">==</span> <span class="n">NT</span><span class="p">,</span> <span class="s2">&quot;Wrong number of time points&quot;</span>
</span><span id="SensoryBase.add_covariate-130"><a href="#SensoryBase.add_covariate-130"><span class="linenos">130</span></a>
</span><span id="SensoryBase.add_covariate-131"><a href="#SensoryBase.add_covariate-131"><span class="linenos">131</span></a>        <span class="k">if</span> <span class="n">cov_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">:</span>
</span><span id="SensoryBase.add_covariate-132"><a href="#SensoryBase.add_covariate-132"><span class="linenos">132</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Discarding old&#39;</span><span class="p">,</span> <span class="n">cov_name</span><span class="p">)</span>
</span><span id="SensoryBase.add_covariate-133"><a href="#SensoryBase.add_covariate-133"><span class="linenos">133</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">[</span><span class="n">cov_name</span><span class="p">]</span>
</span><span id="SensoryBase.add_covariate-134"><a href="#SensoryBase.add_covariate-134"><span class="linenos">134</span></a>
</span><span id="SensoryBase.add_covariate-135"><a href="#SensoryBase.add_covariate-135"><span class="linenos">135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cov_dims</span><span class="p">[</span><span class="n">cov_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dims</span>
</span><span id="SensoryBase.add_covariate-136"><a href="#SensoryBase.add_covariate-136"><span class="linenos">136</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="SensoryBase.add_covariate-137"><a href="#SensoryBase.add_covariate-137"><span class="linenos">137</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">[</span><span class="n">cov_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
</span><span id="SensoryBase.add_covariate-138"><a href="#SensoryBase.add_covariate-138"><span class="linenos">138</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.add_covariate-139"><a href="#SensoryBase.add_covariate-139"><span class="linenos">139</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">[</span><span class="n">cov_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Adds a covariate to the dataset</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>cov_name:</strong>  name of the covariate</li>
<li><strong>cov:</strong>  the covariate itself</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="SensoryBase.append_covariates" class="classattr">
                                        <input id="SensoryBase.append_covariates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">append_covariates</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">out</span>, </span><span class="param"><span class="n">idx</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.append_covariates-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.append_covariates"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.append_covariates-142"><a href="#SensoryBase.append_covariates-142"><span class="linenos">142</span></a>    <span class="k">def</span> <span class="nf">append_covariates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">idx</span> <span class="p">):</span>
</span><span id="SensoryBase.append_covariates-143"><a href="#SensoryBase.append_covariates-143"><span class="linenos">143</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.append_covariates-144"><a href="#SensoryBase.append_covariates-144"><span class="linenos">144</span></a><span class="sd">        Complements __get_item__ to add covariates to existing dictionary</span>
</span><span id="SensoryBase.append_covariates-145"><a href="#SensoryBase.append_covariates-145"><span class="linenos">145</span></a><span class="sd">        </span>
</span><span id="SensoryBase.append_covariates-146"><a href="#SensoryBase.append_covariates-146"><span class="linenos">146</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase.append_covariates-147"><a href="#SensoryBase.append_covariates-147"><span class="linenos">147</span></a><span class="sd">            out: the dictionary to append to</span>
</span><span id="SensoryBase.append_covariates-148"><a href="#SensoryBase.append_covariates-148"><span class="linenos">148</span></a><span class="sd">            idx: the index to append at</span>
</span><span id="SensoryBase.append_covariates-149"><a href="#SensoryBase.append_covariates-149"><span class="linenos">149</span></a>
</span><span id="SensoryBase.append_covariates-150"><a href="#SensoryBase.append_covariates-150"><span class="linenos">150</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase.append_covariates-151"><a href="#SensoryBase.append_covariates-151"><span class="linenos">151</span></a><span class="sd">            None</span>
</span><span id="SensoryBase.append_covariates-152"><a href="#SensoryBase.append_covariates-152"><span class="linenos">152</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.append_covariates-153"><a href="#SensoryBase.append_covariates-153"><span class="linenos">153</span></a>        <span class="k">for</span> <span class="n">cov_name</span><span class="p">,</span> <span class="n">cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="SensoryBase.append_covariates-154"><a href="#SensoryBase.append_covariates-154"><span class="linenos">154</span></a>            <span class="n">out</span><span class="p">[</span><span class="n">cov_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="SensoryBase.append_covariates-155"><a href="#SensoryBase.append_covariates-155"><span class="linenos">155</span></a>        <span class="c1"># Return out, or not?</span>
</span></pre></div>


            <div class="docstring"><p>Complements __get_item__ to add covariates to existing dictionary</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>out:</strong>  the dictionary to append to</li>
<li><strong>idx:</strong>  the index to append at</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="SensoryBase.prepare_stim" class="classattr">
                                        <input id="SensoryBase.prepare_stim-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">prepare_stim</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.prepare_stim-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.prepare_stim"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.prepare_stim-157"><a href="#SensoryBase.prepare_stim-157"><span class="linenos">157</span></a>    <span class="k">def</span> <span class="nf">prepare_stim</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="SensoryBase.prepare_stim-158"><a href="#SensoryBase.prepare_stim-158"><span class="linenos">158</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.prepare_stim-159"><a href="#SensoryBase.prepare_stim-159"><span class="linenos">159</span></a><span class="sd">        This function is meant to be overloaded by child classes</span>
</span><span id="SensoryBase.prepare_stim-160"><a href="#SensoryBase.prepare_stim-160"><span class="linenos">160</span></a>
</span><span id="SensoryBase.prepare_stim-161"><a href="#SensoryBase.prepare_stim-161"><span class="linenos">161</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase.prepare_stim-162"><a href="#SensoryBase.prepare_stim-162"><span class="linenos">162</span></a><span class="sd">            None</span>
</span><span id="SensoryBase.prepare_stim-163"><a href="#SensoryBase.prepare_stim-163"><span class="linenos">163</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.prepare_stim-164"><a href="#SensoryBase.prepare_stim-164"><span class="linenos">164</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Default prepare stimulus method.&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This function is meant to be overloaded by child classes</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="SensoryBase.set_cells" class="classattr">
                                        <input id="SensoryBase.set_cells-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_cells</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">cell_list</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.set_cells-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.set_cells"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.set_cells-166"><a href="#SensoryBase.set_cells-166"><span class="linenos">166</span></a>    <span class="k">def</span> <span class="nf">set_cells</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cell_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="SensoryBase.set_cells-167"><a href="#SensoryBase.set_cells-167"><span class="linenos">167</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.set_cells-168"><a href="#SensoryBase.set_cells-168"><span class="linenos">168</span></a><span class="sd">        Set outputs to potentially limit robs/dfs to certain cells </span>
</span><span id="SensoryBase.set_cells-169"><a href="#SensoryBase.set_cells-169"><span class="linenos">169</span></a><span class="sd">        This sets cells_out but also constructs efficient data structures</span>
</span><span id="SensoryBase.set_cells-170"><a href="#SensoryBase.set_cells-170"><span class="linenos">170</span></a><span class="sd">        </span>
</span><span id="SensoryBase.set_cells-171"><a href="#SensoryBase.set_cells-171"><span class="linenos">171</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase.set_cells-172"><a href="#SensoryBase.set_cells-172"><span class="linenos">172</span></a><span class="sd">            cell_list: list of cells to output</span>
</span><span id="SensoryBase.set_cells-173"><a href="#SensoryBase.set_cells-173"><span class="linenos">173</span></a><span class="sd">            verbose: whether to print out the number of cells</span>
</span><span id="SensoryBase.set_cells-174"><a href="#SensoryBase.set_cells-174"><span class="linenos">174</span></a>
</span><span id="SensoryBase.set_cells-175"><a href="#SensoryBase.set_cells-175"><span class="linenos">175</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase.set_cells-176"><a href="#SensoryBase.set_cells-176"><span class="linenos">176</span></a><span class="sd">            None</span>
</span><span id="SensoryBase.set_cells-177"><a href="#SensoryBase.set_cells-177"><span class="linenos">177</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.set_cells-178"><a href="#SensoryBase.set_cells-178"><span class="linenos">178</span></a>        <span class="k">if</span> <span class="n">cell_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase.set_cells-179"><a href="#SensoryBase.set_cells-179"><span class="linenos">179</span></a>            <span class="c1"># Then reset to full list</span>
</span><span id="SensoryBase.set_cells-180"><a href="#SensoryBase.set_cells-180"><span class="linenos">180</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase.set_cells-181"><a href="#SensoryBase.set_cells-181"><span class="linenos">181</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase.set_cells-182"><a href="#SensoryBase.set_cells-182"><span class="linenos">182</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase.set_cells-183"><a href="#SensoryBase.set_cells-183"><span class="linenos">183</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase.set_cells-184"><a href="#SensoryBase.set_cells-184"><span class="linenos">184</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Mval_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase.set_cells-185"><a href="#SensoryBase.set_cells-185"><span class="linenos">185</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="SensoryBase.set_cells-186"><a href="#SensoryBase.set_cells-186"><span class="linenos">186</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Reset cells_out to full dataset (</span><span class="si">%d</span><span class="s2"> cells).&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="p">)</span>
</span><span id="SensoryBase.set_cells-187"><a href="#SensoryBase.set_cells-187"><span class="linenos">187</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.set_cells-188"><a href="#SensoryBase.set_cells-188"><span class="linenos">188</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="SensoryBase.set_cells-189"><a href="#SensoryBase.set_cells-189"><span class="linenos">189</span></a>                <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_int</span><span class="p">(</span><span class="n">cell_list</span><span class="p">):</span>
</span><span id="SensoryBase.set_cells-190"><a href="#SensoryBase.set_cells-190"><span class="linenos">190</span></a>                    <span class="n">cell_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell_list</span><span class="p">]</span>
</span><span id="SensoryBase.set_cells-191"><a href="#SensoryBase.set_cells-191"><span class="linenos">191</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.set_cells-192"><a href="#SensoryBase.set_cells-192"><span class="linenos">192</span></a>                    <span class="n">cell_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cell_list</span><span class="p">)</span>
</span><span id="SensoryBase.set_cells-193"><a href="#SensoryBase.set_cells-193"><span class="linenos">193</span></a>            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cell_list</span><span class="p">))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="s2">&quot;ERROR: cell_list too high.&quot;</span>
</span><span id="SensoryBase.set_cells-194"><a href="#SensoryBase.set_cells-194"><span class="linenos">194</span></a>            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="SensoryBase.set_cells-195"><a href="#SensoryBase.set_cells-195"><span class="linenos">195</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Output set to </span><span class="si">%d</span><span class="s2"> cells&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">cell_list</span><span class="p">))</span>
</span><span id="SensoryBase.set_cells-196"><a href="#SensoryBase.set_cells-196"><span class="linenos">196</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="o">=</span> <span class="n">cell_list</span>
</span><span id="SensoryBase.set_cells-197"><a href="#SensoryBase.set_cells-197"><span class="linenos">197</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="n">cell_list</span><span class="p">])</span>
</span><span id="SensoryBase.set_cells-198"><a href="#SensoryBase.set_cells-198"><span class="linenos">198</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cell_list</span><span class="p">])</span>
</span><span id="SensoryBase.set_cells-199"><a href="#SensoryBase.set_cells-199"><span class="linenos">199</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase.set_cells-200"><a href="#SensoryBase.set_cells-200"><span class="linenos">200</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span><span class="p">[:,</span> <span class="n">cell_list</span><span class="p">])</span>
</span><span id="SensoryBase.set_cells-201"><a href="#SensoryBase.set_cells-201"><span class="linenos">201</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mval_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Mval</span><span class="p">[:,</span> <span class="n">cell_list</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Set outputs to potentially limit robs/dfs to certain cells 
This sets cells_out but also constructs efficient data structures</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>cell_list:</strong>  list of cells to output</li>
<li><strong>verbose:</strong>  whether to print out the number of cells</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="SensoryBase.time_embedding" class="classattr">
                                        <input id="SensoryBase.time_embedding-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">time_embedding</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">stim</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">nlags</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.time_embedding-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.time_embedding"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.time_embedding-204"><a href="#SensoryBase.time_embedding-204"><span class="linenos">204</span></a>    <span class="k">def</span> <span class="nf">time_embedding</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="SensoryBase.time_embedding-205"><a href="#SensoryBase.time_embedding-205"><span class="linenos">205</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.time_embedding-206"><a href="#SensoryBase.time_embedding-206"><span class="linenos">206</span></a><span class="sd">        Assume all stim dimensions are flattened into single dimension. </span>
</span><span id="SensoryBase.time_embedding-207"><a href="#SensoryBase.time_embedding-207"><span class="linenos">207</span></a><span class="sd">        Will only act on self.stim if &#39;stim&#39; argument is left None</span>
</span><span id="SensoryBase.time_embedding-208"><a href="#SensoryBase.time_embedding-208"><span class="linenos">208</span></a><span class="sd">        </span>
</span><span id="SensoryBase.time_embedding-209"><a href="#SensoryBase.time_embedding-209"><span class="linenos">209</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase.time_embedding-210"><a href="#SensoryBase.time_embedding-210"><span class="linenos">210</span></a><span class="sd">            stim: the stimulus to time-embed</span>
</span><span id="SensoryBase.time_embedding-211"><a href="#SensoryBase.time_embedding-211"><span class="linenos">211</span></a><span class="sd">            nlags: the number of lags to use</span>
</span><span id="SensoryBase.time_embedding-212"><a href="#SensoryBase.time_embedding-212"><span class="linenos">212</span></a><span class="sd">            verbose: whether to print out the time embedding process</span>
</span><span id="SensoryBase.time_embedding-213"><a href="#SensoryBase.time_embedding-213"><span class="linenos">213</span></a>
</span><span id="SensoryBase.time_embedding-214"><a href="#SensoryBase.time_embedding-214"><span class="linenos">214</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase.time_embedding-215"><a href="#SensoryBase.time_embedding-215"><span class="linenos">215</span></a><span class="sd">            tmp_stim: the time-embedded stimulus</span>
</span><span id="SensoryBase.time_embedding-216"><a href="#SensoryBase.time_embedding-216"><span class="linenos">216</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.time_embedding-217"><a href="#SensoryBase.time_embedding-217"><span class="linenos">217</span></a>
</span><span id="SensoryBase.time_embedding-218"><a href="#SensoryBase.time_embedding-218"><span class="linenos">218</span></a>        <span class="k">if</span> <span class="n">nlags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase.time_embedding-219"><a href="#SensoryBase.time_embedding-219"><span class="linenos">219</span></a>            <span class="n">nlags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="SensoryBase.time_embedding-220"><a href="#SensoryBase.time_embedding-220"><span class="linenos">220</span></a>        <span class="k">if</span> <span class="n">stim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase.time_embedding-221"><a href="#SensoryBase.time_embedding-221"><span class="linenos">221</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to assemble stim before time-embedding.&quot;</span>
</span><span id="SensoryBase.time_embedding-222"><a href="#SensoryBase.time_embedding-222"><span class="linenos">222</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span>
</span><span id="SensoryBase.time_embedding-223"><a href="#SensoryBase.time_embedding-223"><span class="linenos">223</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># should only time-embed stim by default, but not all the time</span>
</span><span id="SensoryBase.time_embedding-224"><a href="#SensoryBase.time_embedding-224"><span class="linenos">224</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlags</span>
</span><span id="SensoryBase.time_embedding-225"><a href="#SensoryBase.time_embedding-225"><span class="linenos">225</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.time_embedding-226"><a href="#SensoryBase.time_embedding-226"><span class="linenos">226</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="SensoryBase.time_embedding-227"><a href="#SensoryBase.time_embedding-227"><span class="linenos">227</span></a>                <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">stim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="SensoryBase.time_embedding-228"><a href="#SensoryBase.time_embedding-228"><span class="linenos">228</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.time_embedding-229"><a href="#SensoryBase.time_embedding-229"><span class="linenos">229</span></a>                <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="SensoryBase.time_embedding-230"><a href="#SensoryBase.time_embedding-230"><span class="linenos">230</span></a> 
</span><span id="SensoryBase.time_embedding-231"><a href="#SensoryBase.time_embedding-231"><span class="linenos">231</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="SensoryBase.time_embedding-232"><a href="#SensoryBase.time_embedding-232"><span class="linenos">232</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Time embedding...&quot;</span> <span class="p">)</span>
</span><span id="SensoryBase.time_embedding-233"><a href="#SensoryBase.time_embedding-233"><span class="linenos">233</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SensoryBase.time_embedding-234"><a href="#SensoryBase.time_embedding-234"><span class="linenos">234</span></a>        <span class="n">original_dims</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase.time_embedding-235"><a href="#SensoryBase.time_embedding-235"><span class="linenos">235</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="SensoryBase.time_embedding-236"><a href="#SensoryBase.time_embedding-236"><span class="linenos">236</span></a>            <span class="n">original_dims</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="o">.</span><span class="n">shape</span>
</span><span id="SensoryBase.time_embedding-237"><a href="#SensoryBase.time_embedding-237"><span class="linenos">237</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="SensoryBase.time_embedding-238"><a href="#SensoryBase.time_embedding-238"><span class="linenos">238</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Time embed: flattening stimulus from&quot;</span><span class="p">,</span> <span class="n">original_dims</span><span class="p">)</span>
</span><span id="SensoryBase.time_embedding-239"><a href="#SensoryBase.time_embedding-239"><span class="linenos">239</span></a>        <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># automatically generates 2-dimensional stim</span>
</span><span id="SensoryBase.time_embedding-240"><a href="#SensoryBase.time_embedding-240"><span class="linenos">240</span></a>
</span><span id="SensoryBase.time_embedding-241"><a href="#SensoryBase.time_embedding-241"><span class="linenos">241</span></a>        <span class="c1">#assert self.NT == NT, &quot;TIME EMBEDDING: stim length mismatch&quot;</span>
</span><span id="SensoryBase.time_embedding-242"><a href="#SensoryBase.time_embedding-242"><span class="linenos">242</span></a>
</span><span id="SensoryBase.time_embedding-243"><a href="#SensoryBase.time_embedding-243"><span class="linenos">243</span></a>        <span class="c1"># Actual time-embedding itself</span>
</span><span id="SensoryBase.time_embedding-244"><a href="#SensoryBase.time_embedding-244"><span class="linenos">244</span></a>        <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nlags</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="SensoryBase.time_embedding-245"><a href="#SensoryBase.time_embedding-245"><span class="linenos">245</span></a>        <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="o">.</span><span class="n">permute</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="SensoryBase.time_embedding-246"><a href="#SensoryBase.time_embedding-246"><span class="linenos">246</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="SensoryBase.time_embedding-247"><a href="#SensoryBase.time_embedding-247"><span class="linenos">247</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Done.&quot;</span><span class="p">)</span>
</span><span id="SensoryBase.time_embedding-248"><a href="#SensoryBase.time_embedding-248"><span class="linenos">248</span></a>        <span class="k">return</span> <span class="n">tmp_stim</span>
</span></pre></div>


            <div class="docstring"><p>Assume all stim dimensions are flattened into single dimension. 
Will only act on self.stim if 'stim' argument is left None</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>stim:</strong>  the stimulus to time-embed</li>
<li><strong>nlags:</strong>  the number of lags to use</li>
<li><strong>verbose:</strong>  whether to print out the time embedding process</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>tmp_stim: the time-embedded stimulus</p>
</blockquote>
</div>


                            </div>
                            <div id="SensoryBase.construct_drift_design_matrix" class="classattr">
                                        <input id="SensoryBase.construct_drift_design_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">construct_drift_design_matrix</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">block_anchors</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.construct_drift_design_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.construct_drift_design_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.construct_drift_design_matrix-251"><a href="#SensoryBase.construct_drift_design_matrix-251"><span class="linenos">251</span></a>    <span class="k">def</span> <span class="nf">construct_drift_design_matrix</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">block_anchors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="SensoryBase.construct_drift_design_matrix-252"><a href="#SensoryBase.construct_drift_design_matrix-252"><span class="linenos">252</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.construct_drift_design_matrix-253"><a href="#SensoryBase.construct_drift_design_matrix-253"><span class="linenos">253</span></a><span class="sd">        Note this requires self.block_inds, and either uses self.drift_interval or block_anchors</span>
</span><span id="SensoryBase.construct_drift_design_matrix-254"><a href="#SensoryBase.construct_drift_design_matrix-254"><span class="linenos">254</span></a><span class="sd">        </span>
</span><span id="SensoryBase.construct_drift_design_matrix-255"><a href="#SensoryBase.construct_drift_design_matrix-255"><span class="linenos">255</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase.construct_drift_design_matrix-256"><a href="#SensoryBase.construct_drift_design_matrix-256"><span class="linenos">256</span></a><span class="sd">            block_anchors: the block anchors to use</span>
</span><span id="SensoryBase.construct_drift_design_matrix-257"><a href="#SensoryBase.construct_drift_design_matrix-257"><span class="linenos">257</span></a><span class="sd">            </span>
</span><span id="SensoryBase.construct_drift_design_matrix-258"><a href="#SensoryBase.construct_drift_design_matrix-258"><span class="linenos">258</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase.construct_drift_design_matrix-259"><a href="#SensoryBase.construct_drift_design_matrix-259"><span class="linenos">259</span></a><span class="sd">            None</span>
</span><span id="SensoryBase.construct_drift_design_matrix-260"><a href="#SensoryBase.construct_drift_design_matrix-260"><span class="linenos">260</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.construct_drift_design_matrix-261"><a href="#SensoryBase.construct_drift_design_matrix-261"><span class="linenos">261</span></a>
</span><span id="SensoryBase.construct_drift_design_matrix-262"><a href="#SensoryBase.construct_drift_design_matrix-262"><span class="linenos">262</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need block_inds defined as an internal variable&quot;</span>
</span><span id="SensoryBase.construct_drift_design_matrix-263"><a href="#SensoryBase.construct_drift_design_matrix-263"><span class="linenos">263</span></a>
</span><span id="SensoryBase.construct_drift_design_matrix-264"><a href="#SensoryBase.construct_drift_design_matrix-264"><span class="linenos">264</span></a>        <span class="k">if</span> <span class="n">block_anchors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase.construct_drift_design_matrix-265"><a href="#SensoryBase.construct_drift_design_matrix-265"><span class="linenos">265</span></a>            <span class="n">NBL</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="SensoryBase.construct_drift_design_matrix-266"><a href="#SensoryBase.construct_drift_design_matrix-266"><span class="linenos">266</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase.construct_drift_design_matrix-267"><a href="#SensoryBase.construct_drift_design_matrix-267"><span class="linenos">267</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase.construct_drift_design_matrix-268"><a href="#SensoryBase.construct_drift_design_matrix-268"><span class="linenos">268</span></a>                <span class="k">return</span>
</span><span id="SensoryBase.construct_drift_design_matrix-269"><a href="#SensoryBase.construct_drift_design_matrix-269"><span class="linenos">269</span></a>            <span class="n">block_anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NBL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span><span class="p">)</span>
</span><span id="SensoryBase.construct_drift_design_matrix-270"><a href="#SensoryBase.construct_drift_design_matrix-270"><span class="linenos">270</span></a>
</span><span id="SensoryBase.construct_drift_design_matrix-271"><a href="#SensoryBase.construct_drift_design_matrix-271"><span class="linenos">271</span></a>        <span class="n">Nanchors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">block_anchors</span><span class="p">)</span>
</span><span id="SensoryBase.construct_drift_design_matrix-272"><a href="#SensoryBase.construct_drift_design_matrix-272"><span class="linenos">272</span></a>        <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="SensoryBase.construct_drift_design_matrix-273"><a href="#SensoryBase.construct_drift_design_matrix-273"><span class="linenos">273</span></a>        <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">):</span>
</span><span id="SensoryBase.construct_drift_design_matrix-274"><a href="#SensoryBase.construct_drift_design_matrix-274"><span class="linenos">274</span></a>            <span class="n">anchors</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">block_anchors</span><span class="p">[</span><span class="n">bb</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SensoryBase.construct_drift_design_matrix-275"><a href="#SensoryBase.construct_drift_design_matrix-275"><span class="linenos">275</span></a>        
</span><span id="SensoryBase.construct_drift_design_matrix-276"><a href="#SensoryBase.construct_drift_design_matrix-276"><span class="linenos">276</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">anchors</span> <span class="o">=</span> <span class="n">anchors</span>
</span><span id="SensoryBase.construct_drift_design_matrix-277"><a href="#SensoryBase.construct_drift_design_matrix-277"><span class="linenos">277</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> 
</span><span id="SensoryBase.construct_drift_design_matrix-278"><a href="#SensoryBase.construct_drift_design_matrix-278"><span class="linenos">278</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="SensoryBase.construct_drift_design_matrix-279"><a href="#SensoryBase.construct_drift_design_matrix-279"><span class="linenos">279</span></a>            <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Note this requires self.block_inds, and either uses self.drift_interval or block_anchors</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>block_anchors:</strong>  the block anchors to use</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="SensoryBase.trial_psths" class="classattr">
                                        <input id="SensoryBase.trial_psths-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">trial_psths</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">trials</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">R</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">trial_size</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.trial_psths-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.trial_psths"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.trial_psths-282"><a href="#SensoryBase.trial_psths-282"><span class="linenos">282</span></a>    <span class="k">def</span> <span class="nf">trial_psths</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">trials</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trial_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="SensoryBase.trial_psths-283"><a href="#SensoryBase.trial_psths-283"><span class="linenos">283</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.trial_psths-284"><a href="#SensoryBase.trial_psths-284"><span class="linenos">284</span></a><span class="sd">        Computes average firing rate of cells_out at bin-resolution, averaged across trials</span>
</span><span id="SensoryBase.trial_psths-285"><a href="#SensoryBase.trial_psths-285"><span class="linenos">285</span></a><span class="sd">        given in block_inds</span>
</span><span id="SensoryBase.trial_psths-286"><a href="#SensoryBase.trial_psths-286"><span class="linenos">286</span></a><span class="sd">        </span>
</span><span id="SensoryBase.trial_psths-287"><a href="#SensoryBase.trial_psths-287"><span class="linenos">287</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase.trial_psths-288"><a href="#SensoryBase.trial_psths-288"><span class="linenos">288</span></a><span class="sd">            trials: the trials to compute the PSTHs for</span>
</span><span id="SensoryBase.trial_psths-289"><a href="#SensoryBase.trial_psths-289"><span class="linenos">289</span></a><span class="sd">            R: the firing rates to use</span>
</span><span id="SensoryBase.trial_psths-290"><a href="#SensoryBase.trial_psths-290"><span class="linenos">290</span></a><span class="sd">            trial_size: the size of the trials</span>
</span><span id="SensoryBase.trial_psths-291"><a href="#SensoryBase.trial_psths-291"><span class="linenos">291</span></a><span class="sd">            verbose: whether to print out the trial sizes</span>
</span><span id="SensoryBase.trial_psths-292"><a href="#SensoryBase.trial_psths-292"><span class="linenos">292</span></a>
</span><span id="SensoryBase.trial_psths-293"><a href="#SensoryBase.trial_psths-293"><span class="linenos">293</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase.trial_psths-294"><a href="#SensoryBase.trial_psths-294"><span class="linenos">294</span></a><span class="sd">            psths: the PSTHs</span>
</span><span id="SensoryBase.trial_psths-295"><a href="#SensoryBase.trial_psths-295"><span class="linenos">295</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.trial_psths-296"><a href="#SensoryBase.trial_psths-296"><span class="linenos">296</span></a>
</span><span id="SensoryBase.trial_psths-297"><a href="#SensoryBase.trial_psths-297"><span class="linenos">297</span></a>        <span class="n">Ntr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="SensoryBase.trial_psths-298"><a href="#SensoryBase.trial_psths-298"><span class="linenos">298</span></a>        <span class="k">assert</span> <span class="n">Ntr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Cannot compute PSTHs without block_inds established in dataset.&quot;</span>
</span><span id="SensoryBase.trial_psths-299"><a href="#SensoryBase.trial_psths-299"><span class="linenos">299</span></a>
</span><span id="SensoryBase.trial_psths-300"><a href="#SensoryBase.trial_psths-300"><span class="linenos">300</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SensoryBase.trial_psths-301"><a href="#SensoryBase.trial_psths-301"><span class="linenos">301</span></a>            <span class="n">ccs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span>
</span><span id="SensoryBase.trial_psths-302"><a href="#SensoryBase.trial_psths-302"><span class="linenos">302</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.trial_psths-303"><a href="#SensoryBase.trial_psths-303"><span class="linenos">303</span></a>            <span class="n">ccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">)</span>
</span><span id="SensoryBase.trial_psths-304"><a href="#SensoryBase.trial_psths-304"><span class="linenos">304</span></a>        <span class="k">if</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ccs</span><span class="p">):</span>
</span><span id="SensoryBase.trial_psths-305"><a href="#SensoryBase.trial_psths-305"><span class="linenos">305</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">ccs</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="SensoryBase.trial_psths-306"><a href="#SensoryBase.trial_psths-306"><span class="linenos">306</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.trial_psths-307"><a href="#SensoryBase.trial_psths-307"><span class="linenos">307</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="SensoryBase.trial_psths-308"><a href="#SensoryBase.trial_psths-308"><span class="linenos">308</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Ignoring dfs.&#39;</span><span class="p">)</span>
</span><span id="SensoryBase.trial_psths-309"><a href="#SensoryBase.trial_psths-309"><span class="linenos">309</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
</span><span id="SensoryBase.trial_psths-310"><a href="#SensoryBase.trial_psths-310"><span class="linenos">310</span></a>
</span><span id="SensoryBase.trial_psths-311"><a href="#SensoryBase.trial_psths-311"><span class="linenos">311</span></a>        <span class="k">if</span> <span class="n">R</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1">#then use [internal] Robs</span>
</span><span id="SensoryBase.trial_psths-312"><a href="#SensoryBase.trial_psths-312"><span class="linenos">312</span></a>            <span class="n">R</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="n">ccs</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="p">)</span>  
</span><span id="SensoryBase.trial_psths-313"><a href="#SensoryBase.trial_psths-313"><span class="linenos">313</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SensoryBase.trial_psths-314"><a href="#SensoryBase.trial_psths-314"><span class="linenos">314</span></a>            <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>         
</span><span id="SensoryBase.trial_psths-315"><a href="#SensoryBase.trial_psths-315"><span class="linenos">315</span></a>        <span class="n">num_psths</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># otherwise use existing input</span>
</span><span id="SensoryBase.trial_psths-316"><a href="#SensoryBase.trial_psths-316"><span class="linenos">316</span></a>
</span><span id="SensoryBase.trial_psths-317"><a href="#SensoryBase.trial_psths-317"><span class="linenos">317</span></a>        <span class="c1"># Compute median trial size</span>
</span><span id="SensoryBase.trial_psths-318"><a href="#SensoryBase.trial_psths-318"><span class="linenos">318</span></a>        <span class="k">if</span> <span class="n">trial_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase.trial_psths-319"><a href="#SensoryBase.trial_psths-319"><span class="linenos">319</span></a>            <span class="c1"># select median trial size, but look at all</span>
</span><span id="SensoryBase.trial_psths-320"><a href="#SensoryBase.trial_psths-320"><span class="linenos">320</span></a>            <span class="n">tr_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">))</span>
</span><span id="SensoryBase.trial_psths-321"><a href="#SensoryBase.trial_psths-321"><span class="linenos">321</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntr</span><span class="p">):</span>
</span><span id="SensoryBase.trial_psths-322"><a href="#SensoryBase.trial_psths-322"><span class="linenos">322</span></a>                <span class="n">tr_sizes</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">])</span>
</span><span id="SensoryBase.trial_psths-323"><a href="#SensoryBase.trial_psths-323"><span class="linenos">323</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">tr_sizes</span><span class="p">))</span>
</span><span id="SensoryBase.trial_psths-324"><a href="#SensoryBase.trial_psths-324"><span class="linenos">324</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="SensoryBase.trial_psths-325"><a href="#SensoryBase.trial_psths-325"><span class="linenos">325</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Trial lengths: Min </span><span class="si">%d</span><span class="s2">, Max </span><span class="si">%d</span><span class="s2">, Median </span><span class="si">%d</span><span class="s2">. Selecting median.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tr_sizes</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tr_sizes</span><span class="p">),</span> <span class="n">T</span><span class="p">))</span>
</span><span id="SensoryBase.trial_psths-326"><a href="#SensoryBase.trial_psths-326"><span class="linenos">326</span></a>
</span><span id="SensoryBase.trial_psths-327"><a href="#SensoryBase.trial_psths-327"><span class="linenos">327</span></a>        <span class="k">if</span> <span class="n">trials</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase.trial_psths-328"><a href="#SensoryBase.trial_psths-328"><span class="linenos">328</span></a>            <span class="n">trials</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Ntr</span><span class="p">)</span>
</span><span id="SensoryBase.trial_psths-329"><a href="#SensoryBase.trial_psths-329"><span class="linenos">329</span></a>
</span><span id="SensoryBase.trial_psths-330"><a href="#SensoryBase.trial_psths-330"><span class="linenos">330</span></a>        <span class="n">psths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">T</span><span class="p">,</span> <span class="n">num_psths</span><span class="p">])</span>
</span><span id="SensoryBase.trial_psths-331"><a href="#SensoryBase.trial_psths-331"><span class="linenos">331</span></a>        <span class="n">df_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">T</span><span class="p">,</span> <span class="n">num_psths</span><span class="p">])</span>
</span><span id="SensoryBase.trial_psths-332"><a href="#SensoryBase.trial_psths-332"><span class="linenos">332</span></a>
</span><span id="SensoryBase.trial_psths-333"><a href="#SensoryBase.trial_psths-333"><span class="linenos">333</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SensoryBase.trial_psths-334"><a href="#SensoryBase.trial_psths-334"><span class="linenos">334</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">trials</span><span class="p">:</span>
</span><span id="SensoryBase.trial_psths-335"><a href="#SensoryBase.trial_psths-335"><span class="linenos">335</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">T</span><span class="p">:</span>
</span><span id="SensoryBase.trial_psths-336"><a href="#SensoryBase.trial_psths-336"><span class="linenos">336</span></a>                    <span class="n">trT</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
</span><span id="SensoryBase.trial_psths-337"><a href="#SensoryBase.trial_psths-337"><span class="linenos">337</span></a>                <span class="k">else</span><span class="p">:</span> 
</span><span id="SensoryBase.trial_psths-338"><a href="#SensoryBase.trial_psths-338"><span class="linenos">338</span></a>                    <span class="n">trT</span> <span class="o">=</span> <span class="n">T</span>
</span><span id="SensoryBase.trial_psths-339"><a href="#SensoryBase.trial_psths-339"><span class="linenos">339</span></a>                <span class="n">psths</span><span class="p">[:</span><span class="n">trT</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">R</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][:</span><span class="n">trT</span><span class="p">],</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][:</span><span class="n">trT</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="SensoryBase.trial_psths-340"><a href="#SensoryBase.trial_psths-340"><span class="linenos">340</span></a>                <span class="n">df_count</span><span class="p">[:</span><span class="n">trT</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][:</span><span class="n">trT</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="SensoryBase.trial_psths-341"><a href="#SensoryBase.trial_psths-341"><span class="linenos">341</span></a>            
</span><span id="SensoryBase.trial_psths-342"><a href="#SensoryBase.trial_psths-342"><span class="linenos">342</span></a>            <span class="n">psths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span> <span class="n">psths</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">df_count</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="p">)</span>
</span><span id="SensoryBase.trial_psths-343"><a href="#SensoryBase.trial_psths-343"><span class="linenos">343</span></a>
</span><span id="SensoryBase.trial_psths-344"><a href="#SensoryBase.trial_psths-344"><span class="linenos">344</span></a>        <span class="k">return</span> <span class="n">psths</span>
</span></pre></div>


            <div class="docstring"><p>Computes average firing rate of cells_out at bin-resolution, averaged across trials
given in block_inds</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>trials:</strong>  the trials to compute the PSTHs for</li>
<li><strong>R:</strong>  the firing rates to use</li>
<li><strong>trial_size:</strong>  the size of the trials</li>
<li><strong>verbose:</strong>  whether to print out the trial sizes</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>psths: the PSTHs</p>
</blockquote>
</div>


                            </div>
                            <div id="SensoryBase.construct_LVtents" class="classattr">
                                        <input id="SensoryBase.construct_LVtents-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">construct_LVtents</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">tent_spacing</span><span class="o">=</span><span class="mi">12</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.construct_LVtents-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.construct_LVtents"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.construct_LVtents-347"><a href="#SensoryBase.construct_LVtents-347"><span class="linenos">347</span></a>    <span class="k">def</span> <span class="nf">construct_LVtents</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">tent_spacing</span><span class="o">=</span><span class="mi">12</span> <span class="p">):</span>
</span><span id="SensoryBase.construct_LVtents-348"><a href="#SensoryBase.construct_LVtents-348"><span class="linenos">348</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.construct_LVtents-349"><a href="#SensoryBase.construct_LVtents-349"><span class="linenos">349</span></a><span class="sd">        Constructs tent-basis-style trial-based tent function</span>
</span><span id="SensoryBase.construct_LVtents-350"><a href="#SensoryBase.construct_LVtents-350"><span class="linenos">350</span></a><span class="sd">        </span>
</span><span id="SensoryBase.construct_LVtents-351"><a href="#SensoryBase.construct_LVtents-351"><span class="linenos">351</span></a><span class="sd">        Args: </span>
</span><span id="SensoryBase.construct_LVtents-352"><a href="#SensoryBase.construct_LVtents-352"><span class="linenos">352</span></a><span class="sd">            tent_spacing: the spacing of the tent functions</span>
</span><span id="SensoryBase.construct_LVtents-353"><a href="#SensoryBase.construct_LVtents-353"><span class="linenos">353</span></a>
</span><span id="SensoryBase.construct_LVtents-354"><a href="#SensoryBase.construct_LVtents-354"><span class="linenos">354</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase.construct_LVtents-355"><a href="#SensoryBase.construct_LVtents-355"><span class="linenos">355</span></a><span class="sd">            XLV: the design matrix</span>
</span><span id="SensoryBase.construct_LVtents-356"><a href="#SensoryBase.construct_LVtents-356"><span class="linenos">356</span></a><span class="sd">            LVdims: the dimensions of the design matrix</span>
</span><span id="SensoryBase.construct_LVtents-357"><a href="#SensoryBase.construct_LVtents-357"><span class="linenos">357</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.construct_LVtents-358"><a href="#SensoryBase.construct_LVtents-358"><span class="linenos">358</span></a>        
</span><span id="SensoryBase.construct_LVtents-359"><a href="#SensoryBase.construct_LVtents-359"><span class="linenos">359</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase.construct_LVtents-360"><a href="#SensoryBase.construct_LVtents-360"><span class="linenos">360</span></a>            <span class="c1"># Compute minimum and maximum trial size</span>
</span><span id="SensoryBase.construct_LVtents-361"><a href="#SensoryBase.construct_LVtents-361"><span class="linenos">361</span></a>            <span class="n">Ntr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="SensoryBase.construct_LVtents-362"><a href="#SensoryBase.construct_LVtents-362"><span class="linenos">362</span></a>            <span class="n">min_trial_size</span><span class="p">,</span> <span class="n">max_trial_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">0</span>
</span><span id="SensoryBase.construct_LVtents-363"><a href="#SensoryBase.construct_LVtents-363"><span class="linenos">363</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntr</span><span class="p">):</span>
</span><span id="SensoryBase.construct_LVtents-364"><a href="#SensoryBase.construct_LVtents-364"><span class="linenos">364</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">min_trial_size</span><span class="p">:</span>
</span><span id="SensoryBase.construct_LVtents-365"><a href="#SensoryBase.construct_LVtents-365"><span class="linenos">365</span></a>                    <span class="n">min_trial_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
</span><span id="SensoryBase.construct_LVtents-366"><a href="#SensoryBase.construct_LVtents-366"><span class="linenos">366</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">max_trial_size</span><span class="p">:</span>
</span><span id="SensoryBase.construct_LVtents-367"><a href="#SensoryBase.construct_LVtents-367"><span class="linenos">367</span></a>                    <span class="n">max_trial_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
</span><span id="SensoryBase.construct_LVtents-368"><a href="#SensoryBase.construct_LVtents-368"><span class="linenos">368</span></a>                    
</span><span id="SensoryBase.construct_LVtents-369"><a href="#SensoryBase.construct_LVtents-369"><span class="linenos">369</span></a>            <span class="k">if</span> <span class="n">tent_spacing</span> <span class="o">&gt;</span> <span class="n">min_trial_size</span><span class="p">:</span>
</span><span id="SensoryBase.construct_LVtents-370"><a href="#SensoryBase.construct_LVtents-370"><span class="linenos">370</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using one LV per trial&#39;</span><span class="p">)</span>
</span><span id="SensoryBase.construct_LVtents-371"><a href="#SensoryBase.construct_LVtents-371"><span class="linenos">371</span></a>                <span class="n">XLV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">Ntr</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="SensoryBase.construct_LVtents-372"><a href="#SensoryBase.construct_LVtents-372"><span class="linenos">372</span></a>                <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntr</span><span class="p">):</span>
</span><span id="SensoryBase.construct_LVtents-373"><a href="#SensoryBase.construct_LVtents-373"><span class="linenos">373</span></a>                    <span class="n">XLV</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">tr</span><span class="p">],</span> <span class="n">tr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="SensoryBase.construct_LVtents-374"><a href="#SensoryBase.construct_LVtents-374"><span class="linenos">374</span></a>                <span class="n">LVdims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">Ntr</span><span class="p">]</span>
</span><span id="SensoryBase.construct_LVtents-375"><a href="#SensoryBase.construct_LVtents-375"><span class="linenos">375</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.construct_LVtents-376"><a href="#SensoryBase.construct_LVtents-376"><span class="linenos">376</span></a>                <span class="c1"># automatically wont have any anchors past min_trial_size</span>
</span><span id="SensoryBase.construct_LVtents-377"><a href="#SensoryBase.construct_LVtents-377"><span class="linenos">377</span></a>                <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_trial_size</span><span class="p">,</span> <span class="n">tent_spacing</span><span class="p">)</span> 
</span><span id="SensoryBase.construct_LVtents-378"><a href="#SensoryBase.construct_LVtents-378"><span class="linenos">378</span></a>                <span class="c1"># Generate master tent_basis</span>
</span><span id="SensoryBase.construct_LVtents-379"><a href="#SensoryBase.construct_LVtents-379"><span class="linenos">379</span></a>                <span class="n">trial_tents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span>
</span><span id="SensoryBase.construct_LVtents-380"><a href="#SensoryBase.construct_LVtents-380"><span class="linenos">380</span></a>                    <span class="n">max_trial_size</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zero_right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="SensoryBase.construct_LVtents-381"><a href="#SensoryBase.construct_LVtents-381"><span class="linenos">381</span></a>                <span class="n">num_tents_tr</span> <span class="o">=</span> <span class="n">trial_tents</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SensoryBase.construct_LVtents-382"><a href="#SensoryBase.construct_LVtents-382"><span class="linenos">382</span></a>                <span class="n">num_tents</span> <span class="o">=</span> <span class="n">num_tents_tr</span> <span class="o">*</span> <span class="n">Ntr</span>
</span><span id="SensoryBase.construct_LVtents-383"><a href="#SensoryBase.construct_LVtents-383"><span class="linenos">383</span></a>                <span class="n">LVdims</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ntr</span><span class="p">,</span> <span class="n">num_tents_tr</span><span class="p">]</span> 
</span><span id="SensoryBase.construct_LVtents-384"><a href="#SensoryBase.construct_LVtents-384"><span class="linenos">384</span></a>                <span class="n">XLV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">num_tents</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="SensoryBase.construct_LVtents-385"><a href="#SensoryBase.construct_LVtents-385"><span class="linenos">385</span></a>                <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntr</span><span class="p">):</span>
</span><span id="SensoryBase.construct_LVtents-386"><a href="#SensoryBase.construct_LVtents-386"><span class="linenos">386</span></a>                    <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">tr</span><span class="p">])</span>
</span><span id="SensoryBase.construct_LVtents-387"><a href="#SensoryBase.construct_LVtents-387"><span class="linenos">387</span></a>                    <span class="n">vslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">L</span><span class="p">,</span> <span class="n">num_tents</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="SensoryBase.construct_LVtents-388"><a href="#SensoryBase.construct_LVtents-388"><span class="linenos">388</span></a>                    <span class="n">vslice</span><span class="p">[:,</span> <span class="n">tr</span><span class="o">*</span><span class="n">num_tents_tr</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_tents_tr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">trial_tents</span><span class="p">[:</span><span class="n">L</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="SensoryBase.construct_LVtents-389"><a href="#SensoryBase.construct_LVtents-389"><span class="linenos">389</span></a>                    <span class="n">XLV</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">tr</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">vslice</span><span class="p">)</span>
</span><span id="SensoryBase.construct_LVtents-390"><a href="#SensoryBase.construct_LVtents-390"><span class="linenos">390</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.construct_LVtents-391"><a href="#SensoryBase.construct_LVtents-391"><span class="linenos">391</span></a>            <span class="c1">#print(&#39;Trial-less LV setup not implemented yet, but should be easy.&#39;</span>
</span><span id="SensoryBase.construct_LVtents-392"><a href="#SensoryBase.construct_LVtents-392"><span class="linenos">392</span></a>            <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">tent_spacing</span><span class="p">)</span> 
</span><span id="SensoryBase.construct_LVtents-393"><a href="#SensoryBase.construct_LVtents-393"><span class="linenos">393</span></a>            <span class="n">XLV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span>
</span><span id="SensoryBase.construct_LVtents-394"><a href="#SensoryBase.construct_LVtents-394"><span class="linenos">394</span></a>                <span class="n">max_trial_size</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zero_right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="SensoryBase.construct_LVtents-395"><a href="#SensoryBase.construct_LVtents-395"><span class="linenos">395</span></a>            <span class="n">num_tents</span> <span class="o">=</span> <span class="n">XLV</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SensoryBase.construct_LVtents-396"><a href="#SensoryBase.construct_LVtents-396"><span class="linenos">396</span></a>            <span class="n">LVdims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_tents</span><span class="p">]</span>
</span><span id="SensoryBase.construct_LVtents-397"><a href="#SensoryBase.construct_LVtents-397"><span class="linenos">397</span></a>        <span class="k">return</span> <span class="n">XLV</span><span class="p">,</span> <span class="n">LVdims</span>  <span class="c1"># numpy array</span>
</span></pre></div>


            <div class="docstring"><p>Constructs tent-basis-style trial-based tent function</p>

<p>Args: 
    tent_spacing: the spacing of the tent functions</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>XLV: the design matrix
  LVdims: the dimensions of the design matrix</p>
</blockquote>
</div>


                            </div>
                            <div id="SensoryBase.setup_trial_LVs" class="classattr">
                                        <input id="SensoryBase.setup_trial_LVs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setup_trial_LVs</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.setup_trial_LVs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.setup_trial_LVs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.setup_trial_LVs-400"><a href="#SensoryBase.setup_trial_LVs-400"><span class="linenos">400</span></a>    <span class="k">def</span> <span class="nf">setup_trial_LVs</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="SensoryBase.setup_trial_LVs-401"><a href="#SensoryBase.setup_trial_LVs-401"><span class="linenos">401</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.setup_trial_LVs-402"><a href="#SensoryBase.setup_trial_LVs-402"><span class="linenos">402</span></a><span class="sd">        Usage: XLV = dataset.setup_trial_LVs()</span>
</span><span id="SensoryBase.setup_trial_LVs-403"><a href="#SensoryBase.setup_trial_LVs-403"><span class="linenos">403</span></a><span class="sd">        </span>
</span><span id="SensoryBase.setup_trial_LVs-404"><a href="#SensoryBase.setup_trial_LVs-404"><span class="linenos">404</span></a><span class="sd">        This makes design matrix as input for LVlayer (indexed LV for each trial) and outputs X, LVdims </span>
</span><span id="SensoryBase.setup_trial_LVs-405"><a href="#SensoryBase.setup_trial_LVs-405"><span class="linenos">405</span></a><span class="sd">        to actually figure out which LVs correspond to which trial, once it is done</span>
</span><span id="SensoryBase.setup_trial_LVs-406"><a href="#SensoryBase.setup_trial_LVs-406"><span class="linenos">406</span></a>
</span><span id="SensoryBase.setup_trial_LVs-407"><a href="#SensoryBase.setup_trial_LVs-407"><span class="linenos">407</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase.setup_trial_LVs-408"><a href="#SensoryBase.setup_trial_LVs-408"><span class="linenos">408</span></a><span class="sd">            X: the design matrix</span>
</span><span id="SensoryBase.setup_trial_LVs-409"><a href="#SensoryBase.setup_trial_LVs-409"><span class="linenos">409</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.setup_trial_LVs-410"><a href="#SensoryBase.setup_trial_LVs-410"><span class="linenos">410</span></a>
</span><span id="SensoryBase.setup_trial_LVs-411"><a href="#SensoryBase.setup_trial_LVs-411"><span class="linenos">411</span></a>        <span class="n">num_trials</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="SensoryBase.setup_trial_LVs-412"><a href="#SensoryBase.setup_trial_LVs-412"><span class="linenos">412</span></a>
</span><span id="SensoryBase.setup_trial_LVs-413"><a href="#SensoryBase.setup_trial_LVs-413"><span class="linenos">413</span></a>        <span class="c1"># LVs indexed 0-num_trials</span>
</span><span id="SensoryBase.setup_trial_LVs-414"><a href="#SensoryBase.setup_trial_LVs-414"><span class="linenos">414</span></a>        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="SensoryBase.setup_trial_LVs-415"><a href="#SensoryBase.setup_trial_LVs-415"><span class="linenos">415</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_trials</span><span class="p">):</span>
</span><span id="SensoryBase.setup_trial_LVs-416"><a href="#SensoryBase.setup_trial_LVs-416"><span class="linenos">416</span></a>            <span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ii</span>
</span><span id="SensoryBase.setup_trial_LVs-417"><a href="#SensoryBase.setup_trial_LVs-417"><span class="linenos">417</span></a>
</span><span id="SensoryBase.setup_trial_LVs-418"><a href="#SensoryBase.setup_trial_LVs-418"><span class="linenos">418</span></a>        <span class="k">return</span> <span class="n">X</span>
</span></pre></div>


            <div class="docstring"><p>Usage: XLV = dataset.setup_trial_LVs()</p>

<p>This makes design matrix as input for LVlayer (indexed LV for each trial) and outputs X, LVdims 
to actually figure out which LVs correspond to which trial, once it is done</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>X: the design matrix</p>
</blockquote>
</div>


                            </div>
                            <div id="SensoryBase.setup_LVLayer_input" class="classattr">
                                        <input id="SensoryBase.setup_LVLayer_input-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setup_LVLayer_input</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">tent_spacing</span><span class="o">=</span><span class="mi">10</span>, </span><span class="param"><span class="n">trsize</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.setup_LVLayer_input-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.setup_LVLayer_input"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.setup_LVLayer_input-421"><a href="#SensoryBase.setup_LVLayer_input-421"><span class="linenos">421</span></a>    <span class="k">def</span> <span class="nf">setup_LVLayer_input</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">tent_spacing</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">trsize</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="SensoryBase.setup_LVLayer_input-422"><a href="#SensoryBase.setup_LVLayer_input-422"><span class="linenos">422</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.setup_LVLayer_input-423"><a href="#SensoryBase.setup_LVLayer_input-423"><span class="linenos">423</span></a><span class="sd">        Usage: X, filter_dims = data.setup_LVLayer_input( tent_spacing=10, trsize=None)</span>
</span><span id="SensoryBase.setup_LVLayer_input-424"><a href="#SensoryBase.setup_LVLayer_input-424"><span class="linenos">424</span></a>
</span><span id="SensoryBase.setup_LVLayer_input-425"><a href="#SensoryBase.setup_LVLayer_input-425"><span class="linenos">425</span></a><span class="sd">        Sets up tent-basis-input to LVLayer (part of NDNT code)</span>
</span><span id="SensoryBase.setup_LVLayer_input-426"><a href="#SensoryBase.setup_LVLayer_input-426"><span class="linenos">426</span></a><span class="sd">        This preserves all data by using multiple effective trials for long trials. </span>
</span><span id="SensoryBase.setup_LVLayer_input-427"><a href="#SensoryBase.setup_LVLayer_input-427"><span class="linenos">427</span></a>
</span><span id="SensoryBase.setup_LVLayer_input-428"><a href="#SensoryBase.setup_LVLayer_input-428"><span class="linenos">428</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase.setup_LVLayer_input-429"><a href="#SensoryBase.setup_LVLayer_input-429"><span class="linenos">429</span></a><span class="sd">            tent_spacing: the spacing of the tent functions</span>
</span><span id="SensoryBase.setup_LVLayer_input-430"><a href="#SensoryBase.setup_LVLayer_input-430"><span class="linenos">430</span></a><span class="sd">            trsize: the size of the trials</span>
</span><span id="SensoryBase.setup_LVLayer_input-431"><a href="#SensoryBase.setup_LVLayer_input-431"><span class="linenos">431</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.setup_LVLayer_input-432"><a href="#SensoryBase.setup_LVLayer_input-432"><span class="linenos">432</span></a>        <span class="c1"># Determine trial_size</span>
</span><span id="SensoryBase.setup_LVLayer_input-433"><a href="#SensoryBase.setup_LVLayer_input-433"><span class="linenos">433</span></a>        <span class="n">Ntr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="SensoryBase.setup_LVLayer_input-434"><a href="#SensoryBase.setup_LVLayer_input-434"><span class="linenos">434</span></a>        <span class="n">trsizes</span><span class="o">=</span><span class="p">[]</span>
</span><span id="SensoryBase.setup_LVLayer_input-435"><a href="#SensoryBase.setup_LVLayer_input-435"><span class="linenos">435</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntr</span><span class="p">):</span>
</span><span id="SensoryBase.setup_LVLayer_input-436"><a href="#SensoryBase.setup_LVLayer_input-436"><span class="linenos">436</span></a>            <span class="n">trsizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
</span><span id="SensoryBase.setup_LVLayer_input-437"><a href="#SensoryBase.setup_LVLayer_input-437"><span class="linenos">437</span></a>        <span class="k">if</span> <span class="n">trsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase.setup_LVLayer_input-438"><a href="#SensoryBase.setup_LVLayer_input-438"><span class="linenos">438</span></a>            <span class="n">L0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">trsizes</span><span class="p">)</span>
</span><span id="SensoryBase.setup_LVLayer_input-439"><a href="#SensoryBase.setup_LVLayer_input-439"><span class="linenos">439</span></a>
</span><span id="SensoryBase.setup_LVLayer_input-440"><a href="#SensoryBase.setup_LVLayer_input-440"><span class="linenos">440</span></a>        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span><span id="SensoryBase.setup_LVLayer_input-441"><a href="#SensoryBase.setup_LVLayer_input-441"><span class="linenos">441</span></a>        <span class="n">ramp_down</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tent_spacing</span><span class="p">))</span><span class="o">/</span><span class="n">tent_spacing</span>
</span><span id="SensoryBase.setup_LVLayer_input-442"><a href="#SensoryBase.setup_LVLayer_input-442"><span class="linenos">442</span></a>        <span class="n">NW0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">L0</span><span class="o">/</span><span class="n">tent_spacing</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>  <span class="c1"># how many LVs in standard trial</span>
</span><span id="SensoryBase.setup_LVLayer_input-443"><a href="#SensoryBase.setup_LVLayer_input-443"><span class="linenos">443</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Trial size = </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2"> LV indices per trial&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">L0</span><span class="p">,</span> <span class="n">NW0</span><span class="p">)</span> <span class="p">)</span>
</span><span id="SensoryBase.setup_LVLayer_input-444"><a href="#SensoryBase.setup_LVLayer_input-444"><span class="linenos">444</span></a>
</span><span id="SensoryBase.setup_LVLayer_input-445"><a href="#SensoryBase.setup_LVLayer_input-445"><span class="linenos">445</span></a>        <span class="n">Ntr_eff</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SensoryBase.setup_LVLayer_input-446"><a href="#SensoryBase.setup_LVLayer_input-446"><span class="linenos">446</span></a>        <span class="n">LVindex_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SensoryBase.setup_LVLayer_input-447"><a href="#SensoryBase.setup_LVLayer_input-447"><span class="linenos">447</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntr</span><span class="p">):</span>
</span><span id="SensoryBase.setup_LVLayer_input-448"><a href="#SensoryBase.setup_LVLayer_input-448"><span class="linenos">448</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="SensoryBase.setup_LVLayer_input-449"><a href="#SensoryBase.setup_LVLayer_input-449"><span class="linenos">449</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
</span><span id="SensoryBase.setup_LVLayer_input-450"><a href="#SensoryBase.setup_LVLayer_input-450"><span class="linenos">450</span></a>            <span class="n">NLVts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">tent_spacing</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># this gets one on edge, given partials are pegged at 1</span>
</span><span id="SensoryBase.setup_LVLayer_input-451"><a href="#SensoryBase.setup_LVLayer_input-451"><span class="linenos">451</span></a>            <span class="n">assigned_LVs_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NLVts</span><span class="p">)</span> <span class="o">+</span> <span class="n">LVindex_count</span>
</span><span id="SensoryBase.setup_LVLayer_input-452"><a href="#SensoryBase.setup_LVLayer_input-452"><span class="linenos">452</span></a>            
</span><span id="SensoryBase.setup_LVLayer_input-453"><a href="#SensoryBase.setup_LVLayer_input-453"><span class="linenos">453</span></a>            <span class="c1"># Map these LVs </span>
</span><span id="SensoryBase.setup_LVLayer_input-454"><a href="#SensoryBase.setup_LVLayer_input-454"><span class="linenos">454</span></a>            <span class="n">X</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">assigned_LVs_inds</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tent_spacing</span><span class="p">)[:</span><span class="n">L</span><span class="p">]</span>
</span><span id="SensoryBase.setup_LVLayer_input-455"><a href="#SensoryBase.setup_LVLayer_input-455"><span class="linenos">455</span></a>            <span class="n">X</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">assigned_LVs_inds</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">tent_spacing</span><span class="p">)[:</span><span class="n">L</span><span class="p">]</span>
</span><span id="SensoryBase.setup_LVLayer_input-456"><a href="#SensoryBase.setup_LVLayer_input-456"><span class="linenos">456</span></a>            <span class="n">X</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">ramp_down</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">tent_spacing</span><span class="p">)))[:</span><span class="n">L</span><span class="p">]</span>  <span class="c1"># this will leave the last bit ones</span>
</span><span id="SensoryBase.setup_LVLayer_input-457"><a href="#SensoryBase.setup_LVLayer_input-457"><span class="linenos">457</span></a>            
</span><span id="SensoryBase.setup_LVLayer_input-458"><a href="#SensoryBase.setup_LVLayer_input-458"><span class="linenos">458</span></a>            <span class="c1"># Need to do multiples of trial length so that smoothing works</span>
</span><span id="SensoryBase.setup_LVLayer_input-459"><a href="#SensoryBase.setup_LVLayer_input-459"><span class="linenos">459</span></a>            <span class="n">num_trial_blocks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">L0</span><span class="p">))</span>
</span><span id="SensoryBase.setup_LVLayer_input-460"><a href="#SensoryBase.setup_LVLayer_input-460"><span class="linenos">460</span></a>            <span class="n">LVindex_count</span> <span class="o">+=</span> <span class="n">num_trial_blocks</span> <span class="o">*</span> <span class="n">NW0</span>
</span><span id="SensoryBase.setup_LVLayer_input-461"><a href="#SensoryBase.setup_LVLayer_input-461"><span class="linenos">461</span></a>            <span class="n">Ntr_eff</span> <span class="o">+=</span> <span class="n">num_trial_blocks</span>
</span><span id="SensoryBase.setup_LVLayer_input-462"><a href="#SensoryBase.setup_LVLayer_input-462"><span class="linenos">462</span></a>            
</span><span id="SensoryBase.setup_LVLayer_input-463"><a href="#SensoryBase.setup_LVLayer_input-463"><span class="linenos">463</span></a>        <span class="n">filter_dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ntr_eff</span><span class="p">,</span> <span class="n">NW0</span><span class="p">]</span>
</span><span id="SensoryBase.setup_LVLayer_input-464"><a href="#SensoryBase.setup_LVLayer_input-464"><span class="linenos">464</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> time points, </span><span class="si">%d</span><span class="s2"> LV indices&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">LVindex_count</span><span class="p">))</span>
</span><span id="SensoryBase.setup_LVLayer_input-465"><a href="#SensoryBase.setup_LVLayer_input-465"><span class="linenos">465</span></a>        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">filter_dims</span>
</span><span id="SensoryBase.setup_LVLayer_input-466"><a href="#SensoryBase.setup_LVLayer_input-466"><span class="linenos">466</span></a>        <span class="c1"># END SensoryBase.setup_LVLayer_input()</span>
</span></pre></div>


            <div class="docstring"><p>Usage: X, filter_dims = data.setup_LVLayer_input( tent_spacing=10, trsize=None)</p>

<p>Sets up tent-basis-input to LVLayer (part of NDNT code)
This preserves all data by using multiple effective trials for long trials. </p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>tent_spacing:</strong>  the spacing of the tent functions</li>
<li><strong>trsize:</strong>  the size of the trials</li>
</ul>
</div>


                            </div>
                            <div id="SensoryBase.design_matrix_drift" class="classattr">
                                        <input id="SensoryBase.design_matrix_drift-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">design_matrix_drift</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">NT</span>,</span><span class="param">	<span class="n">anchors</span>,</span><span class="param">	<span class="n">zero_left</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">zero_right</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">const_left</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">const_right</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">to_plot</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.design_matrix_drift-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.design_matrix_drift"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.design_matrix_drift-468"><a href="#SensoryBase.design_matrix_drift-468"><span class="linenos">468</span></a>    <span class="nd">@staticmethod</span>
</span><span id="SensoryBase.design_matrix_drift-469"><a href="#SensoryBase.design_matrix_drift-469"><span class="linenos">469</span></a>    <span class="k">def</span> <span class="nf">design_matrix_drift</span><span class="p">(</span> <span class="n">NT</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">zero_right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">to_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="SensoryBase.design_matrix_drift-470"><a href="#SensoryBase.design_matrix_drift-470"><span class="linenos">470</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.design_matrix_drift-471"><a href="#SensoryBase.design_matrix_drift-471"><span class="linenos">471</span></a><span class="sd">        Produce a design matrix based on continuous data (s) and anchor points for a tent_basis.</span>
</span><span id="SensoryBase.design_matrix_drift-472"><a href="#SensoryBase.design_matrix_drift-472"><span class="linenos">472</span></a><span class="sd">        Here s is a continuous variable (e.g., a stimulus) that is function of time -- single dimension --</span>
</span><span id="SensoryBase.design_matrix_drift-473"><a href="#SensoryBase.design_matrix_drift-473"><span class="linenos">473</span></a><span class="sd">        and this will generate apply a tent basis set to s with a basis variable for each anchor point. </span>
</span><span id="SensoryBase.design_matrix_drift-474"><a href="#SensoryBase.design_matrix_drift-474"><span class="linenos">474</span></a><span class="sd">        The end anchor points will be one-sided, but these can be dropped by changing &quot;zero_left&quot; and/or</span>
</span><span id="SensoryBase.design_matrix_drift-475"><a href="#SensoryBase.design_matrix_drift-475"><span class="linenos">475</span></a><span class="sd">        &quot;zero_right&quot; into &quot;True&quot;.</span>
</span><span id="SensoryBase.design_matrix_drift-476"><a href="#SensoryBase.design_matrix_drift-476"><span class="linenos">476</span></a>
</span><span id="SensoryBase.design_matrix_drift-477"><a href="#SensoryBase.design_matrix_drift-477"><span class="linenos">477</span></a><span class="sd">        Args: </span>
</span><span id="SensoryBase.design_matrix_drift-478"><a href="#SensoryBase.design_matrix_drift-478"><span class="linenos">478</span></a><span class="sd">            NT: length of design matrix</span>
</span><span id="SensoryBase.design_matrix_drift-479"><a href="#SensoryBase.design_matrix_drift-479"><span class="linenos">479</span></a><span class="sd">            anchors: list or array of anchor points for tent-basis set</span>
</span><span id="SensoryBase.design_matrix_drift-480"><a href="#SensoryBase.design_matrix_drift-480"><span class="linenos">480</span></a><span class="sd">            zero_left, zero_right: boolean whether to drop the edge bases (default for both is False)</span>
</span><span id="SensoryBase.design_matrix_drift-481"><a href="#SensoryBase.design_matrix_drift-481"><span class="linenos">481</span></a><span class="sd">            const_left, const_right: boolean whether to make constant basis on left/right (default for both is False)</span>
</span><span id="SensoryBase.design_matrix_drift-482"><a href="#SensoryBase.design_matrix_drift-482"><span class="linenos">482</span></a><span class="sd">            to_plot: whether to plot the design matrix</span>
</span><span id="SensoryBase.design_matrix_drift-483"><a href="#SensoryBase.design_matrix_drift-483"><span class="linenos">483</span></a><span class="sd">        </span>
</span><span id="SensoryBase.design_matrix_drift-484"><a href="#SensoryBase.design_matrix_drift-484"><span class="linenos">484</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase.design_matrix_drift-485"><a href="#SensoryBase.design_matrix_drift-485"><span class="linenos">485</span></a><span class="sd">            X: design matrix that will be NT x the number of anchors left after zeroing out left and right</span>
</span><span id="SensoryBase.design_matrix_drift-486"><a href="#SensoryBase.design_matrix_drift-486"><span class="linenos">486</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.design_matrix_drift-487"><a href="#SensoryBase.design_matrix_drift-487"><span class="linenos">487</span></a>        <span class="n">anchors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span>
</span><span id="SensoryBase.design_matrix_drift-488"><a href="#SensoryBase.design_matrix_drift-488"><span class="linenos">488</span></a>        <span class="k">if</span> <span class="n">anchors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SensoryBase.design_matrix_drift-489"><a href="#SensoryBase.design_matrix_drift-489"><span class="linenos">489</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">const_left</span><span class="p">:</span>
</span><span id="SensoryBase.design_matrix_drift-490"><a href="#SensoryBase.design_matrix_drift-490"><span class="linenos">490</span></a>                <span class="n">anchors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">anchors</span>
</span><span id="SensoryBase.design_matrix_drift-491"><a href="#SensoryBase.design_matrix_drift-491"><span class="linenos">491</span></a>        <span class="c1">#if anchors[-1] &lt; NT:</span>
</span><span id="SensoryBase.design_matrix_drift-492"><a href="#SensoryBase.design_matrix_drift-492"><span class="linenos">492</span></a>        <span class="c1">#    anchors = anchors + [NT]</span>
</span><span id="SensoryBase.design_matrix_drift-493"><a href="#SensoryBase.design_matrix_drift-493"><span class="linenos">493</span></a>        <span class="n">NA</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span>
</span><span id="SensoryBase.design_matrix_drift-494"><a href="#SensoryBase.design_matrix_drift-494"><span class="linenos">494</span></a>
</span><span id="SensoryBase.design_matrix_drift-495"><a href="#SensoryBase.design_matrix_drift-495"><span class="linenos">495</span></a>        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NT</span><span class="p">,</span> <span class="n">NA</span><span class="p">])</span>
</span><span id="SensoryBase.design_matrix_drift-496"><a href="#SensoryBase.design_matrix_drift-496"><span class="linenos">496</span></a>        <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NA</span><span class="p">):</span>
</span><span id="SensoryBase.design_matrix_drift-497"><a href="#SensoryBase.design_matrix_drift-497"><span class="linenos">497</span></a>            <span class="k">if</span> <span class="n">aa</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SensoryBase.design_matrix_drift-498"><a href="#SensoryBase.design_matrix_drift-498"><span class="linenos">498</span></a>                <span class="n">dx</span> <span class="o">=</span> <span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="p">]</span><span class="o">-</span><span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SensoryBase.design_matrix_drift-499"><a href="#SensoryBase.design_matrix_drift-499"><span class="linenos">499</span></a>                <span class="n">X</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="p">]),</span> <span class="n">aa</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span>
</span><span id="SensoryBase.design_matrix_drift-500"><a href="#SensoryBase.design_matrix_drift-500"><span class="linenos">500</span></a>            <span class="k">if</span> <span class="n">aa</span> <span class="o">&lt;</span> <span class="n">NA</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="SensoryBase.design_matrix_drift-501"><a href="#SensoryBase.design_matrix_drift-501"><span class="linenos">501</span></a>                <span class="n">dx</span> <span class="o">=</span> <span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="p">]</span>
</span><span id="SensoryBase.design_matrix_drift-502"><a href="#SensoryBase.design_matrix_drift-502"><span class="linenos">502</span></a>                <span class="n">X</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="p">],</span> <span class="n">anchors</span><span class="p">[</span><span class="n">aa</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span> <span class="n">aa</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span>
</span><span id="SensoryBase.design_matrix_drift-503"><a href="#SensoryBase.design_matrix_drift-503"><span class="linenos">503</span></a>
</span><span id="SensoryBase.design_matrix_drift-504"><a href="#SensoryBase.design_matrix_drift-504"><span class="linenos">504</span></a>        <span class="k">if</span> <span class="n">zero_left</span><span class="p">:</span>
</span><span id="SensoryBase.design_matrix_drift-505"><a href="#SensoryBase.design_matrix_drift-505"><span class="linenos">505</span></a>            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
</span><span id="SensoryBase.design_matrix_drift-506"><a href="#SensoryBase.design_matrix_drift-506"><span class="linenos">506</span></a>        <span class="k">elif</span> <span class="n">const_left</span><span class="p">:</span>  <span class="c1"># makes constant from first anchor back to origin -- wont work without zero-left</span>
</span><span id="SensoryBase.design_matrix_drift-507"><a href="#SensoryBase.design_matrix_drift-507"><span class="linenos">507</span></a>            <span class="n">X</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">anchors</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="SensoryBase.design_matrix_drift-508"><a href="#SensoryBase.design_matrix_drift-508"><span class="linenos">508</span></a>
</span><span id="SensoryBase.design_matrix_drift-509"><a href="#SensoryBase.design_matrix_drift-509"><span class="linenos">509</span></a>        <span class="k">if</span> <span class="n">const_right</span><span class="p">:</span>
</span><span id="SensoryBase.design_matrix_drift-510"><a href="#SensoryBase.design_matrix_drift-510"><span class="linenos">510</span></a>            <span class="n">X</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">anchors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">NT</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="SensoryBase.design_matrix_drift-511"><a href="#SensoryBase.design_matrix_drift-511"><span class="linenos">511</span></a>
</span><span id="SensoryBase.design_matrix_drift-512"><a href="#SensoryBase.design_matrix_drift-512"><span class="linenos">512</span></a>        <span class="k">if</span> <span class="n">zero_right</span><span class="p">:</span>
</span><span id="SensoryBase.design_matrix_drift-513"><a href="#SensoryBase.design_matrix_drift-513"><span class="linenos">513</span></a>            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SensoryBase.design_matrix_drift-514"><a href="#SensoryBase.design_matrix_drift-514"><span class="linenos">514</span></a>
</span><span id="SensoryBase.design_matrix_drift-515"><a href="#SensoryBase.design_matrix_drift-515"><span class="linenos">515</span></a>        <span class="k">if</span> <span class="n">to_plot</span><span class="p">:</span>
</span><span id="SensoryBase.design_matrix_drift-516"><a href="#SensoryBase.design_matrix_drift-516"><span class="linenos">516</span></a>            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span id="SensoryBase.design_matrix_drift-517"><a href="#SensoryBase.design_matrix_drift-517"><span class="linenos">517</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
</span><span id="SensoryBase.design_matrix_drift-518"><a href="#SensoryBase.design_matrix_drift-518"><span class="linenos">518</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="SensoryBase.design_matrix_drift-519"><a href="#SensoryBase.design_matrix_drift-519"><span class="linenos">519</span></a>
</span><span id="SensoryBase.design_matrix_drift-520"><a href="#SensoryBase.design_matrix_drift-520"><span class="linenos">520</span></a>        <span class="k">return</span> <span class="n">X</span>
</span></pre></div>


            <div class="docstring"><p>Produce a design matrix based on continuous data (s) and anchor points for a tent_basis.
Here s is a continuous variable (e.g., a stimulus) that is function of time -- single dimension --
and this will generate apply a tent basis set to s with a basis variable for each anchor point. 
The end anchor points will be one-sided, but these can be dropped by changing "zero_left" and/or
"zero_right" into "True".</p>

<p>Args: 
    NT: length of design matrix
    anchors: list or array of anchor points for tent-basis set
    zero_left, zero_right: boolean whether to drop the edge bases (default for both is False)
    const_left, const_right: boolean whether to make constant basis on left/right (default for both is False)
    to_plot: whether to plot the design matrix</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>X: design matrix that will be NT x the number of anchors left after zeroing out left and right</p>
</blockquote>
</div>


                            </div>
                            <div id="SensoryBase.construct_onehot_design_matrix" class="classattr">
                                        <input id="SensoryBase.construct_onehot_design_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">construct_onehot_design_matrix</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">stim</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">return_categories</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.construct_onehot_design_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.construct_onehot_design_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.construct_onehot_design_matrix-522"><a href="#SensoryBase.construct_onehot_design_matrix-522"><span class="linenos">522</span></a>    <span class="nd">@staticmethod</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-523"><a href="#SensoryBase.construct_onehot_design_matrix-523"><span class="linenos">523</span></a>    <span class="k">def</span> <span class="nf">construct_onehot_design_matrix</span><span class="p">(</span> <span class="n">stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_categories</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-524"><a href="#SensoryBase.construct_onehot_design_matrix-524"><span class="linenos">524</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-525"><a href="#SensoryBase.construct_onehot_design_matrix-525"><span class="linenos">525</span></a><span class="sd">        Construct one-hot design matrix from stimulus.</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-526"><a href="#SensoryBase.construct_onehot_design_matrix-526"><span class="linenos">526</span></a>
</span><span id="SensoryBase.construct_onehot_design_matrix-527"><a href="#SensoryBase.construct_onehot_design_matrix-527"><span class="linenos">527</span></a><span class="sd">        The stimulus should be numpy -- not meant to be used with torch currently.</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-528"><a href="#SensoryBase.construct_onehot_design_matrix-528"><span class="linenos">528</span></a><span class="sd">        </span>
</span><span id="SensoryBase.construct_onehot_design_matrix-529"><a href="#SensoryBase.construct_onehot_design_matrix-529"><span class="linenos">529</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-530"><a href="#SensoryBase.construct_onehot_design_matrix-530"><span class="linenos">530</span></a><span class="sd">            stim: the stimulus to construct one-hot design matrix from</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-531"><a href="#SensoryBase.construct_onehot_design_matrix-531"><span class="linenos">531</span></a><span class="sd">            return_categories: whether to return the categories</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-532"><a href="#SensoryBase.construct_onehot_design_matrix-532"><span class="linenos">532</span></a>
</span><span id="SensoryBase.construct_onehot_design_matrix-533"><a href="#SensoryBase.construct_onehot_design_matrix-533"><span class="linenos">533</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-534"><a href="#SensoryBase.construct_onehot_design_matrix-534"><span class="linenos">534</span></a><span class="sd">            OHmatrix: the one-hot design matrix</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-535"><a href="#SensoryBase.construct_onehot_design_matrix-535"><span class="linenos">535</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-536"><a href="#SensoryBase.construct_onehot_design_matrix-536"><span class="linenos">536</span></a>        <span class="k">assert</span> <span class="n">stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must pass in stimulus&quot;</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-537"><a href="#SensoryBase.construct_onehot_design_matrix-537"><span class="linenos">537</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;Stimulus must be one-dimensional&quot;</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-538"><a href="#SensoryBase.construct_onehot_design_matrix-538"><span class="linenos">538</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">stim</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="p">),</span> <span class="s2">&quot;stim must be a numpy array&quot;</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-539"><a href="#SensoryBase.construct_onehot_design_matrix-539"><span class="linenos">539</span></a>
</span><span id="SensoryBase.construct_onehot_design_matrix-540"><a href="#SensoryBase.construct_onehot_design_matrix-540"><span class="linenos">540</span></a>        <span class="n">category_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-541"><a href="#SensoryBase.construct_onehot_design_matrix-541"><span class="linenos">541</span></a>        <span class="n">NSTIM</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">category_list</span><span class="p">)</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-542"><a href="#SensoryBase.construct_onehot_design_matrix-542"><span class="linenos">542</span></a>        <span class="k">assert</span> <span class="n">NSTIM</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;Must have less than 50 classifications in one-hot: something wrong?&quot;</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-543"><a href="#SensoryBase.construct_onehot_design_matrix-543"><span class="linenos">543</span></a>        <span class="n">OHmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">NSTIM</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-544"><a href="#SensoryBase.construct_onehot_design_matrix-544"><span class="linenos">544</span></a>        <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NSTIM</span><span class="p">):</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-545"><a href="#SensoryBase.construct_onehot_design_matrix-545"><span class="linenos">545</span></a>            <span class="n">OHmatrix</span><span class="p">[</span><span class="n">stim</span> <span class="o">==</span> <span class="n">category_list</span><span class="p">[</span><span class="n">ss</span><span class="p">],</span> <span class="n">ss</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-546"><a href="#SensoryBase.construct_onehot_design_matrix-546"><span class="linenos">546</span></a>        
</span><span id="SensoryBase.construct_onehot_design_matrix-547"><a href="#SensoryBase.construct_onehot_design_matrix-547"><span class="linenos">547</span></a>        <span class="k">if</span> <span class="n">return_categories</span><span class="p">:</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-548"><a href="#SensoryBase.construct_onehot_design_matrix-548"><span class="linenos">548</span></a>            <span class="k">return</span> <span class="n">OHmatrix</span><span class="p">,</span> <span class="n">category_list</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-549"><a href="#SensoryBase.construct_onehot_design_matrix-549"><span class="linenos">549</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.construct_onehot_design_matrix-550"><a href="#SensoryBase.construct_onehot_design_matrix-550"><span class="linenos">550</span></a>            <span class="k">return</span> <span class="n">OHmatrix</span>
</span></pre></div>


            <div class="docstring"><p>Construct one-hot design matrix from stimulus.</p>

<p>The stimulus should be numpy -- not meant to be used with torch currently.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>stim:</strong>  the stimulus to construct one-hot design matrix from</li>
<li><strong>return_categories:</strong>  whether to return the categories</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>OHmatrix: the one-hot design matrix</p>
</blockquote>
</div>


                            </div>
                            <div id="SensoryBase.avrates" class="classattr">
                                        <input id="SensoryBase.avrates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">avrates</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">inds</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.avrates-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.avrates"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.avrates-553"><a href="#SensoryBase.avrates-553"><span class="linenos">553</span></a>    <span class="k">def</span> <span class="nf">avrates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="SensoryBase.avrates-554"><a href="#SensoryBase.avrates-554"><span class="linenos">554</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.avrates-555"><a href="#SensoryBase.avrates-555"><span class="linenos">555</span></a><span class="sd">        Calculates average firing probability across specified inds (or whole dataset)</span>
</span><span id="SensoryBase.avrates-556"><a href="#SensoryBase.avrates-556"><span class="linenos">556</span></a><span class="sd">        -- Note will respect datafilters</span>
</span><span id="SensoryBase.avrates-557"><a href="#SensoryBase.avrates-557"><span class="linenos">557</span></a><span class="sd">        -- will return precalc value to save time if already stored</span>
</span><span id="SensoryBase.avrates-558"><a href="#SensoryBase.avrates-558"><span class="linenos">558</span></a>
</span><span id="SensoryBase.avrates-559"><a href="#SensoryBase.avrates-559"><span class="linenos">559</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase.avrates-560"><a href="#SensoryBase.avrates-560"><span class="linenos">560</span></a><span class="sd">            inds: the indices to calculate the average firing probability across</span>
</span><span id="SensoryBase.avrates-561"><a href="#SensoryBase.avrates-561"><span class="linenos">561</span></a>
</span><span id="SensoryBase.avrates-562"><a href="#SensoryBase.avrates-562"><span class="linenos">562</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase.avrates-563"><a href="#SensoryBase.avrates-563"><span class="linenos">563</span></a><span class="sd">            avRs: the average firing probability</span>
</span><span id="SensoryBase.avrates-564"><a href="#SensoryBase.avrates-564"><span class="linenos">564</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.avrates-565"><a href="#SensoryBase.avrates-565"><span class="linenos">565</span></a>        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase.avrates-566"><a href="#SensoryBase.avrates-566"><span class="linenos">566</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="SensoryBase.avrates-567"><a href="#SensoryBase.avrates-567"><span class="linenos">567</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SensoryBase.avrates-568"><a href="#SensoryBase.avrates-568"><span class="linenos">568</span></a>            <span class="n">cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">)</span>
</span><span id="SensoryBase.avrates-569"><a href="#SensoryBase.avrates-569"><span class="linenos">569</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.avrates-570"><a href="#SensoryBase.avrates-570"><span class="linenos">570</span></a>            <span class="n">cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span>
</span><span id="SensoryBase.avrates-571"><a href="#SensoryBase.avrates-571"><span class="linenos">571</span></a>
</span><span id="SensoryBase.avrates-572"><a href="#SensoryBase.avrates-572"><span class="linenos">572</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="SensoryBase.avrates-573"><a href="#SensoryBase.avrates-573"><span class="linenos">573</span></a>            <span class="c1"># then calculate across whole dataset</span>
</span><span id="SensoryBase.avrates-574"><a href="#SensoryBase.avrates-574"><span class="linenos">574</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase.avrates-575"><a href="#SensoryBase.avrates-575"><span class="linenos">575</span></a>                <span class="c1"># then precalculated and do not need to do</span>
</span><span id="SensoryBase.avrates-576"><a href="#SensoryBase.avrates-576"><span class="linenos">576</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span><span class="p">[</span><span class="n">cells</span><span class="p">]</span>
</span><span id="SensoryBase.avrates-577"><a href="#SensoryBase.avrates-577"><span class="linenos">577</span></a>
</span><span id="SensoryBase.avrates-578"><a href="#SensoryBase.avrates-578"><span class="linenos">578</span></a>        <span class="c1"># Otherwise calculate across all data</span>
</span><span id="SensoryBase.avrates-579"><a href="#SensoryBase.avrates-579"><span class="linenos">579</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="SensoryBase.avrates-580"><a href="#SensoryBase.avrates-580"><span class="linenos">580</span></a>            <span class="n">Reff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="SensoryBase.avrates-581"><a href="#SensoryBase.avrates-581"><span class="linenos">581</span></a>            <span class="n">Teff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="SensoryBase.avrates-582"><a href="#SensoryBase.avrates-582"><span class="linenos">582</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="o">/</span><span class="n">Teff</span><span class="p">)[</span><span class="n">cells</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="SensoryBase.avrates-583"><a href="#SensoryBase.avrates-583"><span class="linenos">583</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.avrates-584"><a href="#SensoryBase.avrates-584"><span class="linenos">584</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Still need to implement avRs without preloading&#39;</span><span class="p">)</span>
</span><span id="SensoryBase.avrates-585"><a href="#SensoryBase.avrates-585"><span class="linenos">585</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Calculates average firing probability across specified inds (or whole dataset)
-- Note will respect datafilters
-- will return precalc value to save time if already stored</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>inds:</strong>  the indices to calculate the average firing probability across</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>avRs: the average firing probability</p>
</blockquote>
</div>


                            </div>
                            <div id="SensoryBase.crossval_setup" class="classattr">
                                        <input id="SensoryBase.crossval_setup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">crossval_setup</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">folds</span><span class="o">=</span><span class="mi">5</span>, </span><span class="param"><span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">test_set</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.crossval_setup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.crossval_setup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.crossval_setup-588"><a href="#SensoryBase.crossval_setup-588"><span class="linenos">588</span></a>    <span class="k">def</span> <span class="nf">crossval_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test_set</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="SensoryBase.crossval_setup-589"><a href="#SensoryBase.crossval_setup-589"><span class="linenos">589</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.crossval_setup-590"><a href="#SensoryBase.crossval_setup-590"><span class="linenos">590</span></a><span class="sd">        This sets the cross-validation indices up We can add featuers here. Many ways to do this</span>
</span><span id="SensoryBase.crossval_setup-591"><a href="#SensoryBase.crossval_setup-591"><span class="linenos">591</span></a><span class="sd">        but will stick to some standard for now. It sets the internal indices, which can be read out</span>
</span><span id="SensoryBase.crossval_setup-592"><a href="#SensoryBase.crossval_setup-592"><span class="linenos">592</span></a><span class="sd">        directly or with helper functions. Perhaps helper_functions is the best way....</span>
</span><span id="SensoryBase.crossval_setup-593"><a href="#SensoryBase.crossval_setup-593"><span class="linenos">593</span></a><span class="sd">        </span>
</span><span id="SensoryBase.crossval_setup-594"><a href="#SensoryBase.crossval_setup-594"><span class="linenos">594</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase.crossval_setup-595"><a href="#SensoryBase.crossval_setup-595"><span class="linenos">595</span></a><span class="sd">            folds: the number of folds to use</span>
</span><span id="SensoryBase.crossval_setup-596"><a href="#SensoryBase.crossval_setup-596"><span class="linenos">596</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="SensoryBase.crossval_setup-597"><a href="#SensoryBase.crossval_setup-597"><span class="linenos">597</span></a><span class="sd">            test_set: whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</span>
</span><span id="SensoryBase.crossval_setup-598"><a href="#SensoryBase.crossval_setup-598"><span class="linenos">598</span></a><span class="sd">            verbose: whether to print out the number of fixations in each set</span>
</span><span id="SensoryBase.crossval_setup-599"><a href="#SensoryBase.crossval_setup-599"><span class="linenos">599</span></a>
</span><span id="SensoryBase.crossval_setup-600"><a href="#SensoryBase.crossval_setup-600"><span class="linenos">600</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase.crossval_setup-601"><a href="#SensoryBase.crossval_setup-601"><span class="linenos">601</span></a><span class="sd">            None: sets internal variables test_inds, train_inds, val_inds</span>
</span><span id="SensoryBase.crossval_setup-602"><a href="#SensoryBase.crossval_setup-602"><span class="linenos">602</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.crossval_setup-603"><a href="#SensoryBase.crossval_setup-603"><span class="linenos">603</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must first specify valid_indices before setting up cross-validation.&quot;</span>
</span><span id="SensoryBase.crossval_setup-604"><a href="#SensoryBase.crossval_setup-604"><span class="linenos">604</span></a>
</span><span id="SensoryBase.crossval_setup-605"><a href="#SensoryBase.crossval_setup-605"><span class="linenos">605</span></a>        <span class="c1"># Reflect block structure</span>
</span><span id="SensoryBase.crossval_setup-606"><a href="#SensoryBase.crossval_setup-606"><span class="linenos">606</span></a>        <span class="n">Nblks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="SensoryBase.crossval_setup-607"><a href="#SensoryBase.crossval_setup-607"><span class="linenos">607</span></a>        <span class="n">val_blk1</span><span class="p">,</span> <span class="n">tr_blk1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="n">Nblks</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="SensoryBase.crossval_setup-608"><a href="#SensoryBase.crossval_setup-608"><span class="linenos">608</span></a>
</span><span id="SensoryBase.crossval_setup-609"><a href="#SensoryBase.crossval_setup-609"><span class="linenos">609</span></a>        <span class="k">if</span> <span class="n">test_set</span><span class="p">:</span>
</span><span id="SensoryBase.crossval_setup-610"><a href="#SensoryBase.crossval_setup-610"><span class="linenos">610</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="n">val_blk1</span>
</span><span id="SensoryBase.crossval_setup-611"><a href="#SensoryBase.crossval_setup-611"><span class="linenos">611</span></a>            <span class="n">val_blk2</span><span class="p">,</span> <span class="n">tr_blk2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_blk1</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="SensoryBase.crossval_setup-612"><a href="#SensoryBase.crossval_setup-612"><span class="linenos">612</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span><span class="p">[</span><span class="n">val_blk2</span><span class="p">]</span>
</span><span id="SensoryBase.crossval_setup-613"><a href="#SensoryBase.crossval_setup-613"><span class="linenos">613</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span><span class="p">[</span><span class="n">tr_blk2</span><span class="p">]</span>
</span><span id="SensoryBase.crossval_setup-614"><a href="#SensoryBase.crossval_setup-614"><span class="linenos">614</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.crossval_setup-615"><a href="#SensoryBase.crossval_setup-615"><span class="linenos">615</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">val_blk1</span>
</span><span id="SensoryBase.crossval_setup-616"><a href="#SensoryBase.crossval_setup-616"><span class="linenos">616</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span>
</span><span id="SensoryBase.crossval_setup-617"><a href="#SensoryBase.crossval_setup-617"><span class="linenos">617</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SensoryBase.crossval_setup-618"><a href="#SensoryBase.crossval_setup-618"><span class="linenos">618</span></a>
</span><span id="SensoryBase.crossval_setup-619"><a href="#SensoryBase.crossval_setup-619"><span class="linenos">619</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="SensoryBase.crossval_setup-620"><a href="#SensoryBase.crossval_setup-620"><span class="linenos">620</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Partitioned </span><span class="si">%d</span><span class="s2"> fixations total: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span>
</span><span id="SensoryBase.crossval_setup-621"><a href="#SensoryBase.crossval_setup-621"><span class="linenos">621</span></a>                <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">)))</span>  
</span><span id="SensoryBase.crossval_setup-622"><a href="#SensoryBase.crossval_setup-622"><span class="linenos">622</span></a>
</span><span id="SensoryBase.crossval_setup-623"><a href="#SensoryBase.crossval_setup-623"><span class="linenos">623</span></a>        <span class="c1"># Now pull indices from each saccade </span>
</span><span id="SensoryBase.crossval_setup-624"><a href="#SensoryBase.crossval_setup-624"><span class="linenos">624</span></a>        <span class="n">tr_inds</span><span class="p">,</span> <span class="n">te_inds</span><span class="p">,</span> <span class="n">val_inds</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="SensoryBase.crossval_setup-625"><a href="#SensoryBase.crossval_setup-625"><span class="linenos">625</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">:</span>
</span><span id="SensoryBase.crossval_setup-626"><a href="#SensoryBase.crossval_setup-626"><span class="linenos">626</span></a>            <span class="n">tr_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="SensoryBase.crossval_setup-627"><a href="#SensoryBase.crossval_setup-627"><span class="linenos">627</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">:</span>
</span><span id="SensoryBase.crossval_setup-628"><a href="#SensoryBase.crossval_setup-628"><span class="linenos">628</span></a>            <span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="SensoryBase.crossval_setup-629"><a href="#SensoryBase.crossval_setup-629"><span class="linenos">629</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">:</span>
</span><span id="SensoryBase.crossval_setup-630"><a href="#SensoryBase.crossval_setup-630"><span class="linenos">630</span></a>            <span class="n">te_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="SensoryBase.crossval_setup-631"><a href="#SensoryBase.crossval_setup-631"><span class="linenos">631</span></a>
</span><span id="SensoryBase.crossval_setup-632"><a href="#SensoryBase.crossval_setup-632"><span class="linenos">632</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="SensoryBase.crossval_setup-633"><a href="#SensoryBase.crossval_setup-633"><span class="linenos">633</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Pre-valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">te_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="SensoryBase.crossval_setup-634"><a href="#SensoryBase.crossval_setup-634"><span class="linenos">634</span></a>
</span><span id="SensoryBase.crossval_setup-635"><a href="#SensoryBase.crossval_setup-635"><span class="linenos">635</span></a>        <span class="c1"># Finally intersect with used_inds</span>
</span><span id="SensoryBase.crossval_setup-636"><a href="#SensoryBase.crossval_setup-636"><span class="linenos">636</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SensoryBase.crossval_setup-637"><a href="#SensoryBase.crossval_setup-637"><span class="linenos">637</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="SensoryBase.crossval_setup-638"><a href="#SensoryBase.crossval_setup-638"><span class="linenos">638</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">val_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="SensoryBase.crossval_setup-639"><a href="#SensoryBase.crossval_setup-639"><span class="linenos">639</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">te_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="SensoryBase.crossval_setup-640"><a href="#SensoryBase.crossval_setup-640"><span class="linenos">640</span></a>
</span><span id="SensoryBase.crossval_setup-641"><a href="#SensoryBase.crossval_setup-641"><span class="linenos">641</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="SensoryBase.crossval_setup-642"><a href="#SensoryBase.crossval_setup-642"><span class="linenos">642</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="SensoryBase.crossval_setup-643"><a href="#SensoryBase.crossval_setup-643"><span class="linenos">643</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.crossval_setup-644"><a href="#SensoryBase.crossval_setup-644"><span class="linenos">644</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">tr_inds</span>
</span><span id="SensoryBase.crossval_setup-645"><a href="#SensoryBase.crossval_setup-645"><span class="linenos">645</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">val_inds</span>
</span><span id="SensoryBase.crossval_setup-646"><a href="#SensoryBase.crossval_setup-646"><span class="linenos">646</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">te_inds</span>
</span><span id="SensoryBase.crossval_setup-647"><a href="#SensoryBase.crossval_setup-647"><span class="linenos">647</span></a>            
</span><span id="SensoryBase.crossval_setup-648"><a href="#SensoryBase.crossval_setup-648"><span class="linenos">648</span></a>        <span class="c1"># make the inds and blks into numpy arrays</span>
</span><span id="SensoryBase.crossval_setup-649"><a href="#SensoryBase.crossval_setup-649"><span class="linenos">649</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">)</span>
</span><span id="SensoryBase.crossval_setup-650"><a href="#SensoryBase.crossval_setup-650"><span class="linenos">650</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">)</span>
</span><span id="SensoryBase.crossval_setup-651"><a href="#SensoryBase.crossval_setup-651"><span class="linenos">651</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span><span class="p">)</span>
</span><span id="SensoryBase.crossval_setup-652"><a href="#SensoryBase.crossval_setup-652"><span class="linenos">652</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">)</span>
</span><span id="SensoryBase.crossval_setup-653"><a href="#SensoryBase.crossval_setup-653"><span class="linenos">653</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">)</span>
</span><span id="SensoryBase.crossval_setup-654"><a href="#SensoryBase.crossval_setup-654"><span class="linenos">654</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This sets the cross-validation indices up We can add featuers here. Many ways to do this
but will stick to some standard for now. It sets the internal indices, which can be read out
directly or with helper functions. Perhaps helper_functions is the best way....</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>folds:</strong>  the number of folds to use</li>
<li><strong>random_gen:</strong>  whether to pick random fixations for validation or uniformly distributed</li>
<li><strong>test_set:</strong>  whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</li>
<li><strong>verbose:</strong>  whether to print out the number of fixations in each set</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: sets internal variables test_inds, train_inds, val_inds</p>
</blockquote>
</div>


                            </div>
                            <div id="SensoryBase.fold_sample" class="classattr">
                                        <input id="SensoryBase.fold_sample-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fold_sample</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">num_items</span>, </span><span class="param"><span class="n">folds</span>, </span><span class="param"><span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">which_fold</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.fold_sample-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.fold_sample"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.fold_sample-658"><a href="#SensoryBase.fold_sample-658"><span class="linenos">658</span></a>    <span class="k">def</span> <span class="nf">fold_sample</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">which_fold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="SensoryBase.fold_sample-659"><a href="#SensoryBase.fold_sample-659"><span class="linenos">659</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.fold_sample-660"><a href="#SensoryBase.fold_sample-660"><span class="linenos">660</span></a><span class="sd">        This really should be a general method not associated with self</span>
</span><span id="SensoryBase.fold_sample-661"><a href="#SensoryBase.fold_sample-661"><span class="linenos">661</span></a><span class="sd">        </span>
</span><span id="SensoryBase.fold_sample-662"><a href="#SensoryBase.fold_sample-662"><span class="linenos">662</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase.fold_sample-663"><a href="#SensoryBase.fold_sample-663"><span class="linenos">663</span></a><span class="sd">            num_items: the number of items to sample</span>
</span><span id="SensoryBase.fold_sample-664"><a href="#SensoryBase.fold_sample-664"><span class="linenos">664</span></a><span class="sd">            folds: the number of folds to use</span>
</span><span id="SensoryBase.fold_sample-665"><a href="#SensoryBase.fold_sample-665"><span class="linenos">665</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="SensoryBase.fold_sample-666"><a href="#SensoryBase.fold_sample-666"><span class="linenos">666</span></a><span class="sd">            which_fold: which fold to use</span>
</span><span id="SensoryBase.fold_sample-667"><a href="#SensoryBase.fold_sample-667"><span class="linenos">667</span></a>
</span><span id="SensoryBase.fold_sample-668"><a href="#SensoryBase.fold_sample-668"><span class="linenos">668</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase.fold_sample-669"><a href="#SensoryBase.fold_sample-669"><span class="linenos">669</span></a><span class="sd">            val_items: the validation items</span>
</span><span id="SensoryBase.fold_sample-670"><a href="#SensoryBase.fold_sample-670"><span class="linenos">670</span></a><span class="sd">            rem_items: the remaining items</span>
</span><span id="SensoryBase.fold_sample-671"><a href="#SensoryBase.fold_sample-671"><span class="linenos">671</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.fold_sample-672"><a href="#SensoryBase.fold_sample-672"><span class="linenos">672</span></a>        <span class="k">if</span> <span class="n">random_gen</span><span class="p">:</span>
</span><span id="SensoryBase.fold_sample-673"><a href="#SensoryBase.fold_sample-673"><span class="linenos">673</span></a>            <span class="n">num_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_items</span><span class="o">/</span><span class="n">folds</span><span class="p">)</span>
</span><span id="SensoryBase.fold_sample-674"><a href="#SensoryBase.fold_sample-674"><span class="linenos">674</span></a>            <span class="n">tmp_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">num_items</span><span class="p">)</span>
</span><span id="SensoryBase.fold_sample-675"><a href="#SensoryBase.fold_sample-675"><span class="linenos">675</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[:</span><span class="n">num_val</span><span class="p">])</span>
</span><span id="SensoryBase.fold_sample-676"><a href="#SensoryBase.fold_sample-676"><span class="linenos">676</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[</span><span class="n">num_val</span><span class="p">:])</span>
</span><span id="SensoryBase.fold_sample-677"><a href="#SensoryBase.fold_sample-677"><span class="linenos">677</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.fold_sample-678"><a href="#SensoryBase.fold_sample-678"><span class="linenos">678</span></a>            <span class="k">if</span> <span class="n">which_fold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase.fold_sample-679"><a href="#SensoryBase.fold_sample-679"><span class="linenos">679</span></a>                <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">folds</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="SensoryBase.fold_sample-680"><a href="#SensoryBase.fold_sample-680"><span class="linenos">680</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.fold_sample-681"><a href="#SensoryBase.fold_sample-681"><span class="linenos">681</span></a>                <span class="n">offset</span> <span class="o">=</span> <span class="n">which_fold</span><span class="o">%</span><span class="n">folds</span>
</span><span id="SensoryBase.fold_sample-682"><a href="#SensoryBase.fold_sample-682"><span class="linenos">682</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="SensoryBase.fold_sample-683"><a href="#SensoryBase.fold_sample-683"><span class="linenos">683</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">val_items</span><span class="p">)</span>
</span><span id="SensoryBase.fold_sample-684"><a href="#SensoryBase.fold_sample-684"><span class="linenos">684</span></a>        <span class="k">return</span> <span class="n">val_items</span><span class="p">,</span> <span class="n">rem_items</span>
</span></pre></div>


            <div class="docstring"><p>This really should be a general method not associated with self</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>num_items:</strong>  the number of items to sample</li>
<li><strong>folds:</strong>  the number of folds to use</li>
<li><strong>random_gen:</strong>  whether to pick random fixations for validation or uniformly distributed</li>
<li><strong>which_fold:</strong>  which fold to use</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>val_items: the validation items
  rem_items: the remaining items</p>
</blockquote>
</div>


                            </div>
                            <div id="SensoryBase.speckledXV_setup" class="classattr">
                                        <input id="SensoryBase.speckledXV_setup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">speckledXV_setup</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">folds</span><span class="o">=</span><span class="mi">5</span>, </span><span class="param"><span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.speckledXV_setup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.speckledXV_setup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.speckledXV_setup-686"><a href="#SensoryBase.speckledXV_setup-686"><span class="linenos">686</span></a>    <span class="k">def</span> <span class="nf">speckledXV_setup</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="SensoryBase.speckledXV_setup-687"><a href="#SensoryBase.speckledXV_setup-687"><span class="linenos">687</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.speckledXV_setup-688"><a href="#SensoryBase.speckledXV_setup-688"><span class="linenos">688</span></a><span class="sd">        Produce data-filter masks for training and XV speckles</span>
</span><span id="SensoryBase.speckledXV_setup-689"><a href="#SensoryBase.speckledXV_setup-689"><span class="linenos">689</span></a><span class="sd">        Will be produced for whole dataset, and must be reduced if cells_out used</span>
</span><span id="SensoryBase.speckledXV_setup-690"><a href="#SensoryBase.speckledXV_setup-690"><span class="linenos">690</span></a>
</span><span id="SensoryBase.speckledXV_setup-691"><a href="#SensoryBase.speckledXV_setup-691"><span class="linenos">691</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase.speckledXV_setup-692"><a href="#SensoryBase.speckledXV_setup-692"><span class="linenos">692</span></a><span class="sd">            folds: the number of folds to use</span>
</span><span id="SensoryBase.speckledXV_setup-693"><a href="#SensoryBase.speckledXV_setup-693"><span class="linenos">693</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="SensoryBase.speckledXV_setup-694"><a href="#SensoryBase.speckledXV_setup-694"><span class="linenos">694</span></a>
</span><span id="SensoryBase.speckledXV_setup-695"><a href="#SensoryBase.speckledXV_setup-695"><span class="linenos">695</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase.speckledXV_setup-696"><a href="#SensoryBase.speckledXV_setup-696"><span class="linenos">696</span></a><span class="sd">            None</span>
</span><span id="SensoryBase.speckledXV_setup-697"><a href="#SensoryBase.speckledXV_setup-697"><span class="linenos">697</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.speckledXV_setup-698"><a href="#SensoryBase.speckledXV_setup-698"><span class="linenos">698</span></a>        <span class="n">Ntr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="SensoryBase.speckledXV_setup-699"><a href="#SensoryBase.speckledXV_setup-699"><span class="linenos">699</span></a>
</span><span id="SensoryBase.speckledXV_setup-700"><a href="#SensoryBase.speckledXV_setup-700"><span class="linenos">700</span></a>        <span class="c1"># Choose trials to leave out for each unit</span>
</span><span id="SensoryBase.speckledXV_setup-701"><a href="#SensoryBase.speckledXV_setup-701"><span class="linenos">701</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Mval</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="SensoryBase.speckledXV_setup-702"><a href="#SensoryBase.speckledXV_setup-702"><span class="linenos">702</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="SensoryBase.speckledXV_setup-703"><a href="#SensoryBase.speckledXV_setup-703"><span class="linenos">703</span></a>        <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">):</span>
</span><span id="SensoryBase.speckledXV_setup-704"><a href="#SensoryBase.speckledXV_setup-704"><span class="linenos">704</span></a>            <span class="n">ival</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span> 
</span><span id="SensoryBase.speckledXV_setup-705"><a href="#SensoryBase.speckledXV_setup-705"><span class="linenos">705</span></a>                <span class="n">Ntr</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">,</span> <span class="n">which_fold</span><span class="o">=</span><span class="n">cc</span><span class="o">%</span><span class="n">folds</span><span class="p">)</span>
</span><span id="SensoryBase.speckledXV_setup-706"><a href="#SensoryBase.speckledXV_setup-706"><span class="linenos">706</span></a>            <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">ival</span><span class="p">:</span>
</span><span id="SensoryBase.speckledXV_setup-707"><a href="#SensoryBase.speckledXV_setup-707"><span class="linenos">707</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mval</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">tr</span><span class="p">],</span> <span class="n">cc</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="SensoryBase.speckledXV_setup-708"><a href="#SensoryBase.speckledXV_setup-708"><span class="linenos">708</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">tr</span><span class="p">],</span> <span class="n">cc</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="SensoryBase.speckledXV_setup-709"><a href="#SensoryBase.speckledXV_setup-709"><span class="linenos">709</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase.speckledXV_setup-710"><a href="#SensoryBase.speckledXV_setup-710"><span class="linenos">710</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">])</span>
</span><span id="SensoryBase.speckledXV_setup-711"><a href="#SensoryBase.speckledXV_setup-711"><span class="linenos">711</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Mval_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Mval</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Produce data-filter masks for training and XV speckles
Will be produced for whole dataset, and must be reduced if cells_out used</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>folds:</strong>  the number of folds to use</li>
<li><strong>random_gen:</strong>  whether to pick random fixations for validation or uniformly distributed</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="SensoryBase.set_speckledXV" class="classattr">
                                        <input id="SensoryBase.set_speckledXV-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_speckledXV</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">val</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">folds</span><span class="o">=</span><span class="mi">5</span>, </span><span class="param"><span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.set_speckledXV-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.set_speckledXV"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.set_speckledXV-714"><a href="#SensoryBase.set_speckledXV-714"><span class="linenos">714</span></a>    <span class="k">def</span> <span class="nf">set_speckledXV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="SensoryBase.set_speckledXV-715"><a href="#SensoryBase.set_speckledXV-715"><span class="linenos">715</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.set_speckledXV-716"><a href="#SensoryBase.set_speckledXV-716"><span class="linenos">716</span></a><span class="sd">        Set up speckled cross-validation with data-filter masks</span>
</span><span id="SensoryBase.set_speckledXV-717"><a href="#SensoryBase.set_speckledXV-717"><span class="linenos">717</span></a>
</span><span id="SensoryBase.set_speckledXV-718"><a href="#SensoryBase.set_speckledXV-718"><span class="linenos">718</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase.set_speckledXV-719"><a href="#SensoryBase.set_speckledXV-719"><span class="linenos">719</span></a><span class="sd">            val: whether to set up speckled cross-validation</span>
</span><span id="SensoryBase.set_speckledXV-720"><a href="#SensoryBase.set_speckledXV-720"><span class="linenos">720</span></a><span class="sd">            folds: the number of folds to use</span>
</span><span id="SensoryBase.set_speckledXV-721"><a href="#SensoryBase.set_speckledXV-721"><span class="linenos">721</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="SensoryBase.set_speckledXV-722"><a href="#SensoryBase.set_speckledXV-722"><span class="linenos">722</span></a>
</span><span id="SensoryBase.set_speckledXV-723"><a href="#SensoryBase.set_speckledXV-723"><span class="linenos">723</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase.set_speckledXV-724"><a href="#SensoryBase.set_speckledXV-724"><span class="linenos">724</span></a><span class="sd">            None</span>
</span><span id="SensoryBase.set_speckledXV-725"><a href="#SensoryBase.set_speckledXV-725"><span class="linenos">725</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.set_speckledXV-726"><a href="#SensoryBase.set_speckledXV-726"><span class="linenos">726</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">speckled</span> <span class="o">=</span> <span class="n">val</span>
</span><span id="SensoryBase.set_speckledXV-727"><a href="#SensoryBase.set_speckledXV-727"><span class="linenos">727</span></a>        <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
</span><span id="SensoryBase.set_speckledXV-728"><a href="#SensoryBase.set_speckledXV-728"><span class="linenos">728</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase.set_speckledXV-729"><a href="#SensoryBase.set_speckledXV-729"><span class="linenos">729</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">speckledXV_setup</span><span class="p">(</span><span class="n">folds</span><span class="o">=</span><span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span> 
</span><span id="SensoryBase.set_speckledXV-730"><a href="#SensoryBase.set_speckledXV-730"><span class="linenos">730</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SensoryBase.set_speckledXV-731"><a href="#SensoryBase.set_speckledXV-731"><span class="linenos">731</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mval_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mval</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="SensoryBase.set_speckledXV-732"><a href="#SensoryBase.set_speckledXV-732"><span class="linenos">732</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="SensoryBase.set_speckledXV-733"><a href="#SensoryBase.set_speckledXV-733"><span class="linenos">733</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.set_speckledXV-734"><a href="#SensoryBase.set_speckledXV-734"><span class="linenos">734</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mval_out</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SensoryBase.set_speckledXV-735"><a href="#SensoryBase.set_speckledXV-735"><span class="linenos">735</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Set up speckled cross-validation with data-filter masks</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>val:</strong>  whether to set up speckled cross-validation</li>
<li><strong>folds:</strong>  the number of folds to use</li>
<li><strong>random_gen:</strong>  whether to pick random fixations for validation or uniformly distributed</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="SensoryBase.make_data_dicts" class="classattr">
                                        <input id="SensoryBase.make_data_dicts-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">make_data_dicts</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">device</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="nb">all</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.make_data_dicts-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.make_data_dicts"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.make_data_dicts-738"><a href="#SensoryBase.make_data_dicts-738"><span class="linenos">738</span></a>    <span class="k">def</span> <span class="nf">make_data_dicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="SensoryBase.make_data_dicts-739"><a href="#SensoryBase.make_data_dicts-739"><span class="linenos">739</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.make_data_dicts-740"><a href="#SensoryBase.make_data_dicts-740"><span class="linenos">740</span></a><span class="sd">        Usage: train_ds, val_ds = dataset.make_data_dicts( device=None, all=False )</span>
</span><span id="SensoryBase.make_data_dicts-741"><a href="#SensoryBase.make_data_dicts-741"><span class="linenos">741</span></a><span class="sd">        </span>
</span><span id="SensoryBase.make_data_dicts-742"><a href="#SensoryBase.make_data_dicts-742"><span class="linenos">742</span></a><span class="sd">        Produce generic datasets on device of choice</span>
</span><span id="SensoryBase.make_data_dicts-743"><a href="#SensoryBase.make_data_dicts-743"><span class="linenos">743</span></a><span class="sd">        device defaults to cuda-0</span>
</span><span id="SensoryBase.make_data_dicts-744"><a href="#SensoryBase.make_data_dicts-744"><span class="linenos">744</span></a><span class="sd">        If &lt;all&gt; is True, then will make single dataset without XVal</span>
</span><span id="SensoryBase.make_data_dicts-745"><a href="#SensoryBase.make_data_dicts-745"><span class="linenos">745</span></a>
</span><span id="SensoryBase.make_data_dicts-746"><a href="#SensoryBase.make_data_dicts-746"><span class="linenos">746</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase.make_data_dicts-747"><a href="#SensoryBase.make_data_dicts-747"><span class="linenos">747</span></a><span class="sd">            device: the device to put the datasets on</span>
</span><span id="SensoryBase.make_data_dicts-748"><a href="#SensoryBase.make_data_dicts-748"><span class="linenos">748</span></a><span class="sd">            all: whether to use all data</span>
</span><span id="SensoryBase.make_data_dicts-749"><a href="#SensoryBase.make_data_dicts-749"><span class="linenos">749</span></a><span class="sd">        </span>
</span><span id="SensoryBase.make_data_dicts-750"><a href="#SensoryBase.make_data_dicts-750"><span class="linenos">750</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase.make_data_dicts-751"><a href="#SensoryBase.make_data_dicts-751"><span class="linenos">751</span></a><span class="sd">            train_ds: the training dataset</span>
</span><span id="SensoryBase.make_data_dicts-752"><a href="#SensoryBase.make_data_dicts-752"><span class="linenos">752</span></a><span class="sd">            val_ds: the validation dataset</span>
</span><span id="SensoryBase.make_data_dicts-753"><a href="#SensoryBase.make_data_dicts-753"><span class="linenos">753</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.make_data_dicts-754"><a href="#SensoryBase.make_data_dicts-754"><span class="linenos">754</span></a>        <span class="kn">from</span> <span class="nn">NTdatasets.generic</span> <span class="kn">import</span> <span class="n">GenericDataset</span>
</span><span id="SensoryBase.make_data_dicts-755"><a href="#SensoryBase.make_data_dicts-755"><span class="linenos">755</span></a>
</span><span id="SensoryBase.make_data_dicts-756"><a href="#SensoryBase.make_data_dicts-756"><span class="linenos">756</span></a>        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase.make_data_dicts-757"><a href="#SensoryBase.make_data_dicts-757"><span class="linenos">757</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Datasets will be on cuda:0&#39;</span><span class="p">)</span>
</span><span id="SensoryBase.make_data_dicts-758"><a href="#SensoryBase.make_data_dicts-758"><span class="linenos">758</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
</span><span id="SensoryBase.make_data_dicts-759"><a href="#SensoryBase.make_data_dicts-759"><span class="linenos">759</span></a>
</span><span id="SensoryBase.make_data_dicts-760"><a href="#SensoryBase.make_data_dicts-760"><span class="linenos">760</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speckled</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">:</span>
</span><span id="SensoryBase.make_data_dicts-761"><a href="#SensoryBase.make_data_dicts-761"><span class="linenos">761</span></a>            <span class="n">trn_inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</span><span id="SensoryBase.make_data_dicts-762"><a href="#SensoryBase.make_data_dicts-762"><span class="linenos">762</span></a>            <span class="n">val_inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</span><span id="SensoryBase.make_data_dicts-763"><a href="#SensoryBase.make_data_dicts-763"><span class="linenos">763</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.make_data_dicts-764"><a href="#SensoryBase.make_data_dicts-764"><span class="linenos">764</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_sample</span><span class="p">,</span> <span class="s2">&quot;trial-sample will not work with generic datasets&quot;</span>
</span><span id="SensoryBase.make_data_dicts-765"><a href="#SensoryBase.make_data_dicts-765"><span class="linenos">765</span></a>            <span class="n">trn_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span>
</span><span id="SensoryBase.make_data_dicts-766"><a href="#SensoryBase.make_data_dicts-766"><span class="linenos">766</span></a>            <span class="n">val_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span>
</span><span id="SensoryBase.make_data_dicts-767"><a href="#SensoryBase.make_data_dicts-767"><span class="linenos">767</span></a>
</span><span id="SensoryBase.make_data_dicts-768"><a href="#SensoryBase.make_data_dicts-768"><span class="linenos">768</span></a>        <span class="n">ks</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="SensoryBase.make_data_dicts-769"><a href="#SensoryBase.make_data_dicts-769"><span class="linenos">769</span></a>        <span class="n">dictTRN</span><span class="p">,</span> <span class="n">dictVAL</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
</span><span id="SensoryBase.make_data_dicts-770"><a href="#SensoryBase.make_data_dicts-770"><span class="linenos">770</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ks</span><span class="p">:</span>
</span><span id="SensoryBase.make_data_dicts-771"><a href="#SensoryBase.make_data_dicts-771"><span class="linenos">771</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">,</span> <span class="s1">&#39;Mtrn&#39;</span><span class="p">,</span> <span class="s1">&#39;Mval&#39;</span><span class="p">]):</span>
</span><span id="SensoryBase.make_data_dicts-772"><a href="#SensoryBase.make_data_dicts-772"><span class="linenos">772</span></a>                <span class="n">dictTRN</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">trn_inds</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>
</span><span id="SensoryBase.make_data_dicts-773"><a href="#SensoryBase.make_data_dicts-773"><span class="linenos">773</span></a>                <span class="n">dictVAL</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">val_inds</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>
</span><span id="SensoryBase.make_data_dicts-774"><a href="#SensoryBase.make_data_dicts-774"><span class="linenos">774</span></a>
</span><span id="SensoryBase.make_data_dicts-775"><a href="#SensoryBase.make_data_dicts-775"><span class="linenos">775</span></a>        <span class="k">if</span> <span class="nb">all</span><span class="p">:</span>
</span><span id="SensoryBase.make_data_dicts-776"><a href="#SensoryBase.make_data_dicts-776"><span class="linenos">776</span></a>            <span class="n">dictTRN</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:][</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span>
</span><span id="SensoryBase.make_data_dicts-777"><a href="#SensoryBase.make_data_dicts-777"><span class="linenos">777</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.make_data_dicts-778"><a href="#SensoryBase.make_data_dicts-778"><span class="linenos">778</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speckled</span><span class="p">:</span>
</span><span id="SensoryBase.make_data_dicts-779"><a href="#SensoryBase.make_data_dicts-779"><span class="linenos">779</span></a>                <span class="k">assert</span> <span class="p">(</span><span class="s1">&#39;Mtrn&#39;</span> <span class="ow">in</span> <span class="n">ks</span><span class="p">),</span> <span class="s2">&quot;speckled not set on dataset&quot;</span>
</span><span id="SensoryBase.make_data_dicts-780"><a href="#SensoryBase.make_data_dicts-780"><span class="linenos">780</span></a>                <span class="n">dictTRN</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:][</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[:][</span><span class="s1">&#39;Mtrn&#39;</span><span class="p">]</span>
</span><span id="SensoryBase.make_data_dicts-781"><a href="#SensoryBase.make_data_dicts-781"><span class="linenos">781</span></a>                <span class="n">dictVAL</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:][</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[:][</span><span class="s1">&#39;Mval&#39;</span><span class="p">]</span>
</span><span id="SensoryBase.make_data_dicts-782"><a href="#SensoryBase.make_data_dicts-782"><span class="linenos">782</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.make_data_dicts-783"><a href="#SensoryBase.make_data_dicts-783"><span class="linenos">783</span></a>                <span class="n">dictTRN</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">trn_inds</span><span class="p">][</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span>
</span><span id="SensoryBase.make_data_dicts-784"><a href="#SensoryBase.make_data_dicts-784"><span class="linenos">784</span></a>                <span class="n">dictVAL</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">val_inds</span><span class="p">][</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span>
</span><span id="SensoryBase.make_data_dicts-785"><a href="#SensoryBase.make_data_dicts-785"><span class="linenos">785</span></a>
</span><span id="SensoryBase.make_data_dicts-786"><a href="#SensoryBase.make_data_dicts-786"><span class="linenos">786</span></a>        <span class="n">train_ds</span> <span class="o">=</span> <span class="n">GenericDataset</span><span class="p">(</span> <span class="n">dictTRN</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span> <span class="p">)</span>
</span><span id="SensoryBase.make_data_dicts-787"><a href="#SensoryBase.make_data_dicts-787"><span class="linenos">787</span></a>        <span class="k">if</span> <span class="nb">all</span><span class="p">:</span>
</span><span id="SensoryBase.make_data_dicts-788"><a href="#SensoryBase.make_data_dicts-788"><span class="linenos">788</span></a>            <span class="k">return</span> <span class="n">train_ds</span>
</span><span id="SensoryBase.make_data_dicts-789"><a href="#SensoryBase.make_data_dicts-789"><span class="linenos">789</span></a>
</span><span id="SensoryBase.make_data_dicts-790"><a href="#SensoryBase.make_data_dicts-790"><span class="linenos">790</span></a>        <span class="n">val_ds</span> <span class="o">=</span> <span class="n">GenericDataset</span><span class="p">(</span> <span class="n">dictVAL</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span> <span class="p">)</span>
</span><span id="SensoryBase.make_data_dicts-791"><a href="#SensoryBase.make_data_dicts-791"><span class="linenos">791</span></a>        <span class="k">return</span> <span class="n">train_ds</span><span class="p">,</span> <span class="n">val_ds</span>
</span></pre></div>


            <div class="docstring"><p>Usage: train_ds, val_ds = dataset.make_data_dicts( device=None, all=False )</p>

<p>Produce generic datasets on device of choice
device defaults to cuda-0
If <all> is True, then will make single dataset without XVal</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>device:</strong>  the device to put the datasets on</li>
<li><strong>all:</strong>  whether to use all data</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>train_ds: the training dataset
  val_ds: the validation dataset</p>
</blockquote>
</div>


                            </div>
                            <div id="SensoryBase.get_max_samples" class="classattr">
                                        <input id="SensoryBase.get_max_samples-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_max_samples</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">gpu_n</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">history_size</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="n">nquad</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">buffer</span><span class="o">=</span><span class="mf">1.2</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.get_max_samples-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.get_max_samples"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.get_max_samples-794"><a href="#SensoryBase.get_max_samples-794"><span class="linenos">794</span></a>    <span class="k">def</span> <span class="nf">get_max_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpu_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nquad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mf">1.2</span><span class="p">):</span>
</span><span id="SensoryBase.get_max_samples-795"><a href="#SensoryBase.get_max_samples-795"><span class="linenos">795</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.get_max_samples-796"><a href="#SensoryBase.get_max_samples-796"><span class="linenos">796</span></a><span class="sd">        get the maximum number of samples that fit in memory -- for GLM/GQM x LBFGS</span>
</span><span id="SensoryBase.get_max_samples-797"><a href="#SensoryBase.get_max_samples-797"><span class="linenos">797</span></a>
</span><span id="SensoryBase.get_max_samples-798"><a href="#SensoryBase.get_max_samples-798"><span class="linenos">798</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase.get_max_samples-799"><a href="#SensoryBase.get_max_samples-799"><span class="linenos">799</span></a><span class="sd">            gpu_n: the gpu number to use</span>
</span><span id="SensoryBase.get_max_samples-800"><a href="#SensoryBase.get_max_samples-800"><span class="linenos">800</span></a><span class="sd">            history_size: the history size</span>
</span><span id="SensoryBase.get_max_samples-801"><a href="#SensoryBase.get_max_samples-801"><span class="linenos">801</span></a><span class="sd">            nquad: the number of quadrature points</span>
</span><span id="SensoryBase.get_max_samples-802"><a href="#SensoryBase.get_max_samples-802"><span class="linenos">802</span></a><span class="sd">            num_cells: the number of cells to use</span>
</span><span id="SensoryBase.get_max_samples-803"><a href="#SensoryBase.get_max_samples-803"><span class="linenos">803</span></a><span class="sd">            buffer: the buffer to use</span>
</span><span id="SensoryBase.get_max_samples-804"><a href="#SensoryBase.get_max_samples-804"><span class="linenos">804</span></a>
</span><span id="SensoryBase.get_max_samples-805"><a href="#SensoryBase.get_max_samples-805"><span class="linenos">805</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase.get_max_samples-806"><a href="#SensoryBase.get_max_samples-806"><span class="linenos">806</span></a><span class="sd">            maxsamples: the maximum number of samples that fit in memory</span>
</span><span id="SensoryBase.get_max_samples-807"><a href="#SensoryBase.get_max_samples-807"><span class="linenos">807</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.get_max_samples-808"><a href="#SensoryBase.get_max_samples-808"><span class="linenos">808</span></a>        <span class="k">if</span> <span class="n">gpu_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SensoryBase.get_max_samples-809"><a href="#SensoryBase.get_max_samples-809"><span class="linenos">809</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
</span><span id="SensoryBase.get_max_samples-810"><a href="#SensoryBase.get_max_samples-810"><span class="linenos">810</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.get_max_samples-811"><a href="#SensoryBase.get_max_samples-811"><span class="linenos">811</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:1&#39;</span><span class="p">)</span>
</span><span id="SensoryBase.get_max_samples-812"><a href="#SensoryBase.get_max_samples-812"><span class="linenos">812</span></a>
</span><span id="SensoryBase.get_max_samples-813"><a href="#SensoryBase.get_max_samples-813"><span class="linenos">813</span></a>        <span class="k">if</span> <span class="n">num_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase.get_max_samples-814"><a href="#SensoryBase.get_max_samples-814"><span class="linenos">814</span></a>            <span class="n">num_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span>
</span><span id="SensoryBase.get_max_samples-815"><a href="#SensoryBase.get_max_samples-815"><span class="linenos">815</span></a>        
</span><span id="SensoryBase.get_max_samples-816"><a href="#SensoryBase.get_max_samples-816"><span class="linenos">816</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">total_memory</span>
</span><span id="SensoryBase.get_max_samples-817"><a href="#SensoryBase.get_max_samples-817"><span class="linenos">817</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_reserved</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="SensoryBase.get_max_samples-818"><a href="#SensoryBase.get_max_samples-818"><span class="linenos">818</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_allocated</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="SensoryBase.get_max_samples-819"><a href="#SensoryBase.get_max_samples-819"><span class="linenos">819</span></a>        <span class="n">free</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">r</span><span class="p">)</span>
</span><span id="SensoryBase.get_max_samples-820"><a href="#SensoryBase.get_max_samples-820"><span class="linenos">820</span></a>
</span><span id="SensoryBase.get_max_samples-821"><a href="#SensoryBase.get_max_samples-821"><span class="linenos">821</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SensoryBase.get_max_samples-822"><a href="#SensoryBase.get_max_samples-822"><span class="linenos">822</span></a>        <span class="n">mempersample</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span>
</span><span id="SensoryBase.get_max_samples-823"><a href="#SensoryBase.get_max_samples-823"><span class="linenos">823</span></a>    
</span><span id="SensoryBase.get_max_samples-824"><a href="#SensoryBase.get_max_samples-824"><span class="linenos">824</span></a>        <span class="n">mempercell</span> <span class="o">=</span> <span class="n">mempersample</span> <span class="o">*</span> <span class="p">(</span><span class="n">nquad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">history_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SensoryBase.get_max_samples-825"><a href="#SensoryBase.get_max_samples-825"><span class="linenos">825</span></a>        <span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">*</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span>
</span><span id="SensoryBase.get_max_samples-826"><a href="#SensoryBase.get_max_samples-826"><span class="linenos">826</span></a>
</span><span id="SensoryBase.get_max_samples-827"><a href="#SensoryBase.get_max_samples-827"><span class="linenos">827</span></a>        <span class="n">maxsamples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">free</span> <span class="o">-</span> <span class="n">mempercell</span><span class="o">*</span><span class="n">num_cells</span> <span class="o">-</span> <span class="n">buffer_bytes</span><span class="p">)</span> <span class="o">//</span> <span class="n">mempersample</span>
</span><span id="SensoryBase.get_max_samples-828"><a href="#SensoryBase.get_max_samples-828"><span class="linenos">828</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# samples that can fit on device: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxsamples</span><span class="p">))</span>
</span><span id="SensoryBase.get_max_samples-829"><a href="#SensoryBase.get_max_samples-829"><span class="linenos">829</span></a>        <span class="k">return</span> <span class="n">maxsamples</span>
</span></pre></div>


            <div class="docstring"><p>get the maximum number of samples that fit in memory -- for GLM/GQM x LBFGS</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>gpu_n:</strong>  the gpu number to use</li>
<li><strong>history_size:</strong>  the history size</li>
<li><strong>nquad:</strong>  the number of quadrature points</li>
<li><strong>num_cells:</strong>  the number of cells to use</li>
<li><strong>buffer:</strong>  the buffer to use</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>maxsamples: the maximum number of samples that fit in memory</p>
</blockquote>
</div>


                            </div>
                            <div id="SensoryBase.assemble_stimulus" class="classattr">
                                        <input id="SensoryBase.assemble_stimulus-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">assemble_stimulus</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.assemble_stimulus-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.assemble_stimulus"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.assemble_stimulus-832"><a href="#SensoryBase.assemble_stimulus-832"><span class="linenos">832</span></a>    <span class="k">def</span> <span class="nf">assemble_stimulus</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">):</span>
</span><span id="SensoryBase.assemble_stimulus-833"><a href="#SensoryBase.assemble_stimulus-833"><span class="linenos">833</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.assemble_stimulus-834"><a href="#SensoryBase.assemble_stimulus-834"><span class="linenos">834</span></a><span class="sd">        This function is meant to be overloaded by child classes</span>
</span><span id="SensoryBase.assemble_stimulus-835"><a href="#SensoryBase.assemble_stimulus-835"><span class="linenos">835</span></a>
</span><span id="SensoryBase.assemble_stimulus-836"><a href="#SensoryBase.assemble_stimulus-836"><span class="linenos">836</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase.assemble_stimulus-837"><a href="#SensoryBase.assemble_stimulus-837"><span class="linenos">837</span></a><span class="sd">            None</span>
</span><span id="SensoryBase.assemble_stimulus-838"><a href="#SensoryBase.assemble_stimulus-838"><span class="linenos">838</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.assemble_stimulus-839"><a href="#SensoryBase.assemble_stimulus-839"><span class="linenos">839</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SensoryBase: assemble_stimulus not implemented in class child.&quot;</span><span class="p">)</span>
</span><span id="SensoryBase.assemble_stimulus-840"><a href="#SensoryBase.assemble_stimulus-840"><span class="linenos">840</span></a>        <span class="k">return</span>
</span></pre></div>


            <div class="docstring"><p>This function is meant to be overloaded by child classes</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="SensoryBase.is_int" class="classattr">
                                        <input id="SensoryBase.is_int-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">is_int</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">val</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.is_int-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.is_int"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.is_int-848"><a href="#SensoryBase.is_int-848"><span class="linenos">848</span></a>    <span class="nd">@staticmethod</span>
</span><span id="SensoryBase.is_int-849"><a href="#SensoryBase.is_int-849"><span class="linenos">849</span></a>    <span class="k">def</span> <span class="nf">is_int</span><span class="p">(</span> <span class="n">val</span> <span class="p">):</span>
</span><span id="SensoryBase.is_int-850"><a href="#SensoryBase.is_int-850"><span class="linenos">850</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.is_int-851"><a href="#SensoryBase.is_int-851"><span class="linenos">851</span></a><span class="sd">        Returns a boolean as to whether val is one of many types of integers</span>
</span><span id="SensoryBase.is_int-852"><a href="#SensoryBase.is_int-852"><span class="linenos">852</span></a>
</span><span id="SensoryBase.is_int-853"><a href="#SensoryBase.is_int-853"><span class="linenos">853</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase.is_int-854"><a href="#SensoryBase.is_int-854"><span class="linenos">854</span></a><span class="sd">            True if val is an integer, False otherwise</span>
</span><span id="SensoryBase.is_int-855"><a href="#SensoryBase.is_int-855"><span class="linenos">855</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.is_int-856"><a href="#SensoryBase.is_int-856"><span class="linenos">856</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> \
</span><span id="SensoryBase.is_int-857"><a href="#SensoryBase.is_int-857"><span class="linenos">857</span></a>            <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="ow">or</span> \
</span><span id="SensoryBase.is_int-858"><a href="#SensoryBase.is_int-858"><span class="linenos">858</span></a>            <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
</span><span id="SensoryBase.is_int-859"><a href="#SensoryBase.is_int-859"><span class="linenos">859</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="SensoryBase.is_int-860"><a href="#SensoryBase.is_int-860"><span class="linenos">860</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SensoryBase.is_int-861"><a href="#SensoryBase.is_int-861"><span class="linenos">861</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Returns a boolean as to whether val is one of many types of integers</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>True if val is an integer, False otherwise</p>
</blockquote>
</div>


                            </div>
                            <div id="SensoryBase.index_to_array" class="classattr">
                                        <input id="SensoryBase.index_to_array-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">index_to_array</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">index</span>, </span><span class="param"><span class="n">max_val</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SensoryBase.index_to_array-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SensoryBase.index_to_array"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SensoryBase.index_to_array-863"><a href="#SensoryBase.index_to_array-863"><span class="linenos">863</span></a>    <span class="nd">@staticmethod</span>
</span><span id="SensoryBase.index_to_array-864"><a href="#SensoryBase.index_to_array-864"><span class="linenos">864</span></a>    <span class="k">def</span> <span class="nf">index_to_array</span><span class="p">(</span> <span class="n">index</span><span class="p">,</span> <span class="n">max_val</span> <span class="p">):</span>
</span><span id="SensoryBase.index_to_array-865"><a href="#SensoryBase.index_to_array-865"><span class="linenos">865</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SensoryBase.index_to_array-866"><a href="#SensoryBase.index_to_array-866"><span class="linenos">866</span></a><span class="sd">        This converts any for index to dataset, including slices, and plain ints, into numpy array</span>
</span><span id="SensoryBase.index_to_array-867"><a href="#SensoryBase.index_to_array-867"><span class="linenos">867</span></a>
</span><span id="SensoryBase.index_to_array-868"><a href="#SensoryBase.index_to_array-868"><span class="linenos">868</span></a><span class="sd">        Args:</span>
</span><span id="SensoryBase.index_to_array-869"><a href="#SensoryBase.index_to_array-869"><span class="linenos">869</span></a><span class="sd">            index: the index to convert</span>
</span><span id="SensoryBase.index_to_array-870"><a href="#SensoryBase.index_to_array-870"><span class="linenos">870</span></a><span class="sd">            max_val: the maximum value to use</span>
</span><span id="SensoryBase.index_to_array-871"><a href="#SensoryBase.index_to_array-871"><span class="linenos">871</span></a>
</span><span id="SensoryBase.index_to_array-872"><a href="#SensoryBase.index_to_array-872"><span class="linenos">872</span></a><span class="sd">        Returns:</span>
</span><span id="SensoryBase.index_to_array-873"><a href="#SensoryBase.index_to_array-873"><span class="linenos">873</span></a><span class="sd">            index: the converted index</span>
</span><span id="SensoryBase.index_to_array-874"><a href="#SensoryBase.index_to_array-874"><span class="linenos">874</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SensoryBase.index_to_array-875"><a href="#SensoryBase.index_to_array-875"><span class="linenos">875</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
</span><span id="SensoryBase.index_to_array-876"><a href="#SensoryBase.index_to_array-876"><span class="linenos">876</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">start</span>
</span><span id="SensoryBase.index_to_array-877"><a href="#SensoryBase.index_to_array-877"><span class="linenos">877</span></a>            <span class="n">stop</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">stop</span>
</span><span id="SensoryBase.index_to_array-878"><a href="#SensoryBase.index_to_array-878"><span class="linenos">878</span></a>            <span class="n">step</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">step</span>
</span><span id="SensoryBase.index_to_array-879"><a href="#SensoryBase.index_to_array-879"><span class="linenos">879</span></a>            <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase.index_to_array-880"><a href="#SensoryBase.index_to_array-880"><span class="linenos">880</span></a>                <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SensoryBase.index_to_array-881"><a href="#SensoryBase.index_to_array-881"><span class="linenos">881</span></a>            <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase.index_to_array-882"><a href="#SensoryBase.index_to_array-882"><span class="linenos">882</span></a>                <span class="n">stop</span> <span class="o">=</span> <span class="n">max_val</span>
</span><span id="SensoryBase.index_to_array-883"><a href="#SensoryBase.index_to_array-883"><span class="linenos">883</span></a>            <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SensoryBase.index_to_array-884"><a href="#SensoryBase.index_to_array-884"><span class="linenos">884</span></a>                <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="SensoryBase.index_to_array-885"><a href="#SensoryBase.index_to_array-885"><span class="linenos">885</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</span><span id="SensoryBase.index_to_array-886"><a href="#SensoryBase.index_to_array-886"><span class="linenos">886</span></a>        <span class="k">elif</span> <span class="n">SensoryBase</span><span class="o">.</span><span class="n">is_int</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
</span><span id="SensoryBase.index_to_array-887"><a href="#SensoryBase.index_to_array-887"><span class="linenos">887</span></a>            <span class="k">return</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="SensoryBase.index_to_array-888"><a href="#SensoryBase.index_to_array-888"><span class="linenos">888</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="SensoryBase.index_to_array-889"><a href="#SensoryBase.index_to_array-889"><span class="linenos">889</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="SensoryBase.index_to_array-890"><a href="#SensoryBase.index_to_array-890"><span class="linenos">890</span></a>        <span class="k">return</span> <span class="n">index</span>
</span></pre></div>


            <div class="docstring"><p>This converts any for index to dataset, including slices, and plain ints, into numpy array</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>index:</strong>  the index to convert</li>
<li><strong>max_val:</strong>  the maximum value to use</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>index: the converted index</p>
</blockquote>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>
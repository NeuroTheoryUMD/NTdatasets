<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.6.0"/>
    <title>NTdatasets.conway.bar1d_datasets API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../conway.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;NTdatasets.conway</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#BarET">BarET</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#BarET.__init__">BarET</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.eye_config">eye_config</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.stim_gap">stim_gap</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.fhandles">fhandles</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.dfs_orig">dfs_orig</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.avRs">avRs</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.stim_location">stim_location</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.stim_locationET">stim_locationET</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.fix_location">fix_location</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.probeIDs">probeIDs</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.probeIDsMU">probeIDsMU</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.dt">dt</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.pixel_size">pixel_size</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.exptdate">exptdate</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.channel_mapSU">channel_mapSU</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.channel_mapMU">channel_mapMU</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.channel_map">channel_map</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.fix_n">fix_n</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.data_threshold">data_threshold</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.file_index">file_index</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.sacc_inds">sacc_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.generate_Xfix">generate_Xfix</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.num_blks">num_blks</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.with_shifter">with_shifter</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.shifts">shifts</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.stimname">stimname</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.ETtraceHR">ETtraceHR</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.NT">NT</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.used_inds">used_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.sort_rating">sort_rating</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.sort_ratingMU">sort_ratingMU</a>
                        </li>
                        <li>
                                <a class="variable" href="#BarET.Xdrift">Xdrift</a>
                        </li>
                        <li>
                                <a class="function" href="#BarET.preload_numpy">preload_numpy</a>
                        </li>
                        <li>
                                <a class="function" href="#BarET.assemble_stimulus">assemble_stimulus</a>
                        </li>
                        <li>
                                <a class="function" href="#BarET.to_tensor">to_tensor</a>
                        </li>
                        <li>
                                <a class="function" href="#BarET.process_fixations">process_fixations</a>
                        </li>
                        <li>
                                <a class="function" href="#BarET.add_shifter">add_shifter</a>
                        </li>
                        <li>
                                <a class="function" href="#BarET.avrates">avrates</a>
                        </li>
                        <li>
                                <a class="function" href="#BarET.apply_data_mask">apply_data_mask</a>
                        </li>
                        <li>
                                <a class="function" href="#BarET.data_mask_revert">data_mask_revert</a>
                        </li>
                        <li>
                                <a class="function" href="#BarET.shift_stim_fixation">shift_stim_fixation</a>
                        </li>
                        <li>
                                <a class="function" href="#BarET.create_valid_indices">create_valid_indices</a>
                        </li>
                        <li>
                                <a class="function" href="#BarET.crossval_setup">crossval_setup</a>
                        </li>
                        <li>
                                <a class="function" href="#BarET.fold_sample">fold_sample</a>
                        </li>
                        <li>
                                <a class="function" href="#BarET.adjust_Xdrift_xval">adjust_Xdrift_xval</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Bar1Dv7">Bar1Dv7</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Bar1Dv7.__init__">Bar1Dv7</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.datadir">datadir</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.sess_list">sess_list</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.device">device</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.num_lags">num_lags</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.time_embed">time_embed</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.preload">preload</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.stim_crop">stim_crop</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.folded_lags">folded_lags</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.combine_stim">combine_stim</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.eye_config">eye_config</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.stim_gap">stim_gap</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.stimHshift">stimHshift</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.Hdiscardzero">Hdiscardzero</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.drift_interval">drift_interval</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.fhandles">fhandles</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.dfs_orig">dfs_orig</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.ETstim_location">ETstim_location</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.stim_location">stim_location</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.fix_location">fix_location</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.probeIDs">probeIDs</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.probeIDsMU">probeIDsMU</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.dt">dt</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.pixel_size">pixel_size</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.exptdate">exptdate</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.data_threshold">data_threshold</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.file_index">file_index</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.sacc_inds">sacc_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.sus">sus</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.NC">NC</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.eyepos">eyepos</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.generate_Xfix">generate_Xfix</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.num_blks">num_blks</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.block_inds">block_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.block_filemapping">block_filemapping</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.include_MUs">include_MUs</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.SUinds">SUinds</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.MUinds">MUinds</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.cells_out">cells_out</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.avRs">avRs</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.with_shifter">with_shifter</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.shifts">shifts</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.test_inds">test_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.val_inds">val_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.train_inds">train_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.fix_n">fix_n</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.used_inds">used_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.stimname">stimname</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.ETtraceHR">ETtraceHR</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.NT">NT</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.sort_rating">sort_rating</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1Dv7.sort_ratingMU">sort_ratingMU</a>
                        </li>
                        <li>
                                <a class="function" href="#Bar1Dv7.preload_numpy">preload_numpy</a>
                        </li>
                        <li>
                                <a class="function" href="#Bar1Dv7.to_tensor">to_tensor</a>
                        </li>
                        <li>
                                <a class="function" href="#Bar1Dv7.process_fixations">process_fixations</a>
                        </li>
                        <li>
                                <a class="function" href="#Bar1Dv7.add_shifter">add_shifter</a>
                        </li>
                        <li>
                                <a class="function" href="#Bar1Dv7.avrates">avrates</a>
                        </li>
                        <li>
                                <a class="function" href="#Bar1Dv7.apply_data_mask">apply_data_mask</a>
                        </li>
                        <li>
                                <a class="function" href="#Bar1Dv7.data_mask_revert">data_mask_revert</a>
                        </li>
                        <li>
                                <a class="function" href="#Bar1Dv7.shift_stim_fixation">shift_stim_fixation</a>
                        </li>
                        <li>
                                <a class="function" href="#Bar1Dv7.create_valid_indices">create_valid_indices</a>
                        </li>
                        <li>
                                <a class="function" href="#Bar1Dv7.crossval_setup">crossval_setup</a>
                        </li>
                        <li>
                                <a class="function" href="#Bar1Dv7.fold_sample">fold_sample</a>
                        </li>
                        <li>
                                <a class="function" href="#Bar1Dv7.adjust_Xdrift_xval">adjust_Xdrift_xval</a>
                        </li>
                        <li>
                                <a class="function" href="#Bar1Dv7.get_max_samples">get_max_samples</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../NTdatasets.html">NTdatasets</a><wbr>.<a href="./../conway.html">conway</a><wbr>.bar1d_datasets    </h1>

                
                        <input id="mod-bar1d_datasets-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-bar1d_datasets-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">sio</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">import</span> <span class="nn">NDNT.utils</span> <span class="k">as</span> <span class="nn">utils</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="c1">#from NDNT.utils import download_file, ensure_dir</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="kn">import</span> <span class="nn">h5py</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">from</span> <span class="nn">NTdatasets.sensory_base</span> <span class="kn">import</span> <span class="n">SensoryBase</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="k">class</span> <span class="nc">BarET</span><span class="p">(</span><span class="n">SensoryBase</span><span class="p">):</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="sd">    -- can load batches from multiple datasets</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="sd">    -- hdf5 files must have the following information:</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="sd">        Robs</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="sd">        RobsMU</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="sd">        stim: 4-d stimulus: time x nx x ny x color</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="sd">        block_inds: start and stop of &#39;trials&#39; (perhaps fixations for now)</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="sd">        other things: saccades? or should that be in trials? </span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="sd">    Constructor will take eye position, which for now is an input from data</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="sd">    generated in the session (not on disk). It should have the length size </span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="sd">    of the total number of fixations x1.</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a>        <span class="n">filenames</span><span class="p">,</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>        <span class="n">datadir</span><span class="p">,</span> 
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a>        <span class="n">include_MUs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>        <span class="c1"># Stim setup -- have option to assemble or could leave blank</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a>        <span class="n">time_embed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a>        <span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a>        <span class="c1"># Dataset-specitic inputs</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>        <span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a>        <span class="n">Hstim_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># to shift-and-wrap stimH stimulus</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a>        <span class="n">Hdiscardzero</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a>        <span class="c1"># Stim configuation</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>        <span class="n">combine_stim</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># if False, horizontal stim will be &#39;stim&#39;</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a>        <span class="n">stim_gap</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a>        <span class="n">drift_interval</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>  <span class="c1"># how many trials to anchor each drift term</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>        <span class="c1"># eye configuration</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>        <span class="n">eye_config</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># 0 = all, 1, 2, and 3 are options (3 = binocular)</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>        <span class="n">binocular</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># whether to include separate filters for each eye</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>        <span class="c1"># other</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a>        <span class="c1">#ignore_saccades=True,</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">),</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>        <span class="n">maxT</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="sd">        Constructor options</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="sd">        </span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="sd">        Args:</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="sd">            filenames: list of strings of hdf5 files</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="sd">            datadir: directory where files are stored</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="sd">            include_MUs: whether to include multi-units</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="sd">            time_embed: 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="sd">            num_lags: number of lags to include in time-embedding</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="sd">            stim_crop: whether to crop stimulus (not implemented)</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="sd">            Hstim_shift: how much to shift horizontal stimulus (in bars)</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="sd">            Hdiscardzero: whether to discard zero position in horizontal stimulus</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a><span class="sd">            combine_stim: whether to combine horizontal and vertical stimulus</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="sd">            stim_gap: gap between horizontal and vertical stimulus</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a><span class="sd">            drift_interval: how many trials to anchor each drift term</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a><span class="sd">            eye_config: 0 = all, 1, 2, and 3 are options (3 = binocular)</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="sd">            binocular: whether to include separate filters for each eye</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a><span class="sd">            device: torch device</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="sd">            maxT: maximum time points to load (for debugging)</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>            <span class="n">filenames</span><span class="o">=</span><span class="n">filenames</span><span class="p">,</span> <span class="n">datadir</span><span class="o">=</span><span class="n">datadir</span><span class="p">,</span> 
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>            <span class="n">time_embed</span><span class="o">=</span><span class="n">time_embed</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">num_lags</span><span class="p">,</span> 
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>            <span class="n">include_MUs</span><span class="o">=</span><span class="n">include_MUs</span><span class="p">,</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>            <span class="n">drift_interval</span><span class="o">=</span><span class="n">drift_interval</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>        <span class="c1"># Done in constructor</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>        <span class="c1">#self.datadir = datadir</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>        <span class="c1">#self.filenames = filenames</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>        <span class="c1">#self.device = device</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>        <span class="c1">#self.num_lags = 10  # default: to be set later</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>        <span class="c1">#self.time_embed = time_embed</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>        <span class="c1">#self.used_inds = []</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>        <span class="c1">#self.NT = 0</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>        <span class="c1"># Stim-specific</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">=</span> <span class="n">eye_config</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_gap</span> <span class="o">=</span> <span class="n">stim_gap</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>        <span class="c1"># get hdf5 file handles</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">sess</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>        <span class="c1"># Data to just read in and store</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;stim_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_locationET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ETstim_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;fix_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probeIDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Robs_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probeIDsMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;RobsMU_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dt&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;pixel_size&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exptdate</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># need to learn matlab strings in HDF5 format (not saved as HDF5 string)</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapSU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Robs_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;RobsMU_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">channel_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_mapSU</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapMU</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>        <span class="c1">#self.stim = []</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>        <span class="c1">#self.dfs = []</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>        <span class="c1">#self.robs = []</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>        <span class="c1">#self.NT = 0</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>        <span class="c1"># Add additional stimuli for processing</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimHout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimVout</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dimsH</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dimsV</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>        <span class="c1"># build index map</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_threshold</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># how many valid time points required to include saccade?</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_index</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># which file the block corresponds to</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>        <span class="c1">#self.unit_ids = []</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>        <span class="c1">#self.num_units, self.num_sus, self.num_mus = [], [], []</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>        <span class="c1">#self.sus = []</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>        <span class="c1">#self.NC = 0</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>        <span class="c1">#self.stim_dims = None</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>        <span class="c1">#self.eyepos = eyepos</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_Xfix</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>        <span class="c1">#self.block_inds = []</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>        <span class="c1">#self.block_filemapping = []</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>        <span class="c1">#self.include_MUs = include_MUs</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>        <span class="c1">#self.SUinds = []</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>        <span class="c1">#self.MUinds = []</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>        <span class="c1">#self.cells_out = []  # can be list to output specific cells in get_item</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>        <span class="c1"># Set up to store default train_, val_, test_inds</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>        <span class="c1">#self.test_inds = None</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>        <span class="c1">#self.val_inds = None</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>        <span class="c1">#self.train_inds = None</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>        <span class="n">tcount</span><span class="p">,</span> <span class="n">fix_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span> <span class="o">=</span> <span class="s1">&#39;stimET&#39;</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ETtraceHR</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>        <span class="k">for</span> <span class="n">fnum</span><span class="p">,</span> <span class="n">fhandle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">):</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>            <span class="n">NT</span><span class="p">,</span> <span class="n">NSUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>            <span class="n">NX</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>            <span class="n">NMUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_SUs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NSUfile</span><span class="p">)</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_MUs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NMUfile</span><span class="p">)</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="o">+</span><span class="n">NSUfile</span><span class="p">))</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;block_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>            <span class="n">stim_eyes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useLeye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span>  \
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>                            <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>            
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>            <span class="n">Reye</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">]</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>            <span class="n">NCfile</span> <span class="o">=</span> <span class="n">NSUfile</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>                <span class="n">NCfile</span> <span class="o">+=</span> <span class="n">NMUfile</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>            
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>            <span class="c1"># This will associate each block with each file</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_filemapping</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="n">fnum</span><span class="p">)</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span><span class="p">[</span><span class="n">fnum</span><span class="p">]</span><span class="o">=</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span><span class="p">[</span><span class="n">fnum</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>            <span class="c1">#if self.stim_dims is None:</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>            <span class="c1">#if folded_lags:</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">([</span><span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="c1">#list(fhandle[stimname].shape[1:4]) + [1]</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>          
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>            <span class="c1">#if self.time_embed &gt; 0:</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>            <span class="c1">#    self.dims[3] = self.num_lags</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stim check:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>            <span class="c1">#self.unit_ids.append(self.NC + np.asarray(range(NCfile)))</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NCfile</span><span class="p">)</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">+=</span> <span class="n">NCfile</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;sacc_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>            <span class="c1">#fix_n = np.zeros(NT, dtype=np.int64)  # each time point labels fixation number</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>            <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;valid_data&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>  <span class="c1">#range(self.NT)  # default -- to be changed at end of init</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>            <span class="c1">### Process blocks and fixations/saccades</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>                <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>                <span class="n">include_block</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>                <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">stim_eyes</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>                        <span class="n">include_block</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>                <span class="k">if</span> <span class="n">include_block</span><span class="p">:</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>            
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>            <span class="n">tcount</span> <span class="o">+=</span> <span class="n">NT</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>            <span class="c1"># make larger fix_n, valid_inds, sacc_inds, block_inds as self</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>  <span class="o">=</span> <span class="n">tcount</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>        <span class="c1"># For now let&#39;s just debug with one file</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: currently ignoring multiple files&#39;</span><span class="p">)</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">valid_inds</span><span class="p">)</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>        
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>        <span class="c1"># PULL OTHER INFO</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ETtraceHR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;ETtrace_raw&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sort_rating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs_rating&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sort_ratingMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU_rating&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>        <span class="c1"># Go through saccades to establish val_indices and produce saccade timing vector </span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>        <span class="c1">#print(&quot;Loading data into memory...&quot;)</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preload_numpy</span><span class="p">()</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>        <span class="c1"># Have data_filters represend used_inds (in case it gets through)</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>        <span class="n">unified_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>        <span class="n">unified_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*=</span> <span class="n">unified_df</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>        <span class="c1"># Prepare design matrix for drift (on trial-by-trial basis)</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>        <span class="c1">#self.Xdrift = np.zeros([self.NT, len(self.block_inds)//], dtype=np.float32)</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>        <span class="c1">#for nn in range(len(self.block_inds)):</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>        <span class="c1">#    self.Xdrift[self.block_inds[nn], nn] = 1.0</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>        <span class="n">NBL</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>        <span class="n">Nanchors</span> <span class="o">=</span> <span class="n">NBL</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>        <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>        <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">):</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>            <span class="n">anchors</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span><span class="o">*</span><span class="n">bb</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">process_fixations</span><span class="p">()</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>        <span class="c1"># Convert data to tensors</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>        <span class="c1">#if self.device is not None:</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>        <span class="c1"># Create valid indices and first pass of cross-validation indices</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>        <span class="c1">#self.create_valid_indices()</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>        <span class="c1"># Develop default train, validation, and test datasets </span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crossval_setup</span><span class="p">()</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>        <span class="c1"># Fix Xdrift to remove test and validation sets</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>        <span class="c1">#self.adjust_Xdrift_xval()</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>        <span class="k">if</span> <span class="n">time_embed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># then call assemble_stimulus in the constructor</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">assemble_stimulus</span><span class="p">(</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>                <span class="n">combine_stim</span><span class="o">=</span><span class="n">combine_stim</span><span class="p">,</span> <span class="n">stim_crop</span><span class="o">=</span><span class="n">stim_crop</span><span class="p">,</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>                <span class="n">time_embed</span><span class="o">=</span><span class="n">time_embed</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">num_lags</span><span class="p">,</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>                <span class="n">Hshift</span><span class="o">=</span><span class="n">Hstim_shift</span><span class="p">,</span> <span class="n">Hdiscardzero</span><span class="o">=</span><span class="n">Hdiscardzero</span><span class="p">)</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>        <span class="c1"># Otherwise leave for the future</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>        <span class="c1"># Reflects block structure</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>        <span class="c1">#vblks, trblks = self.fold_sample(len(self.block_inds), 5, random_gen=True)</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>        <span class="c1">#self.train_inds = []</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>        <span class="c1">#for nn in trblks:</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>        <span class="c1">#    self.train_inds += list(deepcopy(self.block_inds[nn]))</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>        <span class="c1">#self.val_inds = []</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>        <span class="c1">#for nn in vblks:</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>        <span class="c1">#    self.val_inds += list(deepcopy(self.block_inds[nn]))</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>        <span class="c1">#self.train_inds = np.array(self.train_inds, dtype=np.int64)</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>        <span class="c1">#self.val_inds = np.array(self.val_inds, dtype=np.int64)</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>    <span class="c1"># END ColorClouds.__init__</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>    <span class="k">def</span> <span class="nf">preload_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a><span class="sd">        Note this loads stimulus but does not time-embed</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a><span class="sd">        </span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a><span class="sd">        Args:</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a><span class="sd">            None</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a><span class="sd">        Returns:</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a><span class="sd">            None: loads into self.stim, self.robs, self.dfs, self.fix_n, self.Xdrift</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>        <span class="n">NX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>        <span class="n">NX2</span> <span class="o">=</span> <span class="n">NX</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_gap</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a><span class="sd">        Pre-allocate memory for data</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>        <span class="c1">#self.eyepos = np.zeros([NT, 2], dtype=np.float32)</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>        <span class="c1">#self.frame_times = np.zeros([NT,1], dtype=np.float32)</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>        <span class="n">t_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>        <span class="n">unit_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">)):</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>            
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>            <span class="n">fhandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>            <span class="n">sz</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_counter</span><span class="p">,</span> <span class="n">t_counter</span><span class="o">+</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>            <span class="c1">#inds = self.stim_indices[expt][stim][&#39;inds&#39;]</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>            <span class="c1">#self.stim[inds, ...] = np.transpose( np.array(fhandle[self.stimname], dtype=np.float32), axes=[0,3,1,2])</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tmp_stim</span><span class="p">)</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp_stim</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>            <span class="n">stim_ori</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimETori&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>            <span class="n">Hinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_ori</span> <span class="o">&gt;</span> <span class="mi">45</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>            <span class="n">Vinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_ori</span> <span class="o">&lt;</span> <span class="mi">45</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">Vinds</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">Hinds</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Robs and DATAFILTERS&quot;&quot;&quot;</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>            <span class="n">robs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>            <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>            <span class="n">num_SUs</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>            <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_SUs</span><span class="p">)</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>            <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>            <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;datafilts&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>                <span class="n">num_MUs</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>                <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="o">+</span><span class="n">num_SUs</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_SUs</span><span class="o">+</span><span class="n">num_MUs</span><span class="p">)</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>                <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>                <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;datafiltsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>            
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">robs_tmp</span><span class="p">)</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dfs_tmp</span><span class="p">)</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>            <span class="n">t_counter</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>            <span class="n">unit_counter</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span> <span class="o">=</span> <span class="s1">&#39;stim&#39;</span>  <span class="c1"># not sure what this does</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>        <span class="c1"># Make combined stim (in case used)</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">NX2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">)</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">NX</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_gap</span><span class="p">,</span> <span class="n">NX2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">)</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>    <span class="c1"># END Bar1D.preload_numpy()</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>    <span class="k">def</span> <span class="nf">assemble_stimulus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>        <span class="n">combine_stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>        <span class="n">time_embed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> 
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>        <span class="n">Hshift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Hdiscardzero</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>        <span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">BUF</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a><span class="sd">        Assembles stimulus for the dataset</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a><span class="sd">        -- This will also time-embed the stimulus if requested</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a><span class="sd">        -- This will also shift the stimulus if requested</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a><span class="sd">        -- This will also crop the stimulus if requested</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a><span class="sd">        Args:</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a><span class="sd">            combine_stim: whether to combine horizontal and vertical stimulus</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a><span class="sd">            stim_crop: whether to crop stimulus (not implemented)</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a><span class="sd">            time_embed: 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a><span class="sd">            num_lags: number of lags to include in time-embedding</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a><span class="sd">            Hshift: how much to shift horizontal stimulus (in bars)</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a><span class="sd">            Hdiscardzero: whether to discard zero position in horizontal stimulus</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a><span class="sd">            shifts: shifts to apply to stimulus (if not None)</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a><span class="sd">            BUF: buffer for shifting stimulus</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>        <span class="k">if</span> <span class="n">combine_stim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>            <span class="n">combine_stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span> <span class="o">=</span> <span class="n">combine_stim</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimHshift</span> <span class="o">=</span> <span class="n">Hshift</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Hdiscardzero</span> <span class="o">=</span> <span class="n">Hdiscardzero</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="o">=</span> <span class="n">stim_crop</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>        <span class="k">if</span> <span class="n">stim_crop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;stimulus cropping not implemented yet&#39;</span><span class="p">)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>        <span class="c1"># Assemble/shift horizontal stim</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Assembling stimulus&quot;</span><span class="p">)</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>        <span class="n">sh</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Hshift</span><span class="p">)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>        <span class="k">if</span> <span class="n">sh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>            <span class="n">Hstim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>            <span class="n">Lc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span> <span class="o">-</span> <span class="n">sh</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>            <span class="n">Hstim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>            <span class="k">if</span> <span class="n">Hdiscardzero</span><span class="p">:</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Discarding stim at 0 horizontal position&#39;</span><span class="p">)</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>                <span class="k">if</span> <span class="n">Hshift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">sh</span><span class="p">)])</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>                <span class="k">elif</span> <span class="n">Hshift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Lc</span><span class="p">)])</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>                <span class="k">if</span> <span class="n">Hshift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)])</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>                <span class="k">elif</span> <span class="n">Hshift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)])</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>            <span class="c1"># Reassemble stimC</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Hstim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">Hstim</span><span class="p">)</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>   
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>        <span class="c1"># Time embed horizontal and vertical stim</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>        <span class="k">if</span> <span class="n">time_embed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Time embedding...&quot;</span><span class="p">)</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>            <span class="n">tmp_stimH</span> <span class="o">=</span> <span class="n">Hstim</span><span class="p">[</span><span class="n">idx</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>            <span class="n">tmp_stimV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">idx</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>            <span class="n">tmp_stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimH</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>            <span class="n">tmp_stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimV</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>                <span class="n">tmp_stimC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[</span><span class="n">idx</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>                <span class="n">tmp_stimC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimC</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="n">Hstim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimHout</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">tmp_stimH</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dimsH</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">tmp_stimH</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_lags</span><span class="p">]</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimVout</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">tmp_stimV</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dimsV</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">tmp_stimV</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_lags</span><span class="p">]</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>        
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">tmp_stimC</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_lags</span><span class="p">]</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> 
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>                <span class="n">tmp_stimC</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">tmp_stimC</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> 
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_dimsH</span><span class="p">)</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimHout</span><span class="p">)</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>    <span class="c1"># END BarET.assemble_stimulus()        </span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>    <span class="k">def</span> <span class="nf">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a><span class="sd">        Converts all data to tensors</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a><span class="sd">        Args:</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a><span class="sd">            device: torch device to move data to</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>            <span class="c1"># then already converted: just moving device</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>            <span class="c1">#self.stimH = self.stimH.to(device)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>            <span class="c1">#self.stimV = self.stimV.to(device)</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>            <span class="c1">#self.stimH = torch.tensor(self.stimH, dtype=torch.float32, device=device)</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>            <span class="c1">#self.stimV = torch.tensor(self.stimV, dtype=torch.float32, device=device)</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>            <span class="c1">#if self.combine_stim:</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>            <span class="c1">#    self.stimC = torch.tensor(self.stimC, dtype=torch.float32, device=device)</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>    <span class="c1"># END Bar1D.to_tensor</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>    <span class="k">def</span> <span class="nf">process_fixations</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sacc_in</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a><span class="sd">        Processes fixation informatiom from dataset, but also allows new saccade detection</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a><span class="sd">        to be input and put in the right format within the dataset (main use).</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a><span class="sd">        </span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a><span class="sd">        Args:</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a><span class="sd">            sacc_in: new saccade information to be processed</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a><span class="sd">        Returns:</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a><span class="sd">            None: sets self.fix_n</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>        <span class="k">if</span> <span class="n">sacc_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>            <span class="n">sacc_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>        <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> 
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>        <span class="n">fix_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)):</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>            <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>            <span class="c1">#self.block_inds.append(np.arange( blk_inds[ii,0], blk_inds[ii,1], dtype=np.int64))</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>            <span class="c1"># Parse fixation numbers within block</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>            <span class="n">rel_saccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">sacc_in</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sacc_in</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>            <span class="n">tfix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Beginning of fixation by definition</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>            <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel_saccs</span><span class="p">)):</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>                <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>                <span class="c1"># Range goes to beginning of next fixation (note no gap)</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>                <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>                <span class="n">tfix</span> <span class="o">=</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">6</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>            <span class="c1"># Put in last (or only) fixation number</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>            <span class="k">if</span> <span class="n">tfix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>                <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>                <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>        <span class="c1"># Determine whether to be numpy or tensor</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">fix_n</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>    <span class="c1"># END: Bar1D.process_fixations()</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>    <span class="k">def</span> <span class="nf">add_shifter</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">shifts</span> <span class="p">):</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a><span class="sd">        Adds a shifter to the dataset</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a><span class="sd">        Args:</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a><span class="sd">            shifts: shifts to apply to the stimulus</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a><span class="sd">        Returns:</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a><span class="sd">            None: sets self.shifts</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">shifts</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">),</span> <span class="s2">&quot;Entered shifts is wrong size.&quot;</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span><span class="p">:</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>        <span class="c1"># else: Delete old shifts?</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>        
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">device</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">):</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="o">=</span> <span class="n">shifts</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>    <span class="k">def</span> <span class="nf">avrates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a><span class="sd">        Calculates average firing probability across specified inds (or whole dataset)</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a><span class="sd">        -- Note will respect datafilters</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a><span class="sd">        -- will return precalc value to save time if already stored</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a><span class="sd">        Args:</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a><span class="sd">            inds: indices to calculate across</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a><span class="sd">        Returns:</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a><span class="sd">            avRs: average firing rates across specified indices</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>            <span class="c1"># then calculate across whole dataset</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>                <span class="c1"># then precalculated and do not need to do</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>        <span class="c1"># Otherwise calculate across all data</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>        <span class="n">Reff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>        <span class="n">Teff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="o">/</span><span class="n">Teff</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>    <span class="c1"># END .avrates()</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>    <span class="k">def</span> <span class="nf">apply_data_mask</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">dmask</span><span class="p">,</span> <span class="n">crange</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a><span class="sd">        For when data_filters (or a section) is modified based on models, and want to apply</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a><span class="sd">        to the dataset. Ideally would save the original.</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a><span class="sd">        </span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a><span class="sd">        Args:</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a><span class="sd">            dmask: mask to apply to data_filters</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a><span class="sd">            crange: range of cells to apply to</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a><span class="sd">        Returns:</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a><span class="sd">            None: sets self.dfs to new data mask</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dmask</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>            <span class="n">dmask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dmask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dmask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>            <span class="n">dmask</span> <span class="o">=</span> <span class="n">dmask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>        <span class="n">NT</span><span class="p">,</span> <span class="n">mask_size</span> <span class="o">=</span> <span class="n">dmask</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>        <span class="k">assert</span> <span class="n">NT</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="s2">&quot;Data mask is wrong length&quot;</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>            <span class="n">cells_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>            <span class="n">cells_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>        <span class="k">if</span> <span class="n">crange</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>            <span class="n">crange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells_out</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>        <span class="k">assert</span> <span class="n">mask_size</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">crange</span><span class="p">),</span> <span class="s2">&quot;mask does not cover the right range&quot;</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">)</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>        <span class="c1"># Given all assertions worked, then make copy</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">cells_out</span><span class="p">[</span><span class="n">crange</span><span class="p">]]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dmask</span><span class="p">)</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>    <span class="c1"># END .apply_data_mask()</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>    <span class="k">def</span> <span class="nf">data_mask_revert</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">crange</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a><span class="sd">        Reverts data mask to original</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a><span class="sd">        Args:</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a><span class="sd">            crange: range of cells to revert</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a><span class="sd">        Returns:</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a><span class="sd">            None: sets self.dfs to original data mask</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Nothing to revert&quot;</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span><span class="p">)</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>    <span class="k">def</span> <span class="nf">shift_stim_fixation</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a><span class="sd">        Simple shift by integer (rounded shift) and zero padded. Note that this is not in </span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a><span class="sd">        is in units of number of bars, rather than -1 to +1. It assumes the stim</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a><span class="sd">        has a batch dimension (over a fixation), and shifts the whole stim by the same amount.</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a><span class="sd">        </span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a><span class="sd">        Args:</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a><span class="sd">            stim: stimulus to shift</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a><span class="sd">            shift: amount to shift stimulus</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a><span class="sd">        Returns:</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a><span class="sd">            shstim: shifted stimulus</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Currently needs to be fixed to work with 2D&#39;</span><span class="p">)</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>        <span class="n">sh</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>        <span class="n">shstim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>        <span class="k">if</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="o">-</span><span class="n">sh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="p">:</span><span class="n">sh</span><span class="p">]</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>        <span class="k">elif</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="n">sh</span><span class="p">:]</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>            <span class="n">shstim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>        <span class="k">return</span> <span class="n">shstim</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>    <span class="c1"># END .shift_stim_fixation</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>    <span class="k">def</span> <span class="nf">create_valid_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post_sacc_gap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a><span class="sd">        This creates self.valid_inds vector that is used for __get_item__ </span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a><span class="sd">        -- Will default to num_lags following each saccade beginning</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a><span class="sd">        </span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a><span class="sd">        Args:</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a><span class="sd">            post_sacc_gap: number of lags to ignore after saccade</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a><span class="sd">        Returns:</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a><span class="sd">            None: sets self.valid_inds</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>        <span class="k">if</span> <span class="n">post_sacc_gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>            <span class="n">post_sacc_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>        <span class="c1"># first, throw out all data where all data_filters are zero</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>        <span class="n">is_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>        <span class="n">is_valid</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>        
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>        <span class="c1"># Now invalid post_sacc_gap following saccades</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span><span class="p">):</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:])</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>            <span class="n">sts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>            <span class="n">is_valid</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">post_sacc_gap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>        
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>        <span class="c1">#self.valid_inds = list(np.where(is_valid &gt; 0)[0])</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_valid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>    <span class="c1"># END .create_valid_indices</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>    <span class="k">def</span> <span class="nf">crossval_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test_set</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a><span class="sd">        This sets the cross-validation indices up We can add featuers here. Many ways to do this</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a><span class="sd">        but will stick to some standard for now. It sets the internal indices, which can be read out</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a><span class="sd">        directly or with helper functions. Perhaps helper_functions is the best way....</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a><span class="sd">        </span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a><span class="sd">        Args:</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a><span class="sd">            folds: number of folds to use</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a><span class="sd">            test_set: whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a><span class="sd">            verbose: whether to print out information</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a><span class="sd">        </span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a><span class="sd">        Returns:</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a><span class="sd">            None: sets internal variables test_inds, train_inds, val_inds</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must first specify valid_indices before setting up cross-validation.&quot;</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>        <span class="c1"># Reflect block structure</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>        <span class="n">Nblks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>        <span class="n">val_blk1</span><span class="p">,</span> <span class="n">tr_blk1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="n">Nblks</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>        <span class="k">if</span> <span class="n">test_set</span><span class="p">:</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="n">val_blk1</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>            <span class="n">val_blk2</span><span class="p">,</span> <span class="n">tr_blk2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_blk1</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span><span class="p">[</span><span class="n">val_blk2</span><span class="p">]</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span><span class="p">[</span><span class="n">tr_blk2</span><span class="p">]</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">val_blk1</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Partitioned </span><span class="si">%d</span><span class="s2"> fixations total: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>                <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">)))</span>  
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>        <span class="c1"># Now pull indices from each saccade </span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>        <span class="n">tr_inds</span><span class="p">,</span> <span class="n">te_inds</span><span class="p">,</span> <span class="n">val_inds</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">:</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>            <span class="n">tr_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">:</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>            <span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">:</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>            <span class="n">te_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Pre-valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">te_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>        <span class="c1"># Finally intersect with used_inds</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">val_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">te_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>    <span class="c1"># END .crossval_setup()</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>    <span class="k">def</span> <span class="nf">fold_sample</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a><span class="sd">        This really should be a general method not associated with self</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a><span class="sd">        </span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a><span class="sd">        Args:</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a><span class="sd">            num_items: number of items to fold</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a><span class="sd">            folds: number of folds</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a><span class="sd">            random_gen: whether to randomly sample or uniformly sample</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a><span class="sd">        Returns:</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a><span class="sd">            val_items: indices of validation items</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a><span class="sd">            rem_items: indices of remaining items</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>        <span class="k">if</span> <span class="n">random_gen</span><span class="p">:</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>            <span class="n">num_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_items</span><span class="o">/</span><span class="n">folds</span><span class="p">)</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>            <span class="n">tmp_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">num_items</span><span class="p">)</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[:</span><span class="n">num_val</span><span class="p">])</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[</span><span class="n">num_val</span><span class="p">:])</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>            <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">folds</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">),</span> <span class="n">val_items</span><span class="p">)</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>        <span class="k">return</span> <span class="n">val_items</span><span class="p">,</span> <span class="n">rem_items</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>    <span class="k">def</span> <span class="nf">adjust_Xdrift_xval</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a><span class="sd">        Adjust drift matrix to not fit xval parameterz</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a><span class="sd">        Args:</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a><span class="sd">            None</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a><span class="sd">        Returns:</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a><span class="sd">            None: sets self.Xdrift to adjusted version</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>        <span class="n">Xnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">]</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">)):</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>            <span class="n">newpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">ii</span> <span class="c1"># this will be where lower range is</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>            <span class="k">if</span> <span class="n">newpos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>            <span class="k">elif</span> <span class="n">newpos</span> <span class="o">==</span> <span class="n">Xnew</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># In between</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span> <span class="n">newpos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span> <span class="n">newpos</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">Xnew</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>    <span class="c1"># END .adjust_drift_xval</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>        
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;get_item time embedding not implemented yet&quot;</span><span class="p">)</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>            <span class="c1"># if self.folded_lags:</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>            <span class="c1">#    stim = np.transpose( tmp_stim, axes=[0,2,1,3,4] ) </span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>            <span class="c1">#else:</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>            <span class="c1">#    stim = np.transpose( tmp_stim, axes=[0,2,3,4,1] )</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to assemble_stimulus first.&quot;</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>                <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>                    <span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> 
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>                    <span class="s1">&#39;stimH&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimHout</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> 
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>                    <span class="s1">&#39;stimV&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimVout</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]}</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>                <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>                    <span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> 
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>                    <span class="s1">&#39;stimV&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimVout</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]}</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;fix_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Xdrift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>                    <span class="n">robs_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs_out</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>                    <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs_out</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s1">&#39;cells_out must be a list&#39;</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>                    <span class="n">robs_tmp</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>                    <span class="n">dfs_tmp</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">robs_tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfs_tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">append_covariates</span><span class="p">(</span> <span class="n">out</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>        <span class="c1">### THIS IS NOT NEEDED WITH TIME-EMBEDDING: needs to be on fixation-process side...</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>        <span class="c1">#         # Augment to eliminate first X time steps in data_filters</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>        <span class="c1">#if (self.num_lags &gt; 0) &amp;  ~utils.is_int(idx):</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>        <span class="c1">#    if out[&#39;dfs&#39;].shape[0] &lt;= self.num_lags:</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>        <span class="c1">#        print( &quot;Warning: fixation shorter than num_lags: %d &lt;= %d&quot;%(out[&#39;dfs&#39;].shape[0], self.num_lags))</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>        <span class="c1">#    else:</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>        <span class="c1">#        out[&#39;dfs&#39;][:self.num_lags, :] = 0.0</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span><span class="p">:</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;DATASET: shifts missing but &#39;with_shifter&#39; is true&quot;</span> 
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;shifts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>            
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">append_covariates</span><span class="p">(</span> <span class="n">out</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>        <span class="k">return</span> <span class="n">out</span>                
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a><span class="c1"># END BarET Dataset</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a><span class="c1">############ ORIGINAL BAR DATASET -- NOW VERSION 7 ###############</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a><span class="k">class</span> <span class="nc">Bar1Dv7</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a><span class="sd">    -- can load batches from multiple datasets</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a><span class="sd">    -- hdf5 files must have the following information:</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a><span class="sd">        Robs</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a><span class="sd">        RobsMU</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a><span class="sd">        stim: 4-d stimulus: time x nx x ny x color</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a><span class="sd">        block_inds: start and stop of &#39;trials&#39; (perhaps fixations for now)</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a><span class="sd">        other things: saccades? or should that be in trials? </span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a><span class="sd">    Constructor will take eye position, which for now is an input from data</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a><span class="sd">    generated in the session (not on disk). It should have the length size </span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a><span class="sd">    of the total number of fixations x1.</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>        <span class="n">sess_list</span><span class="p">,</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>        <span class="n">datadir</span><span class="p">,</span> 
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>        <span class="c1"># Stim setup</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>        <span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>        <span class="c1">#which_stim = &#39;stimET&#39;,</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>        <span class="n">stim_crop</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>        <span class="n">Hstim_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># to shift-and-wrap stimH stimulus</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>        <span class="n">Hdiscardzero</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>        <span class="n">time_embed</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>        <span class="n">folded_lags</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>        <span class="c1"># Stim configuation</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>        <span class="n">combine_stim</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># if False, horizontal stim will be &#39;stim&#39;</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>        <span class="n">stim_gap</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>        <span class="n">drift_interval</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>  <span class="c1"># how many trials to anchor each drift term</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>        <span class="c1"># eye configuration</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>        <span class="n">eye_config</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 0 = all, 1, -1, and 2 are options (2 = binocular)</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>        <span class="c1"># other</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>        <span class="n">ignore_saccades</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>        <span class="n">include_MUs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>        <span class="n">preload</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>        <span class="n">eyepos</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a><span class="sd">        Constructor options</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a><span class="sd">        Args:</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a><span class="sd">            sess_list: list of sessions to load</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a><span class="sd">            datadir: directory where data is stored</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a><span class="sd">            num_lags: number of lags to include in time-embedding</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a><span class="sd">            stim_crop: whether to crop stimulus (not implemented)</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a><span class="sd">            Hstim_shift: how much to shift horizontal stimulus (in bars)</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a><span class="sd">            Hdiscardzero: whether to discard zero position in horizontal stimulus</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a><span class="sd">            time_embed: 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a><span class="sd">            folded_lags: whether to fold lags in time-embedding</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a><span class="sd">            combine_stim: whether to combine horizontal and vertical stimulus</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a><span class="sd">            stim_gap: gap between horizontal and vertical stimuli</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a><span class="sd">            drift_interval: how many trials to anchor each drift term</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a><span class="sd">            eye_config: 0 = all, 1, -1, and 2 are options (2 = binocular)</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a><span class="sd">            ignore_saccades: whether to ignore saccades</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a><span class="sd">            include_MUs: whether to include multi-units</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a><span class="sd">            preload: whether to preload data</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a><span class="sd">            eyepos: eye position data</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a><span class="sd">            device: torch device to move data to</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">datadir</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sess_list</span> <span class="o">=</span> <span class="n">sess_list</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>        
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span> <span class="o">=</span> <span class="n">num_lags</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>        <span class="k">if</span> <span class="n">time_embed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>            <span class="k">assert</span> <span class="n">preload</span><span class="p">,</span> <span class="s2">&quot;Cannot pre-time-embed without preloading.&quot;</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">=</span> <span class="n">time_embed</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preload</span> <span class="o">=</span> <span class="n">preload</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="o">=</span> <span class="n">stim_crop</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span> <span class="o">=</span> <span class="n">folded_lags</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span> <span class="o">=</span> <span class="n">combine_stim</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">=</span> <span class="n">eye_config</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_gap</span> <span class="o">=</span> <span class="n">stim_gap</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimHshift</span> <span class="o">=</span> <span class="n">Hstim_shift</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Hdiscardzero</span> <span class="o">=</span> <span class="n">Hdiscardzero</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span> <span class="o">=</span> <span class="n">drift_interval</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>        <span class="c1"># get hdf5 file handles</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">sess</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_list</span><span class="p">]</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>        <span class="c1"># Data to just read in and store</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ETstim_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ETstim_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;stim_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;fix_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probeIDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Robs_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probeIDsMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;RobsMU_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dt&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;pixel_size&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exptdate</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># need to learn matlab strings in HDF5 format (not saved as HDF5 string)</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>        <span class="c1"># build index map</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_threshold</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># how many valid time points required to include saccade?</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_index</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># which file the block corresponds to</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>        <span class="c1">#self.unit_ids = []</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_sus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_mus</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sus</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>        <span class="c1">#self.stim_dims = None</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span> <span class="o">=</span> <span class="n">eyepos</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_Xfix</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sess_list</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_filemapping</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span> <span class="o">=</span> <span class="n">include_MUs</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">SUinds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">MUinds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># can be list to output specific cells in get_item</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>        <span class="c1"># Set up to store default train_, val_, test_inds</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>        <span class="c1"># Data to construct and store in memory</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>        <span class="c1">#self.sacc_on = []</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>        <span class="c1">#self.sacc_off = []</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>        <span class="n">tcount</span><span class="p">,</span> <span class="n">fix_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>        <span class="c1">#if which_stim is None:</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>        <span class="c1">#    stimname = &#39;stimET&#39;</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>        <span class="c1">#else:</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>        <span class="c1">#    stimname = which_stim</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span> <span class="o">=</span> <span class="s1">&#39;stimET&#39;</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ETtraceHR</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>        <span class="k">for</span> <span class="n">fnum</span><span class="p">,</span> <span class="n">fhandle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">):</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>            <span class="n">NT</span><span class="p">,</span> <span class="n">NSUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>            <span class="n">NX</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>            <span class="n">NMUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_sus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NSUfile</span><span class="p">)</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_mus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NMUfile</span><span class="p">)</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sus</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="o">+</span><span class="n">NSUfile</span><span class="p">))</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;block_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>            <span class="n">stim_eyes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useLeye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span>  \
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>                            <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>            
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>            <span class="n">Reye</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">]</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>            <span class="n">NCfile</span> <span class="o">=</span> <span class="n">NSUfile</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>                <span class="n">NCfile</span> <span class="o">+=</span> <span class="n">NMUfile</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>            
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>            <span class="c1"># This will associate each block with each file</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_filemapping</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="n">fnum</span><span class="p">)</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span><span class="p">[</span><span class="n">fnum</span><span class="p">]</span><span class="o">=</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span><span class="p">[</span><span class="n">fnum</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>            <span class="c1">#if self.stim_dims is None:</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>            <span class="c1">#if folded_lags:</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">([</span><span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="c1">#list(fhandle[stimname].shape[1:4]) + [1]</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>          
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stim check:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">,</span> <span class="n">folded_lags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>            <span class="c1">#self.unit_ids.append(self.NC + np.asarray(range(NCfile)))</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NCfile</span><span class="p">)</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">+=</span> <span class="n">NCfile</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;sacc_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>            <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>  <span class="c1"># each time point labels fixation number</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>            <span class="c1">#sacc_on = np.zeros(NT, dtype=np.float32)  # each time point labels fixation number</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>            <span class="c1">#sacc_on[sacc_inds[:,0]-1] = 1.0</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>            <span class="c1">#sacc_off = np.zeros(NT, dtype=np.float32)  # each time point labels fixation number</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>            <span class="c1">#sacc_off[sacc_inds[:,1]-1] = 1.0</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>            <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;valid_data&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="mi">1</span>  <span class="c1">#range(self.NT)  # default -- to be changed at end of init</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>            <span class="c1">### Process blocks and fixations/saccades</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>                <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>                <span class="n">include_block</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>                <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">stim_eyes</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>                        <span class="n">include_block</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>                <span class="k">if</span> <span class="n">include_block</span><span class="p">:</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>                    <span class="c1">#self.block_inds.append( np.arange( blk_inds[ii,0], blk_inds[ii,1], dtype=np.int64) )</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>            <span class="c1"># Got through each block to segment into fixations</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>            <span class="c1">#for nn in range(blk_inds.shape[0]):</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>            <span class="c1">#    # note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>            <span class="c1">#    include_block = True</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>            <span class="c1">#    ts = np.arange( blk_inds[nn,0]-1, blk_inds[nn,1], dtype=int)</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>            <span class="c1">#    if self.eye_config &gt; 0:</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>            <span class="c1">#        if np.sum(stim_eyes[ts] == self.eye_config) == 0:</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>            <span class="c1">#            include_block = False</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>            <span class="c1">#    if include_block:</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>            <span class="c1">#        self.block_inds.append(deepcopy(ts))</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>            <span class="c1">#        t0 = blk_inds[nn, 0]-1</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>                    <span class="c1">#valid_inds[range(t0, t0+num_lags)] = 0  # this already adjusted for?</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>                    <span class="c1"># Parse fixation numbers within block</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>            <span class="c1">#        if not ignore_saccades:</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>            <span class="c1">#            rel_saccs = np.where((sacc_inds[:,0] &gt; t0) &amp; (sacc_inds[:,0] &lt; blk_inds[nn,1]))[0]</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>            <span class="c1">#            for mm in range(len(rel_saccs)):</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>            <span class="c1">#                fix_count += 1</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>            <span class="c1">#                fix_n[ range(t0, sacc_inds[rel_saccs[mm], 0]) ] = fix_count</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>            <span class="c1">#                t0 = sacc_inds[rel_saccs[mm], 1]-1</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>                    <span class="c1"># Put in last (or only) fixation number</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>            <span class="c1">#        if t0 &lt; blk_inds[nn, 1]:</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>            <span class="c1">#            fix_count += 1</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>            <span class="c1">#            fix_n[ range(t0, blk_inds[nn, 1]) ] = fix_count</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>            
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>            <span class="n">tcount</span> <span class="o">+=</span> <span class="n">NT</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>            <span class="c1"># make larger fix_n, valid_inds, sacc_inds, block_inds as self</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>  <span class="o">=</span> <span class="n">tcount</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>        <span class="c1"># For now let&#39;s just debug with one file</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sess_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: currently ignoring multiple files&#39;</span><span class="p">)</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">valid_inds</span><span class="p">)</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>        <span class="c1">#self.fix_n = deepcopy(fix_n)</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>        <span class="c1">#self.sac_on = deepcopy(sacc_on)</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>        <span class="c1">#self.sac_off = deepcopy(sacc_off)</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>        <span class="c1">#self.sacc_inds = deepcopy(sacc_inds)</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>        
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>        <span class="c1"># PULL OTHER INFO</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ETtraceHR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;ETtrace_raw&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sort_rating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs_rating&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sort_ratingMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU_rating&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>        <span class="c1"># Go through saccades to establish val_indices and produce saccade timing vector </span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>        <span class="c1"># Note that sacc_ts will be generated even without preload -- small enough that doesnt matter</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>    <span class="c1">#    self.sacc_ts = np.zeros([self.NT, 1], dtype=np.float32)</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>    <span class="c1">#    self.fix_n = np.zeros(self.NT, dtype=np.int64)  # label of which fixation is in each range</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>    <span class="c1">#    for nn in range(self.num_fixations):</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>    <span class="c1">#        print(nn, self.sacc_inds[nn][0], self.sacc_inds[nn][1] )</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>    <span class="c1">#        self.sacc_ts[self.sacc_inds[nn][0]] = 1 </span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>    <span class="c1">#        self.fix_n[range(self.sacc_inds[nn][0], self.sacc_inds[nn][1])] = nn</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>        <span class="c1">#self.fix_n = list(self.fix_n)  # better list than numpy</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>        <span class="c1">#self.dims = np.unique(np.asarray(self.dims)) # assumes they&#39;re all the same    </span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>        <span class="c1">#if self.eyepos is not None:</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>            <span class="c1">#assert len(self.eyepos) == self.num_fixations, \</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>            <span class="c1">#    &quot;eyepos input should have %d fixations.&quot;%self.num_fixations</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>        <span class="k">if</span> <span class="n">preload</span><span class="p">:</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data into memory...&quot;</span><span class="p">)</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">preload_numpy</span><span class="p">()</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>                <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;eye pos wrong shape&quot;</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>                <span class="c1"># Apply horizontal shifts to stim (stil in numpy)</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>                <span class="n">Hshifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">eyepos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">)</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>                <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Hshifts</span><span class="p">)):</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>                    <span class="n">sh</span> <span class="o">=</span> <span class="n">Hshifts</span><span class="p">[</span><span class="n">ss</span><span class="p">]</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>                    <span class="n">Lc</span> <span class="o">=</span> <span class="n">NX</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>                    <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">eyepos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">sh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">])</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>                    <span class="k">if</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="p">:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">ts</span><span class="p">,:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh</span><span class="p">))])</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>                    <span class="k">elif</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">ts</span><span class="p">,:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)])</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">ts</span><span class="p">,:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>                    <span class="k">if</span> <span class="n">sh</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>                        <span class="n">newstim</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">newstim</span><span class="p">)</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>                <span class="c1"># Apply horizontal shifts to stim (stil in numpy)</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>                <span class="n">Vshifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">eyepos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">)</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>                <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Vshifts</span><span class="p">)):</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>                    <span class="n">sh</span> <span class="o">=</span> <span class="n">Vshifts</span><span class="p">[</span><span class="n">ss</span><span class="p">]</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>                    <span class="n">Lc</span> <span class="o">=</span> <span class="n">NX</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>                    <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">eyepos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">sh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">])</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>                    <span class="k">if</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="p">:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">ts</span><span class="p">,:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh</span><span class="p">))])</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>                    <span class="k">elif</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">ts</span><span class="p">,:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)])</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">ts</span><span class="p">,:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>                    <span class="k">if</span> <span class="n">sh</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>                        <span class="n">newstim</span><span class="p">[</span><span class="n">ts</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">tmp</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">newstim</span><span class="p">)</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>    
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;stimulus cropping not implemented yet&#39;</span><span class="p">)</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>            <span class="k">if</span> <span class="n">time_embed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time embedding...&quot;</span><span class="p">)</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>                <span class="n">tmp_stimH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>                <span class="n">tmp_stimV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>                    <span class="n">tmp_stimC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span><span class="p">:</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">tmp_stimH</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">tmp_stimV</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="n">tmp_stimC</span> 
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Folded lags: stim-dim = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimH</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimV</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimC</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>            <span class="c1"># Flatten stim </span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>            <span class="c1"># Have data_filters represend used_inds (in case it gets through)</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>            <span class="n">unified_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>            <span class="n">unified_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*=</span> <span class="n">unified_df</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>            <span class="c1"># Prepare design matrix for drift (on trial-by-trial basis)</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>            <span class="c1">#self.Xdrift = np.zeros([self.NT, len(self.block_inds)//], dtype=np.float32)</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>            <span class="c1">#for nn in range(len(self.block_inds)):</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>            <span class="c1">#    self.Xdrift[self.block_inds[nn], nn] = 1.0</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>            <span class="n">NBL</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>            <span class="n">Nanchors</span> <span class="o">=</span> <span class="n">NBL</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>            <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">):</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>                <span class="n">anchors</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span><span class="o">*</span><span class="n">bb</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">process_fixations</span><span class="p">()</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>            <span class="c1"># Convert data to tensors</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>            <span class="c1">#if self.device is not None:</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>        <span class="c1"># Create valid indices and first pass of cross-validation indices</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>        <span class="c1">#self.create_valid_indices()</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>        <span class="c1"># Develop default train, validation, and test datasets </span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crossval_setup</span><span class="p">()</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>        <span class="c1"># Fix Xdrift to remove test and validation sets</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>        <span class="c1">#self.adjust_Xdrift_xval()</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">stim_gap</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>        <span class="c1"># Reflects block structure</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>        <span class="c1">#vblks, trblks = self.fold_sample(len(self.block_inds), 5, random_gen=True)</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>        <span class="c1">#self.train_inds = []</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>        <span class="c1">#for nn in trblks:</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>        <span class="c1">#    self.train_inds += list(deepcopy(self.block_inds[nn]))</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>        <span class="c1">#self.val_inds = []</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>        <span class="c1">#for nn in vblks:</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>        <span class="c1">#    self.val_inds += list(deepcopy(self.block_inds[nn]))</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>        <span class="c1">#self.train_inds = np.array(self.train_inds, dtype=np.int64)</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>        <span class="c1">#self.val_inds = np.array(self.val_inds, dtype=np.int64)</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>    <span class="c1"># END ColorClouds.__init__</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>    <span class="k">def</span> <span class="nf">preload_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a><span class="sd">        Note this loads stimulus but does not time-embed</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a><span class="sd">        </span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a><span class="sd">        Args:</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a><span class="sd">            None</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a><span class="sd">        Returns:</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a><span class="sd">            None: sets self.stim, self.robs, self.dfs, self.eyepos, self.frame_times</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>        <span class="n">NX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>        <span class="n">NX2</span> <span class="o">=</span> <span class="n">NX</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_gap</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a><span class="sd">        Pre-allocate memory for data</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">NX2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>        <span class="c1">#self.eyepos = np.zeros([NT, 2], dtype=np.float32)</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>        <span class="c1">#self.frame_times = np.zeros([NT,1], dtype=np.float32)</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>        <span class="n">t_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>        <span class="n">unit_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">)):</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>            
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>            <span class="n">fhandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>            <span class="n">sz</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_counter</span><span class="p">,</span> <span class="n">t_counter</span><span class="o">+</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>            <span class="c1">#inds = self.stim_indices[expt][stim][&#39;inds&#39;]</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>            <span class="c1">#self.stim[inds, ...] = np.transpose( np.array(fhandle[self.stimname], dtype=np.float32), axes=[0,3,1,2])</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tmp_stim</span><span class="p">)</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp_stim</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>            <span class="n">stim_ori</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimETori&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>            <span class="n">Hinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_ori</span> <span class="o">&gt;</span> <span class="mi">45</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>            <span class="n">Vinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_ori</span> <span class="o">&lt;</span> <span class="mi">45</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">Vinds</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">Hinds</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Robs and DATAFILTERS&quot;&quot;&quot;</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>            <span class="n">robs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>            <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>            <span class="n">num_sus</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>            <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="p">)</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>            <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>            <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;datafilts&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>                <span class="n">num_mus</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>                <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="o">+</span><span class="n">num_mus</span><span class="p">)</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>                <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>                <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;datafiltsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>            
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">robs_tmp</span><span class="p">)</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dfs_tmp</span><span class="p">)</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>            <span class="n">t_counter</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>            <span class="n">unit_counter</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span> <span class="o">=</span> <span class="s1">&#39;stim&#39;</span>  <span class="c1"># not sure what this does</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">)</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">NX</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_gap</span><span class="p">,</span> <span class="n">NX2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">)</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>        <span class="n">sh</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimHshift</span><span class="p">)</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>        <span class="k">if</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>            <span class="n">Lc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span> <span class="o">-</span> <span class="n">sh</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hdiscardzero</span><span class="p">:</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Discarding stim at 0 horizontal position&#39;</span><span class="p">)</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimHshift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">sh</span><span class="p">)])</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimHshift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Lc</span><span class="p">)])</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimHshift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)])</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimHshift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)])</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tmp_stim</span><span class="p">)</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>    <span class="c1"># END Bar1D.preload_numpy()</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>        
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>    <span class="k">def</span> <span class="nf">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a><span class="sd">        Converts numpy data to torch tensors and moves to device</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a><span class="sd">        Args:</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a><span class="sd">            device: torch device to move data to</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>            <span class="c1"># then already converted: just moving device</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>    <span class="c1"># END Bar1D.to_tensor</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>    <span class="k">def</span> <span class="nf">process_fixations</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sacc_in</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a><span class="sd">        Processes fixation informatiom from dataset, but also allows new saccade detection</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a><span class="sd">        to be input and put in the right format within the dataset (main use)</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a><span class="sd">        </span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a><span class="sd">        Args:</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a><span class="sd">            sacc_in: new saccade information to be processed (if None, will use existing)</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a><span class="sd">        Returns:</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a><span class="sd">            None: sets self.fix_n</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>        <span class="k">if</span> <span class="n">sacc_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>            <span class="n">sacc_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>        <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> 
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>        <span class="n">fix_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)):</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>            <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>            <span class="c1">#self.block_inds.append(np.arange( blk_inds[ii,0], blk_inds[ii,1], dtype=np.int64))</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>            <span class="c1"># Parse fixation numbers within block</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>            <span class="n">rel_saccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">sacc_in</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sacc_in</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>            <span class="n">tfix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Beginning of fixation by definition</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>            <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel_saccs</span><span class="p">)):</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>                <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>                <span class="c1"># Range goes to beginning of next fixation (note no gap)</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>                <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>                <span class="n">tfix</span> <span class="o">=</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">6</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>            <span class="c1"># Put in last (or only) fixation number</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>            <span class="k">if</span> <span class="n">tfix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>                <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>                <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>        <span class="c1"># Determine whether to be numpy or tensor</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">fix_n</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>    <span class="c1"># END: Bar1D.process_fixations()</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>    <span class="k">def</span> <span class="nf">add_shifter</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">shifts</span> <span class="p">):</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a><span class="sd">        Adds a shifter to the dataset, which can be used to shift the stimulus</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a><span class="sd">        Args:</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a><span class="sd">            shifts: shifts to be added to the dataset</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a><span class="sd">        Returns:</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a><span class="sd">            None: sets self.shifts</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">shifts</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">),</span> <span class="s2">&quot;Entered shifts is wrong size.&quot;</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span><span class="p">:</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>        <span class="c1"># else: Delete old shifts?</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>        
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">device</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">):</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="o">=</span> <span class="n">shifts</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>    <span class="k">def</span> <span class="nf">avrates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a><span class="sd">        Calculates average firing probability across specified inds (or whole dataset)</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a><span class="sd">        -- Note will respect datafilters</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a><span class="sd">        -- will return precalc value to save time if already stored</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a><span class="sd">        Args:</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a><span class="sd">            inds: indices to calculate across</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a><span class="sd">        Returns:</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a><span class="sd">            avRs: average firing rates across the dataset</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>            <span class="c1"># then calculate across whole dataset</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>                <span class="c1"># then precalculated and do not need to do</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>        <span class="c1"># Otherwise calculate across all data</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>            <span class="n">Reff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>            <span class="n">Teff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="o">/</span><span class="n">Teff</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Still need to implement avRs without preloading&#39;</span><span class="p">)</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>    <span class="c1"># END .avrates()</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>    <span class="k">def</span> <span class="nf">apply_data_mask</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">dmask</span><span class="p">,</span> <span class="n">crange</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a><span class="sd">        For when data_filters (or a section) is modified based on models, and want to apply</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a><span class="sd">        to the dataset. Ideally would save the original</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a><span class="sd">        </span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a><span class="sd">        Args:</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a><span class="sd">            dmask: mask to apply to data</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a><span class="sd">            crange: range of cells to apply mask to</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a><span class="sd">        Returns:</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a><span class="sd">            None: sets self.dfs to new data mask</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">,</span> <span class="s2">&quot;data must be preloaded to apply mask&quot;</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dmask</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>            <span class="n">dmask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dmask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dmask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>            <span class="n">dmask</span> <span class="o">=</span> <span class="n">dmask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>        <span class="n">NT</span><span class="p">,</span> <span class="n">mask_size</span> <span class="o">=</span> <span class="n">dmask</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>        <span class="k">assert</span> <span class="n">NT</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="s2">&quot;Data mask is wrong length&quot;</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>            <span class="n">cells_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>            <span class="n">cells_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>        <span class="k">if</span> <span class="n">crange</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>            <span class="n">crange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells_out</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>        <span class="k">assert</span> <span class="n">mask_size</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">crange</span><span class="p">),</span> <span class="s2">&quot;mask does not cover the right range&quot;</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">)</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>        <span class="c1"># Given all assertions worked, then make copy</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">cells_out</span><span class="p">[</span><span class="n">crange</span><span class="p">]]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dmask</span><span class="p">)</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>    <span class="c1"># END .apply_data_mask()</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>    <span class="k">def</span> <span class="nf">data_mask_revert</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">crange</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a><span class="sd">        Reverts data mask to original state</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a><span class="sd">        Args:</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a><span class="sd">            crange: range of cells to revert mask</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a><span class="sd">        Returns:</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a><span class="sd">            None: sets self.dfs to original data mask</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Nothing to revert&quot;</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span><span class="p">)</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>    <span class="k">def</span> <span class="nf">shift_stim_fixation</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a><span class="sd">        Simple shift by integer (rounded shift) and zero padded. Note that this is not in </span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a><span class="sd">        is in units of number of bars, rather than -1 to +1. It assumes the stim</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a><span class="sd">        has a batch dimension (over a fixation), and shifts the whole stim by the same amount.</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a><span class="sd">        </span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a><span class="sd">        Args:</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a><span class="sd">            stim: stimulus to shift</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a><span class="sd">            shift: amount to shift by</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a><span class="sd">        Returns:</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a><span class="sd">            shstim: shifted stimulus</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Currently needs to be fixed to work with 2D&#39;</span><span class="p">)</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>        <span class="n">sh</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a>        <span class="n">shstim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>        <span class="k">if</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="o">-</span><span class="n">sh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="p">:</span><span class="n">sh</span><span class="p">]</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>        <span class="k">elif</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="n">sh</span><span class="p">:]</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>            <span class="n">shstim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>        <span class="k">return</span> <span class="n">shstim</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>    <span class="c1"># END .shift_stim_fixation</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>    <span class="k">def</span> <span class="nf">create_valid_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post_sacc_gap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a><span class="sd">        This creates self.valid_inds vector that is used for __get_item__ </span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a><span class="sd">        -- Will default to num_lags following each saccade beginning</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a><span class="sd">        </span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a><span class="sd">        Args:</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a><span class="sd">            post_sacc_gap: number of lags to exclude following saccade</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a><span class="sd">        Returns:</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a><span class="sd">            None: sets self.valid_inds</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>        <span class="k">if</span> <span class="n">post_sacc_gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>            <span class="n">post_sacc_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>        <span class="c1"># first, throw out all data where all data_filters are zero</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>        <span class="n">is_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>        <span class="n">is_valid</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>        
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>        <span class="c1"># Now invalid post_sacc_gap following saccades</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span><span class="p">):</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:])</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>            <span class="n">sts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>            <span class="n">is_valid</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">post_sacc_gap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>        
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>        <span class="c1">#self.valid_inds = list(np.where(is_valid &gt; 0)[0])</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_valid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>    <span class="c1"># END .create_valid_indices</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>    <span class="k">def</span> <span class="nf">crossval_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test_set</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a><span class="sd">        This sets the cross-validation indices up We can add featuers here. Many ways to do this</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a><span class="sd">        but will stick to some standard for now. It sets the internal indices, which can be read out</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a><span class="sd">        directly or with helper functions. Perhaps helper_functions is the best way....</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a><span class="sd">        </span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a><span class="sd">        Args:</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a><span class="sd">            folds: number of folds to use</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a><span class="sd">            test_set: whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a><span class="sd">            verbose: whether to print out information</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a><span class="sd">        </span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a><span class="sd">        Returns:</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a><span class="sd">            None: sets internal variables test_inds, train_inds, val_inds</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must first specify valid_indices before setting up cross-validation.&quot;</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>        <span class="c1"># Reflect block structure</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>        <span class="n">Nblks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>        <span class="n">val_blk1</span><span class="p">,</span> <span class="n">tr_blk1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="n">Nblks</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>        <span class="k">if</span> <span class="n">test_set</span><span class="p">:</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="n">val_blk1</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>            <span class="n">val_blk2</span><span class="p">,</span> <span class="n">tr_blk2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_blk1</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span><span class="p">[</span><span class="n">val_blk2</span><span class="p">]</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span><span class="p">[</span><span class="n">tr_blk2</span><span class="p">]</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">val_blk1</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Partitioned </span><span class="si">%d</span><span class="s2"> fixations total: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>                <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">)))</span>  
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>        <span class="c1"># Now pull indices from each saccade </span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>        <span class="n">tr_inds</span><span class="p">,</span> <span class="n">te_inds</span><span class="p">,</span> <span class="n">val_inds</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">:</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>            <span class="n">tr_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">:</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>            <span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">:</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>            <span class="n">te_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Pre-valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">te_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a>        <span class="c1"># Finally intersect with used_inds</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">val_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">te_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>    <span class="c1"># END .crossval_setup()</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>    <span class="k">def</span> <span class="nf">fold_sample</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a><span class="sd">        This really should be a general method not associated with self</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a><span class="sd">        </span>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a><span class="sd">        Args:</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a><span class="sd">            num_items: number of items to fold</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a><span class="sd">            folds: number of folds</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a><span class="sd">            random_gen: whether to randomly sample or uniformly sample</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a><span class="sd">        Returns:</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a><span class="sd">            val_items: indices for validation set</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a><span class="sd">            rem_items: indices for remaining set</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>        <span class="k">if</span> <span class="n">random_gen</span><span class="p">:</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>            <span class="n">num_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_items</span><span class="o">/</span><span class="n">folds</span><span class="p">)</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>            <span class="n">tmp_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">num_items</span><span class="p">)</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[:</span><span class="n">num_val</span><span class="p">])</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[</span><span class="n">num_val</span><span class="p">:])</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>            <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">folds</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">),</span> <span class="n">val_items</span><span class="p">)</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>        <span class="k">return</span> <span class="n">val_items</span><span class="p">,</span> <span class="n">rem_items</span>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>    <span class="k">def</span> <span class="nf">adjust_Xdrift_xval</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a><span class="sd">        Adjust drift matrix to not fit xval parameterz</span>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a><span class="sd">        Args:</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a><span class="sd">            None</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a><span class="sd">        Returns:</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a><span class="sd">            None: sets self.Xdrift to new matrix</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>        <span class="n">Xnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">]</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">)):</span>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>            <span class="n">newpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">ii</span> <span class="c1"># this will be where lower range is</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>            <span class="k">if</span> <span class="n">newpos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>            <span class="k">elif</span> <span class="n">newpos</span> <span class="o">==</span> <span class="n">Xnew</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># In between</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span> <span class="n">newpos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span> <span class="n">newpos</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">Xnew</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>    <span class="c1"># END .adjust_drift_xval</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>    <span class="k">def</span> <span class="nf">get_max_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpu_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nquad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mf">1.2</span><span class="p">):</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a><span class="sd">        get the maximum number of samples that fit in memory -- for GLM/GQM x LBFGS</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a><span class="sd">        Args:</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a><span class="sd">            gpu_n: which gpu to use</span>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a><span class="sd">            history_size: number of time lags</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a><span class="sd">            nquad: number of quadrature points</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a><span class="sd">            num_cells: number of cells to use</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a><span class="sd">            buffer: buffer to leave for other memory</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a><span class="sd">        Returns:</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a><span class="sd">            maxsamples: maximum number of samples that can fit in memory</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a>        <span class="k">if</span> <span class="n">gpu_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:1&#39;</span><span class="p">)</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a>        <span class="k">if</span> <span class="n">num_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a>            <span class="n">num_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>        
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">total_memory</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_reserved</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_allocated</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a>        <span class="n">free</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a>        <span class="n">mempersample</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>    
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>        <span class="n">mempercell</span> <span class="o">=</span> <span class="n">mempersample</span> <span class="o">*</span> <span class="p">(</span><span class="n">nquad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">history_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a>        <span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">*</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>        <span class="n">maxsamples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">free</span> <span class="o">-</span> <span class="n">mempercell</span><span class="o">*</span><span class="n">num_cells</span> <span class="o">-</span> <span class="n">buffer_bytes</span><span class="p">)</span> <span class="o">//</span> <span class="n">mempersample</span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# samples that can fit on device: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxsamples</span><span class="p">))</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>        <span class="k">return</span> <span class="n">maxsamples</span>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a>    <span class="c1"># END .get_max_samples</span>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>        
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;get_item time embedding not implemented yet&quot;</span><span class="p">)</span>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a>                <span class="c1"># if self.folded_lags:</span>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a>                <span class="c1">#    stim = np.transpose( tmp_stim, axes=[0,2,1,3,4] ) </span>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a>                <span class="c1">#else:</span>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a>                <span class="c1">#    stim = np.transpose( tmp_stim, axes=[0,2,3,4,1] )</span>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a>    
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a>                    <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>                        <span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> 
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a>                        <span class="s1">&#39;stimH&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> 
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a>                        <span class="s1">&#39;stimV&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]}</span>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a>                    <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a>                        <span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> 
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a>                        <span class="s1">&#39;stimV&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]}</span>
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a>                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;fix_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a>                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Xdrift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a>                    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a>                    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a>                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s1">&#39;cells_out must be a list&#39;</span>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a>                    <span class="n">robs_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a>                    <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a>                    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">robs_tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a>                    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfs_tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">append_covariates</span><span class="p">(</span> <span class="n">out</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a>            
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a>            <span class="n">stim</span><span class="p">,</span> <span class="n">stimV</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a>            <span class="n">robs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a>            <span class="n">num_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Stim &quot;&quot;&quot;</span>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a>            <span class="c1"># need file handle</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a>            <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a>            <span class="c1">#f = self.file_index[inds]  # problem is this could span across several files</span>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NOT DONE YET&quot;</span><span class="p">)</span>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">stimname</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a>            <span class="c1"># reshape and flatten stim: currently its NT x NX x NY x Nclrs</span>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">permute</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">])</span>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a><span class="w">                </span>
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Spikes: needs padding so all are B x NC &quot;&quot;&quot;</span> 
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a>            <span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;Robs&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a>                <span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a>                    <span class="p">(</span><span class="n">robs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span> 
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a>                    <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Datafilters: needs padding like robs &quot;&quot;&quot;</span>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;DFs&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a>                <span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a>                    <span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;DFsMU&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a>                    <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="n">stim</span><span class="p">,</span> <span class="s1">&#39;stimV&#39;</span><span class="p">:</span> <span class="n">stimV</span><span class="p">,</span> <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="n">robs</span><span class="p">,</span> <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="n">dfs</span><span class="p">,</span> <span class="s1">&#39;fix_n&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">[</span><span class="n">inds</span><span class="p">]}</span>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a>        <span class="c1">### THIS IS NOT NEEDED WITH TIME-EMBEDDING: needs to be on fixation-process side...</span>
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a>        <span class="c1">#         # Augment to eliminate first X time steps in data_filters</span>
</span><span id="L-1720"><a href="#L-1720"><span class="linenos">1720</span></a>        <span class="c1">#if (self.num_lags &gt; 0) &amp;  ~utils.is_int(idx):</span>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos">1721</span></a>        <span class="c1">#    if out[&#39;dfs&#39;].shape[0] &lt;= self.num_lags:</span>
</span><span id="L-1722"><a href="#L-1722"><span class="linenos">1722</span></a>        <span class="c1">#        print( &quot;Warning: fixation shorter than num_lags: %d &lt;= %d&quot;%(out[&#39;dfs&#39;].shape[0], self.num_lags))</span>
</span><span id="L-1723"><a href="#L-1723"><span class="linenos">1723</span></a>        <span class="c1">#    else:</span>
</span><span id="L-1724"><a href="#L-1724"><span class="linenos">1724</span></a>        <span class="c1">#        out[&#39;dfs&#39;][:self.num_lags, :] = 0.0</span>
</span><span id="L-1725"><a href="#L-1725"><span class="linenos">1725</span></a>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos">1726</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span><span class="p">:</span>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos">1727</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;DATASET: shifts missing but &#39;with_shifter&#39; is true&quot;</span> 
</span><span id="L-1728"><a href="#L-1728"><span class="linenos">1728</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;shifts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-1729"><a href="#L-1729"><span class="linenos">1729</span></a>
</span><span id="L-1730"><a href="#L-1730"><span class="linenos">1730</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos">1731</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">append_covariates</span><span class="p">(</span> <span class="n">out</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos">1732</span></a>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos">1733</span></a>        <span class="k">return</span> <span class="n">out</span>                
</span><span id="L-1734"><a href="#L-1734"><span class="linenos">1734</span></a>
</span><span id="L-1735"><a href="#L-1735"><span class="linenos">1735</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1736"><a href="#L-1736"><span class="linenos">1736</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span></pre></div>


            </section>
                <section id="BarET">
                            <input id="BarET-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">BarET</span><wbr>(<span class="base">typing.Generic[+T_co]</span>):

                <label class="view-source-button" for="BarET-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BarET"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BarET-16"><a href="#BarET-16"><span class="linenos"> 16</span></a><span class="k">class</span> <span class="nc">BarET</span><span class="p">(</span><span class="n">SensoryBase</span><span class="p">):</span>
</span><span id="BarET-17"><a href="#BarET-17"><span class="linenos"> 17</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET-18"><a href="#BarET-18"><span class="linenos"> 18</span></a><span class="sd">    -- can load batches from multiple datasets</span>
</span><span id="BarET-19"><a href="#BarET-19"><span class="linenos"> 19</span></a><span class="sd">    -- hdf5 files must have the following information:</span>
</span><span id="BarET-20"><a href="#BarET-20"><span class="linenos"> 20</span></a><span class="sd">        Robs</span>
</span><span id="BarET-21"><a href="#BarET-21"><span class="linenos"> 21</span></a><span class="sd">        RobsMU</span>
</span><span id="BarET-22"><a href="#BarET-22"><span class="linenos"> 22</span></a><span class="sd">        stim: 4-d stimulus: time x nx x ny x color</span>
</span><span id="BarET-23"><a href="#BarET-23"><span class="linenos"> 23</span></a><span class="sd">        block_inds: start and stop of &#39;trials&#39; (perhaps fixations for now)</span>
</span><span id="BarET-24"><a href="#BarET-24"><span class="linenos"> 24</span></a><span class="sd">        other things: saccades? or should that be in trials? </span>
</span><span id="BarET-25"><a href="#BarET-25"><span class="linenos"> 25</span></a>
</span><span id="BarET-26"><a href="#BarET-26"><span class="linenos"> 26</span></a><span class="sd">    Constructor will take eye position, which for now is an input from data</span>
</span><span id="BarET-27"><a href="#BarET-27"><span class="linenos"> 27</span></a><span class="sd">    generated in the session (not on disk). It should have the length size </span>
</span><span id="BarET-28"><a href="#BarET-28"><span class="linenos"> 28</span></a><span class="sd">    of the total number of fixations x1.</span>
</span><span id="BarET-29"><a href="#BarET-29"><span class="linenos"> 29</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="BarET-30"><a href="#BarET-30"><span class="linenos"> 30</span></a>
</span><span id="BarET-31"><a href="#BarET-31"><span class="linenos"> 31</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="BarET-32"><a href="#BarET-32"><span class="linenos"> 32</span></a>        <span class="n">filenames</span><span class="p">,</span>
</span><span id="BarET-33"><a href="#BarET-33"><span class="linenos"> 33</span></a>        <span class="n">datadir</span><span class="p">,</span> 
</span><span id="BarET-34"><a href="#BarET-34"><span class="linenos"> 34</span></a>        <span class="n">include_MUs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="BarET-35"><a href="#BarET-35"><span class="linenos"> 35</span></a>        <span class="c1"># Stim setup -- have option to assemble or could leave blank</span>
</span><span id="BarET-36"><a href="#BarET-36"><span class="linenos"> 36</span></a>        <span class="n">time_embed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="BarET-37"><a href="#BarET-37"><span class="linenos"> 37</span></a>        <span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
</span><span id="BarET-38"><a href="#BarET-38"><span class="linenos"> 38</span></a>        <span class="c1"># Dataset-specitic inputs</span>
</span><span id="BarET-39"><a href="#BarET-39"><span class="linenos"> 39</span></a>        <span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="BarET-40"><a href="#BarET-40"><span class="linenos"> 40</span></a>        <span class="n">Hstim_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># to shift-and-wrap stimH stimulus</span>
</span><span id="BarET-41"><a href="#BarET-41"><span class="linenos"> 41</span></a>        <span class="n">Hdiscardzero</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="BarET-42"><a href="#BarET-42"><span class="linenos"> 42</span></a>        <span class="c1"># Stim configuation</span>
</span><span id="BarET-43"><a href="#BarET-43"><span class="linenos"> 43</span></a>        <span class="n">combine_stim</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># if False, horizontal stim will be &#39;stim&#39;</span>
</span><span id="BarET-44"><a href="#BarET-44"><span class="linenos"> 44</span></a>        <span class="n">stim_gap</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="BarET-45"><a href="#BarET-45"><span class="linenos"> 45</span></a>        <span class="n">drift_interval</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>  <span class="c1"># how many trials to anchor each drift term</span>
</span><span id="BarET-46"><a href="#BarET-46"><span class="linenos"> 46</span></a>        <span class="c1"># eye configuration</span>
</span><span id="BarET-47"><a href="#BarET-47"><span class="linenos"> 47</span></a>        <span class="n">eye_config</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># 0 = all, 1, 2, and 3 are options (3 = binocular)</span>
</span><span id="BarET-48"><a href="#BarET-48"><span class="linenos"> 48</span></a>        <span class="n">binocular</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># whether to include separate filters for each eye</span>
</span><span id="BarET-49"><a href="#BarET-49"><span class="linenos"> 49</span></a>        <span class="c1"># other</span>
</span><span id="BarET-50"><a href="#BarET-50"><span class="linenos"> 50</span></a>        <span class="c1">#ignore_saccades=True,</span>
</span><span id="BarET-51"><a href="#BarET-51"><span class="linenos"> 51</span></a>        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">),</span>
</span><span id="BarET-52"><a href="#BarET-52"><span class="linenos"> 52</span></a>        <span class="n">maxT</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="BarET-53"><a href="#BarET-53"><span class="linenos"> 53</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET-54"><a href="#BarET-54"><span class="linenos"> 54</span></a><span class="sd">        Constructor options</span>
</span><span id="BarET-55"><a href="#BarET-55"><span class="linenos"> 55</span></a><span class="sd">        </span>
</span><span id="BarET-56"><a href="#BarET-56"><span class="linenos"> 56</span></a><span class="sd">        Args:</span>
</span><span id="BarET-57"><a href="#BarET-57"><span class="linenos"> 57</span></a><span class="sd">            filenames: list of strings of hdf5 files</span>
</span><span id="BarET-58"><a href="#BarET-58"><span class="linenos"> 58</span></a><span class="sd">            datadir: directory where files are stored</span>
</span><span id="BarET-59"><a href="#BarET-59"><span class="linenos"> 59</span></a><span class="sd">            include_MUs: whether to include multi-units</span>
</span><span id="BarET-60"><a href="#BarET-60"><span class="linenos"> 60</span></a><span class="sd">            time_embed: 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="BarET-61"><a href="#BarET-61"><span class="linenos"> 61</span></a><span class="sd">            num_lags: number of lags to include in time-embedding</span>
</span><span id="BarET-62"><a href="#BarET-62"><span class="linenos"> 62</span></a><span class="sd">            stim_crop: whether to crop stimulus (not implemented)</span>
</span><span id="BarET-63"><a href="#BarET-63"><span class="linenos"> 63</span></a><span class="sd">            Hstim_shift: how much to shift horizontal stimulus (in bars)</span>
</span><span id="BarET-64"><a href="#BarET-64"><span class="linenos"> 64</span></a><span class="sd">            Hdiscardzero: whether to discard zero position in horizontal stimulus</span>
</span><span id="BarET-65"><a href="#BarET-65"><span class="linenos"> 65</span></a><span class="sd">            combine_stim: whether to combine horizontal and vertical stimulus</span>
</span><span id="BarET-66"><a href="#BarET-66"><span class="linenos"> 66</span></a><span class="sd">            stim_gap: gap between horizontal and vertical stimulus</span>
</span><span id="BarET-67"><a href="#BarET-67"><span class="linenos"> 67</span></a><span class="sd">            drift_interval: how many trials to anchor each drift term</span>
</span><span id="BarET-68"><a href="#BarET-68"><span class="linenos"> 68</span></a><span class="sd">            eye_config: 0 = all, 1, 2, and 3 are options (3 = binocular)</span>
</span><span id="BarET-69"><a href="#BarET-69"><span class="linenos"> 69</span></a><span class="sd">            binocular: whether to include separate filters for each eye</span>
</span><span id="BarET-70"><a href="#BarET-70"><span class="linenos"> 70</span></a><span class="sd">            device: torch device</span>
</span><span id="BarET-71"><a href="#BarET-71"><span class="linenos"> 71</span></a><span class="sd">            maxT: maximum time points to load (for debugging)</span>
</span><span id="BarET-72"><a href="#BarET-72"><span class="linenos"> 72</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET-73"><a href="#BarET-73"><span class="linenos"> 73</span></a>
</span><span id="BarET-74"><a href="#BarET-74"><span class="linenos"> 74</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="BarET-75"><a href="#BarET-75"><span class="linenos"> 75</span></a>            <span class="n">filenames</span><span class="o">=</span><span class="n">filenames</span><span class="p">,</span> <span class="n">datadir</span><span class="o">=</span><span class="n">datadir</span><span class="p">,</span> 
</span><span id="BarET-76"><a href="#BarET-76"><span class="linenos"> 76</span></a>            <span class="n">time_embed</span><span class="o">=</span><span class="n">time_embed</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">num_lags</span><span class="p">,</span> 
</span><span id="BarET-77"><a href="#BarET-77"><span class="linenos"> 77</span></a>            <span class="n">include_MUs</span><span class="o">=</span><span class="n">include_MUs</span><span class="p">,</span>
</span><span id="BarET-78"><a href="#BarET-78"><span class="linenos"> 78</span></a>            <span class="n">drift_interval</span><span class="o">=</span><span class="n">drift_interval</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET-79"><a href="#BarET-79"><span class="linenos"> 79</span></a>
</span><span id="BarET-80"><a href="#BarET-80"><span class="linenos"> 80</span></a>        <span class="c1"># Done in constructor</span>
</span><span id="BarET-81"><a href="#BarET-81"><span class="linenos"> 81</span></a>        <span class="c1">#self.datadir = datadir</span>
</span><span id="BarET-82"><a href="#BarET-82"><span class="linenos"> 82</span></a>        <span class="c1">#self.filenames = filenames</span>
</span><span id="BarET-83"><a href="#BarET-83"><span class="linenos"> 83</span></a>        <span class="c1">#self.device = device</span>
</span><span id="BarET-84"><a href="#BarET-84"><span class="linenos"> 84</span></a>        <span class="c1">#self.num_lags = 10  # default: to be set later</span>
</span><span id="BarET-85"><a href="#BarET-85"><span class="linenos"> 85</span></a>        <span class="c1">#self.time_embed = time_embed</span>
</span><span id="BarET-86"><a href="#BarET-86"><span class="linenos"> 86</span></a>        <span class="c1">#self.used_inds = []</span>
</span><span id="BarET-87"><a href="#BarET-87"><span class="linenos"> 87</span></a>        <span class="c1">#self.NT = 0</span>
</span><span id="BarET-88"><a href="#BarET-88"><span class="linenos"> 88</span></a>
</span><span id="BarET-89"><a href="#BarET-89"><span class="linenos"> 89</span></a>        <span class="c1"># Stim-specific</span>
</span><span id="BarET-90"><a href="#BarET-90"><span class="linenos"> 90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">=</span> <span class="n">eye_config</span>
</span><span id="BarET-91"><a href="#BarET-91"><span class="linenos"> 91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_gap</span> <span class="o">=</span> <span class="n">stim_gap</span>
</span><span id="BarET-92"><a href="#BarET-92"><span class="linenos"> 92</span></a>
</span><span id="BarET-93"><a href="#BarET-93"><span class="linenos"> 93</span></a>        <span class="c1"># get hdf5 file handles</span>
</span><span id="BarET-94"><a href="#BarET-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">sess</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>
</span><span id="BarET-95"><a href="#BarET-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BarET-96"><a href="#BarET-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BarET-97"><a href="#BarET-97"><span class="linenos"> 97</span></a>
</span><span id="BarET-98"><a href="#BarET-98"><span class="linenos"> 98</span></a>        <span class="c1"># Data to just read in and store</span>
</span><span id="BarET-99"><a href="#BarET-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;stim_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="BarET-100"><a href="#BarET-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_locationET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ETstim_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="BarET-101"><a href="#BarET-101"><span class="linenos">101</span></a>
</span><span id="BarET-102"><a href="#BarET-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;fix_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="BarET-103"><a href="#BarET-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probeIDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Robs_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="BarET-104"><a href="#BarET-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probeIDsMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;RobsMU_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="BarET-105"><a href="#BarET-105"><span class="linenos">105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dt&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="BarET-106"><a href="#BarET-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;pixel_size&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="BarET-107"><a href="#BarET-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exptdate</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># need to learn matlab strings in HDF5 format (not saved as HDF5 string)</span>
</span><span id="BarET-108"><a href="#BarET-108"><span class="linenos">108</span></a>
</span><span id="BarET-109"><a href="#BarET-109"><span class="linenos">109</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapSU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Robs_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="BarET-110"><a href="#BarET-110"><span class="linenos">110</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;RobsMU_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="BarET-111"><a href="#BarET-111"><span class="linenos">111</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">channel_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_mapSU</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapMU</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="BarET-112"><a href="#BarET-112"><span class="linenos">112</span></a>
</span><span id="BarET-113"><a href="#BarET-113"><span class="linenos">113</span></a>        <span class="c1">#self.stim = []</span>
</span><span id="BarET-114"><a href="#BarET-114"><span class="linenos">114</span></a>        <span class="c1">#self.dfs = []</span>
</span><span id="BarET-115"><a href="#BarET-115"><span class="linenos">115</span></a>        <span class="c1">#self.robs = []</span>
</span><span id="BarET-116"><a href="#BarET-116"><span class="linenos">116</span></a>        <span class="c1">#self.NT = 0</span>
</span><span id="BarET-117"><a href="#BarET-117"><span class="linenos">117</span></a>        <span class="c1"># Add additional stimuli for processing</span>
</span><span id="BarET-118"><a href="#BarET-118"><span class="linenos">118</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimHout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimVout</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="BarET-119"><a href="#BarET-119"><span class="linenos">119</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dimsH</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dimsV</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="BarET-120"><a href="#BarET-120"><span class="linenos">120</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BarET-121"><a href="#BarET-121"><span class="linenos">121</span></a>
</span><span id="BarET-122"><a href="#BarET-122"><span class="linenos">122</span></a>        <span class="c1"># build index map</span>
</span><span id="BarET-123"><a href="#BarET-123"><span class="linenos">123</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_threshold</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># how many valid time points required to include saccade?</span>
</span><span id="BarET-124"><a href="#BarET-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_index</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># which file the block corresponds to</span>
</span><span id="BarET-125"><a href="#BarET-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BarET-126"><a href="#BarET-126"><span class="linenos">126</span></a>        <span class="c1">#self.unit_ids = []</span>
</span><span id="BarET-127"><a href="#BarET-127"><span class="linenos">127</span></a>        <span class="c1">#self.num_units, self.num_sus, self.num_mus = [], [], []</span>
</span><span id="BarET-128"><a href="#BarET-128"><span class="linenos">128</span></a>        <span class="c1">#self.sus = []</span>
</span><span id="BarET-129"><a href="#BarET-129"><span class="linenos">129</span></a>        <span class="c1">#self.NC = 0</span>
</span><span id="BarET-130"><a href="#BarET-130"><span class="linenos">130</span></a>        <span class="c1">#self.stim_dims = None</span>
</span><span id="BarET-131"><a href="#BarET-131"><span class="linenos">131</span></a>        <span class="c1">#self.eyepos = eyepos</span>
</span><span id="BarET-132"><a href="#BarET-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_Xfix</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="BarET-133"><a href="#BarET-133"><span class="linenos">133</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="BarET-134"><a href="#BarET-134"><span class="linenos">134</span></a>        <span class="c1">#self.block_inds = []</span>
</span><span id="BarET-135"><a href="#BarET-135"><span class="linenos">135</span></a>        <span class="c1">#self.block_filemapping = []</span>
</span><span id="BarET-136"><a href="#BarET-136"><span class="linenos">136</span></a>        <span class="c1">#self.include_MUs = include_MUs</span>
</span><span id="BarET-137"><a href="#BarET-137"><span class="linenos">137</span></a>        <span class="c1">#self.SUinds = []</span>
</span><span id="BarET-138"><a href="#BarET-138"><span class="linenos">138</span></a>        <span class="c1">#self.MUinds = []</span>
</span><span id="BarET-139"><a href="#BarET-139"><span class="linenos">139</span></a>        <span class="c1">#self.cells_out = []  # can be list to output specific cells in get_item</span>
</span><span id="BarET-140"><a href="#BarET-140"><span class="linenos">140</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="BarET-141"><a href="#BarET-141"><span class="linenos">141</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BarET-142"><a href="#BarET-142"><span class="linenos">142</span></a>
</span><span id="BarET-143"><a href="#BarET-143"><span class="linenos">143</span></a>        <span class="c1"># Set up to store default train_, val_, test_inds</span>
</span><span id="BarET-144"><a href="#BarET-144"><span class="linenos">144</span></a>        <span class="c1">#self.test_inds = None</span>
</span><span id="BarET-145"><a href="#BarET-145"><span class="linenos">145</span></a>        <span class="c1">#self.val_inds = None</span>
</span><span id="BarET-146"><a href="#BarET-146"><span class="linenos">146</span></a>        <span class="c1">#self.train_inds = None</span>
</span><span id="BarET-147"><a href="#BarET-147"><span class="linenos">147</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="BarET-148"><a href="#BarET-148"><span class="linenos">148</span></a>
</span><span id="BarET-149"><a href="#BarET-149"><span class="linenos">149</span></a>        <span class="n">tcount</span><span class="p">,</span> <span class="n">fix_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="BarET-150"><a href="#BarET-150"><span class="linenos">150</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span> <span class="o">=</span> <span class="s1">&#39;stimET&#39;</span>
</span><span id="BarET-151"><a href="#BarET-151"><span class="linenos">151</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ETtraceHR</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BarET-152"><a href="#BarET-152"><span class="linenos">152</span></a>
</span><span id="BarET-153"><a href="#BarET-153"><span class="linenos">153</span></a>        <span class="k">for</span> <span class="n">fnum</span><span class="p">,</span> <span class="n">fhandle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">):</span>
</span><span id="BarET-154"><a href="#BarET-154"><span class="linenos">154</span></a>
</span><span id="BarET-155"><a href="#BarET-155"><span class="linenos">155</span></a>            <span class="n">NT</span><span class="p">,</span> <span class="n">NSUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="BarET-156"><a href="#BarET-156"><span class="linenos">156</span></a>            <span class="n">NX</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="BarET-157"><a href="#BarET-157"><span class="linenos">157</span></a>            <span class="n">NMUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="BarET-158"><a href="#BarET-158"><span class="linenos">158</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_SUs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NSUfile</span><span class="p">)</span>
</span><span id="BarET-159"><a href="#BarET-159"><span class="linenos">159</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_MUs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NMUfile</span><span class="p">)</span>
</span><span id="BarET-160"><a href="#BarET-160"><span class="linenos">160</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="o">+</span><span class="n">NSUfile</span><span class="p">))</span>
</span><span id="BarET-161"><a href="#BarET-161"><span class="linenos">161</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;block_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="BarET-162"><a href="#BarET-162"><span class="linenos">162</span></a>            <span class="n">stim_eyes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useLeye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span>  \
</span><span id="BarET-163"><a href="#BarET-163"><span class="linenos">163</span></a>                            <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="BarET-164"><a href="#BarET-164"><span class="linenos">164</span></a>            
</span><span id="BarET-165"><a href="#BarET-165"><span class="linenos">165</span></a>            <span class="n">Reye</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">]</span>
</span><span id="BarET-166"><a href="#BarET-166"><span class="linenos">166</span></a>            <span class="n">NCfile</span> <span class="o">=</span> <span class="n">NSUfile</span>
</span><span id="BarET-167"><a href="#BarET-167"><span class="linenos">167</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="BarET-168"><a href="#BarET-168"><span class="linenos">168</span></a>                <span class="n">NCfile</span> <span class="o">+=</span> <span class="n">NMUfile</span>
</span><span id="BarET-169"><a href="#BarET-169"><span class="linenos">169</span></a>            
</span><span id="BarET-170"><a href="#BarET-170"><span class="linenos">170</span></a>            <span class="c1"># This will associate each block with each file</span>
</span><span id="BarET-171"><a href="#BarET-171"><span class="linenos">171</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_filemapping</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="n">fnum</span><span class="p">)</span>
</span><span id="BarET-172"><a href="#BarET-172"><span class="linenos">172</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span><span class="p">[</span><span class="n">fnum</span><span class="p">]</span><span class="o">=</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BarET-173"><a href="#BarET-173"><span class="linenos">173</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span><span class="p">[</span><span class="n">fnum</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BarET-174"><a href="#BarET-174"><span class="linenos">174</span></a>            <span class="c1">#if self.stim_dims is None:</span>
</span><span id="BarET-175"><a href="#BarET-175"><span class="linenos">175</span></a>            <span class="c1">#if folded_lags:</span>
</span><span id="BarET-176"><a href="#BarET-176"><span class="linenos">176</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">([</span><span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="c1">#list(fhandle[stimname].shape[1:4]) + [1]</span>
</span><span id="BarET-177"><a href="#BarET-177"><span class="linenos">177</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="BarET-178"><a href="#BarET-178"><span class="linenos">178</span></a>          
</span><span id="BarET-179"><a href="#BarET-179"><span class="linenos">179</span></a>            <span class="c1">#if self.time_embed &gt; 0:</span>
</span><span id="BarET-180"><a href="#BarET-180"><span class="linenos">180</span></a>            <span class="c1">#    self.dims[3] = self.num_lags</span>
</span><span id="BarET-181"><a href="#BarET-181"><span class="linenos">181</span></a>
</span><span id="BarET-182"><a href="#BarET-182"><span class="linenos">182</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stim check:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</span><span id="BarET-183"><a href="#BarET-183"><span class="linenos">183</span></a>
</span><span id="BarET-184"><a href="#BarET-184"><span class="linenos">184</span></a>            <span class="c1">#self.unit_ids.append(self.NC + np.asarray(range(NCfile)))</span>
</span><span id="BarET-185"><a href="#BarET-185"><span class="linenos">185</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NCfile</span><span class="p">)</span>
</span><span id="BarET-186"><a href="#BarET-186"><span class="linenos">186</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">+=</span> <span class="n">NCfile</span>
</span><span id="BarET-187"><a href="#BarET-187"><span class="linenos">187</span></a>
</span><span id="BarET-188"><a href="#BarET-188"><span class="linenos">188</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;sacc_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="BarET-189"><a href="#BarET-189"><span class="linenos">189</span></a>            <span class="c1">#fix_n = np.zeros(NT, dtype=np.int64)  # each time point labels fixation number</span>
</span><span id="BarET-190"><a href="#BarET-190"><span class="linenos">190</span></a>
</span><span id="BarET-191"><a href="#BarET-191"><span class="linenos">191</span></a>            <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;valid_data&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>  <span class="c1">#range(self.NT)  # default -- to be changed at end of init</span>
</span><span id="BarET-192"><a href="#BarET-192"><span class="linenos">192</span></a>
</span><span id="BarET-193"><a href="#BarET-193"><span class="linenos">193</span></a>            <span class="c1">### Process blocks and fixations/saccades</span>
</span><span id="BarET-194"><a href="#BarET-194"><span class="linenos">194</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="BarET-195"><a href="#BarET-195"><span class="linenos">195</span></a>                <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="BarET-196"><a href="#BarET-196"><span class="linenos">196</span></a>                <span class="n">include_block</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="BarET-197"><a href="#BarET-197"><span class="linenos">197</span></a>                <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="BarET-198"><a href="#BarET-198"><span class="linenos">198</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET-199"><a href="#BarET-199"><span class="linenos">199</span></a>                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">stim_eyes</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET-200"><a href="#BarET-200"><span class="linenos">200</span></a>                        <span class="n">include_block</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="BarET-201"><a href="#BarET-201"><span class="linenos">201</span></a>                <span class="k">if</span> <span class="n">include_block</span><span class="p">:</span>
</span><span id="BarET-202"><a href="#BarET-202"><span class="linenos">202</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
</span><span id="BarET-203"><a href="#BarET-203"><span class="linenos">203</span></a>            
</span><span id="BarET-204"><a href="#BarET-204"><span class="linenos">204</span></a>            <span class="n">tcount</span> <span class="o">+=</span> <span class="n">NT</span>
</span><span id="BarET-205"><a href="#BarET-205"><span class="linenos">205</span></a>            <span class="c1"># make larger fix_n, valid_inds, sacc_inds, block_inds as self</span>
</span><span id="BarET-206"><a href="#BarET-206"><span class="linenos">206</span></a>
</span><span id="BarET-207"><a href="#BarET-207"><span class="linenos">207</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>  <span class="o">=</span> <span class="n">tcount</span>
</span><span id="BarET-208"><a href="#BarET-208"><span class="linenos">208</span></a>
</span><span id="BarET-209"><a href="#BarET-209"><span class="linenos">209</span></a>        <span class="c1"># For now let&#39;s just debug with one file</span>
</span><span id="BarET-210"><a href="#BarET-210"><span class="linenos">210</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="BarET-211"><a href="#BarET-211"><span class="linenos">211</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: currently ignoring multiple files&#39;</span><span class="p">)</span>
</span><span id="BarET-212"><a href="#BarET-212"><span class="linenos">212</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">valid_inds</span><span class="p">)</span>
</span><span id="BarET-213"><a href="#BarET-213"><span class="linenos">213</span></a>        
</span><span id="BarET-214"><a href="#BarET-214"><span class="linenos">214</span></a>        <span class="c1"># PULL OTHER INFO</span>
</span><span id="BarET-215"><a href="#BarET-215"><span class="linenos">215</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ETtraceHR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;ETtrace_raw&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET-216"><a href="#BarET-216"><span class="linenos">216</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sort_rating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs_rating&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="BarET-217"><a href="#BarET-217"><span class="linenos">217</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sort_ratingMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU_rating&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span>
</span><span id="BarET-218"><a href="#BarET-218"><span class="linenos">218</span></a>
</span><span id="BarET-219"><a href="#BarET-219"><span class="linenos">219</span></a>        <span class="c1"># Go through saccades to establish val_indices and produce saccade timing vector </span>
</span><span id="BarET-220"><a href="#BarET-220"><span class="linenos">220</span></a>        <span class="c1">#print(&quot;Loading data into memory...&quot;)</span>
</span><span id="BarET-221"><a href="#BarET-221"><span class="linenos">221</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preload_numpy</span><span class="p">()</span>
</span><span id="BarET-222"><a href="#BarET-222"><span class="linenos">222</span></a>
</span><span id="BarET-223"><a href="#BarET-223"><span class="linenos">223</span></a>        <span class="c1"># Have data_filters represend used_inds (in case it gets through)</span>
</span><span id="BarET-224"><a href="#BarET-224"><span class="linenos">224</span></a>        <span class="n">unified_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET-225"><a href="#BarET-225"><span class="linenos">225</span></a>        <span class="n">unified_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="BarET-226"><a href="#BarET-226"><span class="linenos">226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*=</span> <span class="n">unified_df</span>
</span><span id="BarET-227"><a href="#BarET-227"><span class="linenos">227</span></a>
</span><span id="BarET-228"><a href="#BarET-228"><span class="linenos">228</span></a>        <span class="c1"># Prepare design matrix for drift (on trial-by-trial basis)</span>
</span><span id="BarET-229"><a href="#BarET-229"><span class="linenos">229</span></a>        <span class="c1">#self.Xdrift = np.zeros([self.NT, len(self.block_inds)//], dtype=np.float32)</span>
</span><span id="BarET-230"><a href="#BarET-230"><span class="linenos">230</span></a>        <span class="c1">#for nn in range(len(self.block_inds)):</span>
</span><span id="BarET-231"><a href="#BarET-231"><span class="linenos">231</span></a>        <span class="c1">#    self.Xdrift[self.block_inds[nn], nn] = 1.0</span>
</span><span id="BarET-232"><a href="#BarET-232"><span class="linenos">232</span></a>        <span class="n">NBL</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="BarET-233"><a href="#BarET-233"><span class="linenos">233</span></a>        <span class="n">Nanchors</span> <span class="o">=</span> <span class="n">NBL</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span>
</span><span id="BarET-234"><a href="#BarET-234"><span class="linenos">234</span></a>        <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="BarET-235"><a href="#BarET-235"><span class="linenos">235</span></a>        <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">):</span>
</span><span id="BarET-236"><a href="#BarET-236"><span class="linenos">236</span></a>            <span class="n">anchors</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span><span class="o">*</span><span class="n">bb</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BarET-237"><a href="#BarET-237"><span class="linenos">237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="BarET-238"><a href="#BarET-238"><span class="linenos">238</span></a>
</span><span id="BarET-239"><a href="#BarET-239"><span class="linenos">239</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">process_fixations</span><span class="p">()</span>
</span><span id="BarET-240"><a href="#BarET-240"><span class="linenos">240</span></a>
</span><span id="BarET-241"><a href="#BarET-241"><span class="linenos">241</span></a>        <span class="c1"># Convert data to tensors</span>
</span><span id="BarET-242"><a href="#BarET-242"><span class="linenos">242</span></a>        <span class="c1">#if self.device is not None:</span>
</span><span id="BarET-243"><a href="#BarET-243"><span class="linenos">243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET-244"><a href="#BarET-244"><span class="linenos">244</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>
</span><span id="BarET-245"><a href="#BarET-245"><span class="linenos">245</span></a>
</span><span id="BarET-246"><a href="#BarET-246"><span class="linenos">246</span></a>        <span class="c1"># Create valid indices and first pass of cross-validation indices</span>
</span><span id="BarET-247"><a href="#BarET-247"><span class="linenos">247</span></a>        <span class="c1">#self.create_valid_indices()</span>
</span><span id="BarET-248"><a href="#BarET-248"><span class="linenos">248</span></a>        <span class="c1"># Develop default train, validation, and test datasets </span>
</span><span id="BarET-249"><a href="#BarET-249"><span class="linenos">249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crossval_setup</span><span class="p">()</span>
</span><span id="BarET-250"><a href="#BarET-250"><span class="linenos">250</span></a>
</span><span id="BarET-251"><a href="#BarET-251"><span class="linenos">251</span></a>        <span class="c1"># Fix Xdrift to remove test and validation sets</span>
</span><span id="BarET-252"><a href="#BarET-252"><span class="linenos">252</span></a>        <span class="c1">#self.adjust_Xdrift_xval()</span>
</span><span id="BarET-253"><a href="#BarET-253"><span class="linenos">253</span></a>        <span class="k">if</span> <span class="n">time_embed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># then call assemble_stimulus in the constructor</span>
</span><span id="BarET-254"><a href="#BarET-254"><span class="linenos">254</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">assemble_stimulus</span><span class="p">(</span>
</span><span id="BarET-255"><a href="#BarET-255"><span class="linenos">255</span></a>                <span class="n">combine_stim</span><span class="o">=</span><span class="n">combine_stim</span><span class="p">,</span> <span class="n">stim_crop</span><span class="o">=</span><span class="n">stim_crop</span><span class="p">,</span>
</span><span id="BarET-256"><a href="#BarET-256"><span class="linenos">256</span></a>                <span class="n">time_embed</span><span class="o">=</span><span class="n">time_embed</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">num_lags</span><span class="p">,</span>
</span><span id="BarET-257"><a href="#BarET-257"><span class="linenos">257</span></a>                <span class="n">Hshift</span><span class="o">=</span><span class="n">Hstim_shift</span><span class="p">,</span> <span class="n">Hdiscardzero</span><span class="o">=</span><span class="n">Hdiscardzero</span><span class="p">)</span>
</span><span id="BarET-258"><a href="#BarET-258"><span class="linenos">258</span></a>        <span class="c1"># Otherwise leave for the future</span>
</span><span id="BarET-259"><a href="#BarET-259"><span class="linenos">259</span></a>
</span><span id="BarET-260"><a href="#BarET-260"><span class="linenos">260</span></a>        <span class="c1"># Reflects block structure</span>
</span><span id="BarET-261"><a href="#BarET-261"><span class="linenos">261</span></a>        <span class="c1">#vblks, trblks = self.fold_sample(len(self.block_inds), 5, random_gen=True)</span>
</span><span id="BarET-262"><a href="#BarET-262"><span class="linenos">262</span></a>        <span class="c1">#self.train_inds = []</span>
</span><span id="BarET-263"><a href="#BarET-263"><span class="linenos">263</span></a>        <span class="c1">#for nn in trblks:</span>
</span><span id="BarET-264"><a href="#BarET-264"><span class="linenos">264</span></a>        <span class="c1">#    self.train_inds += list(deepcopy(self.block_inds[nn]))</span>
</span><span id="BarET-265"><a href="#BarET-265"><span class="linenos">265</span></a>        <span class="c1">#self.val_inds = []</span>
</span><span id="BarET-266"><a href="#BarET-266"><span class="linenos">266</span></a>        <span class="c1">#for nn in vblks:</span>
</span><span id="BarET-267"><a href="#BarET-267"><span class="linenos">267</span></a>        <span class="c1">#    self.val_inds += list(deepcopy(self.block_inds[nn]))</span>
</span><span id="BarET-268"><a href="#BarET-268"><span class="linenos">268</span></a>        <span class="c1">#self.train_inds = np.array(self.train_inds, dtype=np.int64)</span>
</span><span id="BarET-269"><a href="#BarET-269"><span class="linenos">269</span></a>        <span class="c1">#self.val_inds = np.array(self.val_inds, dtype=np.int64)</span>
</span><span id="BarET-270"><a href="#BarET-270"><span class="linenos">270</span></a>    <span class="c1"># END ColorClouds.__init__</span>
</span><span id="BarET-271"><a href="#BarET-271"><span class="linenos">271</span></a>
</span><span id="BarET-272"><a href="#BarET-272"><span class="linenos">272</span></a>    <span class="k">def</span> <span class="nf">preload_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BarET-273"><a href="#BarET-273"><span class="linenos">273</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET-274"><a href="#BarET-274"><span class="linenos">274</span></a><span class="sd">        Note this loads stimulus but does not time-embed</span>
</span><span id="BarET-275"><a href="#BarET-275"><span class="linenos">275</span></a><span class="sd">        </span>
</span><span id="BarET-276"><a href="#BarET-276"><span class="linenos">276</span></a><span class="sd">        Args:</span>
</span><span id="BarET-277"><a href="#BarET-277"><span class="linenos">277</span></a><span class="sd">            None</span>
</span><span id="BarET-278"><a href="#BarET-278"><span class="linenos">278</span></a>
</span><span id="BarET-279"><a href="#BarET-279"><span class="linenos">279</span></a><span class="sd">        Returns:</span>
</span><span id="BarET-280"><a href="#BarET-280"><span class="linenos">280</span></a><span class="sd">            None: loads into self.stim, self.robs, self.dfs, self.fix_n, self.Xdrift</span>
</span><span id="BarET-281"><a href="#BarET-281"><span class="linenos">281</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET-282"><a href="#BarET-282"><span class="linenos">282</span></a>
</span><span id="BarET-283"><a href="#BarET-283"><span class="linenos">283</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span><span id="BarET-284"><a href="#BarET-284"><span class="linenos">284</span></a>        <span class="n">NX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="BarET-285"><a href="#BarET-285"><span class="linenos">285</span></a>        <span class="n">NX2</span> <span class="o">=</span> <span class="n">NX</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_gap</span>
</span><span id="BarET-286"><a href="#BarET-286"><span class="linenos">286</span></a>
</span><span id="BarET-287"><a href="#BarET-287"><span class="linenos">287</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="BarET-288"><a href="#BarET-288"><span class="linenos">288</span></a><span class="sd">        Pre-allocate memory for data</span>
</span><span id="BarET-289"><a href="#BarET-289"><span class="linenos">289</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="BarET-290"><a href="#BarET-290"><span class="linenos">290</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET-291"><a href="#BarET-291"><span class="linenos">291</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET-292"><a href="#BarET-292"><span class="linenos">292</span></a>
</span><span id="BarET-293"><a href="#BarET-293"><span class="linenos">293</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET-294"><a href="#BarET-294"><span class="linenos">294</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET-295"><a href="#BarET-295"><span class="linenos">295</span></a>        <span class="c1">#self.eyepos = np.zeros([NT, 2], dtype=np.float32)</span>
</span><span id="BarET-296"><a href="#BarET-296"><span class="linenos">296</span></a>        <span class="c1">#self.frame_times = np.zeros([NT,1], dtype=np.float32)</span>
</span><span id="BarET-297"><a href="#BarET-297"><span class="linenos">297</span></a>
</span><span id="BarET-298"><a href="#BarET-298"><span class="linenos">298</span></a>        <span class="n">t_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BarET-299"><a href="#BarET-299"><span class="linenos">299</span></a>        <span class="n">unit_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BarET-300"><a href="#BarET-300"><span class="linenos">300</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">)):</span>
</span><span id="BarET-301"><a href="#BarET-301"><span class="linenos">301</span></a>            
</span><span id="BarET-302"><a href="#BarET-302"><span class="linenos">302</span></a>            <span class="n">fhandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="BarET-303"><a href="#BarET-303"><span class="linenos">303</span></a>            <span class="n">sz</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="BarET-304"><a href="#BarET-304"><span class="linenos">304</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_counter</span><span class="p">,</span> <span class="n">t_counter</span><span class="o">+</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="BarET-305"><a href="#BarET-305"><span class="linenos">305</span></a>            <span class="c1">#inds = self.stim_indices[expt][stim][&#39;inds&#39;]</span>
</span><span id="BarET-306"><a href="#BarET-306"><span class="linenos">306</span></a>            <span class="c1">#self.stim[inds, ...] = np.transpose( np.array(fhandle[self.stimname], dtype=np.float32), axes=[0,3,1,2])</span>
</span><span id="BarET-307"><a href="#BarET-307"><span class="linenos">307</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET-308"><a href="#BarET-308"><span class="linenos">308</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tmp_stim</span><span class="p">)</span>
</span><span id="BarET-309"><a href="#BarET-309"><span class="linenos">309</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp_stim</span>
</span><span id="BarET-310"><a href="#BarET-310"><span class="linenos">310</span></a>            <span class="n">stim_ori</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimETori&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="BarET-311"><a href="#BarET-311"><span class="linenos">311</span></a>            <span class="n">Hinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_ori</span> <span class="o">&gt;</span> <span class="mi">45</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BarET-312"><a href="#BarET-312"><span class="linenos">312</span></a>            <span class="n">Vinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_ori</span> <span class="o">&lt;</span> <span class="mi">45</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BarET-313"><a href="#BarET-313"><span class="linenos">313</span></a>
</span><span id="BarET-314"><a href="#BarET-314"><span class="linenos">314</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">Vinds</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="BarET-315"><a href="#BarET-315"><span class="linenos">315</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">Hinds</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="BarET-316"><a href="#BarET-316"><span class="linenos">316</span></a>
</span><span id="BarET-317"><a href="#BarET-317"><span class="linenos">317</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Robs and DATAFILTERS&quot;&quot;&quot;</span>
</span><span id="BarET-318"><a href="#BarET-318"><span class="linenos">318</span></a>            <span class="n">robs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="BarET-319"><a href="#BarET-319"><span class="linenos">319</span></a>            <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="BarET-320"><a href="#BarET-320"><span class="linenos">320</span></a>            <span class="n">num_SUs</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="BarET-321"><a href="#BarET-321"><span class="linenos">321</span></a>            <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_SUs</span><span class="p">)</span>
</span><span id="BarET-322"><a href="#BarET-322"><span class="linenos">322</span></a>            <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET-323"><a href="#BarET-323"><span class="linenos">323</span></a>            <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;datafilts&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET-324"><a href="#BarET-324"><span class="linenos">324</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="BarET-325"><a href="#BarET-325"><span class="linenos">325</span></a>                <span class="n">num_MUs</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="BarET-326"><a href="#BarET-326"><span class="linenos">326</span></a>                <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="o">+</span><span class="n">num_SUs</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_SUs</span><span class="o">+</span><span class="n">num_MUs</span><span class="p">)</span>
</span><span id="BarET-327"><a href="#BarET-327"><span class="linenos">327</span></a>                <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET-328"><a href="#BarET-328"><span class="linenos">328</span></a>                <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;datafiltsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET-329"><a href="#BarET-329"><span class="linenos">329</span></a>            
</span><span id="BarET-330"><a href="#BarET-330"><span class="linenos">330</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">robs_tmp</span><span class="p">)</span>
</span><span id="BarET-331"><a href="#BarET-331"><span class="linenos">331</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dfs_tmp</span><span class="p">)</span>
</span><span id="BarET-332"><a href="#BarET-332"><span class="linenos">332</span></a>
</span><span id="BarET-333"><a href="#BarET-333"><span class="linenos">333</span></a>            <span class="n">t_counter</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BarET-334"><a href="#BarET-334"><span class="linenos">334</span></a>            <span class="n">unit_counter</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="BarET-335"><a href="#BarET-335"><span class="linenos">335</span></a>
</span><span id="BarET-336"><a href="#BarET-336"><span class="linenos">336</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span> <span class="o">=</span> <span class="s1">&#39;stim&#39;</span>  <span class="c1"># not sure what this does</span>
</span><span id="BarET-337"><a href="#BarET-337"><span class="linenos">337</span></a>
</span><span id="BarET-338"><a href="#BarET-338"><span class="linenos">338</span></a>        <span class="c1"># Make combined stim (in case used)</span>
</span><span id="BarET-339"><a href="#BarET-339"><span class="linenos">339</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">NX2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET-340"><a href="#BarET-340"><span class="linenos">340</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">)</span>
</span><span id="BarET-341"><a href="#BarET-341"><span class="linenos">341</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">NX</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_gap</span><span class="p">,</span> <span class="n">NX2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">)</span>
</span><span id="BarET-342"><a href="#BarET-342"><span class="linenos">342</span></a>
</span><span id="BarET-343"><a href="#BarET-343"><span class="linenos">343</span></a>    <span class="c1"># END Bar1D.preload_numpy()</span>
</span><span id="BarET-344"><a href="#BarET-344"><span class="linenos">344</span></a>
</span><span id="BarET-345"><a href="#BarET-345"><span class="linenos">345</span></a>    <span class="k">def</span> <span class="nf">assemble_stimulus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="BarET-346"><a href="#BarET-346"><span class="linenos">346</span></a>        <span class="n">combine_stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="BarET-347"><a href="#BarET-347"><span class="linenos">347</span></a>        <span class="n">time_embed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> 
</span><span id="BarET-348"><a href="#BarET-348"><span class="linenos">348</span></a>        <span class="n">Hshift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Hdiscardzero</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
</span><span id="BarET-349"><a href="#BarET-349"><span class="linenos">349</span></a>        <span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">BUF</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
</span><span id="BarET-350"><a href="#BarET-350"><span class="linenos">350</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET-351"><a href="#BarET-351"><span class="linenos">351</span></a><span class="sd">        Assembles stimulus for the dataset</span>
</span><span id="BarET-352"><a href="#BarET-352"><span class="linenos">352</span></a><span class="sd">        -- This will also time-embed the stimulus if requested</span>
</span><span id="BarET-353"><a href="#BarET-353"><span class="linenos">353</span></a><span class="sd">        -- This will also shift the stimulus if requested</span>
</span><span id="BarET-354"><a href="#BarET-354"><span class="linenos">354</span></a><span class="sd">        -- This will also crop the stimulus if requested</span>
</span><span id="BarET-355"><a href="#BarET-355"><span class="linenos">355</span></a>
</span><span id="BarET-356"><a href="#BarET-356"><span class="linenos">356</span></a><span class="sd">        Args:</span>
</span><span id="BarET-357"><a href="#BarET-357"><span class="linenos">357</span></a><span class="sd">            combine_stim: whether to combine horizontal and vertical stimulus</span>
</span><span id="BarET-358"><a href="#BarET-358"><span class="linenos">358</span></a><span class="sd">            stim_crop: whether to crop stimulus (not implemented)</span>
</span><span id="BarET-359"><a href="#BarET-359"><span class="linenos">359</span></a><span class="sd">            time_embed: 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="BarET-360"><a href="#BarET-360"><span class="linenos">360</span></a><span class="sd">            num_lags: number of lags to include in time-embedding</span>
</span><span id="BarET-361"><a href="#BarET-361"><span class="linenos">361</span></a><span class="sd">            Hshift: how much to shift horizontal stimulus (in bars)</span>
</span><span id="BarET-362"><a href="#BarET-362"><span class="linenos">362</span></a><span class="sd">            Hdiscardzero: whether to discard zero position in horizontal stimulus</span>
</span><span id="BarET-363"><a href="#BarET-363"><span class="linenos">363</span></a><span class="sd">            shifts: shifts to apply to stimulus (if not None)</span>
</span><span id="BarET-364"><a href="#BarET-364"><span class="linenos">364</span></a><span class="sd">            BUF: buffer for shifting stimulus</span>
</span><span id="BarET-365"><a href="#BarET-365"><span class="linenos">365</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET-366"><a href="#BarET-366"><span class="linenos">366</span></a>
</span><span id="BarET-367"><a href="#BarET-367"><span class="linenos">367</span></a>        <span class="k">if</span> <span class="n">combine_stim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BarET-368"><a href="#BarET-368"><span class="linenos">368</span></a>            <span class="n">combine_stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span>
</span><span id="BarET-369"><a href="#BarET-369"><span class="linenos">369</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BarET-370"><a href="#BarET-370"><span class="linenos">370</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span> <span class="o">=</span> <span class="n">combine_stim</span>
</span><span id="BarET-371"><a href="#BarET-371"><span class="linenos">371</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimHshift</span> <span class="o">=</span> <span class="n">Hshift</span>
</span><span id="BarET-372"><a href="#BarET-372"><span class="linenos">372</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Hdiscardzero</span> <span class="o">=</span> <span class="n">Hdiscardzero</span>
</span><span id="BarET-373"><a href="#BarET-373"><span class="linenos">373</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="o">=</span> <span class="n">stim_crop</span>
</span><span id="BarET-374"><a href="#BarET-374"><span class="linenos">374</span></a>
</span><span id="BarET-375"><a href="#BarET-375"><span class="linenos">375</span></a>        <span class="k">if</span> <span class="n">stim_crop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BarET-376"><a href="#BarET-376"><span class="linenos">376</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;stimulus cropping not implemented yet&#39;</span><span class="p">)</span>
</span><span id="BarET-377"><a href="#BarET-377"><span class="linenos">377</span></a>
</span><span id="BarET-378"><a href="#BarET-378"><span class="linenos">378</span></a>        <span class="c1"># Assemble/shift horizontal stim</span>
</span><span id="BarET-379"><a href="#BarET-379"><span class="linenos">379</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Assembling stimulus&quot;</span><span class="p">)</span>
</span><span id="BarET-380"><a href="#BarET-380"><span class="linenos">380</span></a>        <span class="n">sh</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Hshift</span><span class="p">)</span>
</span><span id="BarET-381"><a href="#BarET-381"><span class="linenos">381</span></a>        <span class="k">if</span> <span class="n">sh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET-382"><a href="#BarET-382"><span class="linenos">382</span></a>            <span class="n">Hstim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span>
</span><span id="BarET-383"><a href="#BarET-383"><span class="linenos">383</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BarET-384"><a href="#BarET-384"><span class="linenos">384</span></a>            <span class="n">Lc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span> <span class="o">-</span> <span class="n">sh</span>
</span><span id="BarET-385"><a href="#BarET-385"><span class="linenos">385</span></a>            <span class="n">Hstim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET-386"><a href="#BarET-386"><span class="linenos">386</span></a>            <span class="k">if</span> <span class="n">Hdiscardzero</span><span class="p">:</span>
</span><span id="BarET-387"><a href="#BarET-387"><span class="linenos">387</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Discarding stim at 0 horizontal position&#39;</span><span class="p">)</span>
</span><span id="BarET-388"><a href="#BarET-388"><span class="linenos">388</span></a>                <span class="k">if</span> <span class="n">Hshift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET-389"><a href="#BarET-389"><span class="linenos">389</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="BarET-390"><a href="#BarET-390"><span class="linenos">390</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">sh</span><span class="p">)])</span>
</span><span id="BarET-391"><a href="#BarET-391"><span class="linenos">391</span></a>                <span class="k">elif</span> <span class="n">Hshift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET-392"><a href="#BarET-392"><span class="linenos">392</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Lc</span><span class="p">)])</span>
</span><span id="BarET-393"><a href="#BarET-393"><span class="linenos">393</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="BarET-394"><a href="#BarET-394"><span class="linenos">394</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="BarET-395"><a href="#BarET-395"><span class="linenos">395</span></a>                <span class="k">if</span> <span class="n">Hshift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET-396"><a href="#BarET-396"><span class="linenos">396</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="BarET-397"><a href="#BarET-397"><span class="linenos">397</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)])</span>
</span><span id="BarET-398"><a href="#BarET-398"><span class="linenos">398</span></a>                <span class="k">elif</span> <span class="n">Hshift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET-399"><a href="#BarET-399"><span class="linenos">399</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)])</span>
</span><span id="BarET-400"><a href="#BarET-400"><span class="linenos">400</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="BarET-401"><a href="#BarET-401"><span class="linenos">401</span></a>            <span class="c1"># Reassemble stimC</span>
</span><span id="BarET-402"><a href="#BarET-402"><span class="linenos">402</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Hstim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">Hstim</span><span class="p">)</span>
</span><span id="BarET-403"><a href="#BarET-403"><span class="linenos">403</span></a>   
</span><span id="BarET-404"><a href="#BarET-404"><span class="linenos">404</span></a>        <span class="c1"># Time embed horizontal and vertical stim</span>
</span><span id="BarET-405"><a href="#BarET-405"><span class="linenos">405</span></a>        <span class="k">if</span> <span class="n">time_embed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="BarET-406"><a href="#BarET-406"><span class="linenos">406</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Time embedding...&quot;</span><span class="p">)</span>
</span><span id="BarET-407"><a href="#BarET-407"><span class="linenos">407</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="BarET-408"><a href="#BarET-408"><span class="linenos">408</span></a>            <span class="n">tmp_stimH</span> <span class="o">=</span> <span class="n">Hstim</span><span class="p">[</span><span class="n">idx</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="BarET-409"><a href="#BarET-409"><span class="linenos">409</span></a>            <span class="n">tmp_stimV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">idx</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="BarET-410"><a href="#BarET-410"><span class="linenos">410</span></a>
</span><span id="BarET-411"><a href="#BarET-411"><span class="linenos">411</span></a>            <span class="n">tmp_stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimH</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="BarET-412"><a href="#BarET-412"><span class="linenos">412</span></a>            <span class="n">tmp_stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimV</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="BarET-413"><a href="#BarET-413"><span class="linenos">413</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="BarET-414"><a href="#BarET-414"><span class="linenos">414</span></a>                <span class="n">tmp_stimC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[</span><span class="n">idx</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="BarET-415"><a href="#BarET-415"><span class="linenos">415</span></a>                <span class="n">tmp_stimC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimC</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="BarET-416"><a href="#BarET-416"><span class="linenos">416</span></a>
</span><span id="BarET-417"><a href="#BarET-417"><span class="linenos">417</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="n">Hstim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BarET-418"><a href="#BarET-418"><span class="linenos">418</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimHout</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">tmp_stimH</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET-419"><a href="#BarET-419"><span class="linenos">419</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dimsH</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">tmp_stimH</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_lags</span><span class="p">]</span>
</span><span id="BarET-420"><a href="#BarET-420"><span class="linenos">420</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimVout</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">tmp_stimV</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET-421"><a href="#BarET-421"><span class="linenos">421</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dimsV</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">tmp_stimV</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_lags</span><span class="p">]</span>
</span><span id="BarET-422"><a href="#BarET-422"><span class="linenos">422</span></a>        
</span><span id="BarET-423"><a href="#BarET-423"><span class="linenos">423</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="BarET-424"><a href="#BarET-424"><span class="linenos">424</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">tmp_stimC</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_lags</span><span class="p">]</span>
</span><span id="BarET-425"><a href="#BarET-425"><span class="linenos">425</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> 
</span><span id="BarET-426"><a href="#BarET-426"><span class="linenos">426</span></a>                <span class="n">tmp_stimC</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">tmp_stimC</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> 
</span><span id="BarET-427"><a href="#BarET-427"><span class="linenos">427</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET-428"><a href="#BarET-428"><span class="linenos">428</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="BarET-429"><a href="#BarET-429"><span class="linenos">429</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_dimsH</span><span class="p">)</span>
</span><span id="BarET-430"><a href="#BarET-430"><span class="linenos">430</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimHout</span><span class="p">)</span>
</span><span id="BarET-431"><a href="#BarET-431"><span class="linenos">431</span></a>    <span class="c1"># END BarET.assemble_stimulus()        </span>
</span><span id="BarET-432"><a href="#BarET-432"><span class="linenos">432</span></a>
</span><span id="BarET-433"><a href="#BarET-433"><span class="linenos">433</span></a>    <span class="k">def</span> <span class="nf">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="BarET-434"><a href="#BarET-434"><span class="linenos">434</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET-435"><a href="#BarET-435"><span class="linenos">435</span></a><span class="sd">        Converts all data to tensors</span>
</span><span id="BarET-436"><a href="#BarET-436"><span class="linenos">436</span></a>
</span><span id="BarET-437"><a href="#BarET-437"><span class="linenos">437</span></a><span class="sd">        Args:</span>
</span><span id="BarET-438"><a href="#BarET-438"><span class="linenos">438</span></a><span class="sd">            device: torch device to move data to</span>
</span><span id="BarET-439"><a href="#BarET-439"><span class="linenos">439</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET-440"><a href="#BarET-440"><span class="linenos">440</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="BarET-441"><a href="#BarET-441"><span class="linenos">441</span></a>            <span class="c1"># then already converted: just moving device</span>
</span><span id="BarET-442"><a href="#BarET-442"><span class="linenos">442</span></a>            <span class="c1">#self.stimH = self.stimH.to(device)</span>
</span><span id="BarET-443"><a href="#BarET-443"><span class="linenos">443</span></a>            <span class="c1">#self.stimV = self.stimV.to(device)</span>
</span><span id="BarET-444"><a href="#BarET-444"><span class="linenos">444</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET-445"><a href="#BarET-445"><span class="linenos">445</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET-446"><a href="#BarET-446"><span class="linenos">446</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET-447"><a href="#BarET-447"><span class="linenos">447</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET-448"><a href="#BarET-448"><span class="linenos">448</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="BarET-449"><a href="#BarET-449"><span class="linenos">449</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET-450"><a href="#BarET-450"><span class="linenos">450</span></a>
</span><span id="BarET-451"><a href="#BarET-451"><span class="linenos">451</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BarET-452"><a href="#BarET-452"><span class="linenos">452</span></a>            <span class="c1">#self.stimH = torch.tensor(self.stimH, dtype=torch.float32, device=device)</span>
</span><span id="BarET-453"><a href="#BarET-453"><span class="linenos">453</span></a>            <span class="c1">#self.stimV = torch.tensor(self.stimV, dtype=torch.float32, device=device)</span>
</span><span id="BarET-454"><a href="#BarET-454"><span class="linenos">454</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET-455"><a href="#BarET-455"><span class="linenos">455</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET-456"><a href="#BarET-456"><span class="linenos">456</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET-457"><a href="#BarET-457"><span class="linenos">457</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET-458"><a href="#BarET-458"><span class="linenos">458</span></a>            <span class="c1">#if self.combine_stim:</span>
</span><span id="BarET-459"><a href="#BarET-459"><span class="linenos">459</span></a>            <span class="c1">#    self.stimC = torch.tensor(self.stimC, dtype=torch.float32, device=device)</span>
</span><span id="BarET-460"><a href="#BarET-460"><span class="linenos">460</span></a>    <span class="c1"># END Bar1D.to_tensor</span>
</span><span id="BarET-461"><a href="#BarET-461"><span class="linenos">461</span></a>
</span><span id="BarET-462"><a href="#BarET-462"><span class="linenos">462</span></a>    <span class="k">def</span> <span class="nf">process_fixations</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sacc_in</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="BarET-463"><a href="#BarET-463"><span class="linenos">463</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET-464"><a href="#BarET-464"><span class="linenos">464</span></a><span class="sd">        Processes fixation informatiom from dataset, but also allows new saccade detection</span>
</span><span id="BarET-465"><a href="#BarET-465"><span class="linenos">465</span></a><span class="sd">        to be input and put in the right format within the dataset (main use).</span>
</span><span id="BarET-466"><a href="#BarET-466"><span class="linenos">466</span></a><span class="sd">        </span>
</span><span id="BarET-467"><a href="#BarET-467"><span class="linenos">467</span></a><span class="sd">        Args:</span>
</span><span id="BarET-468"><a href="#BarET-468"><span class="linenos">468</span></a><span class="sd">            sacc_in: new saccade information to be processed</span>
</span><span id="BarET-469"><a href="#BarET-469"><span class="linenos">469</span></a>
</span><span id="BarET-470"><a href="#BarET-470"><span class="linenos">470</span></a><span class="sd">        Returns:</span>
</span><span id="BarET-471"><a href="#BarET-471"><span class="linenos">471</span></a><span class="sd">            None: sets self.fix_n</span>
</span><span id="BarET-472"><a href="#BarET-472"><span class="linenos">472</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET-473"><a href="#BarET-473"><span class="linenos">473</span></a>        <span class="k">if</span> <span class="n">sacc_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BarET-474"><a href="#BarET-474"><span class="linenos">474</span></a>            <span class="n">sacc_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="BarET-475"><a href="#BarET-475"><span class="linenos">475</span></a>
</span><span id="BarET-476"><a href="#BarET-476"><span class="linenos">476</span></a>        <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> 
</span><span id="BarET-477"><a href="#BarET-477"><span class="linenos">477</span></a>        <span class="n">fix_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BarET-478"><a href="#BarET-478"><span class="linenos">478</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)):</span>
</span><span id="BarET-479"><a href="#BarET-479"><span class="linenos">479</span></a>            <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="BarET-480"><a href="#BarET-480"><span class="linenos">480</span></a>            <span class="c1">#self.block_inds.append(np.arange( blk_inds[ii,0], blk_inds[ii,1], dtype=np.int64))</span>
</span><span id="BarET-481"><a href="#BarET-481"><span class="linenos">481</span></a>
</span><span id="BarET-482"><a href="#BarET-482"><span class="linenos">482</span></a>            <span class="c1"># Parse fixation numbers within block</span>
</span><span id="BarET-483"><a href="#BarET-483"><span class="linenos">483</span></a>            <span class="n">rel_saccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">sacc_in</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sacc_in</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BarET-484"><a href="#BarET-484"><span class="linenos">484</span></a>
</span><span id="BarET-485"><a href="#BarET-485"><span class="linenos">485</span></a>            <span class="n">tfix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Beginning of fixation by definition</span>
</span><span id="BarET-486"><a href="#BarET-486"><span class="linenos">486</span></a>            <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel_saccs</span><span class="p">)):</span>
</span><span id="BarET-487"><a href="#BarET-487"><span class="linenos">487</span></a>                <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="BarET-488"><a href="#BarET-488"><span class="linenos">488</span></a>                <span class="c1"># Range goes to beginning of next fixation (note no gap)</span>
</span><span id="BarET-489"><a href="#BarET-489"><span class="linenos">489</span></a>                <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="BarET-490"><a href="#BarET-490"><span class="linenos">490</span></a>                <span class="n">tfix</span> <span class="o">=</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">6</span>
</span><span id="BarET-491"><a href="#BarET-491"><span class="linenos">491</span></a>            <span class="c1"># Put in last (or only) fixation number</span>
</span><span id="BarET-492"><a href="#BarET-492"><span class="linenos">492</span></a>            <span class="k">if</span> <span class="n">tfix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="BarET-493"><a href="#BarET-493"><span class="linenos">493</span></a>                <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="BarET-494"><a href="#BarET-494"><span class="linenos">494</span></a>                <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="BarET-495"><a href="#BarET-495"><span class="linenos">495</span></a>
</span><span id="BarET-496"><a href="#BarET-496"><span class="linenos">496</span></a>        <span class="c1"># Determine whether to be numpy or tensor</span>
</span><span id="BarET-497"><a href="#BarET-497"><span class="linenos">497</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="BarET-498"><a href="#BarET-498"><span class="linenos">498</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET-499"><a href="#BarET-499"><span class="linenos">499</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BarET-500"><a href="#BarET-500"><span class="linenos">500</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">fix_n</span>
</span><span id="BarET-501"><a href="#BarET-501"><span class="linenos">501</span></a>    <span class="c1"># END: Bar1D.process_fixations()</span>
</span><span id="BarET-502"><a href="#BarET-502"><span class="linenos">502</span></a>
</span><span id="BarET-503"><a href="#BarET-503"><span class="linenos">503</span></a>    <span class="k">def</span> <span class="nf">add_shifter</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">shifts</span> <span class="p">):</span>
</span><span id="BarET-504"><a href="#BarET-504"><span class="linenos">504</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET-505"><a href="#BarET-505"><span class="linenos">505</span></a><span class="sd">        Adds a shifter to the dataset</span>
</span><span id="BarET-506"><a href="#BarET-506"><span class="linenos">506</span></a>
</span><span id="BarET-507"><a href="#BarET-507"><span class="linenos">507</span></a><span class="sd">        Args:</span>
</span><span id="BarET-508"><a href="#BarET-508"><span class="linenos">508</span></a><span class="sd">            shifts: shifts to apply to the stimulus</span>
</span><span id="BarET-509"><a href="#BarET-509"><span class="linenos">509</span></a>
</span><span id="BarET-510"><a href="#BarET-510"><span class="linenos">510</span></a><span class="sd">        Returns:</span>
</span><span id="BarET-511"><a href="#BarET-511"><span class="linenos">511</span></a><span class="sd">            None: sets self.shifts</span>
</span><span id="BarET-512"><a href="#BarET-512"><span class="linenos">512</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET-513"><a href="#BarET-513"><span class="linenos">513</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">shifts</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">),</span> <span class="s2">&quot;Entered shifts is wrong size.&quot;</span>
</span><span id="BarET-514"><a href="#BarET-514"><span class="linenos">514</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span><span class="p">:</span>
</span><span id="BarET-515"><a href="#BarET-515"><span class="linenos">515</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="BarET-516"><a href="#BarET-516"><span class="linenos">516</span></a>        <span class="c1"># else: Delete old shifts?</span>
</span><span id="BarET-517"><a href="#BarET-517"><span class="linenos">517</span></a>        
</span><span id="BarET-518"><a href="#BarET-518"><span class="linenos">518</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">device</span>
</span><span id="BarET-519"><a href="#BarET-519"><span class="linenos">519</span></a>
</span><span id="BarET-520"><a href="#BarET-520"><span class="linenos">520</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">):</span>
</span><span id="BarET-521"><a href="#BarET-521"><span class="linenos">521</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="o">=</span> <span class="n">shifts</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET-522"><a href="#BarET-522"><span class="linenos">522</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BarET-523"><a href="#BarET-523"><span class="linenos">523</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET-524"><a href="#BarET-524"><span class="linenos">524</span></a>
</span><span id="BarET-525"><a href="#BarET-525"><span class="linenos">525</span></a>    <span class="k">def</span> <span class="nf">avrates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="BarET-526"><a href="#BarET-526"><span class="linenos">526</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET-527"><a href="#BarET-527"><span class="linenos">527</span></a><span class="sd">        Calculates average firing probability across specified inds (or whole dataset)</span>
</span><span id="BarET-528"><a href="#BarET-528"><span class="linenos">528</span></a><span class="sd">        -- Note will respect datafilters</span>
</span><span id="BarET-529"><a href="#BarET-529"><span class="linenos">529</span></a><span class="sd">        -- will return precalc value to save time if already stored</span>
</span><span id="BarET-530"><a href="#BarET-530"><span class="linenos">530</span></a>
</span><span id="BarET-531"><a href="#BarET-531"><span class="linenos">531</span></a><span class="sd">        Args:</span>
</span><span id="BarET-532"><a href="#BarET-532"><span class="linenos">532</span></a><span class="sd">            inds: indices to calculate across</span>
</span><span id="BarET-533"><a href="#BarET-533"><span class="linenos">533</span></a>
</span><span id="BarET-534"><a href="#BarET-534"><span class="linenos">534</span></a><span class="sd">        Returns:</span>
</span><span id="BarET-535"><a href="#BarET-535"><span class="linenos">535</span></a><span class="sd">            avRs: average firing rates across specified indices</span>
</span><span id="BarET-536"><a href="#BarET-536"><span class="linenos">536</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET-537"><a href="#BarET-537"><span class="linenos">537</span></a>        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BarET-538"><a href="#BarET-538"><span class="linenos">538</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="BarET-539"><a href="#BarET-539"><span class="linenos">539</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="BarET-540"><a href="#BarET-540"><span class="linenos">540</span></a>            <span class="c1"># then calculate across whole dataset</span>
</span><span id="BarET-541"><a href="#BarET-541"><span class="linenos">541</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BarET-542"><a href="#BarET-542"><span class="linenos">542</span></a>                <span class="c1"># then precalculated and do not need to do</span>
</span><span id="BarET-543"><a href="#BarET-543"><span class="linenos">543</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span>
</span><span id="BarET-544"><a href="#BarET-544"><span class="linenos">544</span></a>
</span><span id="BarET-545"><a href="#BarET-545"><span class="linenos">545</span></a>        <span class="c1"># Otherwise calculate across all data</span>
</span><span id="BarET-546"><a href="#BarET-546"><span class="linenos">546</span></a>        <span class="n">Reff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="BarET-547"><a href="#BarET-547"><span class="linenos">547</span></a>        <span class="n">Teff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="BarET-548"><a href="#BarET-548"><span class="linenos">548</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="o">/</span><span class="n">Teff</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="BarET-549"><a href="#BarET-549"><span class="linenos">549</span></a>    <span class="c1"># END .avrates()</span>
</span><span id="BarET-550"><a href="#BarET-550"><span class="linenos">550</span></a>
</span><span id="BarET-551"><a href="#BarET-551"><span class="linenos">551</span></a>    <span class="k">def</span> <span class="nf">apply_data_mask</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">dmask</span><span class="p">,</span> <span class="n">crange</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="BarET-552"><a href="#BarET-552"><span class="linenos">552</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET-553"><a href="#BarET-553"><span class="linenos">553</span></a><span class="sd">        For when data_filters (or a section) is modified based on models, and want to apply</span>
</span><span id="BarET-554"><a href="#BarET-554"><span class="linenos">554</span></a><span class="sd">        to the dataset. Ideally would save the original.</span>
</span><span id="BarET-555"><a href="#BarET-555"><span class="linenos">555</span></a><span class="sd">        </span>
</span><span id="BarET-556"><a href="#BarET-556"><span class="linenos">556</span></a><span class="sd">        Args:</span>
</span><span id="BarET-557"><a href="#BarET-557"><span class="linenos">557</span></a><span class="sd">            dmask: mask to apply to data_filters</span>
</span><span id="BarET-558"><a href="#BarET-558"><span class="linenos">558</span></a><span class="sd">            crange: range of cells to apply to</span>
</span><span id="BarET-559"><a href="#BarET-559"><span class="linenos">559</span></a>
</span><span id="BarET-560"><a href="#BarET-560"><span class="linenos">560</span></a><span class="sd">        Returns:</span>
</span><span id="BarET-561"><a href="#BarET-561"><span class="linenos">561</span></a><span class="sd">            None: sets self.dfs to new data mask</span>
</span><span id="BarET-562"><a href="#BarET-562"><span class="linenos">562</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET-563"><a href="#BarET-563"><span class="linenos">563</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dmask</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="BarET-564"><a href="#BarET-564"><span class="linenos">564</span></a>            <span class="n">dmask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dmask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET-565"><a href="#BarET-565"><span class="linenos">565</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dmask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="BarET-566"><a href="#BarET-566"><span class="linenos">566</span></a>            <span class="n">dmask</span> <span class="o">=</span> <span class="n">dmask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="BarET-567"><a href="#BarET-567"><span class="linenos">567</span></a>        <span class="n">NT</span><span class="p">,</span> <span class="n">mask_size</span> <span class="o">=</span> <span class="n">dmask</span><span class="o">.</span><span class="n">shape</span>
</span><span id="BarET-568"><a href="#BarET-568"><span class="linenos">568</span></a>        <span class="k">assert</span> <span class="n">NT</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="s2">&quot;Data mask is wrong length&quot;</span>
</span><span id="BarET-569"><a href="#BarET-569"><span class="linenos">569</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET-570"><a href="#BarET-570"><span class="linenos">570</span></a>            <span class="n">cells_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="BarET-571"><a href="#BarET-571"><span class="linenos">571</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BarET-572"><a href="#BarET-572"><span class="linenos">572</span></a>            <span class="n">cells_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="BarET-573"><a href="#BarET-573"><span class="linenos">573</span></a>        <span class="k">if</span> <span class="n">crange</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BarET-574"><a href="#BarET-574"><span class="linenos">574</span></a>            <span class="n">crange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells_out</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="BarET-575"><a href="#BarET-575"><span class="linenos">575</span></a>        <span class="k">assert</span> <span class="n">mask_size</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">crange</span><span class="p">),</span> <span class="s2">&quot;mask does not cover the right range&quot;</span>
</span><span id="BarET-576"><a href="#BarET-576"><span class="linenos">576</span></a>
</span><span id="BarET-577"><a href="#BarET-577"><span class="linenos">577</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BarET-578"><a href="#BarET-578"><span class="linenos">578</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">)</span>
</span><span id="BarET-579"><a href="#BarET-579"><span class="linenos">579</span></a>        <span class="c1"># Given all assertions worked, then make copy</span>
</span><span id="BarET-580"><a href="#BarET-580"><span class="linenos">580</span></a>
</span><span id="BarET-581"><a href="#BarET-581"><span class="linenos">581</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">cells_out</span><span class="p">[</span><span class="n">crange</span><span class="p">]]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dmask</span><span class="p">)</span>
</span><span id="BarET-582"><a href="#BarET-582"><span class="linenos">582</span></a>    <span class="c1"># END .apply_data_mask()</span>
</span><span id="BarET-583"><a href="#BarET-583"><span class="linenos">583</span></a>
</span><span id="BarET-584"><a href="#BarET-584"><span class="linenos">584</span></a>    <span class="k">def</span> <span class="nf">data_mask_revert</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">crange</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="BarET-585"><a href="#BarET-585"><span class="linenos">585</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET-586"><a href="#BarET-586"><span class="linenos">586</span></a><span class="sd">        Reverts data mask to original</span>
</span><span id="BarET-587"><a href="#BarET-587"><span class="linenos">587</span></a>
</span><span id="BarET-588"><a href="#BarET-588"><span class="linenos">588</span></a><span class="sd">        Args:</span>
</span><span id="BarET-589"><a href="#BarET-589"><span class="linenos">589</span></a><span class="sd">            crange: range of cells to revert</span>
</span><span id="BarET-590"><a href="#BarET-590"><span class="linenos">590</span></a>
</span><span id="BarET-591"><a href="#BarET-591"><span class="linenos">591</span></a><span class="sd">        Returns:</span>
</span><span id="BarET-592"><a href="#BarET-592"><span class="linenos">592</span></a><span class="sd">            None: sets self.dfs to original data mask</span>
</span><span id="BarET-593"><a href="#BarET-593"><span class="linenos">593</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET-594"><a href="#BarET-594"><span class="linenos">594</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Nothing to revert&quot;</span>
</span><span id="BarET-595"><a href="#BarET-595"><span class="linenos">595</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span><span class="p">)</span>
</span><span id="BarET-596"><a href="#BarET-596"><span class="linenos">596</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BarET-597"><a href="#BarET-597"><span class="linenos">597</span></a>
</span><span id="BarET-598"><a href="#BarET-598"><span class="linenos">598</span></a>    <span class="k">def</span> <span class="nf">shift_stim_fixation</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
</span><span id="BarET-599"><a href="#BarET-599"><span class="linenos">599</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET-600"><a href="#BarET-600"><span class="linenos">600</span></a><span class="sd">        Simple shift by integer (rounded shift) and zero padded. Note that this is not in </span>
</span><span id="BarET-601"><a href="#BarET-601"><span class="linenos">601</span></a><span class="sd">        is in units of number of bars, rather than -1 to +1. It assumes the stim</span>
</span><span id="BarET-602"><a href="#BarET-602"><span class="linenos">602</span></a><span class="sd">        has a batch dimension (over a fixation), and shifts the whole stim by the same amount.</span>
</span><span id="BarET-603"><a href="#BarET-603"><span class="linenos">603</span></a><span class="sd">        </span>
</span><span id="BarET-604"><a href="#BarET-604"><span class="linenos">604</span></a><span class="sd">        Args:</span>
</span><span id="BarET-605"><a href="#BarET-605"><span class="linenos">605</span></a><span class="sd">            stim: stimulus to shift</span>
</span><span id="BarET-606"><a href="#BarET-606"><span class="linenos">606</span></a><span class="sd">            shift: amount to shift stimulus</span>
</span><span id="BarET-607"><a href="#BarET-607"><span class="linenos">607</span></a>
</span><span id="BarET-608"><a href="#BarET-608"><span class="linenos">608</span></a><span class="sd">        Returns:</span>
</span><span id="BarET-609"><a href="#BarET-609"><span class="linenos">609</span></a><span class="sd">            shstim: shifted stimulus</span>
</span><span id="BarET-610"><a href="#BarET-610"><span class="linenos">610</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET-611"><a href="#BarET-611"><span class="linenos">611</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Currently needs to be fixed to work with 2D&#39;</span><span class="p">)</span>
</span><span id="BarET-612"><a href="#BarET-612"><span class="linenos">612</span></a>        <span class="n">sh</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span>
</span><span id="BarET-613"><a href="#BarET-613"><span class="linenos">613</span></a>        <span class="n">shstim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="BarET-614"><a href="#BarET-614"><span class="linenos">614</span></a>        <span class="k">if</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET-615"><a href="#BarET-615"><span class="linenos">615</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="o">-</span><span class="n">sh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="p">:</span><span class="n">sh</span><span class="p">]</span>
</span><span id="BarET-616"><a href="#BarET-616"><span class="linenos">616</span></a>        <span class="k">elif</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET-617"><a href="#BarET-617"><span class="linenos">617</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="n">sh</span><span class="p">:]</span>
</span><span id="BarET-618"><a href="#BarET-618"><span class="linenos">618</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BarET-619"><a href="#BarET-619"><span class="linenos">619</span></a>            <span class="n">shstim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="BarET-620"><a href="#BarET-620"><span class="linenos">620</span></a>
</span><span id="BarET-621"><a href="#BarET-621"><span class="linenos">621</span></a>        <span class="k">return</span> <span class="n">shstim</span>
</span><span id="BarET-622"><a href="#BarET-622"><span class="linenos">622</span></a>    <span class="c1"># END .shift_stim_fixation</span>
</span><span id="BarET-623"><a href="#BarET-623"><span class="linenos">623</span></a>
</span><span id="BarET-624"><a href="#BarET-624"><span class="linenos">624</span></a>    <span class="k">def</span> <span class="nf">create_valid_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post_sacc_gap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="BarET-625"><a href="#BarET-625"><span class="linenos">625</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET-626"><a href="#BarET-626"><span class="linenos">626</span></a><span class="sd">        This creates self.valid_inds vector that is used for __get_item__ </span>
</span><span id="BarET-627"><a href="#BarET-627"><span class="linenos">627</span></a><span class="sd">        -- Will default to num_lags following each saccade beginning</span>
</span><span id="BarET-628"><a href="#BarET-628"><span class="linenos">628</span></a><span class="sd">        </span>
</span><span id="BarET-629"><a href="#BarET-629"><span class="linenos">629</span></a><span class="sd">        Args:</span>
</span><span id="BarET-630"><a href="#BarET-630"><span class="linenos">630</span></a><span class="sd">            post_sacc_gap: number of lags to ignore after saccade</span>
</span><span id="BarET-631"><a href="#BarET-631"><span class="linenos">631</span></a>
</span><span id="BarET-632"><a href="#BarET-632"><span class="linenos">632</span></a><span class="sd">        Returns:</span>
</span><span id="BarET-633"><a href="#BarET-633"><span class="linenos">633</span></a><span class="sd">            None: sets self.valid_inds</span>
</span><span id="BarET-634"><a href="#BarET-634"><span class="linenos">634</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET-635"><a href="#BarET-635"><span class="linenos">635</span></a>
</span><span id="BarET-636"><a href="#BarET-636"><span class="linenos">636</span></a>        <span class="k">if</span> <span class="n">post_sacc_gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BarET-637"><a href="#BarET-637"><span class="linenos">637</span></a>            <span class="n">post_sacc_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="BarET-638"><a href="#BarET-638"><span class="linenos">638</span></a>
</span><span id="BarET-639"><a href="#BarET-639"><span class="linenos">639</span></a>        <span class="c1"># first, throw out all data where all data_filters are zero</span>
</span><span id="BarET-640"><a href="#BarET-640"><span class="linenos">640</span></a>        <span class="n">is_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="BarET-641"><a href="#BarET-641"><span class="linenos">641</span></a>        <span class="n">is_valid</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="BarET-642"><a href="#BarET-642"><span class="linenos">642</span></a>        
</span><span id="BarET-643"><a href="#BarET-643"><span class="linenos">643</span></a>        <span class="c1"># Now invalid post_sacc_gap following saccades</span>
</span><span id="BarET-644"><a href="#BarET-644"><span class="linenos">644</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span><span class="p">):</span>
</span><span id="BarET-645"><a href="#BarET-645"><span class="linenos">645</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:])</span>
</span><span id="BarET-646"><a href="#BarET-646"><span class="linenos">646</span></a>            <span class="n">sts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="BarET-647"><a href="#BarET-647"><span class="linenos">647</span></a>            <span class="n">is_valid</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">post_sacc_gap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BarET-648"><a href="#BarET-648"><span class="linenos">648</span></a>        
</span><span id="BarET-649"><a href="#BarET-649"><span class="linenos">649</span></a>        <span class="c1">#self.valid_inds = list(np.where(is_valid &gt; 0)[0])</span>
</span><span id="BarET-650"><a href="#BarET-650"><span class="linenos">650</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_valid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BarET-651"><a href="#BarET-651"><span class="linenos">651</span></a>    <span class="c1"># END .create_valid_indices</span>
</span><span id="BarET-652"><a href="#BarET-652"><span class="linenos">652</span></a>
</span><span id="BarET-653"><a href="#BarET-653"><span class="linenos">653</span></a>    <span class="k">def</span> <span class="nf">crossval_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test_set</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="BarET-654"><a href="#BarET-654"><span class="linenos">654</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET-655"><a href="#BarET-655"><span class="linenos">655</span></a><span class="sd">        This sets the cross-validation indices up We can add featuers here. Many ways to do this</span>
</span><span id="BarET-656"><a href="#BarET-656"><span class="linenos">656</span></a><span class="sd">        but will stick to some standard for now. It sets the internal indices, which can be read out</span>
</span><span id="BarET-657"><a href="#BarET-657"><span class="linenos">657</span></a><span class="sd">        directly or with helper functions. Perhaps helper_functions is the best way....</span>
</span><span id="BarET-658"><a href="#BarET-658"><span class="linenos">658</span></a><span class="sd">        </span>
</span><span id="BarET-659"><a href="#BarET-659"><span class="linenos">659</span></a><span class="sd">        Args:</span>
</span><span id="BarET-660"><a href="#BarET-660"><span class="linenos">660</span></a><span class="sd">            folds: number of folds to use</span>
</span><span id="BarET-661"><a href="#BarET-661"><span class="linenos">661</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="BarET-662"><a href="#BarET-662"><span class="linenos">662</span></a><span class="sd">            test_set: whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</span>
</span><span id="BarET-663"><a href="#BarET-663"><span class="linenos">663</span></a><span class="sd">            verbose: whether to print out information</span>
</span><span id="BarET-664"><a href="#BarET-664"><span class="linenos">664</span></a><span class="sd">        </span>
</span><span id="BarET-665"><a href="#BarET-665"><span class="linenos">665</span></a><span class="sd">        Returns:</span>
</span><span id="BarET-666"><a href="#BarET-666"><span class="linenos">666</span></a><span class="sd">            None: sets internal variables test_inds, train_inds, val_inds</span>
</span><span id="BarET-667"><a href="#BarET-667"><span class="linenos">667</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET-668"><a href="#BarET-668"><span class="linenos">668</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must first specify valid_indices before setting up cross-validation.&quot;</span>
</span><span id="BarET-669"><a href="#BarET-669"><span class="linenos">669</span></a>
</span><span id="BarET-670"><a href="#BarET-670"><span class="linenos">670</span></a>        <span class="c1"># Reflect block structure</span>
</span><span id="BarET-671"><a href="#BarET-671"><span class="linenos">671</span></a>        <span class="n">Nblks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="BarET-672"><a href="#BarET-672"><span class="linenos">672</span></a>        <span class="n">val_blk1</span><span class="p">,</span> <span class="n">tr_blk1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="n">Nblks</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="BarET-673"><a href="#BarET-673"><span class="linenos">673</span></a>
</span><span id="BarET-674"><a href="#BarET-674"><span class="linenos">674</span></a>        <span class="k">if</span> <span class="n">test_set</span><span class="p">:</span>
</span><span id="BarET-675"><a href="#BarET-675"><span class="linenos">675</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="n">val_blk1</span>
</span><span id="BarET-676"><a href="#BarET-676"><span class="linenos">676</span></a>            <span class="n">val_blk2</span><span class="p">,</span> <span class="n">tr_blk2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_blk1</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="BarET-677"><a href="#BarET-677"><span class="linenos">677</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span><span class="p">[</span><span class="n">val_blk2</span><span class="p">]</span>
</span><span id="BarET-678"><a href="#BarET-678"><span class="linenos">678</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span><span class="p">[</span><span class="n">tr_blk2</span><span class="p">]</span>
</span><span id="BarET-679"><a href="#BarET-679"><span class="linenos">679</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BarET-680"><a href="#BarET-680"><span class="linenos">680</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">val_blk1</span>
</span><span id="BarET-681"><a href="#BarET-681"><span class="linenos">681</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span>
</span><span id="BarET-682"><a href="#BarET-682"><span class="linenos">682</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BarET-683"><a href="#BarET-683"><span class="linenos">683</span></a>
</span><span id="BarET-684"><a href="#BarET-684"><span class="linenos">684</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="BarET-685"><a href="#BarET-685"><span class="linenos">685</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Partitioned </span><span class="si">%d</span><span class="s2"> fixations total: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span>
</span><span id="BarET-686"><a href="#BarET-686"><span class="linenos">686</span></a>                <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">)))</span>  
</span><span id="BarET-687"><a href="#BarET-687"><span class="linenos">687</span></a>
</span><span id="BarET-688"><a href="#BarET-688"><span class="linenos">688</span></a>        <span class="c1"># Now pull indices from each saccade </span>
</span><span id="BarET-689"><a href="#BarET-689"><span class="linenos">689</span></a>        <span class="n">tr_inds</span><span class="p">,</span> <span class="n">te_inds</span><span class="p">,</span> <span class="n">val_inds</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="BarET-690"><a href="#BarET-690"><span class="linenos">690</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">:</span>
</span><span id="BarET-691"><a href="#BarET-691"><span class="linenos">691</span></a>            <span class="n">tr_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="BarET-692"><a href="#BarET-692"><span class="linenos">692</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">:</span>
</span><span id="BarET-693"><a href="#BarET-693"><span class="linenos">693</span></a>            <span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="BarET-694"><a href="#BarET-694"><span class="linenos">694</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">:</span>
</span><span id="BarET-695"><a href="#BarET-695"><span class="linenos">695</span></a>            <span class="n">te_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="BarET-696"><a href="#BarET-696"><span class="linenos">696</span></a>
</span><span id="BarET-697"><a href="#BarET-697"><span class="linenos">697</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="BarET-698"><a href="#BarET-698"><span class="linenos">698</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Pre-valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">te_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="BarET-699"><a href="#BarET-699"><span class="linenos">699</span></a>
</span><span id="BarET-700"><a href="#BarET-700"><span class="linenos">700</span></a>        <span class="c1"># Finally intersect with used_inds</span>
</span><span id="BarET-701"><a href="#BarET-701"><span class="linenos">701</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="BarET-702"><a href="#BarET-702"><span class="linenos">702</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">val_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="BarET-703"><a href="#BarET-703"><span class="linenos">703</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">te_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="BarET-704"><a href="#BarET-704"><span class="linenos">704</span></a>
</span><span id="BarET-705"><a href="#BarET-705"><span class="linenos">705</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="BarET-706"><a href="#BarET-706"><span class="linenos">706</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="BarET-707"><a href="#BarET-707"><span class="linenos">707</span></a>
</span><span id="BarET-708"><a href="#BarET-708"><span class="linenos">708</span></a>    <span class="c1"># END .crossval_setup()</span>
</span><span id="BarET-709"><a href="#BarET-709"><span class="linenos">709</span></a>
</span><span id="BarET-710"><a href="#BarET-710"><span class="linenos">710</span></a>    <span class="k">def</span> <span class="nf">fold_sample</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="BarET-711"><a href="#BarET-711"><span class="linenos">711</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET-712"><a href="#BarET-712"><span class="linenos">712</span></a><span class="sd">        This really should be a general method not associated with self</span>
</span><span id="BarET-713"><a href="#BarET-713"><span class="linenos">713</span></a><span class="sd">        </span>
</span><span id="BarET-714"><a href="#BarET-714"><span class="linenos">714</span></a><span class="sd">        Args:</span>
</span><span id="BarET-715"><a href="#BarET-715"><span class="linenos">715</span></a><span class="sd">            num_items: number of items to fold</span>
</span><span id="BarET-716"><a href="#BarET-716"><span class="linenos">716</span></a><span class="sd">            folds: number of folds</span>
</span><span id="BarET-717"><a href="#BarET-717"><span class="linenos">717</span></a><span class="sd">            random_gen: whether to randomly sample or uniformly sample</span>
</span><span id="BarET-718"><a href="#BarET-718"><span class="linenos">718</span></a>
</span><span id="BarET-719"><a href="#BarET-719"><span class="linenos">719</span></a><span class="sd">        Returns:</span>
</span><span id="BarET-720"><a href="#BarET-720"><span class="linenos">720</span></a><span class="sd">            val_items: indices of validation items</span>
</span><span id="BarET-721"><a href="#BarET-721"><span class="linenos">721</span></a><span class="sd">            rem_items: indices of remaining items</span>
</span><span id="BarET-722"><a href="#BarET-722"><span class="linenos">722</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET-723"><a href="#BarET-723"><span class="linenos">723</span></a>        <span class="k">if</span> <span class="n">random_gen</span><span class="p">:</span>
</span><span id="BarET-724"><a href="#BarET-724"><span class="linenos">724</span></a>            <span class="n">num_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_items</span><span class="o">/</span><span class="n">folds</span><span class="p">)</span>
</span><span id="BarET-725"><a href="#BarET-725"><span class="linenos">725</span></a>            <span class="n">tmp_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">num_items</span><span class="p">)</span>
</span><span id="BarET-726"><a href="#BarET-726"><span class="linenos">726</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[:</span><span class="n">num_val</span><span class="p">])</span>
</span><span id="BarET-727"><a href="#BarET-727"><span class="linenos">727</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[</span><span class="n">num_val</span><span class="p">:])</span>
</span><span id="BarET-728"><a href="#BarET-728"><span class="linenos">728</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BarET-729"><a href="#BarET-729"><span class="linenos">729</span></a>            <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">folds</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="BarET-730"><a href="#BarET-730"><span class="linenos">730</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
</span><span id="BarET-731"><a href="#BarET-731"><span class="linenos">731</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">),</span> <span class="n">val_items</span><span class="p">)</span>
</span><span id="BarET-732"><a href="#BarET-732"><span class="linenos">732</span></a>        <span class="k">return</span> <span class="n">val_items</span><span class="p">,</span> <span class="n">rem_items</span>
</span><span id="BarET-733"><a href="#BarET-733"><span class="linenos">733</span></a>
</span><span id="BarET-734"><a href="#BarET-734"><span class="linenos">734</span></a>    <span class="k">def</span> <span class="nf">adjust_Xdrift_xval</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="BarET-735"><a href="#BarET-735"><span class="linenos">735</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET-736"><a href="#BarET-736"><span class="linenos">736</span></a><span class="sd">        Adjust drift matrix to not fit xval parameterz</span>
</span><span id="BarET-737"><a href="#BarET-737"><span class="linenos">737</span></a>
</span><span id="BarET-738"><a href="#BarET-738"><span class="linenos">738</span></a><span class="sd">        Args:</span>
</span><span id="BarET-739"><a href="#BarET-739"><span class="linenos">739</span></a><span class="sd">            None</span>
</span><span id="BarET-740"><a href="#BarET-740"><span class="linenos">740</span></a>
</span><span id="BarET-741"><a href="#BarET-741"><span class="linenos">741</span></a><span class="sd">        Returns:</span>
</span><span id="BarET-742"><a href="#BarET-742"><span class="linenos">742</span></a><span class="sd">            None: sets self.Xdrift to adjusted version</span>
</span><span id="BarET-743"><a href="#BarET-743"><span class="linenos">743</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET-744"><a href="#BarET-744"><span class="linenos">744</span></a>        <span class="n">Xnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">]</span>
</span><span id="BarET-745"><a href="#BarET-745"><span class="linenos">745</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">)):</span>
</span><span id="BarET-746"><a href="#BarET-746"><span class="linenos">746</span></a>            <span class="n">newpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">ii</span> <span class="c1"># this will be where lower range is</span>
</span><span id="BarET-747"><a href="#BarET-747"><span class="linenos">747</span></a>            <span class="k">if</span> <span class="n">newpos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET-748"><a href="#BarET-748"><span class="linenos">748</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="BarET-749"><a href="#BarET-749"><span class="linenos">749</span></a>            <span class="k">elif</span> <span class="n">newpos</span> <span class="o">==</span> <span class="n">Xnew</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="BarET-750"><a href="#BarET-750"><span class="linenos">750</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="BarET-751"><a href="#BarET-751"><span class="linenos">751</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># In between</span>
</span><span id="BarET-752"><a href="#BarET-752"><span class="linenos">752</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span> <span class="n">newpos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="BarET-753"><a href="#BarET-753"><span class="linenos">753</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span> <span class="n">newpos</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="BarET-754"><a href="#BarET-754"><span class="linenos">754</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">Xnew</span>
</span><span id="BarET-755"><a href="#BarET-755"><span class="linenos">755</span></a>    <span class="c1"># END .adjust_drift_xval</span>
</span><span id="BarET-756"><a href="#BarET-756"><span class="linenos">756</span></a>
</span><span id="BarET-757"><a href="#BarET-757"><span class="linenos">757</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="BarET-758"><a href="#BarET-758"><span class="linenos">758</span></a>        
</span><span id="BarET-759"><a href="#BarET-759"><span class="linenos">759</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="BarET-760"><a href="#BarET-760"><span class="linenos">760</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;get_item time embedding not implemented yet&quot;</span><span class="p">)</span>
</span><span id="BarET-761"><a href="#BarET-761"><span class="linenos">761</span></a>            <span class="c1"># if self.folded_lags:</span>
</span><span id="BarET-762"><a href="#BarET-762"><span class="linenos">762</span></a>            <span class="c1">#    stim = np.transpose( tmp_stim, axes=[0,2,1,3,4] ) </span>
</span><span id="BarET-763"><a href="#BarET-763"><span class="linenos">763</span></a>            <span class="c1">#else:</span>
</span><span id="BarET-764"><a href="#BarET-764"><span class="linenos">764</span></a>            <span class="c1">#    stim = np.transpose( tmp_stim, axes=[0,2,3,4,1] )</span>
</span><span id="BarET-765"><a href="#BarET-765"><span class="linenos">765</span></a>
</span><span id="BarET-766"><a href="#BarET-766"><span class="linenos">766</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BarET-767"><a href="#BarET-767"><span class="linenos">767</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to assemble_stimulus first.&quot;</span>
</span><span id="BarET-768"><a href="#BarET-768"><span class="linenos">768</span></a>
</span><span id="BarET-769"><a href="#BarET-769"><span class="linenos">769</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="BarET-770"><a href="#BarET-770"><span class="linenos">770</span></a>                <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="BarET-771"><a href="#BarET-771"><span class="linenos">771</span></a>                    <span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> 
</span><span id="BarET-772"><a href="#BarET-772"><span class="linenos">772</span></a>                    <span class="s1">&#39;stimH&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimHout</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> 
</span><span id="BarET-773"><a href="#BarET-773"><span class="linenos">773</span></a>                    <span class="s1">&#39;stimV&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimVout</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]}</span>
</span><span id="BarET-774"><a href="#BarET-774"><span class="linenos">774</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="BarET-775"><a href="#BarET-775"><span class="linenos">775</span></a>                <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="BarET-776"><a href="#BarET-776"><span class="linenos">776</span></a>                    <span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> 
</span><span id="BarET-777"><a href="#BarET-777"><span class="linenos">777</span></a>                    <span class="s1">&#39;stimV&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimVout</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]}</span>
</span><span id="BarET-778"><a href="#BarET-778"><span class="linenos">778</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;fix_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="BarET-779"><a href="#BarET-779"><span class="linenos">779</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Xdrift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="BarET-780"><a href="#BarET-780"><span class="linenos">780</span></a>
</span><span id="BarET-781"><a href="#BarET-781"><span class="linenos">781</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET-782"><a href="#BarET-782"><span class="linenos">782</span></a>                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="BarET-783"><a href="#BarET-783"><span class="linenos">783</span></a>                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="BarET-784"><a href="#BarET-784"><span class="linenos">784</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="BarET-785"><a href="#BarET-785"><span class="linenos">785</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BarET-786"><a href="#BarET-786"><span class="linenos">786</span></a>                    <span class="n">robs_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs_out</span>
</span><span id="BarET-787"><a href="#BarET-787"><span class="linenos">787</span></a>                    <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs_out</span>
</span><span id="BarET-788"><a href="#BarET-788"><span class="linenos">788</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="BarET-789"><a href="#BarET-789"><span class="linenos">789</span></a>                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s1">&#39;cells_out must be a list&#39;</span>
</span><span id="BarET-790"><a href="#BarET-790"><span class="linenos">790</span></a>                    <span class="n">robs_tmp</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="BarET-791"><a href="#BarET-791"><span class="linenos">791</span></a>                    <span class="n">dfs_tmp</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="BarET-792"><a href="#BarET-792"><span class="linenos">792</span></a>
</span><span id="BarET-793"><a href="#BarET-793"><span class="linenos">793</span></a>                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">robs_tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="BarET-794"><a href="#BarET-794"><span class="linenos">794</span></a>                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfs_tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="BarET-795"><a href="#BarET-795"><span class="linenos">795</span></a>
</span><span id="BarET-796"><a href="#BarET-796"><span class="linenos">796</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET-797"><a href="#BarET-797"><span class="linenos">797</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">append_covariates</span><span class="p">(</span> <span class="n">out</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span><span id="BarET-798"><a href="#BarET-798"><span class="linenos">798</span></a>
</span><span id="BarET-799"><a href="#BarET-799"><span class="linenos">799</span></a>        <span class="c1">### THIS IS NOT NEEDED WITH TIME-EMBEDDING: needs to be on fixation-process side...</span>
</span><span id="BarET-800"><a href="#BarET-800"><span class="linenos">800</span></a>        <span class="c1">#         # Augment to eliminate first X time steps in data_filters</span>
</span><span id="BarET-801"><a href="#BarET-801"><span class="linenos">801</span></a>        <span class="c1">#if (self.num_lags &gt; 0) &amp;  ~utils.is_int(idx):</span>
</span><span id="BarET-802"><a href="#BarET-802"><span class="linenos">802</span></a>        <span class="c1">#    if out[&#39;dfs&#39;].shape[0] &lt;= self.num_lags:</span>
</span><span id="BarET-803"><a href="#BarET-803"><span class="linenos">803</span></a>        <span class="c1">#        print( &quot;Warning: fixation shorter than num_lags: %d &lt;= %d&quot;%(out[&#39;dfs&#39;].shape[0], self.num_lags))</span>
</span><span id="BarET-804"><a href="#BarET-804"><span class="linenos">804</span></a>        <span class="c1">#    else:</span>
</span><span id="BarET-805"><a href="#BarET-805"><span class="linenos">805</span></a>        <span class="c1">#        out[&#39;dfs&#39;][:self.num_lags, :] = 0.0</span>
</span><span id="BarET-806"><a href="#BarET-806"><span class="linenos">806</span></a>
</span><span id="BarET-807"><a href="#BarET-807"><span class="linenos">807</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span><span class="p">:</span>
</span><span id="BarET-808"><a href="#BarET-808"><span class="linenos">808</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;DATASET: shifts missing but &#39;with_shifter&#39; is true&quot;</span> 
</span><span id="BarET-809"><a href="#BarET-809"><span class="linenos">809</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;shifts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="BarET-810"><a href="#BarET-810"><span class="linenos">810</span></a>            
</span><span id="BarET-811"><a href="#BarET-811"><span class="linenos">811</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET-812"><a href="#BarET-812"><span class="linenos">812</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">append_covariates</span><span class="p">(</span> <span class="n">out</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span><span id="BarET-813"><a href="#BarET-813"><span class="linenos">813</span></a>
</span><span id="BarET-814"><a href="#BarET-814"><span class="linenos">814</span></a>        <span class="k">return</span> <span class="n">out</span>                
</span></pre></div>


            <div class="docstring"><p>-- can load batches from multiple datasets
-- hdf5 files must have the following information:
    Robs
    RobsMU
    stim: 4-d stimulus: time x nx x ny x color
    block_inds: start and stop of 'trials' (perhaps fixations for now)
    other things: saccades? or should that be in trials? </p>

<p>Constructor will take eye position, which for now is an input from data
generated in the session (not on disk). It should have the length size 
of the total number of fixations x1.</p>
</div>


                            <div id="BarET.__init__" class="classattr">
                                        <input id="BarET.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">BarET</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">filenames</span>,</span><span class="param">	<span class="n">datadir</span>,</span><span class="param">	<span class="n">include_MUs</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">time_embed</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span>,</span><span class="param">	<span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">Hstim_shift</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">Hdiscardzero</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">combine_stim</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">stim_gap</span><span class="o">=</span><span class="mi">8</span>,</span><span class="param">	<span class="n">drift_interval</span><span class="o">=</span><span class="mi">16</span>,</span><span class="param">	<span class="n">eye_config</span><span class="o">=</span><span class="mi">3</span>,</span><span class="param">	<span class="n">binocular</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>,</span><span class="param">	<span class="n">maxT</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="BarET.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BarET.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BarET.__init__-31"><a href="#BarET.__init__-31"><span class="linenos"> 31</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="BarET.__init__-32"><a href="#BarET.__init__-32"><span class="linenos"> 32</span></a>        <span class="n">filenames</span><span class="p">,</span>
</span><span id="BarET.__init__-33"><a href="#BarET.__init__-33"><span class="linenos"> 33</span></a>        <span class="n">datadir</span><span class="p">,</span> 
</span><span id="BarET.__init__-34"><a href="#BarET.__init__-34"><span class="linenos"> 34</span></a>        <span class="n">include_MUs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="BarET.__init__-35"><a href="#BarET.__init__-35"><span class="linenos"> 35</span></a>        <span class="c1"># Stim setup -- have option to assemble or could leave blank</span>
</span><span id="BarET.__init__-36"><a href="#BarET.__init__-36"><span class="linenos"> 36</span></a>        <span class="n">time_embed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="BarET.__init__-37"><a href="#BarET.__init__-37"><span class="linenos"> 37</span></a>        <span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
</span><span id="BarET.__init__-38"><a href="#BarET.__init__-38"><span class="linenos"> 38</span></a>        <span class="c1"># Dataset-specitic inputs</span>
</span><span id="BarET.__init__-39"><a href="#BarET.__init__-39"><span class="linenos"> 39</span></a>        <span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="BarET.__init__-40"><a href="#BarET.__init__-40"><span class="linenos"> 40</span></a>        <span class="n">Hstim_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># to shift-and-wrap stimH stimulus</span>
</span><span id="BarET.__init__-41"><a href="#BarET.__init__-41"><span class="linenos"> 41</span></a>        <span class="n">Hdiscardzero</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="BarET.__init__-42"><a href="#BarET.__init__-42"><span class="linenos"> 42</span></a>        <span class="c1"># Stim configuation</span>
</span><span id="BarET.__init__-43"><a href="#BarET.__init__-43"><span class="linenos"> 43</span></a>        <span class="n">combine_stim</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># if False, horizontal stim will be &#39;stim&#39;</span>
</span><span id="BarET.__init__-44"><a href="#BarET.__init__-44"><span class="linenos"> 44</span></a>        <span class="n">stim_gap</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="BarET.__init__-45"><a href="#BarET.__init__-45"><span class="linenos"> 45</span></a>        <span class="n">drift_interval</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>  <span class="c1"># how many trials to anchor each drift term</span>
</span><span id="BarET.__init__-46"><a href="#BarET.__init__-46"><span class="linenos"> 46</span></a>        <span class="c1"># eye configuration</span>
</span><span id="BarET.__init__-47"><a href="#BarET.__init__-47"><span class="linenos"> 47</span></a>        <span class="n">eye_config</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># 0 = all, 1, 2, and 3 are options (3 = binocular)</span>
</span><span id="BarET.__init__-48"><a href="#BarET.__init__-48"><span class="linenos"> 48</span></a>        <span class="n">binocular</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># whether to include separate filters for each eye</span>
</span><span id="BarET.__init__-49"><a href="#BarET.__init__-49"><span class="linenos"> 49</span></a>        <span class="c1"># other</span>
</span><span id="BarET.__init__-50"><a href="#BarET.__init__-50"><span class="linenos"> 50</span></a>        <span class="c1">#ignore_saccades=True,</span>
</span><span id="BarET.__init__-51"><a href="#BarET.__init__-51"><span class="linenos"> 51</span></a>        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">),</span>
</span><span id="BarET.__init__-52"><a href="#BarET.__init__-52"><span class="linenos"> 52</span></a>        <span class="n">maxT</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="BarET.__init__-53"><a href="#BarET.__init__-53"><span class="linenos"> 53</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET.__init__-54"><a href="#BarET.__init__-54"><span class="linenos"> 54</span></a><span class="sd">        Constructor options</span>
</span><span id="BarET.__init__-55"><a href="#BarET.__init__-55"><span class="linenos"> 55</span></a><span class="sd">        </span>
</span><span id="BarET.__init__-56"><a href="#BarET.__init__-56"><span class="linenos"> 56</span></a><span class="sd">        Args:</span>
</span><span id="BarET.__init__-57"><a href="#BarET.__init__-57"><span class="linenos"> 57</span></a><span class="sd">            filenames: list of strings of hdf5 files</span>
</span><span id="BarET.__init__-58"><a href="#BarET.__init__-58"><span class="linenos"> 58</span></a><span class="sd">            datadir: directory where files are stored</span>
</span><span id="BarET.__init__-59"><a href="#BarET.__init__-59"><span class="linenos"> 59</span></a><span class="sd">            include_MUs: whether to include multi-units</span>
</span><span id="BarET.__init__-60"><a href="#BarET.__init__-60"><span class="linenos"> 60</span></a><span class="sd">            time_embed: 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="BarET.__init__-61"><a href="#BarET.__init__-61"><span class="linenos"> 61</span></a><span class="sd">            num_lags: number of lags to include in time-embedding</span>
</span><span id="BarET.__init__-62"><a href="#BarET.__init__-62"><span class="linenos"> 62</span></a><span class="sd">            stim_crop: whether to crop stimulus (not implemented)</span>
</span><span id="BarET.__init__-63"><a href="#BarET.__init__-63"><span class="linenos"> 63</span></a><span class="sd">            Hstim_shift: how much to shift horizontal stimulus (in bars)</span>
</span><span id="BarET.__init__-64"><a href="#BarET.__init__-64"><span class="linenos"> 64</span></a><span class="sd">            Hdiscardzero: whether to discard zero position in horizontal stimulus</span>
</span><span id="BarET.__init__-65"><a href="#BarET.__init__-65"><span class="linenos"> 65</span></a><span class="sd">            combine_stim: whether to combine horizontal and vertical stimulus</span>
</span><span id="BarET.__init__-66"><a href="#BarET.__init__-66"><span class="linenos"> 66</span></a><span class="sd">            stim_gap: gap between horizontal and vertical stimulus</span>
</span><span id="BarET.__init__-67"><a href="#BarET.__init__-67"><span class="linenos"> 67</span></a><span class="sd">            drift_interval: how many trials to anchor each drift term</span>
</span><span id="BarET.__init__-68"><a href="#BarET.__init__-68"><span class="linenos"> 68</span></a><span class="sd">            eye_config: 0 = all, 1, 2, and 3 are options (3 = binocular)</span>
</span><span id="BarET.__init__-69"><a href="#BarET.__init__-69"><span class="linenos"> 69</span></a><span class="sd">            binocular: whether to include separate filters for each eye</span>
</span><span id="BarET.__init__-70"><a href="#BarET.__init__-70"><span class="linenos"> 70</span></a><span class="sd">            device: torch device</span>
</span><span id="BarET.__init__-71"><a href="#BarET.__init__-71"><span class="linenos"> 71</span></a><span class="sd">            maxT: maximum time points to load (for debugging)</span>
</span><span id="BarET.__init__-72"><a href="#BarET.__init__-72"><span class="linenos"> 72</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET.__init__-73"><a href="#BarET.__init__-73"><span class="linenos"> 73</span></a>
</span><span id="BarET.__init__-74"><a href="#BarET.__init__-74"><span class="linenos"> 74</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="BarET.__init__-75"><a href="#BarET.__init__-75"><span class="linenos"> 75</span></a>            <span class="n">filenames</span><span class="o">=</span><span class="n">filenames</span><span class="p">,</span> <span class="n">datadir</span><span class="o">=</span><span class="n">datadir</span><span class="p">,</span> 
</span><span id="BarET.__init__-76"><a href="#BarET.__init__-76"><span class="linenos"> 76</span></a>            <span class="n">time_embed</span><span class="o">=</span><span class="n">time_embed</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">num_lags</span><span class="p">,</span> 
</span><span id="BarET.__init__-77"><a href="#BarET.__init__-77"><span class="linenos"> 77</span></a>            <span class="n">include_MUs</span><span class="o">=</span><span class="n">include_MUs</span><span class="p">,</span>
</span><span id="BarET.__init__-78"><a href="#BarET.__init__-78"><span class="linenos"> 78</span></a>            <span class="n">drift_interval</span><span class="o">=</span><span class="n">drift_interval</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET.__init__-79"><a href="#BarET.__init__-79"><span class="linenos"> 79</span></a>
</span><span id="BarET.__init__-80"><a href="#BarET.__init__-80"><span class="linenos"> 80</span></a>        <span class="c1"># Done in constructor</span>
</span><span id="BarET.__init__-81"><a href="#BarET.__init__-81"><span class="linenos"> 81</span></a>        <span class="c1">#self.datadir = datadir</span>
</span><span id="BarET.__init__-82"><a href="#BarET.__init__-82"><span class="linenos"> 82</span></a>        <span class="c1">#self.filenames = filenames</span>
</span><span id="BarET.__init__-83"><a href="#BarET.__init__-83"><span class="linenos"> 83</span></a>        <span class="c1">#self.device = device</span>
</span><span id="BarET.__init__-84"><a href="#BarET.__init__-84"><span class="linenos"> 84</span></a>        <span class="c1">#self.num_lags = 10  # default: to be set later</span>
</span><span id="BarET.__init__-85"><a href="#BarET.__init__-85"><span class="linenos"> 85</span></a>        <span class="c1">#self.time_embed = time_embed</span>
</span><span id="BarET.__init__-86"><a href="#BarET.__init__-86"><span class="linenos"> 86</span></a>        <span class="c1">#self.used_inds = []</span>
</span><span id="BarET.__init__-87"><a href="#BarET.__init__-87"><span class="linenos"> 87</span></a>        <span class="c1">#self.NT = 0</span>
</span><span id="BarET.__init__-88"><a href="#BarET.__init__-88"><span class="linenos"> 88</span></a>
</span><span id="BarET.__init__-89"><a href="#BarET.__init__-89"><span class="linenos"> 89</span></a>        <span class="c1"># Stim-specific</span>
</span><span id="BarET.__init__-90"><a href="#BarET.__init__-90"><span class="linenos"> 90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">=</span> <span class="n">eye_config</span>
</span><span id="BarET.__init__-91"><a href="#BarET.__init__-91"><span class="linenos"> 91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_gap</span> <span class="o">=</span> <span class="n">stim_gap</span>
</span><span id="BarET.__init__-92"><a href="#BarET.__init__-92"><span class="linenos"> 92</span></a>
</span><span id="BarET.__init__-93"><a href="#BarET.__init__-93"><span class="linenos"> 93</span></a>        <span class="c1"># get hdf5 file handles</span>
</span><span id="BarET.__init__-94"><a href="#BarET.__init__-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">sess</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>
</span><span id="BarET.__init__-95"><a href="#BarET.__init__-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BarET.__init__-96"><a href="#BarET.__init__-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BarET.__init__-97"><a href="#BarET.__init__-97"><span class="linenos"> 97</span></a>
</span><span id="BarET.__init__-98"><a href="#BarET.__init__-98"><span class="linenos"> 98</span></a>        <span class="c1"># Data to just read in and store</span>
</span><span id="BarET.__init__-99"><a href="#BarET.__init__-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;stim_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="BarET.__init__-100"><a href="#BarET.__init__-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_locationET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ETstim_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="BarET.__init__-101"><a href="#BarET.__init__-101"><span class="linenos">101</span></a>
</span><span id="BarET.__init__-102"><a href="#BarET.__init__-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;fix_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="BarET.__init__-103"><a href="#BarET.__init__-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probeIDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Robs_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="BarET.__init__-104"><a href="#BarET.__init__-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probeIDsMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;RobsMU_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="BarET.__init__-105"><a href="#BarET.__init__-105"><span class="linenos">105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dt&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="BarET.__init__-106"><a href="#BarET.__init__-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;pixel_size&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="BarET.__init__-107"><a href="#BarET.__init__-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exptdate</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># need to learn matlab strings in HDF5 format (not saved as HDF5 string)</span>
</span><span id="BarET.__init__-108"><a href="#BarET.__init__-108"><span class="linenos">108</span></a>
</span><span id="BarET.__init__-109"><a href="#BarET.__init__-109"><span class="linenos">109</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapSU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Robs_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="BarET.__init__-110"><a href="#BarET.__init__-110"><span class="linenos">110</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;RobsMU_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="BarET.__init__-111"><a href="#BarET.__init__-111"><span class="linenos">111</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">channel_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_mapSU</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapMU</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="BarET.__init__-112"><a href="#BarET.__init__-112"><span class="linenos">112</span></a>
</span><span id="BarET.__init__-113"><a href="#BarET.__init__-113"><span class="linenos">113</span></a>        <span class="c1">#self.stim = []</span>
</span><span id="BarET.__init__-114"><a href="#BarET.__init__-114"><span class="linenos">114</span></a>        <span class="c1">#self.dfs = []</span>
</span><span id="BarET.__init__-115"><a href="#BarET.__init__-115"><span class="linenos">115</span></a>        <span class="c1">#self.robs = []</span>
</span><span id="BarET.__init__-116"><a href="#BarET.__init__-116"><span class="linenos">116</span></a>        <span class="c1">#self.NT = 0</span>
</span><span id="BarET.__init__-117"><a href="#BarET.__init__-117"><span class="linenos">117</span></a>        <span class="c1"># Add additional stimuli for processing</span>
</span><span id="BarET.__init__-118"><a href="#BarET.__init__-118"><span class="linenos">118</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimHout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimVout</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="BarET.__init__-119"><a href="#BarET.__init__-119"><span class="linenos">119</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dimsH</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dimsV</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="BarET.__init__-120"><a href="#BarET.__init__-120"><span class="linenos">120</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BarET.__init__-121"><a href="#BarET.__init__-121"><span class="linenos">121</span></a>
</span><span id="BarET.__init__-122"><a href="#BarET.__init__-122"><span class="linenos">122</span></a>        <span class="c1"># build index map</span>
</span><span id="BarET.__init__-123"><a href="#BarET.__init__-123"><span class="linenos">123</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_threshold</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># how many valid time points required to include saccade?</span>
</span><span id="BarET.__init__-124"><a href="#BarET.__init__-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_index</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># which file the block corresponds to</span>
</span><span id="BarET.__init__-125"><a href="#BarET.__init__-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BarET.__init__-126"><a href="#BarET.__init__-126"><span class="linenos">126</span></a>        <span class="c1">#self.unit_ids = []</span>
</span><span id="BarET.__init__-127"><a href="#BarET.__init__-127"><span class="linenos">127</span></a>        <span class="c1">#self.num_units, self.num_sus, self.num_mus = [], [], []</span>
</span><span id="BarET.__init__-128"><a href="#BarET.__init__-128"><span class="linenos">128</span></a>        <span class="c1">#self.sus = []</span>
</span><span id="BarET.__init__-129"><a href="#BarET.__init__-129"><span class="linenos">129</span></a>        <span class="c1">#self.NC = 0</span>
</span><span id="BarET.__init__-130"><a href="#BarET.__init__-130"><span class="linenos">130</span></a>        <span class="c1">#self.stim_dims = None</span>
</span><span id="BarET.__init__-131"><a href="#BarET.__init__-131"><span class="linenos">131</span></a>        <span class="c1">#self.eyepos = eyepos</span>
</span><span id="BarET.__init__-132"><a href="#BarET.__init__-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_Xfix</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="BarET.__init__-133"><a href="#BarET.__init__-133"><span class="linenos">133</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="BarET.__init__-134"><a href="#BarET.__init__-134"><span class="linenos">134</span></a>        <span class="c1">#self.block_inds = []</span>
</span><span id="BarET.__init__-135"><a href="#BarET.__init__-135"><span class="linenos">135</span></a>        <span class="c1">#self.block_filemapping = []</span>
</span><span id="BarET.__init__-136"><a href="#BarET.__init__-136"><span class="linenos">136</span></a>        <span class="c1">#self.include_MUs = include_MUs</span>
</span><span id="BarET.__init__-137"><a href="#BarET.__init__-137"><span class="linenos">137</span></a>        <span class="c1">#self.SUinds = []</span>
</span><span id="BarET.__init__-138"><a href="#BarET.__init__-138"><span class="linenos">138</span></a>        <span class="c1">#self.MUinds = []</span>
</span><span id="BarET.__init__-139"><a href="#BarET.__init__-139"><span class="linenos">139</span></a>        <span class="c1">#self.cells_out = []  # can be list to output specific cells in get_item</span>
</span><span id="BarET.__init__-140"><a href="#BarET.__init__-140"><span class="linenos">140</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="BarET.__init__-141"><a href="#BarET.__init__-141"><span class="linenos">141</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BarET.__init__-142"><a href="#BarET.__init__-142"><span class="linenos">142</span></a>
</span><span id="BarET.__init__-143"><a href="#BarET.__init__-143"><span class="linenos">143</span></a>        <span class="c1"># Set up to store default train_, val_, test_inds</span>
</span><span id="BarET.__init__-144"><a href="#BarET.__init__-144"><span class="linenos">144</span></a>        <span class="c1">#self.test_inds = None</span>
</span><span id="BarET.__init__-145"><a href="#BarET.__init__-145"><span class="linenos">145</span></a>        <span class="c1">#self.val_inds = None</span>
</span><span id="BarET.__init__-146"><a href="#BarET.__init__-146"><span class="linenos">146</span></a>        <span class="c1">#self.train_inds = None</span>
</span><span id="BarET.__init__-147"><a href="#BarET.__init__-147"><span class="linenos">147</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="BarET.__init__-148"><a href="#BarET.__init__-148"><span class="linenos">148</span></a>
</span><span id="BarET.__init__-149"><a href="#BarET.__init__-149"><span class="linenos">149</span></a>        <span class="n">tcount</span><span class="p">,</span> <span class="n">fix_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="BarET.__init__-150"><a href="#BarET.__init__-150"><span class="linenos">150</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span> <span class="o">=</span> <span class="s1">&#39;stimET&#39;</span>
</span><span id="BarET.__init__-151"><a href="#BarET.__init__-151"><span class="linenos">151</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ETtraceHR</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BarET.__init__-152"><a href="#BarET.__init__-152"><span class="linenos">152</span></a>
</span><span id="BarET.__init__-153"><a href="#BarET.__init__-153"><span class="linenos">153</span></a>        <span class="k">for</span> <span class="n">fnum</span><span class="p">,</span> <span class="n">fhandle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">):</span>
</span><span id="BarET.__init__-154"><a href="#BarET.__init__-154"><span class="linenos">154</span></a>
</span><span id="BarET.__init__-155"><a href="#BarET.__init__-155"><span class="linenos">155</span></a>            <span class="n">NT</span><span class="p">,</span> <span class="n">NSUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="BarET.__init__-156"><a href="#BarET.__init__-156"><span class="linenos">156</span></a>            <span class="n">NX</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="BarET.__init__-157"><a href="#BarET.__init__-157"><span class="linenos">157</span></a>            <span class="n">NMUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="BarET.__init__-158"><a href="#BarET.__init__-158"><span class="linenos">158</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_SUs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NSUfile</span><span class="p">)</span>
</span><span id="BarET.__init__-159"><a href="#BarET.__init__-159"><span class="linenos">159</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_MUs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NMUfile</span><span class="p">)</span>
</span><span id="BarET.__init__-160"><a href="#BarET.__init__-160"><span class="linenos">160</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="o">+</span><span class="n">NSUfile</span><span class="p">))</span>
</span><span id="BarET.__init__-161"><a href="#BarET.__init__-161"><span class="linenos">161</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;block_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="BarET.__init__-162"><a href="#BarET.__init__-162"><span class="linenos">162</span></a>            <span class="n">stim_eyes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useLeye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span>  \
</span><span id="BarET.__init__-163"><a href="#BarET.__init__-163"><span class="linenos">163</span></a>                            <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="BarET.__init__-164"><a href="#BarET.__init__-164"><span class="linenos">164</span></a>            
</span><span id="BarET.__init__-165"><a href="#BarET.__init__-165"><span class="linenos">165</span></a>            <span class="n">Reye</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">]</span>
</span><span id="BarET.__init__-166"><a href="#BarET.__init__-166"><span class="linenos">166</span></a>            <span class="n">NCfile</span> <span class="o">=</span> <span class="n">NSUfile</span>
</span><span id="BarET.__init__-167"><a href="#BarET.__init__-167"><span class="linenos">167</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="BarET.__init__-168"><a href="#BarET.__init__-168"><span class="linenos">168</span></a>                <span class="n">NCfile</span> <span class="o">+=</span> <span class="n">NMUfile</span>
</span><span id="BarET.__init__-169"><a href="#BarET.__init__-169"><span class="linenos">169</span></a>            
</span><span id="BarET.__init__-170"><a href="#BarET.__init__-170"><span class="linenos">170</span></a>            <span class="c1"># This will associate each block with each file</span>
</span><span id="BarET.__init__-171"><a href="#BarET.__init__-171"><span class="linenos">171</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_filemapping</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="n">fnum</span><span class="p">)</span>
</span><span id="BarET.__init__-172"><a href="#BarET.__init__-172"><span class="linenos">172</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span><span class="p">[</span><span class="n">fnum</span><span class="p">]</span><span class="o">=</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BarET.__init__-173"><a href="#BarET.__init__-173"><span class="linenos">173</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span><span class="p">[</span><span class="n">fnum</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BarET.__init__-174"><a href="#BarET.__init__-174"><span class="linenos">174</span></a>            <span class="c1">#if self.stim_dims is None:</span>
</span><span id="BarET.__init__-175"><a href="#BarET.__init__-175"><span class="linenos">175</span></a>            <span class="c1">#if folded_lags:</span>
</span><span id="BarET.__init__-176"><a href="#BarET.__init__-176"><span class="linenos">176</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">([</span><span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="c1">#list(fhandle[stimname].shape[1:4]) + [1]</span>
</span><span id="BarET.__init__-177"><a href="#BarET.__init__-177"><span class="linenos">177</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="BarET.__init__-178"><a href="#BarET.__init__-178"><span class="linenos">178</span></a>          
</span><span id="BarET.__init__-179"><a href="#BarET.__init__-179"><span class="linenos">179</span></a>            <span class="c1">#if self.time_embed &gt; 0:</span>
</span><span id="BarET.__init__-180"><a href="#BarET.__init__-180"><span class="linenos">180</span></a>            <span class="c1">#    self.dims[3] = self.num_lags</span>
</span><span id="BarET.__init__-181"><a href="#BarET.__init__-181"><span class="linenos">181</span></a>
</span><span id="BarET.__init__-182"><a href="#BarET.__init__-182"><span class="linenos">182</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stim check:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</span><span id="BarET.__init__-183"><a href="#BarET.__init__-183"><span class="linenos">183</span></a>
</span><span id="BarET.__init__-184"><a href="#BarET.__init__-184"><span class="linenos">184</span></a>            <span class="c1">#self.unit_ids.append(self.NC + np.asarray(range(NCfile)))</span>
</span><span id="BarET.__init__-185"><a href="#BarET.__init__-185"><span class="linenos">185</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NCfile</span><span class="p">)</span>
</span><span id="BarET.__init__-186"><a href="#BarET.__init__-186"><span class="linenos">186</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">+=</span> <span class="n">NCfile</span>
</span><span id="BarET.__init__-187"><a href="#BarET.__init__-187"><span class="linenos">187</span></a>
</span><span id="BarET.__init__-188"><a href="#BarET.__init__-188"><span class="linenos">188</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;sacc_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="BarET.__init__-189"><a href="#BarET.__init__-189"><span class="linenos">189</span></a>            <span class="c1">#fix_n = np.zeros(NT, dtype=np.int64)  # each time point labels fixation number</span>
</span><span id="BarET.__init__-190"><a href="#BarET.__init__-190"><span class="linenos">190</span></a>
</span><span id="BarET.__init__-191"><a href="#BarET.__init__-191"><span class="linenos">191</span></a>            <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;valid_data&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>  <span class="c1">#range(self.NT)  # default -- to be changed at end of init</span>
</span><span id="BarET.__init__-192"><a href="#BarET.__init__-192"><span class="linenos">192</span></a>
</span><span id="BarET.__init__-193"><a href="#BarET.__init__-193"><span class="linenos">193</span></a>            <span class="c1">### Process blocks and fixations/saccades</span>
</span><span id="BarET.__init__-194"><a href="#BarET.__init__-194"><span class="linenos">194</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="BarET.__init__-195"><a href="#BarET.__init__-195"><span class="linenos">195</span></a>                <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="BarET.__init__-196"><a href="#BarET.__init__-196"><span class="linenos">196</span></a>                <span class="n">include_block</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="BarET.__init__-197"><a href="#BarET.__init__-197"><span class="linenos">197</span></a>                <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="BarET.__init__-198"><a href="#BarET.__init__-198"><span class="linenos">198</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET.__init__-199"><a href="#BarET.__init__-199"><span class="linenos">199</span></a>                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">stim_eyes</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET.__init__-200"><a href="#BarET.__init__-200"><span class="linenos">200</span></a>                        <span class="n">include_block</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="BarET.__init__-201"><a href="#BarET.__init__-201"><span class="linenos">201</span></a>                <span class="k">if</span> <span class="n">include_block</span><span class="p">:</span>
</span><span id="BarET.__init__-202"><a href="#BarET.__init__-202"><span class="linenos">202</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
</span><span id="BarET.__init__-203"><a href="#BarET.__init__-203"><span class="linenos">203</span></a>            
</span><span id="BarET.__init__-204"><a href="#BarET.__init__-204"><span class="linenos">204</span></a>            <span class="n">tcount</span> <span class="o">+=</span> <span class="n">NT</span>
</span><span id="BarET.__init__-205"><a href="#BarET.__init__-205"><span class="linenos">205</span></a>            <span class="c1"># make larger fix_n, valid_inds, sacc_inds, block_inds as self</span>
</span><span id="BarET.__init__-206"><a href="#BarET.__init__-206"><span class="linenos">206</span></a>
</span><span id="BarET.__init__-207"><a href="#BarET.__init__-207"><span class="linenos">207</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>  <span class="o">=</span> <span class="n">tcount</span>
</span><span id="BarET.__init__-208"><a href="#BarET.__init__-208"><span class="linenos">208</span></a>
</span><span id="BarET.__init__-209"><a href="#BarET.__init__-209"><span class="linenos">209</span></a>        <span class="c1"># For now let&#39;s just debug with one file</span>
</span><span id="BarET.__init__-210"><a href="#BarET.__init__-210"><span class="linenos">210</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="BarET.__init__-211"><a href="#BarET.__init__-211"><span class="linenos">211</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: currently ignoring multiple files&#39;</span><span class="p">)</span>
</span><span id="BarET.__init__-212"><a href="#BarET.__init__-212"><span class="linenos">212</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">valid_inds</span><span class="p">)</span>
</span><span id="BarET.__init__-213"><a href="#BarET.__init__-213"><span class="linenos">213</span></a>        
</span><span id="BarET.__init__-214"><a href="#BarET.__init__-214"><span class="linenos">214</span></a>        <span class="c1"># PULL OTHER INFO</span>
</span><span id="BarET.__init__-215"><a href="#BarET.__init__-215"><span class="linenos">215</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ETtraceHR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;ETtrace_raw&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET.__init__-216"><a href="#BarET.__init__-216"><span class="linenos">216</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sort_rating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs_rating&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="BarET.__init__-217"><a href="#BarET.__init__-217"><span class="linenos">217</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sort_ratingMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU_rating&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span>
</span><span id="BarET.__init__-218"><a href="#BarET.__init__-218"><span class="linenos">218</span></a>
</span><span id="BarET.__init__-219"><a href="#BarET.__init__-219"><span class="linenos">219</span></a>        <span class="c1"># Go through saccades to establish val_indices and produce saccade timing vector </span>
</span><span id="BarET.__init__-220"><a href="#BarET.__init__-220"><span class="linenos">220</span></a>        <span class="c1">#print(&quot;Loading data into memory...&quot;)</span>
</span><span id="BarET.__init__-221"><a href="#BarET.__init__-221"><span class="linenos">221</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preload_numpy</span><span class="p">()</span>
</span><span id="BarET.__init__-222"><a href="#BarET.__init__-222"><span class="linenos">222</span></a>
</span><span id="BarET.__init__-223"><a href="#BarET.__init__-223"><span class="linenos">223</span></a>        <span class="c1"># Have data_filters represend used_inds (in case it gets through)</span>
</span><span id="BarET.__init__-224"><a href="#BarET.__init__-224"><span class="linenos">224</span></a>        <span class="n">unified_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET.__init__-225"><a href="#BarET.__init__-225"><span class="linenos">225</span></a>        <span class="n">unified_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="BarET.__init__-226"><a href="#BarET.__init__-226"><span class="linenos">226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*=</span> <span class="n">unified_df</span>
</span><span id="BarET.__init__-227"><a href="#BarET.__init__-227"><span class="linenos">227</span></a>
</span><span id="BarET.__init__-228"><a href="#BarET.__init__-228"><span class="linenos">228</span></a>        <span class="c1"># Prepare design matrix for drift (on trial-by-trial basis)</span>
</span><span id="BarET.__init__-229"><a href="#BarET.__init__-229"><span class="linenos">229</span></a>        <span class="c1">#self.Xdrift = np.zeros([self.NT, len(self.block_inds)//], dtype=np.float32)</span>
</span><span id="BarET.__init__-230"><a href="#BarET.__init__-230"><span class="linenos">230</span></a>        <span class="c1">#for nn in range(len(self.block_inds)):</span>
</span><span id="BarET.__init__-231"><a href="#BarET.__init__-231"><span class="linenos">231</span></a>        <span class="c1">#    self.Xdrift[self.block_inds[nn], nn] = 1.0</span>
</span><span id="BarET.__init__-232"><a href="#BarET.__init__-232"><span class="linenos">232</span></a>        <span class="n">NBL</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="BarET.__init__-233"><a href="#BarET.__init__-233"><span class="linenos">233</span></a>        <span class="n">Nanchors</span> <span class="o">=</span> <span class="n">NBL</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span>
</span><span id="BarET.__init__-234"><a href="#BarET.__init__-234"><span class="linenos">234</span></a>        <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="BarET.__init__-235"><a href="#BarET.__init__-235"><span class="linenos">235</span></a>        <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">):</span>
</span><span id="BarET.__init__-236"><a href="#BarET.__init__-236"><span class="linenos">236</span></a>            <span class="n">anchors</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span><span class="o">*</span><span class="n">bb</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BarET.__init__-237"><a href="#BarET.__init__-237"><span class="linenos">237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="BarET.__init__-238"><a href="#BarET.__init__-238"><span class="linenos">238</span></a>
</span><span id="BarET.__init__-239"><a href="#BarET.__init__-239"><span class="linenos">239</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">process_fixations</span><span class="p">()</span>
</span><span id="BarET.__init__-240"><a href="#BarET.__init__-240"><span class="linenos">240</span></a>
</span><span id="BarET.__init__-241"><a href="#BarET.__init__-241"><span class="linenos">241</span></a>        <span class="c1"># Convert data to tensors</span>
</span><span id="BarET.__init__-242"><a href="#BarET.__init__-242"><span class="linenos">242</span></a>        <span class="c1">#if self.device is not None:</span>
</span><span id="BarET.__init__-243"><a href="#BarET.__init__-243"><span class="linenos">243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET.__init__-244"><a href="#BarET.__init__-244"><span class="linenos">244</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>
</span><span id="BarET.__init__-245"><a href="#BarET.__init__-245"><span class="linenos">245</span></a>
</span><span id="BarET.__init__-246"><a href="#BarET.__init__-246"><span class="linenos">246</span></a>        <span class="c1"># Create valid indices and first pass of cross-validation indices</span>
</span><span id="BarET.__init__-247"><a href="#BarET.__init__-247"><span class="linenos">247</span></a>        <span class="c1">#self.create_valid_indices()</span>
</span><span id="BarET.__init__-248"><a href="#BarET.__init__-248"><span class="linenos">248</span></a>        <span class="c1"># Develop default train, validation, and test datasets </span>
</span><span id="BarET.__init__-249"><a href="#BarET.__init__-249"><span class="linenos">249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crossval_setup</span><span class="p">()</span>
</span><span id="BarET.__init__-250"><a href="#BarET.__init__-250"><span class="linenos">250</span></a>
</span><span id="BarET.__init__-251"><a href="#BarET.__init__-251"><span class="linenos">251</span></a>        <span class="c1"># Fix Xdrift to remove test and validation sets</span>
</span><span id="BarET.__init__-252"><a href="#BarET.__init__-252"><span class="linenos">252</span></a>        <span class="c1">#self.adjust_Xdrift_xval()</span>
</span><span id="BarET.__init__-253"><a href="#BarET.__init__-253"><span class="linenos">253</span></a>        <span class="k">if</span> <span class="n">time_embed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># then call assemble_stimulus in the constructor</span>
</span><span id="BarET.__init__-254"><a href="#BarET.__init__-254"><span class="linenos">254</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">assemble_stimulus</span><span class="p">(</span>
</span><span id="BarET.__init__-255"><a href="#BarET.__init__-255"><span class="linenos">255</span></a>                <span class="n">combine_stim</span><span class="o">=</span><span class="n">combine_stim</span><span class="p">,</span> <span class="n">stim_crop</span><span class="o">=</span><span class="n">stim_crop</span><span class="p">,</span>
</span><span id="BarET.__init__-256"><a href="#BarET.__init__-256"><span class="linenos">256</span></a>                <span class="n">time_embed</span><span class="o">=</span><span class="n">time_embed</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">num_lags</span><span class="p">,</span>
</span><span id="BarET.__init__-257"><a href="#BarET.__init__-257"><span class="linenos">257</span></a>                <span class="n">Hshift</span><span class="o">=</span><span class="n">Hstim_shift</span><span class="p">,</span> <span class="n">Hdiscardzero</span><span class="o">=</span><span class="n">Hdiscardzero</span><span class="p">)</span>
</span><span id="BarET.__init__-258"><a href="#BarET.__init__-258"><span class="linenos">258</span></a>        <span class="c1"># Otherwise leave for the future</span>
</span><span id="BarET.__init__-259"><a href="#BarET.__init__-259"><span class="linenos">259</span></a>
</span><span id="BarET.__init__-260"><a href="#BarET.__init__-260"><span class="linenos">260</span></a>        <span class="c1"># Reflects block structure</span>
</span><span id="BarET.__init__-261"><a href="#BarET.__init__-261"><span class="linenos">261</span></a>        <span class="c1">#vblks, trblks = self.fold_sample(len(self.block_inds), 5, random_gen=True)</span>
</span><span id="BarET.__init__-262"><a href="#BarET.__init__-262"><span class="linenos">262</span></a>        <span class="c1">#self.train_inds = []</span>
</span><span id="BarET.__init__-263"><a href="#BarET.__init__-263"><span class="linenos">263</span></a>        <span class="c1">#for nn in trblks:</span>
</span><span id="BarET.__init__-264"><a href="#BarET.__init__-264"><span class="linenos">264</span></a>        <span class="c1">#    self.train_inds += list(deepcopy(self.block_inds[nn]))</span>
</span><span id="BarET.__init__-265"><a href="#BarET.__init__-265"><span class="linenos">265</span></a>        <span class="c1">#self.val_inds = []</span>
</span><span id="BarET.__init__-266"><a href="#BarET.__init__-266"><span class="linenos">266</span></a>        <span class="c1">#for nn in vblks:</span>
</span><span id="BarET.__init__-267"><a href="#BarET.__init__-267"><span class="linenos">267</span></a>        <span class="c1">#    self.val_inds += list(deepcopy(self.block_inds[nn]))</span>
</span><span id="BarET.__init__-268"><a href="#BarET.__init__-268"><span class="linenos">268</span></a>        <span class="c1">#self.train_inds = np.array(self.train_inds, dtype=np.int64)</span>
</span><span id="BarET.__init__-269"><a href="#BarET.__init__-269"><span class="linenos">269</span></a>        <span class="c1">#self.val_inds = np.array(self.val_inds, dtype=np.int64)</span>
</span></pre></div>


            <div class="docstring"><p>Constructor options</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>filenames:</strong>  list of strings of hdf5 files</li>
<li><strong>datadir:</strong>  directory where files are stored</li>
<li><strong>include_MUs:</strong>  whether to include multi-units</li>
<li><strong>time_embed:</strong>  0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</li>
<li><strong>num_lags:</strong>  number of lags to include in time-embedding</li>
<li><strong>stim_crop:</strong>  whether to crop stimulus (not implemented)</li>
<li><strong>Hstim_shift:</strong>  how much to shift horizontal stimulus (in bars)</li>
<li><strong>Hdiscardzero:</strong>  whether to discard zero position in horizontal stimulus</li>
<li><strong>combine_stim:</strong>  whether to combine horizontal and vertical stimulus</li>
<li><strong>stim_gap:</strong>  gap between horizontal and vertical stimulus</li>
<li><strong>drift_interval:</strong>  how many trials to anchor each drift term</li>
<li><strong>eye_config:</strong>  0 = all, 1, 2, and 3 are options (3 = binocular)</li>
<li><strong>binocular:</strong>  whether to include separate filters for each eye</li>
<li><strong>device:</strong>  torch device</li>
<li><strong>maxT:</strong>  maximum time points to load (for debugging)</li>
</ul>
</div>


                            </div>
                            <div id="BarET.eye_config" class="classattr">
                                <div class="attr variable">
            <span class="name">eye_config</span>

        
    </div>
    <a class="headerlink" href="#BarET.eye_config"></a>
    
    

                            </div>
                            <div id="BarET.stim_gap" class="classattr">
                                <div class="attr variable">
            <span class="name">stim_gap</span>

        
    </div>
    <a class="headerlink" href="#BarET.stim_gap"></a>
    
    

                            </div>
                            <div id="BarET.fhandles" class="classattr">
                                <div class="attr variable">
            <span class="name">fhandles</span>

        
    </div>
    <a class="headerlink" href="#BarET.fhandles"></a>
    
    

                            </div>
                            <div id="BarET.dfs_orig" class="classattr">
                                <div class="attr variable">
            <span class="name">dfs_orig</span>

        
    </div>
    <a class="headerlink" href="#BarET.dfs_orig"></a>
    
    

                            </div>
                            <div id="BarET.avRs" class="classattr">
                                <div class="attr variable">
            <span class="name">avRs</span>

        
    </div>
    <a class="headerlink" href="#BarET.avRs"></a>
    
    

                            </div>
                            <div id="BarET.stim_location" class="classattr">
                                <div class="attr variable">
            <span class="name">stim_location</span>

        
    </div>
    <a class="headerlink" href="#BarET.stim_location"></a>
    
    

                            </div>
                            <div id="BarET.stim_locationET" class="classattr">
                                <div class="attr variable">
            <span class="name">stim_locationET</span>

        
    </div>
    <a class="headerlink" href="#BarET.stim_locationET"></a>
    
    

                            </div>
                            <div id="BarET.fix_location" class="classattr">
                                <div class="attr variable">
            <span class="name">fix_location</span>

        
    </div>
    <a class="headerlink" href="#BarET.fix_location"></a>
    
    

                            </div>
                            <div id="BarET.probeIDs" class="classattr">
                                <div class="attr variable">
            <span class="name">probeIDs</span>

        
    </div>
    <a class="headerlink" href="#BarET.probeIDs"></a>
    
    

                            </div>
                            <div id="BarET.probeIDsMU" class="classattr">
                                <div class="attr variable">
            <span class="name">probeIDsMU</span>

        
    </div>
    <a class="headerlink" href="#BarET.probeIDsMU"></a>
    
    

                            </div>
                            <div id="BarET.dt" class="classattr">
                                <div class="attr variable">
            <span class="name">dt</span>

        
    </div>
    <a class="headerlink" href="#BarET.dt"></a>
    
    

                            </div>
                            <div id="BarET.pixel_size" class="classattr">
                                <div class="attr variable">
            <span class="name">pixel_size</span>

        
    </div>
    <a class="headerlink" href="#BarET.pixel_size"></a>
    
    

                            </div>
                            <div id="BarET.exptdate" class="classattr">
                                <div class="attr variable">
            <span class="name">exptdate</span>

        
    </div>
    <a class="headerlink" href="#BarET.exptdate"></a>
    
    

                            </div>
                            <div id="BarET.channel_mapSU" class="classattr">
                                <div class="attr variable">
            <span class="name">channel_mapSU</span>

        
    </div>
    <a class="headerlink" href="#BarET.channel_mapSU"></a>
    
    

                            </div>
                            <div id="BarET.channel_mapMU" class="classattr">
                                <div class="attr variable">
            <span class="name">channel_mapMU</span>

        
    </div>
    <a class="headerlink" href="#BarET.channel_mapMU"></a>
    
    

                            </div>
                            <div id="BarET.channel_map" class="classattr">
                                <div class="attr variable">
            <span class="name">channel_map</span>

        
    </div>
    <a class="headerlink" href="#BarET.channel_map"></a>
    
    

                            </div>
                            <div id="BarET.fix_n" class="classattr">
                                <div class="attr variable">
            <span class="name">fix_n</span>

        
    </div>
    <a class="headerlink" href="#BarET.fix_n"></a>
    
    

                            </div>
                            <div id="BarET.data_threshold" class="classattr">
                                <div class="attr variable">
            <span class="name">data_threshold</span>

        
    </div>
    <a class="headerlink" href="#BarET.data_threshold"></a>
    
    

                            </div>
                            <div id="BarET.file_index" class="classattr">
                                <div class="attr variable">
            <span class="name">file_index</span>

        
    </div>
    <a class="headerlink" href="#BarET.file_index"></a>
    
    

                            </div>
                            <div id="BarET.sacc_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">sacc_inds</span>

        
    </div>
    <a class="headerlink" href="#BarET.sacc_inds"></a>
    
    

                            </div>
                            <div id="BarET.generate_Xfix" class="classattr">
                                <div class="attr variable">
            <span class="name">generate_Xfix</span>

        
    </div>
    <a class="headerlink" href="#BarET.generate_Xfix"></a>
    
    

                            </div>
                            <div id="BarET.num_blks" class="classattr">
                                <div class="attr variable">
            <span class="name">num_blks</span>

        
    </div>
    <a class="headerlink" href="#BarET.num_blks"></a>
    
    

                            </div>
                            <div id="BarET.with_shifter" class="classattr">
                                <div class="attr variable">
            <span class="name">with_shifter</span>

        
    </div>
    <a class="headerlink" href="#BarET.with_shifter"></a>
    
    

                            </div>
                            <div id="BarET.shifts" class="classattr">
                                <div class="attr variable">
            <span class="name">shifts</span>

        
    </div>
    <a class="headerlink" href="#BarET.shifts"></a>
    
    

                            </div>
                            <div id="BarET.stimname" class="classattr">
                                <div class="attr variable">
            <span class="name">stimname</span>

        
    </div>
    <a class="headerlink" href="#BarET.stimname"></a>
    
    

                            </div>
                            <div id="BarET.ETtraceHR" class="classattr">
                                <div class="attr variable">
            <span class="name">ETtraceHR</span>

        
    </div>
    <a class="headerlink" href="#BarET.ETtraceHR"></a>
    
    

                            </div>
                            <div id="BarET.NT" class="classattr">
                                <div class="attr variable">
            <span class="name">NT</span>

        
    </div>
    <a class="headerlink" href="#BarET.NT"></a>
    
    

                            </div>
                            <div id="BarET.used_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">used_inds</span>

        
    </div>
    <a class="headerlink" href="#BarET.used_inds"></a>
    
    

                            </div>
                            <div id="BarET.sort_rating" class="classattr">
                                <div class="attr variable">
            <span class="name">sort_rating</span>

        
    </div>
    <a class="headerlink" href="#BarET.sort_rating"></a>
    
    

                            </div>
                            <div id="BarET.sort_ratingMU" class="classattr">
                                <div class="attr variable">
            <span class="name">sort_ratingMU</span>

        
    </div>
    <a class="headerlink" href="#BarET.sort_ratingMU"></a>
    
    

                            </div>
                            <div id="BarET.Xdrift" class="classattr">
                                <div class="attr variable">
            <span class="name">Xdrift</span>

        
    </div>
    <a class="headerlink" href="#BarET.Xdrift"></a>
    
    

                            </div>
                            <div id="BarET.preload_numpy" class="classattr">
                                        <input id="BarET.preload_numpy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">preload_numpy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BarET.preload_numpy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BarET.preload_numpy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BarET.preload_numpy-272"><a href="#BarET.preload_numpy-272"><span class="linenos">272</span></a>    <span class="k">def</span> <span class="nf">preload_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BarET.preload_numpy-273"><a href="#BarET.preload_numpy-273"><span class="linenos">273</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET.preload_numpy-274"><a href="#BarET.preload_numpy-274"><span class="linenos">274</span></a><span class="sd">        Note this loads stimulus but does not time-embed</span>
</span><span id="BarET.preload_numpy-275"><a href="#BarET.preload_numpy-275"><span class="linenos">275</span></a><span class="sd">        </span>
</span><span id="BarET.preload_numpy-276"><a href="#BarET.preload_numpy-276"><span class="linenos">276</span></a><span class="sd">        Args:</span>
</span><span id="BarET.preload_numpy-277"><a href="#BarET.preload_numpy-277"><span class="linenos">277</span></a><span class="sd">            None</span>
</span><span id="BarET.preload_numpy-278"><a href="#BarET.preload_numpy-278"><span class="linenos">278</span></a>
</span><span id="BarET.preload_numpy-279"><a href="#BarET.preload_numpy-279"><span class="linenos">279</span></a><span class="sd">        Returns:</span>
</span><span id="BarET.preload_numpy-280"><a href="#BarET.preload_numpy-280"><span class="linenos">280</span></a><span class="sd">            None: loads into self.stim, self.robs, self.dfs, self.fix_n, self.Xdrift</span>
</span><span id="BarET.preload_numpy-281"><a href="#BarET.preload_numpy-281"><span class="linenos">281</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET.preload_numpy-282"><a href="#BarET.preload_numpy-282"><span class="linenos">282</span></a>
</span><span id="BarET.preload_numpy-283"><a href="#BarET.preload_numpy-283"><span class="linenos">283</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span><span id="BarET.preload_numpy-284"><a href="#BarET.preload_numpy-284"><span class="linenos">284</span></a>        <span class="n">NX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="BarET.preload_numpy-285"><a href="#BarET.preload_numpy-285"><span class="linenos">285</span></a>        <span class="n">NX2</span> <span class="o">=</span> <span class="n">NX</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_gap</span>
</span><span id="BarET.preload_numpy-286"><a href="#BarET.preload_numpy-286"><span class="linenos">286</span></a>
</span><span id="BarET.preload_numpy-287"><a href="#BarET.preload_numpy-287"><span class="linenos">287</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="BarET.preload_numpy-288"><a href="#BarET.preload_numpy-288"><span class="linenos">288</span></a><span class="sd">        Pre-allocate memory for data</span>
</span><span id="BarET.preload_numpy-289"><a href="#BarET.preload_numpy-289"><span class="linenos">289</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="BarET.preload_numpy-290"><a href="#BarET.preload_numpy-290"><span class="linenos">290</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET.preload_numpy-291"><a href="#BarET.preload_numpy-291"><span class="linenos">291</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET.preload_numpy-292"><a href="#BarET.preload_numpy-292"><span class="linenos">292</span></a>
</span><span id="BarET.preload_numpy-293"><a href="#BarET.preload_numpy-293"><span class="linenos">293</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET.preload_numpy-294"><a href="#BarET.preload_numpy-294"><span class="linenos">294</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET.preload_numpy-295"><a href="#BarET.preload_numpy-295"><span class="linenos">295</span></a>        <span class="c1">#self.eyepos = np.zeros([NT, 2], dtype=np.float32)</span>
</span><span id="BarET.preload_numpy-296"><a href="#BarET.preload_numpy-296"><span class="linenos">296</span></a>        <span class="c1">#self.frame_times = np.zeros([NT,1], dtype=np.float32)</span>
</span><span id="BarET.preload_numpy-297"><a href="#BarET.preload_numpy-297"><span class="linenos">297</span></a>
</span><span id="BarET.preload_numpy-298"><a href="#BarET.preload_numpy-298"><span class="linenos">298</span></a>        <span class="n">t_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BarET.preload_numpy-299"><a href="#BarET.preload_numpy-299"><span class="linenos">299</span></a>        <span class="n">unit_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BarET.preload_numpy-300"><a href="#BarET.preload_numpy-300"><span class="linenos">300</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">)):</span>
</span><span id="BarET.preload_numpy-301"><a href="#BarET.preload_numpy-301"><span class="linenos">301</span></a>            
</span><span id="BarET.preload_numpy-302"><a href="#BarET.preload_numpy-302"><span class="linenos">302</span></a>            <span class="n">fhandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="BarET.preload_numpy-303"><a href="#BarET.preload_numpy-303"><span class="linenos">303</span></a>            <span class="n">sz</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="BarET.preload_numpy-304"><a href="#BarET.preload_numpy-304"><span class="linenos">304</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_counter</span><span class="p">,</span> <span class="n">t_counter</span><span class="o">+</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="BarET.preload_numpy-305"><a href="#BarET.preload_numpy-305"><span class="linenos">305</span></a>            <span class="c1">#inds = self.stim_indices[expt][stim][&#39;inds&#39;]</span>
</span><span id="BarET.preload_numpy-306"><a href="#BarET.preload_numpy-306"><span class="linenos">306</span></a>            <span class="c1">#self.stim[inds, ...] = np.transpose( np.array(fhandle[self.stimname], dtype=np.float32), axes=[0,3,1,2])</span>
</span><span id="BarET.preload_numpy-307"><a href="#BarET.preload_numpy-307"><span class="linenos">307</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET.preload_numpy-308"><a href="#BarET.preload_numpy-308"><span class="linenos">308</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tmp_stim</span><span class="p">)</span>
</span><span id="BarET.preload_numpy-309"><a href="#BarET.preload_numpy-309"><span class="linenos">309</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp_stim</span>
</span><span id="BarET.preload_numpy-310"><a href="#BarET.preload_numpy-310"><span class="linenos">310</span></a>            <span class="n">stim_ori</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimETori&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="BarET.preload_numpy-311"><a href="#BarET.preload_numpy-311"><span class="linenos">311</span></a>            <span class="n">Hinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_ori</span> <span class="o">&gt;</span> <span class="mi">45</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BarET.preload_numpy-312"><a href="#BarET.preload_numpy-312"><span class="linenos">312</span></a>            <span class="n">Vinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_ori</span> <span class="o">&lt;</span> <span class="mi">45</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BarET.preload_numpy-313"><a href="#BarET.preload_numpy-313"><span class="linenos">313</span></a>
</span><span id="BarET.preload_numpy-314"><a href="#BarET.preload_numpy-314"><span class="linenos">314</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">Vinds</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="BarET.preload_numpy-315"><a href="#BarET.preload_numpy-315"><span class="linenos">315</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">Hinds</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="BarET.preload_numpy-316"><a href="#BarET.preload_numpy-316"><span class="linenos">316</span></a>
</span><span id="BarET.preload_numpy-317"><a href="#BarET.preload_numpy-317"><span class="linenos">317</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Robs and DATAFILTERS&quot;&quot;&quot;</span>
</span><span id="BarET.preload_numpy-318"><a href="#BarET.preload_numpy-318"><span class="linenos">318</span></a>            <span class="n">robs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="BarET.preload_numpy-319"><a href="#BarET.preload_numpy-319"><span class="linenos">319</span></a>            <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="BarET.preload_numpy-320"><a href="#BarET.preload_numpy-320"><span class="linenos">320</span></a>            <span class="n">num_SUs</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="BarET.preload_numpy-321"><a href="#BarET.preload_numpy-321"><span class="linenos">321</span></a>            <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_SUs</span><span class="p">)</span>
</span><span id="BarET.preload_numpy-322"><a href="#BarET.preload_numpy-322"><span class="linenos">322</span></a>            <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET.preload_numpy-323"><a href="#BarET.preload_numpy-323"><span class="linenos">323</span></a>            <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;datafilts&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET.preload_numpy-324"><a href="#BarET.preload_numpy-324"><span class="linenos">324</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="BarET.preload_numpy-325"><a href="#BarET.preload_numpy-325"><span class="linenos">325</span></a>                <span class="n">num_MUs</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="BarET.preload_numpy-326"><a href="#BarET.preload_numpy-326"><span class="linenos">326</span></a>                <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="o">+</span><span class="n">num_SUs</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_SUs</span><span class="o">+</span><span class="n">num_MUs</span><span class="p">)</span>
</span><span id="BarET.preload_numpy-327"><a href="#BarET.preload_numpy-327"><span class="linenos">327</span></a>                <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET.preload_numpy-328"><a href="#BarET.preload_numpy-328"><span class="linenos">328</span></a>                <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;datafiltsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET.preload_numpy-329"><a href="#BarET.preload_numpy-329"><span class="linenos">329</span></a>            
</span><span id="BarET.preload_numpy-330"><a href="#BarET.preload_numpy-330"><span class="linenos">330</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">robs_tmp</span><span class="p">)</span>
</span><span id="BarET.preload_numpy-331"><a href="#BarET.preload_numpy-331"><span class="linenos">331</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dfs_tmp</span><span class="p">)</span>
</span><span id="BarET.preload_numpy-332"><a href="#BarET.preload_numpy-332"><span class="linenos">332</span></a>
</span><span id="BarET.preload_numpy-333"><a href="#BarET.preload_numpy-333"><span class="linenos">333</span></a>            <span class="n">t_counter</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BarET.preload_numpy-334"><a href="#BarET.preload_numpy-334"><span class="linenos">334</span></a>            <span class="n">unit_counter</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="BarET.preload_numpy-335"><a href="#BarET.preload_numpy-335"><span class="linenos">335</span></a>
</span><span id="BarET.preload_numpy-336"><a href="#BarET.preload_numpy-336"><span class="linenos">336</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span> <span class="o">=</span> <span class="s1">&#39;stim&#39;</span>  <span class="c1"># not sure what this does</span>
</span><span id="BarET.preload_numpy-337"><a href="#BarET.preload_numpy-337"><span class="linenos">337</span></a>
</span><span id="BarET.preload_numpy-338"><a href="#BarET.preload_numpy-338"><span class="linenos">338</span></a>        <span class="c1"># Make combined stim (in case used)</span>
</span><span id="BarET.preload_numpy-339"><a href="#BarET.preload_numpy-339"><span class="linenos">339</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">NX2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET.preload_numpy-340"><a href="#BarET.preload_numpy-340"><span class="linenos">340</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">)</span>
</span><span id="BarET.preload_numpy-341"><a href="#BarET.preload_numpy-341"><span class="linenos">341</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">NX</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_gap</span><span class="p">,</span> <span class="n">NX2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Note this loads stimulus but does not time-embed</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li>None</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: loads into self.stim, self.robs, self.dfs, self.fix_n, self.Xdrift</p>
</blockquote>
</div>


                            </div>
                            <div id="BarET.assemble_stimulus" class="classattr">
                                        <input id="BarET.assemble_stimulus-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">assemble_stimulus</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">combine_stim</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">time_embed</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">num_lags</span><span class="o">=</span><span class="mi">12</span>,</span><span class="param">	<span class="n">Hshift</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">Hdiscardzero</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">shifts</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">BUF</span><span class="o">=</span><span class="mi">20</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BarET.assemble_stimulus-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BarET.assemble_stimulus"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BarET.assemble_stimulus-345"><a href="#BarET.assemble_stimulus-345"><span class="linenos">345</span></a>    <span class="k">def</span> <span class="nf">assemble_stimulus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="BarET.assemble_stimulus-346"><a href="#BarET.assemble_stimulus-346"><span class="linenos">346</span></a>        <span class="n">combine_stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="BarET.assemble_stimulus-347"><a href="#BarET.assemble_stimulus-347"><span class="linenos">347</span></a>        <span class="n">time_embed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> 
</span><span id="BarET.assemble_stimulus-348"><a href="#BarET.assemble_stimulus-348"><span class="linenos">348</span></a>        <span class="n">Hshift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Hdiscardzero</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
</span><span id="BarET.assemble_stimulus-349"><a href="#BarET.assemble_stimulus-349"><span class="linenos">349</span></a>        <span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">BUF</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
</span><span id="BarET.assemble_stimulus-350"><a href="#BarET.assemble_stimulus-350"><span class="linenos">350</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET.assemble_stimulus-351"><a href="#BarET.assemble_stimulus-351"><span class="linenos">351</span></a><span class="sd">        Assembles stimulus for the dataset</span>
</span><span id="BarET.assemble_stimulus-352"><a href="#BarET.assemble_stimulus-352"><span class="linenos">352</span></a><span class="sd">        -- This will also time-embed the stimulus if requested</span>
</span><span id="BarET.assemble_stimulus-353"><a href="#BarET.assemble_stimulus-353"><span class="linenos">353</span></a><span class="sd">        -- This will also shift the stimulus if requested</span>
</span><span id="BarET.assemble_stimulus-354"><a href="#BarET.assemble_stimulus-354"><span class="linenos">354</span></a><span class="sd">        -- This will also crop the stimulus if requested</span>
</span><span id="BarET.assemble_stimulus-355"><a href="#BarET.assemble_stimulus-355"><span class="linenos">355</span></a>
</span><span id="BarET.assemble_stimulus-356"><a href="#BarET.assemble_stimulus-356"><span class="linenos">356</span></a><span class="sd">        Args:</span>
</span><span id="BarET.assemble_stimulus-357"><a href="#BarET.assemble_stimulus-357"><span class="linenos">357</span></a><span class="sd">            combine_stim: whether to combine horizontal and vertical stimulus</span>
</span><span id="BarET.assemble_stimulus-358"><a href="#BarET.assemble_stimulus-358"><span class="linenos">358</span></a><span class="sd">            stim_crop: whether to crop stimulus (not implemented)</span>
</span><span id="BarET.assemble_stimulus-359"><a href="#BarET.assemble_stimulus-359"><span class="linenos">359</span></a><span class="sd">            time_embed: 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="BarET.assemble_stimulus-360"><a href="#BarET.assemble_stimulus-360"><span class="linenos">360</span></a><span class="sd">            num_lags: number of lags to include in time-embedding</span>
</span><span id="BarET.assemble_stimulus-361"><a href="#BarET.assemble_stimulus-361"><span class="linenos">361</span></a><span class="sd">            Hshift: how much to shift horizontal stimulus (in bars)</span>
</span><span id="BarET.assemble_stimulus-362"><a href="#BarET.assemble_stimulus-362"><span class="linenos">362</span></a><span class="sd">            Hdiscardzero: whether to discard zero position in horizontal stimulus</span>
</span><span id="BarET.assemble_stimulus-363"><a href="#BarET.assemble_stimulus-363"><span class="linenos">363</span></a><span class="sd">            shifts: shifts to apply to stimulus (if not None)</span>
</span><span id="BarET.assemble_stimulus-364"><a href="#BarET.assemble_stimulus-364"><span class="linenos">364</span></a><span class="sd">            BUF: buffer for shifting stimulus</span>
</span><span id="BarET.assemble_stimulus-365"><a href="#BarET.assemble_stimulus-365"><span class="linenos">365</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET.assemble_stimulus-366"><a href="#BarET.assemble_stimulus-366"><span class="linenos">366</span></a>
</span><span id="BarET.assemble_stimulus-367"><a href="#BarET.assemble_stimulus-367"><span class="linenos">367</span></a>        <span class="k">if</span> <span class="n">combine_stim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BarET.assemble_stimulus-368"><a href="#BarET.assemble_stimulus-368"><span class="linenos">368</span></a>            <span class="n">combine_stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span>
</span><span id="BarET.assemble_stimulus-369"><a href="#BarET.assemble_stimulus-369"><span class="linenos">369</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BarET.assemble_stimulus-370"><a href="#BarET.assemble_stimulus-370"><span class="linenos">370</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span> <span class="o">=</span> <span class="n">combine_stim</span>
</span><span id="BarET.assemble_stimulus-371"><a href="#BarET.assemble_stimulus-371"><span class="linenos">371</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimHshift</span> <span class="o">=</span> <span class="n">Hshift</span>
</span><span id="BarET.assemble_stimulus-372"><a href="#BarET.assemble_stimulus-372"><span class="linenos">372</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Hdiscardzero</span> <span class="o">=</span> <span class="n">Hdiscardzero</span>
</span><span id="BarET.assemble_stimulus-373"><a href="#BarET.assemble_stimulus-373"><span class="linenos">373</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="o">=</span> <span class="n">stim_crop</span>
</span><span id="BarET.assemble_stimulus-374"><a href="#BarET.assemble_stimulus-374"><span class="linenos">374</span></a>
</span><span id="BarET.assemble_stimulus-375"><a href="#BarET.assemble_stimulus-375"><span class="linenos">375</span></a>        <span class="k">if</span> <span class="n">stim_crop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BarET.assemble_stimulus-376"><a href="#BarET.assemble_stimulus-376"><span class="linenos">376</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;stimulus cropping not implemented yet&#39;</span><span class="p">)</span>
</span><span id="BarET.assemble_stimulus-377"><a href="#BarET.assemble_stimulus-377"><span class="linenos">377</span></a>
</span><span id="BarET.assemble_stimulus-378"><a href="#BarET.assemble_stimulus-378"><span class="linenos">378</span></a>        <span class="c1"># Assemble/shift horizontal stim</span>
</span><span id="BarET.assemble_stimulus-379"><a href="#BarET.assemble_stimulus-379"><span class="linenos">379</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Assembling stimulus&quot;</span><span class="p">)</span>
</span><span id="BarET.assemble_stimulus-380"><a href="#BarET.assemble_stimulus-380"><span class="linenos">380</span></a>        <span class="n">sh</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Hshift</span><span class="p">)</span>
</span><span id="BarET.assemble_stimulus-381"><a href="#BarET.assemble_stimulus-381"><span class="linenos">381</span></a>        <span class="k">if</span> <span class="n">sh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET.assemble_stimulus-382"><a href="#BarET.assemble_stimulus-382"><span class="linenos">382</span></a>            <span class="n">Hstim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span>
</span><span id="BarET.assemble_stimulus-383"><a href="#BarET.assemble_stimulus-383"><span class="linenos">383</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BarET.assemble_stimulus-384"><a href="#BarET.assemble_stimulus-384"><span class="linenos">384</span></a>            <span class="n">Lc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span> <span class="o">-</span> <span class="n">sh</span>
</span><span id="BarET.assemble_stimulus-385"><a href="#BarET.assemble_stimulus-385"><span class="linenos">385</span></a>            <span class="n">Hstim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET.assemble_stimulus-386"><a href="#BarET.assemble_stimulus-386"><span class="linenos">386</span></a>            <span class="k">if</span> <span class="n">Hdiscardzero</span><span class="p">:</span>
</span><span id="BarET.assemble_stimulus-387"><a href="#BarET.assemble_stimulus-387"><span class="linenos">387</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Discarding stim at 0 horizontal position&#39;</span><span class="p">)</span>
</span><span id="BarET.assemble_stimulus-388"><a href="#BarET.assemble_stimulus-388"><span class="linenos">388</span></a>                <span class="k">if</span> <span class="n">Hshift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET.assemble_stimulus-389"><a href="#BarET.assemble_stimulus-389"><span class="linenos">389</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="BarET.assemble_stimulus-390"><a href="#BarET.assemble_stimulus-390"><span class="linenos">390</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">sh</span><span class="p">)])</span>
</span><span id="BarET.assemble_stimulus-391"><a href="#BarET.assemble_stimulus-391"><span class="linenos">391</span></a>                <span class="k">elif</span> <span class="n">Hshift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET.assemble_stimulus-392"><a href="#BarET.assemble_stimulus-392"><span class="linenos">392</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Lc</span><span class="p">)])</span>
</span><span id="BarET.assemble_stimulus-393"><a href="#BarET.assemble_stimulus-393"><span class="linenos">393</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="BarET.assemble_stimulus-394"><a href="#BarET.assemble_stimulus-394"><span class="linenos">394</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="BarET.assemble_stimulus-395"><a href="#BarET.assemble_stimulus-395"><span class="linenos">395</span></a>                <span class="k">if</span> <span class="n">Hshift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET.assemble_stimulus-396"><a href="#BarET.assemble_stimulus-396"><span class="linenos">396</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="BarET.assemble_stimulus-397"><a href="#BarET.assemble_stimulus-397"><span class="linenos">397</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)])</span>
</span><span id="BarET.assemble_stimulus-398"><a href="#BarET.assemble_stimulus-398"><span class="linenos">398</span></a>                <span class="k">elif</span> <span class="n">Hshift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET.assemble_stimulus-399"><a href="#BarET.assemble_stimulus-399"><span class="linenos">399</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)])</span>
</span><span id="BarET.assemble_stimulus-400"><a href="#BarET.assemble_stimulus-400"><span class="linenos">400</span></a>                    <span class="n">Hstim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="BarET.assemble_stimulus-401"><a href="#BarET.assemble_stimulus-401"><span class="linenos">401</span></a>            <span class="c1"># Reassemble stimC</span>
</span><span id="BarET.assemble_stimulus-402"><a href="#BarET.assemble_stimulus-402"><span class="linenos">402</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Hstim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">Hstim</span><span class="p">)</span>
</span><span id="BarET.assemble_stimulus-403"><a href="#BarET.assemble_stimulus-403"><span class="linenos">403</span></a>   
</span><span id="BarET.assemble_stimulus-404"><a href="#BarET.assemble_stimulus-404"><span class="linenos">404</span></a>        <span class="c1"># Time embed horizontal and vertical stim</span>
</span><span id="BarET.assemble_stimulus-405"><a href="#BarET.assemble_stimulus-405"><span class="linenos">405</span></a>        <span class="k">if</span> <span class="n">time_embed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="BarET.assemble_stimulus-406"><a href="#BarET.assemble_stimulus-406"><span class="linenos">406</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Time embedding...&quot;</span><span class="p">)</span>
</span><span id="BarET.assemble_stimulus-407"><a href="#BarET.assemble_stimulus-407"><span class="linenos">407</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="BarET.assemble_stimulus-408"><a href="#BarET.assemble_stimulus-408"><span class="linenos">408</span></a>            <span class="n">tmp_stimH</span> <span class="o">=</span> <span class="n">Hstim</span><span class="p">[</span><span class="n">idx</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="BarET.assemble_stimulus-409"><a href="#BarET.assemble_stimulus-409"><span class="linenos">409</span></a>            <span class="n">tmp_stimV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">idx</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="BarET.assemble_stimulus-410"><a href="#BarET.assemble_stimulus-410"><span class="linenos">410</span></a>
</span><span id="BarET.assemble_stimulus-411"><a href="#BarET.assemble_stimulus-411"><span class="linenos">411</span></a>            <span class="n">tmp_stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimH</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="BarET.assemble_stimulus-412"><a href="#BarET.assemble_stimulus-412"><span class="linenos">412</span></a>            <span class="n">tmp_stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimV</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="BarET.assemble_stimulus-413"><a href="#BarET.assemble_stimulus-413"><span class="linenos">413</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="BarET.assemble_stimulus-414"><a href="#BarET.assemble_stimulus-414"><span class="linenos">414</span></a>                <span class="n">tmp_stimC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[</span><span class="n">idx</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="BarET.assemble_stimulus-415"><a href="#BarET.assemble_stimulus-415"><span class="linenos">415</span></a>                <span class="n">tmp_stimC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimC</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="BarET.assemble_stimulus-416"><a href="#BarET.assemble_stimulus-416"><span class="linenos">416</span></a>
</span><span id="BarET.assemble_stimulus-417"><a href="#BarET.assemble_stimulus-417"><span class="linenos">417</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="n">Hstim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BarET.assemble_stimulus-418"><a href="#BarET.assemble_stimulus-418"><span class="linenos">418</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimHout</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">tmp_stimH</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET.assemble_stimulus-419"><a href="#BarET.assemble_stimulus-419"><span class="linenos">419</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dimsH</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">tmp_stimH</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_lags</span><span class="p">]</span>
</span><span id="BarET.assemble_stimulus-420"><a href="#BarET.assemble_stimulus-420"><span class="linenos">420</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimVout</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">tmp_stimV</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET.assemble_stimulus-421"><a href="#BarET.assemble_stimulus-421"><span class="linenos">421</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dimsV</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">tmp_stimV</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_lags</span><span class="p">]</span>
</span><span id="BarET.assemble_stimulus-422"><a href="#BarET.assemble_stimulus-422"><span class="linenos">422</span></a>        
</span><span id="BarET.assemble_stimulus-423"><a href="#BarET.assemble_stimulus-423"><span class="linenos">423</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="BarET.assemble_stimulus-424"><a href="#BarET.assemble_stimulus-424"><span class="linenos">424</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">tmp_stimC</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_lags</span><span class="p">]</span>
</span><span id="BarET.assemble_stimulus-425"><a href="#BarET.assemble_stimulus-425"><span class="linenos">425</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> 
</span><span id="BarET.assemble_stimulus-426"><a href="#BarET.assemble_stimulus-426"><span class="linenos">426</span></a>                <span class="n">tmp_stimC</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">tmp_stimC</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> 
</span><span id="BarET.assemble_stimulus-427"><a href="#BarET.assemble_stimulus-427"><span class="linenos">427</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET.assemble_stimulus-428"><a href="#BarET.assemble_stimulus-428"><span class="linenos">428</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="BarET.assemble_stimulus-429"><a href="#BarET.assemble_stimulus-429"><span class="linenos">429</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_dimsH</span><span class="p">)</span>
</span><span id="BarET.assemble_stimulus-430"><a href="#BarET.assemble_stimulus-430"><span class="linenos">430</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimHout</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Assembles stimulus for the dataset
-- This will also time-embed the stimulus if requested
-- This will also shift the stimulus if requested
-- This will also crop the stimulus if requested</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>combine_stim:</strong>  whether to combine horizontal and vertical stimulus</li>
<li><strong>stim_crop:</strong>  whether to crop stimulus (not implemented)</li>
<li><strong>time_embed:</strong>  0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</li>
<li><strong>num_lags:</strong>  number of lags to include in time-embedding</li>
<li><strong>Hshift:</strong>  how much to shift horizontal stimulus (in bars)</li>
<li><strong>Hdiscardzero:</strong>  whether to discard zero position in horizontal stimulus</li>
<li><strong>shifts:</strong>  shifts to apply to stimulus (if not None)</li>
<li><strong>BUF:</strong>  buffer for shifting stimulus</li>
</ul>
</div>


                            </div>
                            <div id="BarET.to_tensor" class="classattr">
                                        <input id="BarET.to_tensor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">to_tensor</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">device</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BarET.to_tensor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BarET.to_tensor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BarET.to_tensor-433"><a href="#BarET.to_tensor-433"><span class="linenos">433</span></a>    <span class="k">def</span> <span class="nf">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="BarET.to_tensor-434"><a href="#BarET.to_tensor-434"><span class="linenos">434</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET.to_tensor-435"><a href="#BarET.to_tensor-435"><span class="linenos">435</span></a><span class="sd">        Converts all data to tensors</span>
</span><span id="BarET.to_tensor-436"><a href="#BarET.to_tensor-436"><span class="linenos">436</span></a>
</span><span id="BarET.to_tensor-437"><a href="#BarET.to_tensor-437"><span class="linenos">437</span></a><span class="sd">        Args:</span>
</span><span id="BarET.to_tensor-438"><a href="#BarET.to_tensor-438"><span class="linenos">438</span></a><span class="sd">            device: torch device to move data to</span>
</span><span id="BarET.to_tensor-439"><a href="#BarET.to_tensor-439"><span class="linenos">439</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET.to_tensor-440"><a href="#BarET.to_tensor-440"><span class="linenos">440</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="BarET.to_tensor-441"><a href="#BarET.to_tensor-441"><span class="linenos">441</span></a>            <span class="c1"># then already converted: just moving device</span>
</span><span id="BarET.to_tensor-442"><a href="#BarET.to_tensor-442"><span class="linenos">442</span></a>            <span class="c1">#self.stimH = self.stimH.to(device)</span>
</span><span id="BarET.to_tensor-443"><a href="#BarET.to_tensor-443"><span class="linenos">443</span></a>            <span class="c1">#self.stimV = self.stimV.to(device)</span>
</span><span id="BarET.to_tensor-444"><a href="#BarET.to_tensor-444"><span class="linenos">444</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET.to_tensor-445"><a href="#BarET.to_tensor-445"><span class="linenos">445</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET.to_tensor-446"><a href="#BarET.to_tensor-446"><span class="linenos">446</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET.to_tensor-447"><a href="#BarET.to_tensor-447"><span class="linenos">447</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET.to_tensor-448"><a href="#BarET.to_tensor-448"><span class="linenos">448</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="BarET.to_tensor-449"><a href="#BarET.to_tensor-449"><span class="linenos">449</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET.to_tensor-450"><a href="#BarET.to_tensor-450"><span class="linenos">450</span></a>
</span><span id="BarET.to_tensor-451"><a href="#BarET.to_tensor-451"><span class="linenos">451</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BarET.to_tensor-452"><a href="#BarET.to_tensor-452"><span class="linenos">452</span></a>            <span class="c1">#self.stimH = torch.tensor(self.stimH, dtype=torch.float32, device=device)</span>
</span><span id="BarET.to_tensor-453"><a href="#BarET.to_tensor-453"><span class="linenos">453</span></a>            <span class="c1">#self.stimV = torch.tensor(self.stimV, dtype=torch.float32, device=device)</span>
</span><span id="BarET.to_tensor-454"><a href="#BarET.to_tensor-454"><span class="linenos">454</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET.to_tensor-455"><a href="#BarET.to_tensor-455"><span class="linenos">455</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET.to_tensor-456"><a href="#BarET.to_tensor-456"><span class="linenos">456</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET.to_tensor-457"><a href="#BarET.to_tensor-457"><span class="linenos">457</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET.to_tensor-458"><a href="#BarET.to_tensor-458"><span class="linenos">458</span></a>            <span class="c1">#if self.combine_stim:</span>
</span><span id="BarET.to_tensor-459"><a href="#BarET.to_tensor-459"><span class="linenos">459</span></a>            <span class="c1">#    self.stimC = torch.tensor(self.stimC, dtype=torch.float32, device=device)</span>
</span></pre></div>


            <div class="docstring"><p>Converts all data to tensors</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>device:</strong>  torch device to move data to</li>
</ul>
</div>


                            </div>
                            <div id="BarET.process_fixations" class="classattr">
                                        <input id="BarET.process_fixations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">process_fixations</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">sacc_in</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BarET.process_fixations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BarET.process_fixations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BarET.process_fixations-462"><a href="#BarET.process_fixations-462"><span class="linenos">462</span></a>    <span class="k">def</span> <span class="nf">process_fixations</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sacc_in</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="BarET.process_fixations-463"><a href="#BarET.process_fixations-463"><span class="linenos">463</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET.process_fixations-464"><a href="#BarET.process_fixations-464"><span class="linenos">464</span></a><span class="sd">        Processes fixation informatiom from dataset, but also allows new saccade detection</span>
</span><span id="BarET.process_fixations-465"><a href="#BarET.process_fixations-465"><span class="linenos">465</span></a><span class="sd">        to be input and put in the right format within the dataset (main use).</span>
</span><span id="BarET.process_fixations-466"><a href="#BarET.process_fixations-466"><span class="linenos">466</span></a><span class="sd">        </span>
</span><span id="BarET.process_fixations-467"><a href="#BarET.process_fixations-467"><span class="linenos">467</span></a><span class="sd">        Args:</span>
</span><span id="BarET.process_fixations-468"><a href="#BarET.process_fixations-468"><span class="linenos">468</span></a><span class="sd">            sacc_in: new saccade information to be processed</span>
</span><span id="BarET.process_fixations-469"><a href="#BarET.process_fixations-469"><span class="linenos">469</span></a>
</span><span id="BarET.process_fixations-470"><a href="#BarET.process_fixations-470"><span class="linenos">470</span></a><span class="sd">        Returns:</span>
</span><span id="BarET.process_fixations-471"><a href="#BarET.process_fixations-471"><span class="linenos">471</span></a><span class="sd">            None: sets self.fix_n</span>
</span><span id="BarET.process_fixations-472"><a href="#BarET.process_fixations-472"><span class="linenos">472</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET.process_fixations-473"><a href="#BarET.process_fixations-473"><span class="linenos">473</span></a>        <span class="k">if</span> <span class="n">sacc_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BarET.process_fixations-474"><a href="#BarET.process_fixations-474"><span class="linenos">474</span></a>            <span class="n">sacc_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="BarET.process_fixations-475"><a href="#BarET.process_fixations-475"><span class="linenos">475</span></a>
</span><span id="BarET.process_fixations-476"><a href="#BarET.process_fixations-476"><span class="linenos">476</span></a>        <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> 
</span><span id="BarET.process_fixations-477"><a href="#BarET.process_fixations-477"><span class="linenos">477</span></a>        <span class="n">fix_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BarET.process_fixations-478"><a href="#BarET.process_fixations-478"><span class="linenos">478</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)):</span>
</span><span id="BarET.process_fixations-479"><a href="#BarET.process_fixations-479"><span class="linenos">479</span></a>            <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="BarET.process_fixations-480"><a href="#BarET.process_fixations-480"><span class="linenos">480</span></a>            <span class="c1">#self.block_inds.append(np.arange( blk_inds[ii,0], blk_inds[ii,1], dtype=np.int64))</span>
</span><span id="BarET.process_fixations-481"><a href="#BarET.process_fixations-481"><span class="linenos">481</span></a>
</span><span id="BarET.process_fixations-482"><a href="#BarET.process_fixations-482"><span class="linenos">482</span></a>            <span class="c1"># Parse fixation numbers within block</span>
</span><span id="BarET.process_fixations-483"><a href="#BarET.process_fixations-483"><span class="linenos">483</span></a>            <span class="n">rel_saccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">sacc_in</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sacc_in</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BarET.process_fixations-484"><a href="#BarET.process_fixations-484"><span class="linenos">484</span></a>
</span><span id="BarET.process_fixations-485"><a href="#BarET.process_fixations-485"><span class="linenos">485</span></a>            <span class="n">tfix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Beginning of fixation by definition</span>
</span><span id="BarET.process_fixations-486"><a href="#BarET.process_fixations-486"><span class="linenos">486</span></a>            <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel_saccs</span><span class="p">)):</span>
</span><span id="BarET.process_fixations-487"><a href="#BarET.process_fixations-487"><span class="linenos">487</span></a>                <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="BarET.process_fixations-488"><a href="#BarET.process_fixations-488"><span class="linenos">488</span></a>                <span class="c1"># Range goes to beginning of next fixation (note no gap)</span>
</span><span id="BarET.process_fixations-489"><a href="#BarET.process_fixations-489"><span class="linenos">489</span></a>                <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="BarET.process_fixations-490"><a href="#BarET.process_fixations-490"><span class="linenos">490</span></a>                <span class="n">tfix</span> <span class="o">=</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">6</span>
</span><span id="BarET.process_fixations-491"><a href="#BarET.process_fixations-491"><span class="linenos">491</span></a>            <span class="c1"># Put in last (or only) fixation number</span>
</span><span id="BarET.process_fixations-492"><a href="#BarET.process_fixations-492"><span class="linenos">492</span></a>            <span class="k">if</span> <span class="n">tfix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="BarET.process_fixations-493"><a href="#BarET.process_fixations-493"><span class="linenos">493</span></a>                <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="BarET.process_fixations-494"><a href="#BarET.process_fixations-494"><span class="linenos">494</span></a>                <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="BarET.process_fixations-495"><a href="#BarET.process_fixations-495"><span class="linenos">495</span></a>
</span><span id="BarET.process_fixations-496"><a href="#BarET.process_fixations-496"><span class="linenos">496</span></a>        <span class="c1"># Determine whether to be numpy or tensor</span>
</span><span id="BarET.process_fixations-497"><a href="#BarET.process_fixations-497"><span class="linenos">497</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="BarET.process_fixations-498"><a href="#BarET.process_fixations-498"><span class="linenos">498</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET.process_fixations-499"><a href="#BarET.process_fixations-499"><span class="linenos">499</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BarET.process_fixations-500"><a href="#BarET.process_fixations-500"><span class="linenos">500</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">fix_n</span>
</span></pre></div>


            <div class="docstring"><p>Processes fixation informatiom from dataset, but also allows new saccade detection
to be input and put in the right format within the dataset (main use).</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>sacc_in:</strong>  new saccade information to be processed</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: sets self.fix_n</p>
</blockquote>
</div>


                            </div>
                            <div id="BarET.add_shifter" class="classattr">
                                        <input id="BarET.add_shifter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_shifter</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">shifts</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BarET.add_shifter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BarET.add_shifter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BarET.add_shifter-503"><a href="#BarET.add_shifter-503"><span class="linenos">503</span></a>    <span class="k">def</span> <span class="nf">add_shifter</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">shifts</span> <span class="p">):</span>
</span><span id="BarET.add_shifter-504"><a href="#BarET.add_shifter-504"><span class="linenos">504</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET.add_shifter-505"><a href="#BarET.add_shifter-505"><span class="linenos">505</span></a><span class="sd">        Adds a shifter to the dataset</span>
</span><span id="BarET.add_shifter-506"><a href="#BarET.add_shifter-506"><span class="linenos">506</span></a>
</span><span id="BarET.add_shifter-507"><a href="#BarET.add_shifter-507"><span class="linenos">507</span></a><span class="sd">        Args:</span>
</span><span id="BarET.add_shifter-508"><a href="#BarET.add_shifter-508"><span class="linenos">508</span></a><span class="sd">            shifts: shifts to apply to the stimulus</span>
</span><span id="BarET.add_shifter-509"><a href="#BarET.add_shifter-509"><span class="linenos">509</span></a>
</span><span id="BarET.add_shifter-510"><a href="#BarET.add_shifter-510"><span class="linenos">510</span></a><span class="sd">        Returns:</span>
</span><span id="BarET.add_shifter-511"><a href="#BarET.add_shifter-511"><span class="linenos">511</span></a><span class="sd">            None: sets self.shifts</span>
</span><span id="BarET.add_shifter-512"><a href="#BarET.add_shifter-512"><span class="linenos">512</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET.add_shifter-513"><a href="#BarET.add_shifter-513"><span class="linenos">513</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">shifts</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">),</span> <span class="s2">&quot;Entered shifts is wrong size.&quot;</span>
</span><span id="BarET.add_shifter-514"><a href="#BarET.add_shifter-514"><span class="linenos">514</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span><span class="p">:</span>
</span><span id="BarET.add_shifter-515"><a href="#BarET.add_shifter-515"><span class="linenos">515</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="BarET.add_shifter-516"><a href="#BarET.add_shifter-516"><span class="linenos">516</span></a>        <span class="c1"># else: Delete old shifts?</span>
</span><span id="BarET.add_shifter-517"><a href="#BarET.add_shifter-517"><span class="linenos">517</span></a>        
</span><span id="BarET.add_shifter-518"><a href="#BarET.add_shifter-518"><span class="linenos">518</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">device</span>
</span><span id="BarET.add_shifter-519"><a href="#BarET.add_shifter-519"><span class="linenos">519</span></a>
</span><span id="BarET.add_shifter-520"><a href="#BarET.add_shifter-520"><span class="linenos">520</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">):</span>
</span><span id="BarET.add_shifter-521"><a href="#BarET.add_shifter-521"><span class="linenos">521</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="o">=</span> <span class="n">shifts</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="BarET.add_shifter-522"><a href="#BarET.add_shifter-522"><span class="linenos">522</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BarET.add_shifter-523"><a href="#BarET.add_shifter-523"><span class="linenos">523</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Adds a shifter to the dataset</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>shifts:</strong>  shifts to apply to the stimulus</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: sets self.shifts</p>
</blockquote>
</div>


                            </div>
                            <div id="BarET.avrates" class="classattr">
                                        <input id="BarET.avrates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">avrates</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">inds</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BarET.avrates-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BarET.avrates"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BarET.avrates-525"><a href="#BarET.avrates-525"><span class="linenos">525</span></a>    <span class="k">def</span> <span class="nf">avrates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="BarET.avrates-526"><a href="#BarET.avrates-526"><span class="linenos">526</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET.avrates-527"><a href="#BarET.avrates-527"><span class="linenos">527</span></a><span class="sd">        Calculates average firing probability across specified inds (or whole dataset)</span>
</span><span id="BarET.avrates-528"><a href="#BarET.avrates-528"><span class="linenos">528</span></a><span class="sd">        -- Note will respect datafilters</span>
</span><span id="BarET.avrates-529"><a href="#BarET.avrates-529"><span class="linenos">529</span></a><span class="sd">        -- will return precalc value to save time if already stored</span>
</span><span id="BarET.avrates-530"><a href="#BarET.avrates-530"><span class="linenos">530</span></a>
</span><span id="BarET.avrates-531"><a href="#BarET.avrates-531"><span class="linenos">531</span></a><span class="sd">        Args:</span>
</span><span id="BarET.avrates-532"><a href="#BarET.avrates-532"><span class="linenos">532</span></a><span class="sd">            inds: indices to calculate across</span>
</span><span id="BarET.avrates-533"><a href="#BarET.avrates-533"><span class="linenos">533</span></a>
</span><span id="BarET.avrates-534"><a href="#BarET.avrates-534"><span class="linenos">534</span></a><span class="sd">        Returns:</span>
</span><span id="BarET.avrates-535"><a href="#BarET.avrates-535"><span class="linenos">535</span></a><span class="sd">            avRs: average firing rates across specified indices</span>
</span><span id="BarET.avrates-536"><a href="#BarET.avrates-536"><span class="linenos">536</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET.avrates-537"><a href="#BarET.avrates-537"><span class="linenos">537</span></a>        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BarET.avrates-538"><a href="#BarET.avrates-538"><span class="linenos">538</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="BarET.avrates-539"><a href="#BarET.avrates-539"><span class="linenos">539</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="BarET.avrates-540"><a href="#BarET.avrates-540"><span class="linenos">540</span></a>            <span class="c1"># then calculate across whole dataset</span>
</span><span id="BarET.avrates-541"><a href="#BarET.avrates-541"><span class="linenos">541</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BarET.avrates-542"><a href="#BarET.avrates-542"><span class="linenos">542</span></a>                <span class="c1"># then precalculated and do not need to do</span>
</span><span id="BarET.avrates-543"><a href="#BarET.avrates-543"><span class="linenos">543</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span>
</span><span id="BarET.avrates-544"><a href="#BarET.avrates-544"><span class="linenos">544</span></a>
</span><span id="BarET.avrates-545"><a href="#BarET.avrates-545"><span class="linenos">545</span></a>        <span class="c1"># Otherwise calculate across all data</span>
</span><span id="BarET.avrates-546"><a href="#BarET.avrates-546"><span class="linenos">546</span></a>        <span class="n">Reff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="BarET.avrates-547"><a href="#BarET.avrates-547"><span class="linenos">547</span></a>        <span class="n">Teff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="BarET.avrates-548"><a href="#BarET.avrates-548"><span class="linenos">548</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="o">/</span><span class="n">Teff</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Calculates average firing probability across specified inds (or whole dataset)
-- Note will respect datafilters
-- will return precalc value to save time if already stored</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>inds:</strong>  indices to calculate across</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>avRs: average firing rates across specified indices</p>
</blockquote>
</div>


                            </div>
                            <div id="BarET.apply_data_mask" class="classattr">
                                        <input id="BarET.apply_data_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">apply_data_mask</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">dmask</span>, </span><span class="param"><span class="n">crange</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BarET.apply_data_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BarET.apply_data_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BarET.apply_data_mask-551"><a href="#BarET.apply_data_mask-551"><span class="linenos">551</span></a>    <span class="k">def</span> <span class="nf">apply_data_mask</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">dmask</span><span class="p">,</span> <span class="n">crange</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="BarET.apply_data_mask-552"><a href="#BarET.apply_data_mask-552"><span class="linenos">552</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET.apply_data_mask-553"><a href="#BarET.apply_data_mask-553"><span class="linenos">553</span></a><span class="sd">        For when data_filters (or a section) is modified based on models, and want to apply</span>
</span><span id="BarET.apply_data_mask-554"><a href="#BarET.apply_data_mask-554"><span class="linenos">554</span></a><span class="sd">        to the dataset. Ideally would save the original.</span>
</span><span id="BarET.apply_data_mask-555"><a href="#BarET.apply_data_mask-555"><span class="linenos">555</span></a><span class="sd">        </span>
</span><span id="BarET.apply_data_mask-556"><a href="#BarET.apply_data_mask-556"><span class="linenos">556</span></a><span class="sd">        Args:</span>
</span><span id="BarET.apply_data_mask-557"><a href="#BarET.apply_data_mask-557"><span class="linenos">557</span></a><span class="sd">            dmask: mask to apply to data_filters</span>
</span><span id="BarET.apply_data_mask-558"><a href="#BarET.apply_data_mask-558"><span class="linenos">558</span></a><span class="sd">            crange: range of cells to apply to</span>
</span><span id="BarET.apply_data_mask-559"><a href="#BarET.apply_data_mask-559"><span class="linenos">559</span></a>
</span><span id="BarET.apply_data_mask-560"><a href="#BarET.apply_data_mask-560"><span class="linenos">560</span></a><span class="sd">        Returns:</span>
</span><span id="BarET.apply_data_mask-561"><a href="#BarET.apply_data_mask-561"><span class="linenos">561</span></a><span class="sd">            None: sets self.dfs to new data mask</span>
</span><span id="BarET.apply_data_mask-562"><a href="#BarET.apply_data_mask-562"><span class="linenos">562</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET.apply_data_mask-563"><a href="#BarET.apply_data_mask-563"><span class="linenos">563</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dmask</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="BarET.apply_data_mask-564"><a href="#BarET.apply_data_mask-564"><span class="linenos">564</span></a>            <span class="n">dmask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dmask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="BarET.apply_data_mask-565"><a href="#BarET.apply_data_mask-565"><span class="linenos">565</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dmask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="BarET.apply_data_mask-566"><a href="#BarET.apply_data_mask-566"><span class="linenos">566</span></a>            <span class="n">dmask</span> <span class="o">=</span> <span class="n">dmask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="BarET.apply_data_mask-567"><a href="#BarET.apply_data_mask-567"><span class="linenos">567</span></a>        <span class="n">NT</span><span class="p">,</span> <span class="n">mask_size</span> <span class="o">=</span> <span class="n">dmask</span><span class="o">.</span><span class="n">shape</span>
</span><span id="BarET.apply_data_mask-568"><a href="#BarET.apply_data_mask-568"><span class="linenos">568</span></a>        <span class="k">assert</span> <span class="n">NT</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="s2">&quot;Data mask is wrong length&quot;</span>
</span><span id="BarET.apply_data_mask-569"><a href="#BarET.apply_data_mask-569"><span class="linenos">569</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET.apply_data_mask-570"><a href="#BarET.apply_data_mask-570"><span class="linenos">570</span></a>            <span class="n">cells_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="BarET.apply_data_mask-571"><a href="#BarET.apply_data_mask-571"><span class="linenos">571</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BarET.apply_data_mask-572"><a href="#BarET.apply_data_mask-572"><span class="linenos">572</span></a>            <span class="n">cells_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="BarET.apply_data_mask-573"><a href="#BarET.apply_data_mask-573"><span class="linenos">573</span></a>        <span class="k">if</span> <span class="n">crange</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BarET.apply_data_mask-574"><a href="#BarET.apply_data_mask-574"><span class="linenos">574</span></a>            <span class="n">crange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells_out</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="BarET.apply_data_mask-575"><a href="#BarET.apply_data_mask-575"><span class="linenos">575</span></a>        <span class="k">assert</span> <span class="n">mask_size</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">crange</span><span class="p">),</span> <span class="s2">&quot;mask does not cover the right range&quot;</span>
</span><span id="BarET.apply_data_mask-576"><a href="#BarET.apply_data_mask-576"><span class="linenos">576</span></a>
</span><span id="BarET.apply_data_mask-577"><a href="#BarET.apply_data_mask-577"><span class="linenos">577</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BarET.apply_data_mask-578"><a href="#BarET.apply_data_mask-578"><span class="linenos">578</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">)</span>
</span><span id="BarET.apply_data_mask-579"><a href="#BarET.apply_data_mask-579"><span class="linenos">579</span></a>        <span class="c1"># Given all assertions worked, then make copy</span>
</span><span id="BarET.apply_data_mask-580"><a href="#BarET.apply_data_mask-580"><span class="linenos">580</span></a>
</span><span id="BarET.apply_data_mask-581"><a href="#BarET.apply_data_mask-581"><span class="linenos">581</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">cells_out</span><span class="p">[</span><span class="n">crange</span><span class="p">]]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dmask</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>For when data_filters (or a section) is modified based on models, and want to apply
to the dataset. Ideally would save the original.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>dmask:</strong>  mask to apply to data_filters</li>
<li><strong>crange:</strong>  range of cells to apply to</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: sets self.dfs to new data mask</p>
</blockquote>
</div>


                            </div>
                            <div id="BarET.data_mask_revert" class="classattr">
                                        <input id="BarET.data_mask_revert-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">data_mask_revert</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">crange</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BarET.data_mask_revert-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BarET.data_mask_revert"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BarET.data_mask_revert-584"><a href="#BarET.data_mask_revert-584"><span class="linenos">584</span></a>    <span class="k">def</span> <span class="nf">data_mask_revert</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">crange</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="BarET.data_mask_revert-585"><a href="#BarET.data_mask_revert-585"><span class="linenos">585</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET.data_mask_revert-586"><a href="#BarET.data_mask_revert-586"><span class="linenos">586</span></a><span class="sd">        Reverts data mask to original</span>
</span><span id="BarET.data_mask_revert-587"><a href="#BarET.data_mask_revert-587"><span class="linenos">587</span></a>
</span><span id="BarET.data_mask_revert-588"><a href="#BarET.data_mask_revert-588"><span class="linenos">588</span></a><span class="sd">        Args:</span>
</span><span id="BarET.data_mask_revert-589"><a href="#BarET.data_mask_revert-589"><span class="linenos">589</span></a><span class="sd">            crange: range of cells to revert</span>
</span><span id="BarET.data_mask_revert-590"><a href="#BarET.data_mask_revert-590"><span class="linenos">590</span></a>
</span><span id="BarET.data_mask_revert-591"><a href="#BarET.data_mask_revert-591"><span class="linenos">591</span></a><span class="sd">        Returns:</span>
</span><span id="BarET.data_mask_revert-592"><a href="#BarET.data_mask_revert-592"><span class="linenos">592</span></a><span class="sd">            None: sets self.dfs to original data mask</span>
</span><span id="BarET.data_mask_revert-593"><a href="#BarET.data_mask_revert-593"><span class="linenos">593</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET.data_mask_revert-594"><a href="#BarET.data_mask_revert-594"><span class="linenos">594</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Nothing to revert&quot;</span>
</span><span id="BarET.data_mask_revert-595"><a href="#BarET.data_mask_revert-595"><span class="linenos">595</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span><span class="p">)</span>
</span><span id="BarET.data_mask_revert-596"><a href="#BarET.data_mask_revert-596"><span class="linenos">596</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Reverts data mask to original</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>crange:</strong>  range of cells to revert</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: sets self.dfs to original data mask</p>
</blockquote>
</div>


                            </div>
                            <div id="BarET.shift_stim_fixation" class="classattr">
                                        <input id="BarET.shift_stim_fixation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">shift_stim_fixation</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">stim</span>, </span><span class="param"><span class="n">shift</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BarET.shift_stim_fixation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BarET.shift_stim_fixation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BarET.shift_stim_fixation-598"><a href="#BarET.shift_stim_fixation-598"><span class="linenos">598</span></a>    <span class="k">def</span> <span class="nf">shift_stim_fixation</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
</span><span id="BarET.shift_stim_fixation-599"><a href="#BarET.shift_stim_fixation-599"><span class="linenos">599</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET.shift_stim_fixation-600"><a href="#BarET.shift_stim_fixation-600"><span class="linenos">600</span></a><span class="sd">        Simple shift by integer (rounded shift) and zero padded. Note that this is not in </span>
</span><span id="BarET.shift_stim_fixation-601"><a href="#BarET.shift_stim_fixation-601"><span class="linenos">601</span></a><span class="sd">        is in units of number of bars, rather than -1 to +1. It assumes the stim</span>
</span><span id="BarET.shift_stim_fixation-602"><a href="#BarET.shift_stim_fixation-602"><span class="linenos">602</span></a><span class="sd">        has a batch dimension (over a fixation), and shifts the whole stim by the same amount.</span>
</span><span id="BarET.shift_stim_fixation-603"><a href="#BarET.shift_stim_fixation-603"><span class="linenos">603</span></a><span class="sd">        </span>
</span><span id="BarET.shift_stim_fixation-604"><a href="#BarET.shift_stim_fixation-604"><span class="linenos">604</span></a><span class="sd">        Args:</span>
</span><span id="BarET.shift_stim_fixation-605"><a href="#BarET.shift_stim_fixation-605"><span class="linenos">605</span></a><span class="sd">            stim: stimulus to shift</span>
</span><span id="BarET.shift_stim_fixation-606"><a href="#BarET.shift_stim_fixation-606"><span class="linenos">606</span></a><span class="sd">            shift: amount to shift stimulus</span>
</span><span id="BarET.shift_stim_fixation-607"><a href="#BarET.shift_stim_fixation-607"><span class="linenos">607</span></a>
</span><span id="BarET.shift_stim_fixation-608"><a href="#BarET.shift_stim_fixation-608"><span class="linenos">608</span></a><span class="sd">        Returns:</span>
</span><span id="BarET.shift_stim_fixation-609"><a href="#BarET.shift_stim_fixation-609"><span class="linenos">609</span></a><span class="sd">            shstim: shifted stimulus</span>
</span><span id="BarET.shift_stim_fixation-610"><a href="#BarET.shift_stim_fixation-610"><span class="linenos">610</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET.shift_stim_fixation-611"><a href="#BarET.shift_stim_fixation-611"><span class="linenos">611</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Currently needs to be fixed to work with 2D&#39;</span><span class="p">)</span>
</span><span id="BarET.shift_stim_fixation-612"><a href="#BarET.shift_stim_fixation-612"><span class="linenos">612</span></a>        <span class="n">sh</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span>
</span><span id="BarET.shift_stim_fixation-613"><a href="#BarET.shift_stim_fixation-613"><span class="linenos">613</span></a>        <span class="n">shstim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="BarET.shift_stim_fixation-614"><a href="#BarET.shift_stim_fixation-614"><span class="linenos">614</span></a>        <span class="k">if</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET.shift_stim_fixation-615"><a href="#BarET.shift_stim_fixation-615"><span class="linenos">615</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="o">-</span><span class="n">sh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="p">:</span><span class="n">sh</span><span class="p">]</span>
</span><span id="BarET.shift_stim_fixation-616"><a href="#BarET.shift_stim_fixation-616"><span class="linenos">616</span></a>        <span class="k">elif</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET.shift_stim_fixation-617"><a href="#BarET.shift_stim_fixation-617"><span class="linenos">617</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="n">sh</span><span class="p">:]</span>
</span><span id="BarET.shift_stim_fixation-618"><a href="#BarET.shift_stim_fixation-618"><span class="linenos">618</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BarET.shift_stim_fixation-619"><a href="#BarET.shift_stim_fixation-619"><span class="linenos">619</span></a>            <span class="n">shstim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="BarET.shift_stim_fixation-620"><a href="#BarET.shift_stim_fixation-620"><span class="linenos">620</span></a>
</span><span id="BarET.shift_stim_fixation-621"><a href="#BarET.shift_stim_fixation-621"><span class="linenos">621</span></a>        <span class="k">return</span> <span class="n">shstim</span>
</span></pre></div>


            <div class="docstring"><p>Simple shift by integer (rounded shift) and zero padded. Note that this is not in 
is in units of number of bars, rather than -1 to +1. It assumes the stim
has a batch dimension (over a fixation), and shifts the whole stim by the same amount.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>stim:</strong>  stimulus to shift</li>
<li><strong>shift:</strong>  amount to shift stimulus</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>shstim: shifted stimulus</p>
</blockquote>
</div>


                            </div>
                            <div id="BarET.create_valid_indices" class="classattr">
                                        <input id="BarET.create_valid_indices-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_valid_indices</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">post_sacc_gap</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BarET.create_valid_indices-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BarET.create_valid_indices"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BarET.create_valid_indices-624"><a href="#BarET.create_valid_indices-624"><span class="linenos">624</span></a>    <span class="k">def</span> <span class="nf">create_valid_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post_sacc_gap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="BarET.create_valid_indices-625"><a href="#BarET.create_valid_indices-625"><span class="linenos">625</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET.create_valid_indices-626"><a href="#BarET.create_valid_indices-626"><span class="linenos">626</span></a><span class="sd">        This creates self.valid_inds vector that is used for __get_item__ </span>
</span><span id="BarET.create_valid_indices-627"><a href="#BarET.create_valid_indices-627"><span class="linenos">627</span></a><span class="sd">        -- Will default to num_lags following each saccade beginning</span>
</span><span id="BarET.create_valid_indices-628"><a href="#BarET.create_valid_indices-628"><span class="linenos">628</span></a><span class="sd">        </span>
</span><span id="BarET.create_valid_indices-629"><a href="#BarET.create_valid_indices-629"><span class="linenos">629</span></a><span class="sd">        Args:</span>
</span><span id="BarET.create_valid_indices-630"><a href="#BarET.create_valid_indices-630"><span class="linenos">630</span></a><span class="sd">            post_sacc_gap: number of lags to ignore after saccade</span>
</span><span id="BarET.create_valid_indices-631"><a href="#BarET.create_valid_indices-631"><span class="linenos">631</span></a>
</span><span id="BarET.create_valid_indices-632"><a href="#BarET.create_valid_indices-632"><span class="linenos">632</span></a><span class="sd">        Returns:</span>
</span><span id="BarET.create_valid_indices-633"><a href="#BarET.create_valid_indices-633"><span class="linenos">633</span></a><span class="sd">            None: sets self.valid_inds</span>
</span><span id="BarET.create_valid_indices-634"><a href="#BarET.create_valid_indices-634"><span class="linenos">634</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET.create_valid_indices-635"><a href="#BarET.create_valid_indices-635"><span class="linenos">635</span></a>
</span><span id="BarET.create_valid_indices-636"><a href="#BarET.create_valid_indices-636"><span class="linenos">636</span></a>        <span class="k">if</span> <span class="n">post_sacc_gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BarET.create_valid_indices-637"><a href="#BarET.create_valid_indices-637"><span class="linenos">637</span></a>            <span class="n">post_sacc_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="BarET.create_valid_indices-638"><a href="#BarET.create_valid_indices-638"><span class="linenos">638</span></a>
</span><span id="BarET.create_valid_indices-639"><a href="#BarET.create_valid_indices-639"><span class="linenos">639</span></a>        <span class="c1"># first, throw out all data where all data_filters are zero</span>
</span><span id="BarET.create_valid_indices-640"><a href="#BarET.create_valid_indices-640"><span class="linenos">640</span></a>        <span class="n">is_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="BarET.create_valid_indices-641"><a href="#BarET.create_valid_indices-641"><span class="linenos">641</span></a>        <span class="n">is_valid</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="BarET.create_valid_indices-642"><a href="#BarET.create_valid_indices-642"><span class="linenos">642</span></a>        
</span><span id="BarET.create_valid_indices-643"><a href="#BarET.create_valid_indices-643"><span class="linenos">643</span></a>        <span class="c1"># Now invalid post_sacc_gap following saccades</span>
</span><span id="BarET.create_valid_indices-644"><a href="#BarET.create_valid_indices-644"><span class="linenos">644</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span><span class="p">):</span>
</span><span id="BarET.create_valid_indices-645"><a href="#BarET.create_valid_indices-645"><span class="linenos">645</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:])</span>
</span><span id="BarET.create_valid_indices-646"><a href="#BarET.create_valid_indices-646"><span class="linenos">646</span></a>            <span class="n">sts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="BarET.create_valid_indices-647"><a href="#BarET.create_valid_indices-647"><span class="linenos">647</span></a>            <span class="n">is_valid</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">post_sacc_gap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BarET.create_valid_indices-648"><a href="#BarET.create_valid_indices-648"><span class="linenos">648</span></a>        
</span><span id="BarET.create_valid_indices-649"><a href="#BarET.create_valid_indices-649"><span class="linenos">649</span></a>        <span class="c1">#self.valid_inds = list(np.where(is_valid &gt; 0)[0])</span>
</span><span id="BarET.create_valid_indices-650"><a href="#BarET.create_valid_indices-650"><span class="linenos">650</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_valid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>This creates self.valid_inds vector that is used for __get_item__ 
-- Will default to num_lags following each saccade beginning</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>post_sacc_gap:</strong>  number of lags to ignore after saccade</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: sets self.valid_inds</p>
</blockquote>
</div>


                            </div>
                            <div id="BarET.crossval_setup" class="classattr">
                                        <input id="BarET.crossval_setup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">crossval_setup</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">folds</span><span class="o">=</span><span class="mi">5</span>, </span><span class="param"><span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">test_set</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BarET.crossval_setup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BarET.crossval_setup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BarET.crossval_setup-653"><a href="#BarET.crossval_setup-653"><span class="linenos">653</span></a>    <span class="k">def</span> <span class="nf">crossval_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test_set</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="BarET.crossval_setup-654"><a href="#BarET.crossval_setup-654"><span class="linenos">654</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET.crossval_setup-655"><a href="#BarET.crossval_setup-655"><span class="linenos">655</span></a><span class="sd">        This sets the cross-validation indices up We can add featuers here. Many ways to do this</span>
</span><span id="BarET.crossval_setup-656"><a href="#BarET.crossval_setup-656"><span class="linenos">656</span></a><span class="sd">        but will stick to some standard for now. It sets the internal indices, which can be read out</span>
</span><span id="BarET.crossval_setup-657"><a href="#BarET.crossval_setup-657"><span class="linenos">657</span></a><span class="sd">        directly or with helper functions. Perhaps helper_functions is the best way....</span>
</span><span id="BarET.crossval_setup-658"><a href="#BarET.crossval_setup-658"><span class="linenos">658</span></a><span class="sd">        </span>
</span><span id="BarET.crossval_setup-659"><a href="#BarET.crossval_setup-659"><span class="linenos">659</span></a><span class="sd">        Args:</span>
</span><span id="BarET.crossval_setup-660"><a href="#BarET.crossval_setup-660"><span class="linenos">660</span></a><span class="sd">            folds: number of folds to use</span>
</span><span id="BarET.crossval_setup-661"><a href="#BarET.crossval_setup-661"><span class="linenos">661</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="BarET.crossval_setup-662"><a href="#BarET.crossval_setup-662"><span class="linenos">662</span></a><span class="sd">            test_set: whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</span>
</span><span id="BarET.crossval_setup-663"><a href="#BarET.crossval_setup-663"><span class="linenos">663</span></a><span class="sd">            verbose: whether to print out information</span>
</span><span id="BarET.crossval_setup-664"><a href="#BarET.crossval_setup-664"><span class="linenos">664</span></a><span class="sd">        </span>
</span><span id="BarET.crossval_setup-665"><a href="#BarET.crossval_setup-665"><span class="linenos">665</span></a><span class="sd">        Returns:</span>
</span><span id="BarET.crossval_setup-666"><a href="#BarET.crossval_setup-666"><span class="linenos">666</span></a><span class="sd">            None: sets internal variables test_inds, train_inds, val_inds</span>
</span><span id="BarET.crossval_setup-667"><a href="#BarET.crossval_setup-667"><span class="linenos">667</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET.crossval_setup-668"><a href="#BarET.crossval_setup-668"><span class="linenos">668</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must first specify valid_indices before setting up cross-validation.&quot;</span>
</span><span id="BarET.crossval_setup-669"><a href="#BarET.crossval_setup-669"><span class="linenos">669</span></a>
</span><span id="BarET.crossval_setup-670"><a href="#BarET.crossval_setup-670"><span class="linenos">670</span></a>        <span class="c1"># Reflect block structure</span>
</span><span id="BarET.crossval_setup-671"><a href="#BarET.crossval_setup-671"><span class="linenos">671</span></a>        <span class="n">Nblks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="BarET.crossval_setup-672"><a href="#BarET.crossval_setup-672"><span class="linenos">672</span></a>        <span class="n">val_blk1</span><span class="p">,</span> <span class="n">tr_blk1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="n">Nblks</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="BarET.crossval_setup-673"><a href="#BarET.crossval_setup-673"><span class="linenos">673</span></a>
</span><span id="BarET.crossval_setup-674"><a href="#BarET.crossval_setup-674"><span class="linenos">674</span></a>        <span class="k">if</span> <span class="n">test_set</span><span class="p">:</span>
</span><span id="BarET.crossval_setup-675"><a href="#BarET.crossval_setup-675"><span class="linenos">675</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="n">val_blk1</span>
</span><span id="BarET.crossval_setup-676"><a href="#BarET.crossval_setup-676"><span class="linenos">676</span></a>            <span class="n">val_blk2</span><span class="p">,</span> <span class="n">tr_blk2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_blk1</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="BarET.crossval_setup-677"><a href="#BarET.crossval_setup-677"><span class="linenos">677</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span><span class="p">[</span><span class="n">val_blk2</span><span class="p">]</span>
</span><span id="BarET.crossval_setup-678"><a href="#BarET.crossval_setup-678"><span class="linenos">678</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span><span class="p">[</span><span class="n">tr_blk2</span><span class="p">]</span>
</span><span id="BarET.crossval_setup-679"><a href="#BarET.crossval_setup-679"><span class="linenos">679</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BarET.crossval_setup-680"><a href="#BarET.crossval_setup-680"><span class="linenos">680</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">val_blk1</span>
</span><span id="BarET.crossval_setup-681"><a href="#BarET.crossval_setup-681"><span class="linenos">681</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span>
</span><span id="BarET.crossval_setup-682"><a href="#BarET.crossval_setup-682"><span class="linenos">682</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BarET.crossval_setup-683"><a href="#BarET.crossval_setup-683"><span class="linenos">683</span></a>
</span><span id="BarET.crossval_setup-684"><a href="#BarET.crossval_setup-684"><span class="linenos">684</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="BarET.crossval_setup-685"><a href="#BarET.crossval_setup-685"><span class="linenos">685</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Partitioned </span><span class="si">%d</span><span class="s2"> fixations total: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span>
</span><span id="BarET.crossval_setup-686"><a href="#BarET.crossval_setup-686"><span class="linenos">686</span></a>                <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">)))</span>  
</span><span id="BarET.crossval_setup-687"><a href="#BarET.crossval_setup-687"><span class="linenos">687</span></a>
</span><span id="BarET.crossval_setup-688"><a href="#BarET.crossval_setup-688"><span class="linenos">688</span></a>        <span class="c1"># Now pull indices from each saccade </span>
</span><span id="BarET.crossval_setup-689"><a href="#BarET.crossval_setup-689"><span class="linenos">689</span></a>        <span class="n">tr_inds</span><span class="p">,</span> <span class="n">te_inds</span><span class="p">,</span> <span class="n">val_inds</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="BarET.crossval_setup-690"><a href="#BarET.crossval_setup-690"><span class="linenos">690</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">:</span>
</span><span id="BarET.crossval_setup-691"><a href="#BarET.crossval_setup-691"><span class="linenos">691</span></a>            <span class="n">tr_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="BarET.crossval_setup-692"><a href="#BarET.crossval_setup-692"><span class="linenos">692</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">:</span>
</span><span id="BarET.crossval_setup-693"><a href="#BarET.crossval_setup-693"><span class="linenos">693</span></a>            <span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="BarET.crossval_setup-694"><a href="#BarET.crossval_setup-694"><span class="linenos">694</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">:</span>
</span><span id="BarET.crossval_setup-695"><a href="#BarET.crossval_setup-695"><span class="linenos">695</span></a>            <span class="n">te_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="BarET.crossval_setup-696"><a href="#BarET.crossval_setup-696"><span class="linenos">696</span></a>
</span><span id="BarET.crossval_setup-697"><a href="#BarET.crossval_setup-697"><span class="linenos">697</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="BarET.crossval_setup-698"><a href="#BarET.crossval_setup-698"><span class="linenos">698</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Pre-valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">te_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="BarET.crossval_setup-699"><a href="#BarET.crossval_setup-699"><span class="linenos">699</span></a>
</span><span id="BarET.crossval_setup-700"><a href="#BarET.crossval_setup-700"><span class="linenos">700</span></a>        <span class="c1"># Finally intersect with used_inds</span>
</span><span id="BarET.crossval_setup-701"><a href="#BarET.crossval_setup-701"><span class="linenos">701</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="BarET.crossval_setup-702"><a href="#BarET.crossval_setup-702"><span class="linenos">702</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">val_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="BarET.crossval_setup-703"><a href="#BarET.crossval_setup-703"><span class="linenos">703</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">te_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="BarET.crossval_setup-704"><a href="#BarET.crossval_setup-704"><span class="linenos">704</span></a>
</span><span id="BarET.crossval_setup-705"><a href="#BarET.crossval_setup-705"><span class="linenos">705</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="BarET.crossval_setup-706"><a href="#BarET.crossval_setup-706"><span class="linenos">706</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span><span class="p">))</span> <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This sets the cross-validation indices up We can add featuers here. Many ways to do this
but will stick to some standard for now. It sets the internal indices, which can be read out
directly or with helper functions. Perhaps helper_functions is the best way....</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>folds:</strong>  number of folds to use</li>
<li><strong>random_gen:</strong>  whether to pick random fixations for validation or uniformly distributed</li>
<li><strong>test_set:</strong>  whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</li>
<li><strong>verbose:</strong>  whether to print out information</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: sets internal variables test_inds, train_inds, val_inds</p>
</blockquote>
</div>


                            </div>
                            <div id="BarET.fold_sample" class="classattr">
                                        <input id="BarET.fold_sample-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fold_sample</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">num_items</span>, </span><span class="param"><span class="n">folds</span>, </span><span class="param"><span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BarET.fold_sample-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BarET.fold_sample"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BarET.fold_sample-710"><a href="#BarET.fold_sample-710"><span class="linenos">710</span></a>    <span class="k">def</span> <span class="nf">fold_sample</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="BarET.fold_sample-711"><a href="#BarET.fold_sample-711"><span class="linenos">711</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET.fold_sample-712"><a href="#BarET.fold_sample-712"><span class="linenos">712</span></a><span class="sd">        This really should be a general method not associated with self</span>
</span><span id="BarET.fold_sample-713"><a href="#BarET.fold_sample-713"><span class="linenos">713</span></a><span class="sd">        </span>
</span><span id="BarET.fold_sample-714"><a href="#BarET.fold_sample-714"><span class="linenos">714</span></a><span class="sd">        Args:</span>
</span><span id="BarET.fold_sample-715"><a href="#BarET.fold_sample-715"><span class="linenos">715</span></a><span class="sd">            num_items: number of items to fold</span>
</span><span id="BarET.fold_sample-716"><a href="#BarET.fold_sample-716"><span class="linenos">716</span></a><span class="sd">            folds: number of folds</span>
</span><span id="BarET.fold_sample-717"><a href="#BarET.fold_sample-717"><span class="linenos">717</span></a><span class="sd">            random_gen: whether to randomly sample or uniformly sample</span>
</span><span id="BarET.fold_sample-718"><a href="#BarET.fold_sample-718"><span class="linenos">718</span></a>
</span><span id="BarET.fold_sample-719"><a href="#BarET.fold_sample-719"><span class="linenos">719</span></a><span class="sd">        Returns:</span>
</span><span id="BarET.fold_sample-720"><a href="#BarET.fold_sample-720"><span class="linenos">720</span></a><span class="sd">            val_items: indices of validation items</span>
</span><span id="BarET.fold_sample-721"><a href="#BarET.fold_sample-721"><span class="linenos">721</span></a><span class="sd">            rem_items: indices of remaining items</span>
</span><span id="BarET.fold_sample-722"><a href="#BarET.fold_sample-722"><span class="linenos">722</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET.fold_sample-723"><a href="#BarET.fold_sample-723"><span class="linenos">723</span></a>        <span class="k">if</span> <span class="n">random_gen</span><span class="p">:</span>
</span><span id="BarET.fold_sample-724"><a href="#BarET.fold_sample-724"><span class="linenos">724</span></a>            <span class="n">num_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_items</span><span class="o">/</span><span class="n">folds</span><span class="p">)</span>
</span><span id="BarET.fold_sample-725"><a href="#BarET.fold_sample-725"><span class="linenos">725</span></a>            <span class="n">tmp_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">num_items</span><span class="p">)</span>
</span><span id="BarET.fold_sample-726"><a href="#BarET.fold_sample-726"><span class="linenos">726</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[:</span><span class="n">num_val</span><span class="p">])</span>
</span><span id="BarET.fold_sample-727"><a href="#BarET.fold_sample-727"><span class="linenos">727</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[</span><span class="n">num_val</span><span class="p">:])</span>
</span><span id="BarET.fold_sample-728"><a href="#BarET.fold_sample-728"><span class="linenos">728</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BarET.fold_sample-729"><a href="#BarET.fold_sample-729"><span class="linenos">729</span></a>            <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">folds</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="BarET.fold_sample-730"><a href="#BarET.fold_sample-730"><span class="linenos">730</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
</span><span id="BarET.fold_sample-731"><a href="#BarET.fold_sample-731"><span class="linenos">731</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">),</span> <span class="n">val_items</span><span class="p">)</span>
</span><span id="BarET.fold_sample-732"><a href="#BarET.fold_sample-732"><span class="linenos">732</span></a>        <span class="k">return</span> <span class="n">val_items</span><span class="p">,</span> <span class="n">rem_items</span>
</span></pre></div>


            <div class="docstring"><p>This really should be a general method not associated with self</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>num_items:</strong>  number of items to fold</li>
<li><strong>folds:</strong>  number of folds</li>
<li><strong>random_gen:</strong>  whether to randomly sample or uniformly sample</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>val_items: indices of validation items
  rem_items: indices of remaining items</p>
</blockquote>
</div>


                            </div>
                            <div id="BarET.adjust_Xdrift_xval" class="classattr">
                                        <input id="BarET.adjust_Xdrift_xval-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">adjust_Xdrift_xval</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BarET.adjust_Xdrift_xval-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BarET.adjust_Xdrift_xval"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BarET.adjust_Xdrift_xval-734"><a href="#BarET.adjust_Xdrift_xval-734"><span class="linenos">734</span></a>    <span class="k">def</span> <span class="nf">adjust_Xdrift_xval</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="BarET.adjust_Xdrift_xval-735"><a href="#BarET.adjust_Xdrift_xval-735"><span class="linenos">735</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BarET.adjust_Xdrift_xval-736"><a href="#BarET.adjust_Xdrift_xval-736"><span class="linenos">736</span></a><span class="sd">        Adjust drift matrix to not fit xval parameterz</span>
</span><span id="BarET.adjust_Xdrift_xval-737"><a href="#BarET.adjust_Xdrift_xval-737"><span class="linenos">737</span></a>
</span><span id="BarET.adjust_Xdrift_xval-738"><a href="#BarET.adjust_Xdrift_xval-738"><span class="linenos">738</span></a><span class="sd">        Args:</span>
</span><span id="BarET.adjust_Xdrift_xval-739"><a href="#BarET.adjust_Xdrift_xval-739"><span class="linenos">739</span></a><span class="sd">            None</span>
</span><span id="BarET.adjust_Xdrift_xval-740"><a href="#BarET.adjust_Xdrift_xval-740"><span class="linenos">740</span></a>
</span><span id="BarET.adjust_Xdrift_xval-741"><a href="#BarET.adjust_Xdrift_xval-741"><span class="linenos">741</span></a><span class="sd">        Returns:</span>
</span><span id="BarET.adjust_Xdrift_xval-742"><a href="#BarET.adjust_Xdrift_xval-742"><span class="linenos">742</span></a><span class="sd">            None: sets self.Xdrift to adjusted version</span>
</span><span id="BarET.adjust_Xdrift_xval-743"><a href="#BarET.adjust_Xdrift_xval-743"><span class="linenos">743</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BarET.adjust_Xdrift_xval-744"><a href="#BarET.adjust_Xdrift_xval-744"><span class="linenos">744</span></a>        <span class="n">Xnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">]</span>
</span><span id="BarET.adjust_Xdrift_xval-745"><a href="#BarET.adjust_Xdrift_xval-745"><span class="linenos">745</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">)):</span>
</span><span id="BarET.adjust_Xdrift_xval-746"><a href="#BarET.adjust_Xdrift_xval-746"><span class="linenos">746</span></a>            <span class="n">newpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">ii</span> <span class="c1"># this will be where lower range is</span>
</span><span id="BarET.adjust_Xdrift_xval-747"><a href="#BarET.adjust_Xdrift_xval-747"><span class="linenos">747</span></a>            <span class="k">if</span> <span class="n">newpos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BarET.adjust_Xdrift_xval-748"><a href="#BarET.adjust_Xdrift_xval-748"><span class="linenos">748</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="BarET.adjust_Xdrift_xval-749"><a href="#BarET.adjust_Xdrift_xval-749"><span class="linenos">749</span></a>            <span class="k">elif</span> <span class="n">newpos</span> <span class="o">==</span> <span class="n">Xnew</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="BarET.adjust_Xdrift_xval-750"><a href="#BarET.adjust_Xdrift_xval-750"><span class="linenos">750</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="BarET.adjust_Xdrift_xval-751"><a href="#BarET.adjust_Xdrift_xval-751"><span class="linenos">751</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># In between</span>
</span><span id="BarET.adjust_Xdrift_xval-752"><a href="#BarET.adjust_Xdrift_xval-752"><span class="linenos">752</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span> <span class="n">newpos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="BarET.adjust_Xdrift_xval-753"><a href="#BarET.adjust_Xdrift_xval-753"><span class="linenos">753</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span> <span class="n">newpos</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="BarET.adjust_Xdrift_xval-754"><a href="#BarET.adjust_Xdrift_xval-754"><span class="linenos">754</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">Xnew</span>
</span></pre></div>


            <div class="docstring"><p>Adjust drift matrix to not fit xval parameterz</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li>None</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: sets self.Xdrift to adjusted version</p>
</blockquote>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="../sensory_base.html#SensoryBase">NTdatasets.sensory_base.SensoryBase</a></dt>
                                <dd id="BarET.datadir" class="variable"><a href="../sensory_base.html#SensoryBase.datadir">datadir</a></dd>
                <dd id="BarET.filenames" class="variable"><a href="../sensory_base.html#SensoryBase.filenames">filenames</a></dd>
                <dd id="BarET.device" class="variable"><a href="../sensory_base.html#SensoryBase.device">device</a></dd>
                <dd id="BarET.block_sample" class="variable"><a href="../sensory_base.html#SensoryBase.block_sample">block_sample</a></dd>
                <dd id="BarET.num_lags" class="variable"><a href="../sensory_base.html#SensoryBase.num_lags">num_lags</a></dd>
                <dd id="BarET.stim_dims" class="variable"><a href="../sensory_base.html#SensoryBase.stim_dims">stim_dims</a></dd>
                <dd id="BarET.time_embed" class="variable"><a href="../sensory_base.html#SensoryBase.time_embed">time_embed</a></dd>
                <dd id="BarET.preload" class="variable"><a href="../sensory_base.html#SensoryBase.preload">preload</a></dd>
                <dd id="BarET.drift_interval" class="variable"><a href="../sensory_base.html#SensoryBase.drift_interval">drift_interval</a></dd>
                <dd id="BarET.SUs" class="variable"><a href="../sensory_base.html#SensoryBase.SUs">SUs</a></dd>
                <dd id="BarET.NC" class="variable"><a href="../sensory_base.html#SensoryBase.NC">NC</a></dd>
                <dd id="BarET.block_inds" class="variable"><a href="../sensory_base.html#SensoryBase.block_inds">block_inds</a></dd>
                <dd id="BarET.block_filemapping" class="variable"><a href="../sensory_base.html#SensoryBase.block_filemapping">block_filemapping</a></dd>
                <dd id="BarET.include_MUs" class="variable"><a href="../sensory_base.html#SensoryBase.include_MUs">include_MUs</a></dd>
                <dd id="BarET.SUinds" class="variable"><a href="../sensory_base.html#SensoryBase.SUinds">SUinds</a></dd>
                <dd id="BarET.MUinds" class="variable"><a href="../sensory_base.html#SensoryBase.MUinds">MUinds</a></dd>
                <dd id="BarET.cells_out" class="variable"><a href="../sensory_base.html#SensoryBase.cells_out">cells_out</a></dd>
                <dd id="BarET.robs_out" class="variable"><a href="../sensory_base.html#SensoryBase.robs_out">robs_out</a></dd>
                <dd id="BarET.dfs_out" class="variable"><a href="../sensory_base.html#SensoryBase.dfs_out">dfs_out</a></dd>
                <dd id="BarET.test_inds" class="variable"><a href="../sensory_base.html#SensoryBase.test_inds">test_inds</a></dd>
                <dd id="BarET.val_inds" class="variable"><a href="../sensory_base.html#SensoryBase.val_inds">val_inds</a></dd>
                <dd id="BarET.train_inds" class="variable"><a href="../sensory_base.html#SensoryBase.train_inds">train_inds</a></dd>
                <dd id="BarET.test_blks" class="variable"><a href="../sensory_base.html#SensoryBase.test_blks">test_blks</a></dd>
                <dd id="BarET.val_blks" class="variable"><a href="../sensory_base.html#SensoryBase.val_blks">val_blks</a></dd>
                <dd id="BarET.train_blks" class="variable"><a href="../sensory_base.html#SensoryBase.train_blks">train_blks</a></dd>
                <dd id="BarET.speckled" class="variable"><a href="../sensory_base.html#SensoryBase.speckled">speckled</a></dd>
                <dd id="BarET.stim" class="variable"><a href="../sensory_base.html#SensoryBase.stim">stim</a></dd>
                <dd id="BarET.dfs" class="variable"><a href="../sensory_base.html#SensoryBase.dfs">dfs</a></dd>
                <dd id="BarET.robs" class="variable"><a href="../sensory_base.html#SensoryBase.robs">robs</a></dd>
                <dd id="BarET.covariates" class="variable"><a href="../sensory_base.html#SensoryBase.covariates">covariates</a></dd>
                <dd id="BarET.cov_dims" class="variable"><a href="../sensory_base.html#SensoryBase.cov_dims">cov_dims</a></dd>
                <dd id="BarET.add_covariate" class="function"><a href="../sensory_base.html#SensoryBase.add_covariate">add_covariate</a></dd>
                <dd id="BarET.append_covariates" class="function"><a href="../sensory_base.html#SensoryBase.append_covariates">append_covariates</a></dd>
                <dd id="BarET.prepare_stim" class="function"><a href="../sensory_base.html#SensoryBase.prepare_stim">prepare_stim</a></dd>
                <dd id="BarET.set_cells" class="function"><a href="../sensory_base.html#SensoryBase.set_cells">set_cells</a></dd>
                <dd id="BarET.time_embedding" class="function"><a href="../sensory_base.html#SensoryBase.time_embedding">time_embedding</a></dd>
                <dd id="BarET.construct_drift_design_matrix" class="function"><a href="../sensory_base.html#SensoryBase.construct_drift_design_matrix">construct_drift_design_matrix</a></dd>
                <dd id="BarET.trial_psths" class="function"><a href="../sensory_base.html#SensoryBase.trial_psths">trial_psths</a></dd>
                <dd id="BarET.construct_LVtents" class="function"><a href="../sensory_base.html#SensoryBase.construct_LVtents">construct_LVtents</a></dd>
                <dd id="BarET.setup_trial_LVs" class="function"><a href="../sensory_base.html#SensoryBase.setup_trial_LVs">setup_trial_LVs</a></dd>
                <dd id="BarET.setup_LVLayer_input" class="function"><a href="../sensory_base.html#SensoryBase.setup_LVLayer_input">setup_LVLayer_input</a></dd>
                <dd id="BarET.design_matrix_drift" class="function"><a href="../sensory_base.html#SensoryBase.design_matrix_drift">design_matrix_drift</a></dd>
                <dd id="BarET.construct_onehot_design_matrix" class="function"><a href="../sensory_base.html#SensoryBase.construct_onehot_design_matrix">construct_onehot_design_matrix</a></dd>
                <dd id="BarET.speckledXV_setup" class="function"><a href="../sensory_base.html#SensoryBase.speckledXV_setup">speckledXV_setup</a></dd>
                <dd id="BarET.set_speckledXV" class="function"><a href="../sensory_base.html#SensoryBase.set_speckledXV">set_speckledXV</a></dd>
                <dd id="BarET.make_data_dicts" class="function"><a href="../sensory_base.html#SensoryBase.make_data_dicts">make_data_dicts</a></dd>
                <dd id="BarET.get_max_samples" class="function"><a href="../sensory_base.html#SensoryBase.get_max_samples">get_max_samples</a></dd>
                <dd id="BarET.is_int" class="function"><a href="../sensory_base.html#SensoryBase.is_int">is_int</a></dd>
                <dd id="BarET.index_to_array" class="function"><a href="../sensory_base.html#SensoryBase.index_to_array">index_to_array</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Bar1Dv7">
                            <input id="Bar1Dv7-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Bar1Dv7</span><wbr>(<span class="base">typing.Generic[+T_co]</span>):

                <label class="view-source-button" for="Bar1Dv7-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1Dv7"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1Dv7-818"><a href="#Bar1Dv7-818"><span class="linenos"> 818</span></a><span class="k">class</span> <span class="nc">Bar1Dv7</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span><span id="Bar1Dv7-819"><a href="#Bar1Dv7-819"><span class="linenos"> 819</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-820"><a href="#Bar1Dv7-820"><span class="linenos"> 820</span></a><span class="sd">    -- can load batches from multiple datasets</span>
</span><span id="Bar1Dv7-821"><a href="#Bar1Dv7-821"><span class="linenos"> 821</span></a><span class="sd">    -- hdf5 files must have the following information:</span>
</span><span id="Bar1Dv7-822"><a href="#Bar1Dv7-822"><span class="linenos"> 822</span></a><span class="sd">        Robs</span>
</span><span id="Bar1Dv7-823"><a href="#Bar1Dv7-823"><span class="linenos"> 823</span></a><span class="sd">        RobsMU</span>
</span><span id="Bar1Dv7-824"><a href="#Bar1Dv7-824"><span class="linenos"> 824</span></a><span class="sd">        stim: 4-d stimulus: time x nx x ny x color</span>
</span><span id="Bar1Dv7-825"><a href="#Bar1Dv7-825"><span class="linenos"> 825</span></a><span class="sd">        block_inds: start and stop of &#39;trials&#39; (perhaps fixations for now)</span>
</span><span id="Bar1Dv7-826"><a href="#Bar1Dv7-826"><span class="linenos"> 826</span></a><span class="sd">        other things: saccades? or should that be in trials? </span>
</span><span id="Bar1Dv7-827"><a href="#Bar1Dv7-827"><span class="linenos"> 827</span></a>
</span><span id="Bar1Dv7-828"><a href="#Bar1Dv7-828"><span class="linenos"> 828</span></a><span class="sd">    Constructor will take eye position, which for now is an input from data</span>
</span><span id="Bar1Dv7-829"><a href="#Bar1Dv7-829"><span class="linenos"> 829</span></a><span class="sd">    generated in the session (not on disk). It should have the length size </span>
</span><span id="Bar1Dv7-830"><a href="#Bar1Dv7-830"><span class="linenos"> 830</span></a><span class="sd">    of the total number of fixations x1.</span>
</span><span id="Bar1Dv7-831"><a href="#Bar1Dv7-831"><span class="linenos"> 831</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-832"><a href="#Bar1Dv7-832"><span class="linenos"> 832</span></a>
</span><span id="Bar1Dv7-833"><a href="#Bar1Dv7-833"><span class="linenos"> 833</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="Bar1Dv7-834"><a href="#Bar1Dv7-834"><span class="linenos"> 834</span></a>        <span class="n">sess_list</span><span class="p">,</span>
</span><span id="Bar1Dv7-835"><a href="#Bar1Dv7-835"><span class="linenos"> 835</span></a>        <span class="n">datadir</span><span class="p">,</span> 
</span><span id="Bar1Dv7-836"><a href="#Bar1Dv7-836"><span class="linenos"> 836</span></a>        <span class="c1"># Stim setup</span>
</span><span id="Bar1Dv7-837"><a href="#Bar1Dv7-837"><span class="linenos"> 837</span></a>        <span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
</span><span id="Bar1Dv7-838"><a href="#Bar1Dv7-838"><span class="linenos"> 838</span></a>        <span class="c1">#which_stim = &#39;stimET&#39;,</span>
</span><span id="Bar1Dv7-839"><a href="#Bar1Dv7-839"><span class="linenos"> 839</span></a>        <span class="n">stim_crop</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Bar1Dv7-840"><a href="#Bar1Dv7-840"><span class="linenos"> 840</span></a>        <span class="n">Hstim_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># to shift-and-wrap stimH stimulus</span>
</span><span id="Bar1Dv7-841"><a href="#Bar1Dv7-841"><span class="linenos"> 841</span></a>        <span class="n">Hdiscardzero</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Bar1Dv7-842"><a href="#Bar1Dv7-842"><span class="linenos"> 842</span></a>        <span class="n">time_embed</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="Bar1Dv7-843"><a href="#Bar1Dv7-843"><span class="linenos"> 843</span></a>        <span class="n">folded_lags</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Bar1Dv7-844"><a href="#Bar1Dv7-844"><span class="linenos"> 844</span></a>        <span class="c1"># Stim configuation</span>
</span><span id="Bar1Dv7-845"><a href="#Bar1Dv7-845"><span class="linenos"> 845</span></a>        <span class="n">combine_stim</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># if False, horizontal stim will be &#39;stim&#39;</span>
</span><span id="Bar1Dv7-846"><a href="#Bar1Dv7-846"><span class="linenos"> 846</span></a>        <span class="n">stim_gap</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="Bar1Dv7-847"><a href="#Bar1Dv7-847"><span class="linenos"> 847</span></a>        <span class="n">drift_interval</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>  <span class="c1"># how many trials to anchor each drift term</span>
</span><span id="Bar1Dv7-848"><a href="#Bar1Dv7-848"><span class="linenos"> 848</span></a>        <span class="c1"># eye configuration</span>
</span><span id="Bar1Dv7-849"><a href="#Bar1Dv7-849"><span class="linenos"> 849</span></a>        <span class="n">eye_config</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 0 = all, 1, -1, and 2 are options (2 = binocular)</span>
</span><span id="Bar1Dv7-850"><a href="#Bar1Dv7-850"><span class="linenos"> 850</span></a>        <span class="c1"># other</span>
</span><span id="Bar1Dv7-851"><a href="#Bar1Dv7-851"><span class="linenos"> 851</span></a>        <span class="n">ignore_saccades</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Bar1Dv7-852"><a href="#Bar1Dv7-852"><span class="linenos"> 852</span></a>        <span class="n">include_MUs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Bar1Dv7-853"><a href="#Bar1Dv7-853"><span class="linenos"> 853</span></a>        <span class="n">preload</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Bar1Dv7-854"><a href="#Bar1Dv7-854"><span class="linenos"> 854</span></a>        <span class="n">eyepos</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="Bar1Dv7-855"><a href="#Bar1Dv7-855"><span class="linenos"> 855</span></a>        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
</span><span id="Bar1Dv7-856"><a href="#Bar1Dv7-856"><span class="linenos"> 856</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-857"><a href="#Bar1Dv7-857"><span class="linenos"> 857</span></a><span class="sd">        Constructor options</span>
</span><span id="Bar1Dv7-858"><a href="#Bar1Dv7-858"><span class="linenos"> 858</span></a>
</span><span id="Bar1Dv7-859"><a href="#Bar1Dv7-859"><span class="linenos"> 859</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7-860"><a href="#Bar1Dv7-860"><span class="linenos"> 860</span></a><span class="sd">            sess_list: list of sessions to load</span>
</span><span id="Bar1Dv7-861"><a href="#Bar1Dv7-861"><span class="linenos"> 861</span></a><span class="sd">            datadir: directory where data is stored</span>
</span><span id="Bar1Dv7-862"><a href="#Bar1Dv7-862"><span class="linenos"> 862</span></a><span class="sd">            num_lags: number of lags to include in time-embedding</span>
</span><span id="Bar1Dv7-863"><a href="#Bar1Dv7-863"><span class="linenos"> 863</span></a><span class="sd">            stim_crop: whether to crop stimulus (not implemented)</span>
</span><span id="Bar1Dv7-864"><a href="#Bar1Dv7-864"><span class="linenos"> 864</span></a><span class="sd">            Hstim_shift: how much to shift horizontal stimulus (in bars)</span>
</span><span id="Bar1Dv7-865"><a href="#Bar1Dv7-865"><span class="linenos"> 865</span></a><span class="sd">            Hdiscardzero: whether to discard zero position in horizontal stimulus</span>
</span><span id="Bar1Dv7-866"><a href="#Bar1Dv7-866"><span class="linenos"> 866</span></a><span class="sd">            time_embed: 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="Bar1Dv7-867"><a href="#Bar1Dv7-867"><span class="linenos"> 867</span></a><span class="sd">            folded_lags: whether to fold lags in time-embedding</span>
</span><span id="Bar1Dv7-868"><a href="#Bar1Dv7-868"><span class="linenos"> 868</span></a><span class="sd">            combine_stim: whether to combine horizontal and vertical stimulus</span>
</span><span id="Bar1Dv7-869"><a href="#Bar1Dv7-869"><span class="linenos"> 869</span></a><span class="sd">            stim_gap: gap between horizontal and vertical stimuli</span>
</span><span id="Bar1Dv7-870"><a href="#Bar1Dv7-870"><span class="linenos"> 870</span></a><span class="sd">            drift_interval: how many trials to anchor each drift term</span>
</span><span id="Bar1Dv7-871"><a href="#Bar1Dv7-871"><span class="linenos"> 871</span></a><span class="sd">            eye_config: 0 = all, 1, -1, and 2 are options (2 = binocular)</span>
</span><span id="Bar1Dv7-872"><a href="#Bar1Dv7-872"><span class="linenos"> 872</span></a><span class="sd">            ignore_saccades: whether to ignore saccades</span>
</span><span id="Bar1Dv7-873"><a href="#Bar1Dv7-873"><span class="linenos"> 873</span></a><span class="sd">            include_MUs: whether to include multi-units</span>
</span><span id="Bar1Dv7-874"><a href="#Bar1Dv7-874"><span class="linenos"> 874</span></a><span class="sd">            preload: whether to preload data</span>
</span><span id="Bar1Dv7-875"><a href="#Bar1Dv7-875"><span class="linenos"> 875</span></a><span class="sd">            eyepos: eye position data</span>
</span><span id="Bar1Dv7-876"><a href="#Bar1Dv7-876"><span class="linenos"> 876</span></a><span class="sd">            device: torch device to move data to</span>
</span><span id="Bar1Dv7-877"><a href="#Bar1Dv7-877"><span class="linenos"> 877</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-878"><a href="#Bar1Dv7-878"><span class="linenos"> 878</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">datadir</span>
</span><span id="Bar1Dv7-879"><a href="#Bar1Dv7-879"><span class="linenos"> 879</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sess_list</span> <span class="o">=</span> <span class="n">sess_list</span>
</span><span id="Bar1Dv7-880"><a href="#Bar1Dv7-880"><span class="linenos"> 880</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
</span><span id="Bar1Dv7-881"><a href="#Bar1Dv7-881"><span class="linenos"> 881</span></a>        
</span><span id="Bar1Dv7-882"><a href="#Bar1Dv7-882"><span class="linenos"> 882</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span> <span class="o">=</span> <span class="n">num_lags</span>
</span><span id="Bar1Dv7-883"><a href="#Bar1Dv7-883"><span class="linenos"> 883</span></a>        <span class="k">if</span> <span class="n">time_embed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Bar1Dv7-884"><a href="#Bar1Dv7-884"><span class="linenos"> 884</span></a>            <span class="k">assert</span> <span class="n">preload</span><span class="p">,</span> <span class="s2">&quot;Cannot pre-time-embed without preloading.&quot;</span>
</span><span id="Bar1Dv7-885"><a href="#Bar1Dv7-885"><span class="linenos"> 885</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">=</span> <span class="n">time_embed</span>
</span><span id="Bar1Dv7-886"><a href="#Bar1Dv7-886"><span class="linenos"> 886</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preload</span> <span class="o">=</span> <span class="n">preload</span>
</span><span id="Bar1Dv7-887"><a href="#Bar1Dv7-887"><span class="linenos"> 887</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="o">=</span> <span class="n">stim_crop</span>
</span><span id="Bar1Dv7-888"><a href="#Bar1Dv7-888"><span class="linenos"> 888</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span> <span class="o">=</span> <span class="n">folded_lags</span>
</span><span id="Bar1Dv7-889"><a href="#Bar1Dv7-889"><span class="linenos"> 889</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span> <span class="o">=</span> <span class="n">combine_stim</span>
</span><span id="Bar1Dv7-890"><a href="#Bar1Dv7-890"><span class="linenos"> 890</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">=</span> <span class="n">eye_config</span>
</span><span id="Bar1Dv7-891"><a href="#Bar1Dv7-891"><span class="linenos"> 891</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_gap</span> <span class="o">=</span> <span class="n">stim_gap</span>
</span><span id="Bar1Dv7-892"><a href="#Bar1Dv7-892"><span class="linenos"> 892</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimHshift</span> <span class="o">=</span> <span class="n">Hstim_shift</span>
</span><span id="Bar1Dv7-893"><a href="#Bar1Dv7-893"><span class="linenos"> 893</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Hdiscardzero</span> <span class="o">=</span> <span class="n">Hdiscardzero</span>
</span><span id="Bar1Dv7-894"><a href="#Bar1Dv7-894"><span class="linenos"> 894</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span> <span class="o">=</span> <span class="n">drift_interval</span>
</span><span id="Bar1Dv7-895"><a href="#Bar1Dv7-895"><span class="linenos"> 895</span></a>
</span><span id="Bar1Dv7-896"><a href="#Bar1Dv7-896"><span class="linenos"> 896</span></a>        <span class="c1"># get hdf5 file handles</span>
</span><span id="Bar1Dv7-897"><a href="#Bar1Dv7-897"><span class="linenos"> 897</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">sess</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_list</span><span class="p">]</span>
</span><span id="Bar1Dv7-898"><a href="#Bar1Dv7-898"><span class="linenos"> 898</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1Dv7-899"><a href="#Bar1Dv7-899"><span class="linenos"> 899</span></a>
</span><span id="Bar1Dv7-900"><a href="#Bar1Dv7-900"><span class="linenos"> 900</span></a>        <span class="c1"># Data to just read in and store</span>
</span><span id="Bar1Dv7-901"><a href="#Bar1Dv7-901"><span class="linenos"> 901</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ETstim_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ETstim_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Bar1Dv7-902"><a href="#Bar1Dv7-902"><span class="linenos"> 902</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;stim_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Bar1Dv7-903"><a href="#Bar1Dv7-903"><span class="linenos"> 903</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;fix_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7-904"><a href="#Bar1Dv7-904"><span class="linenos"> 904</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probeIDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Robs_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="Bar1Dv7-905"><a href="#Bar1Dv7-905"><span class="linenos"> 905</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probeIDsMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;RobsMU_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="Bar1Dv7-906"><a href="#Bar1Dv7-906"><span class="linenos"> 906</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dt&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7-907"><a href="#Bar1Dv7-907"><span class="linenos"> 907</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;pixel_size&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7-908"><a href="#Bar1Dv7-908"><span class="linenos"> 908</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exptdate</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># need to learn matlab strings in HDF5 format (not saved as HDF5 string)</span>
</span><span id="Bar1Dv7-909"><a href="#Bar1Dv7-909"><span class="linenos"> 909</span></a>
</span><span id="Bar1Dv7-910"><a href="#Bar1Dv7-910"><span class="linenos"> 910</span></a>        <span class="c1"># build index map</span>
</span><span id="Bar1Dv7-911"><a href="#Bar1Dv7-911"><span class="linenos"> 911</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_threshold</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># how many valid time points required to include saccade?</span>
</span><span id="Bar1Dv7-912"><a href="#Bar1Dv7-912"><span class="linenos"> 912</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_index</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># which file the block corresponds to</span>
</span><span id="Bar1Dv7-913"><a href="#Bar1Dv7-913"><span class="linenos"> 913</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7-914"><a href="#Bar1Dv7-914"><span class="linenos"> 914</span></a>        <span class="c1">#self.unit_ids = []</span>
</span><span id="Bar1Dv7-915"><a href="#Bar1Dv7-915"><span class="linenos"> 915</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_sus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_mus</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="Bar1Dv7-916"><a href="#Bar1Dv7-916"><span class="linenos"> 916</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sus</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7-917"><a href="#Bar1Dv7-917"><span class="linenos"> 917</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1Dv7-918"><a href="#Bar1Dv7-918"><span class="linenos"> 918</span></a>        <span class="c1">#self.stim_dims = None</span>
</span><span id="Bar1Dv7-919"><a href="#Bar1Dv7-919"><span class="linenos"> 919</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span> <span class="o">=</span> <span class="n">eyepos</span>
</span><span id="Bar1Dv7-920"><a href="#Bar1Dv7-920"><span class="linenos"> 920</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_Xfix</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Bar1Dv7-921"><a href="#Bar1Dv7-921"><span class="linenos"> 921</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sess_list</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Bar1Dv7-922"><a href="#Bar1Dv7-922"><span class="linenos"> 922</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7-923"><a href="#Bar1Dv7-923"><span class="linenos"> 923</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_filemapping</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7-924"><a href="#Bar1Dv7-924"><span class="linenos"> 924</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span> <span class="o">=</span> <span class="n">include_MUs</span>
</span><span id="Bar1Dv7-925"><a href="#Bar1Dv7-925"><span class="linenos"> 925</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">SUinds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7-926"><a href="#Bar1Dv7-926"><span class="linenos"> 926</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">MUinds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7-927"><a href="#Bar1Dv7-927"><span class="linenos"> 927</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># can be list to output specific cells in get_item</span>
</span><span id="Bar1Dv7-928"><a href="#Bar1Dv7-928"><span class="linenos"> 928</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1Dv7-929"><a href="#Bar1Dv7-929"><span class="linenos"> 929</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Bar1Dv7-930"><a href="#Bar1Dv7-930"><span class="linenos"> 930</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1Dv7-931"><a href="#Bar1Dv7-931"><span class="linenos"> 931</span></a>
</span><span id="Bar1Dv7-932"><a href="#Bar1Dv7-932"><span class="linenos"> 932</span></a>        <span class="c1"># Set up to store default train_, val_, test_inds</span>
</span><span id="Bar1Dv7-933"><a href="#Bar1Dv7-933"><span class="linenos"> 933</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1Dv7-934"><a href="#Bar1Dv7-934"><span class="linenos"> 934</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1Dv7-935"><a href="#Bar1Dv7-935"><span class="linenos"> 935</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1Dv7-936"><a href="#Bar1Dv7-936"><span class="linenos"> 936</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="Bar1Dv7-937"><a href="#Bar1Dv7-937"><span class="linenos"> 937</span></a>
</span><span id="Bar1Dv7-938"><a href="#Bar1Dv7-938"><span class="linenos"> 938</span></a>        <span class="c1"># Data to construct and store in memory</span>
</span><span id="Bar1Dv7-939"><a href="#Bar1Dv7-939"><span class="linenos"> 939</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7-940"><a href="#Bar1Dv7-940"><span class="linenos"> 940</span></a>        <span class="c1">#self.sacc_on = []</span>
</span><span id="Bar1Dv7-941"><a href="#Bar1Dv7-941"><span class="linenos"> 941</span></a>        <span class="c1">#self.sacc_off = []</span>
</span><span id="Bar1Dv7-942"><a href="#Bar1Dv7-942"><span class="linenos"> 942</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7-943"><a href="#Bar1Dv7-943"><span class="linenos"> 943</span></a>
</span><span id="Bar1Dv7-944"><a href="#Bar1Dv7-944"><span class="linenos"> 944</span></a>        <span class="n">tcount</span><span class="p">,</span> <span class="n">fix_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="Bar1Dv7-945"><a href="#Bar1Dv7-945"><span class="linenos"> 945</span></a>
</span><span id="Bar1Dv7-946"><a href="#Bar1Dv7-946"><span class="linenos"> 946</span></a>        <span class="c1">#if which_stim is None:</span>
</span><span id="Bar1Dv7-947"><a href="#Bar1Dv7-947"><span class="linenos"> 947</span></a>        <span class="c1">#    stimname = &#39;stimET&#39;</span>
</span><span id="Bar1Dv7-948"><a href="#Bar1Dv7-948"><span class="linenos"> 948</span></a>        <span class="c1">#else:</span>
</span><span id="Bar1Dv7-949"><a href="#Bar1Dv7-949"><span class="linenos"> 949</span></a>        <span class="c1">#    stimname = which_stim</span>
</span><span id="Bar1Dv7-950"><a href="#Bar1Dv7-950"><span class="linenos"> 950</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span> <span class="o">=</span> <span class="s1">&#39;stimET&#39;</span>
</span><span id="Bar1Dv7-951"><a href="#Bar1Dv7-951"><span class="linenos"> 951</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ETtraceHR</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7-952"><a href="#Bar1Dv7-952"><span class="linenos"> 952</span></a>
</span><span id="Bar1Dv7-953"><a href="#Bar1Dv7-953"><span class="linenos"> 953</span></a>        <span class="k">for</span> <span class="n">fnum</span><span class="p">,</span> <span class="n">fhandle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">):</span>
</span><span id="Bar1Dv7-954"><a href="#Bar1Dv7-954"><span class="linenos"> 954</span></a>
</span><span id="Bar1Dv7-955"><a href="#Bar1Dv7-955"><span class="linenos"> 955</span></a>            <span class="n">NT</span><span class="p">,</span> <span class="n">NSUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="Bar1Dv7-956"><a href="#Bar1Dv7-956"><span class="linenos"> 956</span></a>            <span class="n">NX</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Bar1Dv7-957"><a href="#Bar1Dv7-957"><span class="linenos"> 957</span></a>            <span class="n">NMUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Bar1Dv7-958"><a href="#Bar1Dv7-958"><span class="linenos"> 958</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_sus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NSUfile</span><span class="p">)</span>
</span><span id="Bar1Dv7-959"><a href="#Bar1Dv7-959"><span class="linenos"> 959</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_mus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NMUfile</span><span class="p">)</span>
</span><span id="Bar1Dv7-960"><a href="#Bar1Dv7-960"><span class="linenos"> 960</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sus</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="o">+</span><span class="n">NSUfile</span><span class="p">))</span>
</span><span id="Bar1Dv7-961"><a href="#Bar1Dv7-961"><span class="linenos"> 961</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;block_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span id="Bar1Dv7-962"><a href="#Bar1Dv7-962"><span class="linenos"> 962</span></a>            <span class="n">stim_eyes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useLeye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span>  \
</span><span id="Bar1Dv7-963"><a href="#Bar1Dv7-963"><span class="linenos"> 963</span></a>                            <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Bar1Dv7-964"><a href="#Bar1Dv7-964"><span class="linenos"> 964</span></a>            
</span><span id="Bar1Dv7-965"><a href="#Bar1Dv7-965"><span class="linenos"> 965</span></a>            <span class="n">Reye</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">]</span>
</span><span id="Bar1Dv7-966"><a href="#Bar1Dv7-966"><span class="linenos"> 966</span></a>            <span class="n">NCfile</span> <span class="o">=</span> <span class="n">NSUfile</span>
</span><span id="Bar1Dv7-967"><a href="#Bar1Dv7-967"><span class="linenos"> 967</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="Bar1Dv7-968"><a href="#Bar1Dv7-968"><span class="linenos"> 968</span></a>                <span class="n">NCfile</span> <span class="o">+=</span> <span class="n">NMUfile</span>
</span><span id="Bar1Dv7-969"><a href="#Bar1Dv7-969"><span class="linenos"> 969</span></a>            
</span><span id="Bar1Dv7-970"><a href="#Bar1Dv7-970"><span class="linenos"> 970</span></a>            <span class="c1"># This will associate each block with each file</span>
</span><span id="Bar1Dv7-971"><a href="#Bar1Dv7-971"><span class="linenos"> 971</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_filemapping</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="n">fnum</span><span class="p">)</span>
</span><span id="Bar1Dv7-972"><a href="#Bar1Dv7-972"><span class="linenos"> 972</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span><span class="p">[</span><span class="n">fnum</span><span class="p">]</span><span class="o">=</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7-973"><a href="#Bar1Dv7-973"><span class="linenos"> 973</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span><span class="p">[</span><span class="n">fnum</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1Dv7-974"><a href="#Bar1Dv7-974"><span class="linenos"> 974</span></a>            <span class="c1">#if self.stim_dims is None:</span>
</span><span id="Bar1Dv7-975"><a href="#Bar1Dv7-975"><span class="linenos"> 975</span></a>            <span class="c1">#if folded_lags:</span>
</span><span id="Bar1Dv7-976"><a href="#Bar1Dv7-976"><span class="linenos"> 976</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">([</span><span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="c1">#list(fhandle[stimname].shape[1:4]) + [1]</span>
</span><span id="Bar1Dv7-977"><a href="#Bar1Dv7-977"><span class="linenos"> 977</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Bar1Dv7-978"><a href="#Bar1Dv7-978"><span class="linenos"> 978</span></a>          
</span><span id="Bar1Dv7-979"><a href="#Bar1Dv7-979"><span class="linenos"> 979</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-980"><a href="#Bar1Dv7-980"><span class="linenos"> 980</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="Bar1Dv7-981"><a href="#Bar1Dv7-981"><span class="linenos"> 981</span></a>
</span><span id="Bar1Dv7-982"><a href="#Bar1Dv7-982"><span class="linenos"> 982</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stim check:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">,</span> <span class="n">folded_lags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</span><span id="Bar1Dv7-983"><a href="#Bar1Dv7-983"><span class="linenos"> 983</span></a>
</span><span id="Bar1Dv7-984"><a href="#Bar1Dv7-984"><span class="linenos"> 984</span></a>            <span class="c1">#self.unit_ids.append(self.NC + np.asarray(range(NCfile)))</span>
</span><span id="Bar1Dv7-985"><a href="#Bar1Dv7-985"><span class="linenos"> 985</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NCfile</span><span class="p">)</span>
</span><span id="Bar1Dv7-986"><a href="#Bar1Dv7-986"><span class="linenos"> 986</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">+=</span> <span class="n">NCfile</span>
</span><span id="Bar1Dv7-987"><a href="#Bar1Dv7-987"><span class="linenos"> 987</span></a>
</span><span id="Bar1Dv7-988"><a href="#Bar1Dv7-988"><span class="linenos"> 988</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;sacc_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="Bar1Dv7-989"><a href="#Bar1Dv7-989"><span class="linenos"> 989</span></a>            <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>  <span class="c1"># each time point labels fixation number</span>
</span><span id="Bar1Dv7-990"><a href="#Bar1Dv7-990"><span class="linenos"> 990</span></a>            <span class="c1">#sacc_on = np.zeros(NT, dtype=np.float32)  # each time point labels fixation number</span>
</span><span id="Bar1Dv7-991"><a href="#Bar1Dv7-991"><span class="linenos"> 991</span></a>            <span class="c1">#sacc_on[sacc_inds[:,0]-1] = 1.0</span>
</span><span id="Bar1Dv7-992"><a href="#Bar1Dv7-992"><span class="linenos"> 992</span></a>            <span class="c1">#sacc_off = np.zeros(NT, dtype=np.float32)  # each time point labels fixation number</span>
</span><span id="Bar1Dv7-993"><a href="#Bar1Dv7-993"><span class="linenos"> 993</span></a>            <span class="c1">#sacc_off[sacc_inds[:,1]-1] = 1.0</span>
</span><span id="Bar1Dv7-994"><a href="#Bar1Dv7-994"><span class="linenos"> 994</span></a>
</span><span id="Bar1Dv7-995"><a href="#Bar1Dv7-995"><span class="linenos"> 995</span></a>            <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;valid_data&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="mi">1</span>  <span class="c1">#range(self.NT)  # default -- to be changed at end of init</span>
</span><span id="Bar1Dv7-996"><a href="#Bar1Dv7-996"><span class="linenos"> 996</span></a>
</span><span id="Bar1Dv7-997"><a href="#Bar1Dv7-997"><span class="linenos"> 997</span></a>            <span class="c1">### Process blocks and fixations/saccades</span>
</span><span id="Bar1Dv7-998"><a href="#Bar1Dv7-998"><span class="linenos"> 998</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="Bar1Dv7-999"><a href="#Bar1Dv7-999"><span class="linenos"> 999</span></a>                <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="Bar1Dv7-1000"><a href="#Bar1Dv7-1000"><span class="linenos">1000</span></a>                <span class="n">include_block</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Bar1Dv7-1001"><a href="#Bar1Dv7-1001"><span class="linenos">1001</span></a>                <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Bar1Dv7-1002"><a href="#Bar1Dv7-1002"><span class="linenos">1002</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-1003"><a href="#Bar1Dv7-1003"><span class="linenos">1003</span></a>                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">stim_eyes</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-1004"><a href="#Bar1Dv7-1004"><span class="linenos">1004</span></a>                        <span class="n">include_block</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Bar1Dv7-1005"><a href="#Bar1Dv7-1005"><span class="linenos">1005</span></a>                <span class="k">if</span> <span class="n">include_block</span><span class="p">:</span>
</span><span id="Bar1Dv7-1006"><a href="#Bar1Dv7-1006"><span class="linenos">1006</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
</span><span id="Bar1Dv7-1007"><a href="#Bar1Dv7-1007"><span class="linenos">1007</span></a>                    <span class="c1">#self.block_inds.append( np.arange( blk_inds[ii,0], blk_inds[ii,1], dtype=np.int64) )</span>
</span><span id="Bar1Dv7-1008"><a href="#Bar1Dv7-1008"><span class="linenos">1008</span></a>
</span><span id="Bar1Dv7-1009"><a href="#Bar1Dv7-1009"><span class="linenos">1009</span></a>            <span class="c1"># Got through each block to segment into fixations</span>
</span><span id="Bar1Dv7-1010"><a href="#Bar1Dv7-1010"><span class="linenos">1010</span></a>            <span class="c1">#for nn in range(blk_inds.shape[0]):</span>
</span><span id="Bar1Dv7-1011"><a href="#Bar1Dv7-1011"><span class="linenos">1011</span></a>            <span class="c1">#    # note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="Bar1Dv7-1012"><a href="#Bar1Dv7-1012"><span class="linenos">1012</span></a>            <span class="c1">#    include_block = True</span>
</span><span id="Bar1Dv7-1013"><a href="#Bar1Dv7-1013"><span class="linenos">1013</span></a>            <span class="c1">#    ts = np.arange( blk_inds[nn,0]-1, blk_inds[nn,1], dtype=int)</span>
</span><span id="Bar1Dv7-1014"><a href="#Bar1Dv7-1014"><span class="linenos">1014</span></a>            <span class="c1">#    if self.eye_config &gt; 0:</span>
</span><span id="Bar1Dv7-1015"><a href="#Bar1Dv7-1015"><span class="linenos">1015</span></a>            <span class="c1">#        if np.sum(stim_eyes[ts] == self.eye_config) == 0:</span>
</span><span id="Bar1Dv7-1016"><a href="#Bar1Dv7-1016"><span class="linenos">1016</span></a>            <span class="c1">#            include_block = False</span>
</span><span id="Bar1Dv7-1017"><a href="#Bar1Dv7-1017"><span class="linenos">1017</span></a>            <span class="c1">#    if include_block:</span>
</span><span id="Bar1Dv7-1018"><a href="#Bar1Dv7-1018"><span class="linenos">1018</span></a>            <span class="c1">#        self.block_inds.append(deepcopy(ts))</span>
</span><span id="Bar1Dv7-1019"><a href="#Bar1Dv7-1019"><span class="linenos">1019</span></a>            <span class="c1">#        t0 = blk_inds[nn, 0]-1</span>
</span><span id="Bar1Dv7-1020"><a href="#Bar1Dv7-1020"><span class="linenos">1020</span></a>                    <span class="c1">#valid_inds[range(t0, t0+num_lags)] = 0  # this already adjusted for?</span>
</span><span id="Bar1Dv7-1021"><a href="#Bar1Dv7-1021"><span class="linenos">1021</span></a>
</span><span id="Bar1Dv7-1022"><a href="#Bar1Dv7-1022"><span class="linenos">1022</span></a>                    <span class="c1"># Parse fixation numbers within block</span>
</span><span id="Bar1Dv7-1023"><a href="#Bar1Dv7-1023"><span class="linenos">1023</span></a>            <span class="c1">#        if not ignore_saccades:</span>
</span><span id="Bar1Dv7-1024"><a href="#Bar1Dv7-1024"><span class="linenos">1024</span></a>            <span class="c1">#            rel_saccs = np.where((sacc_inds[:,0] &gt; t0) &amp; (sacc_inds[:,0] &lt; blk_inds[nn,1]))[0]</span>
</span><span id="Bar1Dv7-1025"><a href="#Bar1Dv7-1025"><span class="linenos">1025</span></a>            <span class="c1">#            for mm in range(len(rel_saccs)):</span>
</span><span id="Bar1Dv7-1026"><a href="#Bar1Dv7-1026"><span class="linenos">1026</span></a>            <span class="c1">#                fix_count += 1</span>
</span><span id="Bar1Dv7-1027"><a href="#Bar1Dv7-1027"><span class="linenos">1027</span></a>            <span class="c1">#                fix_n[ range(t0, sacc_inds[rel_saccs[mm], 0]) ] = fix_count</span>
</span><span id="Bar1Dv7-1028"><a href="#Bar1Dv7-1028"><span class="linenos">1028</span></a>            <span class="c1">#                t0 = sacc_inds[rel_saccs[mm], 1]-1</span>
</span><span id="Bar1Dv7-1029"><a href="#Bar1Dv7-1029"><span class="linenos">1029</span></a>                    <span class="c1"># Put in last (or only) fixation number</span>
</span><span id="Bar1Dv7-1030"><a href="#Bar1Dv7-1030"><span class="linenos">1030</span></a>            <span class="c1">#        if t0 &lt; blk_inds[nn, 1]:</span>
</span><span id="Bar1Dv7-1031"><a href="#Bar1Dv7-1031"><span class="linenos">1031</span></a>            <span class="c1">#            fix_count += 1</span>
</span><span id="Bar1Dv7-1032"><a href="#Bar1Dv7-1032"><span class="linenos">1032</span></a>            <span class="c1">#            fix_n[ range(t0, blk_inds[nn, 1]) ] = fix_count</span>
</span><span id="Bar1Dv7-1033"><a href="#Bar1Dv7-1033"><span class="linenos">1033</span></a>            
</span><span id="Bar1Dv7-1034"><a href="#Bar1Dv7-1034"><span class="linenos">1034</span></a>            <span class="n">tcount</span> <span class="o">+=</span> <span class="n">NT</span>
</span><span id="Bar1Dv7-1035"><a href="#Bar1Dv7-1035"><span class="linenos">1035</span></a>            <span class="c1"># make larger fix_n, valid_inds, sacc_inds, block_inds as self</span>
</span><span id="Bar1Dv7-1036"><a href="#Bar1Dv7-1036"><span class="linenos">1036</span></a>
</span><span id="Bar1Dv7-1037"><a href="#Bar1Dv7-1037"><span class="linenos">1037</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>  <span class="o">=</span> <span class="n">tcount</span>
</span><span id="Bar1Dv7-1038"><a href="#Bar1Dv7-1038"><span class="linenos">1038</span></a>
</span><span id="Bar1Dv7-1039"><a href="#Bar1Dv7-1039"><span class="linenos">1039</span></a>        <span class="c1"># For now let&#39;s just debug with one file</span>
</span><span id="Bar1Dv7-1040"><a href="#Bar1Dv7-1040"><span class="linenos">1040</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sess_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Bar1Dv7-1041"><a href="#Bar1Dv7-1041"><span class="linenos">1041</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: currently ignoring multiple files&#39;</span><span class="p">)</span>
</span><span id="Bar1Dv7-1042"><a href="#Bar1Dv7-1042"><span class="linenos">1042</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">valid_inds</span><span class="p">)</span>
</span><span id="Bar1Dv7-1043"><a href="#Bar1Dv7-1043"><span class="linenos">1043</span></a>        <span class="c1">#self.fix_n = deepcopy(fix_n)</span>
</span><span id="Bar1Dv7-1044"><a href="#Bar1Dv7-1044"><span class="linenos">1044</span></a>        <span class="c1">#self.sac_on = deepcopy(sacc_on)</span>
</span><span id="Bar1Dv7-1045"><a href="#Bar1Dv7-1045"><span class="linenos">1045</span></a>        <span class="c1">#self.sac_off = deepcopy(sacc_off)</span>
</span><span id="Bar1Dv7-1046"><a href="#Bar1Dv7-1046"><span class="linenos">1046</span></a>        <span class="c1">#self.sacc_inds = deepcopy(sacc_inds)</span>
</span><span id="Bar1Dv7-1047"><a href="#Bar1Dv7-1047"><span class="linenos">1047</span></a>        
</span><span id="Bar1Dv7-1048"><a href="#Bar1Dv7-1048"><span class="linenos">1048</span></a>        <span class="c1"># PULL OTHER INFO</span>
</span><span id="Bar1Dv7-1049"><a href="#Bar1Dv7-1049"><span class="linenos">1049</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ETtraceHR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;ETtrace_raw&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7-1050"><a href="#Bar1Dv7-1050"><span class="linenos">1050</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sort_rating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs_rating&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="Bar1Dv7-1051"><a href="#Bar1Dv7-1051"><span class="linenos">1051</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sort_ratingMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU_rating&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span>
</span><span id="Bar1Dv7-1052"><a href="#Bar1Dv7-1052"><span class="linenos">1052</span></a>
</span><span id="Bar1Dv7-1053"><a href="#Bar1Dv7-1053"><span class="linenos">1053</span></a>        <span class="c1"># Go through saccades to establish val_indices and produce saccade timing vector </span>
</span><span id="Bar1Dv7-1054"><a href="#Bar1Dv7-1054"><span class="linenos">1054</span></a>        <span class="c1"># Note that sacc_ts will be generated even without preload -- small enough that doesnt matter</span>
</span><span id="Bar1Dv7-1055"><a href="#Bar1Dv7-1055"><span class="linenos">1055</span></a>    <span class="c1">#    self.sacc_ts = np.zeros([self.NT, 1], dtype=np.float32)</span>
</span><span id="Bar1Dv7-1056"><a href="#Bar1Dv7-1056"><span class="linenos">1056</span></a>    <span class="c1">#    self.fix_n = np.zeros(self.NT, dtype=np.int64)  # label of which fixation is in each range</span>
</span><span id="Bar1Dv7-1057"><a href="#Bar1Dv7-1057"><span class="linenos">1057</span></a>    <span class="c1">#    for nn in range(self.num_fixations):</span>
</span><span id="Bar1Dv7-1058"><a href="#Bar1Dv7-1058"><span class="linenos">1058</span></a>    <span class="c1">#        print(nn, self.sacc_inds[nn][0], self.sacc_inds[nn][1] )</span>
</span><span id="Bar1Dv7-1059"><a href="#Bar1Dv7-1059"><span class="linenos">1059</span></a>    <span class="c1">#        self.sacc_ts[self.sacc_inds[nn][0]] = 1 </span>
</span><span id="Bar1Dv7-1060"><a href="#Bar1Dv7-1060"><span class="linenos">1060</span></a>    <span class="c1">#        self.fix_n[range(self.sacc_inds[nn][0], self.sacc_inds[nn][1])] = nn</span>
</span><span id="Bar1Dv7-1061"><a href="#Bar1Dv7-1061"><span class="linenos">1061</span></a>        <span class="c1">#self.fix_n = list(self.fix_n)  # better list than numpy</span>
</span><span id="Bar1Dv7-1062"><a href="#Bar1Dv7-1062"><span class="linenos">1062</span></a>
</span><span id="Bar1Dv7-1063"><a href="#Bar1Dv7-1063"><span class="linenos">1063</span></a>        <span class="c1">#self.dims = np.unique(np.asarray(self.dims)) # assumes they&#39;re all the same    </span>
</span><span id="Bar1Dv7-1064"><a href="#Bar1Dv7-1064"><span class="linenos">1064</span></a>        <span class="c1">#if self.eyepos is not None:</span>
</span><span id="Bar1Dv7-1065"><a href="#Bar1Dv7-1065"><span class="linenos">1065</span></a>            <span class="c1">#assert len(self.eyepos) == self.num_fixations, \</span>
</span><span id="Bar1Dv7-1066"><a href="#Bar1Dv7-1066"><span class="linenos">1066</span></a>            <span class="c1">#    &quot;eyepos input should have %d fixations.&quot;%self.num_fixations</span>
</span><span id="Bar1Dv7-1067"><a href="#Bar1Dv7-1067"><span class="linenos">1067</span></a>
</span><span id="Bar1Dv7-1068"><a href="#Bar1Dv7-1068"><span class="linenos">1068</span></a>        <span class="k">if</span> <span class="n">preload</span><span class="p">:</span>
</span><span id="Bar1Dv7-1069"><a href="#Bar1Dv7-1069"><span class="linenos">1069</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data into memory...&quot;</span><span class="p">)</span>
</span><span id="Bar1Dv7-1070"><a href="#Bar1Dv7-1070"><span class="linenos">1070</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">preload_numpy</span><span class="p">()</span>
</span><span id="Bar1Dv7-1071"><a href="#Bar1Dv7-1071"><span class="linenos">1071</span></a>
</span><span id="Bar1Dv7-1072"><a href="#Bar1Dv7-1072"><span class="linenos">1072</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1Dv7-1073"><a href="#Bar1Dv7-1073"><span class="linenos">1073</span></a>                <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;eye pos wrong shape&quot;</span>
</span><span id="Bar1Dv7-1074"><a href="#Bar1Dv7-1074"><span class="linenos">1074</span></a>                <span class="c1"># Apply horizontal shifts to stim (stil in numpy)</span>
</span><span id="Bar1Dv7-1075"><a href="#Bar1Dv7-1075"><span class="linenos">1075</span></a>                <span class="n">Hshifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">eyepos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Bar1Dv7-1076"><a href="#Bar1Dv7-1076"><span class="linenos">1076</span></a>
</span><span id="Bar1Dv7-1077"><a href="#Bar1Dv7-1077"><span class="linenos">1077</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">)</span>
</span><span id="Bar1Dv7-1078"><a href="#Bar1Dv7-1078"><span class="linenos">1078</span></a>                <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Hshifts</span><span class="p">)):</span>
</span><span id="Bar1Dv7-1079"><a href="#Bar1Dv7-1079"><span class="linenos">1079</span></a>                    <span class="n">sh</span> <span class="o">=</span> <span class="n">Hshifts</span><span class="p">[</span><span class="n">ss</span><span class="p">]</span>
</span><span id="Bar1Dv7-1080"><a href="#Bar1Dv7-1080"><span class="linenos">1080</span></a>                    <span class="n">Lc</span> <span class="o">=</span> <span class="n">NX</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
</span><span id="Bar1Dv7-1081"><a href="#Bar1Dv7-1081"><span class="linenos">1081</span></a>                    <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">eyepos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">sh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7-1082"><a href="#Bar1Dv7-1082"><span class="linenos">1082</span></a>                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">])</span>
</span><span id="Bar1Dv7-1083"><a href="#Bar1Dv7-1083"><span class="linenos">1083</span></a>                    <span class="k">if</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-1084"><a href="#Bar1Dv7-1084"><span class="linenos">1084</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="p">:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="Bar1Dv7-1085"><a href="#Bar1Dv7-1085"><span class="linenos">1085</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">ts</span><span class="p">,:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh</span><span class="p">))])</span>
</span><span id="Bar1Dv7-1086"><a href="#Bar1Dv7-1086"><span class="linenos">1086</span></a>                    <span class="k">elif</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-1087"><a href="#Bar1Dv7-1087"><span class="linenos">1087</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">ts</span><span class="p">,:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)])</span>
</span><span id="Bar1Dv7-1088"><a href="#Bar1Dv7-1088"><span class="linenos">1088</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">ts</span><span class="p">,:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="Bar1Dv7-1089"><a href="#Bar1Dv7-1089"><span class="linenos">1089</span></a>                    <span class="k">if</span> <span class="n">sh</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-1090"><a href="#Bar1Dv7-1090"><span class="linenos">1090</span></a>                        <span class="n">newstim</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
</span><span id="Bar1Dv7-1091"><a href="#Bar1Dv7-1091"><span class="linenos">1091</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">newstim</span><span class="p">)</span>
</span><span id="Bar1Dv7-1092"><a href="#Bar1Dv7-1092"><span class="linenos">1092</span></a>
</span><span id="Bar1Dv7-1093"><a href="#Bar1Dv7-1093"><span class="linenos">1093</span></a>                <span class="c1"># Apply horizontal shifts to stim (stil in numpy)</span>
</span><span id="Bar1Dv7-1094"><a href="#Bar1Dv7-1094"><span class="linenos">1094</span></a>                <span class="n">Vshifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">eyepos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Bar1Dv7-1095"><a href="#Bar1Dv7-1095"><span class="linenos">1095</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">)</span>
</span><span id="Bar1Dv7-1096"><a href="#Bar1Dv7-1096"><span class="linenos">1096</span></a>                <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Vshifts</span><span class="p">)):</span>
</span><span id="Bar1Dv7-1097"><a href="#Bar1Dv7-1097"><span class="linenos">1097</span></a>                    <span class="n">sh</span> <span class="o">=</span> <span class="n">Vshifts</span><span class="p">[</span><span class="n">ss</span><span class="p">]</span>
</span><span id="Bar1Dv7-1098"><a href="#Bar1Dv7-1098"><span class="linenos">1098</span></a>                    <span class="n">Lc</span> <span class="o">=</span> <span class="n">NX</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
</span><span id="Bar1Dv7-1099"><a href="#Bar1Dv7-1099"><span class="linenos">1099</span></a>                    <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">eyepos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">sh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7-1100"><a href="#Bar1Dv7-1100"><span class="linenos">1100</span></a>                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">])</span>
</span><span id="Bar1Dv7-1101"><a href="#Bar1Dv7-1101"><span class="linenos">1101</span></a>                    <span class="k">if</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-1102"><a href="#Bar1Dv7-1102"><span class="linenos">1102</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="p">:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="Bar1Dv7-1103"><a href="#Bar1Dv7-1103"><span class="linenos">1103</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">ts</span><span class="p">,:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh</span><span class="p">))])</span>
</span><span id="Bar1Dv7-1104"><a href="#Bar1Dv7-1104"><span class="linenos">1104</span></a>                    <span class="k">elif</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-1105"><a href="#Bar1Dv7-1105"><span class="linenos">1105</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">ts</span><span class="p">,:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)])</span>
</span><span id="Bar1Dv7-1106"><a href="#Bar1Dv7-1106"><span class="linenos">1106</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">ts</span><span class="p">,:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="Bar1Dv7-1107"><a href="#Bar1Dv7-1107"><span class="linenos">1107</span></a>                    <span class="k">if</span> <span class="n">sh</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-1108"><a href="#Bar1Dv7-1108"><span class="linenos">1108</span></a>                        <span class="n">newstim</span><span class="p">[</span><span class="n">ts</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">tmp</span>
</span><span id="Bar1Dv7-1109"><a href="#Bar1Dv7-1109"><span class="linenos">1109</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">newstim</span><span class="p">)</span>
</span><span id="Bar1Dv7-1110"><a href="#Bar1Dv7-1110"><span class="linenos">1110</span></a>    
</span><span id="Bar1Dv7-1111"><a href="#Bar1Dv7-1111"><span class="linenos">1111</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1Dv7-1112"><a href="#Bar1Dv7-1112"><span class="linenos">1112</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;stimulus cropping not implemented yet&#39;</span><span class="p">)</span>
</span><span id="Bar1Dv7-1113"><a href="#Bar1Dv7-1113"><span class="linenos">1113</span></a>
</span><span id="Bar1Dv7-1114"><a href="#Bar1Dv7-1114"><span class="linenos">1114</span></a>            <span class="k">if</span> <span class="n">time_embed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Bar1Dv7-1115"><a href="#Bar1Dv7-1115"><span class="linenos">1115</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time embedding...&quot;</span><span class="p">)</span>
</span><span id="Bar1Dv7-1116"><a href="#Bar1Dv7-1116"><span class="linenos">1116</span></a>                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="Bar1Dv7-1117"><a href="#Bar1Dv7-1117"><span class="linenos">1117</span></a>                <span class="n">tmp_stimH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="Bar1Dv7-1118"><a href="#Bar1Dv7-1118"><span class="linenos">1118</span></a>                <span class="n">tmp_stimV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="Bar1Dv7-1119"><a href="#Bar1Dv7-1119"><span class="linenos">1119</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="Bar1Dv7-1120"><a href="#Bar1Dv7-1120"><span class="linenos">1120</span></a>                    <span class="n">tmp_stimC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="Bar1Dv7-1121"><a href="#Bar1Dv7-1121"><span class="linenos">1121</span></a>
</span><span id="Bar1Dv7-1122"><a href="#Bar1Dv7-1122"><span class="linenos">1122</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span><span class="p">:</span>
</span><span id="Bar1Dv7-1123"><a href="#Bar1Dv7-1123"><span class="linenos">1123</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">tmp_stimH</span>
</span><span id="Bar1Dv7-1124"><a href="#Bar1Dv7-1124"><span class="linenos">1124</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">tmp_stimV</span>
</span><span id="Bar1Dv7-1125"><a href="#Bar1Dv7-1125"><span class="linenos">1125</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="Bar1Dv7-1126"><a href="#Bar1Dv7-1126"><span class="linenos">1126</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="n">tmp_stimC</span> 
</span><span id="Bar1Dv7-1127"><a href="#Bar1Dv7-1127"><span class="linenos">1127</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Folded lags: stim-dim = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Bar1Dv7-1128"><a href="#Bar1Dv7-1128"><span class="linenos">1128</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7-1129"><a href="#Bar1Dv7-1129"><span class="linenos">1129</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimH</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="Bar1Dv7-1130"><a href="#Bar1Dv7-1130"><span class="linenos">1130</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimV</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="Bar1Dv7-1131"><a href="#Bar1Dv7-1131"><span class="linenos">1131</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="Bar1Dv7-1132"><a href="#Bar1Dv7-1132"><span class="linenos">1132</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimC</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="Bar1Dv7-1133"><a href="#Bar1Dv7-1133"><span class="linenos">1133</span></a>
</span><span id="Bar1Dv7-1134"><a href="#Bar1Dv7-1134"><span class="linenos">1134</span></a>            <span class="c1"># Flatten stim </span>
</span><span id="Bar1Dv7-1135"><a href="#Bar1Dv7-1135"><span class="linenos">1135</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Bar1Dv7-1136"><a href="#Bar1Dv7-1136"><span class="linenos">1136</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Bar1Dv7-1137"><a href="#Bar1Dv7-1137"><span class="linenos">1137</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="Bar1Dv7-1138"><a href="#Bar1Dv7-1138"><span class="linenos">1138</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Bar1Dv7-1139"><a href="#Bar1Dv7-1139"><span class="linenos">1139</span></a>
</span><span id="Bar1Dv7-1140"><a href="#Bar1Dv7-1140"><span class="linenos">1140</span></a>            <span class="c1"># Have data_filters represend used_inds (in case it gets through)</span>
</span><span id="Bar1Dv7-1141"><a href="#Bar1Dv7-1141"><span class="linenos">1141</span></a>            <span class="n">unified_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7-1142"><a href="#Bar1Dv7-1142"><span class="linenos">1142</span></a>            <span class="n">unified_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="Bar1Dv7-1143"><a href="#Bar1Dv7-1143"><span class="linenos">1143</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*=</span> <span class="n">unified_df</span>
</span><span id="Bar1Dv7-1144"><a href="#Bar1Dv7-1144"><span class="linenos">1144</span></a>
</span><span id="Bar1Dv7-1145"><a href="#Bar1Dv7-1145"><span class="linenos">1145</span></a>            <span class="c1"># Prepare design matrix for drift (on trial-by-trial basis)</span>
</span><span id="Bar1Dv7-1146"><a href="#Bar1Dv7-1146"><span class="linenos">1146</span></a>            <span class="c1">#self.Xdrift = np.zeros([self.NT, len(self.block_inds)//], dtype=np.float32)</span>
</span><span id="Bar1Dv7-1147"><a href="#Bar1Dv7-1147"><span class="linenos">1147</span></a>            <span class="c1">#for nn in range(len(self.block_inds)):</span>
</span><span id="Bar1Dv7-1148"><a href="#Bar1Dv7-1148"><span class="linenos">1148</span></a>            <span class="c1">#    self.Xdrift[self.block_inds[nn], nn] = 1.0</span>
</span><span id="Bar1Dv7-1149"><a href="#Bar1Dv7-1149"><span class="linenos">1149</span></a>            <span class="n">NBL</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="Bar1Dv7-1150"><a href="#Bar1Dv7-1150"><span class="linenos">1150</span></a>            <span class="n">Nanchors</span> <span class="o">=</span> <span class="n">NBL</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span>
</span><span id="Bar1Dv7-1151"><a href="#Bar1Dv7-1151"><span class="linenos">1151</span></a>            <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="Bar1Dv7-1152"><a href="#Bar1Dv7-1152"><span class="linenos">1152</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">):</span>
</span><span id="Bar1Dv7-1153"><a href="#Bar1Dv7-1153"><span class="linenos">1153</span></a>                <span class="n">anchors</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span><span class="o">*</span><span class="n">bb</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7-1154"><a href="#Bar1Dv7-1154"><span class="linenos">1154</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Bar1Dv7-1155"><a href="#Bar1Dv7-1155"><span class="linenos">1155</span></a>
</span><span id="Bar1Dv7-1156"><a href="#Bar1Dv7-1156"><span class="linenos">1156</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">process_fixations</span><span class="p">()</span>
</span><span id="Bar1Dv7-1157"><a href="#Bar1Dv7-1157"><span class="linenos">1157</span></a>
</span><span id="Bar1Dv7-1158"><a href="#Bar1Dv7-1158"><span class="linenos">1158</span></a>            <span class="c1"># Convert data to tensors</span>
</span><span id="Bar1Dv7-1159"><a href="#Bar1Dv7-1159"><span class="linenos">1159</span></a>            <span class="c1">#if self.device is not None:</span>
</span><span id="Bar1Dv7-1160"><a href="#Bar1Dv7-1160"><span class="linenos">1160</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7-1161"><a href="#Bar1Dv7-1161"><span class="linenos">1161</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>
</span><span id="Bar1Dv7-1162"><a href="#Bar1Dv7-1162"><span class="linenos">1162</span></a>
</span><span id="Bar1Dv7-1163"><a href="#Bar1Dv7-1163"><span class="linenos">1163</span></a>        <span class="c1"># Create valid indices and first pass of cross-validation indices</span>
</span><span id="Bar1Dv7-1164"><a href="#Bar1Dv7-1164"><span class="linenos">1164</span></a>        <span class="c1">#self.create_valid_indices()</span>
</span><span id="Bar1Dv7-1165"><a href="#Bar1Dv7-1165"><span class="linenos">1165</span></a>        <span class="c1"># Develop default train, validation, and test datasets </span>
</span><span id="Bar1Dv7-1166"><a href="#Bar1Dv7-1166"><span class="linenos">1166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crossval_setup</span><span class="p">()</span>
</span><span id="Bar1Dv7-1167"><a href="#Bar1Dv7-1167"><span class="linenos">1167</span></a>
</span><span id="Bar1Dv7-1168"><a href="#Bar1Dv7-1168"><span class="linenos">1168</span></a>        <span class="c1"># Fix Xdrift to remove test and validation sets</span>
</span><span id="Bar1Dv7-1169"><a href="#Bar1Dv7-1169"><span class="linenos">1169</span></a>        <span class="c1">#self.adjust_Xdrift_xval()</span>
</span><span id="Bar1Dv7-1170"><a href="#Bar1Dv7-1170"><span class="linenos">1170</span></a>
</span><span id="Bar1Dv7-1171"><a href="#Bar1Dv7-1171"><span class="linenos">1171</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="Bar1Dv7-1172"><a href="#Bar1Dv7-1172"><span class="linenos">1172</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">stim_gap</span>
</span><span id="Bar1Dv7-1173"><a href="#Bar1Dv7-1173"><span class="linenos">1173</span></a>
</span><span id="Bar1Dv7-1174"><a href="#Bar1Dv7-1174"><span class="linenos">1174</span></a>        <span class="c1"># Reflects block structure</span>
</span><span id="Bar1Dv7-1175"><a href="#Bar1Dv7-1175"><span class="linenos">1175</span></a>        <span class="c1">#vblks, trblks = self.fold_sample(len(self.block_inds), 5, random_gen=True)</span>
</span><span id="Bar1Dv7-1176"><a href="#Bar1Dv7-1176"><span class="linenos">1176</span></a>        <span class="c1">#self.train_inds = []</span>
</span><span id="Bar1Dv7-1177"><a href="#Bar1Dv7-1177"><span class="linenos">1177</span></a>        <span class="c1">#for nn in trblks:</span>
</span><span id="Bar1Dv7-1178"><a href="#Bar1Dv7-1178"><span class="linenos">1178</span></a>        <span class="c1">#    self.train_inds += list(deepcopy(self.block_inds[nn]))</span>
</span><span id="Bar1Dv7-1179"><a href="#Bar1Dv7-1179"><span class="linenos">1179</span></a>        <span class="c1">#self.val_inds = []</span>
</span><span id="Bar1Dv7-1180"><a href="#Bar1Dv7-1180"><span class="linenos">1180</span></a>        <span class="c1">#for nn in vblks:</span>
</span><span id="Bar1Dv7-1181"><a href="#Bar1Dv7-1181"><span class="linenos">1181</span></a>        <span class="c1">#    self.val_inds += list(deepcopy(self.block_inds[nn]))</span>
</span><span id="Bar1Dv7-1182"><a href="#Bar1Dv7-1182"><span class="linenos">1182</span></a>        <span class="c1">#self.train_inds = np.array(self.train_inds, dtype=np.int64)</span>
</span><span id="Bar1Dv7-1183"><a href="#Bar1Dv7-1183"><span class="linenos">1183</span></a>        <span class="c1">#self.val_inds = np.array(self.val_inds, dtype=np.int64)</span>
</span><span id="Bar1Dv7-1184"><a href="#Bar1Dv7-1184"><span class="linenos">1184</span></a>    <span class="c1"># END ColorClouds.__init__</span>
</span><span id="Bar1Dv7-1185"><a href="#Bar1Dv7-1185"><span class="linenos">1185</span></a>
</span><span id="Bar1Dv7-1186"><a href="#Bar1Dv7-1186"><span class="linenos">1186</span></a>    <span class="k">def</span> <span class="nf">preload_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Bar1Dv7-1187"><a href="#Bar1Dv7-1187"><span class="linenos">1187</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1188"><a href="#Bar1Dv7-1188"><span class="linenos">1188</span></a><span class="sd">        Note this loads stimulus but does not time-embed</span>
</span><span id="Bar1Dv7-1189"><a href="#Bar1Dv7-1189"><span class="linenos">1189</span></a><span class="sd">        </span>
</span><span id="Bar1Dv7-1190"><a href="#Bar1Dv7-1190"><span class="linenos">1190</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7-1191"><a href="#Bar1Dv7-1191"><span class="linenos">1191</span></a><span class="sd">            None</span>
</span><span id="Bar1Dv7-1192"><a href="#Bar1Dv7-1192"><span class="linenos">1192</span></a>
</span><span id="Bar1Dv7-1193"><a href="#Bar1Dv7-1193"><span class="linenos">1193</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7-1194"><a href="#Bar1Dv7-1194"><span class="linenos">1194</span></a><span class="sd">            None: sets self.stim, self.robs, self.dfs, self.eyepos, self.frame_times</span>
</span><span id="Bar1Dv7-1195"><a href="#Bar1Dv7-1195"><span class="linenos">1195</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1196"><a href="#Bar1Dv7-1196"><span class="linenos">1196</span></a>
</span><span id="Bar1Dv7-1197"><a href="#Bar1Dv7-1197"><span class="linenos">1197</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span><span id="Bar1Dv7-1198"><a href="#Bar1Dv7-1198"><span class="linenos">1198</span></a>        <span class="n">NX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Bar1Dv7-1199"><a href="#Bar1Dv7-1199"><span class="linenos">1199</span></a>        <span class="n">NX2</span> <span class="o">=</span> <span class="n">NX</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_gap</span>
</span><span id="Bar1Dv7-1200"><a href="#Bar1Dv7-1200"><span class="linenos">1200</span></a>
</span><span id="Bar1Dv7-1201"><a href="#Bar1Dv7-1201"><span class="linenos">1201</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="Bar1Dv7-1202"><a href="#Bar1Dv7-1202"><span class="linenos">1202</span></a><span class="sd">        Pre-allocate memory for data</span>
</span><span id="Bar1Dv7-1203"><a href="#Bar1Dv7-1203"><span class="linenos">1203</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="Bar1Dv7-1204"><a href="#Bar1Dv7-1204"><span class="linenos">1204</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7-1205"><a href="#Bar1Dv7-1205"><span class="linenos">1205</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7-1206"><a href="#Bar1Dv7-1206"><span class="linenos">1206</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="Bar1Dv7-1207"><a href="#Bar1Dv7-1207"><span class="linenos">1207</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">NX2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7-1208"><a href="#Bar1Dv7-1208"><span class="linenos">1208</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7-1209"><a href="#Bar1Dv7-1209"><span class="linenos">1209</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1Dv7-1210"><a href="#Bar1Dv7-1210"><span class="linenos">1210</span></a>
</span><span id="Bar1Dv7-1211"><a href="#Bar1Dv7-1211"><span class="linenos">1211</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7-1212"><a href="#Bar1Dv7-1212"><span class="linenos">1212</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7-1213"><a href="#Bar1Dv7-1213"><span class="linenos">1213</span></a>        <span class="c1">#self.eyepos = np.zeros([NT, 2], dtype=np.float32)</span>
</span><span id="Bar1Dv7-1214"><a href="#Bar1Dv7-1214"><span class="linenos">1214</span></a>        <span class="c1">#self.frame_times = np.zeros([NT,1], dtype=np.float32)</span>
</span><span id="Bar1Dv7-1215"><a href="#Bar1Dv7-1215"><span class="linenos">1215</span></a>
</span><span id="Bar1Dv7-1216"><a href="#Bar1Dv7-1216"><span class="linenos">1216</span></a>        <span class="n">t_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1Dv7-1217"><a href="#Bar1Dv7-1217"><span class="linenos">1217</span></a>        <span class="n">unit_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1Dv7-1218"><a href="#Bar1Dv7-1218"><span class="linenos">1218</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">)):</span>
</span><span id="Bar1Dv7-1219"><a href="#Bar1Dv7-1219"><span class="linenos">1219</span></a>            
</span><span id="Bar1Dv7-1220"><a href="#Bar1Dv7-1220"><span class="linenos">1220</span></a>            <span class="n">fhandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="Bar1Dv7-1221"><a href="#Bar1Dv7-1221"><span class="linenos">1221</span></a>            <span class="n">sz</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="Bar1Dv7-1222"><a href="#Bar1Dv7-1222"><span class="linenos">1222</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_counter</span><span class="p">,</span> <span class="n">t_counter</span><span class="o">+</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="Bar1Dv7-1223"><a href="#Bar1Dv7-1223"><span class="linenos">1223</span></a>            <span class="c1">#inds = self.stim_indices[expt][stim][&#39;inds&#39;]</span>
</span><span id="Bar1Dv7-1224"><a href="#Bar1Dv7-1224"><span class="linenos">1224</span></a>            <span class="c1">#self.stim[inds, ...] = np.transpose( np.array(fhandle[self.stimname], dtype=np.float32), axes=[0,3,1,2])</span>
</span><span id="Bar1Dv7-1225"><a href="#Bar1Dv7-1225"><span class="linenos">1225</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7-1226"><a href="#Bar1Dv7-1226"><span class="linenos">1226</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tmp_stim</span><span class="p">)</span>
</span><span id="Bar1Dv7-1227"><a href="#Bar1Dv7-1227"><span class="linenos">1227</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp_stim</span>
</span><span id="Bar1Dv7-1228"><a href="#Bar1Dv7-1228"><span class="linenos">1228</span></a>            <span class="n">stim_ori</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimETori&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7-1229"><a href="#Bar1Dv7-1229"><span class="linenos">1229</span></a>            <span class="n">Hinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_ori</span> <span class="o">&gt;</span> <span class="mi">45</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7-1230"><a href="#Bar1Dv7-1230"><span class="linenos">1230</span></a>            <span class="n">Vinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_ori</span> <span class="o">&lt;</span> <span class="mi">45</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7-1231"><a href="#Bar1Dv7-1231"><span class="linenos">1231</span></a>
</span><span id="Bar1Dv7-1232"><a href="#Bar1Dv7-1232"><span class="linenos">1232</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">Vinds</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="Bar1Dv7-1233"><a href="#Bar1Dv7-1233"><span class="linenos">1233</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">Hinds</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="Bar1Dv7-1234"><a href="#Bar1Dv7-1234"><span class="linenos">1234</span></a>
</span><span id="Bar1Dv7-1235"><a href="#Bar1Dv7-1235"><span class="linenos">1235</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Robs and DATAFILTERS&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1236"><a href="#Bar1Dv7-1236"><span class="linenos">1236</span></a>            <span class="n">robs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="Bar1Dv7-1237"><a href="#Bar1Dv7-1237"><span class="linenos">1237</span></a>            <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="Bar1Dv7-1238"><a href="#Bar1Dv7-1238"><span class="linenos">1238</span></a>            <span class="n">num_sus</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Bar1Dv7-1239"><a href="#Bar1Dv7-1239"><span class="linenos">1239</span></a>            <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="p">)</span>
</span><span id="Bar1Dv7-1240"><a href="#Bar1Dv7-1240"><span class="linenos">1240</span></a>            <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7-1241"><a href="#Bar1Dv7-1241"><span class="linenos">1241</span></a>            <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;datafilts&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7-1242"><a href="#Bar1Dv7-1242"><span class="linenos">1242</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="Bar1Dv7-1243"><a href="#Bar1Dv7-1243"><span class="linenos">1243</span></a>                <span class="n">num_mus</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Bar1Dv7-1244"><a href="#Bar1Dv7-1244"><span class="linenos">1244</span></a>                <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="o">+</span><span class="n">num_mus</span><span class="p">)</span>
</span><span id="Bar1Dv7-1245"><a href="#Bar1Dv7-1245"><span class="linenos">1245</span></a>                <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7-1246"><a href="#Bar1Dv7-1246"><span class="linenos">1246</span></a>                <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;datafiltsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7-1247"><a href="#Bar1Dv7-1247"><span class="linenos">1247</span></a>            
</span><span id="Bar1Dv7-1248"><a href="#Bar1Dv7-1248"><span class="linenos">1248</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">robs_tmp</span><span class="p">)</span>
</span><span id="Bar1Dv7-1249"><a href="#Bar1Dv7-1249"><span class="linenos">1249</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dfs_tmp</span><span class="p">)</span>
</span><span id="Bar1Dv7-1250"><a href="#Bar1Dv7-1250"><span class="linenos">1250</span></a>
</span><span id="Bar1Dv7-1251"><a href="#Bar1Dv7-1251"><span class="linenos">1251</span></a>            <span class="n">t_counter</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7-1252"><a href="#Bar1Dv7-1252"><span class="linenos">1252</span></a>            <span class="n">unit_counter</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="Bar1Dv7-1253"><a href="#Bar1Dv7-1253"><span class="linenos">1253</span></a>
</span><span id="Bar1Dv7-1254"><a href="#Bar1Dv7-1254"><span class="linenos">1254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span> <span class="o">=</span> <span class="s1">&#39;stim&#39;</span>  <span class="c1"># not sure what this does</span>
</span><span id="Bar1Dv7-1255"><a href="#Bar1Dv7-1255"><span class="linenos">1255</span></a>
</span><span id="Bar1Dv7-1256"><a href="#Bar1Dv7-1256"><span class="linenos">1256</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="Bar1Dv7-1257"><a href="#Bar1Dv7-1257"><span class="linenos">1257</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">)</span>
</span><span id="Bar1Dv7-1258"><a href="#Bar1Dv7-1258"><span class="linenos">1258</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">NX</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_gap</span><span class="p">,</span> <span class="n">NX2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">)</span>
</span><span id="Bar1Dv7-1259"><a href="#Bar1Dv7-1259"><span class="linenos">1259</span></a>
</span><span id="Bar1Dv7-1260"><a href="#Bar1Dv7-1260"><span class="linenos">1260</span></a>        <span class="n">sh</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimHshift</span><span class="p">)</span>
</span><span id="Bar1Dv7-1261"><a href="#Bar1Dv7-1261"><span class="linenos">1261</span></a>        <span class="k">if</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-1262"><a href="#Bar1Dv7-1262"><span class="linenos">1262</span></a>            <span class="n">Lc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span> <span class="o">-</span> <span class="n">sh</span>
</span><span id="Bar1Dv7-1263"><a href="#Bar1Dv7-1263"><span class="linenos">1263</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7-1264"><a href="#Bar1Dv7-1264"><span class="linenos">1264</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hdiscardzero</span><span class="p">:</span>
</span><span id="Bar1Dv7-1265"><a href="#Bar1Dv7-1265"><span class="linenos">1265</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Discarding stim at 0 horizontal position&#39;</span><span class="p">)</span>
</span><span id="Bar1Dv7-1266"><a href="#Bar1Dv7-1266"><span class="linenos">1266</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimHshift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-1267"><a href="#Bar1Dv7-1267"><span class="linenos">1267</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="Bar1Dv7-1268"><a href="#Bar1Dv7-1268"><span class="linenos">1268</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">sh</span><span class="p">)])</span>
</span><span id="Bar1Dv7-1269"><a href="#Bar1Dv7-1269"><span class="linenos">1269</span></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimHshift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-1270"><a href="#Bar1Dv7-1270"><span class="linenos">1270</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Lc</span><span class="p">)])</span>
</span><span id="Bar1Dv7-1271"><a href="#Bar1Dv7-1271"><span class="linenos">1271</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="Bar1Dv7-1272"><a href="#Bar1Dv7-1272"><span class="linenos">1272</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7-1273"><a href="#Bar1Dv7-1273"><span class="linenos">1273</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimHshift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-1274"><a href="#Bar1Dv7-1274"><span class="linenos">1274</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="Bar1Dv7-1275"><a href="#Bar1Dv7-1275"><span class="linenos">1275</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)])</span>
</span><span id="Bar1Dv7-1276"><a href="#Bar1Dv7-1276"><span class="linenos">1276</span></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimHshift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-1277"><a href="#Bar1Dv7-1277"><span class="linenos">1277</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)])</span>
</span><span id="Bar1Dv7-1278"><a href="#Bar1Dv7-1278"><span class="linenos">1278</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="Bar1Dv7-1279"><a href="#Bar1Dv7-1279"><span class="linenos">1279</span></a>
</span><span id="Bar1Dv7-1280"><a href="#Bar1Dv7-1280"><span class="linenos">1280</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tmp_stim</span><span class="p">)</span>
</span><span id="Bar1Dv7-1281"><a href="#Bar1Dv7-1281"><span class="linenos">1281</span></a>    <span class="c1"># END Bar1D.preload_numpy()</span>
</span><span id="Bar1Dv7-1282"><a href="#Bar1Dv7-1282"><span class="linenos">1282</span></a>        
</span><span id="Bar1Dv7-1283"><a href="#Bar1Dv7-1283"><span class="linenos">1283</span></a>    <span class="k">def</span> <span class="nf">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="Bar1Dv7-1284"><a href="#Bar1Dv7-1284"><span class="linenos">1284</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1285"><a href="#Bar1Dv7-1285"><span class="linenos">1285</span></a><span class="sd">        Converts numpy data to torch tensors and moves to device</span>
</span><span id="Bar1Dv7-1286"><a href="#Bar1Dv7-1286"><span class="linenos">1286</span></a>
</span><span id="Bar1Dv7-1287"><a href="#Bar1Dv7-1287"><span class="linenos">1287</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7-1288"><a href="#Bar1Dv7-1288"><span class="linenos">1288</span></a><span class="sd">            device: torch device to move data to</span>
</span><span id="Bar1Dv7-1289"><a href="#Bar1Dv7-1289"><span class="linenos">1289</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1290"><a href="#Bar1Dv7-1290"><span class="linenos">1290</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="Bar1Dv7-1291"><a href="#Bar1Dv7-1291"><span class="linenos">1291</span></a>            <span class="c1"># then already converted: just moving device</span>
</span><span id="Bar1Dv7-1292"><a href="#Bar1Dv7-1292"><span class="linenos">1292</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7-1293"><a href="#Bar1Dv7-1293"><span class="linenos">1293</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7-1294"><a href="#Bar1Dv7-1294"><span class="linenos">1294</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7-1295"><a href="#Bar1Dv7-1295"><span class="linenos">1295</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7-1296"><a href="#Bar1Dv7-1296"><span class="linenos">1296</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7-1297"><a href="#Bar1Dv7-1297"><span class="linenos">1297</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7-1298"><a href="#Bar1Dv7-1298"><span class="linenos">1298</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="Bar1Dv7-1299"><a href="#Bar1Dv7-1299"><span class="linenos">1299</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7-1300"><a href="#Bar1Dv7-1300"><span class="linenos">1300</span></a>
</span><span id="Bar1Dv7-1301"><a href="#Bar1Dv7-1301"><span class="linenos">1301</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7-1302"><a href="#Bar1Dv7-1302"><span class="linenos">1302</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7-1303"><a href="#Bar1Dv7-1303"><span class="linenos">1303</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7-1304"><a href="#Bar1Dv7-1304"><span class="linenos">1304</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7-1305"><a href="#Bar1Dv7-1305"><span class="linenos">1305</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7-1306"><a href="#Bar1Dv7-1306"><span class="linenos">1306</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7-1307"><a href="#Bar1Dv7-1307"><span class="linenos">1307</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7-1308"><a href="#Bar1Dv7-1308"><span class="linenos">1308</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="Bar1Dv7-1309"><a href="#Bar1Dv7-1309"><span class="linenos">1309</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7-1310"><a href="#Bar1Dv7-1310"><span class="linenos">1310</span></a>    <span class="c1"># END Bar1D.to_tensor</span>
</span><span id="Bar1Dv7-1311"><a href="#Bar1Dv7-1311"><span class="linenos">1311</span></a>
</span><span id="Bar1Dv7-1312"><a href="#Bar1Dv7-1312"><span class="linenos">1312</span></a>    <span class="k">def</span> <span class="nf">process_fixations</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sacc_in</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="Bar1Dv7-1313"><a href="#Bar1Dv7-1313"><span class="linenos">1313</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1314"><a href="#Bar1Dv7-1314"><span class="linenos">1314</span></a><span class="sd">        Processes fixation informatiom from dataset, but also allows new saccade detection</span>
</span><span id="Bar1Dv7-1315"><a href="#Bar1Dv7-1315"><span class="linenos">1315</span></a><span class="sd">        to be input and put in the right format within the dataset (main use)</span>
</span><span id="Bar1Dv7-1316"><a href="#Bar1Dv7-1316"><span class="linenos">1316</span></a><span class="sd">        </span>
</span><span id="Bar1Dv7-1317"><a href="#Bar1Dv7-1317"><span class="linenos">1317</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7-1318"><a href="#Bar1Dv7-1318"><span class="linenos">1318</span></a><span class="sd">            sacc_in: new saccade information to be processed (if None, will use existing)</span>
</span><span id="Bar1Dv7-1319"><a href="#Bar1Dv7-1319"><span class="linenos">1319</span></a>
</span><span id="Bar1Dv7-1320"><a href="#Bar1Dv7-1320"><span class="linenos">1320</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7-1321"><a href="#Bar1Dv7-1321"><span class="linenos">1321</span></a><span class="sd">            None: sets self.fix_n</span>
</span><span id="Bar1Dv7-1322"><a href="#Bar1Dv7-1322"><span class="linenos">1322</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1323"><a href="#Bar1Dv7-1323"><span class="linenos">1323</span></a>        <span class="k">if</span> <span class="n">sacc_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1Dv7-1324"><a href="#Bar1Dv7-1324"><span class="linenos">1324</span></a>            <span class="n">sacc_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7-1325"><a href="#Bar1Dv7-1325"><span class="linenos">1325</span></a>
</span><span id="Bar1Dv7-1326"><a href="#Bar1Dv7-1326"><span class="linenos">1326</span></a>        <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> 
</span><span id="Bar1Dv7-1327"><a href="#Bar1Dv7-1327"><span class="linenos">1327</span></a>        <span class="n">fix_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1Dv7-1328"><a href="#Bar1Dv7-1328"><span class="linenos">1328</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)):</span>
</span><span id="Bar1Dv7-1329"><a href="#Bar1Dv7-1329"><span class="linenos">1329</span></a>            <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="Bar1Dv7-1330"><a href="#Bar1Dv7-1330"><span class="linenos">1330</span></a>            <span class="c1">#self.block_inds.append(np.arange( blk_inds[ii,0], blk_inds[ii,1], dtype=np.int64))</span>
</span><span id="Bar1Dv7-1331"><a href="#Bar1Dv7-1331"><span class="linenos">1331</span></a>
</span><span id="Bar1Dv7-1332"><a href="#Bar1Dv7-1332"><span class="linenos">1332</span></a>            <span class="c1"># Parse fixation numbers within block</span>
</span><span id="Bar1Dv7-1333"><a href="#Bar1Dv7-1333"><span class="linenos">1333</span></a>            <span class="n">rel_saccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">sacc_in</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sacc_in</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7-1334"><a href="#Bar1Dv7-1334"><span class="linenos">1334</span></a>
</span><span id="Bar1Dv7-1335"><a href="#Bar1Dv7-1335"><span class="linenos">1335</span></a>            <span class="n">tfix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Beginning of fixation by definition</span>
</span><span id="Bar1Dv7-1336"><a href="#Bar1Dv7-1336"><span class="linenos">1336</span></a>            <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel_saccs</span><span class="p">)):</span>
</span><span id="Bar1Dv7-1337"><a href="#Bar1Dv7-1337"><span class="linenos">1337</span></a>                <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Bar1Dv7-1338"><a href="#Bar1Dv7-1338"><span class="linenos">1338</span></a>                <span class="c1"># Range goes to beginning of next fixation (note no gap)</span>
</span><span id="Bar1Dv7-1339"><a href="#Bar1Dv7-1339"><span class="linenos">1339</span></a>                <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="Bar1Dv7-1340"><a href="#Bar1Dv7-1340"><span class="linenos">1340</span></a>                <span class="n">tfix</span> <span class="o">=</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">6</span>
</span><span id="Bar1Dv7-1341"><a href="#Bar1Dv7-1341"><span class="linenos">1341</span></a>            <span class="c1"># Put in last (or only) fixation number</span>
</span><span id="Bar1Dv7-1342"><a href="#Bar1Dv7-1342"><span class="linenos">1342</span></a>            <span class="k">if</span> <span class="n">tfix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="Bar1Dv7-1343"><a href="#Bar1Dv7-1343"><span class="linenos">1343</span></a>                <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Bar1Dv7-1344"><a href="#Bar1Dv7-1344"><span class="linenos">1344</span></a>                <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="Bar1Dv7-1345"><a href="#Bar1Dv7-1345"><span class="linenos">1345</span></a>
</span><span id="Bar1Dv7-1346"><a href="#Bar1Dv7-1346"><span class="linenos">1346</span></a>        <span class="c1"># Determine whether to be numpy or tensor</span>
</span><span id="Bar1Dv7-1347"><a href="#Bar1Dv7-1347"><span class="linenos">1347</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="Bar1Dv7-1348"><a href="#Bar1Dv7-1348"><span class="linenos">1348</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7-1349"><a href="#Bar1Dv7-1349"><span class="linenos">1349</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7-1350"><a href="#Bar1Dv7-1350"><span class="linenos">1350</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">fix_n</span>
</span><span id="Bar1Dv7-1351"><a href="#Bar1Dv7-1351"><span class="linenos">1351</span></a>    <span class="c1"># END: Bar1D.process_fixations()</span>
</span><span id="Bar1Dv7-1352"><a href="#Bar1Dv7-1352"><span class="linenos">1352</span></a>
</span><span id="Bar1Dv7-1353"><a href="#Bar1Dv7-1353"><span class="linenos">1353</span></a>    <span class="k">def</span> <span class="nf">add_shifter</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">shifts</span> <span class="p">):</span>
</span><span id="Bar1Dv7-1354"><a href="#Bar1Dv7-1354"><span class="linenos">1354</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1355"><a href="#Bar1Dv7-1355"><span class="linenos">1355</span></a><span class="sd">        Adds a shifter to the dataset, which can be used to shift the stimulus</span>
</span><span id="Bar1Dv7-1356"><a href="#Bar1Dv7-1356"><span class="linenos">1356</span></a>
</span><span id="Bar1Dv7-1357"><a href="#Bar1Dv7-1357"><span class="linenos">1357</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7-1358"><a href="#Bar1Dv7-1358"><span class="linenos">1358</span></a><span class="sd">            shifts: shifts to be added to the dataset</span>
</span><span id="Bar1Dv7-1359"><a href="#Bar1Dv7-1359"><span class="linenos">1359</span></a>
</span><span id="Bar1Dv7-1360"><a href="#Bar1Dv7-1360"><span class="linenos">1360</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7-1361"><a href="#Bar1Dv7-1361"><span class="linenos">1361</span></a><span class="sd">            None: sets self.shifts</span>
</span><span id="Bar1Dv7-1362"><a href="#Bar1Dv7-1362"><span class="linenos">1362</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1363"><a href="#Bar1Dv7-1363"><span class="linenos">1363</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">shifts</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">),</span> <span class="s2">&quot;Entered shifts is wrong size.&quot;</span>
</span><span id="Bar1Dv7-1364"><a href="#Bar1Dv7-1364"><span class="linenos">1364</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span><span class="p">:</span>
</span><span id="Bar1Dv7-1365"><a href="#Bar1Dv7-1365"><span class="linenos">1365</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Bar1Dv7-1366"><a href="#Bar1Dv7-1366"><span class="linenos">1366</span></a>        <span class="c1"># else: Delete old shifts?</span>
</span><span id="Bar1Dv7-1367"><a href="#Bar1Dv7-1367"><span class="linenos">1367</span></a>        
</span><span id="Bar1Dv7-1368"><a href="#Bar1Dv7-1368"><span class="linenos">1368</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">device</span>
</span><span id="Bar1Dv7-1369"><a href="#Bar1Dv7-1369"><span class="linenos">1369</span></a>
</span><span id="Bar1Dv7-1370"><a href="#Bar1Dv7-1370"><span class="linenos">1370</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">):</span>
</span><span id="Bar1Dv7-1371"><a href="#Bar1Dv7-1371"><span class="linenos">1371</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="o">=</span> <span class="n">shifts</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7-1372"><a href="#Bar1Dv7-1372"><span class="linenos">1372</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7-1373"><a href="#Bar1Dv7-1373"><span class="linenos">1373</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7-1374"><a href="#Bar1Dv7-1374"><span class="linenos">1374</span></a>
</span><span id="Bar1Dv7-1375"><a href="#Bar1Dv7-1375"><span class="linenos">1375</span></a>    <span class="k">def</span> <span class="nf">avrates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="Bar1Dv7-1376"><a href="#Bar1Dv7-1376"><span class="linenos">1376</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1377"><a href="#Bar1Dv7-1377"><span class="linenos">1377</span></a><span class="sd">        Calculates average firing probability across specified inds (or whole dataset)</span>
</span><span id="Bar1Dv7-1378"><a href="#Bar1Dv7-1378"><span class="linenos">1378</span></a><span class="sd">        -- Note will respect datafilters</span>
</span><span id="Bar1Dv7-1379"><a href="#Bar1Dv7-1379"><span class="linenos">1379</span></a><span class="sd">        -- will return precalc value to save time if already stored</span>
</span><span id="Bar1Dv7-1380"><a href="#Bar1Dv7-1380"><span class="linenos">1380</span></a>
</span><span id="Bar1Dv7-1381"><a href="#Bar1Dv7-1381"><span class="linenos">1381</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7-1382"><a href="#Bar1Dv7-1382"><span class="linenos">1382</span></a><span class="sd">            inds: indices to calculate across</span>
</span><span id="Bar1Dv7-1383"><a href="#Bar1Dv7-1383"><span class="linenos">1383</span></a>
</span><span id="Bar1Dv7-1384"><a href="#Bar1Dv7-1384"><span class="linenos">1384</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7-1385"><a href="#Bar1Dv7-1385"><span class="linenos">1385</span></a><span class="sd">            avRs: average firing rates across the dataset</span>
</span><span id="Bar1Dv7-1386"><a href="#Bar1Dv7-1386"><span class="linenos">1386</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1387"><a href="#Bar1Dv7-1387"><span class="linenos">1387</span></a>        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1Dv7-1388"><a href="#Bar1Dv7-1388"><span class="linenos">1388</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="Bar1Dv7-1389"><a href="#Bar1Dv7-1389"><span class="linenos">1389</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="Bar1Dv7-1390"><a href="#Bar1Dv7-1390"><span class="linenos">1390</span></a>            <span class="c1"># then calculate across whole dataset</span>
</span><span id="Bar1Dv7-1391"><a href="#Bar1Dv7-1391"><span class="linenos">1391</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1Dv7-1392"><a href="#Bar1Dv7-1392"><span class="linenos">1392</span></a>                <span class="c1"># then precalculated and do not need to do</span>
</span><span id="Bar1Dv7-1393"><a href="#Bar1Dv7-1393"><span class="linenos">1393</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span>
</span><span id="Bar1Dv7-1394"><a href="#Bar1Dv7-1394"><span class="linenos">1394</span></a>
</span><span id="Bar1Dv7-1395"><a href="#Bar1Dv7-1395"><span class="linenos">1395</span></a>        <span class="c1"># Otherwise calculate across all data</span>
</span><span id="Bar1Dv7-1396"><a href="#Bar1Dv7-1396"><span class="linenos">1396</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="Bar1Dv7-1397"><a href="#Bar1Dv7-1397"><span class="linenos">1397</span></a>            <span class="n">Reff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="Bar1Dv7-1398"><a href="#Bar1Dv7-1398"><span class="linenos">1398</span></a>            <span class="n">Teff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="Bar1Dv7-1399"><a href="#Bar1Dv7-1399"><span class="linenos">1399</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="o">/</span><span class="n">Teff</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="Bar1Dv7-1400"><a href="#Bar1Dv7-1400"><span class="linenos">1400</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7-1401"><a href="#Bar1Dv7-1401"><span class="linenos">1401</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Still need to implement avRs without preloading&#39;</span><span class="p">)</span>
</span><span id="Bar1Dv7-1402"><a href="#Bar1Dv7-1402"><span class="linenos">1402</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="Bar1Dv7-1403"><a href="#Bar1Dv7-1403"><span class="linenos">1403</span></a>    <span class="c1"># END .avrates()</span>
</span><span id="Bar1Dv7-1404"><a href="#Bar1Dv7-1404"><span class="linenos">1404</span></a>
</span><span id="Bar1Dv7-1405"><a href="#Bar1Dv7-1405"><span class="linenos">1405</span></a>    <span class="k">def</span> <span class="nf">apply_data_mask</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">dmask</span><span class="p">,</span> <span class="n">crange</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="Bar1Dv7-1406"><a href="#Bar1Dv7-1406"><span class="linenos">1406</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1407"><a href="#Bar1Dv7-1407"><span class="linenos">1407</span></a><span class="sd">        For when data_filters (or a section) is modified based on models, and want to apply</span>
</span><span id="Bar1Dv7-1408"><a href="#Bar1Dv7-1408"><span class="linenos">1408</span></a><span class="sd">        to the dataset. Ideally would save the original</span>
</span><span id="Bar1Dv7-1409"><a href="#Bar1Dv7-1409"><span class="linenos">1409</span></a><span class="sd">        </span>
</span><span id="Bar1Dv7-1410"><a href="#Bar1Dv7-1410"><span class="linenos">1410</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7-1411"><a href="#Bar1Dv7-1411"><span class="linenos">1411</span></a><span class="sd">            dmask: mask to apply to data</span>
</span><span id="Bar1Dv7-1412"><a href="#Bar1Dv7-1412"><span class="linenos">1412</span></a><span class="sd">            crange: range of cells to apply mask to</span>
</span><span id="Bar1Dv7-1413"><a href="#Bar1Dv7-1413"><span class="linenos">1413</span></a>
</span><span id="Bar1Dv7-1414"><a href="#Bar1Dv7-1414"><span class="linenos">1414</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7-1415"><a href="#Bar1Dv7-1415"><span class="linenos">1415</span></a><span class="sd">            None: sets self.dfs to new data mask</span>
</span><span id="Bar1Dv7-1416"><a href="#Bar1Dv7-1416"><span class="linenos">1416</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1417"><a href="#Bar1Dv7-1417"><span class="linenos">1417</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">,</span> <span class="s2">&quot;data must be preloaded to apply mask&quot;</span>
</span><span id="Bar1Dv7-1418"><a href="#Bar1Dv7-1418"><span class="linenos">1418</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dmask</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="Bar1Dv7-1419"><a href="#Bar1Dv7-1419"><span class="linenos">1419</span></a>            <span class="n">dmask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dmask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7-1420"><a href="#Bar1Dv7-1420"><span class="linenos">1420</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dmask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Bar1Dv7-1421"><a href="#Bar1Dv7-1421"><span class="linenos">1421</span></a>            <span class="n">dmask</span> <span class="o">=</span> <span class="n">dmask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="Bar1Dv7-1422"><a href="#Bar1Dv7-1422"><span class="linenos">1422</span></a>        <span class="n">NT</span><span class="p">,</span> <span class="n">mask_size</span> <span class="o">=</span> <span class="n">dmask</span><span class="o">.</span><span class="n">shape</span>
</span><span id="Bar1Dv7-1423"><a href="#Bar1Dv7-1423"><span class="linenos">1423</span></a>        <span class="k">assert</span> <span class="n">NT</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="s2">&quot;Data mask is wrong length&quot;</span>
</span><span id="Bar1Dv7-1424"><a href="#Bar1Dv7-1424"><span class="linenos">1424</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-1425"><a href="#Bar1Dv7-1425"><span class="linenos">1425</span></a>            <span class="n">cells_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Bar1Dv7-1426"><a href="#Bar1Dv7-1426"><span class="linenos">1426</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7-1427"><a href="#Bar1Dv7-1427"><span class="linenos">1427</span></a>            <span class="n">cells_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Bar1Dv7-1428"><a href="#Bar1Dv7-1428"><span class="linenos">1428</span></a>        <span class="k">if</span> <span class="n">crange</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1Dv7-1429"><a href="#Bar1Dv7-1429"><span class="linenos">1429</span></a>            <span class="n">crange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells_out</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Bar1Dv7-1430"><a href="#Bar1Dv7-1430"><span class="linenos">1430</span></a>        <span class="k">assert</span> <span class="n">mask_size</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">crange</span><span class="p">),</span> <span class="s2">&quot;mask does not cover the right range&quot;</span>
</span><span id="Bar1Dv7-1431"><a href="#Bar1Dv7-1431"><span class="linenos">1431</span></a>
</span><span id="Bar1Dv7-1432"><a href="#Bar1Dv7-1432"><span class="linenos">1432</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1Dv7-1433"><a href="#Bar1Dv7-1433"><span class="linenos">1433</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">)</span>
</span><span id="Bar1Dv7-1434"><a href="#Bar1Dv7-1434"><span class="linenos">1434</span></a>        <span class="c1"># Given all assertions worked, then make copy</span>
</span><span id="Bar1Dv7-1435"><a href="#Bar1Dv7-1435"><span class="linenos">1435</span></a>
</span><span id="Bar1Dv7-1436"><a href="#Bar1Dv7-1436"><span class="linenos">1436</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">cells_out</span><span class="p">[</span><span class="n">crange</span><span class="p">]]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dmask</span><span class="p">)</span>
</span><span id="Bar1Dv7-1437"><a href="#Bar1Dv7-1437"><span class="linenos">1437</span></a>    <span class="c1"># END .apply_data_mask()</span>
</span><span id="Bar1Dv7-1438"><a href="#Bar1Dv7-1438"><span class="linenos">1438</span></a>
</span><span id="Bar1Dv7-1439"><a href="#Bar1Dv7-1439"><span class="linenos">1439</span></a>    <span class="k">def</span> <span class="nf">data_mask_revert</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">crange</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="Bar1Dv7-1440"><a href="#Bar1Dv7-1440"><span class="linenos">1440</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1441"><a href="#Bar1Dv7-1441"><span class="linenos">1441</span></a><span class="sd">        Reverts data mask to original state</span>
</span><span id="Bar1Dv7-1442"><a href="#Bar1Dv7-1442"><span class="linenos">1442</span></a>
</span><span id="Bar1Dv7-1443"><a href="#Bar1Dv7-1443"><span class="linenos">1443</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7-1444"><a href="#Bar1Dv7-1444"><span class="linenos">1444</span></a><span class="sd">            crange: range of cells to revert mask</span>
</span><span id="Bar1Dv7-1445"><a href="#Bar1Dv7-1445"><span class="linenos">1445</span></a>
</span><span id="Bar1Dv7-1446"><a href="#Bar1Dv7-1446"><span class="linenos">1446</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7-1447"><a href="#Bar1Dv7-1447"><span class="linenos">1447</span></a><span class="sd">            None: sets self.dfs to original data mask</span>
</span><span id="Bar1Dv7-1448"><a href="#Bar1Dv7-1448"><span class="linenos">1448</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1449"><a href="#Bar1Dv7-1449"><span class="linenos">1449</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Nothing to revert&quot;</span>
</span><span id="Bar1Dv7-1450"><a href="#Bar1Dv7-1450"><span class="linenos">1450</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span><span class="p">)</span>
</span><span id="Bar1Dv7-1451"><a href="#Bar1Dv7-1451"><span class="linenos">1451</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1Dv7-1452"><a href="#Bar1Dv7-1452"><span class="linenos">1452</span></a>
</span><span id="Bar1Dv7-1453"><a href="#Bar1Dv7-1453"><span class="linenos">1453</span></a>    <span class="k">def</span> <span class="nf">shift_stim_fixation</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
</span><span id="Bar1Dv7-1454"><a href="#Bar1Dv7-1454"><span class="linenos">1454</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1455"><a href="#Bar1Dv7-1455"><span class="linenos">1455</span></a><span class="sd">        Simple shift by integer (rounded shift) and zero padded. Note that this is not in </span>
</span><span id="Bar1Dv7-1456"><a href="#Bar1Dv7-1456"><span class="linenos">1456</span></a><span class="sd">        is in units of number of bars, rather than -1 to +1. It assumes the stim</span>
</span><span id="Bar1Dv7-1457"><a href="#Bar1Dv7-1457"><span class="linenos">1457</span></a><span class="sd">        has a batch dimension (over a fixation), and shifts the whole stim by the same amount.</span>
</span><span id="Bar1Dv7-1458"><a href="#Bar1Dv7-1458"><span class="linenos">1458</span></a><span class="sd">        </span>
</span><span id="Bar1Dv7-1459"><a href="#Bar1Dv7-1459"><span class="linenos">1459</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7-1460"><a href="#Bar1Dv7-1460"><span class="linenos">1460</span></a><span class="sd">            stim: stimulus to shift</span>
</span><span id="Bar1Dv7-1461"><a href="#Bar1Dv7-1461"><span class="linenos">1461</span></a><span class="sd">            shift: amount to shift by</span>
</span><span id="Bar1Dv7-1462"><a href="#Bar1Dv7-1462"><span class="linenos">1462</span></a>
</span><span id="Bar1Dv7-1463"><a href="#Bar1Dv7-1463"><span class="linenos">1463</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7-1464"><a href="#Bar1Dv7-1464"><span class="linenos">1464</span></a><span class="sd">            shstim: shifted stimulus</span>
</span><span id="Bar1Dv7-1465"><a href="#Bar1Dv7-1465"><span class="linenos">1465</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1466"><a href="#Bar1Dv7-1466"><span class="linenos">1466</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Currently needs to be fixed to work with 2D&#39;</span><span class="p">)</span>
</span><span id="Bar1Dv7-1467"><a href="#Bar1Dv7-1467"><span class="linenos">1467</span></a>        <span class="n">sh</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span>
</span><span id="Bar1Dv7-1468"><a href="#Bar1Dv7-1468"><span class="linenos">1468</span></a>        <span class="n">shstim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Bar1Dv7-1469"><a href="#Bar1Dv7-1469"><span class="linenos">1469</span></a>        <span class="k">if</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-1470"><a href="#Bar1Dv7-1470"><span class="linenos">1470</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="o">-</span><span class="n">sh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="p">:</span><span class="n">sh</span><span class="p">]</span>
</span><span id="Bar1Dv7-1471"><a href="#Bar1Dv7-1471"><span class="linenos">1471</span></a>        <span class="k">elif</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-1472"><a href="#Bar1Dv7-1472"><span class="linenos">1472</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="n">sh</span><span class="p">:]</span>
</span><span id="Bar1Dv7-1473"><a href="#Bar1Dv7-1473"><span class="linenos">1473</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7-1474"><a href="#Bar1Dv7-1474"><span class="linenos">1474</span></a>            <span class="n">shstim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="Bar1Dv7-1475"><a href="#Bar1Dv7-1475"><span class="linenos">1475</span></a>
</span><span id="Bar1Dv7-1476"><a href="#Bar1Dv7-1476"><span class="linenos">1476</span></a>        <span class="k">return</span> <span class="n">shstim</span>
</span><span id="Bar1Dv7-1477"><a href="#Bar1Dv7-1477"><span class="linenos">1477</span></a>    <span class="c1"># END .shift_stim_fixation</span>
</span><span id="Bar1Dv7-1478"><a href="#Bar1Dv7-1478"><span class="linenos">1478</span></a>
</span><span id="Bar1Dv7-1479"><a href="#Bar1Dv7-1479"><span class="linenos">1479</span></a>    <span class="k">def</span> <span class="nf">create_valid_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post_sacc_gap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Bar1Dv7-1480"><a href="#Bar1Dv7-1480"><span class="linenos">1480</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1481"><a href="#Bar1Dv7-1481"><span class="linenos">1481</span></a><span class="sd">        This creates self.valid_inds vector that is used for __get_item__ </span>
</span><span id="Bar1Dv7-1482"><a href="#Bar1Dv7-1482"><span class="linenos">1482</span></a><span class="sd">        -- Will default to num_lags following each saccade beginning</span>
</span><span id="Bar1Dv7-1483"><a href="#Bar1Dv7-1483"><span class="linenos">1483</span></a><span class="sd">        </span>
</span><span id="Bar1Dv7-1484"><a href="#Bar1Dv7-1484"><span class="linenos">1484</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7-1485"><a href="#Bar1Dv7-1485"><span class="linenos">1485</span></a><span class="sd">            post_sacc_gap: number of lags to exclude following saccade</span>
</span><span id="Bar1Dv7-1486"><a href="#Bar1Dv7-1486"><span class="linenos">1486</span></a>
</span><span id="Bar1Dv7-1487"><a href="#Bar1Dv7-1487"><span class="linenos">1487</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7-1488"><a href="#Bar1Dv7-1488"><span class="linenos">1488</span></a><span class="sd">            None: sets self.valid_inds</span>
</span><span id="Bar1Dv7-1489"><a href="#Bar1Dv7-1489"><span class="linenos">1489</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1490"><a href="#Bar1Dv7-1490"><span class="linenos">1490</span></a>
</span><span id="Bar1Dv7-1491"><a href="#Bar1Dv7-1491"><span class="linenos">1491</span></a>        <span class="k">if</span> <span class="n">post_sacc_gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1Dv7-1492"><a href="#Bar1Dv7-1492"><span class="linenos">1492</span></a>            <span class="n">post_sacc_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="Bar1Dv7-1493"><a href="#Bar1Dv7-1493"><span class="linenos">1493</span></a>
</span><span id="Bar1Dv7-1494"><a href="#Bar1Dv7-1494"><span class="linenos">1494</span></a>        <span class="c1"># first, throw out all data where all data_filters are zero</span>
</span><span id="Bar1Dv7-1495"><a href="#Bar1Dv7-1495"><span class="linenos">1495</span></a>        <span class="n">is_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="Bar1Dv7-1496"><a href="#Bar1Dv7-1496"><span class="linenos">1496</span></a>        <span class="n">is_valid</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Bar1Dv7-1497"><a href="#Bar1Dv7-1497"><span class="linenos">1497</span></a>        
</span><span id="Bar1Dv7-1498"><a href="#Bar1Dv7-1498"><span class="linenos">1498</span></a>        <span class="c1"># Now invalid post_sacc_gap following saccades</span>
</span><span id="Bar1Dv7-1499"><a href="#Bar1Dv7-1499"><span class="linenos">1499</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span><span class="p">):</span>
</span><span id="Bar1Dv7-1500"><a href="#Bar1Dv7-1500"><span class="linenos">1500</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:])</span>
</span><span id="Bar1Dv7-1501"><a href="#Bar1Dv7-1501"><span class="linenos">1501</span></a>            <span class="n">sts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="Bar1Dv7-1502"><a href="#Bar1Dv7-1502"><span class="linenos">1502</span></a>            <span class="n">is_valid</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">post_sacc_gap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1Dv7-1503"><a href="#Bar1Dv7-1503"><span class="linenos">1503</span></a>        
</span><span id="Bar1Dv7-1504"><a href="#Bar1Dv7-1504"><span class="linenos">1504</span></a>        <span class="c1">#self.valid_inds = list(np.where(is_valid &gt; 0)[0])</span>
</span><span id="Bar1Dv7-1505"><a href="#Bar1Dv7-1505"><span class="linenos">1505</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_valid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7-1506"><a href="#Bar1Dv7-1506"><span class="linenos">1506</span></a>    <span class="c1"># END .create_valid_indices</span>
</span><span id="Bar1Dv7-1507"><a href="#Bar1Dv7-1507"><span class="linenos">1507</span></a>
</span><span id="Bar1Dv7-1508"><a href="#Bar1Dv7-1508"><span class="linenos">1508</span></a>    <span class="k">def</span> <span class="nf">crossval_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test_set</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Bar1Dv7-1509"><a href="#Bar1Dv7-1509"><span class="linenos">1509</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1510"><a href="#Bar1Dv7-1510"><span class="linenos">1510</span></a><span class="sd">        This sets the cross-validation indices up We can add featuers here. Many ways to do this</span>
</span><span id="Bar1Dv7-1511"><a href="#Bar1Dv7-1511"><span class="linenos">1511</span></a><span class="sd">        but will stick to some standard for now. It sets the internal indices, which can be read out</span>
</span><span id="Bar1Dv7-1512"><a href="#Bar1Dv7-1512"><span class="linenos">1512</span></a><span class="sd">        directly or with helper functions. Perhaps helper_functions is the best way....</span>
</span><span id="Bar1Dv7-1513"><a href="#Bar1Dv7-1513"><span class="linenos">1513</span></a><span class="sd">        </span>
</span><span id="Bar1Dv7-1514"><a href="#Bar1Dv7-1514"><span class="linenos">1514</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7-1515"><a href="#Bar1Dv7-1515"><span class="linenos">1515</span></a><span class="sd">            folds: number of folds to use</span>
</span><span id="Bar1Dv7-1516"><a href="#Bar1Dv7-1516"><span class="linenos">1516</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="Bar1Dv7-1517"><a href="#Bar1Dv7-1517"><span class="linenos">1517</span></a><span class="sd">            test_set: whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</span>
</span><span id="Bar1Dv7-1518"><a href="#Bar1Dv7-1518"><span class="linenos">1518</span></a><span class="sd">            verbose: whether to print out information</span>
</span><span id="Bar1Dv7-1519"><a href="#Bar1Dv7-1519"><span class="linenos">1519</span></a><span class="sd">        </span>
</span><span id="Bar1Dv7-1520"><a href="#Bar1Dv7-1520"><span class="linenos">1520</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7-1521"><a href="#Bar1Dv7-1521"><span class="linenos">1521</span></a><span class="sd">            None: sets internal variables test_inds, train_inds, val_inds</span>
</span><span id="Bar1Dv7-1522"><a href="#Bar1Dv7-1522"><span class="linenos">1522</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1523"><a href="#Bar1Dv7-1523"><span class="linenos">1523</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must first specify valid_indices before setting up cross-validation.&quot;</span>
</span><span id="Bar1Dv7-1524"><a href="#Bar1Dv7-1524"><span class="linenos">1524</span></a>
</span><span id="Bar1Dv7-1525"><a href="#Bar1Dv7-1525"><span class="linenos">1525</span></a>        <span class="c1"># Reflect block structure</span>
</span><span id="Bar1Dv7-1526"><a href="#Bar1Dv7-1526"><span class="linenos">1526</span></a>        <span class="n">Nblks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="Bar1Dv7-1527"><a href="#Bar1Dv7-1527"><span class="linenos">1527</span></a>        <span class="n">val_blk1</span><span class="p">,</span> <span class="n">tr_blk1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="n">Nblks</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="Bar1Dv7-1528"><a href="#Bar1Dv7-1528"><span class="linenos">1528</span></a>
</span><span id="Bar1Dv7-1529"><a href="#Bar1Dv7-1529"><span class="linenos">1529</span></a>        <span class="k">if</span> <span class="n">test_set</span><span class="p">:</span>
</span><span id="Bar1Dv7-1530"><a href="#Bar1Dv7-1530"><span class="linenos">1530</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="n">val_blk1</span>
</span><span id="Bar1Dv7-1531"><a href="#Bar1Dv7-1531"><span class="linenos">1531</span></a>            <span class="n">val_blk2</span><span class="p">,</span> <span class="n">tr_blk2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_blk1</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="Bar1Dv7-1532"><a href="#Bar1Dv7-1532"><span class="linenos">1532</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span><span class="p">[</span><span class="n">val_blk2</span><span class="p">]</span>
</span><span id="Bar1Dv7-1533"><a href="#Bar1Dv7-1533"><span class="linenos">1533</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span><span class="p">[</span><span class="n">tr_blk2</span><span class="p">]</span>
</span><span id="Bar1Dv7-1534"><a href="#Bar1Dv7-1534"><span class="linenos">1534</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7-1535"><a href="#Bar1Dv7-1535"><span class="linenos">1535</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">val_blk1</span>
</span><span id="Bar1Dv7-1536"><a href="#Bar1Dv7-1536"><span class="linenos">1536</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span>
</span><span id="Bar1Dv7-1537"><a href="#Bar1Dv7-1537"><span class="linenos">1537</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7-1538"><a href="#Bar1Dv7-1538"><span class="linenos">1538</span></a>
</span><span id="Bar1Dv7-1539"><a href="#Bar1Dv7-1539"><span class="linenos">1539</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Bar1Dv7-1540"><a href="#Bar1Dv7-1540"><span class="linenos">1540</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Partitioned </span><span class="si">%d</span><span class="s2"> fixations total: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span>
</span><span id="Bar1Dv7-1541"><a href="#Bar1Dv7-1541"><span class="linenos">1541</span></a>                <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">)))</span>  
</span><span id="Bar1Dv7-1542"><a href="#Bar1Dv7-1542"><span class="linenos">1542</span></a>
</span><span id="Bar1Dv7-1543"><a href="#Bar1Dv7-1543"><span class="linenos">1543</span></a>        <span class="c1"># Now pull indices from each saccade </span>
</span><span id="Bar1Dv7-1544"><a href="#Bar1Dv7-1544"><span class="linenos">1544</span></a>        <span class="n">tr_inds</span><span class="p">,</span> <span class="n">te_inds</span><span class="p">,</span> <span class="n">val_inds</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="Bar1Dv7-1545"><a href="#Bar1Dv7-1545"><span class="linenos">1545</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">:</span>
</span><span id="Bar1Dv7-1546"><a href="#Bar1Dv7-1546"><span class="linenos">1546</span></a>            <span class="n">tr_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="Bar1Dv7-1547"><a href="#Bar1Dv7-1547"><span class="linenos">1547</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">:</span>
</span><span id="Bar1Dv7-1548"><a href="#Bar1Dv7-1548"><span class="linenos">1548</span></a>            <span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="Bar1Dv7-1549"><a href="#Bar1Dv7-1549"><span class="linenos">1549</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">:</span>
</span><span id="Bar1Dv7-1550"><a href="#Bar1Dv7-1550"><span class="linenos">1550</span></a>            <span class="n">te_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="Bar1Dv7-1551"><a href="#Bar1Dv7-1551"><span class="linenos">1551</span></a>
</span><span id="Bar1Dv7-1552"><a href="#Bar1Dv7-1552"><span class="linenos">1552</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Bar1Dv7-1553"><a href="#Bar1Dv7-1553"><span class="linenos">1553</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Pre-valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">te_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="Bar1Dv7-1554"><a href="#Bar1Dv7-1554"><span class="linenos">1554</span></a>
</span><span id="Bar1Dv7-1555"><a href="#Bar1Dv7-1555"><span class="linenos">1555</span></a>        <span class="c1"># Finally intersect with used_inds</span>
</span><span id="Bar1Dv7-1556"><a href="#Bar1Dv7-1556"><span class="linenos">1556</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="Bar1Dv7-1557"><a href="#Bar1Dv7-1557"><span class="linenos">1557</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">val_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="Bar1Dv7-1558"><a href="#Bar1Dv7-1558"><span class="linenos">1558</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">te_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="Bar1Dv7-1559"><a href="#Bar1Dv7-1559"><span class="linenos">1559</span></a>
</span><span id="Bar1Dv7-1560"><a href="#Bar1Dv7-1560"><span class="linenos">1560</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Bar1Dv7-1561"><a href="#Bar1Dv7-1561"><span class="linenos">1561</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="Bar1Dv7-1562"><a href="#Bar1Dv7-1562"><span class="linenos">1562</span></a>
</span><span id="Bar1Dv7-1563"><a href="#Bar1Dv7-1563"><span class="linenos">1563</span></a>    <span class="c1"># END .crossval_setup()</span>
</span><span id="Bar1Dv7-1564"><a href="#Bar1Dv7-1564"><span class="linenos">1564</span></a>
</span><span id="Bar1Dv7-1565"><a href="#Bar1Dv7-1565"><span class="linenos">1565</span></a>    <span class="k">def</span> <span class="nf">fold_sample</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Bar1Dv7-1566"><a href="#Bar1Dv7-1566"><span class="linenos">1566</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1567"><a href="#Bar1Dv7-1567"><span class="linenos">1567</span></a><span class="sd">        This really should be a general method not associated with self</span>
</span><span id="Bar1Dv7-1568"><a href="#Bar1Dv7-1568"><span class="linenos">1568</span></a><span class="sd">        </span>
</span><span id="Bar1Dv7-1569"><a href="#Bar1Dv7-1569"><span class="linenos">1569</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7-1570"><a href="#Bar1Dv7-1570"><span class="linenos">1570</span></a><span class="sd">            num_items: number of items to fold</span>
</span><span id="Bar1Dv7-1571"><a href="#Bar1Dv7-1571"><span class="linenos">1571</span></a><span class="sd">            folds: number of folds</span>
</span><span id="Bar1Dv7-1572"><a href="#Bar1Dv7-1572"><span class="linenos">1572</span></a><span class="sd">            random_gen: whether to randomly sample or uniformly sample</span>
</span><span id="Bar1Dv7-1573"><a href="#Bar1Dv7-1573"><span class="linenos">1573</span></a>
</span><span id="Bar1Dv7-1574"><a href="#Bar1Dv7-1574"><span class="linenos">1574</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7-1575"><a href="#Bar1Dv7-1575"><span class="linenos">1575</span></a><span class="sd">            val_items: indices for validation set</span>
</span><span id="Bar1Dv7-1576"><a href="#Bar1Dv7-1576"><span class="linenos">1576</span></a><span class="sd">            rem_items: indices for remaining set</span>
</span><span id="Bar1Dv7-1577"><a href="#Bar1Dv7-1577"><span class="linenos">1577</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1578"><a href="#Bar1Dv7-1578"><span class="linenos">1578</span></a>        <span class="k">if</span> <span class="n">random_gen</span><span class="p">:</span>
</span><span id="Bar1Dv7-1579"><a href="#Bar1Dv7-1579"><span class="linenos">1579</span></a>            <span class="n">num_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_items</span><span class="o">/</span><span class="n">folds</span><span class="p">)</span>
</span><span id="Bar1Dv7-1580"><a href="#Bar1Dv7-1580"><span class="linenos">1580</span></a>            <span class="n">tmp_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">num_items</span><span class="p">)</span>
</span><span id="Bar1Dv7-1581"><a href="#Bar1Dv7-1581"><span class="linenos">1581</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[:</span><span class="n">num_val</span><span class="p">])</span>
</span><span id="Bar1Dv7-1582"><a href="#Bar1Dv7-1582"><span class="linenos">1582</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[</span><span class="n">num_val</span><span class="p">:])</span>
</span><span id="Bar1Dv7-1583"><a href="#Bar1Dv7-1583"><span class="linenos">1583</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7-1584"><a href="#Bar1Dv7-1584"><span class="linenos">1584</span></a>            <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">folds</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="Bar1Dv7-1585"><a href="#Bar1Dv7-1585"><span class="linenos">1585</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
</span><span id="Bar1Dv7-1586"><a href="#Bar1Dv7-1586"><span class="linenos">1586</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">),</span> <span class="n">val_items</span><span class="p">)</span>
</span><span id="Bar1Dv7-1587"><a href="#Bar1Dv7-1587"><span class="linenos">1587</span></a>        <span class="k">return</span> <span class="n">val_items</span><span class="p">,</span> <span class="n">rem_items</span>
</span><span id="Bar1Dv7-1588"><a href="#Bar1Dv7-1588"><span class="linenos">1588</span></a>
</span><span id="Bar1Dv7-1589"><a href="#Bar1Dv7-1589"><span class="linenos">1589</span></a>    <span class="k">def</span> <span class="nf">adjust_Xdrift_xval</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="Bar1Dv7-1590"><a href="#Bar1Dv7-1590"><span class="linenos">1590</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1591"><a href="#Bar1Dv7-1591"><span class="linenos">1591</span></a><span class="sd">        Adjust drift matrix to not fit xval parameterz</span>
</span><span id="Bar1Dv7-1592"><a href="#Bar1Dv7-1592"><span class="linenos">1592</span></a>
</span><span id="Bar1Dv7-1593"><a href="#Bar1Dv7-1593"><span class="linenos">1593</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7-1594"><a href="#Bar1Dv7-1594"><span class="linenos">1594</span></a><span class="sd">            None</span>
</span><span id="Bar1Dv7-1595"><a href="#Bar1Dv7-1595"><span class="linenos">1595</span></a>
</span><span id="Bar1Dv7-1596"><a href="#Bar1Dv7-1596"><span class="linenos">1596</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7-1597"><a href="#Bar1Dv7-1597"><span class="linenos">1597</span></a><span class="sd">            None: sets self.Xdrift to new matrix</span>
</span><span id="Bar1Dv7-1598"><a href="#Bar1Dv7-1598"><span class="linenos">1598</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1599"><a href="#Bar1Dv7-1599"><span class="linenos">1599</span></a>        <span class="n">Xnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">]</span>
</span><span id="Bar1Dv7-1600"><a href="#Bar1Dv7-1600"><span class="linenos">1600</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">)):</span>
</span><span id="Bar1Dv7-1601"><a href="#Bar1Dv7-1601"><span class="linenos">1601</span></a>            <span class="n">newpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">ii</span> <span class="c1"># this will be where lower range is</span>
</span><span id="Bar1Dv7-1602"><a href="#Bar1Dv7-1602"><span class="linenos">1602</span></a>            <span class="k">if</span> <span class="n">newpos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-1603"><a href="#Bar1Dv7-1603"><span class="linenos">1603</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="Bar1Dv7-1604"><a href="#Bar1Dv7-1604"><span class="linenos">1604</span></a>            <span class="k">elif</span> <span class="n">newpos</span> <span class="o">==</span> <span class="n">Xnew</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="Bar1Dv7-1605"><a href="#Bar1Dv7-1605"><span class="linenos">1605</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="Bar1Dv7-1606"><a href="#Bar1Dv7-1606"><span class="linenos">1606</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># In between</span>
</span><span id="Bar1Dv7-1607"><a href="#Bar1Dv7-1607"><span class="linenos">1607</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span> <span class="n">newpos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="Bar1Dv7-1608"><a href="#Bar1Dv7-1608"><span class="linenos">1608</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span> <span class="n">newpos</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="Bar1Dv7-1609"><a href="#Bar1Dv7-1609"><span class="linenos">1609</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">Xnew</span>
</span><span id="Bar1Dv7-1610"><a href="#Bar1Dv7-1610"><span class="linenos">1610</span></a>    <span class="c1"># END .adjust_drift_xval</span>
</span><span id="Bar1Dv7-1611"><a href="#Bar1Dv7-1611"><span class="linenos">1611</span></a>
</span><span id="Bar1Dv7-1612"><a href="#Bar1Dv7-1612"><span class="linenos">1612</span></a>    <span class="k">def</span> <span class="nf">get_max_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpu_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nquad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mf">1.2</span><span class="p">):</span>
</span><span id="Bar1Dv7-1613"><a href="#Bar1Dv7-1613"><span class="linenos">1613</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1614"><a href="#Bar1Dv7-1614"><span class="linenos">1614</span></a><span class="sd">        get the maximum number of samples that fit in memory -- for GLM/GQM x LBFGS</span>
</span><span id="Bar1Dv7-1615"><a href="#Bar1Dv7-1615"><span class="linenos">1615</span></a>
</span><span id="Bar1Dv7-1616"><a href="#Bar1Dv7-1616"><span class="linenos">1616</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7-1617"><a href="#Bar1Dv7-1617"><span class="linenos">1617</span></a><span class="sd">            gpu_n: which gpu to use</span>
</span><span id="Bar1Dv7-1618"><a href="#Bar1Dv7-1618"><span class="linenos">1618</span></a><span class="sd">            history_size: number of time lags</span>
</span><span id="Bar1Dv7-1619"><a href="#Bar1Dv7-1619"><span class="linenos">1619</span></a><span class="sd">            nquad: number of quadrature points</span>
</span><span id="Bar1Dv7-1620"><a href="#Bar1Dv7-1620"><span class="linenos">1620</span></a><span class="sd">            num_cells: number of cells to use</span>
</span><span id="Bar1Dv7-1621"><a href="#Bar1Dv7-1621"><span class="linenos">1621</span></a><span class="sd">            buffer: buffer to leave for other memory</span>
</span><span id="Bar1Dv7-1622"><a href="#Bar1Dv7-1622"><span class="linenos">1622</span></a>
</span><span id="Bar1Dv7-1623"><a href="#Bar1Dv7-1623"><span class="linenos">1623</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7-1624"><a href="#Bar1Dv7-1624"><span class="linenos">1624</span></a><span class="sd">            maxsamples: maximum number of samples that can fit in memory</span>
</span><span id="Bar1Dv7-1625"><a href="#Bar1Dv7-1625"><span class="linenos">1625</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1626"><a href="#Bar1Dv7-1626"><span class="linenos">1626</span></a>        <span class="k">if</span> <span class="n">gpu_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-1627"><a href="#Bar1Dv7-1627"><span class="linenos">1627</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
</span><span id="Bar1Dv7-1628"><a href="#Bar1Dv7-1628"><span class="linenos">1628</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7-1629"><a href="#Bar1Dv7-1629"><span class="linenos">1629</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:1&#39;</span><span class="p">)</span>
</span><span id="Bar1Dv7-1630"><a href="#Bar1Dv7-1630"><span class="linenos">1630</span></a>
</span><span id="Bar1Dv7-1631"><a href="#Bar1Dv7-1631"><span class="linenos">1631</span></a>        <span class="k">if</span> <span class="n">num_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1Dv7-1632"><a href="#Bar1Dv7-1632"><span class="linenos">1632</span></a>            <span class="n">num_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span>
</span><span id="Bar1Dv7-1633"><a href="#Bar1Dv7-1633"><span class="linenos">1633</span></a>        
</span><span id="Bar1Dv7-1634"><a href="#Bar1Dv7-1634"><span class="linenos">1634</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">total_memory</span>
</span><span id="Bar1Dv7-1635"><a href="#Bar1Dv7-1635"><span class="linenos">1635</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_reserved</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7-1636"><a href="#Bar1Dv7-1636"><span class="linenos">1636</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_allocated</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7-1637"><a href="#Bar1Dv7-1637"><span class="linenos">1637</span></a>        <span class="n">free</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">r</span><span class="p">)</span>
</span><span id="Bar1Dv7-1638"><a href="#Bar1Dv7-1638"><span class="linenos">1638</span></a>
</span><span id="Bar1Dv7-1639"><a href="#Bar1Dv7-1639"><span class="linenos">1639</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7-1640"><a href="#Bar1Dv7-1640"><span class="linenos">1640</span></a>        <span class="n">mempersample</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span>
</span><span id="Bar1Dv7-1641"><a href="#Bar1Dv7-1641"><span class="linenos">1641</span></a>    
</span><span id="Bar1Dv7-1642"><a href="#Bar1Dv7-1642"><span class="linenos">1642</span></a>        <span class="n">mempercell</span> <span class="o">=</span> <span class="n">mempersample</span> <span class="o">*</span> <span class="p">(</span><span class="n">nquad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">history_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Bar1Dv7-1643"><a href="#Bar1Dv7-1643"><span class="linenos">1643</span></a>        <span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">*</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span>
</span><span id="Bar1Dv7-1644"><a href="#Bar1Dv7-1644"><span class="linenos">1644</span></a>
</span><span id="Bar1Dv7-1645"><a href="#Bar1Dv7-1645"><span class="linenos">1645</span></a>        <span class="n">maxsamples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">free</span> <span class="o">-</span> <span class="n">mempercell</span><span class="o">*</span><span class="n">num_cells</span> <span class="o">-</span> <span class="n">buffer_bytes</span><span class="p">)</span> <span class="o">//</span> <span class="n">mempersample</span>
</span><span id="Bar1Dv7-1646"><a href="#Bar1Dv7-1646"><span class="linenos">1646</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# samples that can fit on device: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxsamples</span><span class="p">))</span>
</span><span id="Bar1Dv7-1647"><a href="#Bar1Dv7-1647"><span class="linenos">1647</span></a>        <span class="k">return</span> <span class="n">maxsamples</span>
</span><span id="Bar1Dv7-1648"><a href="#Bar1Dv7-1648"><span class="linenos">1648</span></a>    <span class="c1"># END .get_max_samples</span>
</span><span id="Bar1Dv7-1649"><a href="#Bar1Dv7-1649"><span class="linenos">1649</span></a>
</span><span id="Bar1Dv7-1650"><a href="#Bar1Dv7-1650"><span class="linenos">1650</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="Bar1Dv7-1651"><a href="#Bar1Dv7-1651"><span class="linenos">1651</span></a>        
</span><span id="Bar1Dv7-1652"><a href="#Bar1Dv7-1652"><span class="linenos">1652</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="Bar1Dv7-1653"><a href="#Bar1Dv7-1653"><span class="linenos">1653</span></a>
</span><span id="Bar1Dv7-1654"><a href="#Bar1Dv7-1654"><span class="linenos">1654</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Bar1Dv7-1655"><a href="#Bar1Dv7-1655"><span class="linenos">1655</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;get_item time embedding not implemented yet&quot;</span><span class="p">)</span>
</span><span id="Bar1Dv7-1656"><a href="#Bar1Dv7-1656"><span class="linenos">1656</span></a>                <span class="c1"># if self.folded_lags:</span>
</span><span id="Bar1Dv7-1657"><a href="#Bar1Dv7-1657"><span class="linenos">1657</span></a>                <span class="c1">#    stim = np.transpose( tmp_stim, axes=[0,2,1,3,4] ) </span>
</span><span id="Bar1Dv7-1658"><a href="#Bar1Dv7-1658"><span class="linenos">1658</span></a>                <span class="c1">#else:</span>
</span><span id="Bar1Dv7-1659"><a href="#Bar1Dv7-1659"><span class="linenos">1659</span></a>                <span class="c1">#    stim = np.transpose( tmp_stim, axes=[0,2,3,4,1] )</span>
</span><span id="Bar1Dv7-1660"><a href="#Bar1Dv7-1660"><span class="linenos">1660</span></a>    
</span><span id="Bar1Dv7-1661"><a href="#Bar1Dv7-1661"><span class="linenos">1661</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7-1662"><a href="#Bar1Dv7-1662"><span class="linenos">1662</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="Bar1Dv7-1663"><a href="#Bar1Dv7-1663"><span class="linenos">1663</span></a>                    <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Bar1Dv7-1664"><a href="#Bar1Dv7-1664"><span class="linenos">1664</span></a>                        <span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> 
</span><span id="Bar1Dv7-1665"><a href="#Bar1Dv7-1665"><span class="linenos">1665</span></a>                        <span class="s1">&#39;stimH&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> 
</span><span id="Bar1Dv7-1666"><a href="#Bar1Dv7-1666"><span class="linenos">1666</span></a>                        <span class="s1">&#39;stimV&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]}</span>
</span><span id="Bar1Dv7-1667"><a href="#Bar1Dv7-1667"><span class="linenos">1667</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7-1668"><a href="#Bar1Dv7-1668"><span class="linenos">1668</span></a>                    <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Bar1Dv7-1669"><a href="#Bar1Dv7-1669"><span class="linenos">1669</span></a>                        <span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> 
</span><span id="Bar1Dv7-1670"><a href="#Bar1Dv7-1670"><span class="linenos">1670</span></a>                        <span class="s1">&#39;stimV&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]}</span>
</span><span id="Bar1Dv7-1671"><a href="#Bar1Dv7-1671"><span class="linenos">1671</span></a>                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;fix_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="Bar1Dv7-1672"><a href="#Bar1Dv7-1672"><span class="linenos">1672</span></a>                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Xdrift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="Bar1Dv7-1673"><a href="#Bar1Dv7-1673"><span class="linenos">1673</span></a>
</span><span id="Bar1Dv7-1674"><a href="#Bar1Dv7-1674"><span class="linenos">1674</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-1675"><a href="#Bar1Dv7-1675"><span class="linenos">1675</span></a>                    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="Bar1Dv7-1676"><a href="#Bar1Dv7-1676"><span class="linenos">1676</span></a>                    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="Bar1Dv7-1677"><a href="#Bar1Dv7-1677"><span class="linenos">1677</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7-1678"><a href="#Bar1Dv7-1678"><span class="linenos">1678</span></a>                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s1">&#39;cells_out must be a list&#39;</span>
</span><span id="Bar1Dv7-1679"><a href="#Bar1Dv7-1679"><span class="linenos">1679</span></a>                    <span class="n">robs_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="Bar1Dv7-1680"><a href="#Bar1Dv7-1680"><span class="linenos">1680</span></a>                    <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="Bar1Dv7-1681"><a href="#Bar1Dv7-1681"><span class="linenos">1681</span></a>                    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">robs_tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="Bar1Dv7-1682"><a href="#Bar1Dv7-1682"><span class="linenos">1682</span></a>                    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfs_tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="Bar1Dv7-1683"><a href="#Bar1Dv7-1683"><span class="linenos">1683</span></a>
</span><span id="Bar1Dv7-1684"><a href="#Bar1Dv7-1684"><span class="linenos">1684</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-1685"><a href="#Bar1Dv7-1685"><span class="linenos">1685</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">append_covariates</span><span class="p">(</span> <span class="n">out</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span><span id="Bar1Dv7-1686"><a href="#Bar1Dv7-1686"><span class="linenos">1686</span></a>
</span><span id="Bar1Dv7-1687"><a href="#Bar1Dv7-1687"><span class="linenos">1687</span></a>            
</span><span id="Bar1Dv7-1688"><a href="#Bar1Dv7-1688"><span class="linenos">1688</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7-1689"><a href="#Bar1Dv7-1689"><span class="linenos">1689</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="Bar1Dv7-1690"><a href="#Bar1Dv7-1690"><span class="linenos">1690</span></a>            <span class="n">stim</span><span class="p">,</span> <span class="n">stimV</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="Bar1Dv7-1691"><a href="#Bar1Dv7-1691"><span class="linenos">1691</span></a>            <span class="n">robs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7-1692"><a href="#Bar1Dv7-1692"><span class="linenos">1692</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7-1693"><a href="#Bar1Dv7-1693"><span class="linenos">1693</span></a>            <span class="n">num_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Bar1Dv7-1694"><a href="#Bar1Dv7-1694"><span class="linenos">1694</span></a>
</span><span id="Bar1Dv7-1695"><a href="#Bar1Dv7-1695"><span class="linenos">1695</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Stim &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1696"><a href="#Bar1Dv7-1696"><span class="linenos">1696</span></a>            <span class="c1"># need file handle</span>
</span><span id="Bar1Dv7-1697"><a href="#Bar1Dv7-1697"><span class="linenos">1697</span></a>            <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1Dv7-1698"><a href="#Bar1Dv7-1698"><span class="linenos">1698</span></a>            <span class="c1">#f = self.file_index[inds]  # problem is this could span across several files</span>
</span><span id="Bar1Dv7-1699"><a href="#Bar1Dv7-1699"><span class="linenos">1699</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NOT DONE YET&quot;</span><span class="p">)</span>
</span><span id="Bar1Dv7-1700"><a href="#Bar1Dv7-1700"><span class="linenos">1700</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">stimname</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7-1701"><a href="#Bar1Dv7-1701"><span class="linenos">1701</span></a>            <span class="c1"># reshape and flatten stim: currently its NT x NX x NY x Nclrs</span>
</span><span id="Bar1Dv7-1702"><a href="#Bar1Dv7-1702"><span class="linenos">1702</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">permute</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">])</span>
</span><span id="Bar1Dv7-1703"><a href="#Bar1Dv7-1703"><span class="linenos">1703</span></a><span class="w">                </span>
</span><span id="Bar1Dv7-1704"><a href="#Bar1Dv7-1704"><span class="linenos">1704</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Spikes: needs padding so all are B x NC &quot;&quot;&quot;</span> 
</span><span id="Bar1Dv7-1705"><a href="#Bar1Dv7-1705"><span class="linenos">1705</span></a>            <span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;Robs&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7-1706"><a href="#Bar1Dv7-1706"><span class="linenos">1706</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="Bar1Dv7-1707"><a href="#Bar1Dv7-1707"><span class="linenos">1707</span></a>                <span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="Bar1Dv7-1708"><a href="#Bar1Dv7-1708"><span class="linenos">1708</span></a>                    <span class="p">(</span><span class="n">robs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span> 
</span><span id="Bar1Dv7-1709"><a href="#Bar1Dv7-1709"><span class="linenos">1709</span></a>                    <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Bar1Dv7-1710"><a href="#Bar1Dv7-1710"><span class="linenos">1710</span></a>
</span><span id="Bar1Dv7-1711"><a href="#Bar1Dv7-1711"><span class="linenos">1711</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Datafilters: needs padding like robs &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7-1712"><a href="#Bar1Dv7-1712"><span class="linenos">1712</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;DFs&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7-1713"><a href="#Bar1Dv7-1713"><span class="linenos">1713</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="Bar1Dv7-1714"><a href="#Bar1Dv7-1714"><span class="linenos">1714</span></a>                <span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="Bar1Dv7-1715"><a href="#Bar1Dv7-1715"><span class="linenos">1715</span></a>                    <span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;DFsMU&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span>
</span><span id="Bar1Dv7-1716"><a href="#Bar1Dv7-1716"><span class="linenos">1716</span></a>                    <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Bar1Dv7-1717"><a href="#Bar1Dv7-1717"><span class="linenos">1717</span></a>
</span><span id="Bar1Dv7-1718"><a href="#Bar1Dv7-1718"><span class="linenos">1718</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="n">stim</span><span class="p">,</span> <span class="s1">&#39;stimV&#39;</span><span class="p">:</span> <span class="n">stimV</span><span class="p">,</span> <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="n">robs</span><span class="p">,</span> <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="n">dfs</span><span class="p">,</span> <span class="s1">&#39;fix_n&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">[</span><span class="n">inds</span><span class="p">]}</span>
</span><span id="Bar1Dv7-1719"><a href="#Bar1Dv7-1719"><span class="linenos">1719</span></a>
</span><span id="Bar1Dv7-1720"><a href="#Bar1Dv7-1720"><span class="linenos">1720</span></a>        <span class="c1">### THIS IS NOT NEEDED WITH TIME-EMBEDDING: needs to be on fixation-process side...</span>
</span><span id="Bar1Dv7-1721"><a href="#Bar1Dv7-1721"><span class="linenos">1721</span></a>        <span class="c1">#         # Augment to eliminate first X time steps in data_filters</span>
</span><span id="Bar1Dv7-1722"><a href="#Bar1Dv7-1722"><span class="linenos">1722</span></a>        <span class="c1">#if (self.num_lags &gt; 0) &amp;  ~utils.is_int(idx):</span>
</span><span id="Bar1Dv7-1723"><a href="#Bar1Dv7-1723"><span class="linenos">1723</span></a>        <span class="c1">#    if out[&#39;dfs&#39;].shape[0] &lt;= self.num_lags:</span>
</span><span id="Bar1Dv7-1724"><a href="#Bar1Dv7-1724"><span class="linenos">1724</span></a>        <span class="c1">#        print( &quot;Warning: fixation shorter than num_lags: %d &lt;= %d&quot;%(out[&#39;dfs&#39;].shape[0], self.num_lags))</span>
</span><span id="Bar1Dv7-1725"><a href="#Bar1Dv7-1725"><span class="linenos">1725</span></a>        <span class="c1">#    else:</span>
</span><span id="Bar1Dv7-1726"><a href="#Bar1Dv7-1726"><span class="linenos">1726</span></a>        <span class="c1">#        out[&#39;dfs&#39;][:self.num_lags, :] = 0.0</span>
</span><span id="Bar1Dv7-1727"><a href="#Bar1Dv7-1727"><span class="linenos">1727</span></a>
</span><span id="Bar1Dv7-1728"><a href="#Bar1Dv7-1728"><span class="linenos">1728</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span><span class="p">:</span>
</span><span id="Bar1Dv7-1729"><a href="#Bar1Dv7-1729"><span class="linenos">1729</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;DATASET: shifts missing but &#39;with_shifter&#39; is true&quot;</span> 
</span><span id="Bar1Dv7-1730"><a href="#Bar1Dv7-1730"><span class="linenos">1730</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;shifts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="Bar1Dv7-1731"><a href="#Bar1Dv7-1731"><span class="linenos">1731</span></a>
</span><span id="Bar1Dv7-1732"><a href="#Bar1Dv7-1732"><span class="linenos">1732</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7-1733"><a href="#Bar1Dv7-1733"><span class="linenos">1733</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">append_covariates</span><span class="p">(</span> <span class="n">out</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span><span id="Bar1Dv7-1734"><a href="#Bar1Dv7-1734"><span class="linenos">1734</span></a>
</span><span id="Bar1Dv7-1735"><a href="#Bar1Dv7-1735"><span class="linenos">1735</span></a>        <span class="k">return</span> <span class="n">out</span>                
</span><span id="Bar1Dv7-1736"><a href="#Bar1Dv7-1736"><span class="linenos">1736</span></a>
</span><span id="Bar1Dv7-1737"><a href="#Bar1Dv7-1737"><span class="linenos">1737</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Bar1Dv7-1738"><a href="#Bar1Dv7-1738"><span class="linenos">1738</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span></pre></div>


            <div class="docstring"><p>-- can load batches from multiple datasets
-- hdf5 files must have the following information:
    Robs
    RobsMU
    stim: 4-d stimulus: time x nx x ny x color
    block_inds: start and stop of 'trials' (perhaps fixations for now)
    other things: saccades? or should that be in trials? </p>

<p>Constructor will take eye position, which for now is an input from data
generated in the session (not on disk). It should have the length size 
of the total number of fixations x1.</p>
</div>


                            <div id="Bar1Dv7.__init__" class="classattr">
                                        <input id="Bar1Dv7.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Bar1Dv7</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">sess_list</span>,</span><span class="param">	<span class="n">datadir</span>,</span><span class="param">	<span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span>,</span><span class="param">	<span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">Hstim_shift</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">Hdiscardzero</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">time_embed</span><span class="o">=</span><span class="mi">2</span>,</span><span class="param">	<span class="n">folded_lags</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">combine_stim</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">stim_gap</span><span class="o">=</span><span class="mi">8</span>,</span><span class="param">	<span class="n">drift_interval</span><span class="o">=</span><span class="mi">16</span>,</span><span class="param">	<span class="n">eye_config</span><span class="o">=</span><span class="mi">2</span>,</span><span class="param">	<span class="n">ignore_saccades</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">include_MUs</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">preload</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">eyepos</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span></span>)</span>

                <label class="view-source-button" for="Bar1Dv7.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1Dv7.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1Dv7.__init__-833"><a href="#Bar1Dv7.__init__-833"><span class="linenos"> 833</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="Bar1Dv7.__init__-834"><a href="#Bar1Dv7.__init__-834"><span class="linenos"> 834</span></a>        <span class="n">sess_list</span><span class="p">,</span>
</span><span id="Bar1Dv7.__init__-835"><a href="#Bar1Dv7.__init__-835"><span class="linenos"> 835</span></a>        <span class="n">datadir</span><span class="p">,</span> 
</span><span id="Bar1Dv7.__init__-836"><a href="#Bar1Dv7.__init__-836"><span class="linenos"> 836</span></a>        <span class="c1"># Stim setup</span>
</span><span id="Bar1Dv7.__init__-837"><a href="#Bar1Dv7.__init__-837"><span class="linenos"> 837</span></a>        <span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
</span><span id="Bar1Dv7.__init__-838"><a href="#Bar1Dv7.__init__-838"><span class="linenos"> 838</span></a>        <span class="c1">#which_stim = &#39;stimET&#39;,</span>
</span><span id="Bar1Dv7.__init__-839"><a href="#Bar1Dv7.__init__-839"><span class="linenos"> 839</span></a>        <span class="n">stim_crop</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Bar1Dv7.__init__-840"><a href="#Bar1Dv7.__init__-840"><span class="linenos"> 840</span></a>        <span class="n">Hstim_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># to shift-and-wrap stimH stimulus</span>
</span><span id="Bar1Dv7.__init__-841"><a href="#Bar1Dv7.__init__-841"><span class="linenos"> 841</span></a>        <span class="n">Hdiscardzero</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Bar1Dv7.__init__-842"><a href="#Bar1Dv7.__init__-842"><span class="linenos"> 842</span></a>        <span class="n">time_embed</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="Bar1Dv7.__init__-843"><a href="#Bar1Dv7.__init__-843"><span class="linenos"> 843</span></a>        <span class="n">folded_lags</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Bar1Dv7.__init__-844"><a href="#Bar1Dv7.__init__-844"><span class="linenos"> 844</span></a>        <span class="c1"># Stim configuation</span>
</span><span id="Bar1Dv7.__init__-845"><a href="#Bar1Dv7.__init__-845"><span class="linenos"> 845</span></a>        <span class="n">combine_stim</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># if False, horizontal stim will be &#39;stim&#39;</span>
</span><span id="Bar1Dv7.__init__-846"><a href="#Bar1Dv7.__init__-846"><span class="linenos"> 846</span></a>        <span class="n">stim_gap</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="Bar1Dv7.__init__-847"><a href="#Bar1Dv7.__init__-847"><span class="linenos"> 847</span></a>        <span class="n">drift_interval</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>  <span class="c1"># how many trials to anchor each drift term</span>
</span><span id="Bar1Dv7.__init__-848"><a href="#Bar1Dv7.__init__-848"><span class="linenos"> 848</span></a>        <span class="c1"># eye configuration</span>
</span><span id="Bar1Dv7.__init__-849"><a href="#Bar1Dv7.__init__-849"><span class="linenos"> 849</span></a>        <span class="n">eye_config</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 0 = all, 1, -1, and 2 are options (2 = binocular)</span>
</span><span id="Bar1Dv7.__init__-850"><a href="#Bar1Dv7.__init__-850"><span class="linenos"> 850</span></a>        <span class="c1"># other</span>
</span><span id="Bar1Dv7.__init__-851"><a href="#Bar1Dv7.__init__-851"><span class="linenos"> 851</span></a>        <span class="n">ignore_saccades</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Bar1Dv7.__init__-852"><a href="#Bar1Dv7.__init__-852"><span class="linenos"> 852</span></a>        <span class="n">include_MUs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Bar1Dv7.__init__-853"><a href="#Bar1Dv7.__init__-853"><span class="linenos"> 853</span></a>        <span class="n">preload</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Bar1Dv7.__init__-854"><a href="#Bar1Dv7.__init__-854"><span class="linenos"> 854</span></a>        <span class="n">eyepos</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="Bar1Dv7.__init__-855"><a href="#Bar1Dv7.__init__-855"><span class="linenos"> 855</span></a>        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
</span><span id="Bar1Dv7.__init__-856"><a href="#Bar1Dv7.__init__-856"><span class="linenos"> 856</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.__init__-857"><a href="#Bar1Dv7.__init__-857"><span class="linenos"> 857</span></a><span class="sd">        Constructor options</span>
</span><span id="Bar1Dv7.__init__-858"><a href="#Bar1Dv7.__init__-858"><span class="linenos"> 858</span></a>
</span><span id="Bar1Dv7.__init__-859"><a href="#Bar1Dv7.__init__-859"><span class="linenos"> 859</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7.__init__-860"><a href="#Bar1Dv7.__init__-860"><span class="linenos"> 860</span></a><span class="sd">            sess_list: list of sessions to load</span>
</span><span id="Bar1Dv7.__init__-861"><a href="#Bar1Dv7.__init__-861"><span class="linenos"> 861</span></a><span class="sd">            datadir: directory where data is stored</span>
</span><span id="Bar1Dv7.__init__-862"><a href="#Bar1Dv7.__init__-862"><span class="linenos"> 862</span></a><span class="sd">            num_lags: number of lags to include in time-embedding</span>
</span><span id="Bar1Dv7.__init__-863"><a href="#Bar1Dv7.__init__-863"><span class="linenos"> 863</span></a><span class="sd">            stim_crop: whether to crop stimulus (not implemented)</span>
</span><span id="Bar1Dv7.__init__-864"><a href="#Bar1Dv7.__init__-864"><span class="linenos"> 864</span></a><span class="sd">            Hstim_shift: how much to shift horizontal stimulus (in bars)</span>
</span><span id="Bar1Dv7.__init__-865"><a href="#Bar1Dv7.__init__-865"><span class="linenos"> 865</span></a><span class="sd">            Hdiscardzero: whether to discard zero position in horizontal stimulus</span>
</span><span id="Bar1Dv7.__init__-866"><a href="#Bar1Dv7.__init__-866"><span class="linenos"> 866</span></a><span class="sd">            time_embed: 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="Bar1Dv7.__init__-867"><a href="#Bar1Dv7.__init__-867"><span class="linenos"> 867</span></a><span class="sd">            folded_lags: whether to fold lags in time-embedding</span>
</span><span id="Bar1Dv7.__init__-868"><a href="#Bar1Dv7.__init__-868"><span class="linenos"> 868</span></a><span class="sd">            combine_stim: whether to combine horizontal and vertical stimulus</span>
</span><span id="Bar1Dv7.__init__-869"><a href="#Bar1Dv7.__init__-869"><span class="linenos"> 869</span></a><span class="sd">            stim_gap: gap between horizontal and vertical stimuli</span>
</span><span id="Bar1Dv7.__init__-870"><a href="#Bar1Dv7.__init__-870"><span class="linenos"> 870</span></a><span class="sd">            drift_interval: how many trials to anchor each drift term</span>
</span><span id="Bar1Dv7.__init__-871"><a href="#Bar1Dv7.__init__-871"><span class="linenos"> 871</span></a><span class="sd">            eye_config: 0 = all, 1, -1, and 2 are options (2 = binocular)</span>
</span><span id="Bar1Dv7.__init__-872"><a href="#Bar1Dv7.__init__-872"><span class="linenos"> 872</span></a><span class="sd">            ignore_saccades: whether to ignore saccades</span>
</span><span id="Bar1Dv7.__init__-873"><a href="#Bar1Dv7.__init__-873"><span class="linenos"> 873</span></a><span class="sd">            include_MUs: whether to include multi-units</span>
</span><span id="Bar1Dv7.__init__-874"><a href="#Bar1Dv7.__init__-874"><span class="linenos"> 874</span></a><span class="sd">            preload: whether to preload data</span>
</span><span id="Bar1Dv7.__init__-875"><a href="#Bar1Dv7.__init__-875"><span class="linenos"> 875</span></a><span class="sd">            eyepos: eye position data</span>
</span><span id="Bar1Dv7.__init__-876"><a href="#Bar1Dv7.__init__-876"><span class="linenos"> 876</span></a><span class="sd">            device: torch device to move data to</span>
</span><span id="Bar1Dv7.__init__-877"><a href="#Bar1Dv7.__init__-877"><span class="linenos"> 877</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.__init__-878"><a href="#Bar1Dv7.__init__-878"><span class="linenos"> 878</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">datadir</span>
</span><span id="Bar1Dv7.__init__-879"><a href="#Bar1Dv7.__init__-879"><span class="linenos"> 879</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sess_list</span> <span class="o">=</span> <span class="n">sess_list</span>
</span><span id="Bar1Dv7.__init__-880"><a href="#Bar1Dv7.__init__-880"><span class="linenos"> 880</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
</span><span id="Bar1Dv7.__init__-881"><a href="#Bar1Dv7.__init__-881"><span class="linenos"> 881</span></a>        
</span><span id="Bar1Dv7.__init__-882"><a href="#Bar1Dv7.__init__-882"><span class="linenos"> 882</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span> <span class="o">=</span> <span class="n">num_lags</span>
</span><span id="Bar1Dv7.__init__-883"><a href="#Bar1Dv7.__init__-883"><span class="linenos"> 883</span></a>        <span class="k">if</span> <span class="n">time_embed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-884"><a href="#Bar1Dv7.__init__-884"><span class="linenos"> 884</span></a>            <span class="k">assert</span> <span class="n">preload</span><span class="p">,</span> <span class="s2">&quot;Cannot pre-time-embed without preloading.&quot;</span>
</span><span id="Bar1Dv7.__init__-885"><a href="#Bar1Dv7.__init__-885"><span class="linenos"> 885</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">=</span> <span class="n">time_embed</span>
</span><span id="Bar1Dv7.__init__-886"><a href="#Bar1Dv7.__init__-886"><span class="linenos"> 886</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preload</span> <span class="o">=</span> <span class="n">preload</span>
</span><span id="Bar1Dv7.__init__-887"><a href="#Bar1Dv7.__init__-887"><span class="linenos"> 887</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="o">=</span> <span class="n">stim_crop</span>
</span><span id="Bar1Dv7.__init__-888"><a href="#Bar1Dv7.__init__-888"><span class="linenos"> 888</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span> <span class="o">=</span> <span class="n">folded_lags</span>
</span><span id="Bar1Dv7.__init__-889"><a href="#Bar1Dv7.__init__-889"><span class="linenos"> 889</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span> <span class="o">=</span> <span class="n">combine_stim</span>
</span><span id="Bar1Dv7.__init__-890"><a href="#Bar1Dv7.__init__-890"><span class="linenos"> 890</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">=</span> <span class="n">eye_config</span>
</span><span id="Bar1Dv7.__init__-891"><a href="#Bar1Dv7.__init__-891"><span class="linenos"> 891</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_gap</span> <span class="o">=</span> <span class="n">stim_gap</span>
</span><span id="Bar1Dv7.__init__-892"><a href="#Bar1Dv7.__init__-892"><span class="linenos"> 892</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimHshift</span> <span class="o">=</span> <span class="n">Hstim_shift</span>
</span><span id="Bar1Dv7.__init__-893"><a href="#Bar1Dv7.__init__-893"><span class="linenos"> 893</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Hdiscardzero</span> <span class="o">=</span> <span class="n">Hdiscardzero</span>
</span><span id="Bar1Dv7.__init__-894"><a href="#Bar1Dv7.__init__-894"><span class="linenos"> 894</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span> <span class="o">=</span> <span class="n">drift_interval</span>
</span><span id="Bar1Dv7.__init__-895"><a href="#Bar1Dv7.__init__-895"><span class="linenos"> 895</span></a>
</span><span id="Bar1Dv7.__init__-896"><a href="#Bar1Dv7.__init__-896"><span class="linenos"> 896</span></a>        <span class="c1"># get hdf5 file handles</span>
</span><span id="Bar1Dv7.__init__-897"><a href="#Bar1Dv7.__init__-897"><span class="linenos"> 897</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">sess</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_list</span><span class="p">]</span>
</span><span id="Bar1Dv7.__init__-898"><a href="#Bar1Dv7.__init__-898"><span class="linenos"> 898</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1Dv7.__init__-899"><a href="#Bar1Dv7.__init__-899"><span class="linenos"> 899</span></a>
</span><span id="Bar1Dv7.__init__-900"><a href="#Bar1Dv7.__init__-900"><span class="linenos"> 900</span></a>        <span class="c1"># Data to just read in and store</span>
</span><span id="Bar1Dv7.__init__-901"><a href="#Bar1Dv7.__init__-901"><span class="linenos"> 901</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ETstim_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ETstim_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-902"><a href="#Bar1Dv7.__init__-902"><span class="linenos"> 902</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;stim_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-903"><a href="#Bar1Dv7.__init__-903"><span class="linenos"> 903</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;fix_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7.__init__-904"><a href="#Bar1Dv7.__init__-904"><span class="linenos"> 904</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probeIDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Robs_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="Bar1Dv7.__init__-905"><a href="#Bar1Dv7.__init__-905"><span class="linenos"> 905</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probeIDsMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;RobsMU_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="Bar1Dv7.__init__-906"><a href="#Bar1Dv7.__init__-906"><span class="linenos"> 906</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dt&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7.__init__-907"><a href="#Bar1Dv7.__init__-907"><span class="linenos"> 907</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;pixel_size&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7.__init__-908"><a href="#Bar1Dv7.__init__-908"><span class="linenos"> 908</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exptdate</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># need to learn matlab strings in HDF5 format (not saved as HDF5 string)</span>
</span><span id="Bar1Dv7.__init__-909"><a href="#Bar1Dv7.__init__-909"><span class="linenos"> 909</span></a>
</span><span id="Bar1Dv7.__init__-910"><a href="#Bar1Dv7.__init__-910"><span class="linenos"> 910</span></a>        <span class="c1"># build index map</span>
</span><span id="Bar1Dv7.__init__-911"><a href="#Bar1Dv7.__init__-911"><span class="linenos"> 911</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_threshold</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># how many valid time points required to include saccade?</span>
</span><span id="Bar1Dv7.__init__-912"><a href="#Bar1Dv7.__init__-912"><span class="linenos"> 912</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_index</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># which file the block corresponds to</span>
</span><span id="Bar1Dv7.__init__-913"><a href="#Bar1Dv7.__init__-913"><span class="linenos"> 913</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7.__init__-914"><a href="#Bar1Dv7.__init__-914"><span class="linenos"> 914</span></a>        <span class="c1">#self.unit_ids = []</span>
</span><span id="Bar1Dv7.__init__-915"><a href="#Bar1Dv7.__init__-915"><span class="linenos"> 915</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_sus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_mus</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="Bar1Dv7.__init__-916"><a href="#Bar1Dv7.__init__-916"><span class="linenos"> 916</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sus</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7.__init__-917"><a href="#Bar1Dv7.__init__-917"><span class="linenos"> 917</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1Dv7.__init__-918"><a href="#Bar1Dv7.__init__-918"><span class="linenos"> 918</span></a>        <span class="c1">#self.stim_dims = None</span>
</span><span id="Bar1Dv7.__init__-919"><a href="#Bar1Dv7.__init__-919"><span class="linenos"> 919</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span> <span class="o">=</span> <span class="n">eyepos</span>
</span><span id="Bar1Dv7.__init__-920"><a href="#Bar1Dv7.__init__-920"><span class="linenos"> 920</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_Xfix</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Bar1Dv7.__init__-921"><a href="#Bar1Dv7.__init__-921"><span class="linenos"> 921</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sess_list</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-922"><a href="#Bar1Dv7.__init__-922"><span class="linenos"> 922</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7.__init__-923"><a href="#Bar1Dv7.__init__-923"><span class="linenos"> 923</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_filemapping</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7.__init__-924"><a href="#Bar1Dv7.__init__-924"><span class="linenos"> 924</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span> <span class="o">=</span> <span class="n">include_MUs</span>
</span><span id="Bar1Dv7.__init__-925"><a href="#Bar1Dv7.__init__-925"><span class="linenos"> 925</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">SUinds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7.__init__-926"><a href="#Bar1Dv7.__init__-926"><span class="linenos"> 926</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">MUinds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7.__init__-927"><a href="#Bar1Dv7.__init__-927"><span class="linenos"> 927</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># can be list to output specific cells in get_item</span>
</span><span id="Bar1Dv7.__init__-928"><a href="#Bar1Dv7.__init__-928"><span class="linenos"> 928</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1Dv7.__init__-929"><a href="#Bar1Dv7.__init__-929"><span class="linenos"> 929</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Bar1Dv7.__init__-930"><a href="#Bar1Dv7.__init__-930"><span class="linenos"> 930</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1Dv7.__init__-931"><a href="#Bar1Dv7.__init__-931"><span class="linenos"> 931</span></a>
</span><span id="Bar1Dv7.__init__-932"><a href="#Bar1Dv7.__init__-932"><span class="linenos"> 932</span></a>        <span class="c1"># Set up to store default train_, val_, test_inds</span>
</span><span id="Bar1Dv7.__init__-933"><a href="#Bar1Dv7.__init__-933"><span class="linenos"> 933</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1Dv7.__init__-934"><a href="#Bar1Dv7.__init__-934"><span class="linenos"> 934</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1Dv7.__init__-935"><a href="#Bar1Dv7.__init__-935"><span class="linenos"> 935</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1Dv7.__init__-936"><a href="#Bar1Dv7.__init__-936"><span class="linenos"> 936</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="Bar1Dv7.__init__-937"><a href="#Bar1Dv7.__init__-937"><span class="linenos"> 937</span></a>
</span><span id="Bar1Dv7.__init__-938"><a href="#Bar1Dv7.__init__-938"><span class="linenos"> 938</span></a>        <span class="c1"># Data to construct and store in memory</span>
</span><span id="Bar1Dv7.__init__-939"><a href="#Bar1Dv7.__init__-939"><span class="linenos"> 939</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7.__init__-940"><a href="#Bar1Dv7.__init__-940"><span class="linenos"> 940</span></a>        <span class="c1">#self.sacc_on = []</span>
</span><span id="Bar1Dv7.__init__-941"><a href="#Bar1Dv7.__init__-941"><span class="linenos"> 941</span></a>        <span class="c1">#self.sacc_off = []</span>
</span><span id="Bar1Dv7.__init__-942"><a href="#Bar1Dv7.__init__-942"><span class="linenos"> 942</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7.__init__-943"><a href="#Bar1Dv7.__init__-943"><span class="linenos"> 943</span></a>
</span><span id="Bar1Dv7.__init__-944"><a href="#Bar1Dv7.__init__-944"><span class="linenos"> 944</span></a>        <span class="n">tcount</span><span class="p">,</span> <span class="n">fix_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="Bar1Dv7.__init__-945"><a href="#Bar1Dv7.__init__-945"><span class="linenos"> 945</span></a>
</span><span id="Bar1Dv7.__init__-946"><a href="#Bar1Dv7.__init__-946"><span class="linenos"> 946</span></a>        <span class="c1">#if which_stim is None:</span>
</span><span id="Bar1Dv7.__init__-947"><a href="#Bar1Dv7.__init__-947"><span class="linenos"> 947</span></a>        <span class="c1">#    stimname = &#39;stimET&#39;</span>
</span><span id="Bar1Dv7.__init__-948"><a href="#Bar1Dv7.__init__-948"><span class="linenos"> 948</span></a>        <span class="c1">#else:</span>
</span><span id="Bar1Dv7.__init__-949"><a href="#Bar1Dv7.__init__-949"><span class="linenos"> 949</span></a>        <span class="c1">#    stimname = which_stim</span>
</span><span id="Bar1Dv7.__init__-950"><a href="#Bar1Dv7.__init__-950"><span class="linenos"> 950</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span> <span class="o">=</span> <span class="s1">&#39;stimET&#39;</span>
</span><span id="Bar1Dv7.__init__-951"><a href="#Bar1Dv7.__init__-951"><span class="linenos"> 951</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ETtraceHR</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7.__init__-952"><a href="#Bar1Dv7.__init__-952"><span class="linenos"> 952</span></a>
</span><span id="Bar1Dv7.__init__-953"><a href="#Bar1Dv7.__init__-953"><span class="linenos"> 953</span></a>        <span class="k">for</span> <span class="n">fnum</span><span class="p">,</span> <span class="n">fhandle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">):</span>
</span><span id="Bar1Dv7.__init__-954"><a href="#Bar1Dv7.__init__-954"><span class="linenos"> 954</span></a>
</span><span id="Bar1Dv7.__init__-955"><a href="#Bar1Dv7.__init__-955"><span class="linenos"> 955</span></a>            <span class="n">NT</span><span class="p">,</span> <span class="n">NSUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="Bar1Dv7.__init__-956"><a href="#Bar1Dv7.__init__-956"><span class="linenos"> 956</span></a>            <span class="n">NX</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Bar1Dv7.__init__-957"><a href="#Bar1Dv7.__init__-957"><span class="linenos"> 957</span></a>            <span class="n">NMUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Bar1Dv7.__init__-958"><a href="#Bar1Dv7.__init__-958"><span class="linenos"> 958</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_sus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NSUfile</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-959"><a href="#Bar1Dv7.__init__-959"><span class="linenos"> 959</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_mus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NMUfile</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-960"><a href="#Bar1Dv7.__init__-960"><span class="linenos"> 960</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sus</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="o">+</span><span class="n">NSUfile</span><span class="p">))</span>
</span><span id="Bar1Dv7.__init__-961"><a href="#Bar1Dv7.__init__-961"><span class="linenos"> 961</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;block_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span id="Bar1Dv7.__init__-962"><a href="#Bar1Dv7.__init__-962"><span class="linenos"> 962</span></a>            <span class="n">stim_eyes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useLeye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span>  \
</span><span id="Bar1Dv7.__init__-963"><a href="#Bar1Dv7.__init__-963"><span class="linenos"> 963</span></a>                            <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-964"><a href="#Bar1Dv7.__init__-964"><span class="linenos"> 964</span></a>            
</span><span id="Bar1Dv7.__init__-965"><a href="#Bar1Dv7.__init__-965"><span class="linenos"> 965</span></a>            <span class="n">Reye</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">]</span>
</span><span id="Bar1Dv7.__init__-966"><a href="#Bar1Dv7.__init__-966"><span class="linenos"> 966</span></a>            <span class="n">NCfile</span> <span class="o">=</span> <span class="n">NSUfile</span>
</span><span id="Bar1Dv7.__init__-967"><a href="#Bar1Dv7.__init__-967"><span class="linenos"> 967</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-968"><a href="#Bar1Dv7.__init__-968"><span class="linenos"> 968</span></a>                <span class="n">NCfile</span> <span class="o">+=</span> <span class="n">NMUfile</span>
</span><span id="Bar1Dv7.__init__-969"><a href="#Bar1Dv7.__init__-969"><span class="linenos"> 969</span></a>            
</span><span id="Bar1Dv7.__init__-970"><a href="#Bar1Dv7.__init__-970"><span class="linenos"> 970</span></a>            <span class="c1"># This will associate each block with each file</span>
</span><span id="Bar1Dv7.__init__-971"><a href="#Bar1Dv7.__init__-971"><span class="linenos"> 971</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_filemapping</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="n">fnum</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-972"><a href="#Bar1Dv7.__init__-972"><span class="linenos"> 972</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span><span class="p">[</span><span class="n">fnum</span><span class="p">]</span><span class="o">=</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7.__init__-973"><a href="#Bar1Dv7.__init__-973"><span class="linenos"> 973</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span><span class="p">[</span><span class="n">fnum</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1Dv7.__init__-974"><a href="#Bar1Dv7.__init__-974"><span class="linenos"> 974</span></a>            <span class="c1">#if self.stim_dims is None:</span>
</span><span id="Bar1Dv7.__init__-975"><a href="#Bar1Dv7.__init__-975"><span class="linenos"> 975</span></a>            <span class="c1">#if folded_lags:</span>
</span><span id="Bar1Dv7.__init__-976"><a href="#Bar1Dv7.__init__-976"><span class="linenos"> 976</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">([</span><span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="c1">#list(fhandle[stimname].shape[1:4]) + [1]</span>
</span><span id="Bar1Dv7.__init__-977"><a href="#Bar1Dv7.__init__-977"><span class="linenos"> 977</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Bar1Dv7.__init__-978"><a href="#Bar1Dv7.__init__-978"><span class="linenos"> 978</span></a>          
</span><span id="Bar1Dv7.__init__-979"><a href="#Bar1Dv7.__init__-979"><span class="linenos"> 979</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-980"><a href="#Bar1Dv7.__init__-980"><span class="linenos"> 980</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="Bar1Dv7.__init__-981"><a href="#Bar1Dv7.__init__-981"><span class="linenos"> 981</span></a>
</span><span id="Bar1Dv7.__init__-982"><a href="#Bar1Dv7.__init__-982"><span class="linenos"> 982</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stim check:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">,</span> <span class="n">folded_lags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-983"><a href="#Bar1Dv7.__init__-983"><span class="linenos"> 983</span></a>
</span><span id="Bar1Dv7.__init__-984"><a href="#Bar1Dv7.__init__-984"><span class="linenos"> 984</span></a>            <span class="c1">#self.unit_ids.append(self.NC + np.asarray(range(NCfile)))</span>
</span><span id="Bar1Dv7.__init__-985"><a href="#Bar1Dv7.__init__-985"><span class="linenos"> 985</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NCfile</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-986"><a href="#Bar1Dv7.__init__-986"><span class="linenos"> 986</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">+=</span> <span class="n">NCfile</span>
</span><span id="Bar1Dv7.__init__-987"><a href="#Bar1Dv7.__init__-987"><span class="linenos"> 987</span></a>
</span><span id="Bar1Dv7.__init__-988"><a href="#Bar1Dv7.__init__-988"><span class="linenos"> 988</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;sacc_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-989"><a href="#Bar1Dv7.__init__-989"><span class="linenos"> 989</span></a>            <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>  <span class="c1"># each time point labels fixation number</span>
</span><span id="Bar1Dv7.__init__-990"><a href="#Bar1Dv7.__init__-990"><span class="linenos"> 990</span></a>            <span class="c1">#sacc_on = np.zeros(NT, dtype=np.float32)  # each time point labels fixation number</span>
</span><span id="Bar1Dv7.__init__-991"><a href="#Bar1Dv7.__init__-991"><span class="linenos"> 991</span></a>            <span class="c1">#sacc_on[sacc_inds[:,0]-1] = 1.0</span>
</span><span id="Bar1Dv7.__init__-992"><a href="#Bar1Dv7.__init__-992"><span class="linenos"> 992</span></a>            <span class="c1">#sacc_off = np.zeros(NT, dtype=np.float32)  # each time point labels fixation number</span>
</span><span id="Bar1Dv7.__init__-993"><a href="#Bar1Dv7.__init__-993"><span class="linenos"> 993</span></a>            <span class="c1">#sacc_off[sacc_inds[:,1]-1] = 1.0</span>
</span><span id="Bar1Dv7.__init__-994"><a href="#Bar1Dv7.__init__-994"><span class="linenos"> 994</span></a>
</span><span id="Bar1Dv7.__init__-995"><a href="#Bar1Dv7.__init__-995"><span class="linenos"> 995</span></a>            <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;valid_data&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="mi">1</span>  <span class="c1">#range(self.NT)  # default -- to be changed at end of init</span>
</span><span id="Bar1Dv7.__init__-996"><a href="#Bar1Dv7.__init__-996"><span class="linenos"> 996</span></a>
</span><span id="Bar1Dv7.__init__-997"><a href="#Bar1Dv7.__init__-997"><span class="linenos"> 997</span></a>            <span class="c1">### Process blocks and fixations/saccades</span>
</span><span id="Bar1Dv7.__init__-998"><a href="#Bar1Dv7.__init__-998"><span class="linenos"> 998</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="Bar1Dv7.__init__-999"><a href="#Bar1Dv7.__init__-999"><span class="linenos"> 999</span></a>                <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="Bar1Dv7.__init__-1000"><a href="#Bar1Dv7.__init__-1000"><span class="linenos">1000</span></a>                <span class="n">include_block</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Bar1Dv7.__init__-1001"><a href="#Bar1Dv7.__init__-1001"><span class="linenos">1001</span></a>                <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1002"><a href="#Bar1Dv7.__init__-1002"><span class="linenos">1002</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-1003"><a href="#Bar1Dv7.__init__-1003"><span class="linenos">1003</span></a>                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">stim_eyes</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-1004"><a href="#Bar1Dv7.__init__-1004"><span class="linenos">1004</span></a>                        <span class="n">include_block</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Bar1Dv7.__init__-1005"><a href="#Bar1Dv7.__init__-1005"><span class="linenos">1005</span></a>                <span class="k">if</span> <span class="n">include_block</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-1006"><a href="#Bar1Dv7.__init__-1006"><span class="linenos">1006</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
</span><span id="Bar1Dv7.__init__-1007"><a href="#Bar1Dv7.__init__-1007"><span class="linenos">1007</span></a>                    <span class="c1">#self.block_inds.append( np.arange( blk_inds[ii,0], blk_inds[ii,1], dtype=np.int64) )</span>
</span><span id="Bar1Dv7.__init__-1008"><a href="#Bar1Dv7.__init__-1008"><span class="linenos">1008</span></a>
</span><span id="Bar1Dv7.__init__-1009"><a href="#Bar1Dv7.__init__-1009"><span class="linenos">1009</span></a>            <span class="c1"># Got through each block to segment into fixations</span>
</span><span id="Bar1Dv7.__init__-1010"><a href="#Bar1Dv7.__init__-1010"><span class="linenos">1010</span></a>            <span class="c1">#for nn in range(blk_inds.shape[0]):</span>
</span><span id="Bar1Dv7.__init__-1011"><a href="#Bar1Dv7.__init__-1011"><span class="linenos">1011</span></a>            <span class="c1">#    # note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="Bar1Dv7.__init__-1012"><a href="#Bar1Dv7.__init__-1012"><span class="linenos">1012</span></a>            <span class="c1">#    include_block = True</span>
</span><span id="Bar1Dv7.__init__-1013"><a href="#Bar1Dv7.__init__-1013"><span class="linenos">1013</span></a>            <span class="c1">#    ts = np.arange( blk_inds[nn,0]-1, blk_inds[nn,1], dtype=int)</span>
</span><span id="Bar1Dv7.__init__-1014"><a href="#Bar1Dv7.__init__-1014"><span class="linenos">1014</span></a>            <span class="c1">#    if self.eye_config &gt; 0:</span>
</span><span id="Bar1Dv7.__init__-1015"><a href="#Bar1Dv7.__init__-1015"><span class="linenos">1015</span></a>            <span class="c1">#        if np.sum(stim_eyes[ts] == self.eye_config) == 0:</span>
</span><span id="Bar1Dv7.__init__-1016"><a href="#Bar1Dv7.__init__-1016"><span class="linenos">1016</span></a>            <span class="c1">#            include_block = False</span>
</span><span id="Bar1Dv7.__init__-1017"><a href="#Bar1Dv7.__init__-1017"><span class="linenos">1017</span></a>            <span class="c1">#    if include_block:</span>
</span><span id="Bar1Dv7.__init__-1018"><a href="#Bar1Dv7.__init__-1018"><span class="linenos">1018</span></a>            <span class="c1">#        self.block_inds.append(deepcopy(ts))</span>
</span><span id="Bar1Dv7.__init__-1019"><a href="#Bar1Dv7.__init__-1019"><span class="linenos">1019</span></a>            <span class="c1">#        t0 = blk_inds[nn, 0]-1</span>
</span><span id="Bar1Dv7.__init__-1020"><a href="#Bar1Dv7.__init__-1020"><span class="linenos">1020</span></a>                    <span class="c1">#valid_inds[range(t0, t0+num_lags)] = 0  # this already adjusted for?</span>
</span><span id="Bar1Dv7.__init__-1021"><a href="#Bar1Dv7.__init__-1021"><span class="linenos">1021</span></a>
</span><span id="Bar1Dv7.__init__-1022"><a href="#Bar1Dv7.__init__-1022"><span class="linenos">1022</span></a>                    <span class="c1"># Parse fixation numbers within block</span>
</span><span id="Bar1Dv7.__init__-1023"><a href="#Bar1Dv7.__init__-1023"><span class="linenos">1023</span></a>            <span class="c1">#        if not ignore_saccades:</span>
</span><span id="Bar1Dv7.__init__-1024"><a href="#Bar1Dv7.__init__-1024"><span class="linenos">1024</span></a>            <span class="c1">#            rel_saccs = np.where((sacc_inds[:,0] &gt; t0) &amp; (sacc_inds[:,0] &lt; blk_inds[nn,1]))[0]</span>
</span><span id="Bar1Dv7.__init__-1025"><a href="#Bar1Dv7.__init__-1025"><span class="linenos">1025</span></a>            <span class="c1">#            for mm in range(len(rel_saccs)):</span>
</span><span id="Bar1Dv7.__init__-1026"><a href="#Bar1Dv7.__init__-1026"><span class="linenos">1026</span></a>            <span class="c1">#                fix_count += 1</span>
</span><span id="Bar1Dv7.__init__-1027"><a href="#Bar1Dv7.__init__-1027"><span class="linenos">1027</span></a>            <span class="c1">#                fix_n[ range(t0, sacc_inds[rel_saccs[mm], 0]) ] = fix_count</span>
</span><span id="Bar1Dv7.__init__-1028"><a href="#Bar1Dv7.__init__-1028"><span class="linenos">1028</span></a>            <span class="c1">#                t0 = sacc_inds[rel_saccs[mm], 1]-1</span>
</span><span id="Bar1Dv7.__init__-1029"><a href="#Bar1Dv7.__init__-1029"><span class="linenos">1029</span></a>                    <span class="c1"># Put in last (or only) fixation number</span>
</span><span id="Bar1Dv7.__init__-1030"><a href="#Bar1Dv7.__init__-1030"><span class="linenos">1030</span></a>            <span class="c1">#        if t0 &lt; blk_inds[nn, 1]:</span>
</span><span id="Bar1Dv7.__init__-1031"><a href="#Bar1Dv7.__init__-1031"><span class="linenos">1031</span></a>            <span class="c1">#            fix_count += 1</span>
</span><span id="Bar1Dv7.__init__-1032"><a href="#Bar1Dv7.__init__-1032"><span class="linenos">1032</span></a>            <span class="c1">#            fix_n[ range(t0, blk_inds[nn, 1]) ] = fix_count</span>
</span><span id="Bar1Dv7.__init__-1033"><a href="#Bar1Dv7.__init__-1033"><span class="linenos">1033</span></a>            
</span><span id="Bar1Dv7.__init__-1034"><a href="#Bar1Dv7.__init__-1034"><span class="linenos">1034</span></a>            <span class="n">tcount</span> <span class="o">+=</span> <span class="n">NT</span>
</span><span id="Bar1Dv7.__init__-1035"><a href="#Bar1Dv7.__init__-1035"><span class="linenos">1035</span></a>            <span class="c1"># make larger fix_n, valid_inds, sacc_inds, block_inds as self</span>
</span><span id="Bar1Dv7.__init__-1036"><a href="#Bar1Dv7.__init__-1036"><span class="linenos">1036</span></a>
</span><span id="Bar1Dv7.__init__-1037"><a href="#Bar1Dv7.__init__-1037"><span class="linenos">1037</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>  <span class="o">=</span> <span class="n">tcount</span>
</span><span id="Bar1Dv7.__init__-1038"><a href="#Bar1Dv7.__init__-1038"><span class="linenos">1038</span></a>
</span><span id="Bar1Dv7.__init__-1039"><a href="#Bar1Dv7.__init__-1039"><span class="linenos">1039</span></a>        <span class="c1"># For now let&#39;s just debug with one file</span>
</span><span id="Bar1Dv7.__init__-1040"><a href="#Bar1Dv7.__init__-1040"><span class="linenos">1040</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sess_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-1041"><a href="#Bar1Dv7.__init__-1041"><span class="linenos">1041</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: currently ignoring multiple files&#39;</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1042"><a href="#Bar1Dv7.__init__-1042"><span class="linenos">1042</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">valid_inds</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1043"><a href="#Bar1Dv7.__init__-1043"><span class="linenos">1043</span></a>        <span class="c1">#self.fix_n = deepcopy(fix_n)</span>
</span><span id="Bar1Dv7.__init__-1044"><a href="#Bar1Dv7.__init__-1044"><span class="linenos">1044</span></a>        <span class="c1">#self.sac_on = deepcopy(sacc_on)</span>
</span><span id="Bar1Dv7.__init__-1045"><a href="#Bar1Dv7.__init__-1045"><span class="linenos">1045</span></a>        <span class="c1">#self.sac_off = deepcopy(sacc_off)</span>
</span><span id="Bar1Dv7.__init__-1046"><a href="#Bar1Dv7.__init__-1046"><span class="linenos">1046</span></a>        <span class="c1">#self.sacc_inds = deepcopy(sacc_inds)</span>
</span><span id="Bar1Dv7.__init__-1047"><a href="#Bar1Dv7.__init__-1047"><span class="linenos">1047</span></a>        
</span><span id="Bar1Dv7.__init__-1048"><a href="#Bar1Dv7.__init__-1048"><span class="linenos">1048</span></a>        <span class="c1"># PULL OTHER INFO</span>
</span><span id="Bar1Dv7.__init__-1049"><a href="#Bar1Dv7.__init__-1049"><span class="linenos">1049</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ETtraceHR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;ETtrace_raw&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1050"><a href="#Bar1Dv7.__init__-1050"><span class="linenos">1050</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sort_rating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs_rating&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="Bar1Dv7.__init__-1051"><a href="#Bar1Dv7.__init__-1051"><span class="linenos">1051</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sort_ratingMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU_rating&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span>
</span><span id="Bar1Dv7.__init__-1052"><a href="#Bar1Dv7.__init__-1052"><span class="linenos">1052</span></a>
</span><span id="Bar1Dv7.__init__-1053"><a href="#Bar1Dv7.__init__-1053"><span class="linenos">1053</span></a>        <span class="c1"># Go through saccades to establish val_indices and produce saccade timing vector </span>
</span><span id="Bar1Dv7.__init__-1054"><a href="#Bar1Dv7.__init__-1054"><span class="linenos">1054</span></a>        <span class="c1"># Note that sacc_ts will be generated even without preload -- small enough that doesnt matter</span>
</span><span id="Bar1Dv7.__init__-1055"><a href="#Bar1Dv7.__init__-1055"><span class="linenos">1055</span></a>    <span class="c1">#    self.sacc_ts = np.zeros([self.NT, 1], dtype=np.float32)</span>
</span><span id="Bar1Dv7.__init__-1056"><a href="#Bar1Dv7.__init__-1056"><span class="linenos">1056</span></a>    <span class="c1">#    self.fix_n = np.zeros(self.NT, dtype=np.int64)  # label of which fixation is in each range</span>
</span><span id="Bar1Dv7.__init__-1057"><a href="#Bar1Dv7.__init__-1057"><span class="linenos">1057</span></a>    <span class="c1">#    for nn in range(self.num_fixations):</span>
</span><span id="Bar1Dv7.__init__-1058"><a href="#Bar1Dv7.__init__-1058"><span class="linenos">1058</span></a>    <span class="c1">#        print(nn, self.sacc_inds[nn][0], self.sacc_inds[nn][1] )</span>
</span><span id="Bar1Dv7.__init__-1059"><a href="#Bar1Dv7.__init__-1059"><span class="linenos">1059</span></a>    <span class="c1">#        self.sacc_ts[self.sacc_inds[nn][0]] = 1 </span>
</span><span id="Bar1Dv7.__init__-1060"><a href="#Bar1Dv7.__init__-1060"><span class="linenos">1060</span></a>    <span class="c1">#        self.fix_n[range(self.sacc_inds[nn][0], self.sacc_inds[nn][1])] = nn</span>
</span><span id="Bar1Dv7.__init__-1061"><a href="#Bar1Dv7.__init__-1061"><span class="linenos">1061</span></a>        <span class="c1">#self.fix_n = list(self.fix_n)  # better list than numpy</span>
</span><span id="Bar1Dv7.__init__-1062"><a href="#Bar1Dv7.__init__-1062"><span class="linenos">1062</span></a>
</span><span id="Bar1Dv7.__init__-1063"><a href="#Bar1Dv7.__init__-1063"><span class="linenos">1063</span></a>        <span class="c1">#self.dims = np.unique(np.asarray(self.dims)) # assumes they&#39;re all the same    </span>
</span><span id="Bar1Dv7.__init__-1064"><a href="#Bar1Dv7.__init__-1064"><span class="linenos">1064</span></a>        <span class="c1">#if self.eyepos is not None:</span>
</span><span id="Bar1Dv7.__init__-1065"><a href="#Bar1Dv7.__init__-1065"><span class="linenos">1065</span></a>            <span class="c1">#assert len(self.eyepos) == self.num_fixations, \</span>
</span><span id="Bar1Dv7.__init__-1066"><a href="#Bar1Dv7.__init__-1066"><span class="linenos">1066</span></a>            <span class="c1">#    &quot;eyepos input should have %d fixations.&quot;%self.num_fixations</span>
</span><span id="Bar1Dv7.__init__-1067"><a href="#Bar1Dv7.__init__-1067"><span class="linenos">1067</span></a>
</span><span id="Bar1Dv7.__init__-1068"><a href="#Bar1Dv7.__init__-1068"><span class="linenos">1068</span></a>        <span class="k">if</span> <span class="n">preload</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-1069"><a href="#Bar1Dv7.__init__-1069"><span class="linenos">1069</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data into memory...&quot;</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1070"><a href="#Bar1Dv7.__init__-1070"><span class="linenos">1070</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">preload_numpy</span><span class="p">()</span>
</span><span id="Bar1Dv7.__init__-1071"><a href="#Bar1Dv7.__init__-1071"><span class="linenos">1071</span></a>
</span><span id="Bar1Dv7.__init__-1072"><a href="#Bar1Dv7.__init__-1072"><span class="linenos">1072</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-1073"><a href="#Bar1Dv7.__init__-1073"><span class="linenos">1073</span></a>                <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;eye pos wrong shape&quot;</span>
</span><span id="Bar1Dv7.__init__-1074"><a href="#Bar1Dv7.__init__-1074"><span class="linenos">1074</span></a>                <span class="c1"># Apply horizontal shifts to stim (stil in numpy)</span>
</span><span id="Bar1Dv7.__init__-1075"><a href="#Bar1Dv7.__init__-1075"><span class="linenos">1075</span></a>                <span class="n">Hshifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">eyepos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Bar1Dv7.__init__-1076"><a href="#Bar1Dv7.__init__-1076"><span class="linenos">1076</span></a>
</span><span id="Bar1Dv7.__init__-1077"><a href="#Bar1Dv7.__init__-1077"><span class="linenos">1077</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1078"><a href="#Bar1Dv7.__init__-1078"><span class="linenos">1078</span></a>                <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Hshifts</span><span class="p">)):</span>
</span><span id="Bar1Dv7.__init__-1079"><a href="#Bar1Dv7.__init__-1079"><span class="linenos">1079</span></a>                    <span class="n">sh</span> <span class="o">=</span> <span class="n">Hshifts</span><span class="p">[</span><span class="n">ss</span><span class="p">]</span>
</span><span id="Bar1Dv7.__init__-1080"><a href="#Bar1Dv7.__init__-1080"><span class="linenos">1080</span></a>                    <span class="n">Lc</span> <span class="o">=</span> <span class="n">NX</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1081"><a href="#Bar1Dv7.__init__-1081"><span class="linenos">1081</span></a>                    <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">eyepos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">sh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7.__init__-1082"><a href="#Bar1Dv7.__init__-1082"><span class="linenos">1082</span></a>                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">])</span>
</span><span id="Bar1Dv7.__init__-1083"><a href="#Bar1Dv7.__init__-1083"><span class="linenos">1083</span></a>                    <span class="k">if</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-1084"><a href="#Bar1Dv7.__init__-1084"><span class="linenos">1084</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="p">:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="Bar1Dv7.__init__-1085"><a href="#Bar1Dv7.__init__-1085"><span class="linenos">1085</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">ts</span><span class="p">,:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh</span><span class="p">))])</span>
</span><span id="Bar1Dv7.__init__-1086"><a href="#Bar1Dv7.__init__-1086"><span class="linenos">1086</span></a>                    <span class="k">elif</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-1087"><a href="#Bar1Dv7.__init__-1087"><span class="linenos">1087</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">ts</span><span class="p">,:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)])</span>
</span><span id="Bar1Dv7.__init__-1088"><a href="#Bar1Dv7.__init__-1088"><span class="linenos">1088</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">ts</span><span class="p">,:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="Bar1Dv7.__init__-1089"><a href="#Bar1Dv7.__init__-1089"><span class="linenos">1089</span></a>                    <span class="k">if</span> <span class="n">sh</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-1090"><a href="#Bar1Dv7.__init__-1090"><span class="linenos">1090</span></a>                        <span class="n">newstim</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1091"><a href="#Bar1Dv7.__init__-1091"><span class="linenos">1091</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">newstim</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1092"><a href="#Bar1Dv7.__init__-1092"><span class="linenos">1092</span></a>
</span><span id="Bar1Dv7.__init__-1093"><a href="#Bar1Dv7.__init__-1093"><span class="linenos">1093</span></a>                <span class="c1"># Apply horizontal shifts to stim (stil in numpy)</span>
</span><span id="Bar1Dv7.__init__-1094"><a href="#Bar1Dv7.__init__-1094"><span class="linenos">1094</span></a>                <span class="n">Vshifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">eyepos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Bar1Dv7.__init__-1095"><a href="#Bar1Dv7.__init__-1095"><span class="linenos">1095</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1096"><a href="#Bar1Dv7.__init__-1096"><span class="linenos">1096</span></a>                <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Vshifts</span><span class="p">)):</span>
</span><span id="Bar1Dv7.__init__-1097"><a href="#Bar1Dv7.__init__-1097"><span class="linenos">1097</span></a>                    <span class="n">sh</span> <span class="o">=</span> <span class="n">Vshifts</span><span class="p">[</span><span class="n">ss</span><span class="p">]</span>
</span><span id="Bar1Dv7.__init__-1098"><a href="#Bar1Dv7.__init__-1098"><span class="linenos">1098</span></a>                    <span class="n">Lc</span> <span class="o">=</span> <span class="n">NX</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1099"><a href="#Bar1Dv7.__init__-1099"><span class="linenos">1099</span></a>                    <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">eyepos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">sh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7.__init__-1100"><a href="#Bar1Dv7.__init__-1100"><span class="linenos">1100</span></a>                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">])</span>
</span><span id="Bar1Dv7.__init__-1101"><a href="#Bar1Dv7.__init__-1101"><span class="linenos">1101</span></a>                    <span class="k">if</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-1102"><a href="#Bar1Dv7.__init__-1102"><span class="linenos">1102</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="p">:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="Bar1Dv7.__init__-1103"><a href="#Bar1Dv7.__init__-1103"><span class="linenos">1103</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">ts</span><span class="p">,:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh</span><span class="p">))])</span>
</span><span id="Bar1Dv7.__init__-1104"><a href="#Bar1Dv7.__init__-1104"><span class="linenos">1104</span></a>                    <span class="k">elif</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-1105"><a href="#Bar1Dv7.__init__-1105"><span class="linenos">1105</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">ts</span><span class="p">,:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)])</span>
</span><span id="Bar1Dv7.__init__-1106"><a href="#Bar1Dv7.__init__-1106"><span class="linenos">1106</span></a>                        <span class="n">tmp</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">ts</span><span class="p">,:][:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="Bar1Dv7.__init__-1107"><a href="#Bar1Dv7.__init__-1107"><span class="linenos">1107</span></a>                    <span class="k">if</span> <span class="n">sh</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-1108"><a href="#Bar1Dv7.__init__-1108"><span class="linenos">1108</span></a>                        <span class="n">newstim</span><span class="p">[</span><span class="n">ts</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">tmp</span>
</span><span id="Bar1Dv7.__init__-1109"><a href="#Bar1Dv7.__init__-1109"><span class="linenos">1109</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">newstim</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1110"><a href="#Bar1Dv7.__init__-1110"><span class="linenos">1110</span></a>    
</span><span id="Bar1Dv7.__init__-1111"><a href="#Bar1Dv7.__init__-1111"><span class="linenos">1111</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-1112"><a href="#Bar1Dv7.__init__-1112"><span class="linenos">1112</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;stimulus cropping not implemented yet&#39;</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1113"><a href="#Bar1Dv7.__init__-1113"><span class="linenos">1113</span></a>
</span><span id="Bar1Dv7.__init__-1114"><a href="#Bar1Dv7.__init__-1114"><span class="linenos">1114</span></a>            <span class="k">if</span> <span class="n">time_embed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-1115"><a href="#Bar1Dv7.__init__-1115"><span class="linenos">1115</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time embedding...&quot;</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1116"><a href="#Bar1Dv7.__init__-1116"><span class="linenos">1116</span></a>                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1117"><a href="#Bar1Dv7.__init__-1117"><span class="linenos">1117</span></a>                <span class="n">tmp_stimH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="Bar1Dv7.__init__-1118"><a href="#Bar1Dv7.__init__-1118"><span class="linenos">1118</span></a>                <span class="n">tmp_stimV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="Bar1Dv7.__init__-1119"><a href="#Bar1Dv7.__init__-1119"><span class="linenos">1119</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-1120"><a href="#Bar1Dv7.__init__-1120"><span class="linenos">1120</span></a>                    <span class="n">tmp_stimC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="Bar1Dv7.__init__-1121"><a href="#Bar1Dv7.__init__-1121"><span class="linenos">1121</span></a>
</span><span id="Bar1Dv7.__init__-1122"><a href="#Bar1Dv7.__init__-1122"><span class="linenos">1122</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-1123"><a href="#Bar1Dv7.__init__-1123"><span class="linenos">1123</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">tmp_stimH</span>
</span><span id="Bar1Dv7.__init__-1124"><a href="#Bar1Dv7.__init__-1124"><span class="linenos">1124</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">tmp_stimV</span>
</span><span id="Bar1Dv7.__init__-1125"><a href="#Bar1Dv7.__init__-1125"><span class="linenos">1125</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-1126"><a href="#Bar1Dv7.__init__-1126"><span class="linenos">1126</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="n">tmp_stimC</span> 
</span><span id="Bar1Dv7.__init__-1127"><a href="#Bar1Dv7.__init__-1127"><span class="linenos">1127</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Folded lags: stim-dim = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1128"><a href="#Bar1Dv7.__init__-1128"><span class="linenos">1128</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-1129"><a href="#Bar1Dv7.__init__-1129"><span class="linenos">1129</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimH</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1130"><a href="#Bar1Dv7.__init__-1130"><span class="linenos">1130</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimV</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1131"><a href="#Bar1Dv7.__init__-1131"><span class="linenos">1131</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-1132"><a href="#Bar1Dv7.__init__-1132"><span class="linenos">1132</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimC</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1133"><a href="#Bar1Dv7.__init__-1133"><span class="linenos">1133</span></a>
</span><span id="Bar1Dv7.__init__-1134"><a href="#Bar1Dv7.__init__-1134"><span class="linenos">1134</span></a>            <span class="c1"># Flatten stim </span>
</span><span id="Bar1Dv7.__init__-1135"><a href="#Bar1Dv7.__init__-1135"><span class="linenos">1135</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Bar1Dv7.__init__-1136"><a href="#Bar1Dv7.__init__-1136"><span class="linenos">1136</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Bar1Dv7.__init__-1137"><a href="#Bar1Dv7.__init__-1137"><span class="linenos">1137</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-1138"><a href="#Bar1Dv7.__init__-1138"><span class="linenos">1138</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Bar1Dv7.__init__-1139"><a href="#Bar1Dv7.__init__-1139"><span class="linenos">1139</span></a>
</span><span id="Bar1Dv7.__init__-1140"><a href="#Bar1Dv7.__init__-1140"><span class="linenos">1140</span></a>            <span class="c1"># Have data_filters represend used_inds (in case it gets through)</span>
</span><span id="Bar1Dv7.__init__-1141"><a href="#Bar1Dv7.__init__-1141"><span class="linenos">1141</span></a>            <span class="n">unified_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1142"><a href="#Bar1Dv7.__init__-1142"><span class="linenos">1142</span></a>            <span class="n">unified_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="Bar1Dv7.__init__-1143"><a href="#Bar1Dv7.__init__-1143"><span class="linenos">1143</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*=</span> <span class="n">unified_df</span>
</span><span id="Bar1Dv7.__init__-1144"><a href="#Bar1Dv7.__init__-1144"><span class="linenos">1144</span></a>
</span><span id="Bar1Dv7.__init__-1145"><a href="#Bar1Dv7.__init__-1145"><span class="linenos">1145</span></a>            <span class="c1"># Prepare design matrix for drift (on trial-by-trial basis)</span>
</span><span id="Bar1Dv7.__init__-1146"><a href="#Bar1Dv7.__init__-1146"><span class="linenos">1146</span></a>            <span class="c1">#self.Xdrift = np.zeros([self.NT, len(self.block_inds)//], dtype=np.float32)</span>
</span><span id="Bar1Dv7.__init__-1147"><a href="#Bar1Dv7.__init__-1147"><span class="linenos">1147</span></a>            <span class="c1">#for nn in range(len(self.block_inds)):</span>
</span><span id="Bar1Dv7.__init__-1148"><a href="#Bar1Dv7.__init__-1148"><span class="linenos">1148</span></a>            <span class="c1">#    self.Xdrift[self.block_inds[nn], nn] = 1.0</span>
</span><span id="Bar1Dv7.__init__-1149"><a href="#Bar1Dv7.__init__-1149"><span class="linenos">1149</span></a>            <span class="n">NBL</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1150"><a href="#Bar1Dv7.__init__-1150"><span class="linenos">1150</span></a>            <span class="n">Nanchors</span> <span class="o">=</span> <span class="n">NBL</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span>
</span><span id="Bar1Dv7.__init__-1151"><a href="#Bar1Dv7.__init__-1151"><span class="linenos">1151</span></a>            <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1152"><a href="#Bar1Dv7.__init__-1152"><span class="linenos">1152</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">):</span>
</span><span id="Bar1Dv7.__init__-1153"><a href="#Bar1Dv7.__init__-1153"><span class="linenos">1153</span></a>                <span class="n">anchors</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span><span class="o">*</span><span class="n">bb</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7.__init__-1154"><a href="#Bar1Dv7.__init__-1154"><span class="linenos">1154</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1155"><a href="#Bar1Dv7.__init__-1155"><span class="linenos">1155</span></a>
</span><span id="Bar1Dv7.__init__-1156"><a href="#Bar1Dv7.__init__-1156"><span class="linenos">1156</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">process_fixations</span><span class="p">()</span>
</span><span id="Bar1Dv7.__init__-1157"><a href="#Bar1Dv7.__init__-1157"><span class="linenos">1157</span></a>
</span><span id="Bar1Dv7.__init__-1158"><a href="#Bar1Dv7.__init__-1158"><span class="linenos">1158</span></a>            <span class="c1"># Convert data to tensors</span>
</span><span id="Bar1Dv7.__init__-1159"><a href="#Bar1Dv7.__init__-1159"><span class="linenos">1159</span></a>            <span class="c1">#if self.device is not None:</span>
</span><span id="Bar1Dv7.__init__-1160"><a href="#Bar1Dv7.__init__-1160"><span class="linenos">1160</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1161"><a href="#Bar1Dv7.__init__-1161"><span class="linenos">1161</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>
</span><span id="Bar1Dv7.__init__-1162"><a href="#Bar1Dv7.__init__-1162"><span class="linenos">1162</span></a>
</span><span id="Bar1Dv7.__init__-1163"><a href="#Bar1Dv7.__init__-1163"><span class="linenos">1163</span></a>        <span class="c1"># Create valid indices and first pass of cross-validation indices</span>
</span><span id="Bar1Dv7.__init__-1164"><a href="#Bar1Dv7.__init__-1164"><span class="linenos">1164</span></a>        <span class="c1">#self.create_valid_indices()</span>
</span><span id="Bar1Dv7.__init__-1165"><a href="#Bar1Dv7.__init__-1165"><span class="linenos">1165</span></a>        <span class="c1"># Develop default train, validation, and test datasets </span>
</span><span id="Bar1Dv7.__init__-1166"><a href="#Bar1Dv7.__init__-1166"><span class="linenos">1166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crossval_setup</span><span class="p">()</span>
</span><span id="Bar1Dv7.__init__-1167"><a href="#Bar1Dv7.__init__-1167"><span class="linenos">1167</span></a>
</span><span id="Bar1Dv7.__init__-1168"><a href="#Bar1Dv7.__init__-1168"><span class="linenos">1168</span></a>        <span class="c1"># Fix Xdrift to remove test and validation sets</span>
</span><span id="Bar1Dv7.__init__-1169"><a href="#Bar1Dv7.__init__-1169"><span class="linenos">1169</span></a>        <span class="c1">#self.adjust_Xdrift_xval()</span>
</span><span id="Bar1Dv7.__init__-1170"><a href="#Bar1Dv7.__init__-1170"><span class="linenos">1170</span></a>
</span><span id="Bar1Dv7.__init__-1171"><a href="#Bar1Dv7.__init__-1171"><span class="linenos">1171</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="Bar1Dv7.__init__-1172"><a href="#Bar1Dv7.__init__-1172"><span class="linenos">1172</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">stim_gap</span>
</span><span id="Bar1Dv7.__init__-1173"><a href="#Bar1Dv7.__init__-1173"><span class="linenos">1173</span></a>
</span><span id="Bar1Dv7.__init__-1174"><a href="#Bar1Dv7.__init__-1174"><span class="linenos">1174</span></a>        <span class="c1"># Reflects block structure</span>
</span><span id="Bar1Dv7.__init__-1175"><a href="#Bar1Dv7.__init__-1175"><span class="linenos">1175</span></a>        <span class="c1">#vblks, trblks = self.fold_sample(len(self.block_inds), 5, random_gen=True)</span>
</span><span id="Bar1Dv7.__init__-1176"><a href="#Bar1Dv7.__init__-1176"><span class="linenos">1176</span></a>        <span class="c1">#self.train_inds = []</span>
</span><span id="Bar1Dv7.__init__-1177"><a href="#Bar1Dv7.__init__-1177"><span class="linenos">1177</span></a>        <span class="c1">#for nn in trblks:</span>
</span><span id="Bar1Dv7.__init__-1178"><a href="#Bar1Dv7.__init__-1178"><span class="linenos">1178</span></a>        <span class="c1">#    self.train_inds += list(deepcopy(self.block_inds[nn]))</span>
</span><span id="Bar1Dv7.__init__-1179"><a href="#Bar1Dv7.__init__-1179"><span class="linenos">1179</span></a>        <span class="c1">#self.val_inds = []</span>
</span><span id="Bar1Dv7.__init__-1180"><a href="#Bar1Dv7.__init__-1180"><span class="linenos">1180</span></a>        <span class="c1">#for nn in vblks:</span>
</span><span id="Bar1Dv7.__init__-1181"><a href="#Bar1Dv7.__init__-1181"><span class="linenos">1181</span></a>        <span class="c1">#    self.val_inds += list(deepcopy(self.block_inds[nn]))</span>
</span><span id="Bar1Dv7.__init__-1182"><a href="#Bar1Dv7.__init__-1182"><span class="linenos">1182</span></a>        <span class="c1">#self.train_inds = np.array(self.train_inds, dtype=np.int64)</span>
</span><span id="Bar1Dv7.__init__-1183"><a href="#Bar1Dv7.__init__-1183"><span class="linenos">1183</span></a>        <span class="c1">#self.val_inds = np.array(self.val_inds, dtype=np.int64)</span>
</span></pre></div>


            <div class="docstring"><p>Constructor options</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>sess_list:</strong>  list of sessions to load</li>
<li><strong>datadir:</strong>  directory where data is stored</li>
<li><strong>num_lags:</strong>  number of lags to include in time-embedding</li>
<li><strong>stim_crop:</strong>  whether to crop stimulus (not implemented)</li>
<li><strong>Hstim_shift:</strong>  how much to shift horizontal stimulus (in bars)</li>
<li><strong>Hdiscardzero:</strong>  whether to discard zero position in horizontal stimulus</li>
<li><strong>time_embed:</strong>  0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</li>
<li><strong>folded_lags:</strong>  whether to fold lags in time-embedding</li>
<li><strong>combine_stim:</strong>  whether to combine horizontal and vertical stimulus</li>
<li><strong>stim_gap:</strong>  gap between horizontal and vertical stimuli</li>
<li><strong>drift_interval:</strong>  how many trials to anchor each drift term</li>
<li><strong>eye_config:</strong>  0 = all, 1, -1, and 2 are options (2 = binocular)</li>
<li><strong>ignore_saccades:</strong>  whether to ignore saccades</li>
<li><strong>include_MUs:</strong>  whether to include multi-units</li>
<li><strong>preload:</strong>  whether to preload data</li>
<li><strong>eyepos:</strong>  eye position data</li>
<li><strong>device:</strong>  torch device to move data to</li>
</ul>
</div>


                            </div>
                            <div id="Bar1Dv7.datadir" class="classattr">
                                <div class="attr variable">
            <span class="name">datadir</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.datadir"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.sess_list" class="classattr">
                                <div class="attr variable">
            <span class="name">sess_list</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.sess_list"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.device" class="classattr">
                                <div class="attr variable">
            <span class="name">device</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.device"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.num_lags" class="classattr">
                                <div class="attr variable">
            <span class="name">num_lags</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.num_lags"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.time_embed" class="classattr">
                                <div class="attr variable">
            <span class="name">time_embed</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.time_embed"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.preload" class="classattr">
                                <div class="attr variable">
            <span class="name">preload</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.preload"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.stim_crop" class="classattr">
                                <div class="attr variable">
            <span class="name">stim_crop</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.stim_crop"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.folded_lags" class="classattr">
                                <div class="attr variable">
            <span class="name">folded_lags</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.folded_lags"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.combine_stim" class="classattr">
                                <div class="attr variable">
            <span class="name">combine_stim</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.combine_stim"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.eye_config" class="classattr">
                                <div class="attr variable">
            <span class="name">eye_config</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.eye_config"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.stim_gap" class="classattr">
                                <div class="attr variable">
            <span class="name">stim_gap</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.stim_gap"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.stimHshift" class="classattr">
                                <div class="attr variable">
            <span class="name">stimHshift</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.stimHshift"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.Hdiscardzero" class="classattr">
                                <div class="attr variable">
            <span class="name">Hdiscardzero</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.Hdiscardzero"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.drift_interval" class="classattr">
                                <div class="attr variable">
            <span class="name">drift_interval</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.drift_interval"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.fhandles" class="classattr">
                                <div class="attr variable">
            <span class="name">fhandles</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.fhandles"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.dfs_orig" class="classattr">
                                <div class="attr variable">
            <span class="name">dfs_orig</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.dfs_orig"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.ETstim_location" class="classattr">
                                <div class="attr variable">
            <span class="name">ETstim_location</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.ETstim_location"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.stim_location" class="classattr">
                                <div class="attr variable">
            <span class="name">stim_location</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.stim_location"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.fix_location" class="classattr">
                                <div class="attr variable">
            <span class="name">fix_location</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.fix_location"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.probeIDs" class="classattr">
                                <div class="attr variable">
            <span class="name">probeIDs</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.probeIDs"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.probeIDsMU" class="classattr">
                                <div class="attr variable">
            <span class="name">probeIDsMU</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.probeIDsMU"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.dt" class="classattr">
                                <div class="attr variable">
            <span class="name">dt</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.dt"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.pixel_size" class="classattr">
                                <div class="attr variable">
            <span class="name">pixel_size</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.pixel_size"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.exptdate" class="classattr">
                                <div class="attr variable">
            <span class="name">exptdate</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.exptdate"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.data_threshold" class="classattr">
                                <div class="attr variable">
            <span class="name">data_threshold</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.data_threshold"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.file_index" class="classattr">
                                <div class="attr variable">
            <span class="name">file_index</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.file_index"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.sacc_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">sacc_inds</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.sacc_inds"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.sus" class="classattr">
                                <div class="attr variable">
            <span class="name">sus</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.sus"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.NC" class="classattr">
                                <div class="attr variable">
            <span class="name">NC</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.NC"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.eyepos" class="classattr">
                                <div class="attr variable">
            <span class="name">eyepos</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.eyepos"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.generate_Xfix" class="classattr">
                                <div class="attr variable">
            <span class="name">generate_Xfix</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.generate_Xfix"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.num_blks" class="classattr">
                                <div class="attr variable">
            <span class="name">num_blks</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.num_blks"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.block_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">block_inds</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.block_inds"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.block_filemapping" class="classattr">
                                <div class="attr variable">
            <span class="name">block_filemapping</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.block_filemapping"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.include_MUs" class="classattr">
                                <div class="attr variable">
            <span class="name">include_MUs</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.include_MUs"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.SUinds" class="classattr">
                                <div class="attr variable">
            <span class="name">SUinds</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.SUinds"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.MUinds" class="classattr">
                                <div class="attr variable">
            <span class="name">MUinds</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.MUinds"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.cells_out" class="classattr">
                                <div class="attr variable">
            <span class="name">cells_out</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.cells_out"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.avRs" class="classattr">
                                <div class="attr variable">
            <span class="name">avRs</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.avRs"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.with_shifter" class="classattr">
                                <div class="attr variable">
            <span class="name">with_shifter</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.with_shifter"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.shifts" class="classattr">
                                <div class="attr variable">
            <span class="name">shifts</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.shifts"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.test_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">test_inds</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.test_inds"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.val_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">val_inds</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.val_inds"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.train_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">train_inds</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.train_inds"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.fix_n" class="classattr">
                                <div class="attr variable">
            <span class="name">fix_n</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.fix_n"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.used_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">used_inds</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.used_inds"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.stimname" class="classattr">
                                <div class="attr variable">
            <span class="name">stimname</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.stimname"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.ETtraceHR" class="classattr">
                                <div class="attr variable">
            <span class="name">ETtraceHR</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.ETtraceHR"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.NT" class="classattr">
                                <div class="attr variable">
            <span class="name">NT</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.NT"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.sort_rating" class="classattr">
                                <div class="attr variable">
            <span class="name">sort_rating</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.sort_rating"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.sort_ratingMU" class="classattr">
                                <div class="attr variable">
            <span class="name">sort_ratingMU</span>

        
    </div>
    <a class="headerlink" href="#Bar1Dv7.sort_ratingMU"></a>
    
    

                            </div>
                            <div id="Bar1Dv7.preload_numpy" class="classattr">
                                        <input id="Bar1Dv7.preload_numpy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">preload_numpy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Bar1Dv7.preload_numpy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1Dv7.preload_numpy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1Dv7.preload_numpy-1186"><a href="#Bar1Dv7.preload_numpy-1186"><span class="linenos">1186</span></a>    <span class="k">def</span> <span class="nf">preload_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Bar1Dv7.preload_numpy-1187"><a href="#Bar1Dv7.preload_numpy-1187"><span class="linenos">1187</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.preload_numpy-1188"><a href="#Bar1Dv7.preload_numpy-1188"><span class="linenos">1188</span></a><span class="sd">        Note this loads stimulus but does not time-embed</span>
</span><span id="Bar1Dv7.preload_numpy-1189"><a href="#Bar1Dv7.preload_numpy-1189"><span class="linenos">1189</span></a><span class="sd">        </span>
</span><span id="Bar1Dv7.preload_numpy-1190"><a href="#Bar1Dv7.preload_numpy-1190"><span class="linenos">1190</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7.preload_numpy-1191"><a href="#Bar1Dv7.preload_numpy-1191"><span class="linenos">1191</span></a><span class="sd">            None</span>
</span><span id="Bar1Dv7.preload_numpy-1192"><a href="#Bar1Dv7.preload_numpy-1192"><span class="linenos">1192</span></a>
</span><span id="Bar1Dv7.preload_numpy-1193"><a href="#Bar1Dv7.preload_numpy-1193"><span class="linenos">1193</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7.preload_numpy-1194"><a href="#Bar1Dv7.preload_numpy-1194"><span class="linenos">1194</span></a><span class="sd">            None: sets self.stim, self.robs, self.dfs, self.eyepos, self.frame_times</span>
</span><span id="Bar1Dv7.preload_numpy-1195"><a href="#Bar1Dv7.preload_numpy-1195"><span class="linenos">1195</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.preload_numpy-1196"><a href="#Bar1Dv7.preload_numpy-1196"><span class="linenos">1196</span></a>
</span><span id="Bar1Dv7.preload_numpy-1197"><a href="#Bar1Dv7.preload_numpy-1197"><span class="linenos">1197</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span><span id="Bar1Dv7.preload_numpy-1198"><a href="#Bar1Dv7.preload_numpy-1198"><span class="linenos">1198</span></a>        <span class="n">NX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Bar1Dv7.preload_numpy-1199"><a href="#Bar1Dv7.preload_numpy-1199"><span class="linenos">1199</span></a>        <span class="n">NX2</span> <span class="o">=</span> <span class="n">NX</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_gap</span>
</span><span id="Bar1Dv7.preload_numpy-1200"><a href="#Bar1Dv7.preload_numpy-1200"><span class="linenos">1200</span></a>
</span><span id="Bar1Dv7.preload_numpy-1201"><a href="#Bar1Dv7.preload_numpy-1201"><span class="linenos">1201</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="Bar1Dv7.preload_numpy-1202"><a href="#Bar1Dv7.preload_numpy-1202"><span class="linenos">1202</span></a><span class="sd">        Pre-allocate memory for data</span>
</span><span id="Bar1Dv7.preload_numpy-1203"><a href="#Bar1Dv7.preload_numpy-1203"><span class="linenos">1203</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="Bar1Dv7.preload_numpy-1204"><a href="#Bar1Dv7.preload_numpy-1204"><span class="linenos">1204</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1205"><a href="#Bar1Dv7.preload_numpy-1205"><span class="linenos">1205</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1206"><a href="#Bar1Dv7.preload_numpy-1206"><span class="linenos">1206</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="Bar1Dv7.preload_numpy-1207"><a href="#Bar1Dv7.preload_numpy-1207"><span class="linenos">1207</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">NX2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1208"><a href="#Bar1Dv7.preload_numpy-1208"><span class="linenos">1208</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7.preload_numpy-1209"><a href="#Bar1Dv7.preload_numpy-1209"><span class="linenos">1209</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1Dv7.preload_numpy-1210"><a href="#Bar1Dv7.preload_numpy-1210"><span class="linenos">1210</span></a>
</span><span id="Bar1Dv7.preload_numpy-1211"><a href="#Bar1Dv7.preload_numpy-1211"><span class="linenos">1211</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1212"><a href="#Bar1Dv7.preload_numpy-1212"><span class="linenos">1212</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1213"><a href="#Bar1Dv7.preload_numpy-1213"><span class="linenos">1213</span></a>        <span class="c1">#self.eyepos = np.zeros([NT, 2], dtype=np.float32)</span>
</span><span id="Bar1Dv7.preload_numpy-1214"><a href="#Bar1Dv7.preload_numpy-1214"><span class="linenos">1214</span></a>        <span class="c1">#self.frame_times = np.zeros([NT,1], dtype=np.float32)</span>
</span><span id="Bar1Dv7.preload_numpy-1215"><a href="#Bar1Dv7.preload_numpy-1215"><span class="linenos">1215</span></a>
</span><span id="Bar1Dv7.preload_numpy-1216"><a href="#Bar1Dv7.preload_numpy-1216"><span class="linenos">1216</span></a>        <span class="n">t_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1Dv7.preload_numpy-1217"><a href="#Bar1Dv7.preload_numpy-1217"><span class="linenos">1217</span></a>        <span class="n">unit_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1Dv7.preload_numpy-1218"><a href="#Bar1Dv7.preload_numpy-1218"><span class="linenos">1218</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">)):</span>
</span><span id="Bar1Dv7.preload_numpy-1219"><a href="#Bar1Dv7.preload_numpy-1219"><span class="linenos">1219</span></a>            
</span><span id="Bar1Dv7.preload_numpy-1220"><a href="#Bar1Dv7.preload_numpy-1220"><span class="linenos">1220</span></a>            <span class="n">fhandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="Bar1Dv7.preload_numpy-1221"><a href="#Bar1Dv7.preload_numpy-1221"><span class="linenos">1221</span></a>            <span class="n">sz</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="Bar1Dv7.preload_numpy-1222"><a href="#Bar1Dv7.preload_numpy-1222"><span class="linenos">1222</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_counter</span><span class="p">,</span> <span class="n">t_counter</span><span class="o">+</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1223"><a href="#Bar1Dv7.preload_numpy-1223"><span class="linenos">1223</span></a>            <span class="c1">#inds = self.stim_indices[expt][stim][&#39;inds&#39;]</span>
</span><span id="Bar1Dv7.preload_numpy-1224"><a href="#Bar1Dv7.preload_numpy-1224"><span class="linenos">1224</span></a>            <span class="c1">#self.stim[inds, ...] = np.transpose( np.array(fhandle[self.stimname], dtype=np.float32), axes=[0,3,1,2])</span>
</span><span id="Bar1Dv7.preload_numpy-1225"><a href="#Bar1Dv7.preload_numpy-1225"><span class="linenos">1225</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1226"><a href="#Bar1Dv7.preload_numpy-1226"><span class="linenos">1226</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tmp_stim</span><span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1227"><a href="#Bar1Dv7.preload_numpy-1227"><span class="linenos">1227</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp_stim</span>
</span><span id="Bar1Dv7.preload_numpy-1228"><a href="#Bar1Dv7.preload_numpy-1228"><span class="linenos">1228</span></a>            <span class="n">stim_ori</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimETori&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7.preload_numpy-1229"><a href="#Bar1Dv7.preload_numpy-1229"><span class="linenos">1229</span></a>            <span class="n">Hinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_ori</span> <span class="o">&gt;</span> <span class="mi">45</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7.preload_numpy-1230"><a href="#Bar1Dv7.preload_numpy-1230"><span class="linenos">1230</span></a>            <span class="n">Vinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_ori</span> <span class="o">&lt;</span> <span class="mi">45</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7.preload_numpy-1231"><a href="#Bar1Dv7.preload_numpy-1231"><span class="linenos">1231</span></a>
</span><span id="Bar1Dv7.preload_numpy-1232"><a href="#Bar1Dv7.preload_numpy-1232"><span class="linenos">1232</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">Vinds</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="Bar1Dv7.preload_numpy-1233"><a href="#Bar1Dv7.preload_numpy-1233"><span class="linenos">1233</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">Hinds</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="Bar1Dv7.preload_numpy-1234"><a href="#Bar1Dv7.preload_numpy-1234"><span class="linenos">1234</span></a>
</span><span id="Bar1Dv7.preload_numpy-1235"><a href="#Bar1Dv7.preload_numpy-1235"><span class="linenos">1235</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Robs and DATAFILTERS&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.preload_numpy-1236"><a href="#Bar1Dv7.preload_numpy-1236"><span class="linenos">1236</span></a>            <span class="n">robs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1237"><a href="#Bar1Dv7.preload_numpy-1237"><span class="linenos">1237</span></a>            <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1238"><a href="#Bar1Dv7.preload_numpy-1238"><span class="linenos">1238</span></a>            <span class="n">num_sus</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Bar1Dv7.preload_numpy-1239"><a href="#Bar1Dv7.preload_numpy-1239"><span class="linenos">1239</span></a>            <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1240"><a href="#Bar1Dv7.preload_numpy-1240"><span class="linenos">1240</span></a>            <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1241"><a href="#Bar1Dv7.preload_numpy-1241"><span class="linenos">1241</span></a>            <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;datafilts&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1242"><a href="#Bar1Dv7.preload_numpy-1242"><span class="linenos">1242</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="Bar1Dv7.preload_numpy-1243"><a href="#Bar1Dv7.preload_numpy-1243"><span class="linenos">1243</span></a>                <span class="n">num_mus</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Bar1Dv7.preload_numpy-1244"><a href="#Bar1Dv7.preload_numpy-1244"><span class="linenos">1244</span></a>                <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="o">+</span><span class="n">num_mus</span><span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1245"><a href="#Bar1Dv7.preload_numpy-1245"><span class="linenos">1245</span></a>                <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1246"><a href="#Bar1Dv7.preload_numpy-1246"><span class="linenos">1246</span></a>                <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;datafiltsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1247"><a href="#Bar1Dv7.preload_numpy-1247"><span class="linenos">1247</span></a>            
</span><span id="Bar1Dv7.preload_numpy-1248"><a href="#Bar1Dv7.preload_numpy-1248"><span class="linenos">1248</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">robs_tmp</span><span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1249"><a href="#Bar1Dv7.preload_numpy-1249"><span class="linenos">1249</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dfs_tmp</span><span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1250"><a href="#Bar1Dv7.preload_numpy-1250"><span class="linenos">1250</span></a>
</span><span id="Bar1Dv7.preload_numpy-1251"><a href="#Bar1Dv7.preload_numpy-1251"><span class="linenos">1251</span></a>            <span class="n">t_counter</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7.preload_numpy-1252"><a href="#Bar1Dv7.preload_numpy-1252"><span class="linenos">1252</span></a>            <span class="n">unit_counter</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="Bar1Dv7.preload_numpy-1253"><a href="#Bar1Dv7.preload_numpy-1253"><span class="linenos">1253</span></a>
</span><span id="Bar1Dv7.preload_numpy-1254"><a href="#Bar1Dv7.preload_numpy-1254"><span class="linenos">1254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span> <span class="o">=</span> <span class="s1">&#39;stim&#39;</span>  <span class="c1"># not sure what this does</span>
</span><span id="Bar1Dv7.preload_numpy-1255"><a href="#Bar1Dv7.preload_numpy-1255"><span class="linenos">1255</span></a>
</span><span id="Bar1Dv7.preload_numpy-1256"><a href="#Bar1Dv7.preload_numpy-1256"><span class="linenos">1256</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="Bar1Dv7.preload_numpy-1257"><a href="#Bar1Dv7.preload_numpy-1257"><span class="linenos">1257</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1258"><a href="#Bar1Dv7.preload_numpy-1258"><span class="linenos">1258</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">NX</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_gap</span><span class="p">,</span> <span class="n">NX2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1259"><a href="#Bar1Dv7.preload_numpy-1259"><span class="linenos">1259</span></a>
</span><span id="Bar1Dv7.preload_numpy-1260"><a href="#Bar1Dv7.preload_numpy-1260"><span class="linenos">1260</span></a>        <span class="n">sh</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimHshift</span><span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1261"><a href="#Bar1Dv7.preload_numpy-1261"><span class="linenos">1261</span></a>        <span class="k">if</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7.preload_numpy-1262"><a href="#Bar1Dv7.preload_numpy-1262"><span class="linenos">1262</span></a>            <span class="n">Lc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span> <span class="o">-</span> <span class="n">sh</span>
</span><span id="Bar1Dv7.preload_numpy-1263"><a href="#Bar1Dv7.preload_numpy-1263"><span class="linenos">1263</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1264"><a href="#Bar1Dv7.preload_numpy-1264"><span class="linenos">1264</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hdiscardzero</span><span class="p">:</span>
</span><span id="Bar1Dv7.preload_numpy-1265"><a href="#Bar1Dv7.preload_numpy-1265"><span class="linenos">1265</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Discarding stim at 0 horizontal position&#39;</span><span class="p">)</span>
</span><span id="Bar1Dv7.preload_numpy-1266"><a href="#Bar1Dv7.preload_numpy-1266"><span class="linenos">1266</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimHshift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7.preload_numpy-1267"><a href="#Bar1Dv7.preload_numpy-1267"><span class="linenos">1267</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="Bar1Dv7.preload_numpy-1268"><a href="#Bar1Dv7.preload_numpy-1268"><span class="linenos">1268</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">sh</span><span class="p">)])</span>
</span><span id="Bar1Dv7.preload_numpy-1269"><a href="#Bar1Dv7.preload_numpy-1269"><span class="linenos">1269</span></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimHshift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7.preload_numpy-1270"><a href="#Bar1Dv7.preload_numpy-1270"><span class="linenos">1270</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Lc</span><span class="p">)])</span>
</span><span id="Bar1Dv7.preload_numpy-1271"><a href="#Bar1Dv7.preload_numpy-1271"><span class="linenos">1271</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="Bar1Dv7.preload_numpy-1272"><a href="#Bar1Dv7.preload_numpy-1272"><span class="linenos">1272</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7.preload_numpy-1273"><a href="#Bar1Dv7.preload_numpy-1273"><span class="linenos">1273</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimHshift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7.preload_numpy-1274"><a href="#Bar1Dv7.preload_numpy-1274"><span class="linenos">1274</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="Bar1Dv7.preload_numpy-1275"><a href="#Bar1Dv7.preload_numpy-1275"><span class="linenos">1275</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)])</span>
</span><span id="Bar1Dv7.preload_numpy-1276"><a href="#Bar1Dv7.preload_numpy-1276"><span class="linenos">1276</span></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimHshift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7.preload_numpy-1277"><a href="#Bar1Dv7.preload_numpy-1277"><span class="linenos">1277</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">)])</span>
</span><span id="Bar1Dv7.preload_numpy-1278"><a href="#Bar1Dv7.preload_numpy-1278"><span class="linenos">1278</span></a>                    <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NX</span><span class="p">)])</span>
</span><span id="Bar1Dv7.preload_numpy-1279"><a href="#Bar1Dv7.preload_numpy-1279"><span class="linenos">1279</span></a>
</span><span id="Bar1Dv7.preload_numpy-1280"><a href="#Bar1Dv7.preload_numpy-1280"><span class="linenos">1280</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tmp_stim</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Note this loads stimulus but does not time-embed</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li>None</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: sets self.stim, self.robs, self.dfs, self.eyepos, self.frame_times</p>
</blockquote>
</div>


                            </div>
                            <div id="Bar1Dv7.to_tensor" class="classattr">
                                        <input id="Bar1Dv7.to_tensor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">to_tensor</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">device</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Bar1Dv7.to_tensor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1Dv7.to_tensor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1Dv7.to_tensor-1283"><a href="#Bar1Dv7.to_tensor-1283"><span class="linenos">1283</span></a>    <span class="k">def</span> <span class="nf">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="Bar1Dv7.to_tensor-1284"><a href="#Bar1Dv7.to_tensor-1284"><span class="linenos">1284</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.to_tensor-1285"><a href="#Bar1Dv7.to_tensor-1285"><span class="linenos">1285</span></a><span class="sd">        Converts numpy data to torch tensors and moves to device</span>
</span><span id="Bar1Dv7.to_tensor-1286"><a href="#Bar1Dv7.to_tensor-1286"><span class="linenos">1286</span></a>
</span><span id="Bar1Dv7.to_tensor-1287"><a href="#Bar1Dv7.to_tensor-1287"><span class="linenos">1287</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7.to_tensor-1288"><a href="#Bar1Dv7.to_tensor-1288"><span class="linenos">1288</span></a><span class="sd">            device: torch device to move data to</span>
</span><span id="Bar1Dv7.to_tensor-1289"><a href="#Bar1Dv7.to_tensor-1289"><span class="linenos">1289</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.to_tensor-1290"><a href="#Bar1Dv7.to_tensor-1290"><span class="linenos">1290</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="Bar1Dv7.to_tensor-1291"><a href="#Bar1Dv7.to_tensor-1291"><span class="linenos">1291</span></a>            <span class="c1"># then already converted: just moving device</span>
</span><span id="Bar1Dv7.to_tensor-1292"><a href="#Bar1Dv7.to_tensor-1292"><span class="linenos">1292</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7.to_tensor-1293"><a href="#Bar1Dv7.to_tensor-1293"><span class="linenos">1293</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7.to_tensor-1294"><a href="#Bar1Dv7.to_tensor-1294"><span class="linenos">1294</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7.to_tensor-1295"><a href="#Bar1Dv7.to_tensor-1295"><span class="linenos">1295</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7.to_tensor-1296"><a href="#Bar1Dv7.to_tensor-1296"><span class="linenos">1296</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7.to_tensor-1297"><a href="#Bar1Dv7.to_tensor-1297"><span class="linenos">1297</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7.to_tensor-1298"><a href="#Bar1Dv7.to_tensor-1298"><span class="linenos">1298</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="Bar1Dv7.to_tensor-1299"><a href="#Bar1Dv7.to_tensor-1299"><span class="linenos">1299</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7.to_tensor-1300"><a href="#Bar1Dv7.to_tensor-1300"><span class="linenos">1300</span></a>
</span><span id="Bar1Dv7.to_tensor-1301"><a href="#Bar1Dv7.to_tensor-1301"><span class="linenos">1301</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7.to_tensor-1302"><a href="#Bar1Dv7.to_tensor-1302"><span class="linenos">1302</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7.to_tensor-1303"><a href="#Bar1Dv7.to_tensor-1303"><span class="linenos">1303</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7.to_tensor-1304"><a href="#Bar1Dv7.to_tensor-1304"><span class="linenos">1304</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7.to_tensor-1305"><a href="#Bar1Dv7.to_tensor-1305"><span class="linenos">1305</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7.to_tensor-1306"><a href="#Bar1Dv7.to_tensor-1306"><span class="linenos">1306</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7.to_tensor-1307"><a href="#Bar1Dv7.to_tensor-1307"><span class="linenos">1307</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7.to_tensor-1308"><a href="#Bar1Dv7.to_tensor-1308"><span class="linenos">1308</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_stim</span><span class="p">:</span>
</span><span id="Bar1Dv7.to_tensor-1309"><a href="#Bar1Dv7.to_tensor-1309"><span class="linenos">1309</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimC</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimC</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Converts numpy data to torch tensors and moves to device</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>device:</strong>  torch device to move data to</li>
</ul>
</div>


                            </div>
                            <div id="Bar1Dv7.process_fixations" class="classattr">
                                        <input id="Bar1Dv7.process_fixations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">process_fixations</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">sacc_in</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Bar1Dv7.process_fixations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1Dv7.process_fixations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1Dv7.process_fixations-1312"><a href="#Bar1Dv7.process_fixations-1312"><span class="linenos">1312</span></a>    <span class="k">def</span> <span class="nf">process_fixations</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sacc_in</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="Bar1Dv7.process_fixations-1313"><a href="#Bar1Dv7.process_fixations-1313"><span class="linenos">1313</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.process_fixations-1314"><a href="#Bar1Dv7.process_fixations-1314"><span class="linenos">1314</span></a><span class="sd">        Processes fixation informatiom from dataset, but also allows new saccade detection</span>
</span><span id="Bar1Dv7.process_fixations-1315"><a href="#Bar1Dv7.process_fixations-1315"><span class="linenos">1315</span></a><span class="sd">        to be input and put in the right format within the dataset (main use)</span>
</span><span id="Bar1Dv7.process_fixations-1316"><a href="#Bar1Dv7.process_fixations-1316"><span class="linenos">1316</span></a><span class="sd">        </span>
</span><span id="Bar1Dv7.process_fixations-1317"><a href="#Bar1Dv7.process_fixations-1317"><span class="linenos">1317</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7.process_fixations-1318"><a href="#Bar1Dv7.process_fixations-1318"><span class="linenos">1318</span></a><span class="sd">            sacc_in: new saccade information to be processed (if None, will use existing)</span>
</span><span id="Bar1Dv7.process_fixations-1319"><a href="#Bar1Dv7.process_fixations-1319"><span class="linenos">1319</span></a>
</span><span id="Bar1Dv7.process_fixations-1320"><a href="#Bar1Dv7.process_fixations-1320"><span class="linenos">1320</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7.process_fixations-1321"><a href="#Bar1Dv7.process_fixations-1321"><span class="linenos">1321</span></a><span class="sd">            None: sets self.fix_n</span>
</span><span id="Bar1Dv7.process_fixations-1322"><a href="#Bar1Dv7.process_fixations-1322"><span class="linenos">1322</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.process_fixations-1323"><a href="#Bar1Dv7.process_fixations-1323"><span class="linenos">1323</span></a>        <span class="k">if</span> <span class="n">sacc_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1Dv7.process_fixations-1324"><a href="#Bar1Dv7.process_fixations-1324"><span class="linenos">1324</span></a>            <span class="n">sacc_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7.process_fixations-1325"><a href="#Bar1Dv7.process_fixations-1325"><span class="linenos">1325</span></a>
</span><span id="Bar1Dv7.process_fixations-1326"><a href="#Bar1Dv7.process_fixations-1326"><span class="linenos">1326</span></a>        <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> 
</span><span id="Bar1Dv7.process_fixations-1327"><a href="#Bar1Dv7.process_fixations-1327"><span class="linenos">1327</span></a>        <span class="n">fix_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1Dv7.process_fixations-1328"><a href="#Bar1Dv7.process_fixations-1328"><span class="linenos">1328</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)):</span>
</span><span id="Bar1Dv7.process_fixations-1329"><a href="#Bar1Dv7.process_fixations-1329"><span class="linenos">1329</span></a>            <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="Bar1Dv7.process_fixations-1330"><a href="#Bar1Dv7.process_fixations-1330"><span class="linenos">1330</span></a>            <span class="c1">#self.block_inds.append(np.arange( blk_inds[ii,0], blk_inds[ii,1], dtype=np.int64))</span>
</span><span id="Bar1Dv7.process_fixations-1331"><a href="#Bar1Dv7.process_fixations-1331"><span class="linenos">1331</span></a>
</span><span id="Bar1Dv7.process_fixations-1332"><a href="#Bar1Dv7.process_fixations-1332"><span class="linenos">1332</span></a>            <span class="c1"># Parse fixation numbers within block</span>
</span><span id="Bar1Dv7.process_fixations-1333"><a href="#Bar1Dv7.process_fixations-1333"><span class="linenos">1333</span></a>            <span class="n">rel_saccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">sacc_in</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sacc_in</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7.process_fixations-1334"><a href="#Bar1Dv7.process_fixations-1334"><span class="linenos">1334</span></a>
</span><span id="Bar1Dv7.process_fixations-1335"><a href="#Bar1Dv7.process_fixations-1335"><span class="linenos">1335</span></a>            <span class="n">tfix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Beginning of fixation by definition</span>
</span><span id="Bar1Dv7.process_fixations-1336"><a href="#Bar1Dv7.process_fixations-1336"><span class="linenos">1336</span></a>            <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel_saccs</span><span class="p">)):</span>
</span><span id="Bar1Dv7.process_fixations-1337"><a href="#Bar1Dv7.process_fixations-1337"><span class="linenos">1337</span></a>                <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Bar1Dv7.process_fixations-1338"><a href="#Bar1Dv7.process_fixations-1338"><span class="linenos">1338</span></a>                <span class="c1"># Range goes to beginning of next fixation (note no gap)</span>
</span><span id="Bar1Dv7.process_fixations-1339"><a href="#Bar1Dv7.process_fixations-1339"><span class="linenos">1339</span></a>                <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="Bar1Dv7.process_fixations-1340"><a href="#Bar1Dv7.process_fixations-1340"><span class="linenos">1340</span></a>                <span class="n">tfix</span> <span class="o">=</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">6</span>
</span><span id="Bar1Dv7.process_fixations-1341"><a href="#Bar1Dv7.process_fixations-1341"><span class="linenos">1341</span></a>            <span class="c1"># Put in last (or only) fixation number</span>
</span><span id="Bar1Dv7.process_fixations-1342"><a href="#Bar1Dv7.process_fixations-1342"><span class="linenos">1342</span></a>            <span class="k">if</span> <span class="n">tfix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="Bar1Dv7.process_fixations-1343"><a href="#Bar1Dv7.process_fixations-1343"><span class="linenos">1343</span></a>                <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Bar1Dv7.process_fixations-1344"><a href="#Bar1Dv7.process_fixations-1344"><span class="linenos">1344</span></a>                <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="Bar1Dv7.process_fixations-1345"><a href="#Bar1Dv7.process_fixations-1345"><span class="linenos">1345</span></a>
</span><span id="Bar1Dv7.process_fixations-1346"><a href="#Bar1Dv7.process_fixations-1346"><span class="linenos">1346</span></a>        <span class="c1"># Determine whether to be numpy or tensor</span>
</span><span id="Bar1Dv7.process_fixations-1347"><a href="#Bar1Dv7.process_fixations-1347"><span class="linenos">1347</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="Bar1Dv7.process_fixations-1348"><a href="#Bar1Dv7.process_fixations-1348"><span class="linenos">1348</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7.process_fixations-1349"><a href="#Bar1Dv7.process_fixations-1349"><span class="linenos">1349</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7.process_fixations-1350"><a href="#Bar1Dv7.process_fixations-1350"><span class="linenos">1350</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">fix_n</span>
</span></pre></div>


            <div class="docstring"><p>Processes fixation informatiom from dataset, but also allows new saccade detection
to be input and put in the right format within the dataset (main use)</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>sacc_in:</strong>  new saccade information to be processed (if None, will use existing)</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: sets self.fix_n</p>
</blockquote>
</div>


                            </div>
                            <div id="Bar1Dv7.add_shifter" class="classattr">
                                        <input id="Bar1Dv7.add_shifter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_shifter</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">shifts</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Bar1Dv7.add_shifter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1Dv7.add_shifter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1Dv7.add_shifter-1353"><a href="#Bar1Dv7.add_shifter-1353"><span class="linenos">1353</span></a>    <span class="k">def</span> <span class="nf">add_shifter</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">shifts</span> <span class="p">):</span>
</span><span id="Bar1Dv7.add_shifter-1354"><a href="#Bar1Dv7.add_shifter-1354"><span class="linenos">1354</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.add_shifter-1355"><a href="#Bar1Dv7.add_shifter-1355"><span class="linenos">1355</span></a><span class="sd">        Adds a shifter to the dataset, which can be used to shift the stimulus</span>
</span><span id="Bar1Dv7.add_shifter-1356"><a href="#Bar1Dv7.add_shifter-1356"><span class="linenos">1356</span></a>
</span><span id="Bar1Dv7.add_shifter-1357"><a href="#Bar1Dv7.add_shifter-1357"><span class="linenos">1357</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7.add_shifter-1358"><a href="#Bar1Dv7.add_shifter-1358"><span class="linenos">1358</span></a><span class="sd">            shifts: shifts to be added to the dataset</span>
</span><span id="Bar1Dv7.add_shifter-1359"><a href="#Bar1Dv7.add_shifter-1359"><span class="linenos">1359</span></a>
</span><span id="Bar1Dv7.add_shifter-1360"><a href="#Bar1Dv7.add_shifter-1360"><span class="linenos">1360</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7.add_shifter-1361"><a href="#Bar1Dv7.add_shifter-1361"><span class="linenos">1361</span></a><span class="sd">            None: sets self.shifts</span>
</span><span id="Bar1Dv7.add_shifter-1362"><a href="#Bar1Dv7.add_shifter-1362"><span class="linenos">1362</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.add_shifter-1363"><a href="#Bar1Dv7.add_shifter-1363"><span class="linenos">1363</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">shifts</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">),</span> <span class="s2">&quot;Entered shifts is wrong size.&quot;</span>
</span><span id="Bar1Dv7.add_shifter-1364"><a href="#Bar1Dv7.add_shifter-1364"><span class="linenos">1364</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span><span class="p">:</span>
</span><span id="Bar1Dv7.add_shifter-1365"><a href="#Bar1Dv7.add_shifter-1365"><span class="linenos">1365</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">with_shifter</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Bar1Dv7.add_shifter-1366"><a href="#Bar1Dv7.add_shifter-1366"><span class="linenos">1366</span></a>        <span class="c1"># else: Delete old shifts?</span>
</span><span id="Bar1Dv7.add_shifter-1367"><a href="#Bar1Dv7.add_shifter-1367"><span class="linenos">1367</span></a>        
</span><span id="Bar1Dv7.add_shifter-1368"><a href="#Bar1Dv7.add_shifter-1368"><span class="linenos">1368</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">device</span>
</span><span id="Bar1Dv7.add_shifter-1369"><a href="#Bar1Dv7.add_shifter-1369"><span class="linenos">1369</span></a>
</span><span id="Bar1Dv7.add_shifter-1370"><a href="#Bar1Dv7.add_shifter-1370"><span class="linenos">1370</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">):</span>
</span><span id="Bar1Dv7.add_shifter-1371"><a href="#Bar1Dv7.add_shifter-1371"><span class="linenos">1371</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="o">=</span> <span class="n">shifts</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7.add_shifter-1372"><a href="#Bar1Dv7.add_shifter-1372"><span class="linenos">1372</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7.add_shifter-1373"><a href="#Bar1Dv7.add_shifter-1373"><span class="linenos">1373</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Adds a shifter to the dataset, which can be used to shift the stimulus</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>shifts:</strong>  shifts to be added to the dataset</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: sets self.shifts</p>
</blockquote>
</div>


                            </div>
                            <div id="Bar1Dv7.avrates" class="classattr">
                                        <input id="Bar1Dv7.avrates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">avrates</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">inds</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Bar1Dv7.avrates-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1Dv7.avrates"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1Dv7.avrates-1375"><a href="#Bar1Dv7.avrates-1375"><span class="linenos">1375</span></a>    <span class="k">def</span> <span class="nf">avrates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="Bar1Dv7.avrates-1376"><a href="#Bar1Dv7.avrates-1376"><span class="linenos">1376</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.avrates-1377"><a href="#Bar1Dv7.avrates-1377"><span class="linenos">1377</span></a><span class="sd">        Calculates average firing probability across specified inds (or whole dataset)</span>
</span><span id="Bar1Dv7.avrates-1378"><a href="#Bar1Dv7.avrates-1378"><span class="linenos">1378</span></a><span class="sd">        -- Note will respect datafilters</span>
</span><span id="Bar1Dv7.avrates-1379"><a href="#Bar1Dv7.avrates-1379"><span class="linenos">1379</span></a><span class="sd">        -- will return precalc value to save time if already stored</span>
</span><span id="Bar1Dv7.avrates-1380"><a href="#Bar1Dv7.avrates-1380"><span class="linenos">1380</span></a>
</span><span id="Bar1Dv7.avrates-1381"><a href="#Bar1Dv7.avrates-1381"><span class="linenos">1381</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7.avrates-1382"><a href="#Bar1Dv7.avrates-1382"><span class="linenos">1382</span></a><span class="sd">            inds: indices to calculate across</span>
</span><span id="Bar1Dv7.avrates-1383"><a href="#Bar1Dv7.avrates-1383"><span class="linenos">1383</span></a>
</span><span id="Bar1Dv7.avrates-1384"><a href="#Bar1Dv7.avrates-1384"><span class="linenos">1384</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7.avrates-1385"><a href="#Bar1Dv7.avrates-1385"><span class="linenos">1385</span></a><span class="sd">            avRs: average firing rates across the dataset</span>
</span><span id="Bar1Dv7.avrates-1386"><a href="#Bar1Dv7.avrates-1386"><span class="linenos">1386</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.avrates-1387"><a href="#Bar1Dv7.avrates-1387"><span class="linenos">1387</span></a>        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1Dv7.avrates-1388"><a href="#Bar1Dv7.avrates-1388"><span class="linenos">1388</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="Bar1Dv7.avrates-1389"><a href="#Bar1Dv7.avrates-1389"><span class="linenos">1389</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="Bar1Dv7.avrates-1390"><a href="#Bar1Dv7.avrates-1390"><span class="linenos">1390</span></a>            <span class="c1"># then calculate across whole dataset</span>
</span><span id="Bar1Dv7.avrates-1391"><a href="#Bar1Dv7.avrates-1391"><span class="linenos">1391</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1Dv7.avrates-1392"><a href="#Bar1Dv7.avrates-1392"><span class="linenos">1392</span></a>                <span class="c1"># then precalculated and do not need to do</span>
</span><span id="Bar1Dv7.avrates-1393"><a href="#Bar1Dv7.avrates-1393"><span class="linenos">1393</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span>
</span><span id="Bar1Dv7.avrates-1394"><a href="#Bar1Dv7.avrates-1394"><span class="linenos">1394</span></a>
</span><span id="Bar1Dv7.avrates-1395"><a href="#Bar1Dv7.avrates-1395"><span class="linenos">1395</span></a>        <span class="c1"># Otherwise calculate across all data</span>
</span><span id="Bar1Dv7.avrates-1396"><a href="#Bar1Dv7.avrates-1396"><span class="linenos">1396</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="Bar1Dv7.avrates-1397"><a href="#Bar1Dv7.avrates-1397"><span class="linenos">1397</span></a>            <span class="n">Reff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="Bar1Dv7.avrates-1398"><a href="#Bar1Dv7.avrates-1398"><span class="linenos">1398</span></a>            <span class="n">Teff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="Bar1Dv7.avrates-1399"><a href="#Bar1Dv7.avrates-1399"><span class="linenos">1399</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="o">/</span><span class="n">Teff</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="Bar1Dv7.avrates-1400"><a href="#Bar1Dv7.avrates-1400"><span class="linenos">1400</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7.avrates-1401"><a href="#Bar1Dv7.avrates-1401"><span class="linenos">1401</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Still need to implement avRs without preloading&#39;</span><span class="p">)</span>
</span><span id="Bar1Dv7.avrates-1402"><a href="#Bar1Dv7.avrates-1402"><span class="linenos">1402</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Calculates average firing probability across specified inds (or whole dataset)
-- Note will respect datafilters
-- will return precalc value to save time if already stored</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>inds:</strong>  indices to calculate across</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>avRs: average firing rates across the dataset</p>
</blockquote>
</div>


                            </div>
                            <div id="Bar1Dv7.apply_data_mask" class="classattr">
                                        <input id="Bar1Dv7.apply_data_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">apply_data_mask</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">dmask</span>, </span><span class="param"><span class="n">crange</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Bar1Dv7.apply_data_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1Dv7.apply_data_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1Dv7.apply_data_mask-1405"><a href="#Bar1Dv7.apply_data_mask-1405"><span class="linenos">1405</span></a>    <span class="k">def</span> <span class="nf">apply_data_mask</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">dmask</span><span class="p">,</span> <span class="n">crange</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="Bar1Dv7.apply_data_mask-1406"><a href="#Bar1Dv7.apply_data_mask-1406"><span class="linenos">1406</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.apply_data_mask-1407"><a href="#Bar1Dv7.apply_data_mask-1407"><span class="linenos">1407</span></a><span class="sd">        For when data_filters (or a section) is modified based on models, and want to apply</span>
</span><span id="Bar1Dv7.apply_data_mask-1408"><a href="#Bar1Dv7.apply_data_mask-1408"><span class="linenos">1408</span></a><span class="sd">        to the dataset. Ideally would save the original</span>
</span><span id="Bar1Dv7.apply_data_mask-1409"><a href="#Bar1Dv7.apply_data_mask-1409"><span class="linenos">1409</span></a><span class="sd">        </span>
</span><span id="Bar1Dv7.apply_data_mask-1410"><a href="#Bar1Dv7.apply_data_mask-1410"><span class="linenos">1410</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7.apply_data_mask-1411"><a href="#Bar1Dv7.apply_data_mask-1411"><span class="linenos">1411</span></a><span class="sd">            dmask: mask to apply to data</span>
</span><span id="Bar1Dv7.apply_data_mask-1412"><a href="#Bar1Dv7.apply_data_mask-1412"><span class="linenos">1412</span></a><span class="sd">            crange: range of cells to apply mask to</span>
</span><span id="Bar1Dv7.apply_data_mask-1413"><a href="#Bar1Dv7.apply_data_mask-1413"><span class="linenos">1413</span></a>
</span><span id="Bar1Dv7.apply_data_mask-1414"><a href="#Bar1Dv7.apply_data_mask-1414"><span class="linenos">1414</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7.apply_data_mask-1415"><a href="#Bar1Dv7.apply_data_mask-1415"><span class="linenos">1415</span></a><span class="sd">            None: sets self.dfs to new data mask</span>
</span><span id="Bar1Dv7.apply_data_mask-1416"><a href="#Bar1Dv7.apply_data_mask-1416"><span class="linenos">1416</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.apply_data_mask-1417"><a href="#Bar1Dv7.apply_data_mask-1417"><span class="linenos">1417</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">,</span> <span class="s2">&quot;data must be preloaded to apply mask&quot;</span>
</span><span id="Bar1Dv7.apply_data_mask-1418"><a href="#Bar1Dv7.apply_data_mask-1418"><span class="linenos">1418</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dmask</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="Bar1Dv7.apply_data_mask-1419"><a href="#Bar1Dv7.apply_data_mask-1419"><span class="linenos">1419</span></a>            <span class="n">dmask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dmask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1Dv7.apply_data_mask-1420"><a href="#Bar1Dv7.apply_data_mask-1420"><span class="linenos">1420</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dmask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Bar1Dv7.apply_data_mask-1421"><a href="#Bar1Dv7.apply_data_mask-1421"><span class="linenos">1421</span></a>            <span class="n">dmask</span> <span class="o">=</span> <span class="n">dmask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="Bar1Dv7.apply_data_mask-1422"><a href="#Bar1Dv7.apply_data_mask-1422"><span class="linenos">1422</span></a>        <span class="n">NT</span><span class="p">,</span> <span class="n">mask_size</span> <span class="o">=</span> <span class="n">dmask</span><span class="o">.</span><span class="n">shape</span>
</span><span id="Bar1Dv7.apply_data_mask-1423"><a href="#Bar1Dv7.apply_data_mask-1423"><span class="linenos">1423</span></a>        <span class="k">assert</span> <span class="n">NT</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="s2">&quot;Data mask is wrong length&quot;</span>
</span><span id="Bar1Dv7.apply_data_mask-1424"><a href="#Bar1Dv7.apply_data_mask-1424"><span class="linenos">1424</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7.apply_data_mask-1425"><a href="#Bar1Dv7.apply_data_mask-1425"><span class="linenos">1425</span></a>            <span class="n">cells_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Bar1Dv7.apply_data_mask-1426"><a href="#Bar1Dv7.apply_data_mask-1426"><span class="linenos">1426</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7.apply_data_mask-1427"><a href="#Bar1Dv7.apply_data_mask-1427"><span class="linenos">1427</span></a>            <span class="n">cells_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Bar1Dv7.apply_data_mask-1428"><a href="#Bar1Dv7.apply_data_mask-1428"><span class="linenos">1428</span></a>        <span class="k">if</span> <span class="n">crange</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1Dv7.apply_data_mask-1429"><a href="#Bar1Dv7.apply_data_mask-1429"><span class="linenos">1429</span></a>            <span class="n">crange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells_out</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Bar1Dv7.apply_data_mask-1430"><a href="#Bar1Dv7.apply_data_mask-1430"><span class="linenos">1430</span></a>        <span class="k">assert</span> <span class="n">mask_size</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">crange</span><span class="p">),</span> <span class="s2">&quot;mask does not cover the right range&quot;</span>
</span><span id="Bar1Dv7.apply_data_mask-1431"><a href="#Bar1Dv7.apply_data_mask-1431"><span class="linenos">1431</span></a>
</span><span id="Bar1Dv7.apply_data_mask-1432"><a href="#Bar1Dv7.apply_data_mask-1432"><span class="linenos">1432</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1Dv7.apply_data_mask-1433"><a href="#Bar1Dv7.apply_data_mask-1433"><span class="linenos">1433</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">)</span>
</span><span id="Bar1Dv7.apply_data_mask-1434"><a href="#Bar1Dv7.apply_data_mask-1434"><span class="linenos">1434</span></a>        <span class="c1"># Given all assertions worked, then make copy</span>
</span><span id="Bar1Dv7.apply_data_mask-1435"><a href="#Bar1Dv7.apply_data_mask-1435"><span class="linenos">1435</span></a>
</span><span id="Bar1Dv7.apply_data_mask-1436"><a href="#Bar1Dv7.apply_data_mask-1436"><span class="linenos">1436</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">cells_out</span><span class="p">[</span><span class="n">crange</span><span class="p">]]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dmask</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>For when data_filters (or a section) is modified based on models, and want to apply
to the dataset. Ideally would save the original</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>dmask:</strong>  mask to apply to data</li>
<li><strong>crange:</strong>  range of cells to apply mask to</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: sets self.dfs to new data mask</p>
</blockquote>
</div>


                            </div>
                            <div id="Bar1Dv7.data_mask_revert" class="classattr">
                                        <input id="Bar1Dv7.data_mask_revert-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">data_mask_revert</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">crange</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Bar1Dv7.data_mask_revert-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1Dv7.data_mask_revert"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1Dv7.data_mask_revert-1439"><a href="#Bar1Dv7.data_mask_revert-1439"><span class="linenos">1439</span></a>    <span class="k">def</span> <span class="nf">data_mask_revert</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">crange</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="Bar1Dv7.data_mask_revert-1440"><a href="#Bar1Dv7.data_mask_revert-1440"><span class="linenos">1440</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.data_mask_revert-1441"><a href="#Bar1Dv7.data_mask_revert-1441"><span class="linenos">1441</span></a><span class="sd">        Reverts data mask to original state</span>
</span><span id="Bar1Dv7.data_mask_revert-1442"><a href="#Bar1Dv7.data_mask_revert-1442"><span class="linenos">1442</span></a>
</span><span id="Bar1Dv7.data_mask_revert-1443"><a href="#Bar1Dv7.data_mask_revert-1443"><span class="linenos">1443</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7.data_mask_revert-1444"><a href="#Bar1Dv7.data_mask_revert-1444"><span class="linenos">1444</span></a><span class="sd">            crange: range of cells to revert mask</span>
</span><span id="Bar1Dv7.data_mask_revert-1445"><a href="#Bar1Dv7.data_mask_revert-1445"><span class="linenos">1445</span></a>
</span><span id="Bar1Dv7.data_mask_revert-1446"><a href="#Bar1Dv7.data_mask_revert-1446"><span class="linenos">1446</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7.data_mask_revert-1447"><a href="#Bar1Dv7.data_mask_revert-1447"><span class="linenos">1447</span></a><span class="sd">            None: sets self.dfs to original data mask</span>
</span><span id="Bar1Dv7.data_mask_revert-1448"><a href="#Bar1Dv7.data_mask_revert-1448"><span class="linenos">1448</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.data_mask_revert-1449"><a href="#Bar1Dv7.data_mask_revert-1449"><span class="linenos">1449</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Nothing to revert&quot;</span>
</span><span id="Bar1Dv7.data_mask_revert-1450"><a href="#Bar1Dv7.data_mask_revert-1450"><span class="linenos">1450</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span><span class="p">)</span>
</span><span id="Bar1Dv7.data_mask_revert-1451"><a href="#Bar1Dv7.data_mask_revert-1451"><span class="linenos">1451</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs_orig</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Reverts data mask to original state</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>crange:</strong>  range of cells to revert mask</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: sets self.dfs to original data mask</p>
</blockquote>
</div>


                            </div>
                            <div id="Bar1Dv7.shift_stim_fixation" class="classattr">
                                        <input id="Bar1Dv7.shift_stim_fixation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">shift_stim_fixation</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">stim</span>, </span><span class="param"><span class="n">shift</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Bar1Dv7.shift_stim_fixation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1Dv7.shift_stim_fixation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1Dv7.shift_stim_fixation-1453"><a href="#Bar1Dv7.shift_stim_fixation-1453"><span class="linenos">1453</span></a>    <span class="k">def</span> <span class="nf">shift_stim_fixation</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
</span><span id="Bar1Dv7.shift_stim_fixation-1454"><a href="#Bar1Dv7.shift_stim_fixation-1454"><span class="linenos">1454</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.shift_stim_fixation-1455"><a href="#Bar1Dv7.shift_stim_fixation-1455"><span class="linenos">1455</span></a><span class="sd">        Simple shift by integer (rounded shift) and zero padded. Note that this is not in </span>
</span><span id="Bar1Dv7.shift_stim_fixation-1456"><a href="#Bar1Dv7.shift_stim_fixation-1456"><span class="linenos">1456</span></a><span class="sd">        is in units of number of bars, rather than -1 to +1. It assumes the stim</span>
</span><span id="Bar1Dv7.shift_stim_fixation-1457"><a href="#Bar1Dv7.shift_stim_fixation-1457"><span class="linenos">1457</span></a><span class="sd">        has a batch dimension (over a fixation), and shifts the whole stim by the same amount.</span>
</span><span id="Bar1Dv7.shift_stim_fixation-1458"><a href="#Bar1Dv7.shift_stim_fixation-1458"><span class="linenos">1458</span></a><span class="sd">        </span>
</span><span id="Bar1Dv7.shift_stim_fixation-1459"><a href="#Bar1Dv7.shift_stim_fixation-1459"><span class="linenos">1459</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7.shift_stim_fixation-1460"><a href="#Bar1Dv7.shift_stim_fixation-1460"><span class="linenos">1460</span></a><span class="sd">            stim: stimulus to shift</span>
</span><span id="Bar1Dv7.shift_stim_fixation-1461"><a href="#Bar1Dv7.shift_stim_fixation-1461"><span class="linenos">1461</span></a><span class="sd">            shift: amount to shift by</span>
</span><span id="Bar1Dv7.shift_stim_fixation-1462"><a href="#Bar1Dv7.shift_stim_fixation-1462"><span class="linenos">1462</span></a>
</span><span id="Bar1Dv7.shift_stim_fixation-1463"><a href="#Bar1Dv7.shift_stim_fixation-1463"><span class="linenos">1463</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7.shift_stim_fixation-1464"><a href="#Bar1Dv7.shift_stim_fixation-1464"><span class="linenos">1464</span></a><span class="sd">            shstim: shifted stimulus</span>
</span><span id="Bar1Dv7.shift_stim_fixation-1465"><a href="#Bar1Dv7.shift_stim_fixation-1465"><span class="linenos">1465</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.shift_stim_fixation-1466"><a href="#Bar1Dv7.shift_stim_fixation-1466"><span class="linenos">1466</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Currently needs to be fixed to work with 2D&#39;</span><span class="p">)</span>
</span><span id="Bar1Dv7.shift_stim_fixation-1467"><a href="#Bar1Dv7.shift_stim_fixation-1467"><span class="linenos">1467</span></a>        <span class="n">sh</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span>
</span><span id="Bar1Dv7.shift_stim_fixation-1468"><a href="#Bar1Dv7.shift_stim_fixation-1468"><span class="linenos">1468</span></a>        <span class="n">shstim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Bar1Dv7.shift_stim_fixation-1469"><a href="#Bar1Dv7.shift_stim_fixation-1469"><span class="linenos">1469</span></a>        <span class="k">if</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7.shift_stim_fixation-1470"><a href="#Bar1Dv7.shift_stim_fixation-1470"><span class="linenos">1470</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="o">-</span><span class="n">sh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="p">:</span><span class="n">sh</span><span class="p">]</span>
</span><span id="Bar1Dv7.shift_stim_fixation-1471"><a href="#Bar1Dv7.shift_stim_fixation-1471"><span class="linenos">1471</span></a>        <span class="k">elif</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7.shift_stim_fixation-1472"><a href="#Bar1Dv7.shift_stim_fixation-1472"><span class="linenos">1472</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="n">sh</span><span class="p">:]</span>
</span><span id="Bar1Dv7.shift_stim_fixation-1473"><a href="#Bar1Dv7.shift_stim_fixation-1473"><span class="linenos">1473</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7.shift_stim_fixation-1474"><a href="#Bar1Dv7.shift_stim_fixation-1474"><span class="linenos">1474</span></a>            <span class="n">shstim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="Bar1Dv7.shift_stim_fixation-1475"><a href="#Bar1Dv7.shift_stim_fixation-1475"><span class="linenos">1475</span></a>
</span><span id="Bar1Dv7.shift_stim_fixation-1476"><a href="#Bar1Dv7.shift_stim_fixation-1476"><span class="linenos">1476</span></a>        <span class="k">return</span> <span class="n">shstim</span>
</span></pre></div>


            <div class="docstring"><p>Simple shift by integer (rounded shift) and zero padded. Note that this is not in 
is in units of number of bars, rather than -1 to +1. It assumes the stim
has a batch dimension (over a fixation), and shifts the whole stim by the same amount.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>stim:</strong>  stimulus to shift</li>
<li><strong>shift:</strong>  amount to shift by</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>shstim: shifted stimulus</p>
</blockquote>
</div>


                            </div>
                            <div id="Bar1Dv7.create_valid_indices" class="classattr">
                                        <input id="Bar1Dv7.create_valid_indices-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_valid_indices</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">post_sacc_gap</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Bar1Dv7.create_valid_indices-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1Dv7.create_valid_indices"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1Dv7.create_valid_indices-1479"><a href="#Bar1Dv7.create_valid_indices-1479"><span class="linenos">1479</span></a>    <span class="k">def</span> <span class="nf">create_valid_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post_sacc_gap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Bar1Dv7.create_valid_indices-1480"><a href="#Bar1Dv7.create_valid_indices-1480"><span class="linenos">1480</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.create_valid_indices-1481"><a href="#Bar1Dv7.create_valid_indices-1481"><span class="linenos">1481</span></a><span class="sd">        This creates self.valid_inds vector that is used for __get_item__ </span>
</span><span id="Bar1Dv7.create_valid_indices-1482"><a href="#Bar1Dv7.create_valid_indices-1482"><span class="linenos">1482</span></a><span class="sd">        -- Will default to num_lags following each saccade beginning</span>
</span><span id="Bar1Dv7.create_valid_indices-1483"><a href="#Bar1Dv7.create_valid_indices-1483"><span class="linenos">1483</span></a><span class="sd">        </span>
</span><span id="Bar1Dv7.create_valid_indices-1484"><a href="#Bar1Dv7.create_valid_indices-1484"><span class="linenos">1484</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7.create_valid_indices-1485"><a href="#Bar1Dv7.create_valid_indices-1485"><span class="linenos">1485</span></a><span class="sd">            post_sacc_gap: number of lags to exclude following saccade</span>
</span><span id="Bar1Dv7.create_valid_indices-1486"><a href="#Bar1Dv7.create_valid_indices-1486"><span class="linenos">1486</span></a>
</span><span id="Bar1Dv7.create_valid_indices-1487"><a href="#Bar1Dv7.create_valid_indices-1487"><span class="linenos">1487</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7.create_valid_indices-1488"><a href="#Bar1Dv7.create_valid_indices-1488"><span class="linenos">1488</span></a><span class="sd">            None: sets self.valid_inds</span>
</span><span id="Bar1Dv7.create_valid_indices-1489"><a href="#Bar1Dv7.create_valid_indices-1489"><span class="linenos">1489</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.create_valid_indices-1490"><a href="#Bar1Dv7.create_valid_indices-1490"><span class="linenos">1490</span></a>
</span><span id="Bar1Dv7.create_valid_indices-1491"><a href="#Bar1Dv7.create_valid_indices-1491"><span class="linenos">1491</span></a>        <span class="k">if</span> <span class="n">post_sacc_gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1Dv7.create_valid_indices-1492"><a href="#Bar1Dv7.create_valid_indices-1492"><span class="linenos">1492</span></a>            <span class="n">post_sacc_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="Bar1Dv7.create_valid_indices-1493"><a href="#Bar1Dv7.create_valid_indices-1493"><span class="linenos">1493</span></a>
</span><span id="Bar1Dv7.create_valid_indices-1494"><a href="#Bar1Dv7.create_valid_indices-1494"><span class="linenos">1494</span></a>        <span class="c1"># first, throw out all data where all data_filters are zero</span>
</span><span id="Bar1Dv7.create_valid_indices-1495"><a href="#Bar1Dv7.create_valid_indices-1495"><span class="linenos">1495</span></a>        <span class="n">is_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="Bar1Dv7.create_valid_indices-1496"><a href="#Bar1Dv7.create_valid_indices-1496"><span class="linenos">1496</span></a>        <span class="n">is_valid</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Bar1Dv7.create_valid_indices-1497"><a href="#Bar1Dv7.create_valid_indices-1497"><span class="linenos">1497</span></a>        
</span><span id="Bar1Dv7.create_valid_indices-1498"><a href="#Bar1Dv7.create_valid_indices-1498"><span class="linenos">1498</span></a>        <span class="c1"># Now invalid post_sacc_gap following saccades</span>
</span><span id="Bar1Dv7.create_valid_indices-1499"><a href="#Bar1Dv7.create_valid_indices-1499"><span class="linenos">1499</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span><span class="p">):</span>
</span><span id="Bar1Dv7.create_valid_indices-1500"><a href="#Bar1Dv7.create_valid_indices-1500"><span class="linenos">1500</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:])</span>
</span><span id="Bar1Dv7.create_valid_indices-1501"><a href="#Bar1Dv7.create_valid_indices-1501"><span class="linenos">1501</span></a>            <span class="n">sts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="Bar1Dv7.create_valid_indices-1502"><a href="#Bar1Dv7.create_valid_indices-1502"><span class="linenos">1502</span></a>            <span class="n">is_valid</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">post_sacc_gap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1Dv7.create_valid_indices-1503"><a href="#Bar1Dv7.create_valid_indices-1503"><span class="linenos">1503</span></a>        
</span><span id="Bar1Dv7.create_valid_indices-1504"><a href="#Bar1Dv7.create_valid_indices-1504"><span class="linenos">1504</span></a>        <span class="c1">#self.valid_inds = list(np.where(is_valid &gt; 0)[0])</span>
</span><span id="Bar1Dv7.create_valid_indices-1505"><a href="#Bar1Dv7.create_valid_indices-1505"><span class="linenos">1505</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_valid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>This creates self.valid_inds vector that is used for __get_item__ 
-- Will default to num_lags following each saccade beginning</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>post_sacc_gap:</strong>  number of lags to exclude following saccade</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: sets self.valid_inds</p>
</blockquote>
</div>


                            </div>
                            <div id="Bar1Dv7.crossval_setup" class="classattr">
                                        <input id="Bar1Dv7.crossval_setup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">crossval_setup</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">folds</span><span class="o">=</span><span class="mi">5</span>, </span><span class="param"><span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">test_set</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Bar1Dv7.crossval_setup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1Dv7.crossval_setup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1Dv7.crossval_setup-1508"><a href="#Bar1Dv7.crossval_setup-1508"><span class="linenos">1508</span></a>    <span class="k">def</span> <span class="nf">crossval_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test_set</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Bar1Dv7.crossval_setup-1509"><a href="#Bar1Dv7.crossval_setup-1509"><span class="linenos">1509</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.crossval_setup-1510"><a href="#Bar1Dv7.crossval_setup-1510"><span class="linenos">1510</span></a><span class="sd">        This sets the cross-validation indices up We can add featuers here. Many ways to do this</span>
</span><span id="Bar1Dv7.crossval_setup-1511"><a href="#Bar1Dv7.crossval_setup-1511"><span class="linenos">1511</span></a><span class="sd">        but will stick to some standard for now. It sets the internal indices, which can be read out</span>
</span><span id="Bar1Dv7.crossval_setup-1512"><a href="#Bar1Dv7.crossval_setup-1512"><span class="linenos">1512</span></a><span class="sd">        directly or with helper functions. Perhaps helper_functions is the best way....</span>
</span><span id="Bar1Dv7.crossval_setup-1513"><a href="#Bar1Dv7.crossval_setup-1513"><span class="linenos">1513</span></a><span class="sd">        </span>
</span><span id="Bar1Dv7.crossval_setup-1514"><a href="#Bar1Dv7.crossval_setup-1514"><span class="linenos">1514</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7.crossval_setup-1515"><a href="#Bar1Dv7.crossval_setup-1515"><span class="linenos">1515</span></a><span class="sd">            folds: number of folds to use</span>
</span><span id="Bar1Dv7.crossval_setup-1516"><a href="#Bar1Dv7.crossval_setup-1516"><span class="linenos">1516</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="Bar1Dv7.crossval_setup-1517"><a href="#Bar1Dv7.crossval_setup-1517"><span class="linenos">1517</span></a><span class="sd">            test_set: whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</span>
</span><span id="Bar1Dv7.crossval_setup-1518"><a href="#Bar1Dv7.crossval_setup-1518"><span class="linenos">1518</span></a><span class="sd">            verbose: whether to print out information</span>
</span><span id="Bar1Dv7.crossval_setup-1519"><a href="#Bar1Dv7.crossval_setup-1519"><span class="linenos">1519</span></a><span class="sd">        </span>
</span><span id="Bar1Dv7.crossval_setup-1520"><a href="#Bar1Dv7.crossval_setup-1520"><span class="linenos">1520</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7.crossval_setup-1521"><a href="#Bar1Dv7.crossval_setup-1521"><span class="linenos">1521</span></a><span class="sd">            None: sets internal variables test_inds, train_inds, val_inds</span>
</span><span id="Bar1Dv7.crossval_setup-1522"><a href="#Bar1Dv7.crossval_setup-1522"><span class="linenos">1522</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.crossval_setup-1523"><a href="#Bar1Dv7.crossval_setup-1523"><span class="linenos">1523</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must first specify valid_indices before setting up cross-validation.&quot;</span>
</span><span id="Bar1Dv7.crossval_setup-1524"><a href="#Bar1Dv7.crossval_setup-1524"><span class="linenos">1524</span></a>
</span><span id="Bar1Dv7.crossval_setup-1525"><a href="#Bar1Dv7.crossval_setup-1525"><span class="linenos">1525</span></a>        <span class="c1"># Reflect block structure</span>
</span><span id="Bar1Dv7.crossval_setup-1526"><a href="#Bar1Dv7.crossval_setup-1526"><span class="linenos">1526</span></a>        <span class="n">Nblks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="Bar1Dv7.crossval_setup-1527"><a href="#Bar1Dv7.crossval_setup-1527"><span class="linenos">1527</span></a>        <span class="n">val_blk1</span><span class="p">,</span> <span class="n">tr_blk1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="n">Nblks</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="Bar1Dv7.crossval_setup-1528"><a href="#Bar1Dv7.crossval_setup-1528"><span class="linenos">1528</span></a>
</span><span id="Bar1Dv7.crossval_setup-1529"><a href="#Bar1Dv7.crossval_setup-1529"><span class="linenos">1529</span></a>        <span class="k">if</span> <span class="n">test_set</span><span class="p">:</span>
</span><span id="Bar1Dv7.crossval_setup-1530"><a href="#Bar1Dv7.crossval_setup-1530"><span class="linenos">1530</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="n">val_blk1</span>
</span><span id="Bar1Dv7.crossval_setup-1531"><a href="#Bar1Dv7.crossval_setup-1531"><span class="linenos">1531</span></a>            <span class="n">val_blk2</span><span class="p">,</span> <span class="n">tr_blk2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_blk1</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="Bar1Dv7.crossval_setup-1532"><a href="#Bar1Dv7.crossval_setup-1532"><span class="linenos">1532</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span><span class="p">[</span><span class="n">val_blk2</span><span class="p">]</span>
</span><span id="Bar1Dv7.crossval_setup-1533"><a href="#Bar1Dv7.crossval_setup-1533"><span class="linenos">1533</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span><span class="p">[</span><span class="n">tr_blk2</span><span class="p">]</span>
</span><span id="Bar1Dv7.crossval_setup-1534"><a href="#Bar1Dv7.crossval_setup-1534"><span class="linenos">1534</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7.crossval_setup-1535"><a href="#Bar1Dv7.crossval_setup-1535"><span class="linenos">1535</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">val_blk1</span>
</span><span id="Bar1Dv7.crossval_setup-1536"><a href="#Bar1Dv7.crossval_setup-1536"><span class="linenos">1536</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">tr_blk1</span>
</span><span id="Bar1Dv7.crossval_setup-1537"><a href="#Bar1Dv7.crossval_setup-1537"><span class="linenos">1537</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1Dv7.crossval_setup-1538"><a href="#Bar1Dv7.crossval_setup-1538"><span class="linenos">1538</span></a>
</span><span id="Bar1Dv7.crossval_setup-1539"><a href="#Bar1Dv7.crossval_setup-1539"><span class="linenos">1539</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Bar1Dv7.crossval_setup-1540"><a href="#Bar1Dv7.crossval_setup-1540"><span class="linenos">1540</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Partitioned </span><span class="si">%d</span><span class="s2"> fixations total: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span>
</span><span id="Bar1Dv7.crossval_setup-1541"><a href="#Bar1Dv7.crossval_setup-1541"><span class="linenos">1541</span></a>                <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">)))</span>  
</span><span id="Bar1Dv7.crossval_setup-1542"><a href="#Bar1Dv7.crossval_setup-1542"><span class="linenos">1542</span></a>
</span><span id="Bar1Dv7.crossval_setup-1543"><a href="#Bar1Dv7.crossval_setup-1543"><span class="linenos">1543</span></a>        <span class="c1"># Now pull indices from each saccade </span>
</span><span id="Bar1Dv7.crossval_setup-1544"><a href="#Bar1Dv7.crossval_setup-1544"><span class="linenos">1544</span></a>        <span class="n">tr_inds</span><span class="p">,</span> <span class="n">te_inds</span><span class="p">,</span> <span class="n">val_inds</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="Bar1Dv7.crossval_setup-1545"><a href="#Bar1Dv7.crossval_setup-1545"><span class="linenos">1545</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">:</span>
</span><span id="Bar1Dv7.crossval_setup-1546"><a href="#Bar1Dv7.crossval_setup-1546"><span class="linenos">1546</span></a>            <span class="n">tr_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="Bar1Dv7.crossval_setup-1547"><a href="#Bar1Dv7.crossval_setup-1547"><span class="linenos">1547</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">:</span>
</span><span id="Bar1Dv7.crossval_setup-1548"><a href="#Bar1Dv7.crossval_setup-1548"><span class="linenos">1548</span></a>            <span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="Bar1Dv7.crossval_setup-1549"><a href="#Bar1Dv7.crossval_setup-1549"><span class="linenos">1549</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span><span class="p">:</span>
</span><span id="Bar1Dv7.crossval_setup-1550"><a href="#Bar1Dv7.crossval_setup-1550"><span class="linenos">1550</span></a>            <span class="n">te_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="Bar1Dv7.crossval_setup-1551"><a href="#Bar1Dv7.crossval_setup-1551"><span class="linenos">1551</span></a>
</span><span id="Bar1Dv7.crossval_setup-1552"><a href="#Bar1Dv7.crossval_setup-1552"><span class="linenos">1552</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Bar1Dv7.crossval_setup-1553"><a href="#Bar1Dv7.crossval_setup-1553"><span class="linenos">1553</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Pre-valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">te_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="Bar1Dv7.crossval_setup-1554"><a href="#Bar1Dv7.crossval_setup-1554"><span class="linenos">1554</span></a>
</span><span id="Bar1Dv7.crossval_setup-1555"><a href="#Bar1Dv7.crossval_setup-1555"><span class="linenos">1555</span></a>        <span class="c1"># Finally intersect with used_inds</span>
</span><span id="Bar1Dv7.crossval_setup-1556"><a href="#Bar1Dv7.crossval_setup-1556"><span class="linenos">1556</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="Bar1Dv7.crossval_setup-1557"><a href="#Bar1Dv7.crossval_setup-1557"><span class="linenos">1557</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">val_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="Bar1Dv7.crossval_setup-1558"><a href="#Bar1Dv7.crossval_setup-1558"><span class="linenos">1558</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">te_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)))</span>
</span><span id="Bar1Dv7.crossval_setup-1559"><a href="#Bar1Dv7.crossval_setup-1559"><span class="linenos">1559</span></a>
</span><span id="Bar1Dv7.crossval_setup-1560"><a href="#Bar1Dv7.crossval_setup-1560"><span class="linenos">1560</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Bar1Dv7.crossval_setup-1561"><a href="#Bar1Dv7.crossval_setup-1561"><span class="linenos">1561</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span><span class="p">))</span> <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This sets the cross-validation indices up We can add featuers here. Many ways to do this
but will stick to some standard for now. It sets the internal indices, which can be read out
directly or with helper functions. Perhaps helper_functions is the best way....</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>folds:</strong>  number of folds to use</li>
<li><strong>random_gen:</strong>  whether to pick random fixations for validation or uniformly distributed</li>
<li><strong>test_set:</strong>  whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</li>
<li><strong>verbose:</strong>  whether to print out information</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: sets internal variables test_inds, train_inds, val_inds</p>
</blockquote>
</div>


                            </div>
                            <div id="Bar1Dv7.fold_sample" class="classattr">
                                        <input id="Bar1Dv7.fold_sample-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fold_sample</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">num_items</span>, </span><span class="param"><span class="n">folds</span>, </span><span class="param"><span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Bar1Dv7.fold_sample-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1Dv7.fold_sample"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1Dv7.fold_sample-1565"><a href="#Bar1Dv7.fold_sample-1565"><span class="linenos">1565</span></a>    <span class="k">def</span> <span class="nf">fold_sample</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Bar1Dv7.fold_sample-1566"><a href="#Bar1Dv7.fold_sample-1566"><span class="linenos">1566</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.fold_sample-1567"><a href="#Bar1Dv7.fold_sample-1567"><span class="linenos">1567</span></a><span class="sd">        This really should be a general method not associated with self</span>
</span><span id="Bar1Dv7.fold_sample-1568"><a href="#Bar1Dv7.fold_sample-1568"><span class="linenos">1568</span></a><span class="sd">        </span>
</span><span id="Bar1Dv7.fold_sample-1569"><a href="#Bar1Dv7.fold_sample-1569"><span class="linenos">1569</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7.fold_sample-1570"><a href="#Bar1Dv7.fold_sample-1570"><span class="linenos">1570</span></a><span class="sd">            num_items: number of items to fold</span>
</span><span id="Bar1Dv7.fold_sample-1571"><a href="#Bar1Dv7.fold_sample-1571"><span class="linenos">1571</span></a><span class="sd">            folds: number of folds</span>
</span><span id="Bar1Dv7.fold_sample-1572"><a href="#Bar1Dv7.fold_sample-1572"><span class="linenos">1572</span></a><span class="sd">            random_gen: whether to randomly sample or uniformly sample</span>
</span><span id="Bar1Dv7.fold_sample-1573"><a href="#Bar1Dv7.fold_sample-1573"><span class="linenos">1573</span></a>
</span><span id="Bar1Dv7.fold_sample-1574"><a href="#Bar1Dv7.fold_sample-1574"><span class="linenos">1574</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7.fold_sample-1575"><a href="#Bar1Dv7.fold_sample-1575"><span class="linenos">1575</span></a><span class="sd">            val_items: indices for validation set</span>
</span><span id="Bar1Dv7.fold_sample-1576"><a href="#Bar1Dv7.fold_sample-1576"><span class="linenos">1576</span></a><span class="sd">            rem_items: indices for remaining set</span>
</span><span id="Bar1Dv7.fold_sample-1577"><a href="#Bar1Dv7.fold_sample-1577"><span class="linenos">1577</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.fold_sample-1578"><a href="#Bar1Dv7.fold_sample-1578"><span class="linenos">1578</span></a>        <span class="k">if</span> <span class="n">random_gen</span><span class="p">:</span>
</span><span id="Bar1Dv7.fold_sample-1579"><a href="#Bar1Dv7.fold_sample-1579"><span class="linenos">1579</span></a>            <span class="n">num_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_items</span><span class="o">/</span><span class="n">folds</span><span class="p">)</span>
</span><span id="Bar1Dv7.fold_sample-1580"><a href="#Bar1Dv7.fold_sample-1580"><span class="linenos">1580</span></a>            <span class="n">tmp_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">num_items</span><span class="p">)</span>
</span><span id="Bar1Dv7.fold_sample-1581"><a href="#Bar1Dv7.fold_sample-1581"><span class="linenos">1581</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[:</span><span class="n">num_val</span><span class="p">])</span>
</span><span id="Bar1Dv7.fold_sample-1582"><a href="#Bar1Dv7.fold_sample-1582"><span class="linenos">1582</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[</span><span class="n">num_val</span><span class="p">:])</span>
</span><span id="Bar1Dv7.fold_sample-1583"><a href="#Bar1Dv7.fold_sample-1583"><span class="linenos">1583</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7.fold_sample-1584"><a href="#Bar1Dv7.fold_sample-1584"><span class="linenos">1584</span></a>            <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">folds</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="Bar1Dv7.fold_sample-1585"><a href="#Bar1Dv7.fold_sample-1585"><span class="linenos">1585</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
</span><span id="Bar1Dv7.fold_sample-1586"><a href="#Bar1Dv7.fold_sample-1586"><span class="linenos">1586</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">),</span> <span class="n">val_items</span><span class="p">)</span>
</span><span id="Bar1Dv7.fold_sample-1587"><a href="#Bar1Dv7.fold_sample-1587"><span class="linenos">1587</span></a>        <span class="k">return</span> <span class="n">val_items</span><span class="p">,</span> <span class="n">rem_items</span>
</span></pre></div>


            <div class="docstring"><p>This really should be a general method not associated with self</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>num_items:</strong>  number of items to fold</li>
<li><strong>folds:</strong>  number of folds</li>
<li><strong>random_gen:</strong>  whether to randomly sample or uniformly sample</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>val_items: indices for validation set
  rem_items: indices for remaining set</p>
</blockquote>
</div>


                            </div>
                            <div id="Bar1Dv7.adjust_Xdrift_xval" class="classattr">
                                        <input id="Bar1Dv7.adjust_Xdrift_xval-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">adjust_Xdrift_xval</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Bar1Dv7.adjust_Xdrift_xval-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1Dv7.adjust_Xdrift_xval"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1Dv7.adjust_Xdrift_xval-1589"><a href="#Bar1Dv7.adjust_Xdrift_xval-1589"><span class="linenos">1589</span></a>    <span class="k">def</span> <span class="nf">adjust_Xdrift_xval</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="Bar1Dv7.adjust_Xdrift_xval-1590"><a href="#Bar1Dv7.adjust_Xdrift_xval-1590"><span class="linenos">1590</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.adjust_Xdrift_xval-1591"><a href="#Bar1Dv7.adjust_Xdrift_xval-1591"><span class="linenos">1591</span></a><span class="sd">        Adjust drift matrix to not fit xval parameterz</span>
</span><span id="Bar1Dv7.adjust_Xdrift_xval-1592"><a href="#Bar1Dv7.adjust_Xdrift_xval-1592"><span class="linenos">1592</span></a>
</span><span id="Bar1Dv7.adjust_Xdrift_xval-1593"><a href="#Bar1Dv7.adjust_Xdrift_xval-1593"><span class="linenos">1593</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7.adjust_Xdrift_xval-1594"><a href="#Bar1Dv7.adjust_Xdrift_xval-1594"><span class="linenos">1594</span></a><span class="sd">            None</span>
</span><span id="Bar1Dv7.adjust_Xdrift_xval-1595"><a href="#Bar1Dv7.adjust_Xdrift_xval-1595"><span class="linenos">1595</span></a>
</span><span id="Bar1Dv7.adjust_Xdrift_xval-1596"><a href="#Bar1Dv7.adjust_Xdrift_xval-1596"><span class="linenos">1596</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7.adjust_Xdrift_xval-1597"><a href="#Bar1Dv7.adjust_Xdrift_xval-1597"><span class="linenos">1597</span></a><span class="sd">            None: sets self.Xdrift to new matrix</span>
</span><span id="Bar1Dv7.adjust_Xdrift_xval-1598"><a href="#Bar1Dv7.adjust_Xdrift_xval-1598"><span class="linenos">1598</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.adjust_Xdrift_xval-1599"><a href="#Bar1Dv7.adjust_Xdrift_xval-1599"><span class="linenos">1599</span></a>        <span class="n">Xnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span><span class="p">]</span>
</span><span id="Bar1Dv7.adjust_Xdrift_xval-1600"><a href="#Bar1Dv7.adjust_Xdrift_xval-1600"><span class="linenos">1600</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">)):</span>
</span><span id="Bar1Dv7.adjust_Xdrift_xval-1601"><a href="#Bar1Dv7.adjust_Xdrift_xval-1601"><span class="linenos">1601</span></a>            <span class="n">newpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">ii</span> <span class="c1"># this will be where lower range is</span>
</span><span id="Bar1Dv7.adjust_Xdrift_xval-1602"><a href="#Bar1Dv7.adjust_Xdrift_xval-1602"><span class="linenos">1602</span></a>            <span class="k">if</span> <span class="n">newpos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7.adjust_Xdrift_xval-1603"><a href="#Bar1Dv7.adjust_Xdrift_xval-1603"><span class="linenos">1603</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="Bar1Dv7.adjust_Xdrift_xval-1604"><a href="#Bar1Dv7.adjust_Xdrift_xval-1604"><span class="linenos">1604</span></a>            <span class="k">elif</span> <span class="n">newpos</span> <span class="o">==</span> <span class="n">Xnew</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="Bar1Dv7.adjust_Xdrift_xval-1605"><a href="#Bar1Dv7.adjust_Xdrift_xval-1605"><span class="linenos">1605</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="Bar1Dv7.adjust_Xdrift_xval-1606"><a href="#Bar1Dv7.adjust_Xdrift_xval-1606"><span class="linenos">1606</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># In between</span>
</span><span id="Bar1Dv7.adjust_Xdrift_xval-1607"><a href="#Bar1Dv7.adjust_Xdrift_xval-1607"><span class="linenos">1607</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span> <span class="n">newpos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="Bar1Dv7.adjust_Xdrift_xval-1608"><a href="#Bar1Dv7.adjust_Xdrift_xval-1608"><span class="linenos">1608</span></a>                <span class="n">Xnew</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span> <span class="n">newpos</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="Bar1Dv7.adjust_Xdrift_xval-1609"><a href="#Bar1Dv7.adjust_Xdrift_xval-1609"><span class="linenos">1609</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">Xnew</span>
</span></pre></div>


            <div class="docstring"><p>Adjust drift matrix to not fit xval parameterz</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li>None</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: sets self.Xdrift to new matrix</p>
</blockquote>
</div>


                            </div>
                            <div id="Bar1Dv7.get_max_samples" class="classattr">
                                        <input id="Bar1Dv7.get_max_samples-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_max_samples</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">gpu_n</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">history_size</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="n">nquad</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">buffer</span><span class="o">=</span><span class="mf">1.2</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Bar1Dv7.get_max_samples-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1Dv7.get_max_samples"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1Dv7.get_max_samples-1612"><a href="#Bar1Dv7.get_max_samples-1612"><span class="linenos">1612</span></a>    <span class="k">def</span> <span class="nf">get_max_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpu_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nquad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mf">1.2</span><span class="p">):</span>
</span><span id="Bar1Dv7.get_max_samples-1613"><a href="#Bar1Dv7.get_max_samples-1613"><span class="linenos">1613</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.get_max_samples-1614"><a href="#Bar1Dv7.get_max_samples-1614"><span class="linenos">1614</span></a><span class="sd">        get the maximum number of samples that fit in memory -- for GLM/GQM x LBFGS</span>
</span><span id="Bar1Dv7.get_max_samples-1615"><a href="#Bar1Dv7.get_max_samples-1615"><span class="linenos">1615</span></a>
</span><span id="Bar1Dv7.get_max_samples-1616"><a href="#Bar1Dv7.get_max_samples-1616"><span class="linenos">1616</span></a><span class="sd">        Args:</span>
</span><span id="Bar1Dv7.get_max_samples-1617"><a href="#Bar1Dv7.get_max_samples-1617"><span class="linenos">1617</span></a><span class="sd">            gpu_n: which gpu to use</span>
</span><span id="Bar1Dv7.get_max_samples-1618"><a href="#Bar1Dv7.get_max_samples-1618"><span class="linenos">1618</span></a><span class="sd">            history_size: number of time lags</span>
</span><span id="Bar1Dv7.get_max_samples-1619"><a href="#Bar1Dv7.get_max_samples-1619"><span class="linenos">1619</span></a><span class="sd">            nquad: number of quadrature points</span>
</span><span id="Bar1Dv7.get_max_samples-1620"><a href="#Bar1Dv7.get_max_samples-1620"><span class="linenos">1620</span></a><span class="sd">            num_cells: number of cells to use</span>
</span><span id="Bar1Dv7.get_max_samples-1621"><a href="#Bar1Dv7.get_max_samples-1621"><span class="linenos">1621</span></a><span class="sd">            buffer: buffer to leave for other memory</span>
</span><span id="Bar1Dv7.get_max_samples-1622"><a href="#Bar1Dv7.get_max_samples-1622"><span class="linenos">1622</span></a>
</span><span id="Bar1Dv7.get_max_samples-1623"><a href="#Bar1Dv7.get_max_samples-1623"><span class="linenos">1623</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1Dv7.get_max_samples-1624"><a href="#Bar1Dv7.get_max_samples-1624"><span class="linenos">1624</span></a><span class="sd">            maxsamples: maximum number of samples that can fit in memory</span>
</span><span id="Bar1Dv7.get_max_samples-1625"><a href="#Bar1Dv7.get_max_samples-1625"><span class="linenos">1625</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1Dv7.get_max_samples-1626"><a href="#Bar1Dv7.get_max_samples-1626"><span class="linenos">1626</span></a>        <span class="k">if</span> <span class="n">gpu_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1Dv7.get_max_samples-1627"><a href="#Bar1Dv7.get_max_samples-1627"><span class="linenos">1627</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
</span><span id="Bar1Dv7.get_max_samples-1628"><a href="#Bar1Dv7.get_max_samples-1628"><span class="linenos">1628</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1Dv7.get_max_samples-1629"><a href="#Bar1Dv7.get_max_samples-1629"><span class="linenos">1629</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:1&#39;</span><span class="p">)</span>
</span><span id="Bar1Dv7.get_max_samples-1630"><a href="#Bar1Dv7.get_max_samples-1630"><span class="linenos">1630</span></a>
</span><span id="Bar1Dv7.get_max_samples-1631"><a href="#Bar1Dv7.get_max_samples-1631"><span class="linenos">1631</span></a>        <span class="k">if</span> <span class="n">num_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1Dv7.get_max_samples-1632"><a href="#Bar1Dv7.get_max_samples-1632"><span class="linenos">1632</span></a>            <span class="n">num_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span>
</span><span id="Bar1Dv7.get_max_samples-1633"><a href="#Bar1Dv7.get_max_samples-1633"><span class="linenos">1633</span></a>        
</span><span id="Bar1Dv7.get_max_samples-1634"><a href="#Bar1Dv7.get_max_samples-1634"><span class="linenos">1634</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">total_memory</span>
</span><span id="Bar1Dv7.get_max_samples-1635"><a href="#Bar1Dv7.get_max_samples-1635"><span class="linenos">1635</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_reserved</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7.get_max_samples-1636"><a href="#Bar1Dv7.get_max_samples-1636"><span class="linenos">1636</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_allocated</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1Dv7.get_max_samples-1637"><a href="#Bar1Dv7.get_max_samples-1637"><span class="linenos">1637</span></a>        <span class="n">free</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">r</span><span class="p">)</span>
</span><span id="Bar1Dv7.get_max_samples-1638"><a href="#Bar1Dv7.get_max_samples-1638"><span class="linenos">1638</span></a>
</span><span id="Bar1Dv7.get_max_samples-1639"><a href="#Bar1Dv7.get_max_samples-1639"><span class="linenos">1639</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1Dv7.get_max_samples-1640"><a href="#Bar1Dv7.get_max_samples-1640"><span class="linenos">1640</span></a>        <span class="n">mempersample</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span>
</span><span id="Bar1Dv7.get_max_samples-1641"><a href="#Bar1Dv7.get_max_samples-1641"><span class="linenos">1641</span></a>    
</span><span id="Bar1Dv7.get_max_samples-1642"><a href="#Bar1Dv7.get_max_samples-1642"><span class="linenos">1642</span></a>        <span class="n">mempercell</span> <span class="o">=</span> <span class="n">mempersample</span> <span class="o">*</span> <span class="p">(</span><span class="n">nquad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">history_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Bar1Dv7.get_max_samples-1643"><a href="#Bar1Dv7.get_max_samples-1643"><span class="linenos">1643</span></a>        <span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">*</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span>
</span><span id="Bar1Dv7.get_max_samples-1644"><a href="#Bar1Dv7.get_max_samples-1644"><span class="linenos">1644</span></a>
</span><span id="Bar1Dv7.get_max_samples-1645"><a href="#Bar1Dv7.get_max_samples-1645"><span class="linenos">1645</span></a>        <span class="n">maxsamples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">free</span> <span class="o">-</span> <span class="n">mempercell</span><span class="o">*</span><span class="n">num_cells</span> <span class="o">-</span> <span class="n">buffer_bytes</span><span class="p">)</span> <span class="o">//</span> <span class="n">mempersample</span>
</span><span id="Bar1Dv7.get_max_samples-1646"><a href="#Bar1Dv7.get_max_samples-1646"><span class="linenos">1646</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# samples that can fit on device: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxsamples</span><span class="p">))</span>
</span><span id="Bar1Dv7.get_max_samples-1647"><a href="#Bar1Dv7.get_max_samples-1647"><span class="linenos">1647</span></a>        <span class="k">return</span> <span class="n">maxsamples</span>
</span></pre></div>


            <div class="docstring"><p>get the maximum number of samples that fit in memory -- for GLM/GQM x LBFGS</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>gpu_n:</strong>  which gpu to use</li>
<li><strong>history_size:</strong>  number of time lags</li>
<li><strong>nquad:</strong>  number of quadrature points</li>
<li><strong>num_cells:</strong>  number of cells to use</li>
<li><strong>buffer:</strong>  buffer to leave for other memory</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>maxsamples: maximum number of samples that can fit in memory</p>
</blockquote>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>
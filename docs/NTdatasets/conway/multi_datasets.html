<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.6.0"/>
    <title>NTdatasets.conway.multi_datasets API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../conway.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;NTdatasets.conway</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#MultiClouds">MultiClouds</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#MultiClouds.__init__">MultiClouds</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.time_embed">time_embed</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.Nexpts">Nexpts</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.eye_config">eye_config</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.eye_contiguous">eye_contiguous</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.binocular">binocular</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.luminance_only">luminance_only</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.includeMUs">includeMUs</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.generate_Xfix">generate_Xfix</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.output_separate_eye_stim">output_separate_eye_stim</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.expt_stims">expt_stims</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.L">L</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.LMS">LMS</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.start_t">start_t</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.drift_interval">drift_interval</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.used_inds">used_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.NT">NT</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.fhandles">fhandles</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.file_info">file_info</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.fileNT">fileNT</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.fileNBLK">fileNBLK</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.fileNC">fileNC</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.fileNA">fileNA</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.file_tstart">file_tstart</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.file_blkstart">file_blkstart</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.tranges">tranges</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.cranges">cranges</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.block_inds">block_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.NC">NC</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.sacc_inds">sacc_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiClouds.stim_shifts">stim_shifts</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.read_file_info">read_file_info</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.modify_included_cells">modify_included_cells</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.generate_array_cell_list">generate_array_cell_list</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.assemble_robs">assemble_robs</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.list_expts">list_expts</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.updateDF">updateDF</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.trialfilter_dfs">trialfilter_dfs</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.assemble_saccade_inds">assemble_saccade_inds</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.is_fixpoint_present">is_fixpoint_present</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.build_stim">build_stim</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.assemble_stim">assemble_stim</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.time_embedding">time_embedding</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.rectangle_overlap_ranges">rectangle_overlap_ranges</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.crop_stim">crop_stim</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.draw_stim_locations">draw_stim_locations</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.avrates">avrates</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.shift_stim_oldstyle">shift_stim_oldstyle</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.process_fixations">process_fixations</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.shift_stim">shift_stim</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.shift_im">shift_im</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.get_max_samples">get_max_samples</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiClouds.preload_numpy">preload_numpy</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../NTdatasets.html">NTdatasets</a><wbr>.<a href="./../conway.html">conway</a><wbr>.multi_datasets    </h1>

                
                        <input id="mod-multi_datasets-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-multi_datasets-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="c1">#from inspect import BlockFinder</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="c1">#import scipy.io as sio</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="c1">#from torch.utils.data import Dataset</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">import</span> <span class="nn">NDNT.utils</span> <span class="k">as</span> <span class="nn">utils</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="c1">#from NDNT.utils import download_file, ensure_dir</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">import</span> <span class="nn">h5py</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">from</span> <span class="nn">NTdatasets.sensory_base</span> <span class="kn">import</span> <span class="n">SensoryBase</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">from</span> <span class="nn">NTdatasets.generic</span> <span class="kn">import</span> <span class="n">GenericDataset</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="k">class</span> <span class="nc">MultiClouds</span><span class="p">(</span><span class="n">SensoryBase</span><span class="p">):</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="sd">    -- can load batches from multiple datasets</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="sd">    -- hdf5 files must have the following information:</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="sd">        Robs</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="sd">        RobsMU</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="sd">        stim: 4-d stimulus: time x nx x ny x color</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="sd">        block_inds: start and stop of &#39;trials&#39; (perhaps fixations for now)</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="sd">        other things: saccades? or should that be in trials? </span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="sd">    Constructor will take eye position, which for now is an input from data</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="sd">    generated in the session (not on disk). It should have the length size </span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="sd">    of the total number of fixations x1.</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="sd">    Input arguments (details):</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="sd">        stim_crop = None, should be of form [x1, x2, y1, y2] where each number is the </span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="sd">            extreme point to be include as an index, e.g. range(x1, x2+1), ... </span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a>        <span class="n">filenames</span><span class="p">,</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>        <span class="n">datadir</span><span class="p">,</span> 
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a>        <span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a>        <span class="n">include_MUs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a>        <span class="n">drift_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>        <span class="n">trial_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a>        <span class="n">luminance_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a>        <span class="n">LMS</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>        <span class="n">binocular</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># whether to include separate filters for each eye</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>        <span class="n">eye_config</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># 0 = all, 1, 2, and 3 are options (3 = binocular)</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>        <span class="n">eye_contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># whether to only use eye_config data that is contiguous </span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>        <span class="n">cell_lists</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a>        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a><span class="sd">        Constructor options</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="sd">        </span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="sd">        Args:</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="sd">            filenames (list): list of strings of the filenames to be loaded</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="sd">            datadir (str): directory where the data is stored</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="sd">            num_lags (int): number of lags to include in the stimulus</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="sd">            include_MUs (bool): whether to include multi-units in the dataset</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="sd">            drift_interval (int): number of blocks to include in the drift term</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="sd">            trial_sample (bool): whether to sample trials for train/val/test</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="sd">            luminance_only (bool): whether to only include luminance in the stimulus</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="sd">            binocular (bool): whether to include separate filters for each eye</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="sd">            eye_config (int): which eye configuration to use (0=all, 1=left, 2=right, 3=binocular)</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="sd">            eye_contiguous (bool): whether to only use contiguous eye configurations</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a><span class="sd">            cell_lists (list): list of lists of cell indices to include in the dataset</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="sd">            device (torch.device): device to store the data on</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>            <span class="n">filenames</span><span class="o">=</span><span class="n">filenames</span><span class="p">,</span> <span class="n">datadir</span><span class="o">=</span><span class="n">datadir</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>            <span class="n">time_embed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">num_lags</span><span class="p">,</span> <span class="n">include_MUs</span><span class="o">=</span><span class="n">include_MUs</span><span class="p">,</span> 
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>            <span class="n">drift_interval</span><span class="o">=</span><span class="n">drift_interval</span><span class="p">,</span> <span class="n">trial_sample</span><span class="o">=</span><span class="n">trial_sample</span><span class="p">)</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>        <span class="c1"># Done in parent constructor</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>        <span class="c1">#self.datadir = datadir</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>        <span class="c1">#self.filenames = filenames</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>        <span class="c1">#self.device = device</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>        <span class="c1">#self.num_lags = 10  # default: to be set later</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>        <span class="c1">#if time_embed == 2:</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>        <span class="c1">#    assert preload, &quot;Cannot pre-time-embed without preloading.&quot;</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># not set</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>        <span class="c1">#self.preload = preload</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>        <span class="c1"># Stim-specific</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">=</span> <span class="n">eye_config</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eye_contiguous</span> <span class="o">=</span> <span class="n">eye_contiguous</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span> <span class="o">=</span> <span class="n">binocular</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span> <span class="o">=</span> <span class="n">luminance_only</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">includeMUs</span> <span class="o">=</span> <span class="n">include_MUs</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_Xfix</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_separate_eye_stim</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">expt_stims</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">LMS</span> <span class="o">=</span> <span class="n">LMS</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>        
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span> <span class="o">=</span> <span class="n">drift_interval</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>        <span class="c1"># Set up to store default train_, val_, test_inds -- in SensoryBase</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>        <span class="c1">#self.test_inds = None</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>        <span class="c1">#self.val_inds = None</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>        <span class="c1">#self.train_inds = None</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>        <span class="c1">#self.used_inds = []</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>        <span class="c1"># Data to construct and store in memory -- some in SensoryBase</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>        <span class="c1">#self.stim = []</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>        <span class="c1">#self.dfs = []</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>        <span class="c1">#self.robs = []</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>        <span class="c1"># build index map -- exclude variables already set in sensory-base</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>        <span class="c1">#self.num_blks = np.zeros(len(filenames), dtype=int)</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>        <span class="c1">#self.file_index = [] # which file the block corresponds to</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>        <span class="c1">#self.stim_dims = None</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>        <span class="c1">#self.unit_ids = []</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>        <span class="c1">#self.num_units, self.num_SUs, self.num_MUs = [], [], []</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>        <span class="c1">#self.SUs = []</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>        <span class="c1">#self.NC = 0    </span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>        <span class="c1">#self.block_inds = []</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>        <span class="c1">#self.block_filemapping = []</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>        <span class="c1">#self.include_MUs = include_MUs</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>        <span class="c1">#self.SUinds = []</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>        <span class="c1">#self.MUinds = []</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>        <span class="c1">#self.cells_out = []  # can be list to output specific cells in get_item</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>        <span class="c1">#self.avRs = None</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">sess</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fileNBLK</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fileNA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="c1"># for the drift term</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_tstart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_blkstart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>        <span class="n">tcount</span><span class="p">,</span> <span class="n">blkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tranges</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>        <span class="c1"># Structure of file on time/trial level</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a> 
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">):</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>            <span class="c1"># get hdf5 file handles</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file_info</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">filenames</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NSUs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NMUs&#39;</span><span class="p">]</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NSUs&#39;</span><span class="p">]</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>            <span class="c1"># Consolidate valid t-ranges based on binocular choice</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;tmap&#39;</span><span class="p">]</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>            <span class="c1"># Make one long block-list</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>            <span class="n">NBLK</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;trial_info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NBLK</span><span class="p">):</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> 
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>                    <span class="n">tcount</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;trial_info&#39;</span><span class="p">][</span><span class="n">bb</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;trial_info&#39;</span><span class="p">][</span><span class="n">bb</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fileNBLK</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;trial_info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">file_blkstart</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">blkcount</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>            <span class="n">blkcount</span> <span class="o">+=</span> <span class="n">NBLK</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NT&#39;</span><span class="p">]</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">file_tstart</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">tcount</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>            <span class="n">tcount</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NT&#39;</span><span class="p">]</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>        <span class="c1"># Assemble robs and dfs given current information</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">=</span> <span class="n">tcount</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">)</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> total time steps, </span><span class="si">%d</span><span class="s2"> units&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>        <span class="k">if</span> <span class="n">cell_lists</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">modify_included_cells</span><span class="p">(</span><span class="n">cell_lists</span><span class="p">)</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>            <span class="c1"># this will automatically assemble_robs at the end</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">assemble_robs</span><span class="p">()</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a> 
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>        <span class="c1"># Assemble current list of fixations</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_shifts</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>        <span class="n">to_assemble</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">):</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>            <span class="n">sacc_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;sacc_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sacc_inds</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># assume its no good</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>                <span class="n">sacc_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>                <span class="n">to_assemble</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sacc_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>                    <span class="n">sacc_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># convert to python so range works</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>                    <span class="n">sacc_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>                    <span class="n">to_assemble</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sacc_inds</span><span class="p">)</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>        <span class="c1">#if to_assemble:</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>        <span class="c1">#    self.assemble_saccade_inds()</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>        <span class="c1">### Construct drift term if relevant</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>            <span class="n">Nanchors_tot</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>            <span class="c1"># Make drift for each dataset</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>            <span class="n">Xdrift_expts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>            <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">):</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>                <span class="n">NBL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileNBLK</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>                <span class="n">Nanchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">NBL</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>                <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>                <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">):</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>                    <span class="n">anchors</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span><span class="o">*</span><span class="n">bb</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>                <span class="c1">#self.Xdrift = utils.design_matrix_drift( self.NT, anchors, zero_left=False, const_right=True)</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>                <span class="n">Xdrift_expts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fileNA</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">Nanchors</span> <span class="c1"># store the number of anchors for each file</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>                <span class="n">Nanchors_tot</span> <span class="o">+=</span> <span class="n">Nanchors</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>            <span class="c1"># Assemble whole drift matrix</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">Nanchors_tot</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>            <span class="n">anchor_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>            <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">):</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>                <span class="n">tslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="n">Nanchors_tot</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>                <span class="n">tslice</span><span class="p">[:,</span> <span class="n">anchor_count</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Xdrift_expts</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="n">Xdrift_expts</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">file_tstart</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">ff</span><span class="p">]),</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tslice</span><span class="p">)</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>                <span class="n">anchor_count</span> <span class="o">+=</span> <span class="n">Xdrift_expts</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>        <span class="c1"># set up train, val and test inds and blks</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crossval_setup</span><span class="p">(</span><span class="n">test_set</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>    <span class="c1"># END MultiClouds.__init__</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>    <span class="k">def</span> <span class="nf">read_file_info</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">file_n</span><span class="p">,</span> <span class="n">filename</span> <span class="p">):</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a><span class="sd">        Initial processing of each file to pull out salient info for building stim and responses</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a><span class="sd">        </span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a><span class="sd">        Args:</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a><span class="sd">            file_n (int): index of the file</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a><span class="sd">            filename (str): name of the file</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a><span class="sd">        Returns:</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a><span class="sd">            dict: dictionary of file information</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">file_n</span><span class="p">]</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>        <span class="n">NT</span><span class="p">,</span> <span class="n">NSUs</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>        <span class="c1"># Check for valid RobsMU</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>            <span class="n">NMUs</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>            <span class="n">NMUs</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>        <span class="c1"># Unit information</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>        <span class="n">channel_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Robs_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>        <span class="n">channel_ratings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Robs_rating&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">NMUs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeMUs</span><span class="p">:</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>            <span class="n">channel_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> 
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>                <span class="p">(</span><span class="n">channel_map</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;RobsMU_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>            <span class="n">channel_ratings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> 
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>                <span class="p">(</span><span class="n">channel_ratings</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;RobsMU_rating&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>        <span class="c1"># Block information</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>        <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;block_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>        <span class="n">blk_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># convert to python so range works</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>        <span class="c1"># Check to make sure not inverted blk_inds (older version of data)</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>        <span class="k">if</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: blk_inds is stored old-style: transposing&#39;</span><span class="p">)</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>        <span class="n">NBLK</span> <span class="o">=</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>        <span class="c1"># Stim information</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>        <span class="n">fix_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;fix_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>        <span class="n">fix_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;fix_size&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>        <span class="n">stim_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;stimscale&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>        <span class="n">stim_locsLP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;stim_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_locsLP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># then list of arrays for some reason</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  FILE_INFO: stim_locsLP list again -- ok but output check&#39;</span><span class="p">)</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>            <span class="n">stim_locsLP</span> <span class="o">=</span> <span class="n">stim_locsLP</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>        <span class="n">stim_locsET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;ETstim_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>        <span class="n">blockIDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;blockID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>  <span class="c1"># what is this?</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>        <span class="c1">#self.ETtrace = np.array(f[&#39;ETtrace&#39;], dtype=np.float32)</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>        <span class="c1">#self.ETtraceHR = np.array(f[&#39;ETtrace_raw&#39;], dtype=np.float32)</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>        <span class="c1"># Binocular information</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>        <span class="n">Lpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;useLeye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>        <span class="n">Rpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>        <span class="n">LRpresent</span> <span class="o">=</span> <span class="n">Lpresent</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Rpresent</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>        <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;valid_data&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>  <span class="c1">#range(self.NT)  # default -- to be changed at end of init</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>        <span class="c1"># Parse timing and block information given eye_config</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>            <span class="n">tmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NT</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>            <span class="n">bmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NBLK</span><span class="p">)</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>            <span class="n">block_inds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">)</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>            <span class="n">tmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LRpresent</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>            <span class="c1"># Check for contiguous option (throw away disjoint eye config)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_contiguous</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>                <span class="n">tbreaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tmap</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbreaks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Disjoint data exists with this eye_config -- trunctating to first section.&quot;</span><span class="p">)</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>                    <span class="n">tmap</span> <span class="o">=</span> <span class="n">tmap</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">tbreaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>            <span class="c1"># Remap valid_inds to smaller trange -- does not use val_track: just temp variable</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>            <span class="n">val_track</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>            <span class="n">val_track</span><span class="p">[</span><span class="n">valid_inds</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>            <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">val_track</span><span class="p">[</span><span class="n">tmap</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>            <span class="n">NT</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmap</span><span class="p">)</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a> 
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>            <span class="c1"># Remap block_inds to reduced map</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>            <span class="n">bmap</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>            <span class="n">tcount</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>            <span class="n">block_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NBLK</span><span class="p">):</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>                <span class="k">if</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">tmap</span><span class="p">:</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>                    <span class="n">bmap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>                    <span class="n">NTblk</span> <span class="o">=</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">blk_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>                    <span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">tcount</span><span class="p">,</span> <span class="n">tcount</span><span class="o">+</span><span class="n">NTblk</span><span class="p">])</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>                    <span class="n">tcount</span> <span class="o">+=</span> <span class="n">NTblk</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>            <span class="n">block_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">block_inds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>            <span class="c1"># might have to modify blockIDs -- not done yet</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>            <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>            <span class="s1">&#39;NT&#39;</span><span class="p">:</span> <span class="n">NT</span><span class="p">,</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>            <span class="s1">&#39;tmap&#39;</span><span class="p">:</span> <span class="n">tmap</span><span class="p">,</span> 
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>            <span class="s1">&#39;trial_info&#39;</span><span class="p">:</span> <span class="n">block_inds</span><span class="p">,</span> 
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>            <span class="s1">&#39;LRpresent&#39;</span><span class="p">:</span> <span class="n">LRpresent</span><span class="p">,</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>            <span class="s1">&#39;valid_inds&#39;</span><span class="p">:</span> <span class="n">valid_inds</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>            <span class="s1">&#39;blockIDs&#39;</span><span class="p">:</span> <span class="n">blockIDs</span><span class="p">,</span> <span class="c1"># What is this again?  </span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>            <span class="s1">&#39;NSUs&#39;</span><span class="p">:</span> <span class="n">NSUs</span><span class="p">,</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>            <span class="s1">&#39;NMUs&#39;</span><span class="p">:</span> <span class="n">NMUs</span><span class="p">,</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>            <span class="s1">&#39;channel_map&#39;</span><span class="p">:</span> <span class="n">channel_map</span><span class="p">,</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>            <span class="s1">&#39;channel_ratings&#39;</span><span class="p">:</span> <span class="n">channel_ratings</span><span class="p">,</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>            <span class="s1">&#39;fix_loc&#39;</span><span class="p">:</span> <span class="n">fix_loc</span><span class="p">,</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>            <span class="s1">&#39;fix_size&#39;</span><span class="p">:</span> <span class="n">fix_size</span><span class="p">,</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>            <span class="s1">&#39;stim_scale&#39;</span><span class="p">:</span> <span class="n">stim_scale</span><span class="p">,</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>            <span class="s1">&#39;stim_locsLP&#39;</span><span class="p">:</span> <span class="n">stim_locsLP</span><span class="p">,</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>            <span class="s1">&#39;stim_locsET&#39;</span><span class="p">:</span> <span class="n">stim_locsET</span><span class="p">}</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>    <span class="c1"># END MultiClouds.read_file_info()  </span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>    <span class="k">def</span> <span class="nf">modify_included_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clists</span><span class="p">,</span> <span class="n">expt_n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a><span class="sd">        Modify the included cells in the dataset</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a><span class="sd">        Args:</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a><span class="sd">            clists (list): list of lists of cell indices to include in the dataset</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a><span class="sd">            expt_n (int): index of the experiment to modify</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a><span class="sd">        Returns:</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a><span class="sd">            None</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>        <span class="k">if</span> <span class="n">expt_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>            <span class="n">expts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">)</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">clists</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="s2">&quot;Number of cell_lists must match number of experiments.&quot;</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>            <span class="n">expts</span> <span class="o">=</span> <span class="p">[</span><span class="n">expt_n</span><span class="p">]</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>            
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">expts</span><span class="p">:</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clists</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">clists</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span> <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NSUs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NMUs&#39;</span><span class="p">]),</span> <span class="s2">&quot;clists too large&quot;</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">clists</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeMUs</span><span class="p">:</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NSUs&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NMUs&#39;</span><span class="p">])</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NSUs&#39;</span><span class="p">])</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">)</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assemble_robs</span><span class="p">()</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>    <span class="c1"># END MultiClouds.modify_included_cells()</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>    <span class="k">def</span> <span class="nf">generate_array_cell_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expt_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">which_array</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a><span class="sd">        Formula for generating cell list given channel maps and basic eligibility</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a><span class="sd">        </span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a><span class="sd">        Args:</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a><span class="sd">            expt_n (int): index of the experiment</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a><span class="sd">            which_array (int or str): which array to generate the cell list for</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a><span class="sd">        Returns:</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a><span class="sd">            np.array: array of cell indices</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>        <span class="c1">#expt_val = np.where( np.sum( self.robs[:, np.arange(cstart, cstart+self.fileNC[expt_n])], axis=0 ) &gt; 10)[0]</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>        <span class="c1"># Should only do this if have not already reduced channel list</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>        <span class="n">NC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;NSUs&#39;</span><span class="p">]</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeMUs</span><span class="p">:</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>            <span class="n">NC</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;NMUs&#39;</span><span class="p">]</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">])</span> <span class="o">==</span> <span class="n">NC</span><span class="p">,</span> <span class="s2">&quot;Can only generate cell_array if using currently using full cell_list&quot;</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>        <span class="k">if</span> <span class="n">which_array</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;utah&#39;</span><span class="p">]:</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>            <span class="n">array_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;channel_map&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="o">+</span><span class="mi">128</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>        <span class="k">elif</span> <span class="n">which_array</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;lam&#39;</span><span class="p">,</span> <span class="s1">&#39;laminar&#39;</span><span class="p">]:</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>            <span class="n">array_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;channel_map&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>        <span class="k">else</span><span class="p">:</span> <span class="c1"># assume Nform</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>            <span class="n">array_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;channel_map&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;channel_map&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="o">+</span><span class="mi">128</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>        <span class="n">cstart</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">expt_n</span><span class="p">):</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>            <span class="n">cstart</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>        <span class="n">nspks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">cstart</span><span class="o">+</span><span class="n">array_cells</span><span class="p">]</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>        <span class="n">val_array</span> <span class="o">=</span> <span class="n">array_cells</span><span class="p">[</span><span class="n">nspks</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">]</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>        <span class="k">return</span> <span class="n">val_array</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>    <span class="c1"># END MultiClouds.generate_array_cell_list()</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>    <span class="k">def</span> <span class="nf">assemble_robs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a><span class="sd">        Takes current information (robs and dfs) to make robs and dfs (full version)</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a><span class="sd">        Note this can be replaced by using the spike times explicitly</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a><span class="sd">        </span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a><span class="sd">        Returns:</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a><span class="sd">            None</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span> <span class="p">)</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span> <span class="p">)</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>        <span class="n">tcount</span><span class="p">,</span> <span class="n">ccount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">):</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>            <span class="n">NTexpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NT&#39;</span><span class="p">]</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>            <span class="n">NSUs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NSUs&#39;</span><span class="p">]</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>            <span class="n">valid_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NTexpt</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>            <span class="n">valid_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;valid_inds&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>            <span class="c1"># Classify cell-lists in terms of SUs and MUc</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>            <span class="n">su_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">NSUs</span><span class="p">]</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>            <span class="n">R_tslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NTexpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span> <span class="p">)</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>            <span class="n">df_tslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NTexpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span> <span class="p">)</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>            <span class="n">tslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;Robs&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>            <span class="n">R_tslice</span><span class="p">[:,</span> <span class="n">ccount</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">su_list</span><span class="p">))]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tslice</span><span class="p">[:,</span> <span class="n">su_list</span><span class="p">])</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>            <span class="n">tslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;datafilts&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>            <span class="c1"># Also take valid_data into account</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>            <span class="n">df_tslice</span><span class="p">[:,</span> <span class="n">ccount</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">su_list</span><span class="p">))]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tslice</span><span class="p">[:,</span> <span class="n">su_list</span><span class="p">])</span> <span class="o">*</span> <span class="n">valid_data</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>            <span class="n">ccount</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">su_list</span><span class="p">)</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>                <span class="n">NMUs</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NMUs&#39;</span><span class="p">]</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>                <span class="n">mu_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">NSUs</span><span class="p">]</span><span class="o">-</span><span class="n">NSUs</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>                <span class="n">tslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>                <span class="n">R_tslice</span><span class="p">[:,</span> <span class="n">ccount</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mu_list</span><span class="p">))]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tslice</span><span class="p">[:,</span> <span class="n">mu_list</span><span class="p">])</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>                <span class="n">tslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;datafiltsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>                <span class="n">df_tslice</span><span class="p">[:,</span> <span class="n">ccount</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mu_list</span><span class="p">))]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tslice</span><span class="p">[:,</span> <span class="n">mu_list</span><span class="p">])</span> <span class="o">*</span> <span class="n">valid_data</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>                <span class="n">ccount</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu_list</span><span class="p">)</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>            <span class="c1"># Check that clipping to uint8 wont screw up any robs</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>            <span class="n">robs_ceil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">R_tslice</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">robs_ceil</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Neurons in expt </span><span class="si">%d</span><span class="s2"> have single-bin spike counts above 255:&quot;</span><span class="o">%</span><span class="n">ff</span><span class="p">,</span> <span class="n">robs_ceil</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>                <span class="c1"># Currently do nothing -- this willbe modded: but if problems should probably make dfs = 0 there</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>            <span class="c1"># Write tslice into </span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">tcount</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NTexpt</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span> <span class="n">R_tslice</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">tcount</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NTexpt</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span> <span class="n">df_tslice</span> <span class="p">)</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>            <span class="n">tcount</span> <span class="o">+=</span> <span class="n">NTexpt</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trialfilter_dfs</span><span class="p">()</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>    <span class="c1"># END MultiClouds.assemble_robs()</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>    <span class="k">def</span> <span class="nf">list_expts</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a><span class="sd">        Show filenames with experiment number</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">):</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%2d</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span> <span class="p">)</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>        
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>    <span class="k">def</span> <span class="nf">updateDF</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">expt_n</span><span class="p">,</span> <span class="n">dfs</span><span class="p">,</span> <span class="n">reduce_cells</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a><span class="sd">        Import updated DF for given experiment, as numbered (can see with &#39;list_expts&#39;)</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a><span class="sd">        Will check for neurons with no robs and reduce robs and dataset if reduce_cells=True</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a><span class="sd">        </span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a><span class="sd">        Args:</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a><span class="sd">            expt_n (int): index of the experiment</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a><span class="sd">            dfs (np.array): array of new dfs</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a><span class="sd">            reduce_cells (bool): whether to reduce the number of cells</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a><span class="sd">        Returns:</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a><span class="sd">            None</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>        <span class="k">assert</span> <span class="n">expt_n</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="s2">&quot;updateDF: expt_n too large: not that many experiments&quot;</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>        <span class="c1"># if eye_config, then want to replace whole DFs, or relevant DFs </span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>        <span class="k">if</span> <span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;NT&#39;</span><span class="p">]:</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>            <span class="c1"># Assume need to use trange</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>        <span class="k">assert</span> <span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;NT&#39;</span><span class="p">],</span> <span class="s2">&quot;DF file mismatch: wrong length&quot;</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>        <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">]]</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>        <span class="c1"># Replace dfs with updated</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>        <span class="n">trange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_tstart</span><span class="p">[</span><span class="n">expt_n</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>        <span class="n">df_tslice</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">trange</span><span class="p">,</span> <span class="p">:]</span> <span class="p">)</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>        <span class="n">crange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">[</span><span class="n">expt_n</span><span class="p">])</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>        <span class="k">if</span> <span class="n">expt_n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>            <span class="n">crange</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">[:</span><span class="n">expt_n</span><span class="p">])</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>        <span class="n">df_tslice</span><span class="p">[:,</span> <span class="n">crange</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">trange</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">df_tslice</span><span class="p">)</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>        <span class="k">if</span> <span class="n">reduce_cells</span><span class="p">:</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>            <span class="n">elim_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>            <span class="k">if</span> <span class="n">elim_cells</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  reduce_cells not implemented yet&#39;</span><span class="p">)</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39; Cells to reduce:&#39;</span><span class="p">,</span> <span class="n">elim_cells</span> <span class="p">)</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>        
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trialfilter_dfs</span><span class="p">()</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>    <span class="c1"># END MultiClouds.updateDF()</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>    <span class="k">def</span> <span class="nf">trialfilter_dfs</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a><span class="sd">        Zeros out dfs at the beginning of trials up to num_lags</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a><span class="sd">        </span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a><span class="sd">        Returns:</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a><span class="sd">            None</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)):</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>    <span class="k">def</span> <span class="nf">assemble_saccade_inds</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a><span class="sd">        Assemble saccade indices for all experiments</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a><span class="sd">        Returns:</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a><span class="sd">            None</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Currently not implemented -- needs to have microsaccades labeled well with time first&#39;</span><span class="p">)</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>    <span class="k">def</span> <span class="nf">is_fixpoint_present</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">boxlim</span><span class="p">,</span> <span class="n">expt_n</span> <span class="p">):</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a><span class="sd">        Return if any of fixation point is within the box given by top-left to bottom-right corner</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a><span class="sd">        </span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a><span class="sd">        Args:</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a><span class="sd">            boxlim (list): list of four numbers (top-left, bot-right)</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a><span class="sd">            expt_n (int): index of the experiment</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a><span class="sd">        Returns:</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a><span class="sd">            bool: whether the fixation point is present</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>        <span class="n">fix_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;fix_loc&#39;</span><span class="p">]</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>        <span class="k">if</span> <span class="n">fix_loc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>        <span class="n">fix_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;fix_size&#39;</span><span class="p">]</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>        <span class="n">fix_present</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>        <span class="c1">#if self.file_info[expt_n][&#39;stim_loc&#39;].shape[1] == 1:</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>        <span class="c1"># if there is multiple windows, needs to be manual: so this is the automatic check:</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>        <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">fix_loc</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">-</span><span class="n">boxlim</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">fix_size</span><span class="p">):</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>                <span class="n">fix_present</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">fix_loc</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">-</span><span class="n">boxlim</span><span class="p">[</span><span class="n">dd</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">fix_size</span><span class="p">):</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>                <span class="n">fix_present</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>        <span class="k">return</span> <span class="n">fix_present</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>    <span class="c1"># END .is_fixpoint_present</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>    <span class="k">def</span> <span class="nf">build_stim</span><span class="p">(</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>            <span class="bp">self</span><span class="p">,</span> <span class="n">expt_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>            <span class="n">which_stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">top_corner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># position of stim</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>            <span class="n">time_embed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>            <span class="n">eyepos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">BUF</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="c1"># eye position (not shifts)</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>            <span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>            <span class="n">LMS</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>            <span class="n">fixdot</span><span class="o">=</span><span class="mi">0</span> <span class="p">):</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a><span class="sd">        This assembles a stimulus from the raw numpy-stored stimuli into self.stim</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a><span class="sd">        which_stim: determines what stimulus is assembled from &#39;ET&#39;=0, &#39;lam&#39;=1, None</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a><span class="sd">            If none, will need top_corner present: can specify with four numbers (top-left, bot-right)</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a><span class="sd">            or just top_corner and L</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a><span class="sd">        which is torch.tensor on default device</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a><span class="sd">        stim_wrap: only works if using &#39;which_stim&#39;, and will be [hwrap, vwrap]</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a><span class="sd">        </span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a><span class="sd">        Args:</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a><span class="sd">            expt_n (int): index of the experiment</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a><span class="sd">            which_stim (int or str): which stimulus to use</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a><span class="sd">            top_corner (list): top corner of the stimulus</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a><span class="sd">            L (int): size of the stimulus</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a><span class="sd">            time_embed (int): time embedding</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a><span class="sd">            eyepos (np.array): eye position</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a><span class="sd">            BUF (int): buffer for eye position</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a><span class="sd">            stim_crop (list): crop the stimulus</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a><span class="sd">            LMS (bool): whether to use LMS</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a><span class="sd">            fixdot (int): fixation point</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a><span class="sd">        Returns:</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a><span class="sd">            None</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>        <span class="c1">#eyepos = shifts   # shifts that is passed in is actually the eye position</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>        <span class="k">assert</span> <span class="n">expt_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;CONSTRUCT_STIMULUS: must specify expt_n&quot;</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>        <span class="c1"># Delete existing stim and clear cache to prevent memory issues on GPU</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>        <span class="n">need2crop</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>        <span class="k">if</span> <span class="n">LMS</span><span class="p">:</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">,</span> <span class="s2">&quot;Cannot convert color spaces if luminance-only.&quot;</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">LMS</span> <span class="o">=</span> <span class="n">LMS</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>        <span class="k">if</span> <span class="n">which_stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>            <span class="k">assert</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;CONSTRUCT_STIMULUS: cannot specify L if using which_stim (i.e. prepackaged stim)&quot;</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_stim</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>                <span class="k">if</span> <span class="n">which_stim</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ET&#39;</span><span class="p">,</span> <span class="s1">&#39;et&#39;</span><span class="p">,</span> <span class="s1">&#39;stimET&#39;</span><span class="p">]:</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>                    <span class="n">which_stim</span><span class="o">=</span><span class="mi">0</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>                    <span class="n">which_stim</span><span class="o">=</span><span class="mi">1</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>            <span class="k">if</span> <span class="n">which_stim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Stim #</span><span class="si">%d</span><span class="s2">: using ET stimulus&quot;</span><span class="p">,</span> <span class="n">expt_n</span> <span class="p">)</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>                <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>                <span class="c1">#self.stim_pos = self.stim_locationET[:,0]</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Stim #</span><span class="si">%d</span><span class="s2">: using laminar probe stimulus&quot;</span><span class="p">,</span> <span class="n">expt_n</span> <span class="p">)</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>                <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>                <span class="c1">#self.stim_pos = self.stim_location[:, 0]</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="n">stim_tmp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="n">stim_tmp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>            
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">newstim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>            <span class="c1"># Forget binocular for now</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;currently not implemented&#39;</span><span class="p">)</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>            <span class="c1"># Assemble from combination of ET and laminer probe (NP) stimulus</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>            <span class="k">assert</span> <span class="n">top_corner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need top corner if which_stim unspecified&quot;</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>            <span class="k">assert</span> <span class="n">stim_crop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Cannot specify stim_crop and top_corner&quot;</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>            <span class="c1"># Determine stim location</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_corner</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>                <span class="n">stim_pos</span> <span class="o">=</span> <span class="n">top_corner</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>                <span class="c1">#L = self.stim_pos[2]-self.stim_pos[0]</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>                <span class="k">assert</span> <span class="n">stim_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">stim_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Stim must be square (for now)&quot;</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>                <span class="k">if</span> <span class="n">L</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>                    <span class="k">assert</span> <span class="n">L</span> <span class="o">==</span> <span class="n">stim_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;L does not match specified stim size&quot;</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>                    <span class="n">L</span> <span class="o">=</span> <span class="n">stim_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>                <span class="k">if</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>                    <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>                <span class="k">assert</span> <span class="n">L</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to specify stimulus size&quot;</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>                    <span class="k">assert</span> <span class="n">L</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="s2">&quot;BUILD_STIM: size of stimuli much match. L=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span> 
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>                <span class="n">stim_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">top_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">top_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">top_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">L</span><span class="p">,</span> <span class="n">top_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">L</span><span class="p">]</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>            <span class="k">if</span> <span class="n">eyepos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>                <span class="n">need2crop</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>                <span class="c1"># Extend stim window by BUFF-per-side in each direction</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>                <span class="n">stim_pos</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>                    <span class="n">stim_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>                    <span class="n">stim_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>                    <span class="n">stim_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">BUF</span><span class="p">,</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>                    <span class="n">stim_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">BUF</span><span class="p">]</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Stim expansion for shift:&quot;</span><span class="p">,</span> <span class="n">stim_pos</span><span class="p">)</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>                <span class="n">L</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">BUF</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>                <span class="n">num_clr</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>                <span class="n">num_clr</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>            <span class="c1"># Read in stimuli</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stimET&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>                <span class="n">stimET_base</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>                <span class="n">stimET_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stimET&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>            
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>            <span class="n">locsET</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stim_locsET&#39;</span><span class="p">]</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>            <span class="n">stimLP_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stim&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>            <span class="n">locsLP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stim_locsLP&#39;</span><span class="p">]</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>            <span class="n">fhandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">expt_n</span><span class="p">]</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>            <span class="n">sz</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>            <span class="c1">#stimET_base = np.array(self.fhandles[expt_n][&#39;stimET&#39;][self.tranges[expt_n], ...], dtype=np.int8)</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>            <span class="c1">#stimLP_base = np.array(self.fhandles[expt_n][&#39;stim&#39;][self.tranges[expt_n], ...], dtype=np.int8)</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>            <span class="c1">#locsET = self.file_info[expt_n][&#39;stim_locsET&#39;]</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>            <span class="c1">#locsLP = self.file_info[expt_n][&#39;stim_locsLP&#39;]</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>                <span class="n">num_clr</span> <span class="o">*=</span> <span class="mi">2</span>  <span class="c1"># make binocular be like just 2x more colors (channel dim)</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>                <span class="n">Lpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useLeye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>                <span class="n">Rpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>                <span class="n">LRpresent</span> <span class="o">=</span> <span class="n">Lpresent</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Rpresent</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>                <span class="n">Leye</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>                <span class="n">Reye</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">LRpresent</span><span class="p">),</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span><span class="p">[</span><span class="n">LRpresent</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span><span class="p">[</span><span class="n">LRpresent</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span> 
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>                    <span class="c1">#empty_stimET=np.zeros((np.shape(stimET)[0], 2, np.shape(stimET)[2], np.shape(stimET)[3]))</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>                    <span class="n">stimLP</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimLP_base</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimLP_base</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimLP_base</span><span class="p">)[</span><span class="mi">3</span><span class="p">]))</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>                    <span class="n">stimLP</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>                    <span class="n">stimLP</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>                    <span class="k">if</span> <span class="n">stimET_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>                        <span class="n">stimET</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimET_base</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimET_base</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimET_base</span><span class="p">)[</span><span class="mi">3</span><span class="p">]))</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>                        <span class="n">stimET</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>                        <span class="n">stimET</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>                    <span class="n">stimLP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimLP_base</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimLP_base</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimLP_base</span><span class="p">)[</span><span class="mi">3</span><span class="p">]))</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>                    <span class="n">stimLP</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>                    <span class="n">stimLP</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>                    <span class="k">if</span> <span class="n">stimET_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>                        <span class="n">stimET</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimET_base</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimET_base</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimET_base</span><span class="p">)[</span><span class="mi">3</span><span class="p">]))</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>                        <span class="n">stimET</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>                        <span class="n">stimET</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>                <span class="n">stimET</span><span class="o">=</span><span class="n">stimET_base</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>                <span class="n">stimLP</span><span class="o">=</span><span class="n">stimLP_base</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>                    <span class="n">stimLP</span> <span class="o">=</span> <span class="n">stimLP</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>                <span class="k">if</span> <span class="n">stimET_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>                    <span class="c1"># stimET=stimET_base</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>                        <span class="k">if</span> <span class="n">stimET_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>                            <span class="n">stimET</span> <span class="o">=</span> <span class="n">stimET</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>  <span class="c1"># maintain 2nd dim (length 1)</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>         
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>            <span class="n">NT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">expt_n</span><span class="p">]</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>            <span class="n">newstim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="n">num_clr</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span> <span class="p">)</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">locsLP</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>                <span class="n">OVLP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_overlap_ranges</span><span class="p">(</span><span class="n">stim_pos</span><span class="p">,</span> <span class="n">locsLP</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">])</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>                <span class="k">if</span> <span class="n">OVLP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>                    <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Writing lam stim </span><span class="si">%d</span><span class="s2">: overlap </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">])))</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>                    <span class="n">strip</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:])</span> <span class="c1">#np.zeros([self.NT, num_clr, len(OVLP[&#39;targetX&#39;]), L])</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>                    <span class="n">strip</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">((</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readX&#39;</span><span class="p">],</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readY&#39;</span><span class="p">]]))</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>                    <span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>                
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>            <span class="k">if</span> <span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>    
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">locsET</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>                    <span class="n">OVLP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_overlap_ranges</span><span class="p">(</span><span class="n">stim_pos</span><span class="p">,</span> <span class="n">locsET</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">])</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>                    <span class="k">if</span> <span class="n">OVLP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>                        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Writing ETstim </span><span class="si">%d</span><span class="s2">: overlap </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">])))</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>                        <span class="n">strip</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:])</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>                        <span class="n">strip</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">((</span><span class="n">stimET</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readX&#39;</span><span class="p">],</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readY&#39;</span><span class="p">]]))</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>                        <span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span> 
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>            <span class="c1">#stim = torch.tensor( newstim, dtype=torch.float32, device=self.device )</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>        <span class="c1"># Note stim stored in numpy is being represented as full 3-d + 1 tensor (time, channels, NX, NY)</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>        <span class="c1"># Insert fixation point</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">fixdot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fixpoint_present</span><span class="p">(</span> <span class="n">stim_pos</span><span class="p">,</span> <span class="n">expt_n</span> <span class="p">):</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>            <span class="n">fixranges</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>            <span class="n">fix_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;fix_loc&#39;</span><span class="p">]</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>            <span class="n">fix_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;fix_size&#39;</span><span class="p">]</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>            <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>                <span class="n">fixranges</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">fix_loc</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">-</span><span class="n">fix_size</span><span class="o">-</span><span class="n">stim_pos</span><span class="p">[</span><span class="n">dd</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">fix_loc</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">+</span><span class="n">fix_size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">stim_pos</span><span class="p">[</span><span class="n">dd</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="n">stim_pos</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span> 
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>                    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>            <span class="c1"># Write the correct value to stim</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>            <span class="k">assert</span> <span class="n">fixdot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Haven&#39;t yet put in other fixdot settings than zero&quot;</span> 
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Adding fixation point&#39;</span><span class="p">)</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>            <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">fixranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>                <span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">fixranges</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>        <span class="k">if</span> <span class="n">eyepos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>            <span class="c1"># Would want to shift by input eye positions if input here</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>            <span class="c1">#print(&#39;eye-position shifting not implemented yet&#39;)</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Shifting stim...&#39;</span><span class="p">)</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eyepos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">newstim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>                <span class="n">eyepos</span> <span class="o">=</span> <span class="n">eyepos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">]]</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eyepos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">newstim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>                <span class="n">eyepos_padded</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">newstim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>                <span class="n">Lpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useLeye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>                <span class="n">Rpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>                <span class="n">LRpresent</span> <span class="o">=</span> <span class="n">Lpresent</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Rpresent</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>                <span class="n">bin_inds</span><span class="o">=</span><span class="n">inds</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span><span class="p">)]</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_inds</span><span class="p">)</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="n">eyepos</span><span class="p">):</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>                    <span class="n">eyepos_padded</span><span class="p">[</span><span class="n">bin_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">bin_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">eyepos</span><span class="p">)]</span><span class="o">=</span><span class="n">eyepos</span> <span class="c1">#Off by one errors, probably. </span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>                    <span class="n">eyepos_padded</span><span class="p">[</span><span class="n">bin_inds</span><span class="p">]</span><span class="o">=</span><span class="n">eyepos</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>                <span class="n">eyepos</span><span class="o">=</span><span class="n">eyepos_padded</span> 
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>            <span class="k">if</span> <span class="n">num_clr</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>                 
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_stim</span><span class="p">(</span> <span class="n">newstim</span><span class="p">,</span> <span class="n">eyepos</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_stim</span><span class="p">(</span><span class="n">newstim</span><span class="p">,</span> <span class="n">eyepos</span><span class="p">)</span> 
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>        <span class="c1"># Reduce size back to original If expanded to handle shifts</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>        <span class="k">if</span> <span class="n">need2crop</span><span class="p">:</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>            <span class="c1">#assert self.stim_crop is None, &quot;Cannot crop stim at same time as shifting&quot;</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>            <span class="n">newstim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_stim</span><span class="p">(</span> <span class="n">newstim</span><span class="p">,</span> <span class="p">[</span><span class="n">BUF</span><span class="p">,</span> <span class="n">L</span><span class="o">-</span><span class="n">BUF</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">BUF</span><span class="p">,</span> <span class="n">L</span><span class="o">-</span><span class="n">BUF</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>  <span class="c1"># move back to original size</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">L</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">BUF</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>            <span class="c1"># if used which_stim and added crop</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>            <span class="k">if</span> <span class="n">stim_crop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_stim</span><span class="p">(</span> <span class="n">newstim</span><span class="p">,</span> <span class="n">stim_crop</span> <span class="p">)</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">newstim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>        <span class="c1"># Verify L matches current stim&#39;s L</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>            <span class="k">assert</span> <span class="n">L</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="s2">&quot;BUILD_STIM: L mismatch (which_stim)&quot;</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">L</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">=</span> <span class="n">time_embed</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">==</span> <span class="n">time_embed</span><span class="p">,</span> <span class="s2">&quot;time_embed setting must match&quot;</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>            
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>        <span class="k">if</span> <span class="n">time_embed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>            <span class="c1">#self.stim_dims[3] = num_lags  # this is set by time-embedding</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>            <span class="k">if</span> <span class="n">time_embed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embedding</span><span class="p">(</span> <span class="n">newstim</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span> <span class="p">)</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>        <span class="c1"># now stimulus is represented as full 4-d + 1 tensor (time, channels, NX, NY, num_lags)</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>        <span class="c1"># Translate to cone-isolating stimmulus if DKL is false</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>        <span class="k">if</span> <span class="n">LMS</span><span class="p">:</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>            <span class="c1"># Make LMS conversion matrix</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>            <span class="n">DKL2LMS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.7586</span><span class="p">,</span> <span class="mf">0.6515</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5536</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8328</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.8660</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;  Converting to LMS space&#39;</span><span class="p">)</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>            <span class="n">newstim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span> <span class="s1">&#39;axcd,bx-&gt;abcd&#39;</span><span class="p">,</span> <span class="n">newstim</span><span class="p">,</span> <span class="n">DKL2LMS</span><span class="p">)</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>        <span class="c1"># Flatten stim </span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">expt_stims</span><span class="p">[</span><span class="n">expt_n</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">newstim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">expt_n</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Done: expt&quot;</span><span class="p">,</span> <span class="n">expt_n</span> <span class="p">)</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>    <span class="c1"># END MultiClouds.build_stim()</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>    <span class="k">def</span> <span class="nf">assemble_stim</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a><span class="sd">        Assemble stimulus from all experiments into self.stim</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a><span class="sd">        Returns:</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a><span class="sd">            None</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span><span class="p">:</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>        <span class="n">num_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">)</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span> <span class="p">)</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">):</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">expt_stims</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;ASSEMBLE_STIM: stim </span><span class="si">%d</span><span class="s1"> is not yet built.&#39;</span><span class="o">%</span><span class="n">ff</span>  
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>            <span class="n">trange</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_tstart</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_tstart</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">trange</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expt_stims</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Stimulus assembly complete&quot;</span><span class="p">)</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>    <span class="c1"># END MultiClouds.assemble_stimulus()</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>    <span class="k">def</span> <span class="nf">time_embedding</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a><span class="sd">        Note this overloads SensoryBase because reshapes in full dimensions to handle folded_lags</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a><span class="sd">        </span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a><span class="sd">        Args:</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a><span class="sd">            stim (np.array): stimulus to time-embed</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a><span class="sd">            nlags (int): number of lags</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a><span class="sd">        Returns:</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a><span class="sd">            np.array: time-embedded stimulus</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to assemble stim before time-embedding.&quot;</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>        <span class="k">if</span> <span class="n">nlags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>            <span class="n">nlags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>        <span class="c1">#if self.stim_dims[3] == 1:</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>        <span class="c1">#    self.stim_dims[3] = nlags</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>        <span class="c1">#if stim is None:</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>        <span class="c1">#    tmp_stim = deepcopy(self.stim)</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>    
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Time embedding...&quot;</span><span class="p">)</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>        <span class="c1">#if len(tmp_stim.shape) == 2:</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>        <span class="c1">#    print( &quot;Time embed: reshaping stimulus -&gt;&quot;, self.stim_dims)</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>        <span class="c1">#    tmp_stim = tmp_stim.reshape([NT] + self.stim_dims)</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>        <span class="c1">#assert self.NT == NT, &quot;TIME EMBEDDING: stim length mismatch&quot;</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>        <span class="c1">#tmp_stim = tmp_stim[np.arange(NT)[:,None]-np.arange(nlags), :, :, :]</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>        <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nlags</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>        <span class="c1">#if self.folded_lags:</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>        <span class="c1">#    #tmp_stim = np.transpose( tmp_stim, axes=[0,2,1,3,4] ) </span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>        <span class="c1">#    tmp_stim = torch.permute( tmp_stim, (0,2,1,3,4) ) </span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>        <span class="c1">#    print(&quot;Folded lags: stim-dim = &quot;, self.stim.shape)</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>        <span class="c1">#else:</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>        <span class="c1">#    #tmp_stim = np.transpose( tmp_stim, axes=[0,2,3,4,1] )</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>        <span class="c1">#    tmp_stim = torch.permute( tmp_stim, (0,2,3,4,1) )</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>        <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span> <span class="n">tmp_stim</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>        <span class="k">return</span> <span class="n">tmp_stim</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>    <span class="c1"># END .time_embedding()</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>    <span class="k">def</span> <span class="nf">rectangle_overlap_ranges</span><span class="p">(</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span> <span class="p">):</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a><span class="sd">        Figures out ranges to write relevant overlap of B onto A</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a><span class="sd">        All info is of form [x0, y0, x1, y1]</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a><span class="sd">        </span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a><span class="sd">        Args:</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a><span class="sd">            A (list): first rectangle</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a><span class="sd">            B (list): second rectangle</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a><span class="sd">        Returns:</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a><span class="sd">            dict: dictionary of ranges</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>        <span class="n">C</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>            <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span> 
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>                <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>                <span class="n">D</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>                <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]:</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> 
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>                <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>                <span class="n">D</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>                <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]:</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>            <span class="k">return</span> <span class="kc">None</span>  
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>        <span class="n">ranges</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>            <span class="s1">&#39;targetX&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>            <span class="s1">&#39;targetY&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">C</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>            <span class="s1">&#39;readX&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>            <span class="s1">&#39;readY&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">D</span><span class="p">[</span><span class="mi">3</span><span class="p">])}</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>        <span class="k">return</span> <span class="n">ranges</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>    <span class="c1"># END STATIC.rectangle_overlap_ranges</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>    <span class="k">def</span> <span class="nf">crop_stim</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim0</span><span class="p">,</span> <span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a><span class="sd">        Crop existing (torch) stimulus and change relevant variables [x1, x2, y1, y2]</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a><span class="sd">        </span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a><span class="sd">        Args:</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a><span class="sd">            stim0 (np.array): stimulus to crop</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a><span class="sd">            stim_crop (list): crop the stimulus</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a><span class="sd">        Returns:</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a><span class="sd">            np.array: cropped stimulus</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_crop</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;stim_crop must be of form: [x1, x2, y1, y2]&quot;</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;STIM_CROP: Will only work for unflattened stimulus&quot;</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>        
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>        <span class="c1">#stim_crop = np.array(stim_crop, dtype=np.int64) # make sure array</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>        <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stim_crop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stim_crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>        <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stim_crop</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">stim_crop</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>            <span class="n">newstim</span> <span class="o">=</span> <span class="n">stim0</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">ys</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">xs</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># then lagged -- need extra dim</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>            <span class="n">newstim</span> <span class="o">=</span> <span class="n">stim0</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">ys</span><span class="p">,</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="n">xs</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  CROP: New stim size: </span><span class="si">%d</span><span class="s2"> x </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)))</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>        <span class="k">return</span> <span class="n">newstim</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>    <span class="c1"># END MultiClouds.crop_stim()</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a><span class="c1">#    def augment_dfs( self, new_dfs, cells=None ):</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a><span class="c1">#        &quot;&quot;&quot;Replaces data-filter for given cells. note that new_df should be np.ndarray&quot;&quot;&quot;</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a><span class="c1">#        </span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a><span class="c1">#        NTdf, NCdf = new_dfs.shape </span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a><span class="c1">#        if cells is None:</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a><span class="c1">#            assert NCdf == self.dfs.shape[1], &quot;new DF is wrong shape to replace DF for all cells.&quot;</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a><span class="c1">#            cells = range(self.dfs.shape[1])</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a><span class="c1">#        if self.NT &lt; NTdf:</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a><span class="c1">#            self.dfs[:, cells] *= torch.tensor(new_dfs[:self.NT, :], dtype=torch.float32)</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a><span class="c1">#        else:</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a><span class="c1">#            if self.NT &gt; NTdf:</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a><span class="c1">#                # Assume dfs are 0 after new valid region</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a><span class="c1">#                print(&quot;Truncating valid region to new datafilter length&quot;, NTdf)</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a><span class="c1">#                new_dfs = np.concatenate( </span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a><span class="c1">#                    (new_dfs, np.zeros([self.NT-NTdf, len(cells)], dtype=np.float32)), </span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a><span class="c1">#                    axis=0)</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a><span class="c1">#            self.dfs[:, cells] *= torch.tensor(new_dfs, dtype=torch.float32)</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>        <span class="c1"># END ColorClouds.augment_dfs()</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>    <span class="k">def</span> <span class="nf">draw_stim_locations</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">expt_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_corner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">row_height</span><span class="o">=</span><span class="mf">5.0</span> <span class="p">):</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a><span class="sd">        Draw stimulus locations for given experiment</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a><span class="sd">        Args:</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a><span class="sd">            expt_n (int): index of the experiment</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a><span class="sd">            top_corner (list): top corner of the stimulus</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a><span class="sd">            L (int): size of the stimulus</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a><span class="sd">            row_height (float): height of the row</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a><span class="sd">        Returns:</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a><span class="sd">            None</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>        <span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Rectangle</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>        <span class="n">lamlocs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stim_locsLP&#39;</span><span class="p">]</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>        <span class="n">ETlocs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stim_locsET&#39;</span><span class="p">]</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>        <span class="n">fixloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;fix_loc&#39;</span><span class="p">]</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>        <span class="n">fixsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;fix_size&#39;</span><span class="p">]</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>        <span class="n">BUF</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>        <span class="k">if</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">lamlocs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">row_height</span><span class="p">,</span> <span class="n">row_height</span><span class="p">)</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>        <span class="n">nET</span> <span class="o">=</span> <span class="n">ETlocs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>        <span class="n">nLAM</span> <span class="o">=</span> <span class="n">lamlocs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>        <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>        <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>        <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">3</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">3</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>        <span class="c1">#print(x0,x1,y0,y1)</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nLAM</span><span class="p">):</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>                <span class="n">Rectangle</span><span class="p">((</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">lamlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ii</span><span class="p">]),</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> 
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>                <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">))</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>        <span class="n">clrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">]</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nET</span><span class="p">):</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ii</span><span class="p">],</span> <span class="n">ETlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="p">]),</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> 
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>                                <span class="n">edgecolor</span><span class="o">=</span><span class="n">clrs</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>        <span class="k">if</span> <span class="n">fixloc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">fixloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">fixsize</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fixloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">fixsize</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">fixsize</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">fixsize</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>                                <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>        <span class="k">if</span> <span class="n">top_corner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">(</span><span class="n">top_corner</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> 
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>                                <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">))</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>            
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">x0</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span><span class="n">x1</span><span class="o">+</span><span class="n">BUF</span><span class="p">])</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="n">y0</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span><span class="n">y1</span><span class="o">+</span><span class="n">BUF</span><span class="p">])</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>    <span class="c1"># END .draw_stim_locations()</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>    
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>    <span class="k">def</span> <span class="nf">avrates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a><span class="sd">        Calculates average firing probability across specified inds (or whole dataset)</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a><span class="sd">        -- Note will respect datafilters</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a><span class="sd">        -- will return precalc value to save time if already stored</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a><span class="sd">        Args:</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a><span class="sd">            inds (list): indices to calculate across</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a><span class="sd">        Returns:</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a><span class="sd">            np.array: average firing rates</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>            <span class="c1"># then calculate across whole dataset</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>                <span class="c1"># then precalculated and do not need to do</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>        <span class="c1"># Otherwise calculate across all data</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>            <span class="n">Reff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>            <span class="n">Teff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="o">/</span><span class="n">Teff</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Still need to implement avRs without preloading&#39;</span><span class="p">)</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>    <span class="c1"># END .avrates()</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>    <span class="c1">#def set_cells(self, **kwargs):</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>    <span class="c1">#    raise( Exception(&#39;set_cells does not work with MultiClouds.&#39;) )</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>    <span class="c1"># USE SENSORY-BASE -- should be set up now....</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>    <span class="k">def</span> <span class="nf">shift_stim_oldstyle</span><span class="p">(</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pos_shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metric_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ts_thresh</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">fix_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>        <span class="n">shift_times</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a><span class="sd">        Shift stimulus given standard shifting input (TBD)</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a><span class="sd">        use &#39;shift-times&#39; if given shifts correspond to range of times</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a><span class="sd">        </span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a><span class="sd">        Args:</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a><span class="sd">            stim (np.array): stimulus to shift</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a><span class="sd">            pos_shifts (np.array): shifts to apply</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a><span class="sd">            metrics (np.array): metrics to apply</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a><span class="sd">            metric_threshold (float): metric threshold</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a><span class="sd">            ts_thresh (int): time threshold</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a><span class="sd">            fix_n (np.array): fixations</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a><span class="sd">            shift_times (np.array): times to shift</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a><span class="sd">        Returns:</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a><span class="sd">            np.array: shifted stimulus</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>        <span class="n">NX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>        <span class="n">nlags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>        <span class="c1"># Check if has been time-lagged yet</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>        <span class="k">if</span> <span class="n">stim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>            <span class="n">stim0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>            <span class="n">stim0</span> <span class="o">=</span> <span class="n">stim</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>        <span class="n">already_lagged</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>            <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="n">ND</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim0</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>            <span class="k">if</span> <span class="n">ND</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">NX</span><span class="o">*</span><span class="n">NX</span><span class="p">:</span>  <span class="c1"># then lags in stim</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>                <span class="n">re_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>                <span class="n">already_lagged</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>                <span class="n">re_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Stim be already shaped according shape, but seems not&quot;</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>            <span class="n">re_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>        <span class="k">if</span> <span class="n">fix_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>            <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>        <span class="c1"># Apply shift-times (subset)</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>        <span class="k">if</span> <span class="n">shift_times</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>            <span class="n">fix_n</span> <span class="o">=</span> <span class="n">fix_n</span><span class="p">[</span><span class="n">shift_times</span><span class="p">]</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>            <span class="c1"># Find minimum fix_n and make = 1</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>            <span class="n">min_fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fix_n</span><span class="p">[</span><span class="n">fix_n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>            <span class="c1">#print(&#39;min_fix_n&#39;, min_fix_n, &#39;adjust&#39;, 1-min_fix_n)</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>            <span class="n">fix_n</span><span class="p">[</span><span class="n">fix_n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">-</span><span class="n">min_fix_n</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>            <span class="n">re_stim</span> <span class="o">=</span> <span class="n">re_stim</span><span class="p">[</span><span class="n">shift_times</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>            <span class="c1">#print(&#39;max fix&#39;, np.max(fix_n), fix_n.shape)</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>        
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>        <span class="n">NF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fix_n</span><span class="p">)</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>        <span class="n">NTtmp</span> <span class="o">=</span> <span class="n">re_stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>        <span class="n">nclr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>        <span class="c1">#sh0 = -(pos_shifts[:,0]-self.dims[1]//2)</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>        <span class="c1">#sh1 = -(pos_shifts[:,1]-self.dims[2]//2)</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>        <span class="n">sh0</span> <span class="o">=</span> <span class="n">pos_shifts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># this should be in units of pixels relative to 0</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>        <span class="n">sh1</span> <span class="o">=</span> <span class="n">pos_shifts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>        <span class="n">sp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">re_stim</span><span class="p">)</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>        <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>            <span class="n">val_fix</span> <span class="o">=</span> <span class="n">metrics</span> <span class="o">&gt;</span> <span class="n">metric_threshold</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Applied metric threshold: </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">val_fix</span><span class="p">),</span> <span class="n">NF</span><span class="p">))</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>            <span class="n">val_fix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span><span class="o">*</span><span class="n">NF</span><span class="p">)</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NF</span><span class="p">):</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fix_n</span> <span class="o">==</span> <span class="n">ff</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>            <span class="c1">#print(ff, len(ts), ts[0], ts[-1])</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>            <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh0</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh1</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ts_thresh</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">val_fix</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">):</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>                <span class="c1"># FIRST SP DIM shift</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>                <span class="n">sh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sh0</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>                <span class="n">stim_seg</span> <span class="o">=</span> <span class="n">re_stim</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>                <span class="k">if</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span> <span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>                    <span class="n">stim_tmp</span><span class="p">[:,</span> <span class="p">:,</span><span class="n">sh</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_seg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="o">-</span><span class="n">sh</span><span class="p">),</span> <span class="p">:])</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>                <span class="k">elif</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span> <span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>                    <span class="n">stim_tmp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">sh</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_seg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">(</span><span class="o">-</span><span class="n">sh</span><span class="p">):,</span> <span class="p">:])</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_seg</span><span class="p">)</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>                <span class="c1"># SECOND SP DIM shift</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>                <span class="n">sh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sh1</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>                <span class="k">if</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>                    <span class="n">stim_tmp2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>                    <span class="n">stim_tmp2</span><span class="p">[</span><span class="o">...</span> <span class="p">,</span> <span class="n">sh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:(</span><span class="o">-</span><span class="n">sh</span><span class="p">)])</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>                <span class="k">elif</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>                    <span class="n">stim_tmp2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>                    <span class="n">stim_tmp2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">sh</span><span class="p">):])</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>                    <span class="n">stim_tmp2</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>                    
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>                <span class="n">sp_stim</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="o">...</span> <span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp2</span><span class="p">)</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>        <span class="k">if</span> <span class="n">already_lagged</span><span class="p">:</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>            <span class="c1"># Time-embed</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NTtmp</span><span class="p">)</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>            <span class="n">laggedstim</span> <span class="o">=</span> <span class="n">sp_stim</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NTtmp</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nlags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">laggedstim</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>            <span class="k">return</span> <span class="n">sp_stim</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>    <span class="c1"># END ColorCloud.shift_stim -- note outputs stim rather than overwrites</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>    <span class="k">def</span> <span class="nf">process_fixations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sacc_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expt_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>                          <span class="n">sacc_metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dur_thresh</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>                          <span class="n">modify_dfs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a><span class="sd">        Generates fix_n based on existing trial structure and imported fixations. Will only work for specified</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a><span class="sd">        experiment (expt_n variable) and assume timings are based on the beginning of that experiment.</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a><span class="sd">        Output: fix_n</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a><span class="sd">        Default: modify_dfs=True will zero out data where there is no assigned fixation</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a><span class="sd">        </span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a><span class="sd">        Note that this will assume that saccades correspond to relevant trange (e.g., binocular section) rather</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a><span class="sd">        than the whole experiment.</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a><span class="sd">        </span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a><span class="sd">        Can also use metric criteria to only use fraction of total saccades: sacc_metrics can be amplitude, and </span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a><span class="sd">        sacc_thresh be inclusion criteria (must be greater than sacc_thresh)</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a><span class="sd">        Args:</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a><span class="sd">            sacc_in (np.array): saccade times</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a><span class="sd">            expt_n (int): index of the experiment</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a><span class="sd">            sacc_metrics (np.array): saccade metrics</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a><span class="sd">            thresh (float): threshold for saccade metrics</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a><span class="sd">            dur_thresh (int): duration threshold</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a><span class="sd">            modify_dfs (bool): modify dfs</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a><span class="sd">        Returns:</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a><span class="sd">            np.array: fixation numbers</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>        <span class="k">assert</span> <span class="n">sacc_in</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to enter saccade times&quot;</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">expt_n</span><span class="p">]</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sacc_in</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">NT</span><span class="p">,</span> <span class="s2">&quot;sacc list is too long&quot;</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>        <span class="k">if</span> <span class="n">sacc_metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>            <span class="n">sac_ts</span> <span class="o">=</span> <span class="n">sacc_in</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sacc_metrics</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">sacc_in</span><span class="p">),</span> <span class="s2">&quot;Saccade metrics must match length of sacc_in&quot;</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>            <span class="n">sac_ts</span> <span class="o">=</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sacc_metrics</span> <span class="o">&gt;=</span> <span class="n">thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>        <span class="n">sacc_rate</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sac_ts</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">NT</span><span class="o">/</span><span class="mf">60.0</span><span class="p">)</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Generating fix_n for expt </span><span class="si">%d</span><span class="s2"> with </span><span class="si">%d</span><span class="s2"> valid saccades (</span><span class="si">%0.2f</span><span class="s2"> Hz)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">expt_n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sac_ts</span><span class="p">),</span> <span class="n">sacc_rate</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>        <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> 
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>        <span class="n">fix_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)):</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>            <span class="c1">#if self.block_inds[ii][0] &lt; self.NT:</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>            <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>            <span class="c1">#self.block_inds.append(np.arange( blk_inds[ii,0], blk_inds[ii,1], dtype=np.int64))</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>            <span class="c1"># Parse fixation numbers within block</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>            <span class="n">rel_saccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">sac_ts</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sac_ts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">5</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>            <span class="n">tfix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Beginning of fixation by definition</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>            <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel_saccs</span><span class="p">)):</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>                <span class="k">if</span> <span class="n">sac_ts</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]]</span><span class="o">-</span><span class="n">tfix</span> <span class="o">&gt;=</span> <span class="n">dur_thresh</span><span class="p">:</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>                    <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>                    <span class="c1"># Range goes to beginning of next fixation (note no gap)</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>                    <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="n">sac_ts</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>                <span class="n">tfix</span> <span class="o">=</span> <span class="n">sac_ts</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]]</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>            <span class="c1"># Put in last (or only) fixation number</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>            <span class="k">if</span> <span class="n">tfix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>                <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>                <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Created </span><span class="si">%d</span><span class="s2"> fixations&quot;</span><span class="o">%</span><span class="n">fix_count</span><span class="p">)</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>        <span class="k">if</span> <span class="n">modify_dfs</span><span class="p">:</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>            <span class="n">invalid_fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fix_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">invalid_fix_n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>            
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>        <span class="k">return</span> <span class="n">fix_n</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>    <span class="c1"># END: MultiClouds.process_fixations()</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>    <span class="nd">@staticmethod</span> 
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>    <span class="k">def</span> <span class="nf">shift_stim</span><span class="p">(</span> <span class="n">stim</span><span class="p">,</span> <span class="n">eyepos</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">5000</span><span class="p">):</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a><span class="sd">        Shift stimulus based on eye position</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a><span class="sd">        Args:</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a><span class="sd">            stim (np.array): stimulus to shift</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a><span class="sd">            eyepos (np.array): eye position</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a><span class="sd">            input_dims (list): input dimensions</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a><span class="sd">            batch_size (int): batch size</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a><span class="sd">        Returns:</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a><span class="sd">            np.array: shifted stimulus</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>        <span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>        <span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>            <span class="k">assert</span> <span class="n">input_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;  SHIFT_STIM: stim must be unflatteded or input_dims passed in&quot;</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">input_dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>            <span class="n">to_flatten</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>            <span class="n">to_flatten</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>        <span class="c1"># Determine scaling for translation</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>        <span class="n">Lscale</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">/</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>        <span class="n">stim_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>            <span class="s1">&#39;ts&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>  <span class="c1"># keep track of indices for remapping</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>            <span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>            <span class="s1">&#39;eyepos&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">eyepos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">*</span><span class="n">Lscale</span> <span class="p">}</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>        <span class="n">ds</span> <span class="o">=</span> <span class="n">GenericDataset</span><span class="p">(</span><span class="n">stim_data</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>        <span class="c1">#ds.covariates[&#39;stim&#39;] = ds.covariates[&#39;stim&#39;].flatten(start_dim=1)</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>        <span class="n">dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>        <span class="n">stimSH</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_data</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">])</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dl</span><span class="p">):</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>            <span class="n">stimSH</span><span class="p">[</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">MultiClouds</span><span class="o">.</span><span class="n">shift_im</span><span class="p">(</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>                <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;eyepos&#39;</span><span class="p">][:,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> 
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>                <span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>        
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>        <span class="k">if</span> <span class="n">to_flatten</span><span class="p">:</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>            <span class="n">stimSH</span> <span class="o">=</span> <span class="n">stimSH</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">start_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>        <span class="k">return</span> <span class="n">stimSH</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>    
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>    <span class="k">def</span> <span class="nf">shift_im</span><span class="p">(</span> <span class="n">stim</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a><span class="sd">        Primary function for shifting the intput stimulus</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a><span class="sd">        Args:</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a><span class="sd">            stim: [Batch x channels x height x width] (use Fold2d to fold lags if necessary)</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a><span class="sd">            shift: [Batch x 2] or [Batch x 4] if translation only or affine</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a><span class="sd">            affine: [Boolean] set to True if using affine transformation</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a><span class="sd">            mode: [str] &#39;bilinear&#39; (default) or &#39;nearest&#39;</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a><span class="sd">            batch_size: [int] if None, will use all data at once</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a><span class="sd">            NOTE: mode must be bilinear during fitting otherwise the gradients don&#39;t propogate well</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a><span class="sd">        Returns:</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a><span class="sd">            torch.tensor: shifted stimulus</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>        <span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>        <span class="c1"># build affine transformation matrix size = [batch x 2 x 3]</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>        <span class="n">affine_trans</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">stim</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">stim</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>        
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>        <span class="k">if</span> <span class="n">affine</span><span class="p">:</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>            <span class="c1"># fill in rotation and scaling</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>            <span class="n">costheta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">shift</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">.5</span><span class="p">))</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>            <span class="n">sintheta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">shift</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">.5</span><span class="p">))</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>            
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>            <span class="n">scale</span> <span class="o">=</span> <span class="n">shift</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">1.0</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">costheta</span><span class="o">*</span><span class="n">scale</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sintheta</span><span class="o">*</span><span class="n">scale</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sintheta</span><span class="o">*</span><span class="n">scale</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">costheta</span><span class="o">*</span><span class="n">scale</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>            <span class="c1"># no rotation or scaling</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>        <span class="c1"># translation</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>        <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>        <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>        <span class="n">grid</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">affine_grid</span><span class="p">(</span><span class="n">affine_trans</span><span class="p">,</span> <span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>    <span class="c1"># END shift_im</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>    <span class="k">def</span> <span class="nf">get_max_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpu_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nquad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mf">1.2</span><span class="p">):</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a><span class="sd">        get the maximum number of samples that fit in memory -- for GLM/GQM x LBFGS</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a><span class="sd">        Args:</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a><span class="sd">            gpu_n (int): GPU number</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a><span class="sd">            history_size (int): history size</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a><span class="sd">            nquad (int): number of quadrature points</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a><span class="sd">            num_cells (int): number of cells</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a><span class="sd">            buffer (float): buffer size</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a><span class="sd">        Returns:</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a><span class="sd">            int: maximum number of samples</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>        <span class="k">if</span> <span class="n">gpu_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:1&#39;</span><span class="p">)</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>        <span class="k">if</span> <span class="n">num_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>            <span class="n">num_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>        
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">total_memory</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_reserved</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_allocated</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>        <span class="n">free</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>        <span class="n">mempersample</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>    
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>        <span class="n">mempercell</span> <span class="o">=</span> <span class="n">mempersample</span> <span class="o">*</span> <span class="p">(</span><span class="n">nquad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">history_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>        <span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">*</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>        <span class="n">maxsamples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">free</span> <span class="o">-</span> <span class="n">mempercell</span><span class="o">*</span><span class="n">num_cells</span> <span class="o">-</span> <span class="n">buffer_bytes</span><span class="p">)</span> <span class="o">//</span> <span class="n">mempersample</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# samples that can fit on device: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxsamples</span><span class="p">))</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>        <span class="k">return</span> <span class="n">maxsamples</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>    <span class="c1"># END .get_max_samples</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>        <span class="c1">### THIS IS NOT USED ANY MORE BUT STILL HAS SOME GOOD CODE INSIDE ###</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>    <span class="k">def</span> <span class="nf">preload_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a><span class="sd">        Note this loads stimulus but does not time-embed</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a><span class="sd">        </span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a><span class="sd">        Returns:</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a><span class="sd">            None</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a><span class="sd">        Pre-allocate memory for data</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>        <span class="k">if</span> <span class="s1">&#39;stimET&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>            <span class="c1"># Check to see if 1-d or 2-d eye tracking</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:</span><span class="mi">100</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ET stimulus is 1-d bars.&quot;</span><span class="p">)</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Missing ETstimulus&#39;</span><span class="p">)</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>        <span class="c1">#self.eyepos = np.zeros([NT, 2], dtype=np.float32)</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>        <span class="c1">#self.frame_times = np.zeros([NT,1], dtype=np.float32)</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>        <span class="n">t_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>        <span class="n">unit_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">)):</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>            
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>            <span class="n">fhandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>            <span class="n">sz</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_counter</span><span class="p">,</span> <span class="n">t_counter</span><span class="o">+</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>            <span class="c1">#inds = self.stim_indices[expt][stim][&#39;inds&#39;]</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>            <span class="c1">#self.stim[inds, ...] = np.transpose( np.array(fhandle[self.stimname], dtype=np.float32), axes=[0,3,1,2])</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>                <span class="n">Leye</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>                <span class="n">Reye</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>                <span class="c1">#Leye = inds[np.where(self.LRpresent[inds] != 2)[0]]</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>                <span class="c1">#Reye = inds[np.where(self.LRpresent[inds] != 1)[0]]</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>                <span class="c1">#print(len(Leye), len(Reye))</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>                    <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>                    <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>                        <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>                        <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>                        <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>                        <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>                        <span class="c1">#self.stimET[Leye, np.arange(3), ...] = np.array(fhandle[&#39;stimET&#39;], dtype=np.float32)[Leye, ...]</span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>                        <span class="c1">#self.stimET[Reye, np.arange(3,6), ...] = np.array(fhandle[&#39;stimET&#39;], dtype=np.float32)[Reye, ...]</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>                        
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Monocular</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>                        <span class="c1">#print(np.array(fhandle[&#39;stimET&#39;], dtype=np.float32).shape, self.stimET[inds, 0, ...].shape)</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>            <span class="n">t_counter</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>            <span class="n">unit_counter</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a>        <span class="c1"># Adjust stimulus since stored as ints</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span> 
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">127</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">127</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">128</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">128</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Adjusting stimulus read from disk: mean | std = </span><span class="si">%0.3f</span><span class="s2"> | </span><span class="si">%0.3f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">)))</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>    <span class="c1"># END .preload_numpy()</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Have to specify stimulus before pulling data.&quot;</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>        <span class="c1">#if isinstance(idx, np.ndarray):</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>        <span class="c1">#    idx = list(idx)</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>        <span class="c1"># Convert trials to indices if trial-sample</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_sample</span><span class="p">:</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_to_array</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">))</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>                <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">ts</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_to_array</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;get_item time embedding not implemented yet&quot;</span><span class="p">)</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>                
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">/</span><span class="mi">128</span><span class="p">,</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>                   <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>                   <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)}</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>                <span class="n">robs_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs_out</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>                <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs_out</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s1">&#39;cells_out must be a list&#39;</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>                <span class="n">robs_tmp</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>                <span class="n">dfs_tmp</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">/</span><span class="mi">128</span><span class="p">,</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>                   <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">robs_tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>                   <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dfs_tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)}</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>            <span class="c1"># FIXME: we are not using fix_n at the moment</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>            <span class="c1"># if len(self.fix_n) &gt; 0:</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>            <span class="c1">#     out[&#39;fix_n&#39;] = self.fix_n[idx]</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speckled</span><span class="p">:</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>                <span class="n">M1tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mval</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>                <span class="n">M2tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Mval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M1tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Mtrn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M2tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Mval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Mtrn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_separate_eye_stim</span><span class="p">:</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>            <span class="c1"># Overwrite left stim with left eye only</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>            <span class="n">tmp_dims</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>            <span class="n">stim_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tmp_dims</span><span class="p">])</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim_tmp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;stimR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim_tmp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>            
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>        <span class="c1"># Addition whether-or-not preloaded</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Xdrift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;binocular&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>            
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">append_covariates</span><span class="p">(</span> <span class="n">out</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>     
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>        <span class="k">return</span> <span class="n">out</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>    <span class="c1"># END: MultiCloud.__get_item__</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>    <span class="c1">#@property</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>    <span class="c1">#def NT(self):</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>    <span class="c1">#    return len(self.used_inds)</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


            </section>
                <section id="MultiClouds">
                            <input id="MultiClouds-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MultiClouds</span><wbr>(<span class="base">typing.Generic[+T_co]</span>):

                <label class="view-source-button" for="MultiClouds-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds-18"><a href="#MultiClouds-18"><span class="linenos">  18</span></a><span class="k">class</span> <span class="nc">MultiClouds</span><span class="p">(</span><span class="n">SensoryBase</span><span class="p">):</span>
</span><span id="MultiClouds-19"><a href="#MultiClouds-19"><span class="linenos">  19</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-20"><a href="#MultiClouds-20"><span class="linenos">  20</span></a><span class="sd">    -- can load batches from multiple datasets</span>
</span><span id="MultiClouds-21"><a href="#MultiClouds-21"><span class="linenos">  21</span></a><span class="sd">    -- hdf5 files must have the following information:</span>
</span><span id="MultiClouds-22"><a href="#MultiClouds-22"><span class="linenos">  22</span></a><span class="sd">        Robs</span>
</span><span id="MultiClouds-23"><a href="#MultiClouds-23"><span class="linenos">  23</span></a><span class="sd">        RobsMU</span>
</span><span id="MultiClouds-24"><a href="#MultiClouds-24"><span class="linenos">  24</span></a><span class="sd">        stim: 4-d stimulus: time x nx x ny x color</span>
</span><span id="MultiClouds-25"><a href="#MultiClouds-25"><span class="linenos">  25</span></a><span class="sd">        block_inds: start and stop of &#39;trials&#39; (perhaps fixations for now)</span>
</span><span id="MultiClouds-26"><a href="#MultiClouds-26"><span class="linenos">  26</span></a><span class="sd">        other things: saccades? or should that be in trials? </span>
</span><span id="MultiClouds-27"><a href="#MultiClouds-27"><span class="linenos">  27</span></a>
</span><span id="MultiClouds-28"><a href="#MultiClouds-28"><span class="linenos">  28</span></a><span class="sd">    Constructor will take eye position, which for now is an input from data</span>
</span><span id="MultiClouds-29"><a href="#MultiClouds-29"><span class="linenos">  29</span></a><span class="sd">    generated in the session (not on disk). It should have the length size </span>
</span><span id="MultiClouds-30"><a href="#MultiClouds-30"><span class="linenos">  30</span></a><span class="sd">    of the total number of fixations x1.</span>
</span><span id="MultiClouds-31"><a href="#MultiClouds-31"><span class="linenos">  31</span></a>
</span><span id="MultiClouds-32"><a href="#MultiClouds-32"><span class="linenos">  32</span></a><span class="sd">    Input arguments (details):</span>
</span><span id="MultiClouds-33"><a href="#MultiClouds-33"><span class="linenos">  33</span></a><span class="sd">        stim_crop = None, should be of form [x1, x2, y1, y2] where each number is the </span>
</span><span id="MultiClouds-34"><a href="#MultiClouds-34"><span class="linenos">  34</span></a><span class="sd">            extreme point to be include as an index, e.g. range(x1, x2+1), ... </span>
</span><span id="MultiClouds-35"><a href="#MultiClouds-35"><span class="linenos">  35</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="MultiClouds-36"><a href="#MultiClouds-36"><span class="linenos">  36</span></a>
</span><span id="MultiClouds-37"><a href="#MultiClouds-37"><span class="linenos">  37</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="MultiClouds-38"><a href="#MultiClouds-38"><span class="linenos">  38</span></a>        <span class="n">filenames</span><span class="p">,</span>
</span><span id="MultiClouds-39"><a href="#MultiClouds-39"><span class="linenos">  39</span></a>        <span class="n">datadir</span><span class="p">,</span> 
</span><span id="MultiClouds-40"><a href="#MultiClouds-40"><span class="linenos">  40</span></a>        <span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
</span><span id="MultiClouds-41"><a href="#MultiClouds-41"><span class="linenos">  41</span></a>        <span class="n">include_MUs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="MultiClouds-42"><a href="#MultiClouds-42"><span class="linenos">  42</span></a>        <span class="n">drift_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MultiClouds-43"><a href="#MultiClouds-43"><span class="linenos">  43</span></a>        <span class="n">trial_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="MultiClouds-44"><a href="#MultiClouds-44"><span class="linenos">  44</span></a>        <span class="n">luminance_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="MultiClouds-45"><a href="#MultiClouds-45"><span class="linenos">  45</span></a>        <span class="n">LMS</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="MultiClouds-46"><a href="#MultiClouds-46"><span class="linenos">  46</span></a>        <span class="n">binocular</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># whether to include separate filters for each eye</span>
</span><span id="MultiClouds-47"><a href="#MultiClouds-47"><span class="linenos">  47</span></a>        <span class="n">eye_config</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># 0 = all, 1, 2, and 3 are options (3 = binocular)</span>
</span><span id="MultiClouds-48"><a href="#MultiClouds-48"><span class="linenos">  48</span></a>        <span class="n">eye_contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># whether to only use eye_config data that is contiguous </span>
</span><span id="MultiClouds-49"><a href="#MultiClouds-49"><span class="linenos">  49</span></a>        <span class="n">cell_lists</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MultiClouds-50"><a href="#MultiClouds-50"><span class="linenos">  50</span></a>        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
</span><span id="MultiClouds-51"><a href="#MultiClouds-51"><span class="linenos">  51</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-52"><a href="#MultiClouds-52"><span class="linenos">  52</span></a><span class="sd">        Constructor options</span>
</span><span id="MultiClouds-53"><a href="#MultiClouds-53"><span class="linenos">  53</span></a><span class="sd">        </span>
</span><span id="MultiClouds-54"><a href="#MultiClouds-54"><span class="linenos">  54</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds-55"><a href="#MultiClouds-55"><span class="linenos">  55</span></a><span class="sd">            filenames (list): list of strings of the filenames to be loaded</span>
</span><span id="MultiClouds-56"><a href="#MultiClouds-56"><span class="linenos">  56</span></a><span class="sd">            datadir (str): directory where the data is stored</span>
</span><span id="MultiClouds-57"><a href="#MultiClouds-57"><span class="linenos">  57</span></a><span class="sd">            num_lags (int): number of lags to include in the stimulus</span>
</span><span id="MultiClouds-58"><a href="#MultiClouds-58"><span class="linenos">  58</span></a><span class="sd">            include_MUs (bool): whether to include multi-units in the dataset</span>
</span><span id="MultiClouds-59"><a href="#MultiClouds-59"><span class="linenos">  59</span></a><span class="sd">            drift_interval (int): number of blocks to include in the drift term</span>
</span><span id="MultiClouds-60"><a href="#MultiClouds-60"><span class="linenos">  60</span></a><span class="sd">            trial_sample (bool): whether to sample trials for train/val/test</span>
</span><span id="MultiClouds-61"><a href="#MultiClouds-61"><span class="linenos">  61</span></a><span class="sd">            luminance_only (bool): whether to only include luminance in the stimulus</span>
</span><span id="MultiClouds-62"><a href="#MultiClouds-62"><span class="linenos">  62</span></a><span class="sd">            binocular (bool): whether to include separate filters for each eye</span>
</span><span id="MultiClouds-63"><a href="#MultiClouds-63"><span class="linenos">  63</span></a><span class="sd">            eye_config (int): which eye configuration to use (0=all, 1=left, 2=right, 3=binocular)</span>
</span><span id="MultiClouds-64"><a href="#MultiClouds-64"><span class="linenos">  64</span></a><span class="sd">            eye_contiguous (bool): whether to only use contiguous eye configurations</span>
</span><span id="MultiClouds-65"><a href="#MultiClouds-65"><span class="linenos">  65</span></a><span class="sd">            cell_lists (list): list of lists of cell indices to include in the dataset</span>
</span><span id="MultiClouds-66"><a href="#MultiClouds-66"><span class="linenos">  66</span></a><span class="sd">            device (torch.device): device to store the data on</span>
</span><span id="MultiClouds-67"><a href="#MultiClouds-67"><span class="linenos">  67</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-68"><a href="#MultiClouds-68"><span class="linenos">  68</span></a>
</span><span id="MultiClouds-69"><a href="#MultiClouds-69"><span class="linenos">  69</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="MultiClouds-70"><a href="#MultiClouds-70"><span class="linenos">  70</span></a>            <span class="n">filenames</span><span class="o">=</span><span class="n">filenames</span><span class="p">,</span> <span class="n">datadir</span><span class="o">=</span><span class="n">datadir</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
</span><span id="MultiClouds-71"><a href="#MultiClouds-71"><span class="linenos">  71</span></a>            <span class="n">time_embed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">num_lags</span><span class="p">,</span> <span class="n">include_MUs</span><span class="o">=</span><span class="n">include_MUs</span><span class="p">,</span> 
</span><span id="MultiClouds-72"><a href="#MultiClouds-72"><span class="linenos">  72</span></a>            <span class="n">drift_interval</span><span class="o">=</span><span class="n">drift_interval</span><span class="p">,</span> <span class="n">trial_sample</span><span class="o">=</span><span class="n">trial_sample</span><span class="p">)</span>
</span><span id="MultiClouds-73"><a href="#MultiClouds-73"><span class="linenos">  73</span></a>
</span><span id="MultiClouds-74"><a href="#MultiClouds-74"><span class="linenos">  74</span></a>        <span class="c1"># Done in parent constructor</span>
</span><span id="MultiClouds-75"><a href="#MultiClouds-75"><span class="linenos">  75</span></a>        <span class="c1">#self.datadir = datadir</span>
</span><span id="MultiClouds-76"><a href="#MultiClouds-76"><span class="linenos">  76</span></a>        <span class="c1">#self.filenames = filenames</span>
</span><span id="MultiClouds-77"><a href="#MultiClouds-77"><span class="linenos">  77</span></a>        <span class="c1">#self.device = device</span>
</span><span id="MultiClouds-78"><a href="#MultiClouds-78"><span class="linenos">  78</span></a>        <span class="c1">#self.num_lags = 10  # default: to be set later</span>
</span><span id="MultiClouds-79"><a href="#MultiClouds-79"><span class="linenos">  79</span></a>        <span class="c1">#if time_embed == 2:</span>
</span><span id="MultiClouds-80"><a href="#MultiClouds-80"><span class="linenos">  80</span></a>        <span class="c1">#    assert preload, &quot;Cannot pre-time-embed without preloading.&quot;</span>
</span><span id="MultiClouds-81"><a href="#MultiClouds-81"><span class="linenos">  81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># not set</span>
</span><span id="MultiClouds-82"><a href="#MultiClouds-82"><span class="linenos">  82</span></a>        <span class="c1">#self.preload = preload</span>
</span><span id="MultiClouds-83"><a href="#MultiClouds-83"><span class="linenos">  83</span></a>
</span><span id="MultiClouds-84"><a href="#MultiClouds-84"><span class="linenos">  84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
</span><span id="MultiClouds-85"><a href="#MultiClouds-85"><span class="linenos">  85</span></a>
</span><span id="MultiClouds-86"><a href="#MultiClouds-86"><span class="linenos">  86</span></a>        <span class="c1"># Stim-specific</span>
</span><span id="MultiClouds-87"><a href="#MultiClouds-87"><span class="linenos">  87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">=</span> <span class="n">eye_config</span>
</span><span id="MultiClouds-88"><a href="#MultiClouds-88"><span class="linenos">  88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eye_contiguous</span> <span class="o">=</span> <span class="n">eye_contiguous</span>
</span><span id="MultiClouds-89"><a href="#MultiClouds-89"><span class="linenos">  89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span> <span class="o">=</span> <span class="n">binocular</span>
</span><span id="MultiClouds-90"><a href="#MultiClouds-90"><span class="linenos">  90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span> <span class="o">=</span> <span class="n">luminance_only</span>
</span><span id="MultiClouds-91"><a href="#MultiClouds-91"><span class="linenos">  91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">includeMUs</span> <span class="o">=</span> <span class="n">include_MUs</span>
</span><span id="MultiClouds-92"><a href="#MultiClouds-92"><span class="linenos">  92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_Xfix</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="MultiClouds-93"><a href="#MultiClouds-93"><span class="linenos">  93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_separate_eye_stim</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="MultiClouds-94"><a href="#MultiClouds-94"><span class="linenos">  94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">expt_stims</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span>
</span><span id="MultiClouds-95"><a href="#MultiClouds-95"><span class="linenos">  95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MultiClouds-96"><a href="#MultiClouds-96"><span class="linenos">  96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">LMS</span> <span class="o">=</span> <span class="n">LMS</span>
</span><span id="MultiClouds-97"><a href="#MultiClouds-97"><span class="linenos">  97</span></a>        
</span><span id="MultiClouds-98"><a href="#MultiClouds-98"><span class="linenos">  98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds-99"><a href="#MultiClouds-99"><span class="linenos">  99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span> <span class="o">=</span> <span class="n">drift_interval</span>
</span><span id="MultiClouds-100"><a href="#MultiClouds-100"><span class="linenos"> 100</span></a>
</span><span id="MultiClouds-101"><a href="#MultiClouds-101"><span class="linenos"> 101</span></a>        <span class="c1"># Set up to store default train_, val_, test_inds -- in SensoryBase</span>
</span><span id="MultiClouds-102"><a href="#MultiClouds-102"><span class="linenos"> 102</span></a>        <span class="c1">#self.test_inds = None</span>
</span><span id="MultiClouds-103"><a href="#MultiClouds-103"><span class="linenos"> 103</span></a>        <span class="c1">#self.val_inds = None</span>
</span><span id="MultiClouds-104"><a href="#MultiClouds-104"><span class="linenos"> 104</span></a>        <span class="c1">#self.train_inds = None</span>
</span><span id="MultiClouds-105"><a href="#MultiClouds-105"><span class="linenos"> 105</span></a>        <span class="c1">#self.used_inds = []</span>
</span><span id="MultiClouds-106"><a href="#MultiClouds-106"><span class="linenos"> 106</span></a>
</span><span id="MultiClouds-107"><a href="#MultiClouds-107"><span class="linenos"> 107</span></a>        <span class="c1"># Data to construct and store in memory -- some in SensoryBase</span>
</span><span id="MultiClouds-108"><a href="#MultiClouds-108"><span class="linenos"> 108</span></a>        <span class="c1">#self.stim = []</span>
</span><span id="MultiClouds-109"><a href="#MultiClouds-109"><span class="linenos"> 109</span></a>        <span class="c1">#self.dfs = []</span>
</span><span id="MultiClouds-110"><a href="#MultiClouds-110"><span class="linenos"> 110</span></a>        <span class="c1">#self.robs = []</span>
</span><span id="MultiClouds-111"><a href="#MultiClouds-111"><span class="linenos"> 111</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiClouds-112"><a href="#MultiClouds-112"><span class="linenos"> 112</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds-113"><a href="#MultiClouds-113"><span class="linenos"> 113</span></a>
</span><span id="MultiClouds-114"><a href="#MultiClouds-114"><span class="linenos"> 114</span></a>        <span class="c1"># build index map -- exclude variables already set in sensory-base</span>
</span><span id="MultiClouds-115"><a href="#MultiClouds-115"><span class="linenos"> 115</span></a>        <span class="c1">#self.num_blks = np.zeros(len(filenames), dtype=int)</span>
</span><span id="MultiClouds-116"><a href="#MultiClouds-116"><span class="linenos"> 116</span></a>        <span class="c1">#self.file_index = [] # which file the block corresponds to</span>
</span><span id="MultiClouds-117"><a href="#MultiClouds-117"><span class="linenos"> 117</span></a>        <span class="c1">#self.stim_dims = None</span>
</span><span id="MultiClouds-118"><a href="#MultiClouds-118"><span class="linenos"> 118</span></a>
</span><span id="MultiClouds-119"><a href="#MultiClouds-119"><span class="linenos"> 119</span></a>        <span class="c1">#self.unit_ids = []</span>
</span><span id="MultiClouds-120"><a href="#MultiClouds-120"><span class="linenos"> 120</span></a>        <span class="c1">#self.num_units, self.num_SUs, self.num_MUs = [], [], []</span>
</span><span id="MultiClouds-121"><a href="#MultiClouds-121"><span class="linenos"> 121</span></a>        <span class="c1">#self.SUs = []</span>
</span><span id="MultiClouds-122"><a href="#MultiClouds-122"><span class="linenos"> 122</span></a>        <span class="c1">#self.NC = 0    </span>
</span><span id="MultiClouds-123"><a href="#MultiClouds-123"><span class="linenos"> 123</span></a>        <span class="c1">#self.block_inds = []</span>
</span><span id="MultiClouds-124"><a href="#MultiClouds-124"><span class="linenos"> 124</span></a>        <span class="c1">#self.block_filemapping = []</span>
</span><span id="MultiClouds-125"><a href="#MultiClouds-125"><span class="linenos"> 125</span></a>        <span class="c1">#self.include_MUs = include_MUs</span>
</span><span id="MultiClouds-126"><a href="#MultiClouds-126"><span class="linenos"> 126</span></a>        <span class="c1">#self.SUinds = []</span>
</span><span id="MultiClouds-127"><a href="#MultiClouds-127"><span class="linenos"> 127</span></a>        <span class="c1">#self.MUinds = []</span>
</span><span id="MultiClouds-128"><a href="#MultiClouds-128"><span class="linenos"> 128</span></a>        <span class="c1">#self.cells_out = []  # can be list to output specific cells in get_item</span>
</span><span id="MultiClouds-129"><a href="#MultiClouds-129"><span class="linenos"> 129</span></a>        <span class="c1">#self.avRs = None</span>
</span><span id="MultiClouds-130"><a href="#MultiClouds-130"><span class="linenos"> 130</span></a>
</span><span id="MultiClouds-131"><a href="#MultiClouds-131"><span class="linenos"> 131</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">sess</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>
</span><span id="MultiClouds-132"><a href="#MultiClouds-132"><span class="linenos"> 132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span>
</span><span id="MultiClouds-133"><a href="#MultiClouds-133"><span class="linenos"> 133</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds-134"><a href="#MultiClouds-134"><span class="linenos"> 134</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fileNBLK</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds-135"><a href="#MultiClouds-135"><span class="linenos"> 135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds-136"><a href="#MultiClouds-136"><span class="linenos"> 136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fileNA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="c1"># for the drift term</span>
</span><span id="MultiClouds-137"><a href="#MultiClouds-137"><span class="linenos"> 137</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_tstart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds-138"><a href="#MultiClouds-138"><span class="linenos"> 138</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_blkstart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds-139"><a href="#MultiClouds-139"><span class="linenos"> 139</span></a>
</span><span id="MultiClouds-140"><a href="#MultiClouds-140"><span class="linenos"> 140</span></a>        <span class="n">tcount</span><span class="p">,</span> <span class="n">blkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="MultiClouds-141"><a href="#MultiClouds-141"><span class="linenos"> 141</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tranges</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span>
</span><span id="MultiClouds-142"><a href="#MultiClouds-142"><span class="linenos"> 142</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span>
</span><span id="MultiClouds-143"><a href="#MultiClouds-143"><span class="linenos"> 143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiClouds-144"><a href="#MultiClouds-144"><span class="linenos"> 144</span></a>
</span><span id="MultiClouds-145"><a href="#MultiClouds-145"><span class="linenos"> 145</span></a>        <span class="c1"># Structure of file on time/trial level</span>
</span><span id="MultiClouds-146"><a href="#MultiClouds-146"><span class="linenos"> 146</span></a> 
</span><span id="MultiClouds-147"><a href="#MultiClouds-147"><span class="linenos"> 147</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">):</span>
</span><span id="MultiClouds-148"><a href="#MultiClouds-148"><span class="linenos"> 148</span></a>            <span class="c1"># get hdf5 file handles</span>
</span><span id="MultiClouds-149"><a href="#MultiClouds-149"><span class="linenos"> 149</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file_info</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">filenames</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="MultiClouds-150"><a href="#MultiClouds-150"><span class="linenos"> 150</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="MultiClouds-151"><a href="#MultiClouds-151"><span class="linenos"> 151</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NSUs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NMUs&#39;</span><span class="p">]</span>
</span><span id="MultiClouds-152"><a href="#MultiClouds-152"><span class="linenos"> 152</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-153"><a href="#MultiClouds-153"><span class="linenos"> 153</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NSUs&#39;</span><span class="p">]</span>
</span><span id="MultiClouds-154"><a href="#MultiClouds-154"><span class="linenos"> 154</span></a>
</span><span id="MultiClouds-155"><a href="#MultiClouds-155"><span class="linenos"> 155</span></a>            <span class="c1"># Consolidate valid t-ranges based on binocular choice</span>
</span><span id="MultiClouds-156"><a href="#MultiClouds-156"><span class="linenos"> 156</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;tmap&#39;</span><span class="p">]</span>
</span><span id="MultiClouds-157"><a href="#MultiClouds-157"><span class="linenos"> 157</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds-158"><a href="#MultiClouds-158"><span class="linenos"> 158</span></a>            <span class="c1"># Make one long block-list</span>
</span><span id="MultiClouds-159"><a href="#MultiClouds-159"><span class="linenos"> 159</span></a>            <span class="n">NBLK</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;trial_info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-160"><a href="#MultiClouds-160"><span class="linenos"> 160</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NBLK</span><span class="p">):</span>
</span><span id="MultiClouds-161"><a href="#MultiClouds-161"><span class="linenos"> 161</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> 
</span><span id="MultiClouds-162"><a href="#MultiClouds-162"><span class="linenos"> 162</span></a>                    <span class="n">tcount</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;trial_info&#39;</span><span class="p">][</span><span class="n">bb</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;trial_info&#39;</span><span class="p">][</span><span class="n">bb</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
</span><span id="MultiClouds-163"><a href="#MultiClouds-163"><span class="linenos"> 163</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fileNBLK</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;trial_info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-164"><a href="#MultiClouds-164"><span class="linenos"> 164</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">file_blkstart</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">blkcount</span>
</span><span id="MultiClouds-165"><a href="#MultiClouds-165"><span class="linenos"> 165</span></a>            <span class="n">blkcount</span> <span class="o">+=</span> <span class="n">NBLK</span>
</span><span id="MultiClouds-166"><a href="#MultiClouds-166"><span class="linenos"> 166</span></a>
</span><span id="MultiClouds-167"><a href="#MultiClouds-167"><span class="linenos"> 167</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NT&#39;</span><span class="p">]</span>
</span><span id="MultiClouds-168"><a href="#MultiClouds-168"><span class="linenos"> 168</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">file_tstart</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">tcount</span>
</span><span id="MultiClouds-169"><a href="#MultiClouds-169"><span class="linenos"> 169</span></a>            <span class="n">tcount</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NT&#39;</span><span class="p">]</span>
</span><span id="MultiClouds-170"><a href="#MultiClouds-170"><span class="linenos"> 170</span></a>
</span><span id="MultiClouds-171"><a href="#MultiClouds-171"><span class="linenos"> 171</span></a>        <span class="c1"># Assemble robs and dfs given current information</span>
</span><span id="MultiClouds-172"><a href="#MultiClouds-172"><span class="linenos"> 172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">=</span> <span class="n">tcount</span>
</span><span id="MultiClouds-173"><a href="#MultiClouds-173"><span class="linenos"> 173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">)</span>
</span><span id="MultiClouds-174"><a href="#MultiClouds-174"><span class="linenos"> 174</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> total time steps, </span><span class="si">%d</span><span class="s2"> units&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">)</span> <span class="p">)</span>
</span><span id="MultiClouds-175"><a href="#MultiClouds-175"><span class="linenos"> 175</span></a>        <span class="k">if</span> <span class="n">cell_lists</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-176"><a href="#MultiClouds-176"><span class="linenos"> 176</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">modify_included_cells</span><span class="p">(</span><span class="n">cell_lists</span><span class="p">)</span>
</span><span id="MultiClouds-177"><a href="#MultiClouds-177"><span class="linenos"> 177</span></a>            <span class="c1"># this will automatically assemble_robs at the end</span>
</span><span id="MultiClouds-178"><a href="#MultiClouds-178"><span class="linenos"> 178</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-179"><a href="#MultiClouds-179"><span class="linenos"> 179</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">assemble_robs</span><span class="p">()</span>
</span><span id="MultiClouds-180"><a href="#MultiClouds-180"><span class="linenos"> 180</span></a> 
</span><span id="MultiClouds-181"><a href="#MultiClouds-181"><span class="linenos"> 181</span></a>        <span class="c1"># Assemble current list of fixations</span>
</span><span id="MultiClouds-182"><a href="#MultiClouds-182"><span class="linenos"> 182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span>
</span><span id="MultiClouds-183"><a href="#MultiClouds-183"><span class="linenos"> 183</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_shifts</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span>
</span><span id="MultiClouds-184"><a href="#MultiClouds-184"><span class="linenos"> 184</span></a>        <span class="n">to_assemble</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="MultiClouds-185"><a href="#MultiClouds-185"><span class="linenos"> 185</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">):</span>
</span><span id="MultiClouds-186"><a href="#MultiClouds-186"><span class="linenos"> 186</span></a>            <span class="n">sacc_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;sacc_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds-187"><a href="#MultiClouds-187"><span class="linenos"> 187</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sacc_inds</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># assume its no good</span>
</span><span id="MultiClouds-188"><a href="#MultiClouds-188"><span class="linenos"> 188</span></a>                <span class="n">sacc_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MultiClouds-189"><a href="#MultiClouds-189"><span class="linenos"> 189</span></a>                <span class="n">to_assemble</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="MultiClouds-190"><a href="#MultiClouds-190"><span class="linenos"> 190</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-191"><a href="#MultiClouds-191"><span class="linenos"> 191</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sacc_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MultiClouds-192"><a href="#MultiClouds-192"><span class="linenos"> 192</span></a>                    <span class="n">sacc_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># convert to python so range works</span>
</span><span id="MultiClouds-193"><a href="#MultiClouds-193"><span class="linenos"> 193</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-194"><a href="#MultiClouds-194"><span class="linenos"> 194</span></a>                    <span class="n">sacc_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MultiClouds-195"><a href="#MultiClouds-195"><span class="linenos"> 195</span></a>                    <span class="n">to_assemble</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="MultiClouds-196"><a href="#MultiClouds-196"><span class="linenos"> 196</span></a>
</span><span id="MultiClouds-197"><a href="#MultiClouds-197"><span class="linenos"> 197</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sacc_inds</span><span class="p">)</span>
</span><span id="MultiClouds-198"><a href="#MultiClouds-198"><span class="linenos"> 198</span></a>
</span><span id="MultiClouds-199"><a href="#MultiClouds-199"><span class="linenos"> 199</span></a>        <span class="c1">#if to_assemble:</span>
</span><span id="MultiClouds-200"><a href="#MultiClouds-200"><span class="linenos"> 200</span></a>        <span class="c1">#    self.assemble_saccade_inds()</span>
</span><span id="MultiClouds-201"><a href="#MultiClouds-201"><span class="linenos"> 201</span></a>
</span><span id="MultiClouds-202"><a href="#MultiClouds-202"><span class="linenos"> 202</span></a>        <span class="c1">### Construct drift term if relevant</span>
</span><span id="MultiClouds-203"><a href="#MultiClouds-203"><span class="linenos"> 203</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-204"><a href="#MultiClouds-204"><span class="linenos"> 204</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MultiClouds-205"><a href="#MultiClouds-205"><span class="linenos"> 205</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-206"><a href="#MultiClouds-206"><span class="linenos"> 206</span></a>            <span class="n">Nanchors_tot</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds-207"><a href="#MultiClouds-207"><span class="linenos"> 207</span></a>            <span class="c1"># Make drift for each dataset</span>
</span><span id="MultiClouds-208"><a href="#MultiClouds-208"><span class="linenos"> 208</span></a>            <span class="n">Xdrift_expts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiClouds-209"><a href="#MultiClouds-209"><span class="linenos"> 209</span></a>            <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">):</span>
</span><span id="MultiClouds-210"><a href="#MultiClouds-210"><span class="linenos"> 210</span></a>                <span class="n">NBL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileNBLK</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span>
</span><span id="MultiClouds-211"><a href="#MultiClouds-211"><span class="linenos"> 211</span></a>                <span class="n">Nanchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">NBL</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="MultiClouds-212"><a href="#MultiClouds-212"><span class="linenos"> 212</span></a>                <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds-213"><a href="#MultiClouds-213"><span class="linenos"> 213</span></a>                <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">):</span>
</span><span id="MultiClouds-214"><a href="#MultiClouds-214"><span class="linenos"> 214</span></a>                    <span class="n">anchors</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span><span class="o">*</span><span class="n">bb</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-215"><a href="#MultiClouds-215"><span class="linenos"> 215</span></a>                <span class="c1">#self.Xdrift = utils.design_matrix_drift( self.NT, anchors, zero_left=False, const_right=True)</span>
</span><span id="MultiClouds-216"><a href="#MultiClouds-216"><span class="linenos"> 216</span></a>                <span class="n">Xdrift_expts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="MultiClouds-217"><a href="#MultiClouds-217"><span class="linenos"> 217</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fileNA</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">Nanchors</span> <span class="c1"># store the number of anchors for each file</span>
</span><span id="MultiClouds-218"><a href="#MultiClouds-218"><span class="linenos"> 218</span></a>                <span class="n">Nanchors_tot</span> <span class="o">+=</span> <span class="n">Nanchors</span>
</span><span id="MultiClouds-219"><a href="#MultiClouds-219"><span class="linenos"> 219</span></a>
</span><span id="MultiClouds-220"><a href="#MultiClouds-220"><span class="linenos"> 220</span></a>            <span class="c1"># Assemble whole drift matrix</span>
</span><span id="MultiClouds-221"><a href="#MultiClouds-221"><span class="linenos"> 221</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">Nanchors_tot</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="MultiClouds-222"><a href="#MultiClouds-222"><span class="linenos"> 222</span></a>            <span class="n">anchor_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds-223"><a href="#MultiClouds-223"><span class="linenos"> 223</span></a>            <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">):</span>
</span><span id="MultiClouds-224"><a href="#MultiClouds-224"><span class="linenos"> 224</span></a>                <span class="n">tslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="n">Nanchors_tot</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="MultiClouds-225"><a href="#MultiClouds-225"><span class="linenos"> 225</span></a>                <span class="n">tslice</span><span class="p">[:,</span> <span class="n">anchor_count</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Xdrift_expts</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="n">Xdrift_expts</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span>
</span><span id="MultiClouds-226"><a href="#MultiClouds-226"><span class="linenos"> 226</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">file_tstart</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">ff</span><span class="p">]),</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tslice</span><span class="p">)</span>
</span><span id="MultiClouds-227"><a href="#MultiClouds-227"><span class="linenos"> 227</span></a>                <span class="n">anchor_count</span> <span class="o">+=</span> <span class="n">Xdrift_expts</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds-228"><a href="#MultiClouds-228"><span class="linenos"> 228</span></a>
</span><span id="MultiClouds-229"><a href="#MultiClouds-229"><span class="linenos"> 229</span></a>        <span class="c1"># set up train, val and test inds and blks</span>
</span><span id="MultiClouds-230"><a href="#MultiClouds-230"><span class="linenos"> 230</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crossval_setup</span><span class="p">(</span><span class="n">test_set</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="MultiClouds-231"><a href="#MultiClouds-231"><span class="linenos"> 231</span></a>    <span class="c1"># END MultiClouds.__init__</span>
</span><span id="MultiClouds-232"><a href="#MultiClouds-232"><span class="linenos"> 232</span></a>
</span><span id="MultiClouds-233"><a href="#MultiClouds-233"><span class="linenos"> 233</span></a>    <span class="k">def</span> <span class="nf">read_file_info</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">file_n</span><span class="p">,</span> <span class="n">filename</span> <span class="p">):</span>
</span><span id="MultiClouds-234"><a href="#MultiClouds-234"><span class="linenos"> 234</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-235"><a href="#MultiClouds-235"><span class="linenos"> 235</span></a><span class="sd">        Initial processing of each file to pull out salient info for building stim and responses</span>
</span><span id="MultiClouds-236"><a href="#MultiClouds-236"><span class="linenos"> 236</span></a><span class="sd">        </span>
</span><span id="MultiClouds-237"><a href="#MultiClouds-237"><span class="linenos"> 237</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds-238"><a href="#MultiClouds-238"><span class="linenos"> 238</span></a><span class="sd">            file_n (int): index of the file</span>
</span><span id="MultiClouds-239"><a href="#MultiClouds-239"><span class="linenos"> 239</span></a><span class="sd">            filename (str): name of the file</span>
</span><span id="MultiClouds-240"><a href="#MultiClouds-240"><span class="linenos"> 240</span></a>
</span><span id="MultiClouds-241"><a href="#MultiClouds-241"><span class="linenos"> 241</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds-242"><a href="#MultiClouds-242"><span class="linenos"> 242</span></a><span class="sd">            dict: dictionary of file information</span>
</span><span id="MultiClouds-243"><a href="#MultiClouds-243"><span class="linenos"> 243</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-244"><a href="#MultiClouds-244"><span class="linenos"> 244</span></a>
</span><span id="MultiClouds-245"><a href="#MultiClouds-245"><span class="linenos"> 245</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">file_n</span><span class="p">]</span>
</span><span id="MultiClouds-246"><a href="#MultiClouds-246"><span class="linenos"> 246</span></a>        <span class="n">NT</span><span class="p">,</span> <span class="n">NSUs</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="MultiClouds-247"><a href="#MultiClouds-247"><span class="linenos"> 247</span></a>        <span class="c1"># Check for valid RobsMU</span>
</span><span id="MultiClouds-248"><a href="#MultiClouds-248"><span class="linenos"> 248</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MultiClouds-249"><a href="#MultiClouds-249"><span class="linenos"> 249</span></a>            <span class="n">NMUs</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds-250"><a href="#MultiClouds-250"><span class="linenos"> 250</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="MultiClouds-251"><a href="#MultiClouds-251"><span class="linenos"> 251</span></a>            <span class="n">NMUs</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds-252"><a href="#MultiClouds-252"><span class="linenos"> 252</span></a>
</span><span id="MultiClouds-253"><a href="#MultiClouds-253"><span class="linenos"> 253</span></a>        <span class="c1"># Unit information</span>
</span><span id="MultiClouds-254"><a href="#MultiClouds-254"><span class="linenos"> 254</span></a>        <span class="n">channel_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Robs_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="MultiClouds-255"><a href="#MultiClouds-255"><span class="linenos"> 255</span></a>        <span class="n">channel_ratings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Robs_rating&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="MultiClouds-256"><a href="#MultiClouds-256"><span class="linenos"> 256</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">NMUs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeMUs</span><span class="p">:</span>
</span><span id="MultiClouds-257"><a href="#MultiClouds-257"><span class="linenos"> 257</span></a>            <span class="n">channel_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> 
</span><span id="MultiClouds-258"><a href="#MultiClouds-258"><span class="linenos"> 258</span></a>                <span class="p">(</span><span class="n">channel_map</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;RobsMU_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MultiClouds-259"><a href="#MultiClouds-259"><span class="linenos"> 259</span></a>            <span class="n">channel_ratings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> 
</span><span id="MultiClouds-260"><a href="#MultiClouds-260"><span class="linenos"> 260</span></a>                <span class="p">(</span><span class="n">channel_ratings</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;RobsMU_rating&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MultiClouds-261"><a href="#MultiClouds-261"><span class="linenos"> 261</span></a>
</span><span id="MultiClouds-262"><a href="#MultiClouds-262"><span class="linenos"> 262</span></a>        <span class="c1"># Block information</span>
</span><span id="MultiClouds-263"><a href="#MultiClouds-263"><span class="linenos"> 263</span></a>        <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;block_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds-264"><a href="#MultiClouds-264"><span class="linenos"> 264</span></a>        <span class="n">blk_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># convert to python so range works</span>
</span><span id="MultiClouds-265"><a href="#MultiClouds-265"><span class="linenos"> 265</span></a>        <span class="c1"># Check to make sure not inverted blk_inds (older version of data)</span>
</span><span id="MultiClouds-266"><a href="#MultiClouds-266"><span class="linenos"> 266</span></a>        <span class="k">if</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="MultiClouds-267"><a href="#MultiClouds-267"><span class="linenos"> 267</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: blk_inds is stored old-style: transposing&#39;</span><span class="p">)</span>
</span><span id="MultiClouds-268"><a href="#MultiClouds-268"><span class="linenos"> 268</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">T</span>
</span><span id="MultiClouds-269"><a href="#MultiClouds-269"><span class="linenos"> 269</span></a>        <span class="n">NBLK</span> <span class="o">=</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-270"><a href="#MultiClouds-270"><span class="linenos"> 270</span></a>
</span><span id="MultiClouds-271"><a href="#MultiClouds-271"><span class="linenos"> 271</span></a>        <span class="c1"># Stim information</span>
</span><span id="MultiClouds-272"><a href="#MultiClouds-272"><span class="linenos"> 272</span></a>        <span class="n">fix_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;fix_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="MultiClouds-273"><a href="#MultiClouds-273"><span class="linenos"> 273</span></a>        <span class="n">fix_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;fix_size&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="MultiClouds-274"><a href="#MultiClouds-274"><span class="linenos"> 274</span></a>        <span class="n">stim_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;stimscale&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="MultiClouds-275"><a href="#MultiClouds-275"><span class="linenos"> 275</span></a>        <span class="n">stim_locsLP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;stim_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
</span><span id="MultiClouds-276"><a href="#MultiClouds-276"><span class="linenos"> 276</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_locsLP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># then list of arrays for some reason</span>
</span><span id="MultiClouds-277"><a href="#MultiClouds-277"><span class="linenos"> 277</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  FILE_INFO: stim_locsLP list again -- ok but output check&#39;</span><span class="p">)</span>
</span><span id="MultiClouds-278"><a href="#MultiClouds-278"><span class="linenos"> 278</span></a>            <span class="n">stim_locsLP</span> <span class="o">=</span> <span class="n">stim_locsLP</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-279"><a href="#MultiClouds-279"><span class="linenos"> 279</span></a>        <span class="n">stim_locsET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;ETstim_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds-280"><a href="#MultiClouds-280"><span class="linenos"> 280</span></a>        <span class="n">blockIDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;blockID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>  <span class="c1"># what is this?</span>
</span><span id="MultiClouds-281"><a href="#MultiClouds-281"><span class="linenos"> 281</span></a>        <span class="c1">#self.ETtrace = np.array(f[&#39;ETtrace&#39;], dtype=np.float32)</span>
</span><span id="MultiClouds-282"><a href="#MultiClouds-282"><span class="linenos"> 282</span></a>        <span class="c1">#self.ETtraceHR = np.array(f[&#39;ETtrace_raw&#39;], dtype=np.float32)</span>
</span><span id="MultiClouds-283"><a href="#MultiClouds-283"><span class="linenos"> 283</span></a>
</span><span id="MultiClouds-284"><a href="#MultiClouds-284"><span class="linenos"> 284</span></a>        <span class="c1"># Binocular information</span>
</span><span id="MultiClouds-285"><a href="#MultiClouds-285"><span class="linenos"> 285</span></a>        <span class="n">Lpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;useLeye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-286"><a href="#MultiClouds-286"><span class="linenos"> 286</span></a>        <span class="n">Rpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-287"><a href="#MultiClouds-287"><span class="linenos"> 287</span></a>        <span class="n">LRpresent</span> <span class="o">=</span> <span class="n">Lpresent</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Rpresent</span>
</span><span id="MultiClouds-288"><a href="#MultiClouds-288"><span class="linenos"> 288</span></a>
</span><span id="MultiClouds-289"><a href="#MultiClouds-289"><span class="linenos"> 289</span></a>        <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;valid_data&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>  <span class="c1">#range(self.NT)  # default -- to be changed at end of init</span>
</span><span id="MultiClouds-290"><a href="#MultiClouds-290"><span class="linenos"> 290</span></a>
</span><span id="MultiClouds-291"><a href="#MultiClouds-291"><span class="linenos"> 291</span></a>        <span class="c1"># Parse timing and block information given eye_config</span>
</span><span id="MultiClouds-292"><a href="#MultiClouds-292"><span class="linenos"> 292</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds-293"><a href="#MultiClouds-293"><span class="linenos"> 293</span></a>            <span class="n">tmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NT</span><span class="p">)</span>
</span><span id="MultiClouds-294"><a href="#MultiClouds-294"><span class="linenos"> 294</span></a>            <span class="n">bmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NBLK</span><span class="p">)</span>
</span><span id="MultiClouds-295"><a href="#MultiClouds-295"><span class="linenos"> 295</span></a>            <span class="n">block_inds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">)</span>
</span><span id="MultiClouds-296"><a href="#MultiClouds-296"><span class="linenos"> 296</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-297"><a href="#MultiClouds-297"><span class="linenos"> 297</span></a>            <span class="n">tmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LRpresent</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-298"><a href="#MultiClouds-298"><span class="linenos"> 298</span></a>            <span class="c1"># Check for contiguous option (throw away disjoint eye config)</span>
</span><span id="MultiClouds-299"><a href="#MultiClouds-299"><span class="linenos"> 299</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_contiguous</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="MultiClouds-300"><a href="#MultiClouds-300"><span class="linenos"> 300</span></a>                <span class="n">tbreaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tmap</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-301"><a href="#MultiClouds-301"><span class="linenos"> 301</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbreaks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds-302"><a href="#MultiClouds-302"><span class="linenos"> 302</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Disjoint data exists with this eye_config -- trunctating to first section.&quot;</span><span class="p">)</span>
</span><span id="MultiClouds-303"><a href="#MultiClouds-303"><span class="linenos"> 303</span></a>                    <span class="n">tmap</span> <span class="o">=</span> <span class="n">tmap</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">tbreaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="MultiClouds-304"><a href="#MultiClouds-304"><span class="linenos"> 304</span></a>
</span><span id="MultiClouds-305"><a href="#MultiClouds-305"><span class="linenos"> 305</span></a>            <span class="c1"># Remap valid_inds to smaller trange -- does not use val_track: just temp variable</span>
</span><span id="MultiClouds-306"><a href="#MultiClouds-306"><span class="linenos"> 306</span></a>            <span class="n">val_track</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds-307"><a href="#MultiClouds-307"><span class="linenos"> 307</span></a>            <span class="n">val_track</span><span class="p">[</span><span class="n">valid_inds</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MultiClouds-308"><a href="#MultiClouds-308"><span class="linenos"> 308</span></a>            <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">val_track</span><span class="p">[</span><span class="n">tmap</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-309"><a href="#MultiClouds-309"><span class="linenos"> 309</span></a>
</span><span id="MultiClouds-310"><a href="#MultiClouds-310"><span class="linenos"> 310</span></a>            <span class="n">NT</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmap</span><span class="p">)</span>
</span><span id="MultiClouds-311"><a href="#MultiClouds-311"><span class="linenos"> 311</span></a> 
</span><span id="MultiClouds-312"><a href="#MultiClouds-312"><span class="linenos"> 312</span></a>            <span class="c1"># Remap block_inds to reduced map</span>
</span><span id="MultiClouds-313"><a href="#MultiClouds-313"><span class="linenos"> 313</span></a>            <span class="n">bmap</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiClouds-314"><a href="#MultiClouds-314"><span class="linenos"> 314</span></a>            <span class="n">tcount</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds-315"><a href="#MultiClouds-315"><span class="linenos"> 315</span></a>            <span class="n">block_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiClouds-316"><a href="#MultiClouds-316"><span class="linenos"> 316</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NBLK</span><span class="p">):</span>
</span><span id="MultiClouds-317"><a href="#MultiClouds-317"><span class="linenos"> 317</span></a>                <span class="k">if</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">tmap</span><span class="p">:</span>
</span><span id="MultiClouds-318"><a href="#MultiClouds-318"><span class="linenos"> 318</span></a>                    <span class="n">bmap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
</span><span id="MultiClouds-319"><a href="#MultiClouds-319"><span class="linenos"> 319</span></a>                    <span class="n">NTblk</span> <span class="o">=</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">blk_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-320"><a href="#MultiClouds-320"><span class="linenos"> 320</span></a>                    <span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">tcount</span><span class="p">,</span> <span class="n">tcount</span><span class="o">+</span><span class="n">NTblk</span><span class="p">])</span>
</span><span id="MultiClouds-321"><a href="#MultiClouds-321"><span class="linenos"> 321</span></a>                    <span class="n">tcount</span> <span class="o">+=</span> <span class="n">NTblk</span>
</span><span id="MultiClouds-322"><a href="#MultiClouds-322"><span class="linenos"> 322</span></a>            <span class="n">block_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">block_inds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds-323"><a href="#MultiClouds-323"><span class="linenos"> 323</span></a>            <span class="c1"># might have to modify blockIDs -- not done yet</span>
</span><span id="MultiClouds-324"><a href="#MultiClouds-324"><span class="linenos"> 324</span></a>
</span><span id="MultiClouds-325"><a href="#MultiClouds-325"><span class="linenos"> 325</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="MultiClouds-326"><a href="#MultiClouds-326"><span class="linenos"> 326</span></a>            <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
</span><span id="MultiClouds-327"><a href="#MultiClouds-327"><span class="linenos"> 327</span></a>            <span class="s1">&#39;NT&#39;</span><span class="p">:</span> <span class="n">NT</span><span class="p">,</span>
</span><span id="MultiClouds-328"><a href="#MultiClouds-328"><span class="linenos"> 328</span></a>            <span class="s1">&#39;tmap&#39;</span><span class="p">:</span> <span class="n">tmap</span><span class="p">,</span> 
</span><span id="MultiClouds-329"><a href="#MultiClouds-329"><span class="linenos"> 329</span></a>            <span class="s1">&#39;trial_info&#39;</span><span class="p">:</span> <span class="n">block_inds</span><span class="p">,</span> 
</span><span id="MultiClouds-330"><a href="#MultiClouds-330"><span class="linenos"> 330</span></a>            <span class="s1">&#39;LRpresent&#39;</span><span class="p">:</span> <span class="n">LRpresent</span><span class="p">,</span>
</span><span id="MultiClouds-331"><a href="#MultiClouds-331"><span class="linenos"> 331</span></a>            <span class="s1">&#39;valid_inds&#39;</span><span class="p">:</span> <span class="n">valid_inds</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
</span><span id="MultiClouds-332"><a href="#MultiClouds-332"><span class="linenos"> 332</span></a>            <span class="s1">&#39;blockIDs&#39;</span><span class="p">:</span> <span class="n">blockIDs</span><span class="p">,</span> <span class="c1"># What is this again?  </span>
</span><span id="MultiClouds-333"><a href="#MultiClouds-333"><span class="linenos"> 333</span></a>            <span class="s1">&#39;NSUs&#39;</span><span class="p">:</span> <span class="n">NSUs</span><span class="p">,</span>
</span><span id="MultiClouds-334"><a href="#MultiClouds-334"><span class="linenos"> 334</span></a>            <span class="s1">&#39;NMUs&#39;</span><span class="p">:</span> <span class="n">NMUs</span><span class="p">,</span>
</span><span id="MultiClouds-335"><a href="#MultiClouds-335"><span class="linenos"> 335</span></a>            <span class="s1">&#39;channel_map&#39;</span><span class="p">:</span> <span class="n">channel_map</span><span class="p">,</span>
</span><span id="MultiClouds-336"><a href="#MultiClouds-336"><span class="linenos"> 336</span></a>            <span class="s1">&#39;channel_ratings&#39;</span><span class="p">:</span> <span class="n">channel_ratings</span><span class="p">,</span>
</span><span id="MultiClouds-337"><a href="#MultiClouds-337"><span class="linenos"> 337</span></a>            <span class="s1">&#39;fix_loc&#39;</span><span class="p">:</span> <span class="n">fix_loc</span><span class="p">,</span>
</span><span id="MultiClouds-338"><a href="#MultiClouds-338"><span class="linenos"> 338</span></a>            <span class="s1">&#39;fix_size&#39;</span><span class="p">:</span> <span class="n">fix_size</span><span class="p">,</span>
</span><span id="MultiClouds-339"><a href="#MultiClouds-339"><span class="linenos"> 339</span></a>            <span class="s1">&#39;stim_scale&#39;</span><span class="p">:</span> <span class="n">stim_scale</span><span class="p">,</span>
</span><span id="MultiClouds-340"><a href="#MultiClouds-340"><span class="linenos"> 340</span></a>            <span class="s1">&#39;stim_locsLP&#39;</span><span class="p">:</span> <span class="n">stim_locsLP</span><span class="p">,</span>
</span><span id="MultiClouds-341"><a href="#MultiClouds-341"><span class="linenos"> 341</span></a>            <span class="s1">&#39;stim_locsET&#39;</span><span class="p">:</span> <span class="n">stim_locsET</span><span class="p">}</span>
</span><span id="MultiClouds-342"><a href="#MultiClouds-342"><span class="linenos"> 342</span></a>    <span class="c1"># END MultiClouds.read_file_info()  </span>
</span><span id="MultiClouds-343"><a href="#MultiClouds-343"><span class="linenos"> 343</span></a>
</span><span id="MultiClouds-344"><a href="#MultiClouds-344"><span class="linenos"> 344</span></a>    <span class="k">def</span> <span class="nf">modify_included_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clists</span><span class="p">,</span> <span class="n">expt_n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="MultiClouds-345"><a href="#MultiClouds-345"><span class="linenos"> 345</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-346"><a href="#MultiClouds-346"><span class="linenos"> 346</span></a><span class="sd">        Modify the included cells in the dataset</span>
</span><span id="MultiClouds-347"><a href="#MultiClouds-347"><span class="linenos"> 347</span></a>
</span><span id="MultiClouds-348"><a href="#MultiClouds-348"><span class="linenos"> 348</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds-349"><a href="#MultiClouds-349"><span class="linenos"> 349</span></a><span class="sd">            clists (list): list of lists of cell indices to include in the dataset</span>
</span><span id="MultiClouds-350"><a href="#MultiClouds-350"><span class="linenos"> 350</span></a><span class="sd">            expt_n (int): index of the experiment to modify</span>
</span><span id="MultiClouds-351"><a href="#MultiClouds-351"><span class="linenos"> 351</span></a>
</span><span id="MultiClouds-352"><a href="#MultiClouds-352"><span class="linenos"> 352</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds-353"><a href="#MultiClouds-353"><span class="linenos"> 353</span></a><span class="sd">            None</span>
</span><span id="MultiClouds-354"><a href="#MultiClouds-354"><span class="linenos"> 354</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-355"><a href="#MultiClouds-355"><span class="linenos"> 355</span></a>
</span><span id="MultiClouds-356"><a href="#MultiClouds-356"><span class="linenos"> 356</span></a>        <span class="k">if</span> <span class="n">expt_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-357"><a href="#MultiClouds-357"><span class="linenos"> 357</span></a>            <span class="n">expts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">)</span>
</span><span id="MultiClouds-358"><a href="#MultiClouds-358"><span class="linenos"> 358</span></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">clists</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="s2">&quot;Number of cell_lists must match number of experiments.&quot;</span>
</span><span id="MultiClouds-359"><a href="#MultiClouds-359"><span class="linenos"> 359</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-360"><a href="#MultiClouds-360"><span class="linenos"> 360</span></a>            <span class="n">expts</span> <span class="o">=</span> <span class="p">[</span><span class="n">expt_n</span><span class="p">]</span>
</span><span id="MultiClouds-361"><a href="#MultiClouds-361"><span class="linenos"> 361</span></a>            
</span><span id="MultiClouds-362"><a href="#MultiClouds-362"><span class="linenos"> 362</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">expts</span><span class="p">:</span>
</span><span id="MultiClouds-363"><a href="#MultiClouds-363"><span class="linenos"> 363</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clists</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds-364"><a href="#MultiClouds-364"><span class="linenos"> 364</span></a>                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">clists</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span> <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NSUs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NMUs&#39;</span><span class="p">]),</span> <span class="s2">&quot;clists too large&quot;</span>
</span><span id="MultiClouds-365"><a href="#MultiClouds-365"><span class="linenos"> 365</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">clists</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="MultiClouds-366"><a href="#MultiClouds-366"><span class="linenos"> 366</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-367"><a href="#MultiClouds-367"><span class="linenos"> 367</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeMUs</span><span class="p">:</span>
</span><span id="MultiClouds-368"><a href="#MultiClouds-368"><span class="linenos"> 368</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NSUs&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NMUs&#39;</span><span class="p">])</span>
</span><span id="MultiClouds-369"><a href="#MultiClouds-369"><span class="linenos"> 369</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-370"><a href="#MultiClouds-370"><span class="linenos"> 370</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NSUs&#39;</span><span class="p">])</span>
</span><span id="MultiClouds-371"><a href="#MultiClouds-371"><span class="linenos"> 371</span></a>
</span><span id="MultiClouds-372"><a href="#MultiClouds-372"><span class="linenos"> 372</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="MultiClouds-373"><a href="#MultiClouds-373"><span class="linenos"> 373</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">)</span>
</span><span id="MultiClouds-374"><a href="#MultiClouds-374"><span class="linenos"> 374</span></a>
</span><span id="MultiClouds-375"><a href="#MultiClouds-375"><span class="linenos"> 375</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assemble_robs</span><span class="p">()</span>
</span><span id="MultiClouds-376"><a href="#MultiClouds-376"><span class="linenos"> 376</span></a>    <span class="c1"># END MultiClouds.modify_included_cells()</span>
</span><span id="MultiClouds-377"><a href="#MultiClouds-377"><span class="linenos"> 377</span></a>
</span><span id="MultiClouds-378"><a href="#MultiClouds-378"><span class="linenos"> 378</span></a>    <span class="k">def</span> <span class="nf">generate_array_cell_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expt_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">which_array</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="MultiClouds-379"><a href="#MultiClouds-379"><span class="linenos"> 379</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-380"><a href="#MultiClouds-380"><span class="linenos"> 380</span></a><span class="sd">        Formula for generating cell list given channel maps and basic eligibility</span>
</span><span id="MultiClouds-381"><a href="#MultiClouds-381"><span class="linenos"> 381</span></a><span class="sd">        </span>
</span><span id="MultiClouds-382"><a href="#MultiClouds-382"><span class="linenos"> 382</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds-383"><a href="#MultiClouds-383"><span class="linenos"> 383</span></a><span class="sd">            expt_n (int): index of the experiment</span>
</span><span id="MultiClouds-384"><a href="#MultiClouds-384"><span class="linenos"> 384</span></a><span class="sd">            which_array (int or str): which array to generate the cell list for</span>
</span><span id="MultiClouds-385"><a href="#MultiClouds-385"><span class="linenos"> 385</span></a>
</span><span id="MultiClouds-386"><a href="#MultiClouds-386"><span class="linenos"> 386</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds-387"><a href="#MultiClouds-387"><span class="linenos"> 387</span></a><span class="sd">            np.array: array of cell indices</span>
</span><span id="MultiClouds-388"><a href="#MultiClouds-388"><span class="linenos"> 388</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-389"><a href="#MultiClouds-389"><span class="linenos"> 389</span></a>        <span class="c1">#expt_val = np.where( np.sum( self.robs[:, np.arange(cstart, cstart+self.fileNC[expt_n])], axis=0 ) &gt; 10)[0]</span>
</span><span id="MultiClouds-390"><a href="#MultiClouds-390"><span class="linenos"> 390</span></a>
</span><span id="MultiClouds-391"><a href="#MultiClouds-391"><span class="linenos"> 391</span></a>        <span class="c1"># Should only do this if have not already reduced channel list</span>
</span><span id="MultiClouds-392"><a href="#MultiClouds-392"><span class="linenos"> 392</span></a>        <span class="n">NC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;NSUs&#39;</span><span class="p">]</span>
</span><span id="MultiClouds-393"><a href="#MultiClouds-393"><span class="linenos"> 393</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeMUs</span><span class="p">:</span>
</span><span id="MultiClouds-394"><a href="#MultiClouds-394"><span class="linenos"> 394</span></a>            <span class="n">NC</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;NMUs&#39;</span><span class="p">]</span>
</span><span id="MultiClouds-395"><a href="#MultiClouds-395"><span class="linenos"> 395</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">])</span> <span class="o">==</span> <span class="n">NC</span><span class="p">,</span> <span class="s2">&quot;Can only generate cell_array if using currently using full cell_list&quot;</span>
</span><span id="MultiClouds-396"><a href="#MultiClouds-396"><span class="linenos"> 396</span></a>
</span><span id="MultiClouds-397"><a href="#MultiClouds-397"><span class="linenos"> 397</span></a>        <span class="k">if</span> <span class="n">which_array</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;utah&#39;</span><span class="p">]:</span>
</span><span id="MultiClouds-398"><a href="#MultiClouds-398"><span class="linenos"> 398</span></a>            <span class="n">array_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;channel_map&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="o">+</span><span class="mi">128</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-399"><a href="#MultiClouds-399"><span class="linenos"> 399</span></a>        <span class="k">elif</span> <span class="n">which_array</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;lam&#39;</span><span class="p">,</span> <span class="s1">&#39;laminar&#39;</span><span class="p">]:</span>
</span><span id="MultiClouds-400"><a href="#MultiClouds-400"><span class="linenos"> 400</span></a>            <span class="n">array_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;channel_map&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-401"><a href="#MultiClouds-401"><span class="linenos"> 401</span></a>        <span class="k">else</span><span class="p">:</span> <span class="c1"># assume Nform</span>
</span><span id="MultiClouds-402"><a href="#MultiClouds-402"><span class="linenos"> 402</span></a>            <span class="n">array_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;channel_map&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;channel_map&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="o">+</span><span class="mi">128</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-403"><a href="#MultiClouds-403"><span class="linenos"> 403</span></a>
</span><span id="MultiClouds-404"><a href="#MultiClouds-404"><span class="linenos"> 404</span></a>        <span class="n">cstart</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds-405"><a href="#MultiClouds-405"><span class="linenos"> 405</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">expt_n</span><span class="p">):</span>
</span><span id="MultiClouds-406"><a href="#MultiClouds-406"><span class="linenos"> 406</span></a>            <span class="n">cstart</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span>
</span><span id="MultiClouds-407"><a href="#MultiClouds-407"><span class="linenos"> 407</span></a>        <span class="n">nspks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">cstart</span><span class="o">+</span><span class="n">array_cells</span><span class="p">]</span>
</span><span id="MultiClouds-408"><a href="#MultiClouds-408"><span class="linenos"> 408</span></a>
</span><span id="MultiClouds-409"><a href="#MultiClouds-409"><span class="linenos"> 409</span></a>        <span class="n">val_array</span> <span class="o">=</span> <span class="n">array_cells</span><span class="p">[</span><span class="n">nspks</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">]</span>
</span><span id="MultiClouds-410"><a href="#MultiClouds-410"><span class="linenos"> 410</span></a>        <span class="k">return</span> <span class="n">val_array</span>
</span><span id="MultiClouds-411"><a href="#MultiClouds-411"><span class="linenos"> 411</span></a>    <span class="c1"># END MultiClouds.generate_array_cell_list()</span>
</span><span id="MultiClouds-412"><a href="#MultiClouds-412"><span class="linenos"> 412</span></a>
</span><span id="MultiClouds-413"><a href="#MultiClouds-413"><span class="linenos"> 413</span></a>    <span class="k">def</span> <span class="nf">assemble_robs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MultiClouds-414"><a href="#MultiClouds-414"><span class="linenos"> 414</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-415"><a href="#MultiClouds-415"><span class="linenos"> 415</span></a><span class="sd">        Takes current information (robs and dfs) to make robs and dfs (full version)</span>
</span><span id="MultiClouds-416"><a href="#MultiClouds-416"><span class="linenos"> 416</span></a><span class="sd">        Note this can be replaced by using the spike times explicitly</span>
</span><span id="MultiClouds-417"><a href="#MultiClouds-417"><span class="linenos"> 417</span></a><span class="sd">        </span>
</span><span id="MultiClouds-418"><a href="#MultiClouds-418"><span class="linenos"> 418</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds-419"><a href="#MultiClouds-419"><span class="linenos"> 419</span></a><span class="sd">            None</span>
</span><span id="MultiClouds-420"><a href="#MultiClouds-420"><span class="linenos"> 420</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-421"><a href="#MultiClouds-421"><span class="linenos"> 421</span></a>
</span><span id="MultiClouds-422"><a href="#MultiClouds-422"><span class="linenos"> 422</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span> <span class="p">)</span>
</span><span id="MultiClouds-423"><a href="#MultiClouds-423"><span class="linenos"> 423</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span> <span class="p">)</span>
</span><span id="MultiClouds-424"><a href="#MultiClouds-424"><span class="linenos"> 424</span></a>
</span><span id="MultiClouds-425"><a href="#MultiClouds-425"><span class="linenos"> 425</span></a>        <span class="n">tcount</span><span class="p">,</span> <span class="n">ccount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="MultiClouds-426"><a href="#MultiClouds-426"><span class="linenos"> 426</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">):</span>
</span><span id="MultiClouds-427"><a href="#MultiClouds-427"><span class="linenos"> 427</span></a>            <span class="n">NTexpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NT&#39;</span><span class="p">]</span>
</span><span id="MultiClouds-428"><a href="#MultiClouds-428"><span class="linenos"> 428</span></a>            <span class="n">NSUs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NSUs&#39;</span><span class="p">]</span>
</span><span id="MultiClouds-429"><a href="#MultiClouds-429"><span class="linenos"> 429</span></a>
</span><span id="MultiClouds-430"><a href="#MultiClouds-430"><span class="linenos"> 430</span></a>            <span class="n">valid_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NTexpt</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="MultiClouds-431"><a href="#MultiClouds-431"><span class="linenos"> 431</span></a>            <span class="n">valid_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;valid_inds&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MultiClouds-432"><a href="#MultiClouds-432"><span class="linenos"> 432</span></a>
</span><span id="MultiClouds-433"><a href="#MultiClouds-433"><span class="linenos"> 433</span></a>            <span class="c1"># Classify cell-lists in terms of SUs and MUc</span>
</span><span id="MultiClouds-434"><a href="#MultiClouds-434"><span class="linenos"> 434</span></a>            <span class="n">su_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">NSUs</span><span class="p">]</span>
</span><span id="MultiClouds-435"><a href="#MultiClouds-435"><span class="linenos"> 435</span></a>            <span class="n">R_tslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NTexpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span> <span class="p">)</span>
</span><span id="MultiClouds-436"><a href="#MultiClouds-436"><span class="linenos"> 436</span></a>            <span class="n">df_tslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NTexpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span> <span class="p">)</span>
</span><span id="MultiClouds-437"><a href="#MultiClouds-437"><span class="linenos"> 437</span></a>
</span><span id="MultiClouds-438"><a href="#MultiClouds-438"><span class="linenos"> 438</span></a>            <span class="n">tslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;Robs&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="MultiClouds-439"><a href="#MultiClouds-439"><span class="linenos"> 439</span></a>            <span class="n">R_tslice</span><span class="p">[:,</span> <span class="n">ccount</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">su_list</span><span class="p">))]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tslice</span><span class="p">[:,</span> <span class="n">su_list</span><span class="p">])</span>
</span><span id="MultiClouds-440"><a href="#MultiClouds-440"><span class="linenos"> 440</span></a>            <span class="n">tslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;datafilts&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="MultiClouds-441"><a href="#MultiClouds-441"><span class="linenos"> 441</span></a>            <span class="c1"># Also take valid_data into account</span>
</span><span id="MultiClouds-442"><a href="#MultiClouds-442"><span class="linenos"> 442</span></a>            <span class="n">df_tslice</span><span class="p">[:,</span> <span class="n">ccount</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">su_list</span><span class="p">))]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tslice</span><span class="p">[:,</span> <span class="n">su_list</span><span class="p">])</span> <span class="o">*</span> <span class="n">valid_data</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="MultiClouds-443"><a href="#MultiClouds-443"><span class="linenos"> 443</span></a>            <span class="n">ccount</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">su_list</span><span class="p">)</span>
</span><span id="MultiClouds-444"><a href="#MultiClouds-444"><span class="linenos"> 444</span></a>
</span><span id="MultiClouds-445"><a href="#MultiClouds-445"><span class="linenos"> 445</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="MultiClouds-446"><a href="#MultiClouds-446"><span class="linenos"> 446</span></a>                <span class="n">NMUs</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NMUs&#39;</span><span class="p">]</span>
</span><span id="MultiClouds-447"><a href="#MultiClouds-447"><span class="linenos"> 447</span></a>                <span class="n">mu_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">NSUs</span><span class="p">]</span><span class="o">-</span><span class="n">NSUs</span>
</span><span id="MultiClouds-448"><a href="#MultiClouds-448"><span class="linenos"> 448</span></a>                <span class="n">tslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="MultiClouds-449"><a href="#MultiClouds-449"><span class="linenos"> 449</span></a>                <span class="n">R_tslice</span><span class="p">[:,</span> <span class="n">ccount</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mu_list</span><span class="p">))]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tslice</span><span class="p">[:,</span> <span class="n">mu_list</span><span class="p">])</span>
</span><span id="MultiClouds-450"><a href="#MultiClouds-450"><span class="linenos"> 450</span></a>                <span class="n">tslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;datafiltsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="MultiClouds-451"><a href="#MultiClouds-451"><span class="linenos"> 451</span></a>                <span class="n">df_tslice</span><span class="p">[:,</span> <span class="n">ccount</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mu_list</span><span class="p">))]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tslice</span><span class="p">[:,</span> <span class="n">mu_list</span><span class="p">])</span> <span class="o">*</span> <span class="n">valid_data</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="MultiClouds-452"><a href="#MultiClouds-452"><span class="linenos"> 452</span></a>                <span class="n">ccount</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu_list</span><span class="p">)</span>
</span><span id="MultiClouds-453"><a href="#MultiClouds-453"><span class="linenos"> 453</span></a>
</span><span id="MultiClouds-454"><a href="#MultiClouds-454"><span class="linenos"> 454</span></a>            <span class="c1"># Check that clipping to uint8 wont screw up any robs</span>
</span><span id="MultiClouds-455"><a href="#MultiClouds-455"><span class="linenos"> 455</span></a>            <span class="n">robs_ceil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">R_tslice</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
</span><span id="MultiClouds-456"><a href="#MultiClouds-456"><span class="linenos"> 456</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">robs_ceil</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds-457"><a href="#MultiClouds-457"><span class="linenos"> 457</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Neurons in expt </span><span class="si">%d</span><span class="s2"> have single-bin spike counts above 255:&quot;</span><span class="o">%</span><span class="n">ff</span><span class="p">,</span> <span class="n">robs_ceil</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="MultiClouds-458"><a href="#MultiClouds-458"><span class="linenos"> 458</span></a>                <span class="c1"># Currently do nothing -- this willbe modded: but if problems should probably make dfs = 0 there</span>
</span><span id="MultiClouds-459"><a href="#MultiClouds-459"><span class="linenos"> 459</span></a>
</span><span id="MultiClouds-460"><a href="#MultiClouds-460"><span class="linenos"> 460</span></a>            <span class="c1"># Write tslice into </span>
</span><span id="MultiClouds-461"><a href="#MultiClouds-461"><span class="linenos"> 461</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">tcount</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NTexpt</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span> <span class="n">R_tslice</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="p">)</span>
</span><span id="MultiClouds-462"><a href="#MultiClouds-462"><span class="linenos"> 462</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">tcount</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NTexpt</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span> <span class="n">df_tslice</span> <span class="p">)</span>
</span><span id="MultiClouds-463"><a href="#MultiClouds-463"><span class="linenos"> 463</span></a>
</span><span id="MultiClouds-464"><a href="#MultiClouds-464"><span class="linenos"> 464</span></a>            <span class="n">tcount</span> <span class="o">+=</span> <span class="n">NTexpt</span>
</span><span id="MultiClouds-465"><a href="#MultiClouds-465"><span class="linenos"> 465</span></a>
</span><span id="MultiClouds-466"><a href="#MultiClouds-466"><span class="linenos"> 466</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trialfilter_dfs</span><span class="p">()</span>
</span><span id="MultiClouds-467"><a href="#MultiClouds-467"><span class="linenos"> 467</span></a>    <span class="c1"># END MultiClouds.assemble_robs()</span>
</span><span id="MultiClouds-468"><a href="#MultiClouds-468"><span class="linenos"> 468</span></a>
</span><span id="MultiClouds-469"><a href="#MultiClouds-469"><span class="linenos"> 469</span></a>    <span class="k">def</span> <span class="nf">list_expts</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="MultiClouds-470"><a href="#MultiClouds-470"><span class="linenos"> 470</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-471"><a href="#MultiClouds-471"><span class="linenos"> 471</span></a><span class="sd">        Show filenames with experiment number</span>
</span><span id="MultiClouds-472"><a href="#MultiClouds-472"><span class="linenos"> 472</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-473"><a href="#MultiClouds-473"><span class="linenos"> 473</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">):</span>
</span><span id="MultiClouds-474"><a href="#MultiClouds-474"><span class="linenos"> 474</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%2d</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span> <span class="p">)</span>
</span><span id="MultiClouds-475"><a href="#MultiClouds-475"><span class="linenos"> 475</span></a>        
</span><span id="MultiClouds-476"><a href="#MultiClouds-476"><span class="linenos"> 476</span></a>    <span class="k">def</span> <span class="nf">updateDF</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">expt_n</span><span class="p">,</span> <span class="n">dfs</span><span class="p">,</span> <span class="n">reduce_cells</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="MultiClouds-477"><a href="#MultiClouds-477"><span class="linenos"> 477</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-478"><a href="#MultiClouds-478"><span class="linenos"> 478</span></a><span class="sd">        Import updated DF for given experiment, as numbered (can see with &#39;list_expts&#39;)</span>
</span><span id="MultiClouds-479"><a href="#MultiClouds-479"><span class="linenos"> 479</span></a><span class="sd">        Will check for neurons with no robs and reduce robs and dataset if reduce_cells=True</span>
</span><span id="MultiClouds-480"><a href="#MultiClouds-480"><span class="linenos"> 480</span></a><span class="sd">        </span>
</span><span id="MultiClouds-481"><a href="#MultiClouds-481"><span class="linenos"> 481</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds-482"><a href="#MultiClouds-482"><span class="linenos"> 482</span></a><span class="sd">            expt_n (int): index of the experiment</span>
</span><span id="MultiClouds-483"><a href="#MultiClouds-483"><span class="linenos"> 483</span></a><span class="sd">            dfs (np.array): array of new dfs</span>
</span><span id="MultiClouds-484"><a href="#MultiClouds-484"><span class="linenos"> 484</span></a><span class="sd">            reduce_cells (bool): whether to reduce the number of cells</span>
</span><span id="MultiClouds-485"><a href="#MultiClouds-485"><span class="linenos"> 485</span></a>
</span><span id="MultiClouds-486"><a href="#MultiClouds-486"><span class="linenos"> 486</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds-487"><a href="#MultiClouds-487"><span class="linenos"> 487</span></a><span class="sd">            None</span>
</span><span id="MultiClouds-488"><a href="#MultiClouds-488"><span class="linenos"> 488</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-489"><a href="#MultiClouds-489"><span class="linenos"> 489</span></a>
</span><span id="MultiClouds-490"><a href="#MultiClouds-490"><span class="linenos"> 490</span></a>        <span class="k">assert</span> <span class="n">expt_n</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="s2">&quot;updateDF: expt_n too large: not that many experiments&quot;</span>
</span><span id="MultiClouds-491"><a href="#MultiClouds-491"><span class="linenos"> 491</span></a>
</span><span id="MultiClouds-492"><a href="#MultiClouds-492"><span class="linenos"> 492</span></a>        <span class="c1"># if eye_config, then want to replace whole DFs, or relevant DFs </span>
</span><span id="MultiClouds-493"><a href="#MultiClouds-493"><span class="linenos"> 493</span></a>        <span class="k">if</span> <span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;NT&#39;</span><span class="p">]:</span>
</span><span id="MultiClouds-494"><a href="#MultiClouds-494"><span class="linenos"> 494</span></a>            <span class="c1"># Assume need to use trange</span>
</span><span id="MultiClouds-495"><a href="#MultiClouds-495"><span class="linenos"> 495</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="MultiClouds-496"><a href="#MultiClouds-496"><span class="linenos"> 496</span></a>        <span class="k">assert</span> <span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;NT&#39;</span><span class="p">],</span> <span class="s2">&quot;DF file mismatch: wrong length&quot;</span>
</span><span id="MultiClouds-497"><a href="#MultiClouds-497"><span class="linenos"> 497</span></a>        <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">]]</span>
</span><span id="MultiClouds-498"><a href="#MultiClouds-498"><span class="linenos"> 498</span></a>
</span><span id="MultiClouds-499"><a href="#MultiClouds-499"><span class="linenos"> 499</span></a>        <span class="c1"># Replace dfs with updated</span>
</span><span id="MultiClouds-500"><a href="#MultiClouds-500"><span class="linenos"> 500</span></a>        <span class="n">trange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_tstart</span><span class="p">[</span><span class="n">expt_n</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MultiClouds-501"><a href="#MultiClouds-501"><span class="linenos"> 501</span></a>        <span class="n">df_tslice</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">trange</span><span class="p">,</span> <span class="p">:]</span> <span class="p">)</span>
</span><span id="MultiClouds-502"><a href="#MultiClouds-502"><span class="linenos"> 502</span></a>        <span class="n">crange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">[</span><span class="n">expt_n</span><span class="p">])</span>
</span><span id="MultiClouds-503"><a href="#MultiClouds-503"><span class="linenos"> 503</span></a>        <span class="k">if</span> <span class="n">expt_n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds-504"><a href="#MultiClouds-504"><span class="linenos"> 504</span></a>            <span class="n">crange</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">[:</span><span class="n">expt_n</span><span class="p">])</span>
</span><span id="MultiClouds-505"><a href="#MultiClouds-505"><span class="linenos"> 505</span></a>        <span class="n">df_tslice</span><span class="p">[:,</span> <span class="n">crange</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="MultiClouds-506"><a href="#MultiClouds-506"><span class="linenos"> 506</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">trange</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">df_tslice</span><span class="p">)</span>
</span><span id="MultiClouds-507"><a href="#MultiClouds-507"><span class="linenos"> 507</span></a>
</span><span id="MultiClouds-508"><a href="#MultiClouds-508"><span class="linenos"> 508</span></a>        <span class="k">if</span> <span class="n">reduce_cells</span><span class="p">:</span>
</span><span id="MultiClouds-509"><a href="#MultiClouds-509"><span class="linenos"> 509</span></a>            <span class="n">elim_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-510"><a href="#MultiClouds-510"><span class="linenos"> 510</span></a>            <span class="k">if</span> <span class="n">elim_cells</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds-511"><a href="#MultiClouds-511"><span class="linenos"> 511</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  reduce_cells not implemented yet&#39;</span><span class="p">)</span>
</span><span id="MultiClouds-512"><a href="#MultiClouds-512"><span class="linenos"> 512</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39; Cells to reduce:&#39;</span><span class="p">,</span> <span class="n">elim_cells</span> <span class="p">)</span>
</span><span id="MultiClouds-513"><a href="#MultiClouds-513"><span class="linenos"> 513</span></a>        
</span><span id="MultiClouds-514"><a href="#MultiClouds-514"><span class="linenos"> 514</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trialfilter_dfs</span><span class="p">()</span>
</span><span id="MultiClouds-515"><a href="#MultiClouds-515"><span class="linenos"> 515</span></a>    <span class="c1"># END MultiClouds.updateDF()</span>
</span><span id="MultiClouds-516"><a href="#MultiClouds-516"><span class="linenos"> 516</span></a>
</span><span id="MultiClouds-517"><a href="#MultiClouds-517"><span class="linenos"> 517</span></a>    <span class="k">def</span> <span class="nf">trialfilter_dfs</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="MultiClouds-518"><a href="#MultiClouds-518"><span class="linenos"> 518</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-519"><a href="#MultiClouds-519"><span class="linenos"> 519</span></a><span class="sd">        Zeros out dfs at the beginning of trials up to num_lags</span>
</span><span id="MultiClouds-520"><a href="#MultiClouds-520"><span class="linenos"> 520</span></a><span class="sd">        </span>
</span><span id="MultiClouds-521"><a href="#MultiClouds-521"><span class="linenos"> 521</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds-522"><a href="#MultiClouds-522"><span class="linenos"> 522</span></a><span class="sd">            None</span>
</span><span id="MultiClouds-523"><a href="#MultiClouds-523"><span class="linenos"> 523</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-524"><a href="#MultiClouds-524"><span class="linenos"> 524</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds-525"><a href="#MultiClouds-525"><span class="linenos"> 525</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)):</span>
</span><span id="MultiClouds-526"><a href="#MultiClouds-526"><span class="linenos"> 526</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds-527"><a href="#MultiClouds-527"><span class="linenos"> 527</span></a>
</span><span id="MultiClouds-528"><a href="#MultiClouds-528"><span class="linenos"> 528</span></a>    <span class="k">def</span> <span class="nf">assemble_saccade_inds</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="MultiClouds-529"><a href="#MultiClouds-529"><span class="linenos"> 529</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-530"><a href="#MultiClouds-530"><span class="linenos"> 530</span></a><span class="sd">        Assemble saccade indices for all experiments</span>
</span><span id="MultiClouds-531"><a href="#MultiClouds-531"><span class="linenos"> 531</span></a>
</span><span id="MultiClouds-532"><a href="#MultiClouds-532"><span class="linenos"> 532</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds-533"><a href="#MultiClouds-533"><span class="linenos"> 533</span></a><span class="sd">            None</span>
</span><span id="MultiClouds-534"><a href="#MultiClouds-534"><span class="linenos"> 534</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-535"><a href="#MultiClouds-535"><span class="linenos"> 535</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Currently not implemented -- needs to have microsaccades labeled well with time first&#39;</span><span class="p">)</span>
</span><span id="MultiClouds-536"><a href="#MultiClouds-536"><span class="linenos"> 536</span></a>
</span><span id="MultiClouds-537"><a href="#MultiClouds-537"><span class="linenos"> 537</span></a>    <span class="k">def</span> <span class="nf">is_fixpoint_present</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">boxlim</span><span class="p">,</span> <span class="n">expt_n</span> <span class="p">):</span>
</span><span id="MultiClouds-538"><a href="#MultiClouds-538"><span class="linenos"> 538</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-539"><a href="#MultiClouds-539"><span class="linenos"> 539</span></a><span class="sd">        Return if any of fixation point is within the box given by top-left to bottom-right corner</span>
</span><span id="MultiClouds-540"><a href="#MultiClouds-540"><span class="linenos"> 540</span></a><span class="sd">        </span>
</span><span id="MultiClouds-541"><a href="#MultiClouds-541"><span class="linenos"> 541</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds-542"><a href="#MultiClouds-542"><span class="linenos"> 542</span></a><span class="sd">            boxlim (list): list of four numbers (top-left, bot-right)</span>
</span><span id="MultiClouds-543"><a href="#MultiClouds-543"><span class="linenos"> 543</span></a><span class="sd">            expt_n (int): index of the experiment</span>
</span><span id="MultiClouds-544"><a href="#MultiClouds-544"><span class="linenos"> 544</span></a>
</span><span id="MultiClouds-545"><a href="#MultiClouds-545"><span class="linenos"> 545</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds-546"><a href="#MultiClouds-546"><span class="linenos"> 546</span></a><span class="sd">            bool: whether the fixation point is present</span>
</span><span id="MultiClouds-547"><a href="#MultiClouds-547"><span class="linenos"> 547</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-548"><a href="#MultiClouds-548"><span class="linenos"> 548</span></a>        <span class="n">fix_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;fix_loc&#39;</span><span class="p">]</span>
</span><span id="MultiClouds-549"><a href="#MultiClouds-549"><span class="linenos"> 549</span></a>        <span class="k">if</span> <span class="n">fix_loc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-550"><a href="#MultiClouds-550"><span class="linenos"> 550</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="MultiClouds-551"><a href="#MultiClouds-551"><span class="linenos"> 551</span></a>        <span class="n">fix_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;fix_size&#39;</span><span class="p">]</span>
</span><span id="MultiClouds-552"><a href="#MultiClouds-552"><span class="linenos"> 552</span></a>        <span class="n">fix_present</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="MultiClouds-553"><a href="#MultiClouds-553"><span class="linenos"> 553</span></a>        <span class="c1">#if self.file_info[expt_n][&#39;stim_loc&#39;].shape[1] == 1:</span>
</span><span id="MultiClouds-554"><a href="#MultiClouds-554"><span class="linenos"> 554</span></a>        <span class="c1"># if there is multiple windows, needs to be manual: so this is the automatic check:</span>
</span><span id="MultiClouds-555"><a href="#MultiClouds-555"><span class="linenos"> 555</span></a>        <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="MultiClouds-556"><a href="#MultiClouds-556"><span class="linenos"> 556</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">fix_loc</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">-</span><span class="n">boxlim</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">fix_size</span><span class="p">):</span>
</span><span id="MultiClouds-557"><a href="#MultiClouds-557"><span class="linenos"> 557</span></a>                <span class="n">fix_present</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="MultiClouds-558"><a href="#MultiClouds-558"><span class="linenos"> 558</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">fix_loc</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">-</span><span class="n">boxlim</span><span class="p">[</span><span class="n">dd</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">fix_size</span><span class="p">):</span>
</span><span id="MultiClouds-559"><a href="#MultiClouds-559"><span class="linenos"> 559</span></a>                <span class="n">fix_present</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="MultiClouds-560"><a href="#MultiClouds-560"><span class="linenos"> 560</span></a>        <span class="k">return</span> <span class="n">fix_present</span>
</span><span id="MultiClouds-561"><a href="#MultiClouds-561"><span class="linenos"> 561</span></a>    <span class="c1"># END .is_fixpoint_present</span>
</span><span id="MultiClouds-562"><a href="#MultiClouds-562"><span class="linenos"> 562</span></a>
</span><span id="MultiClouds-563"><a href="#MultiClouds-563"><span class="linenos"> 563</span></a>    <span class="k">def</span> <span class="nf">build_stim</span><span class="p">(</span>
</span><span id="MultiClouds-564"><a href="#MultiClouds-564"><span class="linenos"> 564</span></a>            <span class="bp">self</span><span class="p">,</span> <span class="n">expt_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MultiClouds-565"><a href="#MultiClouds-565"><span class="linenos"> 565</span></a>            <span class="n">which_stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">top_corner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># position of stim</span>
</span><span id="MultiClouds-566"><a href="#MultiClouds-566"><span class="linenos"> 566</span></a>            <span class="n">time_embed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
</span><span id="MultiClouds-567"><a href="#MultiClouds-567"><span class="linenos"> 567</span></a>            <span class="n">eyepos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">BUF</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="c1"># eye position (not shifts)</span>
</span><span id="MultiClouds-568"><a href="#MultiClouds-568"><span class="linenos"> 568</span></a>            <span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MultiClouds-569"><a href="#MultiClouds-569"><span class="linenos"> 569</span></a>            <span class="n">LMS</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="MultiClouds-570"><a href="#MultiClouds-570"><span class="linenos"> 570</span></a>            <span class="n">fixdot</span><span class="o">=</span><span class="mi">0</span> <span class="p">):</span>
</span><span id="MultiClouds-571"><a href="#MultiClouds-571"><span class="linenos"> 571</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-572"><a href="#MultiClouds-572"><span class="linenos"> 572</span></a><span class="sd">        This assembles a stimulus from the raw numpy-stored stimuli into self.stim</span>
</span><span id="MultiClouds-573"><a href="#MultiClouds-573"><span class="linenos"> 573</span></a><span class="sd">        which_stim: determines what stimulus is assembled from &#39;ET&#39;=0, &#39;lam&#39;=1, None</span>
</span><span id="MultiClouds-574"><a href="#MultiClouds-574"><span class="linenos"> 574</span></a><span class="sd">            If none, will need top_corner present: can specify with four numbers (top-left, bot-right)</span>
</span><span id="MultiClouds-575"><a href="#MultiClouds-575"><span class="linenos"> 575</span></a><span class="sd">            or just top_corner and L</span>
</span><span id="MultiClouds-576"><a href="#MultiClouds-576"><span class="linenos"> 576</span></a><span class="sd">        which is torch.tensor on default device</span>
</span><span id="MultiClouds-577"><a href="#MultiClouds-577"><span class="linenos"> 577</span></a><span class="sd">        stim_wrap: only works if using &#39;which_stim&#39;, and will be [hwrap, vwrap]</span>
</span><span id="MultiClouds-578"><a href="#MultiClouds-578"><span class="linenos"> 578</span></a><span class="sd">        </span>
</span><span id="MultiClouds-579"><a href="#MultiClouds-579"><span class="linenos"> 579</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds-580"><a href="#MultiClouds-580"><span class="linenos"> 580</span></a><span class="sd">            expt_n (int): index of the experiment</span>
</span><span id="MultiClouds-581"><a href="#MultiClouds-581"><span class="linenos"> 581</span></a><span class="sd">            which_stim (int or str): which stimulus to use</span>
</span><span id="MultiClouds-582"><a href="#MultiClouds-582"><span class="linenos"> 582</span></a><span class="sd">            top_corner (list): top corner of the stimulus</span>
</span><span id="MultiClouds-583"><a href="#MultiClouds-583"><span class="linenos"> 583</span></a><span class="sd">            L (int): size of the stimulus</span>
</span><span id="MultiClouds-584"><a href="#MultiClouds-584"><span class="linenos"> 584</span></a><span class="sd">            time_embed (int): time embedding</span>
</span><span id="MultiClouds-585"><a href="#MultiClouds-585"><span class="linenos"> 585</span></a><span class="sd">            eyepos (np.array): eye position</span>
</span><span id="MultiClouds-586"><a href="#MultiClouds-586"><span class="linenos"> 586</span></a><span class="sd">            BUF (int): buffer for eye position</span>
</span><span id="MultiClouds-587"><a href="#MultiClouds-587"><span class="linenos"> 587</span></a><span class="sd">            stim_crop (list): crop the stimulus</span>
</span><span id="MultiClouds-588"><a href="#MultiClouds-588"><span class="linenos"> 588</span></a><span class="sd">            LMS (bool): whether to use LMS</span>
</span><span id="MultiClouds-589"><a href="#MultiClouds-589"><span class="linenos"> 589</span></a><span class="sd">            fixdot (int): fixation point</span>
</span><span id="MultiClouds-590"><a href="#MultiClouds-590"><span class="linenos"> 590</span></a>
</span><span id="MultiClouds-591"><a href="#MultiClouds-591"><span class="linenos"> 591</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds-592"><a href="#MultiClouds-592"><span class="linenos"> 592</span></a><span class="sd">            None</span>
</span><span id="MultiClouds-593"><a href="#MultiClouds-593"><span class="linenos"> 593</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-594"><a href="#MultiClouds-594"><span class="linenos"> 594</span></a>
</span><span id="MultiClouds-595"><a href="#MultiClouds-595"><span class="linenos"> 595</span></a>        <span class="c1">#eyepos = shifts   # shifts that is passed in is actually the eye position</span>
</span><span id="MultiClouds-596"><a href="#MultiClouds-596"><span class="linenos"> 596</span></a>
</span><span id="MultiClouds-597"><a href="#MultiClouds-597"><span class="linenos"> 597</span></a>        <span class="k">assert</span> <span class="n">expt_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;CONSTRUCT_STIMULUS: must specify expt_n&quot;</span>
</span><span id="MultiClouds-598"><a href="#MultiClouds-598"><span class="linenos"> 598</span></a>        <span class="c1"># Delete existing stim and clear cache to prevent memory issues on GPU</span>
</span><span id="MultiClouds-599"><a href="#MultiClouds-599"><span class="linenos"> 599</span></a>
</span><span id="MultiClouds-600"><a href="#MultiClouds-600"><span class="linenos"> 600</span></a>        <span class="n">need2crop</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="MultiClouds-601"><a href="#MultiClouds-601"><span class="linenos"> 601</span></a>        <span class="k">if</span> <span class="n">LMS</span><span class="p">:</span>
</span><span id="MultiClouds-602"><a href="#MultiClouds-602"><span class="linenos"> 602</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">,</span> <span class="s2">&quot;Cannot convert color spaces if luminance-only.&quot;</span>
</span><span id="MultiClouds-603"><a href="#MultiClouds-603"><span class="linenos"> 603</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">LMS</span> <span class="o">=</span> <span class="n">LMS</span>
</span><span id="MultiClouds-604"><a href="#MultiClouds-604"><span class="linenos"> 604</span></a>
</span><span id="MultiClouds-605"><a href="#MultiClouds-605"><span class="linenos"> 605</span></a>        <span class="k">if</span> <span class="n">which_stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-606"><a href="#MultiClouds-606"><span class="linenos"> 606</span></a>            <span class="k">assert</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;CONSTRUCT_STIMULUS: cannot specify L if using which_stim (i.e. prepackaged stim)&quot;</span>
</span><span id="MultiClouds-607"><a href="#MultiClouds-607"><span class="linenos"> 607</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_stim</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="MultiClouds-608"><a href="#MultiClouds-608"><span class="linenos"> 608</span></a>                <span class="k">if</span> <span class="n">which_stim</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ET&#39;</span><span class="p">,</span> <span class="s1">&#39;et&#39;</span><span class="p">,</span> <span class="s1">&#39;stimET&#39;</span><span class="p">]:</span>
</span><span id="MultiClouds-609"><a href="#MultiClouds-609"><span class="linenos"> 609</span></a>                    <span class="n">which_stim</span><span class="o">=</span><span class="mi">0</span>
</span><span id="MultiClouds-610"><a href="#MultiClouds-610"><span class="linenos"> 610</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-611"><a href="#MultiClouds-611"><span class="linenos"> 611</span></a>                    <span class="n">which_stim</span><span class="o">=</span><span class="mi">1</span>
</span><span id="MultiClouds-612"><a href="#MultiClouds-612"><span class="linenos"> 612</span></a>            <span class="k">if</span> <span class="n">which_stim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds-613"><a href="#MultiClouds-613"><span class="linenos"> 613</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Stim #</span><span class="si">%d</span><span class="s2">: using ET stimulus&quot;</span><span class="p">,</span> <span class="n">expt_n</span> <span class="p">)</span>
</span><span id="MultiClouds-614"><a href="#MultiClouds-614"><span class="linenos"> 614</span></a>                <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="MultiClouds-615"><a href="#MultiClouds-615"><span class="linenos"> 615</span></a>                <span class="c1">#self.stim_pos = self.stim_locationET[:,0]</span>
</span><span id="MultiClouds-616"><a href="#MultiClouds-616"><span class="linenos"> 616</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-617"><a href="#MultiClouds-617"><span class="linenos"> 617</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Stim #</span><span class="si">%d</span><span class="s2">: using laminar probe stimulus&quot;</span><span class="p">,</span> <span class="n">expt_n</span> <span class="p">)</span>
</span><span id="MultiClouds-618"><a href="#MultiClouds-618"><span class="linenos"> 618</span></a>                <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="MultiClouds-619"><a href="#MultiClouds-619"><span class="linenos"> 619</span></a>                <span class="c1">#self.stim_pos = self.stim_location[:, 0]</span>
</span><span id="MultiClouds-620"><a href="#MultiClouds-620"><span class="linenos"> 620</span></a>
</span><span id="MultiClouds-621"><a href="#MultiClouds-621"><span class="linenos"> 621</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="MultiClouds-622"><a href="#MultiClouds-622"><span class="linenos"> 622</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="n">stim_tmp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-623"><a href="#MultiClouds-623"><span class="linenos"> 623</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-624"><a href="#MultiClouds-624"><span class="linenos"> 624</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="n">stim_tmp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-625"><a href="#MultiClouds-625"><span class="linenos"> 625</span></a>            
</span><span id="MultiClouds-626"><a href="#MultiClouds-626"><span class="linenos"> 626</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">newstim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MultiClouds-627"><a href="#MultiClouds-627"><span class="linenos"> 627</span></a>            <span class="c1"># Forget binocular for now</span>
</span><span id="MultiClouds-628"><a href="#MultiClouds-628"><span class="linenos"> 628</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="MultiClouds-629"><a href="#MultiClouds-629"><span class="linenos"> 629</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;currently not implemented&#39;</span><span class="p">)</span>
</span><span id="MultiClouds-630"><a href="#MultiClouds-630"><span class="linenos"> 630</span></a>
</span><span id="MultiClouds-631"><a href="#MultiClouds-631"><span class="linenos"> 631</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-632"><a href="#MultiClouds-632"><span class="linenos"> 632</span></a>            <span class="c1"># Assemble from combination of ET and laminer probe (NP) stimulus</span>
</span><span id="MultiClouds-633"><a href="#MultiClouds-633"><span class="linenos"> 633</span></a>            <span class="k">assert</span> <span class="n">top_corner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need top corner if which_stim unspecified&quot;</span>
</span><span id="MultiClouds-634"><a href="#MultiClouds-634"><span class="linenos"> 634</span></a>            <span class="k">assert</span> <span class="n">stim_crop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Cannot specify stim_crop and top_corner&quot;</span>
</span><span id="MultiClouds-635"><a href="#MultiClouds-635"><span class="linenos"> 635</span></a>
</span><span id="MultiClouds-636"><a href="#MultiClouds-636"><span class="linenos"> 636</span></a>            <span class="c1"># Determine stim location</span>
</span><span id="MultiClouds-637"><a href="#MultiClouds-637"><span class="linenos"> 637</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_corner</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="MultiClouds-638"><a href="#MultiClouds-638"><span class="linenos"> 638</span></a>                <span class="n">stim_pos</span> <span class="o">=</span> <span class="n">top_corner</span>
</span><span id="MultiClouds-639"><a href="#MultiClouds-639"><span class="linenos"> 639</span></a>                <span class="c1">#L = self.stim_pos[2]-self.stim_pos[0]</span>
</span><span id="MultiClouds-640"><a href="#MultiClouds-640"><span class="linenos"> 640</span></a>                <span class="k">assert</span> <span class="n">stim_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">stim_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Stim must be square (for now)&quot;</span>
</span><span id="MultiClouds-641"><a href="#MultiClouds-641"><span class="linenos"> 641</span></a>                <span class="k">if</span> <span class="n">L</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-642"><a href="#MultiClouds-642"><span class="linenos"> 642</span></a>                    <span class="k">assert</span> <span class="n">L</span> <span class="o">==</span> <span class="n">stim_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;L does not match specified stim size&quot;</span>
</span><span id="MultiClouds-643"><a href="#MultiClouds-643"><span class="linenos"> 643</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-644"><a href="#MultiClouds-644"><span class="linenos"> 644</span></a>                    <span class="n">L</span> <span class="o">=</span> <span class="n">stim_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds-645"><a href="#MultiClouds-645"><span class="linenos"> 645</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-646"><a href="#MultiClouds-646"><span class="linenos"> 646</span></a>                <span class="k">if</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-647"><a href="#MultiClouds-647"><span class="linenos"> 647</span></a>                    <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span>
</span><span id="MultiClouds-648"><a href="#MultiClouds-648"><span class="linenos"> 648</span></a>                <span class="k">assert</span> <span class="n">L</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to specify stimulus size&quot;</span>
</span><span id="MultiClouds-649"><a href="#MultiClouds-649"><span class="linenos"> 649</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-650"><a href="#MultiClouds-650"><span class="linenos"> 650</span></a>                    <span class="k">assert</span> <span class="n">L</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="s2">&quot;BUILD_STIM: size of stimuli much match. L=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span> 
</span><span id="MultiClouds-651"><a href="#MultiClouds-651"><span class="linenos"> 651</span></a>
</span><span id="MultiClouds-652"><a href="#MultiClouds-652"><span class="linenos"> 652</span></a>                <span class="n">stim_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">top_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">top_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">top_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">L</span><span class="p">,</span> <span class="n">top_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">L</span><span class="p">]</span>
</span><span id="MultiClouds-653"><a href="#MultiClouds-653"><span class="linenos"> 653</span></a>
</span><span id="MultiClouds-654"><a href="#MultiClouds-654"><span class="linenos"> 654</span></a>            <span class="k">if</span> <span class="n">eyepos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-655"><a href="#MultiClouds-655"><span class="linenos"> 655</span></a>                <span class="n">need2crop</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="MultiClouds-656"><a href="#MultiClouds-656"><span class="linenos"> 656</span></a>                <span class="c1"># Extend stim window by BUFF-per-side in each direction</span>
</span><span id="MultiClouds-657"><a href="#MultiClouds-657"><span class="linenos"> 657</span></a>                <span class="n">stim_pos</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="MultiClouds-658"><a href="#MultiClouds-658"><span class="linenos"> 658</span></a>                    <span class="n">stim_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span>
</span><span id="MultiClouds-659"><a href="#MultiClouds-659"><span class="linenos"> 659</span></a>                    <span class="n">stim_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span>
</span><span id="MultiClouds-660"><a href="#MultiClouds-660"><span class="linenos"> 660</span></a>                    <span class="n">stim_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">BUF</span><span class="p">,</span>
</span><span id="MultiClouds-661"><a href="#MultiClouds-661"><span class="linenos"> 661</span></a>                    <span class="n">stim_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">BUF</span><span class="p">]</span>
</span><span id="MultiClouds-662"><a href="#MultiClouds-662"><span class="linenos"> 662</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Stim expansion for shift:&quot;</span><span class="p">,</span> <span class="n">stim_pos</span><span class="p">)</span>
</span><span id="MultiClouds-663"><a href="#MultiClouds-663"><span class="linenos"> 663</span></a>                <span class="n">L</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">BUF</span>
</span><span id="MultiClouds-664"><a href="#MultiClouds-664"><span class="linenos"> 664</span></a>
</span><span id="MultiClouds-665"><a href="#MultiClouds-665"><span class="linenos"> 665</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="MultiClouds-666"><a href="#MultiClouds-666"><span class="linenos"> 666</span></a>                <span class="n">num_clr</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MultiClouds-667"><a href="#MultiClouds-667"><span class="linenos"> 667</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-668"><a href="#MultiClouds-668"><span class="linenos"> 668</span></a>                <span class="n">num_clr</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="MultiClouds-669"><a href="#MultiClouds-669"><span class="linenos"> 669</span></a>
</span><span id="MultiClouds-670"><a href="#MultiClouds-670"><span class="linenos"> 670</span></a>            <span class="c1"># Read in stimuli</span>
</span><span id="MultiClouds-671"><a href="#MultiClouds-671"><span class="linenos"> 671</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stimET&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MultiClouds-672"><a href="#MultiClouds-672"><span class="linenos"> 672</span></a>                <span class="n">stimET_base</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MultiClouds-673"><a href="#MultiClouds-673"><span class="linenos"> 673</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-674"><a href="#MultiClouds-674"><span class="linenos"> 674</span></a>                <span class="n">stimET_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stimET&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="MultiClouds-675"><a href="#MultiClouds-675"><span class="linenos"> 675</span></a>            
</span><span id="MultiClouds-676"><a href="#MultiClouds-676"><span class="linenos"> 676</span></a>            <span class="n">locsET</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stim_locsET&#39;</span><span class="p">]</span>
</span><span id="MultiClouds-677"><a href="#MultiClouds-677"><span class="linenos"> 677</span></a>            <span class="n">stimLP_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stim&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="MultiClouds-678"><a href="#MultiClouds-678"><span class="linenos"> 678</span></a>            <span class="n">locsLP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stim_locsLP&#39;</span><span class="p">]</span>
</span><span id="MultiClouds-679"><a href="#MultiClouds-679"><span class="linenos"> 679</span></a>            <span class="n">fhandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">expt_n</span><span class="p">]</span>
</span><span id="MultiClouds-680"><a href="#MultiClouds-680"><span class="linenos"> 680</span></a>            <span class="n">sz</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="MultiClouds-681"><a href="#MultiClouds-681"><span class="linenos"> 681</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds-682"><a href="#MultiClouds-682"><span class="linenos"> 682</span></a>
</span><span id="MultiClouds-683"><a href="#MultiClouds-683"><span class="linenos"> 683</span></a>            <span class="c1">#stimET_base = np.array(self.fhandles[expt_n][&#39;stimET&#39;][self.tranges[expt_n], ...], dtype=np.int8)</span>
</span><span id="MultiClouds-684"><a href="#MultiClouds-684"><span class="linenos"> 684</span></a>            <span class="c1">#stimLP_base = np.array(self.fhandles[expt_n][&#39;stim&#39;][self.tranges[expt_n], ...], dtype=np.int8)</span>
</span><span id="MultiClouds-685"><a href="#MultiClouds-685"><span class="linenos"> 685</span></a>            <span class="c1">#locsET = self.file_info[expt_n][&#39;stim_locsET&#39;]</span>
</span><span id="MultiClouds-686"><a href="#MultiClouds-686"><span class="linenos"> 686</span></a>            <span class="c1">#locsLP = self.file_info[expt_n][&#39;stim_locsLP&#39;]</span>
</span><span id="MultiClouds-687"><a href="#MultiClouds-687"><span class="linenos"> 687</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="MultiClouds-688"><a href="#MultiClouds-688"><span class="linenos"> 688</span></a>                <span class="n">num_clr</span> <span class="o">*=</span> <span class="mi">2</span>  <span class="c1"># make binocular be like just 2x more colors (channel dim)</span>
</span><span id="MultiClouds-689"><a href="#MultiClouds-689"><span class="linenos"> 689</span></a>                <span class="n">Lpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useLeye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-690"><a href="#MultiClouds-690"><span class="linenos"> 690</span></a>                <span class="n">Rpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-691"><a href="#MultiClouds-691"><span class="linenos"> 691</span></a>                <span class="n">LRpresent</span> <span class="o">=</span> <span class="n">Lpresent</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Rpresent</span>
</span><span id="MultiClouds-692"><a href="#MultiClouds-692"><span class="linenos"> 692</span></a>                <span class="n">Leye</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="MultiClouds-693"><a href="#MultiClouds-693"><span class="linenos"> 693</span></a>                <span class="n">Reye</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds-694"><a href="#MultiClouds-694"><span class="linenos"> 694</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">LRpresent</span><span class="p">),</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="MultiClouds-695"><a href="#MultiClouds-695"><span class="linenos"> 695</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span><span class="p">[</span><span class="n">LRpresent</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="MultiClouds-696"><a href="#MultiClouds-696"><span class="linenos"> 696</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span><span class="p">[</span><span class="n">LRpresent</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="MultiClouds-697"><a href="#MultiClouds-697"><span class="linenos"> 697</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span> 
</span><span id="MultiClouds-698"><a href="#MultiClouds-698"><span class="linenos"> 698</span></a>                    <span class="c1">#empty_stimET=np.zeros((np.shape(stimET)[0], 2, np.shape(stimET)[2], np.shape(stimET)[3]))</span>
</span><span id="MultiClouds-699"><a href="#MultiClouds-699"><span class="linenos"> 699</span></a>                    <span class="n">stimLP</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimLP_base</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimLP_base</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimLP_base</span><span class="p">)[</span><span class="mi">3</span><span class="p">]))</span>
</span><span id="MultiClouds-700"><a href="#MultiClouds-700"><span class="linenos"> 700</span></a>                    <span class="n">stimLP</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-701"><a href="#MultiClouds-701"><span class="linenos"> 701</span></a>                    <span class="n">stimLP</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-702"><a href="#MultiClouds-702"><span class="linenos"> 702</span></a>                    <span class="k">if</span> <span class="n">stimET_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-703"><a href="#MultiClouds-703"><span class="linenos"> 703</span></a>                        <span class="n">stimET</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimET_base</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimET_base</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimET_base</span><span class="p">)[</span><span class="mi">3</span><span class="p">]))</span>
</span><span id="MultiClouds-704"><a href="#MultiClouds-704"><span class="linenos"> 704</span></a>                        <span class="n">stimET</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-705"><a href="#MultiClouds-705"><span class="linenos"> 705</span></a>                        <span class="n">stimET</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-706"><a href="#MultiClouds-706"><span class="linenos"> 706</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-707"><a href="#MultiClouds-707"><span class="linenos"> 707</span></a>                    <span class="n">stimLP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimLP_base</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimLP_base</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimLP_base</span><span class="p">)[</span><span class="mi">3</span><span class="p">]))</span>
</span><span id="MultiClouds-708"><a href="#MultiClouds-708"><span class="linenos"> 708</span></a>                    <span class="n">stimLP</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-709"><a href="#MultiClouds-709"><span class="linenos"> 709</span></a>                    <span class="n">stimLP</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-710"><a href="#MultiClouds-710"><span class="linenos"> 710</span></a>                    <span class="k">if</span> <span class="n">stimET_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-711"><a href="#MultiClouds-711"><span class="linenos"> 711</span></a>                        <span class="n">stimET</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimET_base</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimET_base</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimET_base</span><span class="p">)[</span><span class="mi">3</span><span class="p">]))</span>
</span><span id="MultiClouds-712"><a href="#MultiClouds-712"><span class="linenos"> 712</span></a>                        <span class="n">stimET</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-713"><a href="#MultiClouds-713"><span class="linenos"> 713</span></a>                        <span class="n">stimET</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-714"><a href="#MultiClouds-714"><span class="linenos"> 714</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-715"><a href="#MultiClouds-715"><span class="linenos"> 715</span></a>                <span class="n">stimET</span><span class="o">=</span><span class="n">stimET_base</span>
</span><span id="MultiClouds-716"><a href="#MultiClouds-716"><span class="linenos"> 716</span></a>                <span class="n">stimLP</span><span class="o">=</span><span class="n">stimLP_base</span>
</span><span id="MultiClouds-717"><a href="#MultiClouds-717"><span class="linenos"> 717</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="MultiClouds-718"><a href="#MultiClouds-718"><span class="linenos"> 718</span></a>                    <span class="n">stimLP</span> <span class="o">=</span> <span class="n">stimLP</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-719"><a href="#MultiClouds-719"><span class="linenos"> 719</span></a>                <span class="k">if</span> <span class="n">stimET_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-720"><a href="#MultiClouds-720"><span class="linenos"> 720</span></a>                    <span class="c1"># stimET=stimET_base</span>
</span><span id="MultiClouds-721"><a href="#MultiClouds-721"><span class="linenos"> 721</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="MultiClouds-722"><a href="#MultiClouds-722"><span class="linenos"> 722</span></a>                        <span class="k">if</span> <span class="n">stimET_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
</span><span id="MultiClouds-723"><a href="#MultiClouds-723"><span class="linenos"> 723</span></a>                            <span class="n">stimET</span> <span class="o">=</span> <span class="n">stimET</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>  <span class="c1"># maintain 2nd dim (length 1)</span>
</span><span id="MultiClouds-724"><a href="#MultiClouds-724"><span class="linenos"> 724</span></a>         
</span><span id="MultiClouds-725"><a href="#MultiClouds-725"><span class="linenos"> 725</span></a>            <span class="n">NT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">expt_n</span><span class="p">]</span>
</span><span id="MultiClouds-726"><a href="#MultiClouds-726"><span class="linenos"> 726</span></a>            <span class="n">newstim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="n">num_clr</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span> <span class="p">)</span>
</span><span id="MultiClouds-727"><a href="#MultiClouds-727"><span class="linenos"> 727</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">locsLP</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="MultiClouds-728"><a href="#MultiClouds-728"><span class="linenos"> 728</span></a>                <span class="n">OVLP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_overlap_ranges</span><span class="p">(</span><span class="n">stim_pos</span><span class="p">,</span> <span class="n">locsLP</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">])</span>
</span><span id="MultiClouds-729"><a href="#MultiClouds-729"><span class="linenos"> 729</span></a>                <span class="k">if</span> <span class="n">OVLP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-730"><a href="#MultiClouds-730"><span class="linenos"> 730</span></a>                    <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Writing lam stim </span><span class="si">%d</span><span class="s2">: overlap </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">])))</span>
</span><span id="MultiClouds-731"><a href="#MultiClouds-731"><span class="linenos"> 731</span></a>                    <span class="n">strip</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:])</span> <span class="c1">#np.zeros([self.NT, num_clr, len(OVLP[&#39;targetX&#39;]), L])</span>
</span><span id="MultiClouds-732"><a href="#MultiClouds-732"><span class="linenos"> 732</span></a>                    <span class="n">strip</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">((</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readX&#39;</span><span class="p">],</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readY&#39;</span><span class="p">]]))</span>
</span><span id="MultiClouds-733"><a href="#MultiClouds-733"><span class="linenos"> 733</span></a>                    <span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span>
</span><span id="MultiClouds-734"><a href="#MultiClouds-734"><span class="linenos"> 734</span></a>                
</span><span id="MultiClouds-735"><a href="#MultiClouds-735"><span class="linenos"> 735</span></a>            <span class="k">if</span> <span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>    
</span><span id="MultiClouds-736"><a href="#MultiClouds-736"><span class="linenos"> 736</span></a>                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">locsET</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="MultiClouds-737"><a href="#MultiClouds-737"><span class="linenos"> 737</span></a>                    <span class="n">OVLP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_overlap_ranges</span><span class="p">(</span><span class="n">stim_pos</span><span class="p">,</span> <span class="n">locsET</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">])</span>
</span><span id="MultiClouds-738"><a href="#MultiClouds-738"><span class="linenos"> 738</span></a>                    <span class="k">if</span> <span class="n">OVLP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-739"><a href="#MultiClouds-739"><span class="linenos"> 739</span></a>                        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Writing ETstim </span><span class="si">%d</span><span class="s2">: overlap </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">])))</span>
</span><span id="MultiClouds-740"><a href="#MultiClouds-740"><span class="linenos"> 740</span></a>                        <span class="n">strip</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:])</span>
</span><span id="MultiClouds-741"><a href="#MultiClouds-741"><span class="linenos"> 741</span></a>                        <span class="n">strip</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">((</span><span class="n">stimET</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readX&#39;</span><span class="p">],</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readY&#39;</span><span class="p">]]))</span>
</span><span id="MultiClouds-742"><a href="#MultiClouds-742"><span class="linenos"> 742</span></a>                        <span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span> 
</span><span id="MultiClouds-743"><a href="#MultiClouds-743"><span class="linenos"> 743</span></a>
</span><span id="MultiClouds-744"><a href="#MultiClouds-744"><span class="linenos"> 744</span></a>            <span class="c1">#stim = torch.tensor( newstim, dtype=torch.float32, device=self.device )</span>
</span><span id="MultiClouds-745"><a href="#MultiClouds-745"><span class="linenos"> 745</span></a>        <span class="c1"># Note stim stored in numpy is being represented as full 3-d + 1 tensor (time, channels, NX, NY)</span>
</span><span id="MultiClouds-746"><a href="#MultiClouds-746"><span class="linenos"> 746</span></a>
</span><span id="MultiClouds-747"><a href="#MultiClouds-747"><span class="linenos"> 747</span></a>        <span class="c1"># Insert fixation point</span>
</span><span id="MultiClouds-748"><a href="#MultiClouds-748"><span class="linenos"> 748</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">fixdot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fixpoint_present</span><span class="p">(</span> <span class="n">stim_pos</span><span class="p">,</span> <span class="n">expt_n</span> <span class="p">):</span>
</span><span id="MultiClouds-749"><a href="#MultiClouds-749"><span class="linenos"> 749</span></a>            <span class="n">fixranges</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="MultiClouds-750"><a href="#MultiClouds-750"><span class="linenos"> 750</span></a>            <span class="n">fix_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;fix_loc&#39;</span><span class="p">]</span>
</span><span id="MultiClouds-751"><a href="#MultiClouds-751"><span class="linenos"> 751</span></a>            <span class="n">fix_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;fix_size&#39;</span><span class="p">]</span>
</span><span id="MultiClouds-752"><a href="#MultiClouds-752"><span class="linenos"> 752</span></a>            <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="MultiClouds-753"><a href="#MultiClouds-753"><span class="linenos"> 753</span></a>                <span class="n">fixranges</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
</span><span id="MultiClouds-754"><a href="#MultiClouds-754"><span class="linenos"> 754</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">fix_loc</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">-</span><span class="n">fix_size</span><span class="o">-</span><span class="n">stim_pos</span><span class="p">[</span><span class="n">dd</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="MultiClouds-755"><a href="#MultiClouds-755"><span class="linenos"> 755</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">fix_loc</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">+</span><span class="n">fix_size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">stim_pos</span><span class="p">[</span><span class="n">dd</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="n">stim_pos</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span> 
</span><span id="MultiClouds-756"><a href="#MultiClouds-756"><span class="linenos"> 756</span></a>                    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="MultiClouds-757"><a href="#MultiClouds-757"><span class="linenos"> 757</span></a>            <span class="c1"># Write the correct value to stim</span>
</span><span id="MultiClouds-758"><a href="#MultiClouds-758"><span class="linenos"> 758</span></a>            <span class="k">assert</span> <span class="n">fixdot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Haven&#39;t yet put in other fixdot settings than zero&quot;</span> 
</span><span id="MultiClouds-759"><a href="#MultiClouds-759"><span class="linenos"> 759</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Adding fixation point&#39;</span><span class="p">)</span>
</span><span id="MultiClouds-760"><a href="#MultiClouds-760"><span class="linenos"> 760</span></a>            <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">fixranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="MultiClouds-761"><a href="#MultiClouds-761"><span class="linenos"> 761</span></a>                <span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">fixranges</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds-762"><a href="#MultiClouds-762"><span class="linenos"> 762</span></a>
</span><span id="MultiClouds-763"><a href="#MultiClouds-763"><span class="linenos"> 763</span></a>        <span class="k">if</span> <span class="n">eyepos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-764"><a href="#MultiClouds-764"><span class="linenos"> 764</span></a>            <span class="c1"># Would want to shift by input eye positions if input here</span>
</span><span id="MultiClouds-765"><a href="#MultiClouds-765"><span class="linenos"> 765</span></a>            <span class="c1">#print(&#39;eye-position shifting not implemented yet&#39;)</span>
</span><span id="MultiClouds-766"><a href="#MultiClouds-766"><span class="linenos"> 766</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Shifting stim...&#39;</span><span class="p">)</span>
</span><span id="MultiClouds-767"><a href="#MultiClouds-767"><span class="linenos"> 767</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eyepos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">newstim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="MultiClouds-768"><a href="#MultiClouds-768"><span class="linenos"> 768</span></a>                <span class="n">eyepos</span> <span class="o">=</span> <span class="n">eyepos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">]]</span>
</span><span id="MultiClouds-769"><a href="#MultiClouds-769"><span class="linenos"> 769</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eyepos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">newstim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="MultiClouds-770"><a href="#MultiClouds-770"><span class="linenos"> 770</span></a>                <span class="n">eyepos_padded</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">newstim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="MultiClouds-771"><a href="#MultiClouds-771"><span class="linenos"> 771</span></a>                <span class="n">Lpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useLeye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-772"><a href="#MultiClouds-772"><span class="linenos"> 772</span></a>                <span class="n">Rpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-773"><a href="#MultiClouds-773"><span class="linenos"> 773</span></a>                <span class="n">LRpresent</span> <span class="o">=</span> <span class="n">Lpresent</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Rpresent</span>
</span><span id="MultiClouds-774"><a href="#MultiClouds-774"><span class="linenos"> 774</span></a>                <span class="n">bin_inds</span><span class="o">=</span><span class="n">inds</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span><span class="p">)]</span>
</span><span id="MultiClouds-775"><a href="#MultiClouds-775"><span class="linenos"> 775</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_inds</span><span class="p">)</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="n">eyepos</span><span class="p">):</span>
</span><span id="MultiClouds-776"><a href="#MultiClouds-776"><span class="linenos"> 776</span></a>                    <span class="n">eyepos_padded</span><span class="p">[</span><span class="n">bin_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">bin_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">eyepos</span><span class="p">)]</span><span class="o">=</span><span class="n">eyepos</span> <span class="c1">#Off by one errors, probably. </span>
</span><span id="MultiClouds-777"><a href="#MultiClouds-777"><span class="linenos"> 777</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-778"><a href="#MultiClouds-778"><span class="linenos"> 778</span></a>                    <span class="n">eyepos_padded</span><span class="p">[</span><span class="n">bin_inds</span><span class="p">]</span><span class="o">=</span><span class="n">eyepos</span>
</span><span id="MultiClouds-779"><a href="#MultiClouds-779"><span class="linenos"> 779</span></a>                <span class="n">eyepos</span><span class="o">=</span><span class="n">eyepos_padded</span> 
</span><span id="MultiClouds-780"><a href="#MultiClouds-780"><span class="linenos"> 780</span></a>            <span class="k">if</span> <span class="n">num_clr</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>                 
</span><span id="MultiClouds-781"><a href="#MultiClouds-781"><span class="linenos"> 781</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_stim</span><span class="p">(</span> <span class="n">newstim</span><span class="p">,</span> <span class="n">eyepos</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="MultiClouds-782"><a href="#MultiClouds-782"><span class="linenos"> 782</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-783"><a href="#MultiClouds-783"><span class="linenos"> 783</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_stim</span><span class="p">(</span><span class="n">newstim</span><span class="p">,</span> <span class="n">eyepos</span><span class="p">)</span> 
</span><span id="MultiClouds-784"><a href="#MultiClouds-784"><span class="linenos"> 784</span></a>
</span><span id="MultiClouds-785"><a href="#MultiClouds-785"><span class="linenos"> 785</span></a>        <span class="c1"># Reduce size back to original If expanded to handle shifts</span>
</span><span id="MultiClouds-786"><a href="#MultiClouds-786"><span class="linenos"> 786</span></a>        <span class="k">if</span> <span class="n">need2crop</span><span class="p">:</span>
</span><span id="MultiClouds-787"><a href="#MultiClouds-787"><span class="linenos"> 787</span></a>            <span class="c1">#assert self.stim_crop is None, &quot;Cannot crop stim at same time as shifting&quot;</span>
</span><span id="MultiClouds-788"><a href="#MultiClouds-788"><span class="linenos"> 788</span></a>            <span class="n">newstim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_stim</span><span class="p">(</span> <span class="n">newstim</span><span class="p">,</span> <span class="p">[</span><span class="n">BUF</span><span class="p">,</span> <span class="n">L</span><span class="o">-</span><span class="n">BUF</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">BUF</span><span class="p">,</span> <span class="n">L</span><span class="o">-</span><span class="n">BUF</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>  <span class="c1"># move back to original size</span>
</span><span id="MultiClouds-789"><a href="#MultiClouds-789"><span class="linenos"> 789</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">L</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">BUF</span>
</span><span id="MultiClouds-790"><a href="#MultiClouds-790"><span class="linenos"> 790</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-791"><a href="#MultiClouds-791"><span class="linenos"> 791</span></a>            <span class="c1"># if used which_stim and added crop</span>
</span><span id="MultiClouds-792"><a href="#MultiClouds-792"><span class="linenos"> 792</span></a>            <span class="k">if</span> <span class="n">stim_crop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-793"><a href="#MultiClouds-793"><span class="linenos"> 793</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_stim</span><span class="p">(</span> <span class="n">newstim</span><span class="p">,</span> <span class="n">stim_crop</span> <span class="p">)</span>
</span><span id="MultiClouds-794"><a href="#MultiClouds-794"><span class="linenos"> 794</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">newstim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MultiClouds-795"><a href="#MultiClouds-795"><span class="linenos"> 795</span></a>
</span><span id="MultiClouds-796"><a href="#MultiClouds-796"><span class="linenos"> 796</span></a>        <span class="c1"># Verify L matches current stim&#39;s L</span>
</span><span id="MultiClouds-797"><a href="#MultiClouds-797"><span class="linenos"> 797</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-798"><a href="#MultiClouds-798"><span class="linenos"> 798</span></a>            <span class="k">assert</span> <span class="n">L</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="s2">&quot;BUILD_STIM: L mismatch (which_stim)&quot;</span>
</span><span id="MultiClouds-799"><a href="#MultiClouds-799"><span class="linenos"> 799</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">L</span>
</span><span id="MultiClouds-800"><a href="#MultiClouds-800"><span class="linenos"> 800</span></a>
</span><span id="MultiClouds-801"><a href="#MultiClouds-801"><span class="linenos"> 801</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-802"><a href="#MultiClouds-802"><span class="linenos"> 802</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">=</span> <span class="n">time_embed</span>
</span><span id="MultiClouds-803"><a href="#MultiClouds-803"><span class="linenos"> 803</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-804"><a href="#MultiClouds-804"><span class="linenos"> 804</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">==</span> <span class="n">time_embed</span><span class="p">,</span> <span class="s2">&quot;time_embed setting must match&quot;</span>
</span><span id="MultiClouds-805"><a href="#MultiClouds-805"><span class="linenos"> 805</span></a>            
</span><span id="MultiClouds-806"><a href="#MultiClouds-806"><span class="linenos"> 806</span></a>        <span class="k">if</span> <span class="n">time_embed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds-807"><a href="#MultiClouds-807"><span class="linenos"> 807</span></a>            <span class="c1">#self.stim_dims[3] = num_lags  # this is set by time-embedding</span>
</span><span id="MultiClouds-808"><a href="#MultiClouds-808"><span class="linenos"> 808</span></a>            <span class="k">if</span> <span class="n">time_embed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="MultiClouds-809"><a href="#MultiClouds-809"><span class="linenos"> 809</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embedding</span><span class="p">(</span> <span class="n">newstim</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span> <span class="p">)</span>
</span><span id="MultiClouds-810"><a href="#MultiClouds-810"><span class="linenos"> 810</span></a>        <span class="c1"># now stimulus is represented as full 4-d + 1 tensor (time, channels, NX, NY, num_lags)</span>
</span><span id="MultiClouds-811"><a href="#MultiClouds-811"><span class="linenos"> 811</span></a>
</span><span id="MultiClouds-812"><a href="#MultiClouds-812"><span class="linenos"> 812</span></a>        <span class="c1"># Translate to cone-isolating stimmulus if DKL is false</span>
</span><span id="MultiClouds-813"><a href="#MultiClouds-813"><span class="linenos"> 813</span></a>        <span class="k">if</span> <span class="n">LMS</span><span class="p">:</span>
</span><span id="MultiClouds-814"><a href="#MultiClouds-814"><span class="linenos"> 814</span></a>            <span class="c1"># Make LMS conversion matrix</span>
</span><span id="MultiClouds-815"><a href="#MultiClouds-815"><span class="linenos"> 815</span></a>            <span class="n">DKL2LMS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.7586</span><span class="p">,</span> <span class="mf">0.6515</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5536</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8328</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.8660</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds-816"><a href="#MultiClouds-816"><span class="linenos"> 816</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;  Converting to LMS space&#39;</span><span class="p">)</span>
</span><span id="MultiClouds-817"><a href="#MultiClouds-817"><span class="linenos"> 817</span></a>            <span class="n">newstim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span> <span class="s1">&#39;axcd,bx-&gt;abcd&#39;</span><span class="p">,</span> <span class="n">newstim</span><span class="p">,</span> <span class="n">DKL2LMS</span><span class="p">)</span>
</span><span id="MultiClouds-818"><a href="#MultiClouds-818"><span class="linenos"> 818</span></a>
</span><span id="MultiClouds-819"><a href="#MultiClouds-819"><span class="linenos"> 819</span></a>        <span class="c1"># Flatten stim </span>
</span><span id="MultiClouds-820"><a href="#MultiClouds-820"><span class="linenos"> 820</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">expt_stims</span><span class="p">[</span><span class="n">expt_n</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">newstim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">expt_n</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="MultiClouds-821"><a href="#MultiClouds-821"><span class="linenos"> 821</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Done: expt&quot;</span><span class="p">,</span> <span class="n">expt_n</span> <span class="p">)</span>
</span><span id="MultiClouds-822"><a href="#MultiClouds-822"><span class="linenos"> 822</span></a>    <span class="c1"># END MultiClouds.build_stim()</span>
</span><span id="MultiClouds-823"><a href="#MultiClouds-823"><span class="linenos"> 823</span></a>
</span><span id="MultiClouds-824"><a href="#MultiClouds-824"><span class="linenos"> 824</span></a>    <span class="k">def</span> <span class="nf">assemble_stim</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="MultiClouds-825"><a href="#MultiClouds-825"><span class="linenos"> 825</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-826"><a href="#MultiClouds-826"><span class="linenos"> 826</span></a><span class="sd">        Assemble stimulus from all experiments into self.stim</span>
</span><span id="MultiClouds-827"><a href="#MultiClouds-827"><span class="linenos"> 827</span></a>
</span><span id="MultiClouds-828"><a href="#MultiClouds-828"><span class="linenos"> 828</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds-829"><a href="#MultiClouds-829"><span class="linenos"> 829</span></a><span class="sd">            None</span>
</span><span id="MultiClouds-830"><a href="#MultiClouds-830"><span class="linenos"> 830</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-831"><a href="#MultiClouds-831"><span class="linenos"> 831</span></a>
</span><span id="MultiClouds-832"><a href="#MultiClouds-832"><span class="linenos"> 832</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds-833"><a href="#MultiClouds-833"><span class="linenos"> 833</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="MultiClouds-834"><a href="#MultiClouds-834"><span class="linenos"> 834</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MultiClouds-835"><a href="#MultiClouds-835"><span class="linenos"> 835</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="MultiClouds-836"><a href="#MultiClouds-836"><span class="linenos"> 836</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-837"><a href="#MultiClouds-837"><span class="linenos"> 837</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span><span class="p">:</span>
</span><span id="MultiClouds-838"><a href="#MultiClouds-838"><span class="linenos"> 838</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="MultiClouds-839"><a href="#MultiClouds-839"><span class="linenos"> 839</span></a>        <span class="n">num_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">)</span>
</span><span id="MultiClouds-840"><a href="#MultiClouds-840"><span class="linenos"> 840</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span> <span class="p">)</span>
</span><span id="MultiClouds-841"><a href="#MultiClouds-841"><span class="linenos"> 841</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">):</span>
</span><span id="MultiClouds-842"><a href="#MultiClouds-842"><span class="linenos"> 842</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">expt_stims</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;ASSEMBLE_STIM: stim </span><span class="si">%d</span><span class="s1"> is not yet built.&#39;</span><span class="o">%</span><span class="n">ff</span>  
</span><span id="MultiClouds-843"><a href="#MultiClouds-843"><span class="linenos"> 843</span></a>            <span class="n">trange</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_tstart</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_tstart</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="MultiClouds-844"><a href="#MultiClouds-844"><span class="linenos"> 844</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">trange</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expt_stims</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span>
</span><span id="MultiClouds-845"><a href="#MultiClouds-845"><span class="linenos"> 845</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Stimulus assembly complete&quot;</span><span class="p">)</span>
</span><span id="MultiClouds-846"><a href="#MultiClouds-846"><span class="linenos"> 846</span></a>    <span class="c1"># END MultiClouds.assemble_stimulus()</span>
</span><span id="MultiClouds-847"><a href="#MultiClouds-847"><span class="linenos"> 847</span></a>
</span><span id="MultiClouds-848"><a href="#MultiClouds-848"><span class="linenos"> 848</span></a>    <span class="k">def</span> <span class="nf">time_embedding</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="MultiClouds-849"><a href="#MultiClouds-849"><span class="linenos"> 849</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-850"><a href="#MultiClouds-850"><span class="linenos"> 850</span></a><span class="sd">        Note this overloads SensoryBase because reshapes in full dimensions to handle folded_lags</span>
</span><span id="MultiClouds-851"><a href="#MultiClouds-851"><span class="linenos"> 851</span></a><span class="sd">        </span>
</span><span id="MultiClouds-852"><a href="#MultiClouds-852"><span class="linenos"> 852</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds-853"><a href="#MultiClouds-853"><span class="linenos"> 853</span></a><span class="sd">            stim (np.array): stimulus to time-embed</span>
</span><span id="MultiClouds-854"><a href="#MultiClouds-854"><span class="linenos"> 854</span></a><span class="sd">            nlags (int): number of lags</span>
</span><span id="MultiClouds-855"><a href="#MultiClouds-855"><span class="linenos"> 855</span></a>
</span><span id="MultiClouds-856"><a href="#MultiClouds-856"><span class="linenos"> 856</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds-857"><a href="#MultiClouds-857"><span class="linenos"> 857</span></a><span class="sd">            np.array: time-embedded stimulus</span>
</span><span id="MultiClouds-858"><a href="#MultiClouds-858"><span class="linenos"> 858</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-859"><a href="#MultiClouds-859"><span class="linenos"> 859</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to assemble stim before time-embedding.&quot;</span>
</span><span id="MultiClouds-860"><a href="#MultiClouds-860"><span class="linenos"> 860</span></a>
</span><span id="MultiClouds-861"><a href="#MultiClouds-861"><span class="linenos"> 861</span></a>        <span class="k">if</span> <span class="n">nlags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-862"><a href="#MultiClouds-862"><span class="linenos"> 862</span></a>            <span class="n">nlags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="MultiClouds-863"><a href="#MultiClouds-863"><span class="linenos"> 863</span></a>        <span class="c1">#if self.stim_dims[3] == 1:</span>
</span><span id="MultiClouds-864"><a href="#MultiClouds-864"><span class="linenos"> 864</span></a>        <span class="c1">#    self.stim_dims[3] = nlags</span>
</span><span id="MultiClouds-865"><a href="#MultiClouds-865"><span class="linenos"> 865</span></a>        <span class="c1">#if stim is None:</span>
</span><span id="MultiClouds-866"><a href="#MultiClouds-866"><span class="linenos"> 866</span></a>        <span class="c1">#    tmp_stim = deepcopy(self.stim)</span>
</span><span id="MultiClouds-867"><a href="#MultiClouds-867"><span class="linenos"> 867</span></a>    
</span><span id="MultiClouds-868"><a href="#MultiClouds-868"><span class="linenos"> 868</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-869"><a href="#MultiClouds-869"><span class="linenos"> 869</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Time embedding...&quot;</span><span class="p">)</span>
</span><span id="MultiClouds-870"><a href="#MultiClouds-870"><span class="linenos"> 870</span></a>        <span class="c1">#if len(tmp_stim.shape) == 2:</span>
</span><span id="MultiClouds-871"><a href="#MultiClouds-871"><span class="linenos"> 871</span></a>        <span class="c1">#    print( &quot;Time embed: reshaping stimulus -&gt;&quot;, self.stim_dims)</span>
</span><span id="MultiClouds-872"><a href="#MultiClouds-872"><span class="linenos"> 872</span></a>        <span class="c1">#    tmp_stim = tmp_stim.reshape([NT] + self.stim_dims)</span>
</span><span id="MultiClouds-873"><a href="#MultiClouds-873"><span class="linenos"> 873</span></a>
</span><span id="MultiClouds-874"><a href="#MultiClouds-874"><span class="linenos"> 874</span></a>        <span class="c1">#assert self.NT == NT, &quot;TIME EMBEDDING: stim length mismatch&quot;</span>
</span><span id="MultiClouds-875"><a href="#MultiClouds-875"><span class="linenos"> 875</span></a>
</span><span id="MultiClouds-876"><a href="#MultiClouds-876"><span class="linenos"> 876</span></a>        <span class="c1">#tmp_stim = tmp_stim[np.arange(NT)[:,None]-np.arange(nlags), :, :, :]</span>
</span><span id="MultiClouds-877"><a href="#MultiClouds-877"><span class="linenos"> 877</span></a>        <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nlags</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="MultiClouds-878"><a href="#MultiClouds-878"><span class="linenos"> 878</span></a>        <span class="c1">#if self.folded_lags:</span>
</span><span id="MultiClouds-879"><a href="#MultiClouds-879"><span class="linenos"> 879</span></a>        <span class="c1">#    #tmp_stim = np.transpose( tmp_stim, axes=[0,2,1,3,4] ) </span>
</span><span id="MultiClouds-880"><a href="#MultiClouds-880"><span class="linenos"> 880</span></a>        <span class="c1">#    tmp_stim = torch.permute( tmp_stim, (0,2,1,3,4) ) </span>
</span><span id="MultiClouds-881"><a href="#MultiClouds-881"><span class="linenos"> 881</span></a>        <span class="c1">#    print(&quot;Folded lags: stim-dim = &quot;, self.stim.shape)</span>
</span><span id="MultiClouds-882"><a href="#MultiClouds-882"><span class="linenos"> 882</span></a>        <span class="c1">#else:</span>
</span><span id="MultiClouds-883"><a href="#MultiClouds-883"><span class="linenos"> 883</span></a>        <span class="c1">#    #tmp_stim = np.transpose( tmp_stim, axes=[0,2,3,4,1] )</span>
</span><span id="MultiClouds-884"><a href="#MultiClouds-884"><span class="linenos"> 884</span></a>        <span class="c1">#    tmp_stim = torch.permute( tmp_stim, (0,2,3,4,1) )</span>
</span><span id="MultiClouds-885"><a href="#MultiClouds-885"><span class="linenos"> 885</span></a>        <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span> <span class="n">tmp_stim</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
</span><span id="MultiClouds-886"><a href="#MultiClouds-886"><span class="linenos"> 886</span></a>        <span class="k">return</span> <span class="n">tmp_stim</span>
</span><span id="MultiClouds-887"><a href="#MultiClouds-887"><span class="linenos"> 887</span></a>    <span class="c1"># END .time_embedding()</span>
</span><span id="MultiClouds-888"><a href="#MultiClouds-888"><span class="linenos"> 888</span></a>
</span><span id="MultiClouds-889"><a href="#MultiClouds-889"><span class="linenos"> 889</span></a>    <span class="nd">@staticmethod</span>
</span><span id="MultiClouds-890"><a href="#MultiClouds-890"><span class="linenos"> 890</span></a>    <span class="k">def</span> <span class="nf">rectangle_overlap_ranges</span><span class="p">(</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span> <span class="p">):</span>
</span><span id="MultiClouds-891"><a href="#MultiClouds-891"><span class="linenos"> 891</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-892"><a href="#MultiClouds-892"><span class="linenos"> 892</span></a><span class="sd">        Figures out ranges to write relevant overlap of B onto A</span>
</span><span id="MultiClouds-893"><a href="#MultiClouds-893"><span class="linenos"> 893</span></a><span class="sd">        All info is of form [x0, y0, x1, y1]</span>
</span><span id="MultiClouds-894"><a href="#MultiClouds-894"><span class="linenos"> 894</span></a><span class="sd">        </span>
</span><span id="MultiClouds-895"><a href="#MultiClouds-895"><span class="linenos"> 895</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds-896"><a href="#MultiClouds-896"><span class="linenos"> 896</span></a><span class="sd">            A (list): first rectangle</span>
</span><span id="MultiClouds-897"><a href="#MultiClouds-897"><span class="linenos"> 897</span></a><span class="sd">            B (list): second rectangle</span>
</span><span id="MultiClouds-898"><a href="#MultiClouds-898"><span class="linenos"> 898</span></a>
</span><span id="MultiClouds-899"><a href="#MultiClouds-899"><span class="linenos"> 899</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds-900"><a href="#MultiClouds-900"><span class="linenos"> 900</span></a><span class="sd">            dict: dictionary of ranges</span>
</span><span id="MultiClouds-901"><a href="#MultiClouds-901"><span class="linenos"> 901</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-902"><a href="#MultiClouds-902"><span class="linenos"> 902</span></a>
</span><span id="MultiClouds-903"><a href="#MultiClouds-903"><span class="linenos"> 903</span></a>        <span class="n">C</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds-904"><a href="#MultiClouds-904"><span class="linenos"> 904</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="MultiClouds-905"><a href="#MultiClouds-905"><span class="linenos"> 905</span></a>            <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span> 
</span><span id="MultiClouds-906"><a href="#MultiClouds-906"><span class="linenos"> 906</span></a>                <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds-907"><a href="#MultiClouds-907"><span class="linenos"> 907</span></a>                <span class="n">D</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="MultiClouds-908"><a href="#MultiClouds-908"><span class="linenos"> 908</span></a>                <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]:</span>
</span><span id="MultiClouds-909"><a href="#MultiClouds-909"><span class="linenos"> 909</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="MultiClouds-910"><a href="#MultiClouds-910"><span class="linenos"> 910</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> 
</span><span id="MultiClouds-911"><a href="#MultiClouds-911"><span class="linenos"> 911</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-912"><a href="#MultiClouds-912"><span class="linenos"> 912</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="MultiClouds-913"><a href="#MultiClouds-913"><span class="linenos"> 913</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="MultiClouds-914"><a href="#MultiClouds-914"><span class="linenos"> 914</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-915"><a href="#MultiClouds-915"><span class="linenos"> 915</span></a>                <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="MultiClouds-916"><a href="#MultiClouds-916"><span class="linenos"> 916</span></a>                <span class="n">D</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds-917"><a href="#MultiClouds-917"><span class="linenos"> 917</span></a>                <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]:</span>
</span><span id="MultiClouds-918"><a href="#MultiClouds-918"><span class="linenos"> 918</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="MultiClouds-919"><a href="#MultiClouds-919"><span class="linenos"> 919</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="MultiClouds-920"><a href="#MultiClouds-920"><span class="linenos"> 920</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-921"><a href="#MultiClouds-921"><span class="linenos"> 921</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="MultiClouds-922"><a href="#MultiClouds-922"><span class="linenos"> 922</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="MultiClouds-923"><a href="#MultiClouds-923"><span class="linenos"> 923</span></a>
</span><span id="MultiClouds-924"><a href="#MultiClouds-924"><span class="linenos"> 924</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="MultiClouds-925"><a href="#MultiClouds-925"><span class="linenos"> 925</span></a>            <span class="k">return</span> <span class="kc">None</span>  
</span><span id="MultiClouds-926"><a href="#MultiClouds-926"><span class="linenos"> 926</span></a>        <span class="n">ranges</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="MultiClouds-927"><a href="#MultiClouds-927"><span class="linenos"> 927</span></a>            <span class="s1">&#39;targetX&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="MultiClouds-928"><a href="#MultiClouds-928"><span class="linenos"> 928</span></a>            <span class="s1">&#39;targetY&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">C</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="MultiClouds-929"><a href="#MultiClouds-929"><span class="linenos"> 929</span></a>            <span class="s1">&#39;readX&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="MultiClouds-930"><a href="#MultiClouds-930"><span class="linenos"> 930</span></a>            <span class="s1">&#39;readY&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">D</span><span class="p">[</span><span class="mi">3</span><span class="p">])}</span>
</span><span id="MultiClouds-931"><a href="#MultiClouds-931"><span class="linenos"> 931</span></a>        <span class="k">return</span> <span class="n">ranges</span>
</span><span id="MultiClouds-932"><a href="#MultiClouds-932"><span class="linenos"> 932</span></a>    <span class="c1"># END STATIC.rectangle_overlap_ranges</span>
</span><span id="MultiClouds-933"><a href="#MultiClouds-933"><span class="linenos"> 933</span></a>
</span><span id="MultiClouds-934"><a href="#MultiClouds-934"><span class="linenos"> 934</span></a>    <span class="k">def</span> <span class="nf">crop_stim</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim0</span><span class="p">,</span> <span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="MultiClouds-935"><a href="#MultiClouds-935"><span class="linenos"> 935</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-936"><a href="#MultiClouds-936"><span class="linenos"> 936</span></a><span class="sd">        Crop existing (torch) stimulus and change relevant variables [x1, x2, y1, y2]</span>
</span><span id="MultiClouds-937"><a href="#MultiClouds-937"><span class="linenos"> 937</span></a><span class="sd">        </span>
</span><span id="MultiClouds-938"><a href="#MultiClouds-938"><span class="linenos"> 938</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds-939"><a href="#MultiClouds-939"><span class="linenos"> 939</span></a><span class="sd">            stim0 (np.array): stimulus to crop</span>
</span><span id="MultiClouds-940"><a href="#MultiClouds-940"><span class="linenos"> 940</span></a><span class="sd">            stim_crop (list): crop the stimulus</span>
</span><span id="MultiClouds-941"><a href="#MultiClouds-941"><span class="linenos"> 941</span></a>
</span><span id="MultiClouds-942"><a href="#MultiClouds-942"><span class="linenos"> 942</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds-943"><a href="#MultiClouds-943"><span class="linenos"> 943</span></a><span class="sd">            np.array: cropped stimulus</span>
</span><span id="MultiClouds-944"><a href="#MultiClouds-944"><span class="linenos"> 944</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-945"><a href="#MultiClouds-945"><span class="linenos"> 945</span></a>
</span><span id="MultiClouds-946"><a href="#MultiClouds-946"><span class="linenos"> 946</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_crop</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;stim_crop must be of form: [x1, x2, y1, y2]&quot;</span>
</span><span id="MultiClouds-947"><a href="#MultiClouds-947"><span class="linenos"> 947</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;STIM_CROP: Will only work for unflattened stimulus&quot;</span>
</span><span id="MultiClouds-948"><a href="#MultiClouds-948"><span class="linenos"> 948</span></a>        
</span><span id="MultiClouds-949"><a href="#MultiClouds-949"><span class="linenos"> 949</span></a>        <span class="c1">#stim_crop = np.array(stim_crop, dtype=np.int64) # make sure array</span>
</span><span id="MultiClouds-950"><a href="#MultiClouds-950"><span class="linenos"> 950</span></a>        <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stim_crop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stim_crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MultiClouds-951"><a href="#MultiClouds-951"><span class="linenos"> 951</span></a>        <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stim_crop</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">stim_crop</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MultiClouds-952"><a href="#MultiClouds-952"><span class="linenos"> 952</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="MultiClouds-953"><a href="#MultiClouds-953"><span class="linenos"> 953</span></a>            <span class="n">newstim</span> <span class="o">=</span> <span class="n">stim0</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">ys</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">xs</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="MultiClouds-954"><a href="#MultiClouds-954"><span class="linenos"> 954</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># then lagged -- need extra dim</span>
</span><span id="MultiClouds-955"><a href="#MultiClouds-955"><span class="linenos"> 955</span></a>            <span class="n">newstim</span> <span class="o">=</span> <span class="n">stim0</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">ys</span><span class="p">,</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="n">xs</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="MultiClouds-956"><a href="#MultiClouds-956"><span class="linenos"> 956</span></a>
</span><span id="MultiClouds-957"><a href="#MultiClouds-957"><span class="linenos"> 957</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  CROP: New stim size: </span><span class="si">%d</span><span class="s2"> x </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)))</span>
</span><span id="MultiClouds-958"><a href="#MultiClouds-958"><span class="linenos"> 958</span></a>        <span class="k">return</span> <span class="n">newstim</span>
</span><span id="MultiClouds-959"><a href="#MultiClouds-959"><span class="linenos"> 959</span></a>    <span class="c1"># END MultiClouds.crop_stim()</span>
</span><span id="MultiClouds-960"><a href="#MultiClouds-960"><span class="linenos"> 960</span></a>
</span><span id="MultiClouds-961"><a href="#MultiClouds-961"><span class="linenos"> 961</span></a><span class="c1">#    def augment_dfs( self, new_dfs, cells=None ):</span>
</span><span id="MultiClouds-962"><a href="#MultiClouds-962"><span class="linenos"> 962</span></a><span class="c1">#        &quot;&quot;&quot;Replaces data-filter for given cells. note that new_df should be np.ndarray&quot;&quot;&quot;</span>
</span><span id="MultiClouds-963"><a href="#MultiClouds-963"><span class="linenos"> 963</span></a><span class="c1">#        </span>
</span><span id="MultiClouds-964"><a href="#MultiClouds-964"><span class="linenos"> 964</span></a><span class="c1">#        NTdf, NCdf = new_dfs.shape </span>
</span><span id="MultiClouds-965"><a href="#MultiClouds-965"><span class="linenos"> 965</span></a><span class="c1">#        if cells is None:</span>
</span><span id="MultiClouds-966"><a href="#MultiClouds-966"><span class="linenos"> 966</span></a><span class="c1">#            assert NCdf == self.dfs.shape[1], &quot;new DF is wrong shape to replace DF for all cells.&quot;</span>
</span><span id="MultiClouds-967"><a href="#MultiClouds-967"><span class="linenos"> 967</span></a><span class="c1">#            cells = range(self.dfs.shape[1])</span>
</span><span id="MultiClouds-968"><a href="#MultiClouds-968"><span class="linenos"> 968</span></a><span class="c1">#        if self.NT &lt; NTdf:</span>
</span><span id="MultiClouds-969"><a href="#MultiClouds-969"><span class="linenos"> 969</span></a><span class="c1">#            self.dfs[:, cells] *= torch.tensor(new_dfs[:self.NT, :], dtype=torch.float32)</span>
</span><span id="MultiClouds-970"><a href="#MultiClouds-970"><span class="linenos"> 970</span></a><span class="c1">#        else:</span>
</span><span id="MultiClouds-971"><a href="#MultiClouds-971"><span class="linenos"> 971</span></a><span class="c1">#            if self.NT &gt; NTdf:</span>
</span><span id="MultiClouds-972"><a href="#MultiClouds-972"><span class="linenos"> 972</span></a><span class="c1">#                # Assume dfs are 0 after new valid region</span>
</span><span id="MultiClouds-973"><a href="#MultiClouds-973"><span class="linenos"> 973</span></a><span class="c1">#                print(&quot;Truncating valid region to new datafilter length&quot;, NTdf)</span>
</span><span id="MultiClouds-974"><a href="#MultiClouds-974"><span class="linenos"> 974</span></a><span class="c1">#                new_dfs = np.concatenate( </span>
</span><span id="MultiClouds-975"><a href="#MultiClouds-975"><span class="linenos"> 975</span></a><span class="c1">#                    (new_dfs, np.zeros([self.NT-NTdf, len(cells)], dtype=np.float32)), </span>
</span><span id="MultiClouds-976"><a href="#MultiClouds-976"><span class="linenos"> 976</span></a><span class="c1">#                    axis=0)</span>
</span><span id="MultiClouds-977"><a href="#MultiClouds-977"><span class="linenos"> 977</span></a><span class="c1">#            self.dfs[:, cells] *= torch.tensor(new_dfs, dtype=torch.float32)</span>
</span><span id="MultiClouds-978"><a href="#MultiClouds-978"><span class="linenos"> 978</span></a>        <span class="c1"># END ColorClouds.augment_dfs()</span>
</span><span id="MultiClouds-979"><a href="#MultiClouds-979"><span class="linenos"> 979</span></a>
</span><span id="MultiClouds-980"><a href="#MultiClouds-980"><span class="linenos"> 980</span></a>    <span class="k">def</span> <span class="nf">draw_stim_locations</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">expt_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_corner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">row_height</span><span class="o">=</span><span class="mf">5.0</span> <span class="p">):</span>
</span><span id="MultiClouds-981"><a href="#MultiClouds-981"><span class="linenos"> 981</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-982"><a href="#MultiClouds-982"><span class="linenos"> 982</span></a><span class="sd">        Draw stimulus locations for given experiment</span>
</span><span id="MultiClouds-983"><a href="#MultiClouds-983"><span class="linenos"> 983</span></a>
</span><span id="MultiClouds-984"><a href="#MultiClouds-984"><span class="linenos"> 984</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds-985"><a href="#MultiClouds-985"><span class="linenos"> 985</span></a><span class="sd">            expt_n (int): index of the experiment</span>
</span><span id="MultiClouds-986"><a href="#MultiClouds-986"><span class="linenos"> 986</span></a><span class="sd">            top_corner (list): top corner of the stimulus</span>
</span><span id="MultiClouds-987"><a href="#MultiClouds-987"><span class="linenos"> 987</span></a><span class="sd">            L (int): size of the stimulus</span>
</span><span id="MultiClouds-988"><a href="#MultiClouds-988"><span class="linenos"> 988</span></a><span class="sd">            row_height (float): height of the row</span>
</span><span id="MultiClouds-989"><a href="#MultiClouds-989"><span class="linenos"> 989</span></a>
</span><span id="MultiClouds-990"><a href="#MultiClouds-990"><span class="linenos"> 990</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds-991"><a href="#MultiClouds-991"><span class="linenos"> 991</span></a><span class="sd">            None</span>
</span><span id="MultiClouds-992"><a href="#MultiClouds-992"><span class="linenos"> 992</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-993"><a href="#MultiClouds-993"><span class="linenos"> 993</span></a>
</span><span id="MultiClouds-994"><a href="#MultiClouds-994"><span class="linenos"> 994</span></a>        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span id="MultiClouds-995"><a href="#MultiClouds-995"><span class="linenos"> 995</span></a>        <span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Rectangle</span>
</span><span id="MultiClouds-996"><a href="#MultiClouds-996"><span class="linenos"> 996</span></a>
</span><span id="MultiClouds-997"><a href="#MultiClouds-997"><span class="linenos"> 997</span></a>        <span class="n">lamlocs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stim_locsLP&#39;</span><span class="p">]</span>
</span><span id="MultiClouds-998"><a href="#MultiClouds-998"><span class="linenos"> 998</span></a>        <span class="n">ETlocs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stim_locsET&#39;</span><span class="p">]</span>
</span><span id="MultiClouds-999"><a href="#MultiClouds-999"><span class="linenos"> 999</span></a>        <span class="n">fixloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;fix_loc&#39;</span><span class="p">]</span>
</span><span id="MultiClouds-1000"><a href="#MultiClouds-1000"><span class="linenos">1000</span></a>        <span class="n">fixsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;fix_size&#39;</span><span class="p">]</span>
</span><span id="MultiClouds-1001"><a href="#MultiClouds-1001"><span class="linenos">1001</span></a>
</span><span id="MultiClouds-1002"><a href="#MultiClouds-1002"><span class="linenos">1002</span></a>        <span class="n">BUF</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="MultiClouds-1003"><a href="#MultiClouds-1003"><span class="linenos">1003</span></a>        <span class="k">if</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-1004"><a href="#MultiClouds-1004"><span class="linenos">1004</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">lamlocs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-1005"><a href="#MultiClouds-1005"><span class="linenos">1005</span></a>
</span><span id="MultiClouds-1006"><a href="#MultiClouds-1006"><span class="linenos">1006</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="MultiClouds-1007"><a href="#MultiClouds-1007"><span class="linenos">1007</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">row_height</span><span class="p">,</span> <span class="n">row_height</span><span class="p">)</span>
</span><span id="MultiClouds-1008"><a href="#MultiClouds-1008"><span class="linenos">1008</span></a>        <span class="n">nET</span> <span class="o">=</span> <span class="n">ETlocs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds-1009"><a href="#MultiClouds-1009"><span class="linenos">1009</span></a>        <span class="n">nLAM</span> <span class="o">=</span> <span class="n">lamlocs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds-1010"><a href="#MultiClouds-1010"><span class="linenos">1010</span></a>        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="MultiClouds-1011"><a href="#MultiClouds-1011"><span class="linenos">1011</span></a>        <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="MultiClouds-1012"><a href="#MultiClouds-1012"><span class="linenos">1012</span></a>        <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="MultiClouds-1013"><a href="#MultiClouds-1013"><span class="linenos">1013</span></a>        <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">3</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">3</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="MultiClouds-1014"><a href="#MultiClouds-1014"><span class="linenos">1014</span></a>        <span class="c1">#print(x0,x1,y0,y1)</span>
</span><span id="MultiClouds-1015"><a href="#MultiClouds-1015"><span class="linenos">1015</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nLAM</span><span class="p">):</span>
</span><span id="MultiClouds-1016"><a href="#MultiClouds-1016"><span class="linenos">1016</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
</span><span id="MultiClouds-1017"><a href="#MultiClouds-1017"><span class="linenos">1017</span></a>                <span class="n">Rectangle</span><span class="p">((</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">lamlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ii</span><span class="p">]),</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> 
</span><span id="MultiClouds-1018"><a href="#MultiClouds-1018"><span class="linenos">1018</span></a>                <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">))</span>
</span><span id="MultiClouds-1019"><a href="#MultiClouds-1019"><span class="linenos">1019</span></a>        <span class="n">clrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">]</span>
</span><span id="MultiClouds-1020"><a href="#MultiClouds-1020"><span class="linenos">1020</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nET</span><span class="p">):</span>
</span><span id="MultiClouds-1021"><a href="#MultiClouds-1021"><span class="linenos">1021</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ii</span><span class="p">],</span> <span class="n">ETlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="p">]),</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> 
</span><span id="MultiClouds-1022"><a href="#MultiClouds-1022"><span class="linenos">1022</span></a>                                <span class="n">edgecolor</span><span class="o">=</span><span class="n">clrs</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span><span id="MultiClouds-1023"><a href="#MultiClouds-1023"><span class="linenos">1023</span></a>        <span class="k">if</span> <span class="n">fixloc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-1024"><a href="#MultiClouds-1024"><span class="linenos">1024</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">fixloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">fixsize</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fixloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">fixsize</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">fixsize</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">fixsize</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="MultiClouds-1025"><a href="#MultiClouds-1025"><span class="linenos">1025</span></a>                                <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</span><span id="MultiClouds-1026"><a href="#MultiClouds-1026"><span class="linenos">1026</span></a>        <span class="k">if</span> <span class="n">top_corner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-1027"><a href="#MultiClouds-1027"><span class="linenos">1027</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">(</span><span class="n">top_corner</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> 
</span><span id="MultiClouds-1028"><a href="#MultiClouds-1028"><span class="linenos">1028</span></a>                                <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">))</span>
</span><span id="MultiClouds-1029"><a href="#MultiClouds-1029"><span class="linenos">1029</span></a>            
</span><span id="MultiClouds-1030"><a href="#MultiClouds-1030"><span class="linenos">1030</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>
</span><span id="MultiClouds-1031"><a href="#MultiClouds-1031"><span class="linenos">1031</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">x0</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span><span class="n">x1</span><span class="o">+</span><span class="n">BUF</span><span class="p">])</span>
</span><span id="MultiClouds-1032"><a href="#MultiClouds-1032"><span class="linenos">1032</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="n">y0</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span><span class="n">y1</span><span class="o">+</span><span class="n">BUF</span><span class="p">])</span>
</span><span id="MultiClouds-1033"><a href="#MultiClouds-1033"><span class="linenos">1033</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="MultiClouds-1034"><a href="#MultiClouds-1034"><span class="linenos">1034</span></a>    <span class="c1"># END .draw_stim_locations()</span>
</span><span id="MultiClouds-1035"><a href="#MultiClouds-1035"><span class="linenos">1035</span></a>    
</span><span id="MultiClouds-1036"><a href="#MultiClouds-1036"><span class="linenos">1036</span></a>    <span class="k">def</span> <span class="nf">avrates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="MultiClouds-1037"><a href="#MultiClouds-1037"><span class="linenos">1037</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-1038"><a href="#MultiClouds-1038"><span class="linenos">1038</span></a><span class="sd">        Calculates average firing probability across specified inds (or whole dataset)</span>
</span><span id="MultiClouds-1039"><a href="#MultiClouds-1039"><span class="linenos">1039</span></a><span class="sd">        -- Note will respect datafilters</span>
</span><span id="MultiClouds-1040"><a href="#MultiClouds-1040"><span class="linenos">1040</span></a><span class="sd">        -- will return precalc value to save time if already stored</span>
</span><span id="MultiClouds-1041"><a href="#MultiClouds-1041"><span class="linenos">1041</span></a>
</span><span id="MultiClouds-1042"><a href="#MultiClouds-1042"><span class="linenos">1042</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds-1043"><a href="#MultiClouds-1043"><span class="linenos">1043</span></a><span class="sd">            inds (list): indices to calculate across</span>
</span><span id="MultiClouds-1044"><a href="#MultiClouds-1044"><span class="linenos">1044</span></a>
</span><span id="MultiClouds-1045"><a href="#MultiClouds-1045"><span class="linenos">1045</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds-1046"><a href="#MultiClouds-1046"><span class="linenos">1046</span></a><span class="sd">            np.array: average firing rates</span>
</span><span id="MultiClouds-1047"><a href="#MultiClouds-1047"><span class="linenos">1047</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-1048"><a href="#MultiClouds-1048"><span class="linenos">1048</span></a>        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-1049"><a href="#MultiClouds-1049"><span class="linenos">1049</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="MultiClouds-1050"><a href="#MultiClouds-1050"><span class="linenos">1050</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="MultiClouds-1051"><a href="#MultiClouds-1051"><span class="linenos">1051</span></a>            <span class="c1"># then calculate across whole dataset</span>
</span><span id="MultiClouds-1052"><a href="#MultiClouds-1052"><span class="linenos">1052</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-1053"><a href="#MultiClouds-1053"><span class="linenos">1053</span></a>                <span class="c1"># then precalculated and do not need to do</span>
</span><span id="MultiClouds-1054"><a href="#MultiClouds-1054"><span class="linenos">1054</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span>
</span><span id="MultiClouds-1055"><a href="#MultiClouds-1055"><span class="linenos">1055</span></a>
</span><span id="MultiClouds-1056"><a href="#MultiClouds-1056"><span class="linenos">1056</span></a>        <span class="c1"># Otherwise calculate across all data</span>
</span><span id="MultiClouds-1057"><a href="#MultiClouds-1057"><span class="linenos">1057</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="MultiClouds-1058"><a href="#MultiClouds-1058"><span class="linenos">1058</span></a>            <span class="n">Reff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="MultiClouds-1059"><a href="#MultiClouds-1059"><span class="linenos">1059</span></a>            <span class="n">Teff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="MultiClouds-1060"><a href="#MultiClouds-1060"><span class="linenos">1060</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="o">/</span><span class="n">Teff</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="MultiClouds-1061"><a href="#MultiClouds-1061"><span class="linenos">1061</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-1062"><a href="#MultiClouds-1062"><span class="linenos">1062</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Still need to implement avRs without preloading&#39;</span><span class="p">)</span>
</span><span id="MultiClouds-1063"><a href="#MultiClouds-1063"><span class="linenos">1063</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="MultiClouds-1064"><a href="#MultiClouds-1064"><span class="linenos">1064</span></a>    <span class="c1"># END .avrates()</span>
</span><span id="MultiClouds-1065"><a href="#MultiClouds-1065"><span class="linenos">1065</span></a>
</span><span id="MultiClouds-1066"><a href="#MultiClouds-1066"><span class="linenos">1066</span></a>    <span class="c1">#def set_cells(self, **kwargs):</span>
</span><span id="MultiClouds-1067"><a href="#MultiClouds-1067"><span class="linenos">1067</span></a>    <span class="c1">#    raise( Exception(&#39;set_cells does not work with MultiClouds.&#39;) )</span>
</span><span id="MultiClouds-1068"><a href="#MultiClouds-1068"><span class="linenos">1068</span></a>    <span class="c1"># USE SENSORY-BASE -- should be set up now....</span>
</span><span id="MultiClouds-1069"><a href="#MultiClouds-1069"><span class="linenos">1069</span></a>
</span><span id="MultiClouds-1070"><a href="#MultiClouds-1070"><span class="linenos">1070</span></a>    <span class="k">def</span> <span class="nf">shift_stim_oldstyle</span><span class="p">(</span>
</span><span id="MultiClouds-1071"><a href="#MultiClouds-1071"><span class="linenos">1071</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pos_shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metric_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ts_thresh</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">fix_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MultiClouds-1072"><a href="#MultiClouds-1072"><span class="linenos">1072</span></a>        <span class="n">shift_times</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="MultiClouds-1073"><a href="#MultiClouds-1073"><span class="linenos">1073</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-1074"><a href="#MultiClouds-1074"><span class="linenos">1074</span></a><span class="sd">        Shift stimulus given standard shifting input (TBD)</span>
</span><span id="MultiClouds-1075"><a href="#MultiClouds-1075"><span class="linenos">1075</span></a><span class="sd">        use &#39;shift-times&#39; if given shifts correspond to range of times</span>
</span><span id="MultiClouds-1076"><a href="#MultiClouds-1076"><span class="linenos">1076</span></a><span class="sd">        </span>
</span><span id="MultiClouds-1077"><a href="#MultiClouds-1077"><span class="linenos">1077</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds-1078"><a href="#MultiClouds-1078"><span class="linenos">1078</span></a><span class="sd">            stim (np.array): stimulus to shift</span>
</span><span id="MultiClouds-1079"><a href="#MultiClouds-1079"><span class="linenos">1079</span></a><span class="sd">            pos_shifts (np.array): shifts to apply</span>
</span><span id="MultiClouds-1080"><a href="#MultiClouds-1080"><span class="linenos">1080</span></a><span class="sd">            metrics (np.array): metrics to apply</span>
</span><span id="MultiClouds-1081"><a href="#MultiClouds-1081"><span class="linenos">1081</span></a><span class="sd">            metric_threshold (float): metric threshold</span>
</span><span id="MultiClouds-1082"><a href="#MultiClouds-1082"><span class="linenos">1082</span></a><span class="sd">            ts_thresh (int): time threshold</span>
</span><span id="MultiClouds-1083"><a href="#MultiClouds-1083"><span class="linenos">1083</span></a><span class="sd">            fix_n (np.array): fixations</span>
</span><span id="MultiClouds-1084"><a href="#MultiClouds-1084"><span class="linenos">1084</span></a><span class="sd">            shift_times (np.array): times to shift</span>
</span><span id="MultiClouds-1085"><a href="#MultiClouds-1085"><span class="linenos">1085</span></a>
</span><span id="MultiClouds-1086"><a href="#MultiClouds-1086"><span class="linenos">1086</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds-1087"><a href="#MultiClouds-1087"><span class="linenos">1087</span></a><span class="sd">            np.array: shifted stimulus</span>
</span><span id="MultiClouds-1088"><a href="#MultiClouds-1088"><span class="linenos">1088</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-1089"><a href="#MultiClouds-1089"><span class="linenos">1089</span></a>        <span class="n">NX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds-1090"><a href="#MultiClouds-1090"><span class="linenos">1090</span></a>        <span class="n">nlags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="MultiClouds-1091"><a href="#MultiClouds-1091"><span class="linenos">1091</span></a>
</span><span id="MultiClouds-1092"><a href="#MultiClouds-1092"><span class="linenos">1092</span></a>        <span class="c1"># Check if has been time-lagged yet</span>
</span><span id="MultiClouds-1093"><a href="#MultiClouds-1093"><span class="linenos">1093</span></a>        <span class="k">if</span> <span class="n">stim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-1094"><a href="#MultiClouds-1094"><span class="linenos">1094</span></a>            <span class="n">stim0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span>
</span><span id="MultiClouds-1095"><a href="#MultiClouds-1095"><span class="linenos">1095</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-1096"><a href="#MultiClouds-1096"><span class="linenos">1096</span></a>            <span class="n">stim0</span> <span class="o">=</span> <span class="n">stim</span>
</span><span id="MultiClouds-1097"><a href="#MultiClouds-1097"><span class="linenos">1097</span></a>
</span><span id="MultiClouds-1098"><a href="#MultiClouds-1098"><span class="linenos">1098</span></a>        <span class="n">already_lagged</span><span class="o">=</span><span class="kc">False</span>
</span><span id="MultiClouds-1099"><a href="#MultiClouds-1099"><span class="linenos">1099</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="MultiClouds-1100"><a href="#MultiClouds-1100"><span class="linenos">1100</span></a>            <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="n">ND</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim0</span><span class="o">.</span><span class="n">shape</span>
</span><span id="MultiClouds-1101"><a href="#MultiClouds-1101"><span class="linenos">1101</span></a>            <span class="k">if</span> <span class="n">ND</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">NX</span><span class="o">*</span><span class="n">NX</span><span class="p">:</span>  <span class="c1"># then lags in stim</span>
</span><span id="MultiClouds-1102"><a href="#MultiClouds-1102"><span class="linenos">1102</span></a>                <span class="n">re_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-1103"><a href="#MultiClouds-1103"><span class="linenos">1103</span></a>                <span class="n">already_lagged</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="MultiClouds-1104"><a href="#MultiClouds-1104"><span class="linenos">1104</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-1105"><a href="#MultiClouds-1105"><span class="linenos">1105</span></a>                <span class="n">re_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
</span><span id="MultiClouds-1106"><a href="#MultiClouds-1106"><span class="linenos">1106</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-1107"><a href="#MultiClouds-1107"><span class="linenos">1107</span></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Stim be already shaped according shape, but seems not&quot;</span>
</span><span id="MultiClouds-1108"><a href="#MultiClouds-1108"><span class="linenos">1108</span></a>            <span class="n">re_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="MultiClouds-1109"><a href="#MultiClouds-1109"><span class="linenos">1109</span></a>
</span><span id="MultiClouds-1110"><a href="#MultiClouds-1110"><span class="linenos">1110</span></a>        <span class="k">if</span> <span class="n">fix_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-1111"><a href="#MultiClouds-1111"><span class="linenos">1111</span></a>            <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds-1112"><a href="#MultiClouds-1112"><span class="linenos">1112</span></a>
</span><span id="MultiClouds-1113"><a href="#MultiClouds-1113"><span class="linenos">1113</span></a>        <span class="c1"># Apply shift-times (subset)</span>
</span><span id="MultiClouds-1114"><a href="#MultiClouds-1114"><span class="linenos">1114</span></a>        <span class="k">if</span> <span class="n">shift_times</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-1115"><a href="#MultiClouds-1115"><span class="linenos">1115</span></a>            <span class="n">fix_n</span> <span class="o">=</span> <span class="n">fix_n</span><span class="p">[</span><span class="n">shift_times</span><span class="p">]</span>
</span><span id="MultiClouds-1116"><a href="#MultiClouds-1116"><span class="linenos">1116</span></a>            <span class="c1"># Find minimum fix_n and make = 1</span>
</span><span id="MultiClouds-1117"><a href="#MultiClouds-1117"><span class="linenos">1117</span></a>            <span class="n">min_fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fix_n</span><span class="p">[</span><span class="n">fix_n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="MultiClouds-1118"><a href="#MultiClouds-1118"><span class="linenos">1118</span></a>            <span class="c1">#print(&#39;min_fix_n&#39;, min_fix_n, &#39;adjust&#39;, 1-min_fix_n)</span>
</span><span id="MultiClouds-1119"><a href="#MultiClouds-1119"><span class="linenos">1119</span></a>            <span class="n">fix_n</span><span class="p">[</span><span class="n">fix_n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">-</span><span class="n">min_fix_n</span>
</span><span id="MultiClouds-1120"><a href="#MultiClouds-1120"><span class="linenos">1120</span></a>            <span class="n">re_stim</span> <span class="o">=</span> <span class="n">re_stim</span><span class="p">[</span><span class="n">shift_times</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-1121"><a href="#MultiClouds-1121"><span class="linenos">1121</span></a>            <span class="c1">#print(&#39;max fix&#39;, np.max(fix_n), fix_n.shape)</span>
</span><span id="MultiClouds-1122"><a href="#MultiClouds-1122"><span class="linenos">1122</span></a>        
</span><span id="MultiClouds-1123"><a href="#MultiClouds-1123"><span class="linenos">1123</span></a>        <span class="n">NF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fix_n</span><span class="p">)</span>
</span><span id="MultiClouds-1124"><a href="#MultiClouds-1124"><span class="linenos">1124</span></a>        <span class="n">NTtmp</span> <span class="o">=</span> <span class="n">re_stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-1125"><a href="#MultiClouds-1125"><span class="linenos">1125</span></a>        <span class="n">nclr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-1126"><a href="#MultiClouds-1126"><span class="linenos">1126</span></a>        <span class="c1">#sh0 = -(pos_shifts[:,0]-self.dims[1]//2)</span>
</span><span id="MultiClouds-1127"><a href="#MultiClouds-1127"><span class="linenos">1127</span></a>        <span class="c1">#sh1 = -(pos_shifts[:,1]-self.dims[2]//2)</span>
</span><span id="MultiClouds-1128"><a href="#MultiClouds-1128"><span class="linenos">1128</span></a>        <span class="n">sh0</span> <span class="o">=</span> <span class="n">pos_shifts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># this should be in units of pixels relative to 0</span>
</span><span id="MultiClouds-1129"><a href="#MultiClouds-1129"><span class="linenos">1129</span></a>        <span class="n">sh1</span> <span class="o">=</span> <span class="n">pos_shifts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds-1130"><a href="#MultiClouds-1130"><span class="linenos">1130</span></a>
</span><span id="MultiClouds-1131"><a href="#MultiClouds-1131"><span class="linenos">1131</span></a>        <span class="n">sp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">re_stim</span><span class="p">)</span>
</span><span id="MultiClouds-1132"><a href="#MultiClouds-1132"><span class="linenos">1132</span></a>        <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-1133"><a href="#MultiClouds-1133"><span class="linenos">1133</span></a>            <span class="n">val_fix</span> <span class="o">=</span> <span class="n">metrics</span> <span class="o">&gt;</span> <span class="n">metric_threshold</span>
</span><span id="MultiClouds-1134"><a href="#MultiClouds-1134"><span class="linenos">1134</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Applied metric threshold: </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">val_fix</span><span class="p">),</span> <span class="n">NF</span><span class="p">))</span>
</span><span id="MultiClouds-1135"><a href="#MultiClouds-1135"><span class="linenos">1135</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-1136"><a href="#MultiClouds-1136"><span class="linenos">1136</span></a>            <span class="n">val_fix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span><span class="o">*</span><span class="n">NF</span><span class="p">)</span>
</span><span id="MultiClouds-1137"><a href="#MultiClouds-1137"><span class="linenos">1137</span></a>
</span><span id="MultiClouds-1138"><a href="#MultiClouds-1138"><span class="linenos">1138</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NF</span><span class="p">):</span>
</span><span id="MultiClouds-1139"><a href="#MultiClouds-1139"><span class="linenos">1139</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fix_n</span> <span class="o">==</span> <span class="n">ff</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-1140"><a href="#MultiClouds-1140"><span class="linenos">1140</span></a>            <span class="c1">#print(ff, len(ts), ts[0], ts[-1])</span>
</span><span id="MultiClouds-1141"><a href="#MultiClouds-1141"><span class="linenos">1141</span></a>
</span><span id="MultiClouds-1142"><a href="#MultiClouds-1142"><span class="linenos">1142</span></a>            <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh0</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh1</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ts_thresh</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">val_fix</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">):</span>
</span><span id="MultiClouds-1143"><a href="#MultiClouds-1143"><span class="linenos">1143</span></a>                <span class="c1"># FIRST SP DIM shift</span>
</span><span id="MultiClouds-1144"><a href="#MultiClouds-1144"><span class="linenos">1144</span></a>                <span class="n">sh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sh0</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="MultiClouds-1145"><a href="#MultiClouds-1145"><span class="linenos">1145</span></a>                <span class="n">stim_seg</span> <span class="o">=</span> <span class="n">re_stim</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-1146"><a href="#MultiClouds-1146"><span class="linenos">1146</span></a>                <span class="k">if</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds-1147"><a href="#MultiClouds-1147"><span class="linenos">1147</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span> <span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds-1148"><a href="#MultiClouds-1148"><span class="linenos">1148</span></a>                    <span class="n">stim_tmp</span><span class="p">[:,</span> <span class="p">:,</span><span class="n">sh</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_seg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="o">-</span><span class="n">sh</span><span class="p">),</span> <span class="p">:])</span>
</span><span id="MultiClouds-1149"><a href="#MultiClouds-1149"><span class="linenos">1149</span></a>                <span class="k">elif</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds-1150"><a href="#MultiClouds-1150"><span class="linenos">1150</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span> <span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds-1151"><a href="#MultiClouds-1151"><span class="linenos">1151</span></a>                    <span class="n">stim_tmp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">sh</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_seg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">(</span><span class="o">-</span><span class="n">sh</span><span class="p">):,</span> <span class="p">:])</span>
</span><span id="MultiClouds-1152"><a href="#MultiClouds-1152"><span class="linenos">1152</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-1153"><a href="#MultiClouds-1153"><span class="linenos">1153</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_seg</span><span class="p">)</span>
</span><span id="MultiClouds-1154"><a href="#MultiClouds-1154"><span class="linenos">1154</span></a>
</span><span id="MultiClouds-1155"><a href="#MultiClouds-1155"><span class="linenos">1155</span></a>                <span class="c1"># SECOND SP DIM shift</span>
</span><span id="MultiClouds-1156"><a href="#MultiClouds-1156"><span class="linenos">1156</span></a>                <span class="n">sh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sh1</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="MultiClouds-1157"><a href="#MultiClouds-1157"><span class="linenos">1157</span></a>                <span class="k">if</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds-1158"><a href="#MultiClouds-1158"><span class="linenos">1158</span></a>                    <span class="n">stim_tmp2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds-1159"><a href="#MultiClouds-1159"><span class="linenos">1159</span></a>                    <span class="n">stim_tmp2</span><span class="p">[</span><span class="o">...</span> <span class="p">,</span> <span class="n">sh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:(</span><span class="o">-</span><span class="n">sh</span><span class="p">)])</span>
</span><span id="MultiClouds-1160"><a href="#MultiClouds-1160"><span class="linenos">1160</span></a>                <span class="k">elif</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds-1161"><a href="#MultiClouds-1161"><span class="linenos">1161</span></a>                    <span class="n">stim_tmp2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds-1162"><a href="#MultiClouds-1162"><span class="linenos">1162</span></a>                    <span class="n">stim_tmp2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">sh</span><span class="p">):])</span>
</span><span id="MultiClouds-1163"><a href="#MultiClouds-1163"><span class="linenos">1163</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-1164"><a href="#MultiClouds-1164"><span class="linenos">1164</span></a>                    <span class="n">stim_tmp2</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span>
</span><span id="MultiClouds-1165"><a href="#MultiClouds-1165"><span class="linenos">1165</span></a>                    
</span><span id="MultiClouds-1166"><a href="#MultiClouds-1166"><span class="linenos">1166</span></a>                <span class="n">sp_stim</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="o">...</span> <span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp2</span><span class="p">)</span>
</span><span id="MultiClouds-1167"><a href="#MultiClouds-1167"><span class="linenos">1167</span></a>
</span><span id="MultiClouds-1168"><a href="#MultiClouds-1168"><span class="linenos">1168</span></a>        <span class="k">if</span> <span class="n">already_lagged</span><span class="p">:</span>
</span><span id="MultiClouds-1169"><a href="#MultiClouds-1169"><span class="linenos">1169</span></a>            <span class="c1"># Time-embed</span>
</span><span id="MultiClouds-1170"><a href="#MultiClouds-1170"><span class="linenos">1170</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NTtmp</span><span class="p">)</span>
</span><span id="MultiClouds-1171"><a href="#MultiClouds-1171"><span class="linenos">1171</span></a>            <span class="n">laggedstim</span> <span class="o">=</span> <span class="n">sp_stim</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NTtmp</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nlags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-1172"><a href="#MultiClouds-1172"><span class="linenos">1172</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">laggedstim</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="MultiClouds-1173"><a href="#MultiClouds-1173"><span class="linenos">1173</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-1174"><a href="#MultiClouds-1174"><span class="linenos">1174</span></a>            <span class="k">return</span> <span class="n">sp_stim</span>
</span><span id="MultiClouds-1175"><a href="#MultiClouds-1175"><span class="linenos">1175</span></a>    <span class="c1"># END ColorCloud.shift_stim -- note outputs stim rather than overwrites</span>
</span><span id="MultiClouds-1176"><a href="#MultiClouds-1176"><span class="linenos">1176</span></a>
</span><span id="MultiClouds-1177"><a href="#MultiClouds-1177"><span class="linenos">1177</span></a>    <span class="k">def</span> <span class="nf">process_fixations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sacc_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expt_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
</span><span id="MultiClouds-1178"><a href="#MultiClouds-1178"><span class="linenos">1178</span></a>                          <span class="n">sacc_metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dur_thresh</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="MultiClouds-1179"><a href="#MultiClouds-1179"><span class="linenos">1179</span></a>                          <span class="n">modify_dfs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="MultiClouds-1180"><a href="#MultiClouds-1180"><span class="linenos">1180</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-1181"><a href="#MultiClouds-1181"><span class="linenos">1181</span></a><span class="sd">        Generates fix_n based on existing trial structure and imported fixations. Will only work for specified</span>
</span><span id="MultiClouds-1182"><a href="#MultiClouds-1182"><span class="linenos">1182</span></a><span class="sd">        experiment (expt_n variable) and assume timings are based on the beginning of that experiment.</span>
</span><span id="MultiClouds-1183"><a href="#MultiClouds-1183"><span class="linenos">1183</span></a><span class="sd">        Output: fix_n</span>
</span><span id="MultiClouds-1184"><a href="#MultiClouds-1184"><span class="linenos">1184</span></a>
</span><span id="MultiClouds-1185"><a href="#MultiClouds-1185"><span class="linenos">1185</span></a><span class="sd">        Default: modify_dfs=True will zero out data where there is no assigned fixation</span>
</span><span id="MultiClouds-1186"><a href="#MultiClouds-1186"><span class="linenos">1186</span></a><span class="sd">        </span>
</span><span id="MultiClouds-1187"><a href="#MultiClouds-1187"><span class="linenos">1187</span></a><span class="sd">        Note that this will assume that saccades correspond to relevant trange (e.g., binocular section) rather</span>
</span><span id="MultiClouds-1188"><a href="#MultiClouds-1188"><span class="linenos">1188</span></a><span class="sd">        than the whole experiment.</span>
</span><span id="MultiClouds-1189"><a href="#MultiClouds-1189"><span class="linenos">1189</span></a><span class="sd">        </span>
</span><span id="MultiClouds-1190"><a href="#MultiClouds-1190"><span class="linenos">1190</span></a><span class="sd">        Can also use metric criteria to only use fraction of total saccades: sacc_metrics can be amplitude, and </span>
</span><span id="MultiClouds-1191"><a href="#MultiClouds-1191"><span class="linenos">1191</span></a><span class="sd">        sacc_thresh be inclusion criteria (must be greater than sacc_thresh)</span>
</span><span id="MultiClouds-1192"><a href="#MultiClouds-1192"><span class="linenos">1192</span></a>
</span><span id="MultiClouds-1193"><a href="#MultiClouds-1193"><span class="linenos">1193</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds-1194"><a href="#MultiClouds-1194"><span class="linenos">1194</span></a><span class="sd">            sacc_in (np.array): saccade times</span>
</span><span id="MultiClouds-1195"><a href="#MultiClouds-1195"><span class="linenos">1195</span></a><span class="sd">            expt_n (int): index of the experiment</span>
</span><span id="MultiClouds-1196"><a href="#MultiClouds-1196"><span class="linenos">1196</span></a><span class="sd">            sacc_metrics (np.array): saccade metrics</span>
</span><span id="MultiClouds-1197"><a href="#MultiClouds-1197"><span class="linenos">1197</span></a><span class="sd">            thresh (float): threshold for saccade metrics</span>
</span><span id="MultiClouds-1198"><a href="#MultiClouds-1198"><span class="linenos">1198</span></a><span class="sd">            dur_thresh (int): duration threshold</span>
</span><span id="MultiClouds-1199"><a href="#MultiClouds-1199"><span class="linenos">1199</span></a><span class="sd">            modify_dfs (bool): modify dfs</span>
</span><span id="MultiClouds-1200"><a href="#MultiClouds-1200"><span class="linenos">1200</span></a>
</span><span id="MultiClouds-1201"><a href="#MultiClouds-1201"><span class="linenos">1201</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds-1202"><a href="#MultiClouds-1202"><span class="linenos">1202</span></a><span class="sd">            np.array: fixation numbers</span>
</span><span id="MultiClouds-1203"><a href="#MultiClouds-1203"><span class="linenos">1203</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-1204"><a href="#MultiClouds-1204"><span class="linenos">1204</span></a>
</span><span id="MultiClouds-1205"><a href="#MultiClouds-1205"><span class="linenos">1205</span></a>        <span class="k">assert</span> <span class="n">sacc_in</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to enter saccade times&quot;</span>
</span><span id="MultiClouds-1206"><a href="#MultiClouds-1206"><span class="linenos">1206</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">expt_n</span><span class="p">]</span>
</span><span id="MultiClouds-1207"><a href="#MultiClouds-1207"><span class="linenos">1207</span></a>        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sacc_in</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">NT</span><span class="p">,</span> <span class="s2">&quot;sacc list is too long&quot;</span>
</span><span id="MultiClouds-1208"><a href="#MultiClouds-1208"><span class="linenos">1208</span></a>        <span class="k">if</span> <span class="n">sacc_metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-1209"><a href="#MultiClouds-1209"><span class="linenos">1209</span></a>            <span class="n">sac_ts</span> <span class="o">=</span> <span class="n">sacc_in</span>
</span><span id="MultiClouds-1210"><a href="#MultiClouds-1210"><span class="linenos">1210</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-1211"><a href="#MultiClouds-1211"><span class="linenos">1211</span></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sacc_metrics</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">sacc_in</span><span class="p">),</span> <span class="s2">&quot;Saccade metrics must match length of sacc_in&quot;</span>
</span><span id="MultiClouds-1212"><a href="#MultiClouds-1212"><span class="linenos">1212</span></a>            <span class="n">sac_ts</span> <span class="o">=</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sacc_metrics</span> <span class="o">&gt;=</span> <span class="n">thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="MultiClouds-1213"><a href="#MultiClouds-1213"><span class="linenos">1213</span></a>        <span class="n">sacc_rate</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sac_ts</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">NT</span><span class="o">/</span><span class="mf">60.0</span><span class="p">)</span>
</span><span id="MultiClouds-1214"><a href="#MultiClouds-1214"><span class="linenos">1214</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Generating fix_n for expt </span><span class="si">%d</span><span class="s2"> with </span><span class="si">%d</span><span class="s2"> valid saccades (</span><span class="si">%0.2f</span><span class="s2"> Hz)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">expt_n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sac_ts</span><span class="p">),</span> <span class="n">sacc_rate</span><span class="p">)</span> <span class="p">)</span>
</span><span id="MultiClouds-1215"><a href="#MultiClouds-1215"><span class="linenos">1215</span></a>
</span><span id="MultiClouds-1216"><a href="#MultiClouds-1216"><span class="linenos">1216</span></a>        <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> 
</span><span id="MultiClouds-1217"><a href="#MultiClouds-1217"><span class="linenos">1217</span></a>        <span class="n">fix_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds-1218"><a href="#MultiClouds-1218"><span class="linenos">1218</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)):</span>
</span><span id="MultiClouds-1219"><a href="#MultiClouds-1219"><span class="linenos">1219</span></a>            <span class="c1">#if self.block_inds[ii][0] &lt; self.NT:</span>
</span><span id="MultiClouds-1220"><a href="#MultiClouds-1220"><span class="linenos">1220</span></a>            <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="MultiClouds-1221"><a href="#MultiClouds-1221"><span class="linenos">1221</span></a>            <span class="c1">#self.block_inds.append(np.arange( blk_inds[ii,0], blk_inds[ii,1], dtype=np.int64))</span>
</span><span id="MultiClouds-1222"><a href="#MultiClouds-1222"><span class="linenos">1222</span></a>
</span><span id="MultiClouds-1223"><a href="#MultiClouds-1223"><span class="linenos">1223</span></a>            <span class="c1"># Parse fixation numbers within block</span>
</span><span id="MultiClouds-1224"><a href="#MultiClouds-1224"><span class="linenos">1224</span></a>            <span class="n">rel_saccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">sac_ts</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sac_ts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">5</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-1225"><a href="#MultiClouds-1225"><span class="linenos">1225</span></a>
</span><span id="MultiClouds-1226"><a href="#MultiClouds-1226"><span class="linenos">1226</span></a>            <span class="n">tfix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Beginning of fixation by definition</span>
</span><span id="MultiClouds-1227"><a href="#MultiClouds-1227"><span class="linenos">1227</span></a>            <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel_saccs</span><span class="p">)):</span>
</span><span id="MultiClouds-1228"><a href="#MultiClouds-1228"><span class="linenos">1228</span></a>                <span class="k">if</span> <span class="n">sac_ts</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]]</span><span class="o">-</span><span class="n">tfix</span> <span class="o">&gt;=</span> <span class="n">dur_thresh</span><span class="p">:</span>
</span><span id="MultiClouds-1229"><a href="#MultiClouds-1229"><span class="linenos">1229</span></a>                    <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MultiClouds-1230"><a href="#MultiClouds-1230"><span class="linenos">1230</span></a>                    <span class="c1"># Range goes to beginning of next fixation (note no gap)</span>
</span><span id="MultiClouds-1231"><a href="#MultiClouds-1231"><span class="linenos">1231</span></a>                    <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="n">sac_ts</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="MultiClouds-1232"><a href="#MultiClouds-1232"><span class="linenos">1232</span></a>                <span class="n">tfix</span> <span class="o">=</span> <span class="n">sac_ts</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]]</span>
</span><span id="MultiClouds-1233"><a href="#MultiClouds-1233"><span class="linenos">1233</span></a>            <span class="c1"># Put in last (or only) fixation number</span>
</span><span id="MultiClouds-1234"><a href="#MultiClouds-1234"><span class="linenos">1234</span></a>            <span class="k">if</span> <span class="n">tfix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="MultiClouds-1235"><a href="#MultiClouds-1235"><span class="linenos">1235</span></a>                <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MultiClouds-1236"><a href="#MultiClouds-1236"><span class="linenos">1236</span></a>                <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="MultiClouds-1237"><a href="#MultiClouds-1237"><span class="linenos">1237</span></a>
</span><span id="MultiClouds-1238"><a href="#MultiClouds-1238"><span class="linenos">1238</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Created </span><span class="si">%d</span><span class="s2"> fixations&quot;</span><span class="o">%</span><span class="n">fix_count</span><span class="p">)</span>
</span><span id="MultiClouds-1239"><a href="#MultiClouds-1239"><span class="linenos">1239</span></a>
</span><span id="MultiClouds-1240"><a href="#MultiClouds-1240"><span class="linenos">1240</span></a>        <span class="k">if</span> <span class="n">modify_dfs</span><span class="p">:</span>
</span><span id="MultiClouds-1241"><a href="#MultiClouds-1241"><span class="linenos">1241</span></a>            <span class="n">invalid_fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fix_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-1242"><a href="#MultiClouds-1242"><span class="linenos">1242</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">invalid_fix_n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds-1243"><a href="#MultiClouds-1243"><span class="linenos">1243</span></a>            
</span><span id="MultiClouds-1244"><a href="#MultiClouds-1244"><span class="linenos">1244</span></a>        <span class="k">return</span> <span class="n">fix_n</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds-1245"><a href="#MultiClouds-1245"><span class="linenos">1245</span></a>    <span class="c1"># END: MultiClouds.process_fixations()</span>
</span><span id="MultiClouds-1246"><a href="#MultiClouds-1246"><span class="linenos">1246</span></a>
</span><span id="MultiClouds-1247"><a href="#MultiClouds-1247"><span class="linenos">1247</span></a>    <span class="nd">@staticmethod</span> 
</span><span id="MultiClouds-1248"><a href="#MultiClouds-1248"><span class="linenos">1248</span></a>    <span class="k">def</span> <span class="nf">shift_stim</span><span class="p">(</span> <span class="n">stim</span><span class="p">,</span> <span class="n">eyepos</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">5000</span><span class="p">):</span>
</span><span id="MultiClouds-1249"><a href="#MultiClouds-1249"><span class="linenos">1249</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-1250"><a href="#MultiClouds-1250"><span class="linenos">1250</span></a><span class="sd">        Shift stimulus based on eye position</span>
</span><span id="MultiClouds-1251"><a href="#MultiClouds-1251"><span class="linenos">1251</span></a>
</span><span id="MultiClouds-1252"><a href="#MultiClouds-1252"><span class="linenos">1252</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds-1253"><a href="#MultiClouds-1253"><span class="linenos">1253</span></a><span class="sd">            stim (np.array): stimulus to shift</span>
</span><span id="MultiClouds-1254"><a href="#MultiClouds-1254"><span class="linenos">1254</span></a><span class="sd">            eyepos (np.array): eye position</span>
</span><span id="MultiClouds-1255"><a href="#MultiClouds-1255"><span class="linenos">1255</span></a><span class="sd">            input_dims (list): input dimensions</span>
</span><span id="MultiClouds-1256"><a href="#MultiClouds-1256"><span class="linenos">1256</span></a><span class="sd">            batch_size (int): batch size</span>
</span><span id="MultiClouds-1257"><a href="#MultiClouds-1257"><span class="linenos">1257</span></a>
</span><span id="MultiClouds-1258"><a href="#MultiClouds-1258"><span class="linenos">1258</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds-1259"><a href="#MultiClouds-1259"><span class="linenos">1259</span></a><span class="sd">            np.array: shifted stimulus</span>
</span><span id="MultiClouds-1260"><a href="#MultiClouds-1260"><span class="linenos">1260</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-1261"><a href="#MultiClouds-1261"><span class="linenos">1261</span></a>        <span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
</span><span id="MultiClouds-1262"><a href="#MultiClouds-1262"><span class="linenos">1262</span></a>        <span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span><span id="MultiClouds-1263"><a href="#MultiClouds-1263"><span class="linenos">1263</span></a>
</span><span id="MultiClouds-1264"><a href="#MultiClouds-1264"><span class="linenos">1264</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="MultiClouds-1265"><a href="#MultiClouds-1265"><span class="linenos">1265</span></a>            <span class="k">assert</span> <span class="n">input_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;  SHIFT_STIM: stim must be unflatteded or input_dims passed in&quot;</span>
</span><span id="MultiClouds-1266"><a href="#MultiClouds-1266"><span class="linenos">1266</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">input_dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
</span><span id="MultiClouds-1267"><a href="#MultiClouds-1267"><span class="linenos">1267</span></a>            <span class="n">to_flatten</span><span class="o">=</span><span class="kc">True</span>
</span><span id="MultiClouds-1268"><a href="#MultiClouds-1268"><span class="linenos">1268</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-1269"><a href="#MultiClouds-1269"><span class="linenos">1269</span></a>            <span class="n">to_flatten</span><span class="o">=</span><span class="kc">False</span>
</span><span id="MultiClouds-1270"><a href="#MultiClouds-1270"><span class="linenos">1270</span></a>
</span><span id="MultiClouds-1271"><a href="#MultiClouds-1271"><span class="linenos">1271</span></a>        <span class="c1"># Determine scaling for translation</span>
</span><span id="MultiClouds-1272"><a href="#MultiClouds-1272"><span class="linenos">1272</span></a>        <span class="n">Lscale</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">/</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MultiClouds-1273"><a href="#MultiClouds-1273"><span class="linenos">1273</span></a>
</span><span id="MultiClouds-1274"><a href="#MultiClouds-1274"><span class="linenos">1274</span></a>        <span class="n">stim_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="MultiClouds-1275"><a href="#MultiClouds-1275"><span class="linenos">1275</span></a>            <span class="s1">&#39;ts&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>  <span class="c1"># keep track of indices for remapping</span>
</span><span id="MultiClouds-1276"><a href="#MultiClouds-1276"><span class="linenos">1276</span></a>            <span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
</span><span id="MultiClouds-1277"><a href="#MultiClouds-1277"><span class="linenos">1277</span></a>            <span class="s1">&#39;eyepos&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">eyepos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">*</span><span class="n">Lscale</span> <span class="p">}</span>
</span><span id="MultiClouds-1278"><a href="#MultiClouds-1278"><span class="linenos">1278</span></a>
</span><span id="MultiClouds-1279"><a href="#MultiClouds-1279"><span class="linenos">1279</span></a>        <span class="n">ds</span> <span class="o">=</span> <span class="n">GenericDataset</span><span class="p">(</span><span class="n">stim_data</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="MultiClouds-1280"><a href="#MultiClouds-1280"><span class="linenos">1280</span></a>        <span class="c1">#ds.covariates[&#39;stim&#39;] = ds.covariates[&#39;stim&#39;].flatten(start_dim=1)</span>
</span><span id="MultiClouds-1281"><a href="#MultiClouds-1281"><span class="linenos">1281</span></a>        <span class="n">dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="MultiClouds-1282"><a href="#MultiClouds-1282"><span class="linenos">1282</span></a>
</span><span id="MultiClouds-1283"><a href="#MultiClouds-1283"><span class="linenos">1283</span></a>        <span class="n">stimSH</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_data</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">])</span>
</span><span id="MultiClouds-1284"><a href="#MultiClouds-1284"><span class="linenos">1284</span></a>        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dl</span><span class="p">):</span>
</span><span id="MultiClouds-1285"><a href="#MultiClouds-1285"><span class="linenos">1285</span></a>            <span class="n">stimSH</span><span class="p">[</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">MultiClouds</span><span class="o">.</span><span class="n">shift_im</span><span class="p">(</span>
</span><span id="MultiClouds-1286"><a href="#MultiClouds-1286"><span class="linenos">1286</span></a>                <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;eyepos&#39;</span><span class="p">][:,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> 
</span><span id="MultiClouds-1287"><a href="#MultiClouds-1287"><span class="linenos">1287</span></a>                <span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
</span><span id="MultiClouds-1288"><a href="#MultiClouds-1288"><span class="linenos">1288</span></a>        
</span><span id="MultiClouds-1289"><a href="#MultiClouds-1289"><span class="linenos">1289</span></a>        <span class="k">if</span> <span class="n">to_flatten</span><span class="p">:</span>
</span><span id="MultiClouds-1290"><a href="#MultiClouds-1290"><span class="linenos">1290</span></a>            <span class="n">stimSH</span> <span class="o">=</span> <span class="n">stimSH</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">start_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MultiClouds-1291"><a href="#MultiClouds-1291"><span class="linenos">1291</span></a>        <span class="k">return</span> <span class="n">stimSH</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="MultiClouds-1292"><a href="#MultiClouds-1292"><span class="linenos">1292</span></a>    
</span><span id="MultiClouds-1293"><a href="#MultiClouds-1293"><span class="linenos">1293</span></a>    <span class="nd">@staticmethod</span>
</span><span id="MultiClouds-1294"><a href="#MultiClouds-1294"><span class="linenos">1294</span></a>    <span class="k">def</span> <span class="nf">shift_im</span><span class="p">(</span> <span class="n">stim</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="MultiClouds-1295"><a href="#MultiClouds-1295"><span class="linenos">1295</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-1296"><a href="#MultiClouds-1296"><span class="linenos">1296</span></a><span class="sd">        Primary function for shifting the intput stimulus</span>
</span><span id="MultiClouds-1297"><a href="#MultiClouds-1297"><span class="linenos">1297</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds-1298"><a href="#MultiClouds-1298"><span class="linenos">1298</span></a><span class="sd">            stim: [Batch x channels x height x width] (use Fold2d to fold lags if necessary)</span>
</span><span id="MultiClouds-1299"><a href="#MultiClouds-1299"><span class="linenos">1299</span></a><span class="sd">            shift: [Batch x 2] or [Batch x 4] if translation only or affine</span>
</span><span id="MultiClouds-1300"><a href="#MultiClouds-1300"><span class="linenos">1300</span></a><span class="sd">            affine: [Boolean] set to True if using affine transformation</span>
</span><span id="MultiClouds-1301"><a href="#MultiClouds-1301"><span class="linenos">1301</span></a><span class="sd">            mode: [str] &#39;bilinear&#39; (default) or &#39;nearest&#39;</span>
</span><span id="MultiClouds-1302"><a href="#MultiClouds-1302"><span class="linenos">1302</span></a><span class="sd">            batch_size: [int] if None, will use all data at once</span>
</span><span id="MultiClouds-1303"><a href="#MultiClouds-1303"><span class="linenos">1303</span></a><span class="sd">            NOTE: mode must be bilinear during fitting otherwise the gradients don&#39;t propogate well</span>
</span><span id="MultiClouds-1304"><a href="#MultiClouds-1304"><span class="linenos">1304</span></a>
</span><span id="MultiClouds-1305"><a href="#MultiClouds-1305"><span class="linenos">1305</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds-1306"><a href="#MultiClouds-1306"><span class="linenos">1306</span></a><span class="sd">            torch.tensor: shifted stimulus</span>
</span><span id="MultiClouds-1307"><a href="#MultiClouds-1307"><span class="linenos">1307</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-1308"><a href="#MultiClouds-1308"><span class="linenos">1308</span></a>        <span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
</span><span id="MultiClouds-1309"><a href="#MultiClouds-1309"><span class="linenos">1309</span></a>
</span><span id="MultiClouds-1310"><a href="#MultiClouds-1310"><span class="linenos">1310</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-1311"><a href="#MultiClouds-1311"><span class="linenos">1311</span></a>
</span><span id="MultiClouds-1312"><a href="#MultiClouds-1312"><span class="linenos">1312</span></a>        <span class="c1"># build affine transformation matrix size = [batch x 2 x 3]</span>
</span><span id="MultiClouds-1313"><a href="#MultiClouds-1313"><span class="linenos">1313</span></a>        <span class="n">affine_trans</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">stim</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">stim</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MultiClouds-1314"><a href="#MultiClouds-1314"><span class="linenos">1314</span></a>        
</span><span id="MultiClouds-1315"><a href="#MultiClouds-1315"><span class="linenos">1315</span></a>        <span class="k">if</span> <span class="n">affine</span><span class="p">:</span>
</span><span id="MultiClouds-1316"><a href="#MultiClouds-1316"><span class="linenos">1316</span></a>            <span class="c1"># fill in rotation and scaling</span>
</span><span id="MultiClouds-1317"><a href="#MultiClouds-1317"><span class="linenos">1317</span></a>            <span class="n">costheta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">shift</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">.5</span><span class="p">))</span>
</span><span id="MultiClouds-1318"><a href="#MultiClouds-1318"><span class="linenos">1318</span></a>            <span class="n">sintheta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">shift</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">.5</span><span class="p">))</span>
</span><span id="MultiClouds-1319"><a href="#MultiClouds-1319"><span class="linenos">1319</span></a>            
</span><span id="MultiClouds-1320"><a href="#MultiClouds-1320"><span class="linenos">1320</span></a>            <span class="n">scale</span> <span class="o">=</span> <span class="n">shift</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">1.0</span>
</span><span id="MultiClouds-1321"><a href="#MultiClouds-1321"><span class="linenos">1321</span></a>
</span><span id="MultiClouds-1322"><a href="#MultiClouds-1322"><span class="linenos">1322</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">costheta</span><span class="o">*</span><span class="n">scale</span>
</span><span id="MultiClouds-1323"><a href="#MultiClouds-1323"><span class="linenos">1323</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sintheta</span><span class="o">*</span><span class="n">scale</span>
</span><span id="MultiClouds-1324"><a href="#MultiClouds-1324"><span class="linenos">1324</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sintheta</span><span class="o">*</span><span class="n">scale</span>
</span><span id="MultiClouds-1325"><a href="#MultiClouds-1325"><span class="linenos">1325</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">costheta</span><span class="o">*</span><span class="n">scale</span>
</span><span id="MultiClouds-1326"><a href="#MultiClouds-1326"><span class="linenos">1326</span></a>
</span><span id="MultiClouds-1327"><a href="#MultiClouds-1327"><span class="linenos">1327</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-1328"><a href="#MultiClouds-1328"><span class="linenos">1328</span></a>            <span class="c1"># no rotation or scaling</span>
</span><span id="MultiClouds-1329"><a href="#MultiClouds-1329"><span class="linenos">1329</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MultiClouds-1330"><a href="#MultiClouds-1330"><span class="linenos">1330</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds-1331"><a href="#MultiClouds-1331"><span class="linenos">1331</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds-1332"><a href="#MultiClouds-1332"><span class="linenos">1332</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MultiClouds-1333"><a href="#MultiClouds-1333"><span class="linenos">1333</span></a>
</span><span id="MultiClouds-1334"><a href="#MultiClouds-1334"><span class="linenos">1334</span></a>        <span class="c1"># translation</span>
</span><span id="MultiClouds-1335"><a href="#MultiClouds-1335"><span class="linenos">1335</span></a>        <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-1336"><a href="#MultiClouds-1336"><span class="linenos">1336</span></a>        <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds-1337"><a href="#MultiClouds-1337"><span class="linenos">1337</span></a>
</span><span id="MultiClouds-1338"><a href="#MultiClouds-1338"><span class="linenos">1338</span></a>        <span class="n">grid</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">affine_grid</span><span class="p">(</span><span class="n">affine_trans</span><span class="p">,</span> <span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MultiClouds-1339"><a href="#MultiClouds-1339"><span class="linenos">1339</span></a>
</span><span id="MultiClouds-1340"><a href="#MultiClouds-1340"><span class="linenos">1340</span></a>        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MultiClouds-1341"><a href="#MultiClouds-1341"><span class="linenos">1341</span></a>    <span class="c1"># END shift_im</span>
</span><span id="MultiClouds-1342"><a href="#MultiClouds-1342"><span class="linenos">1342</span></a>
</span><span id="MultiClouds-1343"><a href="#MultiClouds-1343"><span class="linenos">1343</span></a>    <span class="k">def</span> <span class="nf">get_max_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpu_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nquad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mf">1.2</span><span class="p">):</span>
</span><span id="MultiClouds-1344"><a href="#MultiClouds-1344"><span class="linenos">1344</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-1345"><a href="#MultiClouds-1345"><span class="linenos">1345</span></a><span class="sd">        get the maximum number of samples that fit in memory -- for GLM/GQM x LBFGS</span>
</span><span id="MultiClouds-1346"><a href="#MultiClouds-1346"><span class="linenos">1346</span></a>
</span><span id="MultiClouds-1347"><a href="#MultiClouds-1347"><span class="linenos">1347</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds-1348"><a href="#MultiClouds-1348"><span class="linenos">1348</span></a><span class="sd">            gpu_n (int): GPU number</span>
</span><span id="MultiClouds-1349"><a href="#MultiClouds-1349"><span class="linenos">1349</span></a><span class="sd">            history_size (int): history size</span>
</span><span id="MultiClouds-1350"><a href="#MultiClouds-1350"><span class="linenos">1350</span></a><span class="sd">            nquad (int): number of quadrature points</span>
</span><span id="MultiClouds-1351"><a href="#MultiClouds-1351"><span class="linenos">1351</span></a><span class="sd">            num_cells (int): number of cells</span>
</span><span id="MultiClouds-1352"><a href="#MultiClouds-1352"><span class="linenos">1352</span></a><span class="sd">            buffer (float): buffer size</span>
</span><span id="MultiClouds-1353"><a href="#MultiClouds-1353"><span class="linenos">1353</span></a>
</span><span id="MultiClouds-1354"><a href="#MultiClouds-1354"><span class="linenos">1354</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds-1355"><a href="#MultiClouds-1355"><span class="linenos">1355</span></a><span class="sd">            int: maximum number of samples</span>
</span><span id="MultiClouds-1356"><a href="#MultiClouds-1356"><span class="linenos">1356</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-1357"><a href="#MultiClouds-1357"><span class="linenos">1357</span></a>        <span class="k">if</span> <span class="n">gpu_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds-1358"><a href="#MultiClouds-1358"><span class="linenos">1358</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
</span><span id="MultiClouds-1359"><a href="#MultiClouds-1359"><span class="linenos">1359</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-1360"><a href="#MultiClouds-1360"><span class="linenos">1360</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:1&#39;</span><span class="p">)</span>
</span><span id="MultiClouds-1361"><a href="#MultiClouds-1361"><span class="linenos">1361</span></a>
</span><span id="MultiClouds-1362"><a href="#MultiClouds-1362"><span class="linenos">1362</span></a>        <span class="k">if</span> <span class="n">num_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-1363"><a href="#MultiClouds-1363"><span class="linenos">1363</span></a>            <span class="n">num_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span>
</span><span id="MultiClouds-1364"><a href="#MultiClouds-1364"><span class="linenos">1364</span></a>        
</span><span id="MultiClouds-1365"><a href="#MultiClouds-1365"><span class="linenos">1365</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">total_memory</span>
</span><span id="MultiClouds-1366"><a href="#MultiClouds-1366"><span class="linenos">1366</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_reserved</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="MultiClouds-1367"><a href="#MultiClouds-1367"><span class="linenos">1367</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_allocated</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="MultiClouds-1368"><a href="#MultiClouds-1368"><span class="linenos">1368</span></a>        <span class="n">free</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">r</span><span class="p">)</span>
</span><span id="MultiClouds-1369"><a href="#MultiClouds-1369"><span class="linenos">1369</span></a>
</span><span id="MultiClouds-1370"><a href="#MultiClouds-1370"><span class="linenos">1370</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-1371"><a href="#MultiClouds-1371"><span class="linenos">1371</span></a>        <span class="n">mempersample</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span>
</span><span id="MultiClouds-1372"><a href="#MultiClouds-1372"><span class="linenos">1372</span></a>    
</span><span id="MultiClouds-1373"><a href="#MultiClouds-1373"><span class="linenos">1373</span></a>        <span class="n">mempercell</span> <span class="o">=</span> <span class="n">mempersample</span> <span class="o">*</span> <span class="p">(</span><span class="n">nquad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">history_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="MultiClouds-1374"><a href="#MultiClouds-1374"><span class="linenos">1374</span></a>        <span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">*</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span>
</span><span id="MultiClouds-1375"><a href="#MultiClouds-1375"><span class="linenos">1375</span></a>
</span><span id="MultiClouds-1376"><a href="#MultiClouds-1376"><span class="linenos">1376</span></a>        <span class="n">maxsamples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">free</span> <span class="o">-</span> <span class="n">mempercell</span><span class="o">*</span><span class="n">num_cells</span> <span class="o">-</span> <span class="n">buffer_bytes</span><span class="p">)</span> <span class="o">//</span> <span class="n">mempersample</span>
</span><span id="MultiClouds-1377"><a href="#MultiClouds-1377"><span class="linenos">1377</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# samples that can fit on device: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxsamples</span><span class="p">))</span>
</span><span id="MultiClouds-1378"><a href="#MultiClouds-1378"><span class="linenos">1378</span></a>        <span class="k">return</span> <span class="n">maxsamples</span>
</span><span id="MultiClouds-1379"><a href="#MultiClouds-1379"><span class="linenos">1379</span></a>    <span class="c1"># END .get_max_samples</span>
</span><span id="MultiClouds-1380"><a href="#MultiClouds-1380"><span class="linenos">1380</span></a>
</span><span id="MultiClouds-1381"><a href="#MultiClouds-1381"><span class="linenos">1381</span></a>        <span class="c1">### THIS IS NOT USED ANY MORE BUT STILL HAS SOME GOOD CODE INSIDE ###</span>
</span><span id="MultiClouds-1382"><a href="#MultiClouds-1382"><span class="linenos">1382</span></a>    <span class="k">def</span> <span class="nf">preload_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MultiClouds-1383"><a href="#MultiClouds-1383"><span class="linenos">1383</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds-1384"><a href="#MultiClouds-1384"><span class="linenos">1384</span></a><span class="sd">        Note this loads stimulus but does not time-embed</span>
</span><span id="MultiClouds-1385"><a href="#MultiClouds-1385"><span class="linenos">1385</span></a><span class="sd">        </span>
</span><span id="MultiClouds-1386"><a href="#MultiClouds-1386"><span class="linenos">1386</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds-1387"><a href="#MultiClouds-1387"><span class="linenos">1387</span></a><span class="sd">            None</span>
</span><span id="MultiClouds-1388"><a href="#MultiClouds-1388"><span class="linenos">1388</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds-1389"><a href="#MultiClouds-1389"><span class="linenos">1389</span></a>
</span><span id="MultiClouds-1390"><a href="#MultiClouds-1390"><span class="linenos">1390</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span><span id="MultiClouds-1391"><a href="#MultiClouds-1391"><span class="linenos">1391</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="MultiClouds-1392"><a href="#MultiClouds-1392"><span class="linenos">1392</span></a><span class="sd">        Pre-allocate memory for data</span>
</span><span id="MultiClouds-1393"><a href="#MultiClouds-1393"><span class="linenos">1393</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="MultiClouds-1394"><a href="#MultiClouds-1394"><span class="linenos">1394</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds-1395"><a href="#MultiClouds-1395"><span class="linenos">1395</span></a>        <span class="k">if</span> <span class="s1">&#39;stimET&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="MultiClouds-1396"><a href="#MultiClouds-1396"><span class="linenos">1396</span></a>            <span class="c1"># Check to see if 1-d or 2-d eye tracking</span>
</span><span id="MultiClouds-1397"><a href="#MultiClouds-1397"><span class="linenos">1397</span></a>            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:</span><span class="mi">100</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-1398"><a href="#MultiClouds-1398"><span class="linenos">1398</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="MultiClouds-1399"><a href="#MultiClouds-1399"><span class="linenos">1399</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ET stimulus is 1-d bars.&quot;</span><span class="p">)</span>
</span><span id="MultiClouds-1400"><a href="#MultiClouds-1400"><span class="linenos">1400</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds-1401"><a href="#MultiClouds-1401"><span class="linenos">1401</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-1402"><a href="#MultiClouds-1402"><span class="linenos">1402</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds-1403"><a href="#MultiClouds-1403"><span class="linenos">1403</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-1404"><a href="#MultiClouds-1404"><span class="linenos">1404</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MultiClouds-1405"><a href="#MultiClouds-1405"><span class="linenos">1405</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Missing ETstimulus&#39;</span><span class="p">)</span>
</span><span id="MultiClouds-1406"><a href="#MultiClouds-1406"><span class="linenos">1406</span></a>
</span><span id="MultiClouds-1407"><a href="#MultiClouds-1407"><span class="linenos">1407</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds-1408"><a href="#MultiClouds-1408"><span class="linenos">1408</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds-1409"><a href="#MultiClouds-1409"><span class="linenos">1409</span></a>        <span class="c1">#self.eyepos = np.zeros([NT, 2], dtype=np.float32)</span>
</span><span id="MultiClouds-1410"><a href="#MultiClouds-1410"><span class="linenos">1410</span></a>        <span class="c1">#self.frame_times = np.zeros([NT,1], dtype=np.float32)</span>
</span><span id="MultiClouds-1411"><a href="#MultiClouds-1411"><span class="linenos">1411</span></a>
</span><span id="MultiClouds-1412"><a href="#MultiClouds-1412"><span class="linenos">1412</span></a>        <span class="n">t_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds-1413"><a href="#MultiClouds-1413"><span class="linenos">1413</span></a>        <span class="n">unit_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds-1414"><a href="#MultiClouds-1414"><span class="linenos">1414</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">)):</span>
</span><span id="MultiClouds-1415"><a href="#MultiClouds-1415"><span class="linenos">1415</span></a>            
</span><span id="MultiClouds-1416"><a href="#MultiClouds-1416"><span class="linenos">1416</span></a>            <span class="n">fhandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="MultiClouds-1417"><a href="#MultiClouds-1417"><span class="linenos">1417</span></a>            <span class="n">sz</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="MultiClouds-1418"><a href="#MultiClouds-1418"><span class="linenos">1418</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_counter</span><span class="p">,</span> <span class="n">t_counter</span><span class="o">+</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds-1419"><a href="#MultiClouds-1419"><span class="linenos">1419</span></a>            <span class="c1">#inds = self.stim_indices[expt][stim][&#39;inds&#39;]</span>
</span><span id="MultiClouds-1420"><a href="#MultiClouds-1420"><span class="linenos">1420</span></a>            <span class="c1">#self.stim[inds, ...] = np.transpose( np.array(fhandle[self.stimname], dtype=np.float32), axes=[0,3,1,2])</span>
</span><span id="MultiClouds-1421"><a href="#MultiClouds-1421"><span class="linenos">1421</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="MultiClouds-1422"><a href="#MultiClouds-1422"><span class="linenos">1422</span></a>                <span class="n">Leye</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="MultiClouds-1423"><a href="#MultiClouds-1423"><span class="linenos">1423</span></a>                <span class="n">Reye</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds-1424"><a href="#MultiClouds-1424"><span class="linenos">1424</span></a>                <span class="c1">#Leye = inds[np.where(self.LRpresent[inds] != 2)[0]]</span>
</span><span id="MultiClouds-1425"><a href="#MultiClouds-1425"><span class="linenos">1425</span></a>                <span class="c1">#Reye = inds[np.where(self.LRpresent[inds] != 1)[0]]</span>
</span><span id="MultiClouds-1426"><a href="#MultiClouds-1426"><span class="linenos">1426</span></a>                <span class="c1">#print(len(Leye), len(Reye))</span>
</span><span id="MultiClouds-1427"><a href="#MultiClouds-1427"><span class="linenos">1427</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="MultiClouds-1428"><a href="#MultiClouds-1428"><span class="linenos">1428</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-1429"><a href="#MultiClouds-1429"><span class="linenos">1429</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-1430"><a href="#MultiClouds-1430"><span class="linenos">1430</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-1431"><a href="#MultiClouds-1431"><span class="linenos">1431</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-1432"><a href="#MultiClouds-1432"><span class="linenos">1432</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-1433"><a href="#MultiClouds-1433"><span class="linenos">1433</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-1434"><a href="#MultiClouds-1434"><span class="linenos">1434</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="MultiClouds-1435"><a href="#MultiClouds-1435"><span class="linenos">1435</span></a>                    <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-1436"><a href="#MultiClouds-1436"><span class="linenos">1436</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="MultiClouds-1437"><a href="#MultiClouds-1437"><span class="linenos">1437</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="MultiClouds-1438"><a href="#MultiClouds-1438"><span class="linenos">1438</span></a>                    <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-1439"><a href="#MultiClouds-1439"><span class="linenos">1439</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="MultiClouds-1440"><a href="#MultiClouds-1440"><span class="linenos">1440</span></a>
</span><span id="MultiClouds-1441"><a href="#MultiClouds-1441"><span class="linenos">1441</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-1442"><a href="#MultiClouds-1442"><span class="linenos">1442</span></a>                        <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="MultiClouds-1443"><a href="#MultiClouds-1443"><span class="linenos">1443</span></a>                        <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-1444"><a href="#MultiClouds-1444"><span class="linenos">1444</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="MultiClouds-1445"><a href="#MultiClouds-1445"><span class="linenos">1445</span></a>                        <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="MultiClouds-1446"><a href="#MultiClouds-1446"><span class="linenos">1446</span></a>                        <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-1447"><a href="#MultiClouds-1447"><span class="linenos">1447</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="MultiClouds-1448"><a href="#MultiClouds-1448"><span class="linenos">1448</span></a>                        <span class="c1">#self.stimET[Leye, np.arange(3), ...] = np.array(fhandle[&#39;stimET&#39;], dtype=np.float32)[Leye, ...]</span>
</span><span id="MultiClouds-1449"><a href="#MultiClouds-1449"><span class="linenos">1449</span></a>                        <span class="c1">#self.stimET[Reye, np.arange(3,6), ...] = np.array(fhandle[&#39;stimET&#39;], dtype=np.float32)[Reye, ...]</span>
</span><span id="MultiClouds-1450"><a href="#MultiClouds-1450"><span class="linenos">1450</span></a>                        
</span><span id="MultiClouds-1451"><a href="#MultiClouds-1451"><span class="linenos">1451</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Monocular</span>
</span><span id="MultiClouds-1452"><a href="#MultiClouds-1452"><span class="linenos">1452</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="MultiClouds-1453"><a href="#MultiClouds-1453"><span class="linenos">1453</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-1454"><a href="#MultiClouds-1454"><span class="linenos">1454</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-1455"><a href="#MultiClouds-1455"><span class="linenos">1455</span></a>                        <span class="c1">#print(np.array(fhandle[&#39;stimET&#39;], dtype=np.float32).shape, self.stimET[inds, 0, ...].shape)</span>
</span><span id="MultiClouds-1456"><a href="#MultiClouds-1456"><span class="linenos">1456</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds-1457"><a href="#MultiClouds-1457"><span class="linenos">1457</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-1458"><a href="#MultiClouds-1458"><span class="linenos">1458</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds-1459"><a href="#MultiClouds-1459"><span class="linenos">1459</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-1460"><a href="#MultiClouds-1460"><span class="linenos">1460</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds-1461"><a href="#MultiClouds-1461"><span class="linenos">1461</span></a>
</span><span id="MultiClouds-1462"><a href="#MultiClouds-1462"><span class="linenos">1462</span></a>            <span class="n">t_counter</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds-1463"><a href="#MultiClouds-1463"><span class="linenos">1463</span></a>            <span class="n">unit_counter</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="MultiClouds-1464"><a href="#MultiClouds-1464"><span class="linenos">1464</span></a>
</span><span id="MultiClouds-1465"><a href="#MultiClouds-1465"><span class="linenos">1465</span></a>        <span class="c1"># Adjust stimulus since stored as ints</span>
</span><span id="MultiClouds-1466"><a href="#MultiClouds-1466"><span class="linenos">1466</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span> 
</span><span id="MultiClouds-1467"><a href="#MultiClouds-1467"><span class="linenos">1467</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
</span><span id="MultiClouds-1468"><a href="#MultiClouds-1468"><span class="linenos">1468</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">127</span>
</span><span id="MultiClouds-1469"><a href="#MultiClouds-1469"><span class="linenos">1469</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-1470"><a href="#MultiClouds-1470"><span class="linenos">1470</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">127</span>
</span><span id="MultiClouds-1471"><a href="#MultiClouds-1471"><span class="linenos">1471</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">128</span>
</span><span id="MultiClouds-1472"><a href="#MultiClouds-1472"><span class="linenos">1472</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-1473"><a href="#MultiClouds-1473"><span class="linenos">1473</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">128</span>
</span><span id="MultiClouds-1474"><a href="#MultiClouds-1474"><span class="linenos">1474</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Adjusting stimulus read from disk: mean | std = </span><span class="si">%0.3f</span><span class="s2"> | </span><span class="si">%0.3f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">)))</span>
</span><span id="MultiClouds-1475"><a href="#MultiClouds-1475"><span class="linenos">1475</span></a>    <span class="c1"># END .preload_numpy()</span>
</span><span id="MultiClouds-1476"><a href="#MultiClouds-1476"><span class="linenos">1476</span></a>
</span><span id="MultiClouds-1477"><a href="#MultiClouds-1477"><span class="linenos">1477</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="MultiClouds-1478"><a href="#MultiClouds-1478"><span class="linenos">1478</span></a>
</span><span id="MultiClouds-1479"><a href="#MultiClouds-1479"><span class="linenos">1479</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Have to specify stimulus before pulling data.&quot;</span>
</span><span id="MultiClouds-1480"><a href="#MultiClouds-1480"><span class="linenos">1480</span></a>        <span class="c1">#if isinstance(idx, np.ndarray):</span>
</span><span id="MultiClouds-1481"><a href="#MultiClouds-1481"><span class="linenos">1481</span></a>        <span class="c1">#    idx = list(idx)</span>
</span><span id="MultiClouds-1482"><a href="#MultiClouds-1482"><span class="linenos">1482</span></a>        <span class="c1"># Convert trials to indices if trial-sample</span>
</span><span id="MultiClouds-1483"><a href="#MultiClouds-1483"><span class="linenos">1483</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_sample</span><span class="p">:</span>
</span><span id="MultiClouds-1484"><a href="#MultiClouds-1484"><span class="linenos">1484</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_to_array</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">))</span>
</span><span id="MultiClouds-1485"><a href="#MultiClouds-1485"><span class="linenos">1485</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="MultiClouds-1486"><a href="#MultiClouds-1486"><span class="linenos">1486</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span id="MultiClouds-1487"><a href="#MultiClouds-1487"><span class="linenos">1487</span></a>                <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
</span><span id="MultiClouds-1488"><a href="#MultiClouds-1488"><span class="linenos">1488</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">ts</span>
</span><span id="MultiClouds-1489"><a href="#MultiClouds-1489"><span class="linenos">1489</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-1490"><a href="#MultiClouds-1490"><span class="linenos">1490</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_to_array</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="MultiClouds-1491"><a href="#MultiClouds-1491"><span class="linenos">1491</span></a>
</span><span id="MultiClouds-1492"><a href="#MultiClouds-1492"><span class="linenos">1492</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MultiClouds-1493"><a href="#MultiClouds-1493"><span class="linenos">1493</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;get_item time embedding not implemented yet&quot;</span><span class="p">)</span>
</span><span id="MultiClouds-1494"><a href="#MultiClouds-1494"><span class="linenos">1494</span></a>                
</span><span id="MultiClouds-1495"><a href="#MultiClouds-1495"><span class="linenos">1495</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds-1496"><a href="#MultiClouds-1496"><span class="linenos">1496</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">/</span><span class="mi">128</span><span class="p">,</span>
</span><span id="MultiClouds-1497"><a href="#MultiClouds-1497"><span class="linenos">1497</span></a>                   <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
</span><span id="MultiClouds-1498"><a href="#MultiClouds-1498"><span class="linenos">1498</span></a>                   <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)}</span>
</span><span id="MultiClouds-1499"><a href="#MultiClouds-1499"><span class="linenos">1499</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-1500"><a href="#MultiClouds-1500"><span class="linenos">1500</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-1501"><a href="#MultiClouds-1501"><span class="linenos">1501</span></a>                <span class="n">robs_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs_out</span>
</span><span id="MultiClouds-1502"><a href="#MultiClouds-1502"><span class="linenos">1502</span></a>                <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs_out</span>
</span><span id="MultiClouds-1503"><a href="#MultiClouds-1503"><span class="linenos">1503</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-1504"><a href="#MultiClouds-1504"><span class="linenos">1504</span></a>                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s1">&#39;cells_out must be a list&#39;</span>
</span><span id="MultiClouds-1505"><a href="#MultiClouds-1505"><span class="linenos">1505</span></a>                <span class="n">robs_tmp</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="MultiClouds-1506"><a href="#MultiClouds-1506"><span class="linenos">1506</span></a>                <span class="n">dfs_tmp</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="MultiClouds-1507"><a href="#MultiClouds-1507"><span class="linenos">1507</span></a>
</span><span id="MultiClouds-1508"><a href="#MultiClouds-1508"><span class="linenos">1508</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">/</span><span class="mi">128</span><span class="p">,</span>
</span><span id="MultiClouds-1509"><a href="#MultiClouds-1509"><span class="linenos">1509</span></a>                   <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">robs_tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
</span><span id="MultiClouds-1510"><a href="#MultiClouds-1510"><span class="linenos">1510</span></a>                   <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dfs_tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)}</span>
</span><span id="MultiClouds-1511"><a href="#MultiClouds-1511"><span class="linenos">1511</span></a>            <span class="c1"># FIXME: we are not using fix_n at the moment</span>
</span><span id="MultiClouds-1512"><a href="#MultiClouds-1512"><span class="linenos">1512</span></a>            <span class="c1"># if len(self.fix_n) &gt; 0:</span>
</span><span id="MultiClouds-1513"><a href="#MultiClouds-1513"><span class="linenos">1513</span></a>            <span class="c1">#     out[&#39;fix_n&#39;] = self.fix_n[idx]</span>
</span><span id="MultiClouds-1514"><a href="#MultiClouds-1514"><span class="linenos">1514</span></a>
</span><span id="MultiClouds-1515"><a href="#MultiClouds-1515"><span class="linenos">1515</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speckled</span><span class="p">:</span>
</span><span id="MultiClouds-1516"><a href="#MultiClouds-1516"><span class="linenos">1516</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-1517"><a href="#MultiClouds-1517"><span class="linenos">1517</span></a>                <span class="n">M1tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mval</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="MultiClouds-1518"><a href="#MultiClouds-1518"><span class="linenos">1518</span></a>                <span class="n">M2tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="MultiClouds-1519"><a href="#MultiClouds-1519"><span class="linenos">1519</span></a>                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Mval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M1tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="MultiClouds-1520"><a href="#MultiClouds-1520"><span class="linenos">1520</span></a>                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Mtrn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M2tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="MultiClouds-1521"><a href="#MultiClouds-1521"><span class="linenos">1521</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds-1522"><a href="#MultiClouds-1522"><span class="linenos">1522</span></a>                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Mval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="MultiClouds-1523"><a href="#MultiClouds-1523"><span class="linenos">1523</span></a>                <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Mtrn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="MultiClouds-1524"><a href="#MultiClouds-1524"><span class="linenos">1524</span></a>
</span><span id="MultiClouds-1525"><a href="#MultiClouds-1525"><span class="linenos">1525</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_separate_eye_stim</span><span class="p">:</span>
</span><span id="MultiClouds-1526"><a href="#MultiClouds-1526"><span class="linenos">1526</span></a>            <span class="c1"># Overwrite left stim with left eye only</span>
</span><span id="MultiClouds-1527"><a href="#MultiClouds-1527"><span class="linenos">1527</span></a>            <span class="n">tmp_dims</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span>
</span><span id="MultiClouds-1528"><a href="#MultiClouds-1528"><span class="linenos">1528</span></a>            <span class="n">stim_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tmp_dims</span><span class="p">])</span>
</span><span id="MultiClouds-1529"><a href="#MultiClouds-1529"><span class="linenos">1529</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim_tmp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="MultiClouds-1530"><a href="#MultiClouds-1530"><span class="linenos">1530</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;stimR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim_tmp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>            
</span><span id="MultiClouds-1531"><a href="#MultiClouds-1531"><span class="linenos">1531</span></a>
</span><span id="MultiClouds-1532"><a href="#MultiClouds-1532"><span class="linenos">1532</span></a>        <span class="c1"># Addition whether-or-not preloaded</span>
</span><span id="MultiClouds-1533"><a href="#MultiClouds-1533"><span class="linenos">1533</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds-1534"><a href="#MultiClouds-1534"><span class="linenos">1534</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Xdrift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MultiClouds-1535"><a href="#MultiClouds-1535"><span class="linenos">1535</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="MultiClouds-1536"><a href="#MultiClouds-1536"><span class="linenos">1536</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;binocular&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="MultiClouds-1537"><a href="#MultiClouds-1537"><span class="linenos">1537</span></a>            
</span><span id="MultiClouds-1538"><a href="#MultiClouds-1538"><span class="linenos">1538</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds-1539"><a href="#MultiClouds-1539"><span class="linenos">1539</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">append_covariates</span><span class="p">(</span> <span class="n">out</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span><span id="MultiClouds-1540"><a href="#MultiClouds-1540"><span class="linenos">1540</span></a>     
</span><span id="MultiClouds-1541"><a href="#MultiClouds-1541"><span class="linenos">1541</span></a>        <span class="k">return</span> <span class="n">out</span>
</span><span id="MultiClouds-1542"><a href="#MultiClouds-1542"><span class="linenos">1542</span></a>    <span class="c1"># END: MultiCloud.__get_item__</span>
</span><span id="MultiClouds-1543"><a href="#MultiClouds-1543"><span class="linenos">1543</span></a>
</span><span id="MultiClouds-1544"><a href="#MultiClouds-1544"><span class="linenos">1544</span></a>    <span class="c1">#@property</span>
</span><span id="MultiClouds-1545"><a href="#MultiClouds-1545"><span class="linenos">1545</span></a>    <span class="c1">#def NT(self):</span>
</span><span id="MultiClouds-1546"><a href="#MultiClouds-1546"><span class="linenos">1546</span></a>    <span class="c1">#    return len(self.used_inds)</span>
</span><span id="MultiClouds-1547"><a href="#MultiClouds-1547"><span class="linenos">1547</span></a>
</span><span id="MultiClouds-1548"><a href="#MultiClouds-1548"><span class="linenos">1548</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MultiClouds-1549"><a href="#MultiClouds-1549"><span class="linenos">1549</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>-- can load batches from multiple datasets
-- hdf5 files must have the following information:
    Robs
    RobsMU
    stim: 4-d stimulus: time x nx x ny x color
    block_inds: start and stop of 'trials' (perhaps fixations for now)
    other things: saccades? or should that be in trials? </p>

<p>Constructor will take eye position, which for now is an input from data
generated in the session (not on disk). It should have the length size 
of the total number of fixations x1.</p>

<p>Input arguments (details):
    stim_crop = None, should be of form [x1, x2, y1, y2] where each number is the 
        extreme point to be include as an index, e.g. range(x1, x2+1), ...</p>
</div>


                            <div id="MultiClouds.__init__" class="classattr">
                                        <input id="MultiClouds.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">MultiClouds</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">filenames</span>,</span><span class="param">	<span class="n">datadir</span>,</span><span class="param">	<span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span>,</span><span class="param">	<span class="n">include_MUs</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">drift_interval</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">trial_sample</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">luminance_only</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">LMS</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">binocular</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">eye_config</span><span class="o">=</span><span class="mi">3</span>,</span><span class="param">	<span class="n">eye_contiguous</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">cell_lists</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span></span>)</span>

                <label class="view-source-button" for="MultiClouds.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.__init__-37"><a href="#MultiClouds.__init__-37"><span class="linenos"> 37</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="MultiClouds.__init__-38"><a href="#MultiClouds.__init__-38"><span class="linenos"> 38</span></a>        <span class="n">filenames</span><span class="p">,</span>
</span><span id="MultiClouds.__init__-39"><a href="#MultiClouds.__init__-39"><span class="linenos"> 39</span></a>        <span class="n">datadir</span><span class="p">,</span> 
</span><span id="MultiClouds.__init__-40"><a href="#MultiClouds.__init__-40"><span class="linenos"> 40</span></a>        <span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
</span><span id="MultiClouds.__init__-41"><a href="#MultiClouds.__init__-41"><span class="linenos"> 41</span></a>        <span class="n">include_MUs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="MultiClouds.__init__-42"><a href="#MultiClouds.__init__-42"><span class="linenos"> 42</span></a>        <span class="n">drift_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MultiClouds.__init__-43"><a href="#MultiClouds.__init__-43"><span class="linenos"> 43</span></a>        <span class="n">trial_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="MultiClouds.__init__-44"><a href="#MultiClouds.__init__-44"><span class="linenos"> 44</span></a>        <span class="n">luminance_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="MultiClouds.__init__-45"><a href="#MultiClouds.__init__-45"><span class="linenos"> 45</span></a>        <span class="n">LMS</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="MultiClouds.__init__-46"><a href="#MultiClouds.__init__-46"><span class="linenos"> 46</span></a>        <span class="n">binocular</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># whether to include separate filters for each eye</span>
</span><span id="MultiClouds.__init__-47"><a href="#MultiClouds.__init__-47"><span class="linenos"> 47</span></a>        <span class="n">eye_config</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># 0 = all, 1, 2, and 3 are options (3 = binocular)</span>
</span><span id="MultiClouds.__init__-48"><a href="#MultiClouds.__init__-48"><span class="linenos"> 48</span></a>        <span class="n">eye_contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># whether to only use eye_config data that is contiguous </span>
</span><span id="MultiClouds.__init__-49"><a href="#MultiClouds.__init__-49"><span class="linenos"> 49</span></a>        <span class="n">cell_lists</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MultiClouds.__init__-50"><a href="#MultiClouds.__init__-50"><span class="linenos"> 50</span></a>        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
</span><span id="MultiClouds.__init__-51"><a href="#MultiClouds.__init__-51"><span class="linenos"> 51</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.__init__-52"><a href="#MultiClouds.__init__-52"><span class="linenos"> 52</span></a><span class="sd">        Constructor options</span>
</span><span id="MultiClouds.__init__-53"><a href="#MultiClouds.__init__-53"><span class="linenos"> 53</span></a><span class="sd">        </span>
</span><span id="MultiClouds.__init__-54"><a href="#MultiClouds.__init__-54"><span class="linenos"> 54</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds.__init__-55"><a href="#MultiClouds.__init__-55"><span class="linenos"> 55</span></a><span class="sd">            filenames (list): list of strings of the filenames to be loaded</span>
</span><span id="MultiClouds.__init__-56"><a href="#MultiClouds.__init__-56"><span class="linenos"> 56</span></a><span class="sd">            datadir (str): directory where the data is stored</span>
</span><span id="MultiClouds.__init__-57"><a href="#MultiClouds.__init__-57"><span class="linenos"> 57</span></a><span class="sd">            num_lags (int): number of lags to include in the stimulus</span>
</span><span id="MultiClouds.__init__-58"><a href="#MultiClouds.__init__-58"><span class="linenos"> 58</span></a><span class="sd">            include_MUs (bool): whether to include multi-units in the dataset</span>
</span><span id="MultiClouds.__init__-59"><a href="#MultiClouds.__init__-59"><span class="linenos"> 59</span></a><span class="sd">            drift_interval (int): number of blocks to include in the drift term</span>
</span><span id="MultiClouds.__init__-60"><a href="#MultiClouds.__init__-60"><span class="linenos"> 60</span></a><span class="sd">            trial_sample (bool): whether to sample trials for train/val/test</span>
</span><span id="MultiClouds.__init__-61"><a href="#MultiClouds.__init__-61"><span class="linenos"> 61</span></a><span class="sd">            luminance_only (bool): whether to only include luminance in the stimulus</span>
</span><span id="MultiClouds.__init__-62"><a href="#MultiClouds.__init__-62"><span class="linenos"> 62</span></a><span class="sd">            binocular (bool): whether to include separate filters for each eye</span>
</span><span id="MultiClouds.__init__-63"><a href="#MultiClouds.__init__-63"><span class="linenos"> 63</span></a><span class="sd">            eye_config (int): which eye configuration to use (0=all, 1=left, 2=right, 3=binocular)</span>
</span><span id="MultiClouds.__init__-64"><a href="#MultiClouds.__init__-64"><span class="linenos"> 64</span></a><span class="sd">            eye_contiguous (bool): whether to only use contiguous eye configurations</span>
</span><span id="MultiClouds.__init__-65"><a href="#MultiClouds.__init__-65"><span class="linenos"> 65</span></a><span class="sd">            cell_lists (list): list of lists of cell indices to include in the dataset</span>
</span><span id="MultiClouds.__init__-66"><a href="#MultiClouds.__init__-66"><span class="linenos"> 66</span></a><span class="sd">            device (torch.device): device to store the data on</span>
</span><span id="MultiClouds.__init__-67"><a href="#MultiClouds.__init__-67"><span class="linenos"> 67</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.__init__-68"><a href="#MultiClouds.__init__-68"><span class="linenos"> 68</span></a>
</span><span id="MultiClouds.__init__-69"><a href="#MultiClouds.__init__-69"><span class="linenos"> 69</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="MultiClouds.__init__-70"><a href="#MultiClouds.__init__-70"><span class="linenos"> 70</span></a>            <span class="n">filenames</span><span class="o">=</span><span class="n">filenames</span><span class="p">,</span> <span class="n">datadir</span><span class="o">=</span><span class="n">datadir</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
</span><span id="MultiClouds.__init__-71"><a href="#MultiClouds.__init__-71"><span class="linenos"> 71</span></a>            <span class="n">time_embed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">num_lags</span><span class="p">,</span> <span class="n">include_MUs</span><span class="o">=</span><span class="n">include_MUs</span><span class="p">,</span> 
</span><span id="MultiClouds.__init__-72"><a href="#MultiClouds.__init__-72"><span class="linenos"> 72</span></a>            <span class="n">drift_interval</span><span class="o">=</span><span class="n">drift_interval</span><span class="p">,</span> <span class="n">trial_sample</span><span class="o">=</span><span class="n">trial_sample</span><span class="p">)</span>
</span><span id="MultiClouds.__init__-73"><a href="#MultiClouds.__init__-73"><span class="linenos"> 73</span></a>
</span><span id="MultiClouds.__init__-74"><a href="#MultiClouds.__init__-74"><span class="linenos"> 74</span></a>        <span class="c1"># Done in parent constructor</span>
</span><span id="MultiClouds.__init__-75"><a href="#MultiClouds.__init__-75"><span class="linenos"> 75</span></a>        <span class="c1">#self.datadir = datadir</span>
</span><span id="MultiClouds.__init__-76"><a href="#MultiClouds.__init__-76"><span class="linenos"> 76</span></a>        <span class="c1">#self.filenames = filenames</span>
</span><span id="MultiClouds.__init__-77"><a href="#MultiClouds.__init__-77"><span class="linenos"> 77</span></a>        <span class="c1">#self.device = device</span>
</span><span id="MultiClouds.__init__-78"><a href="#MultiClouds.__init__-78"><span class="linenos"> 78</span></a>        <span class="c1">#self.num_lags = 10  # default: to be set later</span>
</span><span id="MultiClouds.__init__-79"><a href="#MultiClouds.__init__-79"><span class="linenos"> 79</span></a>        <span class="c1">#if time_embed == 2:</span>
</span><span id="MultiClouds.__init__-80"><a href="#MultiClouds.__init__-80"><span class="linenos"> 80</span></a>        <span class="c1">#    assert preload, &quot;Cannot pre-time-embed without preloading.&quot;</span>
</span><span id="MultiClouds.__init__-81"><a href="#MultiClouds.__init__-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># not set</span>
</span><span id="MultiClouds.__init__-82"><a href="#MultiClouds.__init__-82"><span class="linenos"> 82</span></a>        <span class="c1">#self.preload = preload</span>
</span><span id="MultiClouds.__init__-83"><a href="#MultiClouds.__init__-83"><span class="linenos"> 83</span></a>
</span><span id="MultiClouds.__init__-84"><a href="#MultiClouds.__init__-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
</span><span id="MultiClouds.__init__-85"><a href="#MultiClouds.__init__-85"><span class="linenos"> 85</span></a>
</span><span id="MultiClouds.__init__-86"><a href="#MultiClouds.__init__-86"><span class="linenos"> 86</span></a>        <span class="c1"># Stim-specific</span>
</span><span id="MultiClouds.__init__-87"><a href="#MultiClouds.__init__-87"><span class="linenos"> 87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">=</span> <span class="n">eye_config</span>
</span><span id="MultiClouds.__init__-88"><a href="#MultiClouds.__init__-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eye_contiguous</span> <span class="o">=</span> <span class="n">eye_contiguous</span>
</span><span id="MultiClouds.__init__-89"><a href="#MultiClouds.__init__-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span> <span class="o">=</span> <span class="n">binocular</span>
</span><span id="MultiClouds.__init__-90"><a href="#MultiClouds.__init__-90"><span class="linenos"> 90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span> <span class="o">=</span> <span class="n">luminance_only</span>
</span><span id="MultiClouds.__init__-91"><a href="#MultiClouds.__init__-91"><span class="linenos"> 91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">includeMUs</span> <span class="o">=</span> <span class="n">include_MUs</span>
</span><span id="MultiClouds.__init__-92"><a href="#MultiClouds.__init__-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_Xfix</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="MultiClouds.__init__-93"><a href="#MultiClouds.__init__-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_separate_eye_stim</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="MultiClouds.__init__-94"><a href="#MultiClouds.__init__-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">expt_stims</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span>
</span><span id="MultiClouds.__init__-95"><a href="#MultiClouds.__init__-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MultiClouds.__init__-96"><a href="#MultiClouds.__init__-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">LMS</span> <span class="o">=</span> <span class="n">LMS</span>
</span><span id="MultiClouds.__init__-97"><a href="#MultiClouds.__init__-97"><span class="linenos"> 97</span></a>        
</span><span id="MultiClouds.__init__-98"><a href="#MultiClouds.__init__-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds.__init__-99"><a href="#MultiClouds.__init__-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span> <span class="o">=</span> <span class="n">drift_interval</span>
</span><span id="MultiClouds.__init__-100"><a href="#MultiClouds.__init__-100"><span class="linenos">100</span></a>
</span><span id="MultiClouds.__init__-101"><a href="#MultiClouds.__init__-101"><span class="linenos">101</span></a>        <span class="c1"># Set up to store default train_, val_, test_inds -- in SensoryBase</span>
</span><span id="MultiClouds.__init__-102"><a href="#MultiClouds.__init__-102"><span class="linenos">102</span></a>        <span class="c1">#self.test_inds = None</span>
</span><span id="MultiClouds.__init__-103"><a href="#MultiClouds.__init__-103"><span class="linenos">103</span></a>        <span class="c1">#self.val_inds = None</span>
</span><span id="MultiClouds.__init__-104"><a href="#MultiClouds.__init__-104"><span class="linenos">104</span></a>        <span class="c1">#self.train_inds = None</span>
</span><span id="MultiClouds.__init__-105"><a href="#MultiClouds.__init__-105"><span class="linenos">105</span></a>        <span class="c1">#self.used_inds = []</span>
</span><span id="MultiClouds.__init__-106"><a href="#MultiClouds.__init__-106"><span class="linenos">106</span></a>
</span><span id="MultiClouds.__init__-107"><a href="#MultiClouds.__init__-107"><span class="linenos">107</span></a>        <span class="c1"># Data to construct and store in memory -- some in SensoryBase</span>
</span><span id="MultiClouds.__init__-108"><a href="#MultiClouds.__init__-108"><span class="linenos">108</span></a>        <span class="c1">#self.stim = []</span>
</span><span id="MultiClouds.__init__-109"><a href="#MultiClouds.__init__-109"><span class="linenos">109</span></a>        <span class="c1">#self.dfs = []</span>
</span><span id="MultiClouds.__init__-110"><a href="#MultiClouds.__init__-110"><span class="linenos">110</span></a>        <span class="c1">#self.robs = []</span>
</span><span id="MultiClouds.__init__-111"><a href="#MultiClouds.__init__-111"><span class="linenos">111</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiClouds.__init__-112"><a href="#MultiClouds.__init__-112"><span class="linenos">112</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds.__init__-113"><a href="#MultiClouds.__init__-113"><span class="linenos">113</span></a>
</span><span id="MultiClouds.__init__-114"><a href="#MultiClouds.__init__-114"><span class="linenos">114</span></a>        <span class="c1"># build index map -- exclude variables already set in sensory-base</span>
</span><span id="MultiClouds.__init__-115"><a href="#MultiClouds.__init__-115"><span class="linenos">115</span></a>        <span class="c1">#self.num_blks = np.zeros(len(filenames), dtype=int)</span>
</span><span id="MultiClouds.__init__-116"><a href="#MultiClouds.__init__-116"><span class="linenos">116</span></a>        <span class="c1">#self.file_index = [] # which file the block corresponds to</span>
</span><span id="MultiClouds.__init__-117"><a href="#MultiClouds.__init__-117"><span class="linenos">117</span></a>        <span class="c1">#self.stim_dims = None</span>
</span><span id="MultiClouds.__init__-118"><a href="#MultiClouds.__init__-118"><span class="linenos">118</span></a>
</span><span id="MultiClouds.__init__-119"><a href="#MultiClouds.__init__-119"><span class="linenos">119</span></a>        <span class="c1">#self.unit_ids = []</span>
</span><span id="MultiClouds.__init__-120"><a href="#MultiClouds.__init__-120"><span class="linenos">120</span></a>        <span class="c1">#self.num_units, self.num_SUs, self.num_MUs = [], [], []</span>
</span><span id="MultiClouds.__init__-121"><a href="#MultiClouds.__init__-121"><span class="linenos">121</span></a>        <span class="c1">#self.SUs = []</span>
</span><span id="MultiClouds.__init__-122"><a href="#MultiClouds.__init__-122"><span class="linenos">122</span></a>        <span class="c1">#self.NC = 0    </span>
</span><span id="MultiClouds.__init__-123"><a href="#MultiClouds.__init__-123"><span class="linenos">123</span></a>        <span class="c1">#self.block_inds = []</span>
</span><span id="MultiClouds.__init__-124"><a href="#MultiClouds.__init__-124"><span class="linenos">124</span></a>        <span class="c1">#self.block_filemapping = []</span>
</span><span id="MultiClouds.__init__-125"><a href="#MultiClouds.__init__-125"><span class="linenos">125</span></a>        <span class="c1">#self.include_MUs = include_MUs</span>
</span><span id="MultiClouds.__init__-126"><a href="#MultiClouds.__init__-126"><span class="linenos">126</span></a>        <span class="c1">#self.SUinds = []</span>
</span><span id="MultiClouds.__init__-127"><a href="#MultiClouds.__init__-127"><span class="linenos">127</span></a>        <span class="c1">#self.MUinds = []</span>
</span><span id="MultiClouds.__init__-128"><a href="#MultiClouds.__init__-128"><span class="linenos">128</span></a>        <span class="c1">#self.cells_out = []  # can be list to output specific cells in get_item</span>
</span><span id="MultiClouds.__init__-129"><a href="#MultiClouds.__init__-129"><span class="linenos">129</span></a>        <span class="c1">#self.avRs = None</span>
</span><span id="MultiClouds.__init__-130"><a href="#MultiClouds.__init__-130"><span class="linenos">130</span></a>
</span><span id="MultiClouds.__init__-131"><a href="#MultiClouds.__init__-131"><span class="linenos">131</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">sess</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>
</span><span id="MultiClouds.__init__-132"><a href="#MultiClouds.__init__-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span>
</span><span id="MultiClouds.__init__-133"><a href="#MultiClouds.__init__-133"><span class="linenos">133</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds.__init__-134"><a href="#MultiClouds.__init__-134"><span class="linenos">134</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fileNBLK</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds.__init__-135"><a href="#MultiClouds.__init__-135"><span class="linenos">135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds.__init__-136"><a href="#MultiClouds.__init__-136"><span class="linenos">136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fileNA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="c1"># for the drift term</span>
</span><span id="MultiClouds.__init__-137"><a href="#MultiClouds.__init__-137"><span class="linenos">137</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_tstart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds.__init__-138"><a href="#MultiClouds.__init__-138"><span class="linenos">138</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_blkstart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds.__init__-139"><a href="#MultiClouds.__init__-139"><span class="linenos">139</span></a>
</span><span id="MultiClouds.__init__-140"><a href="#MultiClouds.__init__-140"><span class="linenos">140</span></a>        <span class="n">tcount</span><span class="p">,</span> <span class="n">blkcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="MultiClouds.__init__-141"><a href="#MultiClouds.__init__-141"><span class="linenos">141</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tranges</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span>
</span><span id="MultiClouds.__init__-142"><a href="#MultiClouds.__init__-142"><span class="linenos">142</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span>
</span><span id="MultiClouds.__init__-143"><a href="#MultiClouds.__init__-143"><span class="linenos">143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiClouds.__init__-144"><a href="#MultiClouds.__init__-144"><span class="linenos">144</span></a>
</span><span id="MultiClouds.__init__-145"><a href="#MultiClouds.__init__-145"><span class="linenos">145</span></a>        <span class="c1"># Structure of file on time/trial level</span>
</span><span id="MultiClouds.__init__-146"><a href="#MultiClouds.__init__-146"><span class="linenos">146</span></a> 
</span><span id="MultiClouds.__init__-147"><a href="#MultiClouds.__init__-147"><span class="linenos">147</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">):</span>
</span><span id="MultiClouds.__init__-148"><a href="#MultiClouds.__init__-148"><span class="linenos">148</span></a>            <span class="c1"># get hdf5 file handles</span>
</span><span id="MultiClouds.__init__-149"><a href="#MultiClouds.__init__-149"><span class="linenos">149</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file_info</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">filenames</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="MultiClouds.__init__-150"><a href="#MultiClouds.__init__-150"><span class="linenos">150</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="MultiClouds.__init__-151"><a href="#MultiClouds.__init__-151"><span class="linenos">151</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NSUs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NMUs&#39;</span><span class="p">]</span>
</span><span id="MultiClouds.__init__-152"><a href="#MultiClouds.__init__-152"><span class="linenos">152</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.__init__-153"><a href="#MultiClouds.__init__-153"><span class="linenos">153</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NSUs&#39;</span><span class="p">]</span>
</span><span id="MultiClouds.__init__-154"><a href="#MultiClouds.__init__-154"><span class="linenos">154</span></a>
</span><span id="MultiClouds.__init__-155"><a href="#MultiClouds.__init__-155"><span class="linenos">155</span></a>            <span class="c1"># Consolidate valid t-ranges based on binocular choice</span>
</span><span id="MultiClouds.__init__-156"><a href="#MultiClouds.__init__-156"><span class="linenos">156</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;tmap&#39;</span><span class="p">]</span>
</span><span id="MultiClouds.__init__-157"><a href="#MultiClouds.__init__-157"><span class="linenos">157</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds.__init__-158"><a href="#MultiClouds.__init__-158"><span class="linenos">158</span></a>            <span class="c1"># Make one long block-list</span>
</span><span id="MultiClouds.__init__-159"><a href="#MultiClouds.__init__-159"><span class="linenos">159</span></a>            <span class="n">NBLK</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;trial_info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.__init__-160"><a href="#MultiClouds.__init__-160"><span class="linenos">160</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NBLK</span><span class="p">):</span>
</span><span id="MultiClouds.__init__-161"><a href="#MultiClouds.__init__-161"><span class="linenos">161</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> 
</span><span id="MultiClouds.__init__-162"><a href="#MultiClouds.__init__-162"><span class="linenos">162</span></a>                    <span class="n">tcount</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;trial_info&#39;</span><span class="p">][</span><span class="n">bb</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;trial_info&#39;</span><span class="p">][</span><span class="n">bb</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
</span><span id="MultiClouds.__init__-163"><a href="#MultiClouds.__init__-163"><span class="linenos">163</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fileNBLK</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;trial_info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.__init__-164"><a href="#MultiClouds.__init__-164"><span class="linenos">164</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">file_blkstart</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">blkcount</span>
</span><span id="MultiClouds.__init__-165"><a href="#MultiClouds.__init__-165"><span class="linenos">165</span></a>            <span class="n">blkcount</span> <span class="o">+=</span> <span class="n">NBLK</span>
</span><span id="MultiClouds.__init__-166"><a href="#MultiClouds.__init__-166"><span class="linenos">166</span></a>
</span><span id="MultiClouds.__init__-167"><a href="#MultiClouds.__init__-167"><span class="linenos">167</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NT&#39;</span><span class="p">]</span>
</span><span id="MultiClouds.__init__-168"><a href="#MultiClouds.__init__-168"><span class="linenos">168</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">file_tstart</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">tcount</span>
</span><span id="MultiClouds.__init__-169"><a href="#MultiClouds.__init__-169"><span class="linenos">169</span></a>            <span class="n">tcount</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NT&#39;</span><span class="p">]</span>
</span><span id="MultiClouds.__init__-170"><a href="#MultiClouds.__init__-170"><span class="linenos">170</span></a>
</span><span id="MultiClouds.__init__-171"><a href="#MultiClouds.__init__-171"><span class="linenos">171</span></a>        <span class="c1"># Assemble robs and dfs given current information</span>
</span><span id="MultiClouds.__init__-172"><a href="#MultiClouds.__init__-172"><span class="linenos">172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">=</span> <span class="n">tcount</span>
</span><span id="MultiClouds.__init__-173"><a href="#MultiClouds.__init__-173"><span class="linenos">173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">)</span>
</span><span id="MultiClouds.__init__-174"><a href="#MultiClouds.__init__-174"><span class="linenos">174</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> total time steps, </span><span class="si">%d</span><span class="s2"> units&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">)</span> <span class="p">)</span>
</span><span id="MultiClouds.__init__-175"><a href="#MultiClouds.__init__-175"><span class="linenos">175</span></a>        <span class="k">if</span> <span class="n">cell_lists</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.__init__-176"><a href="#MultiClouds.__init__-176"><span class="linenos">176</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">modify_included_cells</span><span class="p">(</span><span class="n">cell_lists</span><span class="p">)</span>
</span><span id="MultiClouds.__init__-177"><a href="#MultiClouds.__init__-177"><span class="linenos">177</span></a>            <span class="c1"># this will automatically assemble_robs at the end</span>
</span><span id="MultiClouds.__init__-178"><a href="#MultiClouds.__init__-178"><span class="linenos">178</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.__init__-179"><a href="#MultiClouds.__init__-179"><span class="linenos">179</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">assemble_robs</span><span class="p">()</span>
</span><span id="MultiClouds.__init__-180"><a href="#MultiClouds.__init__-180"><span class="linenos">180</span></a> 
</span><span id="MultiClouds.__init__-181"><a href="#MultiClouds.__init__-181"><span class="linenos">181</span></a>        <span class="c1"># Assemble current list of fixations</span>
</span><span id="MultiClouds.__init__-182"><a href="#MultiClouds.__init__-182"><span class="linenos">182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span>
</span><span id="MultiClouds.__init__-183"><a href="#MultiClouds.__init__-183"><span class="linenos">183</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_shifts</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span>
</span><span id="MultiClouds.__init__-184"><a href="#MultiClouds.__init__-184"><span class="linenos">184</span></a>        <span class="n">to_assemble</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="MultiClouds.__init__-185"><a href="#MultiClouds.__init__-185"><span class="linenos">185</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">):</span>
</span><span id="MultiClouds.__init__-186"><a href="#MultiClouds.__init__-186"><span class="linenos">186</span></a>            <span class="n">sacc_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;sacc_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds.__init__-187"><a href="#MultiClouds.__init__-187"><span class="linenos">187</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sacc_inds</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># assume its no good</span>
</span><span id="MultiClouds.__init__-188"><a href="#MultiClouds.__init__-188"><span class="linenos">188</span></a>                <span class="n">sacc_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MultiClouds.__init__-189"><a href="#MultiClouds.__init__-189"><span class="linenos">189</span></a>                <span class="n">to_assemble</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="MultiClouds.__init__-190"><a href="#MultiClouds.__init__-190"><span class="linenos">190</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.__init__-191"><a href="#MultiClouds.__init__-191"><span class="linenos">191</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sacc_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MultiClouds.__init__-192"><a href="#MultiClouds.__init__-192"><span class="linenos">192</span></a>                    <span class="n">sacc_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># convert to python so range works</span>
</span><span id="MultiClouds.__init__-193"><a href="#MultiClouds.__init__-193"><span class="linenos">193</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.__init__-194"><a href="#MultiClouds.__init__-194"><span class="linenos">194</span></a>                    <span class="n">sacc_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MultiClouds.__init__-195"><a href="#MultiClouds.__init__-195"><span class="linenos">195</span></a>                    <span class="n">to_assemble</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="MultiClouds.__init__-196"><a href="#MultiClouds.__init__-196"><span class="linenos">196</span></a>
</span><span id="MultiClouds.__init__-197"><a href="#MultiClouds.__init__-197"><span class="linenos">197</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sacc_inds</span><span class="p">)</span>
</span><span id="MultiClouds.__init__-198"><a href="#MultiClouds.__init__-198"><span class="linenos">198</span></a>
</span><span id="MultiClouds.__init__-199"><a href="#MultiClouds.__init__-199"><span class="linenos">199</span></a>        <span class="c1">#if to_assemble:</span>
</span><span id="MultiClouds.__init__-200"><a href="#MultiClouds.__init__-200"><span class="linenos">200</span></a>        <span class="c1">#    self.assemble_saccade_inds()</span>
</span><span id="MultiClouds.__init__-201"><a href="#MultiClouds.__init__-201"><span class="linenos">201</span></a>
</span><span id="MultiClouds.__init__-202"><a href="#MultiClouds.__init__-202"><span class="linenos">202</span></a>        <span class="c1">### Construct drift term if relevant</span>
</span><span id="MultiClouds.__init__-203"><a href="#MultiClouds.__init__-203"><span class="linenos">203</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.__init__-204"><a href="#MultiClouds.__init__-204"><span class="linenos">204</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MultiClouds.__init__-205"><a href="#MultiClouds.__init__-205"><span class="linenos">205</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.__init__-206"><a href="#MultiClouds.__init__-206"><span class="linenos">206</span></a>            <span class="n">Nanchors_tot</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds.__init__-207"><a href="#MultiClouds.__init__-207"><span class="linenos">207</span></a>            <span class="c1"># Make drift for each dataset</span>
</span><span id="MultiClouds.__init__-208"><a href="#MultiClouds.__init__-208"><span class="linenos">208</span></a>            <span class="n">Xdrift_expts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiClouds.__init__-209"><a href="#MultiClouds.__init__-209"><span class="linenos">209</span></a>            <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">):</span>
</span><span id="MultiClouds.__init__-210"><a href="#MultiClouds.__init__-210"><span class="linenos">210</span></a>                <span class="n">NBL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileNBLK</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span>
</span><span id="MultiClouds.__init__-211"><a href="#MultiClouds.__init__-211"><span class="linenos">211</span></a>                <span class="n">Nanchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">NBL</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="MultiClouds.__init__-212"><a href="#MultiClouds.__init__-212"><span class="linenos">212</span></a>                <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds.__init__-213"><a href="#MultiClouds.__init__-213"><span class="linenos">213</span></a>                <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">):</span>
</span><span id="MultiClouds.__init__-214"><a href="#MultiClouds.__init__-214"><span class="linenos">214</span></a>                    <span class="n">anchors</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span><span class="o">*</span><span class="n">bb</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.__init__-215"><a href="#MultiClouds.__init__-215"><span class="linenos">215</span></a>                <span class="c1">#self.Xdrift = utils.design_matrix_drift( self.NT, anchors, zero_left=False, const_right=True)</span>
</span><span id="MultiClouds.__init__-216"><a href="#MultiClouds.__init__-216"><span class="linenos">216</span></a>                <span class="n">Xdrift_expts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="MultiClouds.__init__-217"><a href="#MultiClouds.__init__-217"><span class="linenos">217</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fileNA</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">Nanchors</span> <span class="c1"># store the number of anchors for each file</span>
</span><span id="MultiClouds.__init__-218"><a href="#MultiClouds.__init__-218"><span class="linenos">218</span></a>                <span class="n">Nanchors_tot</span> <span class="o">+=</span> <span class="n">Nanchors</span>
</span><span id="MultiClouds.__init__-219"><a href="#MultiClouds.__init__-219"><span class="linenos">219</span></a>
</span><span id="MultiClouds.__init__-220"><a href="#MultiClouds.__init__-220"><span class="linenos">220</span></a>            <span class="c1"># Assemble whole drift matrix</span>
</span><span id="MultiClouds.__init__-221"><a href="#MultiClouds.__init__-221"><span class="linenos">221</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">Nanchors_tot</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="MultiClouds.__init__-222"><a href="#MultiClouds.__init__-222"><span class="linenos">222</span></a>            <span class="n">anchor_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds.__init__-223"><a href="#MultiClouds.__init__-223"><span class="linenos">223</span></a>            <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">):</span>
</span><span id="MultiClouds.__init__-224"><a href="#MultiClouds.__init__-224"><span class="linenos">224</span></a>                <span class="n">tslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="n">Nanchors_tot</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="MultiClouds.__init__-225"><a href="#MultiClouds.__init__-225"><span class="linenos">225</span></a>                <span class="n">tslice</span><span class="p">[:,</span> <span class="n">anchor_count</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Xdrift_expts</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="n">Xdrift_expts</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span>
</span><span id="MultiClouds.__init__-226"><a href="#MultiClouds.__init__-226"><span class="linenos">226</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">file_tstart</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">ff</span><span class="p">]),</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tslice</span><span class="p">)</span>
</span><span id="MultiClouds.__init__-227"><a href="#MultiClouds.__init__-227"><span class="linenos">227</span></a>                <span class="n">anchor_count</span> <span class="o">+=</span> <span class="n">Xdrift_expts</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds.__init__-228"><a href="#MultiClouds.__init__-228"><span class="linenos">228</span></a>
</span><span id="MultiClouds.__init__-229"><a href="#MultiClouds.__init__-229"><span class="linenos">229</span></a>        <span class="c1"># set up train, val and test inds and blks</span>
</span><span id="MultiClouds.__init__-230"><a href="#MultiClouds.__init__-230"><span class="linenos">230</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crossval_setup</span><span class="p">(</span><span class="n">test_set</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Constructor options</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>filenames (list):</strong>  list of strings of the filenames to be loaded</li>
<li><strong>datadir (str):</strong>  directory where the data is stored</li>
<li><strong>num_lags (int):</strong>  number of lags to include in the stimulus</li>
<li><strong>include_MUs (bool):</strong>  whether to include multi-units in the dataset</li>
<li><strong>drift_interval (int):</strong>  number of blocks to include in the drift term</li>
<li><strong>trial_sample (bool):</strong>  whether to sample trials for train/val/test</li>
<li><strong>luminance_only (bool):</strong>  whether to only include luminance in the stimulus</li>
<li><strong>binocular (bool):</strong>  whether to include separate filters for each eye</li>
<li><strong>eye_config (int):</strong>  which eye configuration to use (0=all, 1=left, 2=right, 3=binocular)</li>
<li><strong>eye_contiguous (bool):</strong>  whether to only use contiguous eye configurations</li>
<li><strong>cell_lists (list):</strong>  list of lists of cell indices to include in the dataset</li>
<li><strong>device (torch.device):</strong>  device to store the data on</li>
</ul>
</div>


                            </div>
                            <div id="MultiClouds.time_embed" class="classattr">
                                <div class="attr variable">
            <span class="name">time_embed</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.time_embed"></a>
    
    

                            </div>
                            <div id="MultiClouds.Nexpts" class="classattr">
                                <div class="attr variable">
            <span class="name">Nexpts</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.Nexpts"></a>
    
    

                            </div>
                            <div id="MultiClouds.eye_config" class="classattr">
                                <div class="attr variable">
            <span class="name">eye_config</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.eye_config"></a>
    
    

                            </div>
                            <div id="MultiClouds.eye_contiguous" class="classattr">
                                <div class="attr variable">
            <span class="name">eye_contiguous</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.eye_contiguous"></a>
    
    

                            </div>
                            <div id="MultiClouds.binocular" class="classattr">
                                <div class="attr variable">
            <span class="name">binocular</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.binocular"></a>
    
    

                            </div>
                            <div id="MultiClouds.luminance_only" class="classattr">
                                <div class="attr variable">
            <span class="name">luminance_only</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.luminance_only"></a>
    
    

                            </div>
                            <div id="MultiClouds.includeMUs" class="classattr">
                                <div class="attr variable">
            <span class="name">includeMUs</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.includeMUs"></a>
    
    

                            </div>
                            <div id="MultiClouds.generate_Xfix" class="classattr">
                                <div class="attr variable">
            <span class="name">generate_Xfix</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.generate_Xfix"></a>
    
    

                            </div>
                            <div id="MultiClouds.output_separate_eye_stim" class="classattr">
                                <div class="attr variable">
            <span class="name">output_separate_eye_stim</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.output_separate_eye_stim"></a>
    
    

                            </div>
                            <div id="MultiClouds.expt_stims" class="classattr">
                                <div class="attr variable">
            <span class="name">expt_stims</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.expt_stims"></a>
    
    

                            </div>
                            <div id="MultiClouds.L" class="classattr">
                                <div class="attr variable">
            <span class="name">L</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.L"></a>
    
    

                            </div>
                            <div id="MultiClouds.LMS" class="classattr">
                                <div class="attr variable">
            <span class="name">LMS</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.LMS"></a>
    
    

                            </div>
                            <div id="MultiClouds.start_t" class="classattr">
                                <div class="attr variable">
            <span class="name">start_t</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.start_t"></a>
    
    

                            </div>
                            <div id="MultiClouds.drift_interval" class="classattr">
                                <div class="attr variable">
            <span class="name">drift_interval</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.drift_interval"></a>
    
    

                            </div>
                            <div id="MultiClouds.used_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">used_inds</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.used_inds"></a>
    
    

                            </div>
                            <div id="MultiClouds.NT" class="classattr">
                                <div class="attr variable">
            <span class="name">NT</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.NT"></a>
    
    

                            </div>
                            <div id="MultiClouds.fhandles" class="classattr">
                                <div class="attr variable">
            <span class="name">fhandles</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.fhandles"></a>
    
    

                            </div>
                            <div id="MultiClouds.file_info" class="classattr">
                                <div class="attr variable">
            <span class="name">file_info</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.file_info"></a>
    
    

                            </div>
                            <div id="MultiClouds.fileNT" class="classattr">
                                <div class="attr variable">
            <span class="name">fileNT</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.fileNT"></a>
    
    

                            </div>
                            <div id="MultiClouds.fileNBLK" class="classattr">
                                <div class="attr variable">
            <span class="name">fileNBLK</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.fileNBLK"></a>
    
    

                            </div>
                            <div id="MultiClouds.fileNC" class="classattr">
                                <div class="attr variable">
            <span class="name">fileNC</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.fileNC"></a>
    
    

                            </div>
                            <div id="MultiClouds.fileNA" class="classattr">
                                <div class="attr variable">
            <span class="name">fileNA</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.fileNA"></a>
    
    

                            </div>
                            <div id="MultiClouds.file_tstart" class="classattr">
                                <div class="attr variable">
            <span class="name">file_tstart</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.file_tstart"></a>
    
    

                            </div>
                            <div id="MultiClouds.file_blkstart" class="classattr">
                                <div class="attr variable">
            <span class="name">file_blkstart</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.file_blkstart"></a>
    
    

                            </div>
                            <div id="MultiClouds.tranges" class="classattr">
                                <div class="attr variable">
            <span class="name">tranges</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.tranges"></a>
    
    

                            </div>
                            <div id="MultiClouds.cranges" class="classattr">
                                <div class="attr variable">
            <span class="name">cranges</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.cranges"></a>
    
    

                            </div>
                            <div id="MultiClouds.block_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">block_inds</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.block_inds"></a>
    
    

                            </div>
                            <div id="MultiClouds.NC" class="classattr">
                                <div class="attr variable">
            <span class="name">NC</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.NC"></a>
    
    

                            </div>
                            <div id="MultiClouds.sacc_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">sacc_inds</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.sacc_inds"></a>
    
    

                            </div>
                            <div id="MultiClouds.stim_shifts" class="classattr">
                                <div class="attr variable">
            <span class="name">stim_shifts</span>

        
    </div>
    <a class="headerlink" href="#MultiClouds.stim_shifts"></a>
    
    

                            </div>
                            <div id="MultiClouds.read_file_info" class="classattr">
                                        <input id="MultiClouds.read_file_info-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">read_file_info</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">file_n</span>, </span><span class="param"><span class="n">filename</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.read_file_info-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.read_file_info"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.read_file_info-233"><a href="#MultiClouds.read_file_info-233"><span class="linenos">233</span></a>    <span class="k">def</span> <span class="nf">read_file_info</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">file_n</span><span class="p">,</span> <span class="n">filename</span> <span class="p">):</span>
</span><span id="MultiClouds.read_file_info-234"><a href="#MultiClouds.read_file_info-234"><span class="linenos">234</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.read_file_info-235"><a href="#MultiClouds.read_file_info-235"><span class="linenos">235</span></a><span class="sd">        Initial processing of each file to pull out salient info for building stim and responses</span>
</span><span id="MultiClouds.read_file_info-236"><a href="#MultiClouds.read_file_info-236"><span class="linenos">236</span></a><span class="sd">        </span>
</span><span id="MultiClouds.read_file_info-237"><a href="#MultiClouds.read_file_info-237"><span class="linenos">237</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds.read_file_info-238"><a href="#MultiClouds.read_file_info-238"><span class="linenos">238</span></a><span class="sd">            file_n (int): index of the file</span>
</span><span id="MultiClouds.read_file_info-239"><a href="#MultiClouds.read_file_info-239"><span class="linenos">239</span></a><span class="sd">            filename (str): name of the file</span>
</span><span id="MultiClouds.read_file_info-240"><a href="#MultiClouds.read_file_info-240"><span class="linenos">240</span></a>
</span><span id="MultiClouds.read_file_info-241"><a href="#MultiClouds.read_file_info-241"><span class="linenos">241</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds.read_file_info-242"><a href="#MultiClouds.read_file_info-242"><span class="linenos">242</span></a><span class="sd">            dict: dictionary of file information</span>
</span><span id="MultiClouds.read_file_info-243"><a href="#MultiClouds.read_file_info-243"><span class="linenos">243</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.read_file_info-244"><a href="#MultiClouds.read_file_info-244"><span class="linenos">244</span></a>
</span><span id="MultiClouds.read_file_info-245"><a href="#MultiClouds.read_file_info-245"><span class="linenos">245</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">file_n</span><span class="p">]</span>
</span><span id="MultiClouds.read_file_info-246"><a href="#MultiClouds.read_file_info-246"><span class="linenos">246</span></a>        <span class="n">NT</span><span class="p">,</span> <span class="n">NSUs</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="MultiClouds.read_file_info-247"><a href="#MultiClouds.read_file_info-247"><span class="linenos">247</span></a>        <span class="c1"># Check for valid RobsMU</span>
</span><span id="MultiClouds.read_file_info-248"><a href="#MultiClouds.read_file_info-248"><span class="linenos">248</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MultiClouds.read_file_info-249"><a href="#MultiClouds.read_file_info-249"><span class="linenos">249</span></a>            <span class="n">NMUs</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds.read_file_info-250"><a href="#MultiClouds.read_file_info-250"><span class="linenos">250</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="MultiClouds.read_file_info-251"><a href="#MultiClouds.read_file_info-251"><span class="linenos">251</span></a>            <span class="n">NMUs</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds.read_file_info-252"><a href="#MultiClouds.read_file_info-252"><span class="linenos">252</span></a>
</span><span id="MultiClouds.read_file_info-253"><a href="#MultiClouds.read_file_info-253"><span class="linenos">253</span></a>        <span class="c1"># Unit information</span>
</span><span id="MultiClouds.read_file_info-254"><a href="#MultiClouds.read_file_info-254"><span class="linenos">254</span></a>        <span class="n">channel_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Robs_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="MultiClouds.read_file_info-255"><a href="#MultiClouds.read_file_info-255"><span class="linenos">255</span></a>        <span class="n">channel_ratings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;Robs_rating&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="MultiClouds.read_file_info-256"><a href="#MultiClouds.read_file_info-256"><span class="linenos">256</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">NMUs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeMUs</span><span class="p">:</span>
</span><span id="MultiClouds.read_file_info-257"><a href="#MultiClouds.read_file_info-257"><span class="linenos">257</span></a>            <span class="n">channel_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> 
</span><span id="MultiClouds.read_file_info-258"><a href="#MultiClouds.read_file_info-258"><span class="linenos">258</span></a>                <span class="p">(</span><span class="n">channel_map</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;RobsMU_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MultiClouds.read_file_info-259"><a href="#MultiClouds.read_file_info-259"><span class="linenos">259</span></a>            <span class="n">channel_ratings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> 
</span><span id="MultiClouds.read_file_info-260"><a href="#MultiClouds.read_file_info-260"><span class="linenos">260</span></a>                <span class="p">(</span><span class="n">channel_ratings</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;RobsMU_rating&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MultiClouds.read_file_info-261"><a href="#MultiClouds.read_file_info-261"><span class="linenos">261</span></a>
</span><span id="MultiClouds.read_file_info-262"><a href="#MultiClouds.read_file_info-262"><span class="linenos">262</span></a>        <span class="c1"># Block information</span>
</span><span id="MultiClouds.read_file_info-263"><a href="#MultiClouds.read_file_info-263"><span class="linenos">263</span></a>        <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;block_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds.read_file_info-264"><a href="#MultiClouds.read_file_info-264"><span class="linenos">264</span></a>        <span class="n">blk_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># convert to python so range works</span>
</span><span id="MultiClouds.read_file_info-265"><a href="#MultiClouds.read_file_info-265"><span class="linenos">265</span></a>        <span class="c1"># Check to make sure not inverted blk_inds (older version of data)</span>
</span><span id="MultiClouds.read_file_info-266"><a href="#MultiClouds.read_file_info-266"><span class="linenos">266</span></a>        <span class="k">if</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="MultiClouds.read_file_info-267"><a href="#MultiClouds.read_file_info-267"><span class="linenos">267</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: blk_inds is stored old-style: transposing&#39;</span><span class="p">)</span>
</span><span id="MultiClouds.read_file_info-268"><a href="#MultiClouds.read_file_info-268"><span class="linenos">268</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">T</span>
</span><span id="MultiClouds.read_file_info-269"><a href="#MultiClouds.read_file_info-269"><span class="linenos">269</span></a>        <span class="n">NBLK</span> <span class="o">=</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.read_file_info-270"><a href="#MultiClouds.read_file_info-270"><span class="linenos">270</span></a>
</span><span id="MultiClouds.read_file_info-271"><a href="#MultiClouds.read_file_info-271"><span class="linenos">271</span></a>        <span class="c1"># Stim information</span>
</span><span id="MultiClouds.read_file_info-272"><a href="#MultiClouds.read_file_info-272"><span class="linenos">272</span></a>        <span class="n">fix_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;fix_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="MultiClouds.read_file_info-273"><a href="#MultiClouds.read_file_info-273"><span class="linenos">273</span></a>        <span class="n">fix_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;fix_size&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="MultiClouds.read_file_info-274"><a href="#MultiClouds.read_file_info-274"><span class="linenos">274</span></a>        <span class="n">stim_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;stimscale&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="MultiClouds.read_file_info-275"><a href="#MultiClouds.read_file_info-275"><span class="linenos">275</span></a>        <span class="n">stim_locsLP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;stim_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
</span><span id="MultiClouds.read_file_info-276"><a href="#MultiClouds.read_file_info-276"><span class="linenos">276</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_locsLP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># then list of arrays for some reason</span>
</span><span id="MultiClouds.read_file_info-277"><a href="#MultiClouds.read_file_info-277"><span class="linenos">277</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  FILE_INFO: stim_locsLP list again -- ok but output check&#39;</span><span class="p">)</span>
</span><span id="MultiClouds.read_file_info-278"><a href="#MultiClouds.read_file_info-278"><span class="linenos">278</span></a>            <span class="n">stim_locsLP</span> <span class="o">=</span> <span class="n">stim_locsLP</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.read_file_info-279"><a href="#MultiClouds.read_file_info-279"><span class="linenos">279</span></a>        <span class="n">stim_locsET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;ETstim_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds.read_file_info-280"><a href="#MultiClouds.read_file_info-280"><span class="linenos">280</span></a>        <span class="n">blockIDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;blockID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>  <span class="c1"># what is this?</span>
</span><span id="MultiClouds.read_file_info-281"><a href="#MultiClouds.read_file_info-281"><span class="linenos">281</span></a>        <span class="c1">#self.ETtrace = np.array(f[&#39;ETtrace&#39;], dtype=np.float32)</span>
</span><span id="MultiClouds.read_file_info-282"><a href="#MultiClouds.read_file_info-282"><span class="linenos">282</span></a>        <span class="c1">#self.ETtraceHR = np.array(f[&#39;ETtrace_raw&#39;], dtype=np.float32)</span>
</span><span id="MultiClouds.read_file_info-283"><a href="#MultiClouds.read_file_info-283"><span class="linenos">283</span></a>
</span><span id="MultiClouds.read_file_info-284"><a href="#MultiClouds.read_file_info-284"><span class="linenos">284</span></a>        <span class="c1"># Binocular information</span>
</span><span id="MultiClouds.read_file_info-285"><a href="#MultiClouds.read_file_info-285"><span class="linenos">285</span></a>        <span class="n">Lpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;useLeye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.read_file_info-286"><a href="#MultiClouds.read_file_info-286"><span class="linenos">286</span></a>        <span class="n">Rpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.read_file_info-287"><a href="#MultiClouds.read_file_info-287"><span class="linenos">287</span></a>        <span class="n">LRpresent</span> <span class="o">=</span> <span class="n">Lpresent</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Rpresent</span>
</span><span id="MultiClouds.read_file_info-288"><a href="#MultiClouds.read_file_info-288"><span class="linenos">288</span></a>
</span><span id="MultiClouds.read_file_info-289"><a href="#MultiClouds.read_file_info-289"><span class="linenos">289</span></a>        <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;valid_data&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>  <span class="c1">#range(self.NT)  # default -- to be changed at end of init</span>
</span><span id="MultiClouds.read_file_info-290"><a href="#MultiClouds.read_file_info-290"><span class="linenos">290</span></a>
</span><span id="MultiClouds.read_file_info-291"><a href="#MultiClouds.read_file_info-291"><span class="linenos">291</span></a>        <span class="c1"># Parse timing and block information given eye_config</span>
</span><span id="MultiClouds.read_file_info-292"><a href="#MultiClouds.read_file_info-292"><span class="linenos">292</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds.read_file_info-293"><a href="#MultiClouds.read_file_info-293"><span class="linenos">293</span></a>            <span class="n">tmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NT</span><span class="p">)</span>
</span><span id="MultiClouds.read_file_info-294"><a href="#MultiClouds.read_file_info-294"><span class="linenos">294</span></a>            <span class="n">bmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NBLK</span><span class="p">)</span>
</span><span id="MultiClouds.read_file_info-295"><a href="#MultiClouds.read_file_info-295"><span class="linenos">295</span></a>            <span class="n">block_inds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">)</span>
</span><span id="MultiClouds.read_file_info-296"><a href="#MultiClouds.read_file_info-296"><span class="linenos">296</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.read_file_info-297"><a href="#MultiClouds.read_file_info-297"><span class="linenos">297</span></a>            <span class="n">tmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LRpresent</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.read_file_info-298"><a href="#MultiClouds.read_file_info-298"><span class="linenos">298</span></a>            <span class="c1"># Check for contiguous option (throw away disjoint eye config)</span>
</span><span id="MultiClouds.read_file_info-299"><a href="#MultiClouds.read_file_info-299"><span class="linenos">299</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_contiguous</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="MultiClouds.read_file_info-300"><a href="#MultiClouds.read_file_info-300"><span class="linenos">300</span></a>                <span class="n">tbreaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tmap</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.read_file_info-301"><a href="#MultiClouds.read_file_info-301"><span class="linenos">301</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbreaks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds.read_file_info-302"><a href="#MultiClouds.read_file_info-302"><span class="linenos">302</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Disjoint data exists with this eye_config -- trunctating to first section.&quot;</span><span class="p">)</span>
</span><span id="MultiClouds.read_file_info-303"><a href="#MultiClouds.read_file_info-303"><span class="linenos">303</span></a>                    <span class="n">tmap</span> <span class="o">=</span> <span class="n">tmap</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">tbreaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="MultiClouds.read_file_info-304"><a href="#MultiClouds.read_file_info-304"><span class="linenos">304</span></a>
</span><span id="MultiClouds.read_file_info-305"><a href="#MultiClouds.read_file_info-305"><span class="linenos">305</span></a>            <span class="c1"># Remap valid_inds to smaller trange -- does not use val_track: just temp variable</span>
</span><span id="MultiClouds.read_file_info-306"><a href="#MultiClouds.read_file_info-306"><span class="linenos">306</span></a>            <span class="n">val_track</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds.read_file_info-307"><a href="#MultiClouds.read_file_info-307"><span class="linenos">307</span></a>            <span class="n">val_track</span><span class="p">[</span><span class="n">valid_inds</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MultiClouds.read_file_info-308"><a href="#MultiClouds.read_file_info-308"><span class="linenos">308</span></a>            <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">val_track</span><span class="p">[</span><span class="n">tmap</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.read_file_info-309"><a href="#MultiClouds.read_file_info-309"><span class="linenos">309</span></a>
</span><span id="MultiClouds.read_file_info-310"><a href="#MultiClouds.read_file_info-310"><span class="linenos">310</span></a>            <span class="n">NT</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmap</span><span class="p">)</span>
</span><span id="MultiClouds.read_file_info-311"><a href="#MultiClouds.read_file_info-311"><span class="linenos">311</span></a> 
</span><span id="MultiClouds.read_file_info-312"><a href="#MultiClouds.read_file_info-312"><span class="linenos">312</span></a>            <span class="c1"># Remap block_inds to reduced map</span>
</span><span id="MultiClouds.read_file_info-313"><a href="#MultiClouds.read_file_info-313"><span class="linenos">313</span></a>            <span class="n">bmap</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiClouds.read_file_info-314"><a href="#MultiClouds.read_file_info-314"><span class="linenos">314</span></a>            <span class="n">tcount</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds.read_file_info-315"><a href="#MultiClouds.read_file_info-315"><span class="linenos">315</span></a>            <span class="n">block_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiClouds.read_file_info-316"><a href="#MultiClouds.read_file_info-316"><span class="linenos">316</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NBLK</span><span class="p">):</span>
</span><span id="MultiClouds.read_file_info-317"><a href="#MultiClouds.read_file_info-317"><span class="linenos">317</span></a>                <span class="k">if</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">tmap</span><span class="p">:</span>
</span><span id="MultiClouds.read_file_info-318"><a href="#MultiClouds.read_file_info-318"><span class="linenos">318</span></a>                    <span class="n">bmap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
</span><span id="MultiClouds.read_file_info-319"><a href="#MultiClouds.read_file_info-319"><span class="linenos">319</span></a>                    <span class="n">NTblk</span> <span class="o">=</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">blk_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.read_file_info-320"><a href="#MultiClouds.read_file_info-320"><span class="linenos">320</span></a>                    <span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">tcount</span><span class="p">,</span> <span class="n">tcount</span><span class="o">+</span><span class="n">NTblk</span><span class="p">])</span>
</span><span id="MultiClouds.read_file_info-321"><a href="#MultiClouds.read_file_info-321"><span class="linenos">321</span></a>                    <span class="n">tcount</span> <span class="o">+=</span> <span class="n">NTblk</span>
</span><span id="MultiClouds.read_file_info-322"><a href="#MultiClouds.read_file_info-322"><span class="linenos">322</span></a>            <span class="n">block_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">block_inds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds.read_file_info-323"><a href="#MultiClouds.read_file_info-323"><span class="linenos">323</span></a>            <span class="c1"># might have to modify blockIDs -- not done yet</span>
</span><span id="MultiClouds.read_file_info-324"><a href="#MultiClouds.read_file_info-324"><span class="linenos">324</span></a>
</span><span id="MultiClouds.read_file_info-325"><a href="#MultiClouds.read_file_info-325"><span class="linenos">325</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="MultiClouds.read_file_info-326"><a href="#MultiClouds.read_file_info-326"><span class="linenos">326</span></a>            <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
</span><span id="MultiClouds.read_file_info-327"><a href="#MultiClouds.read_file_info-327"><span class="linenos">327</span></a>            <span class="s1">&#39;NT&#39;</span><span class="p">:</span> <span class="n">NT</span><span class="p">,</span>
</span><span id="MultiClouds.read_file_info-328"><a href="#MultiClouds.read_file_info-328"><span class="linenos">328</span></a>            <span class="s1">&#39;tmap&#39;</span><span class="p">:</span> <span class="n">tmap</span><span class="p">,</span> 
</span><span id="MultiClouds.read_file_info-329"><a href="#MultiClouds.read_file_info-329"><span class="linenos">329</span></a>            <span class="s1">&#39;trial_info&#39;</span><span class="p">:</span> <span class="n">block_inds</span><span class="p">,</span> 
</span><span id="MultiClouds.read_file_info-330"><a href="#MultiClouds.read_file_info-330"><span class="linenos">330</span></a>            <span class="s1">&#39;LRpresent&#39;</span><span class="p">:</span> <span class="n">LRpresent</span><span class="p">,</span>
</span><span id="MultiClouds.read_file_info-331"><a href="#MultiClouds.read_file_info-331"><span class="linenos">331</span></a>            <span class="s1">&#39;valid_inds&#39;</span><span class="p">:</span> <span class="n">valid_inds</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
</span><span id="MultiClouds.read_file_info-332"><a href="#MultiClouds.read_file_info-332"><span class="linenos">332</span></a>            <span class="s1">&#39;blockIDs&#39;</span><span class="p">:</span> <span class="n">blockIDs</span><span class="p">,</span> <span class="c1"># What is this again?  </span>
</span><span id="MultiClouds.read_file_info-333"><a href="#MultiClouds.read_file_info-333"><span class="linenos">333</span></a>            <span class="s1">&#39;NSUs&#39;</span><span class="p">:</span> <span class="n">NSUs</span><span class="p">,</span>
</span><span id="MultiClouds.read_file_info-334"><a href="#MultiClouds.read_file_info-334"><span class="linenos">334</span></a>            <span class="s1">&#39;NMUs&#39;</span><span class="p">:</span> <span class="n">NMUs</span><span class="p">,</span>
</span><span id="MultiClouds.read_file_info-335"><a href="#MultiClouds.read_file_info-335"><span class="linenos">335</span></a>            <span class="s1">&#39;channel_map&#39;</span><span class="p">:</span> <span class="n">channel_map</span><span class="p">,</span>
</span><span id="MultiClouds.read_file_info-336"><a href="#MultiClouds.read_file_info-336"><span class="linenos">336</span></a>            <span class="s1">&#39;channel_ratings&#39;</span><span class="p">:</span> <span class="n">channel_ratings</span><span class="p">,</span>
</span><span id="MultiClouds.read_file_info-337"><a href="#MultiClouds.read_file_info-337"><span class="linenos">337</span></a>            <span class="s1">&#39;fix_loc&#39;</span><span class="p">:</span> <span class="n">fix_loc</span><span class="p">,</span>
</span><span id="MultiClouds.read_file_info-338"><a href="#MultiClouds.read_file_info-338"><span class="linenos">338</span></a>            <span class="s1">&#39;fix_size&#39;</span><span class="p">:</span> <span class="n">fix_size</span><span class="p">,</span>
</span><span id="MultiClouds.read_file_info-339"><a href="#MultiClouds.read_file_info-339"><span class="linenos">339</span></a>            <span class="s1">&#39;stim_scale&#39;</span><span class="p">:</span> <span class="n">stim_scale</span><span class="p">,</span>
</span><span id="MultiClouds.read_file_info-340"><a href="#MultiClouds.read_file_info-340"><span class="linenos">340</span></a>            <span class="s1">&#39;stim_locsLP&#39;</span><span class="p">:</span> <span class="n">stim_locsLP</span><span class="p">,</span>
</span><span id="MultiClouds.read_file_info-341"><a href="#MultiClouds.read_file_info-341"><span class="linenos">341</span></a>            <span class="s1">&#39;stim_locsET&#39;</span><span class="p">:</span> <span class="n">stim_locsET</span><span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Initial processing of each file to pull out salient info for building stim and responses</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>file_n (int):</strong>  index of the file</li>
<li><strong>filename (str):</strong>  name of the file</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>dict: dictionary of file information</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiClouds.modify_included_cells" class="classattr">
                                        <input id="MultiClouds.modify_included_cells-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">modify_included_cells</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">clists</span>, </span><span class="param"><span class="n">expt_n</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.modify_included_cells-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.modify_included_cells"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.modify_included_cells-344"><a href="#MultiClouds.modify_included_cells-344"><span class="linenos">344</span></a>    <span class="k">def</span> <span class="nf">modify_included_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clists</span><span class="p">,</span> <span class="n">expt_n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="MultiClouds.modify_included_cells-345"><a href="#MultiClouds.modify_included_cells-345"><span class="linenos">345</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.modify_included_cells-346"><a href="#MultiClouds.modify_included_cells-346"><span class="linenos">346</span></a><span class="sd">        Modify the included cells in the dataset</span>
</span><span id="MultiClouds.modify_included_cells-347"><a href="#MultiClouds.modify_included_cells-347"><span class="linenos">347</span></a>
</span><span id="MultiClouds.modify_included_cells-348"><a href="#MultiClouds.modify_included_cells-348"><span class="linenos">348</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds.modify_included_cells-349"><a href="#MultiClouds.modify_included_cells-349"><span class="linenos">349</span></a><span class="sd">            clists (list): list of lists of cell indices to include in the dataset</span>
</span><span id="MultiClouds.modify_included_cells-350"><a href="#MultiClouds.modify_included_cells-350"><span class="linenos">350</span></a><span class="sd">            expt_n (int): index of the experiment to modify</span>
</span><span id="MultiClouds.modify_included_cells-351"><a href="#MultiClouds.modify_included_cells-351"><span class="linenos">351</span></a>
</span><span id="MultiClouds.modify_included_cells-352"><a href="#MultiClouds.modify_included_cells-352"><span class="linenos">352</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds.modify_included_cells-353"><a href="#MultiClouds.modify_included_cells-353"><span class="linenos">353</span></a><span class="sd">            None</span>
</span><span id="MultiClouds.modify_included_cells-354"><a href="#MultiClouds.modify_included_cells-354"><span class="linenos">354</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.modify_included_cells-355"><a href="#MultiClouds.modify_included_cells-355"><span class="linenos">355</span></a>
</span><span id="MultiClouds.modify_included_cells-356"><a href="#MultiClouds.modify_included_cells-356"><span class="linenos">356</span></a>        <span class="k">if</span> <span class="n">expt_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.modify_included_cells-357"><a href="#MultiClouds.modify_included_cells-357"><span class="linenos">357</span></a>            <span class="n">expts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">)</span>
</span><span id="MultiClouds.modify_included_cells-358"><a href="#MultiClouds.modify_included_cells-358"><span class="linenos">358</span></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">clists</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="s2">&quot;Number of cell_lists must match number of experiments.&quot;</span>
</span><span id="MultiClouds.modify_included_cells-359"><a href="#MultiClouds.modify_included_cells-359"><span class="linenos">359</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.modify_included_cells-360"><a href="#MultiClouds.modify_included_cells-360"><span class="linenos">360</span></a>            <span class="n">expts</span> <span class="o">=</span> <span class="p">[</span><span class="n">expt_n</span><span class="p">]</span>
</span><span id="MultiClouds.modify_included_cells-361"><a href="#MultiClouds.modify_included_cells-361"><span class="linenos">361</span></a>            
</span><span id="MultiClouds.modify_included_cells-362"><a href="#MultiClouds.modify_included_cells-362"><span class="linenos">362</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">expts</span><span class="p">:</span>
</span><span id="MultiClouds.modify_included_cells-363"><a href="#MultiClouds.modify_included_cells-363"><span class="linenos">363</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clists</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds.modify_included_cells-364"><a href="#MultiClouds.modify_included_cells-364"><span class="linenos">364</span></a>                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">clists</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span> <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NSUs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NMUs&#39;</span><span class="p">]),</span> <span class="s2">&quot;clists too large&quot;</span>
</span><span id="MultiClouds.modify_included_cells-365"><a href="#MultiClouds.modify_included_cells-365"><span class="linenos">365</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">clists</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="MultiClouds.modify_included_cells-366"><a href="#MultiClouds.modify_included_cells-366"><span class="linenos">366</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.modify_included_cells-367"><a href="#MultiClouds.modify_included_cells-367"><span class="linenos">367</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeMUs</span><span class="p">:</span>
</span><span id="MultiClouds.modify_included_cells-368"><a href="#MultiClouds.modify_included_cells-368"><span class="linenos">368</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NSUs&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NMUs&#39;</span><span class="p">])</span>
</span><span id="MultiClouds.modify_included_cells-369"><a href="#MultiClouds.modify_included_cells-369"><span class="linenos">369</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.modify_included_cells-370"><a href="#MultiClouds.modify_included_cells-370"><span class="linenos">370</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NSUs&#39;</span><span class="p">])</span>
</span><span id="MultiClouds.modify_included_cells-371"><a href="#MultiClouds.modify_included_cells-371"><span class="linenos">371</span></a>
</span><span id="MultiClouds.modify_included_cells-372"><a href="#MultiClouds.modify_included_cells-372"><span class="linenos">372</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="MultiClouds.modify_included_cells-373"><a href="#MultiClouds.modify_included_cells-373"><span class="linenos">373</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">)</span>
</span><span id="MultiClouds.modify_included_cells-374"><a href="#MultiClouds.modify_included_cells-374"><span class="linenos">374</span></a>
</span><span id="MultiClouds.modify_included_cells-375"><a href="#MultiClouds.modify_included_cells-375"><span class="linenos">375</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assemble_robs</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Modify the included cells in the dataset</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>clists (list):</strong>  list of lists of cell indices to include in the dataset</li>
<li><strong>expt_n (int):</strong>  index of the experiment to modify</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiClouds.generate_array_cell_list" class="classattr">
                                        <input id="MultiClouds.generate_array_cell_list-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_array_cell_list</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">expt_n</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">which_array</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.generate_array_cell_list-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.generate_array_cell_list"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.generate_array_cell_list-378"><a href="#MultiClouds.generate_array_cell_list-378"><span class="linenos">378</span></a>    <span class="k">def</span> <span class="nf">generate_array_cell_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expt_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">which_array</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="MultiClouds.generate_array_cell_list-379"><a href="#MultiClouds.generate_array_cell_list-379"><span class="linenos">379</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.generate_array_cell_list-380"><a href="#MultiClouds.generate_array_cell_list-380"><span class="linenos">380</span></a><span class="sd">        Formula for generating cell list given channel maps and basic eligibility</span>
</span><span id="MultiClouds.generate_array_cell_list-381"><a href="#MultiClouds.generate_array_cell_list-381"><span class="linenos">381</span></a><span class="sd">        </span>
</span><span id="MultiClouds.generate_array_cell_list-382"><a href="#MultiClouds.generate_array_cell_list-382"><span class="linenos">382</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds.generate_array_cell_list-383"><a href="#MultiClouds.generate_array_cell_list-383"><span class="linenos">383</span></a><span class="sd">            expt_n (int): index of the experiment</span>
</span><span id="MultiClouds.generate_array_cell_list-384"><a href="#MultiClouds.generate_array_cell_list-384"><span class="linenos">384</span></a><span class="sd">            which_array (int or str): which array to generate the cell list for</span>
</span><span id="MultiClouds.generate_array_cell_list-385"><a href="#MultiClouds.generate_array_cell_list-385"><span class="linenos">385</span></a>
</span><span id="MultiClouds.generate_array_cell_list-386"><a href="#MultiClouds.generate_array_cell_list-386"><span class="linenos">386</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds.generate_array_cell_list-387"><a href="#MultiClouds.generate_array_cell_list-387"><span class="linenos">387</span></a><span class="sd">            np.array: array of cell indices</span>
</span><span id="MultiClouds.generate_array_cell_list-388"><a href="#MultiClouds.generate_array_cell_list-388"><span class="linenos">388</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.generate_array_cell_list-389"><a href="#MultiClouds.generate_array_cell_list-389"><span class="linenos">389</span></a>        <span class="c1">#expt_val = np.where( np.sum( self.robs[:, np.arange(cstart, cstart+self.fileNC[expt_n])], axis=0 ) &gt; 10)[0]</span>
</span><span id="MultiClouds.generate_array_cell_list-390"><a href="#MultiClouds.generate_array_cell_list-390"><span class="linenos">390</span></a>
</span><span id="MultiClouds.generate_array_cell_list-391"><a href="#MultiClouds.generate_array_cell_list-391"><span class="linenos">391</span></a>        <span class="c1"># Should only do this if have not already reduced channel list</span>
</span><span id="MultiClouds.generate_array_cell_list-392"><a href="#MultiClouds.generate_array_cell_list-392"><span class="linenos">392</span></a>        <span class="n">NC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;NSUs&#39;</span><span class="p">]</span>
</span><span id="MultiClouds.generate_array_cell_list-393"><a href="#MultiClouds.generate_array_cell_list-393"><span class="linenos">393</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">includeMUs</span><span class="p">:</span>
</span><span id="MultiClouds.generate_array_cell_list-394"><a href="#MultiClouds.generate_array_cell_list-394"><span class="linenos">394</span></a>            <span class="n">NC</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;NMUs&#39;</span><span class="p">]</span>
</span><span id="MultiClouds.generate_array_cell_list-395"><a href="#MultiClouds.generate_array_cell_list-395"><span class="linenos">395</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">])</span> <span class="o">==</span> <span class="n">NC</span><span class="p">,</span> <span class="s2">&quot;Can only generate cell_array if using currently using full cell_list&quot;</span>
</span><span id="MultiClouds.generate_array_cell_list-396"><a href="#MultiClouds.generate_array_cell_list-396"><span class="linenos">396</span></a>
</span><span id="MultiClouds.generate_array_cell_list-397"><a href="#MultiClouds.generate_array_cell_list-397"><span class="linenos">397</span></a>        <span class="k">if</span> <span class="n">which_array</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;utah&#39;</span><span class="p">]:</span>
</span><span id="MultiClouds.generate_array_cell_list-398"><a href="#MultiClouds.generate_array_cell_list-398"><span class="linenos">398</span></a>            <span class="n">array_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;channel_map&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="o">+</span><span class="mi">128</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.generate_array_cell_list-399"><a href="#MultiClouds.generate_array_cell_list-399"><span class="linenos">399</span></a>        <span class="k">elif</span> <span class="n">which_array</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;lam&#39;</span><span class="p">,</span> <span class="s1">&#39;laminar&#39;</span><span class="p">]:</span>
</span><span id="MultiClouds.generate_array_cell_list-400"><a href="#MultiClouds.generate_array_cell_list-400"><span class="linenos">400</span></a>            <span class="n">array_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;channel_map&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.generate_array_cell_list-401"><a href="#MultiClouds.generate_array_cell_list-401"><span class="linenos">401</span></a>        <span class="k">else</span><span class="p">:</span> <span class="c1"># assume Nform</span>
</span><span id="MultiClouds.generate_array_cell_list-402"><a href="#MultiClouds.generate_array_cell_list-402"><span class="linenos">402</span></a>            <span class="n">array_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;channel_map&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;channel_map&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="o">+</span><span class="mi">128</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.generate_array_cell_list-403"><a href="#MultiClouds.generate_array_cell_list-403"><span class="linenos">403</span></a>
</span><span id="MultiClouds.generate_array_cell_list-404"><a href="#MultiClouds.generate_array_cell_list-404"><span class="linenos">404</span></a>        <span class="n">cstart</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds.generate_array_cell_list-405"><a href="#MultiClouds.generate_array_cell_list-405"><span class="linenos">405</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">expt_n</span><span class="p">):</span>
</span><span id="MultiClouds.generate_array_cell_list-406"><a href="#MultiClouds.generate_array_cell_list-406"><span class="linenos">406</span></a>            <span class="n">cstart</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span>
</span><span id="MultiClouds.generate_array_cell_list-407"><a href="#MultiClouds.generate_array_cell_list-407"><span class="linenos">407</span></a>        <span class="n">nspks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">cstart</span><span class="o">+</span><span class="n">array_cells</span><span class="p">]</span>
</span><span id="MultiClouds.generate_array_cell_list-408"><a href="#MultiClouds.generate_array_cell_list-408"><span class="linenos">408</span></a>
</span><span id="MultiClouds.generate_array_cell_list-409"><a href="#MultiClouds.generate_array_cell_list-409"><span class="linenos">409</span></a>        <span class="n">val_array</span> <span class="o">=</span> <span class="n">array_cells</span><span class="p">[</span><span class="n">nspks</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">]</span>
</span><span id="MultiClouds.generate_array_cell_list-410"><a href="#MultiClouds.generate_array_cell_list-410"><span class="linenos">410</span></a>        <span class="k">return</span> <span class="n">val_array</span>
</span></pre></div>


            <div class="docstring"><p>Formula for generating cell list given channel maps and basic eligibility</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>expt_n (int):</strong>  index of the experiment</li>
<li><strong>which_array (int or str):</strong>  which array to generate the cell list for</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>np.array: array of cell indices</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiClouds.assemble_robs" class="classattr">
                                        <input id="MultiClouds.assemble_robs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">assemble_robs</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.assemble_robs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.assemble_robs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.assemble_robs-413"><a href="#MultiClouds.assemble_robs-413"><span class="linenos">413</span></a>    <span class="k">def</span> <span class="nf">assemble_robs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MultiClouds.assemble_robs-414"><a href="#MultiClouds.assemble_robs-414"><span class="linenos">414</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.assemble_robs-415"><a href="#MultiClouds.assemble_robs-415"><span class="linenos">415</span></a><span class="sd">        Takes current information (robs and dfs) to make robs and dfs (full version)</span>
</span><span id="MultiClouds.assemble_robs-416"><a href="#MultiClouds.assemble_robs-416"><span class="linenos">416</span></a><span class="sd">        Note this can be replaced by using the spike times explicitly</span>
</span><span id="MultiClouds.assemble_robs-417"><a href="#MultiClouds.assemble_robs-417"><span class="linenos">417</span></a><span class="sd">        </span>
</span><span id="MultiClouds.assemble_robs-418"><a href="#MultiClouds.assemble_robs-418"><span class="linenos">418</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds.assemble_robs-419"><a href="#MultiClouds.assemble_robs-419"><span class="linenos">419</span></a><span class="sd">            None</span>
</span><span id="MultiClouds.assemble_robs-420"><a href="#MultiClouds.assemble_robs-420"><span class="linenos">420</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.assemble_robs-421"><a href="#MultiClouds.assemble_robs-421"><span class="linenos">421</span></a>
</span><span id="MultiClouds.assemble_robs-422"><a href="#MultiClouds.assemble_robs-422"><span class="linenos">422</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span> <span class="p">)</span>
</span><span id="MultiClouds.assemble_robs-423"><a href="#MultiClouds.assemble_robs-423"><span class="linenos">423</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span> <span class="p">)</span>
</span><span id="MultiClouds.assemble_robs-424"><a href="#MultiClouds.assemble_robs-424"><span class="linenos">424</span></a>
</span><span id="MultiClouds.assemble_robs-425"><a href="#MultiClouds.assemble_robs-425"><span class="linenos">425</span></a>        <span class="n">tcount</span><span class="p">,</span> <span class="n">ccount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="MultiClouds.assemble_robs-426"><a href="#MultiClouds.assemble_robs-426"><span class="linenos">426</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">):</span>
</span><span id="MultiClouds.assemble_robs-427"><a href="#MultiClouds.assemble_robs-427"><span class="linenos">427</span></a>            <span class="n">NTexpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NT&#39;</span><span class="p">]</span>
</span><span id="MultiClouds.assemble_robs-428"><a href="#MultiClouds.assemble_robs-428"><span class="linenos">428</span></a>            <span class="n">NSUs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NSUs&#39;</span><span class="p">]</span>
</span><span id="MultiClouds.assemble_robs-429"><a href="#MultiClouds.assemble_robs-429"><span class="linenos">429</span></a>
</span><span id="MultiClouds.assemble_robs-430"><a href="#MultiClouds.assemble_robs-430"><span class="linenos">430</span></a>            <span class="n">valid_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NTexpt</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="MultiClouds.assemble_robs-431"><a href="#MultiClouds.assemble_robs-431"><span class="linenos">431</span></a>            <span class="n">valid_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;valid_inds&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MultiClouds.assemble_robs-432"><a href="#MultiClouds.assemble_robs-432"><span class="linenos">432</span></a>
</span><span id="MultiClouds.assemble_robs-433"><a href="#MultiClouds.assemble_robs-433"><span class="linenos">433</span></a>            <span class="c1"># Classify cell-lists in terms of SUs and MUc</span>
</span><span id="MultiClouds.assemble_robs-434"><a href="#MultiClouds.assemble_robs-434"><span class="linenos">434</span></a>            <span class="n">su_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">NSUs</span><span class="p">]</span>
</span><span id="MultiClouds.assemble_robs-435"><a href="#MultiClouds.assemble_robs-435"><span class="linenos">435</span></a>            <span class="n">R_tslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NTexpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span> <span class="p">)</span>
</span><span id="MultiClouds.assemble_robs-436"><a href="#MultiClouds.assemble_robs-436"><span class="linenos">436</span></a>            <span class="n">df_tslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NTexpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span> <span class="p">)</span>
</span><span id="MultiClouds.assemble_robs-437"><a href="#MultiClouds.assemble_robs-437"><span class="linenos">437</span></a>
</span><span id="MultiClouds.assemble_robs-438"><a href="#MultiClouds.assemble_robs-438"><span class="linenos">438</span></a>            <span class="n">tslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;Robs&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="MultiClouds.assemble_robs-439"><a href="#MultiClouds.assemble_robs-439"><span class="linenos">439</span></a>            <span class="n">R_tslice</span><span class="p">[:,</span> <span class="n">ccount</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">su_list</span><span class="p">))]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tslice</span><span class="p">[:,</span> <span class="n">su_list</span><span class="p">])</span>
</span><span id="MultiClouds.assemble_robs-440"><a href="#MultiClouds.assemble_robs-440"><span class="linenos">440</span></a>            <span class="n">tslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;datafilts&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="MultiClouds.assemble_robs-441"><a href="#MultiClouds.assemble_robs-441"><span class="linenos">441</span></a>            <span class="c1"># Also take valid_data into account</span>
</span><span id="MultiClouds.assemble_robs-442"><a href="#MultiClouds.assemble_robs-442"><span class="linenos">442</span></a>            <span class="n">df_tslice</span><span class="p">[:,</span> <span class="n">ccount</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">su_list</span><span class="p">))]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tslice</span><span class="p">[:,</span> <span class="n">su_list</span><span class="p">])</span> <span class="o">*</span> <span class="n">valid_data</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="MultiClouds.assemble_robs-443"><a href="#MultiClouds.assemble_robs-443"><span class="linenos">443</span></a>            <span class="n">ccount</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">su_list</span><span class="p">)</span>
</span><span id="MultiClouds.assemble_robs-444"><a href="#MultiClouds.assemble_robs-444"><span class="linenos">444</span></a>
</span><span id="MultiClouds.assemble_robs-445"><a href="#MultiClouds.assemble_robs-445"><span class="linenos">445</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="MultiClouds.assemble_robs-446"><a href="#MultiClouds.assemble_robs-446"><span class="linenos">446</span></a>                <span class="n">NMUs</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;NMUs&#39;</span><span class="p">]</span>
</span><span id="MultiClouds.assemble_robs-447"><a href="#MultiClouds.assemble_robs-447"><span class="linenos">447</span></a>                <span class="n">mu_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">NSUs</span><span class="p">]</span><span class="o">-</span><span class="n">NSUs</span>
</span><span id="MultiClouds.assemble_robs-448"><a href="#MultiClouds.assemble_robs-448"><span class="linenos">448</span></a>                <span class="n">tslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="MultiClouds.assemble_robs-449"><a href="#MultiClouds.assemble_robs-449"><span class="linenos">449</span></a>                <span class="n">R_tslice</span><span class="p">[:,</span> <span class="n">ccount</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mu_list</span><span class="p">))]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tslice</span><span class="p">[:,</span> <span class="n">mu_list</span><span class="p">])</span>
</span><span id="MultiClouds.assemble_robs-450"><a href="#MultiClouds.assemble_robs-450"><span class="linenos">450</span></a>                <span class="n">tslice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ff</span><span class="p">][</span><span class="s1">&#39;datafiltsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="MultiClouds.assemble_robs-451"><a href="#MultiClouds.assemble_robs-451"><span class="linenos">451</span></a>                <span class="n">df_tslice</span><span class="p">[:,</span> <span class="n">ccount</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mu_list</span><span class="p">))]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tslice</span><span class="p">[:,</span> <span class="n">mu_list</span><span class="p">])</span> <span class="o">*</span> <span class="n">valid_data</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="MultiClouds.assemble_robs-452"><a href="#MultiClouds.assemble_robs-452"><span class="linenos">452</span></a>                <span class="n">ccount</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu_list</span><span class="p">)</span>
</span><span id="MultiClouds.assemble_robs-453"><a href="#MultiClouds.assemble_robs-453"><span class="linenos">453</span></a>
</span><span id="MultiClouds.assemble_robs-454"><a href="#MultiClouds.assemble_robs-454"><span class="linenos">454</span></a>            <span class="c1"># Check that clipping to uint8 wont screw up any robs</span>
</span><span id="MultiClouds.assemble_robs-455"><a href="#MultiClouds.assemble_robs-455"><span class="linenos">455</span></a>            <span class="n">robs_ceil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">R_tslice</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
</span><span id="MultiClouds.assemble_robs-456"><a href="#MultiClouds.assemble_robs-456"><span class="linenos">456</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">robs_ceil</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds.assemble_robs-457"><a href="#MultiClouds.assemble_robs-457"><span class="linenos">457</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Neurons in expt </span><span class="si">%d</span><span class="s2"> have single-bin spike counts above 255:&quot;</span><span class="o">%</span><span class="n">ff</span><span class="p">,</span> <span class="n">robs_ceil</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="MultiClouds.assemble_robs-458"><a href="#MultiClouds.assemble_robs-458"><span class="linenos">458</span></a>                <span class="c1"># Currently do nothing -- this willbe modded: but if problems should probably make dfs = 0 there</span>
</span><span id="MultiClouds.assemble_robs-459"><a href="#MultiClouds.assemble_robs-459"><span class="linenos">459</span></a>
</span><span id="MultiClouds.assemble_robs-460"><a href="#MultiClouds.assemble_robs-460"><span class="linenos">460</span></a>            <span class="c1"># Write tslice into </span>
</span><span id="MultiClouds.assemble_robs-461"><a href="#MultiClouds.assemble_robs-461"><span class="linenos">461</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">tcount</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NTexpt</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span> <span class="n">R_tslice</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="p">)</span>
</span><span id="MultiClouds.assemble_robs-462"><a href="#MultiClouds.assemble_robs-462"><span class="linenos">462</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">tcount</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NTexpt</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span> <span class="n">df_tslice</span> <span class="p">)</span>
</span><span id="MultiClouds.assemble_robs-463"><a href="#MultiClouds.assemble_robs-463"><span class="linenos">463</span></a>
</span><span id="MultiClouds.assemble_robs-464"><a href="#MultiClouds.assemble_robs-464"><span class="linenos">464</span></a>            <span class="n">tcount</span> <span class="o">+=</span> <span class="n">NTexpt</span>
</span><span id="MultiClouds.assemble_robs-465"><a href="#MultiClouds.assemble_robs-465"><span class="linenos">465</span></a>
</span><span id="MultiClouds.assemble_robs-466"><a href="#MultiClouds.assemble_robs-466"><span class="linenos">466</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trialfilter_dfs</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Takes current information (robs and dfs) to make robs and dfs (full version)
Note this can be replaced by using the spike times explicitly</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiClouds.list_expts" class="classattr">
                                        <input id="MultiClouds.list_expts-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">list_expts</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.list_expts-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.list_expts"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.list_expts-469"><a href="#MultiClouds.list_expts-469"><span class="linenos">469</span></a>    <span class="k">def</span> <span class="nf">list_expts</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="MultiClouds.list_expts-470"><a href="#MultiClouds.list_expts-470"><span class="linenos">470</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.list_expts-471"><a href="#MultiClouds.list_expts-471"><span class="linenos">471</span></a><span class="sd">        Show filenames with experiment number</span>
</span><span id="MultiClouds.list_expts-472"><a href="#MultiClouds.list_expts-472"><span class="linenos">472</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.list_expts-473"><a href="#MultiClouds.list_expts-473"><span class="linenos">473</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">):</span>
</span><span id="MultiClouds.list_expts-474"><a href="#MultiClouds.list_expts-474"><span class="linenos">474</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%2d</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span> <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Show filenames with experiment number</p>
</div>


                            </div>
                            <div id="MultiClouds.updateDF" class="classattr">
                                        <input id="MultiClouds.updateDF-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">updateDF</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">expt_n</span>, </span><span class="param"><span class="n">dfs</span>, </span><span class="param"><span class="n">reduce_cells</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.updateDF-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.updateDF"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.updateDF-476"><a href="#MultiClouds.updateDF-476"><span class="linenos">476</span></a>    <span class="k">def</span> <span class="nf">updateDF</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">expt_n</span><span class="p">,</span> <span class="n">dfs</span><span class="p">,</span> <span class="n">reduce_cells</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="MultiClouds.updateDF-477"><a href="#MultiClouds.updateDF-477"><span class="linenos">477</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.updateDF-478"><a href="#MultiClouds.updateDF-478"><span class="linenos">478</span></a><span class="sd">        Import updated DF for given experiment, as numbered (can see with &#39;list_expts&#39;)</span>
</span><span id="MultiClouds.updateDF-479"><a href="#MultiClouds.updateDF-479"><span class="linenos">479</span></a><span class="sd">        Will check for neurons with no robs and reduce robs and dataset if reduce_cells=True</span>
</span><span id="MultiClouds.updateDF-480"><a href="#MultiClouds.updateDF-480"><span class="linenos">480</span></a><span class="sd">        </span>
</span><span id="MultiClouds.updateDF-481"><a href="#MultiClouds.updateDF-481"><span class="linenos">481</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds.updateDF-482"><a href="#MultiClouds.updateDF-482"><span class="linenos">482</span></a><span class="sd">            expt_n (int): index of the experiment</span>
</span><span id="MultiClouds.updateDF-483"><a href="#MultiClouds.updateDF-483"><span class="linenos">483</span></a><span class="sd">            dfs (np.array): array of new dfs</span>
</span><span id="MultiClouds.updateDF-484"><a href="#MultiClouds.updateDF-484"><span class="linenos">484</span></a><span class="sd">            reduce_cells (bool): whether to reduce the number of cells</span>
</span><span id="MultiClouds.updateDF-485"><a href="#MultiClouds.updateDF-485"><span class="linenos">485</span></a>
</span><span id="MultiClouds.updateDF-486"><a href="#MultiClouds.updateDF-486"><span class="linenos">486</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds.updateDF-487"><a href="#MultiClouds.updateDF-487"><span class="linenos">487</span></a><span class="sd">            None</span>
</span><span id="MultiClouds.updateDF-488"><a href="#MultiClouds.updateDF-488"><span class="linenos">488</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.updateDF-489"><a href="#MultiClouds.updateDF-489"><span class="linenos">489</span></a>
</span><span id="MultiClouds.updateDF-490"><a href="#MultiClouds.updateDF-490"><span class="linenos">490</span></a>        <span class="k">assert</span> <span class="n">expt_n</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">,</span> <span class="s2">&quot;updateDF: expt_n too large: not that many experiments&quot;</span>
</span><span id="MultiClouds.updateDF-491"><a href="#MultiClouds.updateDF-491"><span class="linenos">491</span></a>
</span><span id="MultiClouds.updateDF-492"><a href="#MultiClouds.updateDF-492"><span class="linenos">492</span></a>        <span class="c1"># if eye_config, then want to replace whole DFs, or relevant DFs </span>
</span><span id="MultiClouds.updateDF-493"><a href="#MultiClouds.updateDF-493"><span class="linenos">493</span></a>        <span class="k">if</span> <span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;NT&#39;</span><span class="p">]:</span>
</span><span id="MultiClouds.updateDF-494"><a href="#MultiClouds.updateDF-494"><span class="linenos">494</span></a>            <span class="c1"># Assume need to use trange</span>
</span><span id="MultiClouds.updateDF-495"><a href="#MultiClouds.updateDF-495"><span class="linenos">495</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">],</span> <span class="p">:]</span>
</span><span id="MultiClouds.updateDF-496"><a href="#MultiClouds.updateDF-496"><span class="linenos">496</span></a>        <span class="k">assert</span> <span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;NT&#39;</span><span class="p">],</span> <span class="s2">&quot;DF file mismatch: wrong length&quot;</span>
</span><span id="MultiClouds.updateDF-497"><a href="#MultiClouds.updateDF-497"><span class="linenos">497</span></a>        <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">]]</span>
</span><span id="MultiClouds.updateDF-498"><a href="#MultiClouds.updateDF-498"><span class="linenos">498</span></a>
</span><span id="MultiClouds.updateDF-499"><a href="#MultiClouds.updateDF-499"><span class="linenos">499</span></a>        <span class="c1"># Replace dfs with updated</span>
</span><span id="MultiClouds.updateDF-500"><a href="#MultiClouds.updateDF-500"><span class="linenos">500</span></a>        <span class="n">trange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_tstart</span><span class="p">[</span><span class="n">expt_n</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MultiClouds.updateDF-501"><a href="#MultiClouds.updateDF-501"><span class="linenos">501</span></a>        <span class="n">df_tslice</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">trange</span><span class="p">,</span> <span class="p">:]</span> <span class="p">)</span>
</span><span id="MultiClouds.updateDF-502"><a href="#MultiClouds.updateDF-502"><span class="linenos">502</span></a>        <span class="n">crange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">[</span><span class="n">expt_n</span><span class="p">])</span>
</span><span id="MultiClouds.updateDF-503"><a href="#MultiClouds.updateDF-503"><span class="linenos">503</span></a>        <span class="k">if</span> <span class="n">expt_n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds.updateDF-504"><a href="#MultiClouds.updateDF-504"><span class="linenos">504</span></a>            <span class="n">crange</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNC</span><span class="p">[:</span><span class="n">expt_n</span><span class="p">])</span>
</span><span id="MultiClouds.updateDF-505"><a href="#MultiClouds.updateDF-505"><span class="linenos">505</span></a>        <span class="n">df_tslice</span><span class="p">[:,</span> <span class="n">crange</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="MultiClouds.updateDF-506"><a href="#MultiClouds.updateDF-506"><span class="linenos">506</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">trange</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">df_tslice</span><span class="p">)</span>
</span><span id="MultiClouds.updateDF-507"><a href="#MultiClouds.updateDF-507"><span class="linenos">507</span></a>
</span><span id="MultiClouds.updateDF-508"><a href="#MultiClouds.updateDF-508"><span class="linenos">508</span></a>        <span class="k">if</span> <span class="n">reduce_cells</span><span class="p">:</span>
</span><span id="MultiClouds.updateDF-509"><a href="#MultiClouds.updateDF-509"><span class="linenos">509</span></a>            <span class="n">elim_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.updateDF-510"><a href="#MultiClouds.updateDF-510"><span class="linenos">510</span></a>            <span class="k">if</span> <span class="n">elim_cells</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds.updateDF-511"><a href="#MultiClouds.updateDF-511"><span class="linenos">511</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  reduce_cells not implemented yet&#39;</span><span class="p">)</span>
</span><span id="MultiClouds.updateDF-512"><a href="#MultiClouds.updateDF-512"><span class="linenos">512</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39; Cells to reduce:&#39;</span><span class="p">,</span> <span class="n">elim_cells</span> <span class="p">)</span>
</span><span id="MultiClouds.updateDF-513"><a href="#MultiClouds.updateDF-513"><span class="linenos">513</span></a>        
</span><span id="MultiClouds.updateDF-514"><a href="#MultiClouds.updateDF-514"><span class="linenos">514</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trialfilter_dfs</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Import updated DF for given experiment, as numbered (can see with 'list_expts')
Will check for neurons with no robs and reduce robs and dataset if reduce_cells=True</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>expt_n (int):</strong>  index of the experiment</li>
<li><strong>dfs (np.array):</strong>  array of new dfs</li>
<li><strong>reduce_cells (bool):</strong>  whether to reduce the number of cells</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiClouds.trialfilter_dfs" class="classattr">
                                        <input id="MultiClouds.trialfilter_dfs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">trialfilter_dfs</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.trialfilter_dfs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.trialfilter_dfs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.trialfilter_dfs-517"><a href="#MultiClouds.trialfilter_dfs-517"><span class="linenos">517</span></a>    <span class="k">def</span> <span class="nf">trialfilter_dfs</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="MultiClouds.trialfilter_dfs-518"><a href="#MultiClouds.trialfilter_dfs-518"><span class="linenos">518</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.trialfilter_dfs-519"><a href="#MultiClouds.trialfilter_dfs-519"><span class="linenos">519</span></a><span class="sd">        Zeros out dfs at the beginning of trials up to num_lags</span>
</span><span id="MultiClouds.trialfilter_dfs-520"><a href="#MultiClouds.trialfilter_dfs-520"><span class="linenos">520</span></a><span class="sd">        </span>
</span><span id="MultiClouds.trialfilter_dfs-521"><a href="#MultiClouds.trialfilter_dfs-521"><span class="linenos">521</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds.trialfilter_dfs-522"><a href="#MultiClouds.trialfilter_dfs-522"><span class="linenos">522</span></a><span class="sd">            None</span>
</span><span id="MultiClouds.trialfilter_dfs-523"><a href="#MultiClouds.trialfilter_dfs-523"><span class="linenos">523</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.trialfilter_dfs-524"><a href="#MultiClouds.trialfilter_dfs-524"><span class="linenos">524</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds.trialfilter_dfs-525"><a href="#MultiClouds.trialfilter_dfs-525"><span class="linenos">525</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)):</span>
</span><span id="MultiClouds.trialfilter_dfs-526"><a href="#MultiClouds.trialfilter_dfs-526"><span class="linenos">526</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
</span></pre></div>


            <div class="docstring"><p>Zeros out dfs at the beginning of trials up to num_lags</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiClouds.assemble_saccade_inds" class="classattr">
                                        <input id="MultiClouds.assemble_saccade_inds-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">assemble_saccade_inds</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.assemble_saccade_inds-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.assemble_saccade_inds"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.assemble_saccade_inds-528"><a href="#MultiClouds.assemble_saccade_inds-528"><span class="linenos">528</span></a>    <span class="k">def</span> <span class="nf">assemble_saccade_inds</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="MultiClouds.assemble_saccade_inds-529"><a href="#MultiClouds.assemble_saccade_inds-529"><span class="linenos">529</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.assemble_saccade_inds-530"><a href="#MultiClouds.assemble_saccade_inds-530"><span class="linenos">530</span></a><span class="sd">        Assemble saccade indices for all experiments</span>
</span><span id="MultiClouds.assemble_saccade_inds-531"><a href="#MultiClouds.assemble_saccade_inds-531"><span class="linenos">531</span></a>
</span><span id="MultiClouds.assemble_saccade_inds-532"><a href="#MultiClouds.assemble_saccade_inds-532"><span class="linenos">532</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds.assemble_saccade_inds-533"><a href="#MultiClouds.assemble_saccade_inds-533"><span class="linenos">533</span></a><span class="sd">            None</span>
</span><span id="MultiClouds.assemble_saccade_inds-534"><a href="#MultiClouds.assemble_saccade_inds-534"><span class="linenos">534</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.assemble_saccade_inds-535"><a href="#MultiClouds.assemble_saccade_inds-535"><span class="linenos">535</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Currently not implemented -- needs to have microsaccades labeled well with time first&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Assemble saccade indices for all experiments</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiClouds.is_fixpoint_present" class="classattr">
                                        <input id="MultiClouds.is_fixpoint_present-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">is_fixpoint_present</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">boxlim</span>, </span><span class="param"><span class="n">expt_n</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.is_fixpoint_present-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.is_fixpoint_present"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.is_fixpoint_present-537"><a href="#MultiClouds.is_fixpoint_present-537"><span class="linenos">537</span></a>    <span class="k">def</span> <span class="nf">is_fixpoint_present</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">boxlim</span><span class="p">,</span> <span class="n">expt_n</span> <span class="p">):</span>
</span><span id="MultiClouds.is_fixpoint_present-538"><a href="#MultiClouds.is_fixpoint_present-538"><span class="linenos">538</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.is_fixpoint_present-539"><a href="#MultiClouds.is_fixpoint_present-539"><span class="linenos">539</span></a><span class="sd">        Return if any of fixation point is within the box given by top-left to bottom-right corner</span>
</span><span id="MultiClouds.is_fixpoint_present-540"><a href="#MultiClouds.is_fixpoint_present-540"><span class="linenos">540</span></a><span class="sd">        </span>
</span><span id="MultiClouds.is_fixpoint_present-541"><a href="#MultiClouds.is_fixpoint_present-541"><span class="linenos">541</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds.is_fixpoint_present-542"><a href="#MultiClouds.is_fixpoint_present-542"><span class="linenos">542</span></a><span class="sd">            boxlim (list): list of four numbers (top-left, bot-right)</span>
</span><span id="MultiClouds.is_fixpoint_present-543"><a href="#MultiClouds.is_fixpoint_present-543"><span class="linenos">543</span></a><span class="sd">            expt_n (int): index of the experiment</span>
</span><span id="MultiClouds.is_fixpoint_present-544"><a href="#MultiClouds.is_fixpoint_present-544"><span class="linenos">544</span></a>
</span><span id="MultiClouds.is_fixpoint_present-545"><a href="#MultiClouds.is_fixpoint_present-545"><span class="linenos">545</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds.is_fixpoint_present-546"><a href="#MultiClouds.is_fixpoint_present-546"><span class="linenos">546</span></a><span class="sd">            bool: whether the fixation point is present</span>
</span><span id="MultiClouds.is_fixpoint_present-547"><a href="#MultiClouds.is_fixpoint_present-547"><span class="linenos">547</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.is_fixpoint_present-548"><a href="#MultiClouds.is_fixpoint_present-548"><span class="linenos">548</span></a>        <span class="n">fix_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;fix_loc&#39;</span><span class="p">]</span>
</span><span id="MultiClouds.is_fixpoint_present-549"><a href="#MultiClouds.is_fixpoint_present-549"><span class="linenos">549</span></a>        <span class="k">if</span> <span class="n">fix_loc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.is_fixpoint_present-550"><a href="#MultiClouds.is_fixpoint_present-550"><span class="linenos">550</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="MultiClouds.is_fixpoint_present-551"><a href="#MultiClouds.is_fixpoint_present-551"><span class="linenos">551</span></a>        <span class="n">fix_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;fix_size&#39;</span><span class="p">]</span>
</span><span id="MultiClouds.is_fixpoint_present-552"><a href="#MultiClouds.is_fixpoint_present-552"><span class="linenos">552</span></a>        <span class="n">fix_present</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="MultiClouds.is_fixpoint_present-553"><a href="#MultiClouds.is_fixpoint_present-553"><span class="linenos">553</span></a>        <span class="c1">#if self.file_info[expt_n][&#39;stim_loc&#39;].shape[1] == 1:</span>
</span><span id="MultiClouds.is_fixpoint_present-554"><a href="#MultiClouds.is_fixpoint_present-554"><span class="linenos">554</span></a>        <span class="c1"># if there is multiple windows, needs to be manual: so this is the automatic check:</span>
</span><span id="MultiClouds.is_fixpoint_present-555"><a href="#MultiClouds.is_fixpoint_present-555"><span class="linenos">555</span></a>        <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="MultiClouds.is_fixpoint_present-556"><a href="#MultiClouds.is_fixpoint_present-556"><span class="linenos">556</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">fix_loc</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">-</span><span class="n">boxlim</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">fix_size</span><span class="p">):</span>
</span><span id="MultiClouds.is_fixpoint_present-557"><a href="#MultiClouds.is_fixpoint_present-557"><span class="linenos">557</span></a>                <span class="n">fix_present</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="MultiClouds.is_fixpoint_present-558"><a href="#MultiClouds.is_fixpoint_present-558"><span class="linenos">558</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">fix_loc</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">-</span><span class="n">boxlim</span><span class="p">[</span><span class="n">dd</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">fix_size</span><span class="p">):</span>
</span><span id="MultiClouds.is_fixpoint_present-559"><a href="#MultiClouds.is_fixpoint_present-559"><span class="linenos">559</span></a>                <span class="n">fix_present</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="MultiClouds.is_fixpoint_present-560"><a href="#MultiClouds.is_fixpoint_present-560"><span class="linenos">560</span></a>        <span class="k">return</span> <span class="n">fix_present</span>
</span></pre></div>


            <div class="docstring"><p>Return if any of fixation point is within the box given by top-left to bottom-right corner</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>boxlim (list):</strong>  list of four numbers (top-left, bot-right)</li>
<li><strong>expt_n (int):</strong>  index of the experiment</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>bool: whether the fixation point is present</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiClouds.build_stim" class="classattr">
                                        <input id="MultiClouds.build_stim-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">build_stim</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">expt_n</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">which_stim</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">top_corner</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">L</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">time_embed</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">eyepos</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">BUF</span><span class="o">=</span><span class="mi">20</span>,</span><span class="param">	<span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">LMS</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">fixdot</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.build_stim-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.build_stim"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.build_stim-563"><a href="#MultiClouds.build_stim-563"><span class="linenos">563</span></a>    <span class="k">def</span> <span class="nf">build_stim</span><span class="p">(</span>
</span><span id="MultiClouds.build_stim-564"><a href="#MultiClouds.build_stim-564"><span class="linenos">564</span></a>            <span class="bp">self</span><span class="p">,</span> <span class="n">expt_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MultiClouds.build_stim-565"><a href="#MultiClouds.build_stim-565"><span class="linenos">565</span></a>            <span class="n">which_stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">top_corner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># position of stim</span>
</span><span id="MultiClouds.build_stim-566"><a href="#MultiClouds.build_stim-566"><span class="linenos">566</span></a>            <span class="n">time_embed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
</span><span id="MultiClouds.build_stim-567"><a href="#MultiClouds.build_stim-567"><span class="linenos">567</span></a>            <span class="n">eyepos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">BUF</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="c1"># eye position (not shifts)</span>
</span><span id="MultiClouds.build_stim-568"><a href="#MultiClouds.build_stim-568"><span class="linenos">568</span></a>            <span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MultiClouds.build_stim-569"><a href="#MultiClouds.build_stim-569"><span class="linenos">569</span></a>            <span class="n">LMS</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="MultiClouds.build_stim-570"><a href="#MultiClouds.build_stim-570"><span class="linenos">570</span></a>            <span class="n">fixdot</span><span class="o">=</span><span class="mi">0</span> <span class="p">):</span>
</span><span id="MultiClouds.build_stim-571"><a href="#MultiClouds.build_stim-571"><span class="linenos">571</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.build_stim-572"><a href="#MultiClouds.build_stim-572"><span class="linenos">572</span></a><span class="sd">        This assembles a stimulus from the raw numpy-stored stimuli into self.stim</span>
</span><span id="MultiClouds.build_stim-573"><a href="#MultiClouds.build_stim-573"><span class="linenos">573</span></a><span class="sd">        which_stim: determines what stimulus is assembled from &#39;ET&#39;=0, &#39;lam&#39;=1, None</span>
</span><span id="MultiClouds.build_stim-574"><a href="#MultiClouds.build_stim-574"><span class="linenos">574</span></a><span class="sd">            If none, will need top_corner present: can specify with four numbers (top-left, bot-right)</span>
</span><span id="MultiClouds.build_stim-575"><a href="#MultiClouds.build_stim-575"><span class="linenos">575</span></a><span class="sd">            or just top_corner and L</span>
</span><span id="MultiClouds.build_stim-576"><a href="#MultiClouds.build_stim-576"><span class="linenos">576</span></a><span class="sd">        which is torch.tensor on default device</span>
</span><span id="MultiClouds.build_stim-577"><a href="#MultiClouds.build_stim-577"><span class="linenos">577</span></a><span class="sd">        stim_wrap: only works if using &#39;which_stim&#39;, and will be [hwrap, vwrap]</span>
</span><span id="MultiClouds.build_stim-578"><a href="#MultiClouds.build_stim-578"><span class="linenos">578</span></a><span class="sd">        </span>
</span><span id="MultiClouds.build_stim-579"><a href="#MultiClouds.build_stim-579"><span class="linenos">579</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds.build_stim-580"><a href="#MultiClouds.build_stim-580"><span class="linenos">580</span></a><span class="sd">            expt_n (int): index of the experiment</span>
</span><span id="MultiClouds.build_stim-581"><a href="#MultiClouds.build_stim-581"><span class="linenos">581</span></a><span class="sd">            which_stim (int or str): which stimulus to use</span>
</span><span id="MultiClouds.build_stim-582"><a href="#MultiClouds.build_stim-582"><span class="linenos">582</span></a><span class="sd">            top_corner (list): top corner of the stimulus</span>
</span><span id="MultiClouds.build_stim-583"><a href="#MultiClouds.build_stim-583"><span class="linenos">583</span></a><span class="sd">            L (int): size of the stimulus</span>
</span><span id="MultiClouds.build_stim-584"><a href="#MultiClouds.build_stim-584"><span class="linenos">584</span></a><span class="sd">            time_embed (int): time embedding</span>
</span><span id="MultiClouds.build_stim-585"><a href="#MultiClouds.build_stim-585"><span class="linenos">585</span></a><span class="sd">            eyepos (np.array): eye position</span>
</span><span id="MultiClouds.build_stim-586"><a href="#MultiClouds.build_stim-586"><span class="linenos">586</span></a><span class="sd">            BUF (int): buffer for eye position</span>
</span><span id="MultiClouds.build_stim-587"><a href="#MultiClouds.build_stim-587"><span class="linenos">587</span></a><span class="sd">            stim_crop (list): crop the stimulus</span>
</span><span id="MultiClouds.build_stim-588"><a href="#MultiClouds.build_stim-588"><span class="linenos">588</span></a><span class="sd">            LMS (bool): whether to use LMS</span>
</span><span id="MultiClouds.build_stim-589"><a href="#MultiClouds.build_stim-589"><span class="linenos">589</span></a><span class="sd">            fixdot (int): fixation point</span>
</span><span id="MultiClouds.build_stim-590"><a href="#MultiClouds.build_stim-590"><span class="linenos">590</span></a>
</span><span id="MultiClouds.build_stim-591"><a href="#MultiClouds.build_stim-591"><span class="linenos">591</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds.build_stim-592"><a href="#MultiClouds.build_stim-592"><span class="linenos">592</span></a><span class="sd">            None</span>
</span><span id="MultiClouds.build_stim-593"><a href="#MultiClouds.build_stim-593"><span class="linenos">593</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.build_stim-594"><a href="#MultiClouds.build_stim-594"><span class="linenos">594</span></a>
</span><span id="MultiClouds.build_stim-595"><a href="#MultiClouds.build_stim-595"><span class="linenos">595</span></a>        <span class="c1">#eyepos = shifts   # shifts that is passed in is actually the eye position</span>
</span><span id="MultiClouds.build_stim-596"><a href="#MultiClouds.build_stim-596"><span class="linenos">596</span></a>
</span><span id="MultiClouds.build_stim-597"><a href="#MultiClouds.build_stim-597"><span class="linenos">597</span></a>        <span class="k">assert</span> <span class="n">expt_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;CONSTRUCT_STIMULUS: must specify expt_n&quot;</span>
</span><span id="MultiClouds.build_stim-598"><a href="#MultiClouds.build_stim-598"><span class="linenos">598</span></a>        <span class="c1"># Delete existing stim and clear cache to prevent memory issues on GPU</span>
</span><span id="MultiClouds.build_stim-599"><a href="#MultiClouds.build_stim-599"><span class="linenos">599</span></a>
</span><span id="MultiClouds.build_stim-600"><a href="#MultiClouds.build_stim-600"><span class="linenos">600</span></a>        <span class="n">need2crop</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="MultiClouds.build_stim-601"><a href="#MultiClouds.build_stim-601"><span class="linenos">601</span></a>        <span class="k">if</span> <span class="n">LMS</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-602"><a href="#MultiClouds.build_stim-602"><span class="linenos">602</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">,</span> <span class="s2">&quot;Cannot convert color spaces if luminance-only.&quot;</span>
</span><span id="MultiClouds.build_stim-603"><a href="#MultiClouds.build_stim-603"><span class="linenos">603</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">LMS</span> <span class="o">=</span> <span class="n">LMS</span>
</span><span id="MultiClouds.build_stim-604"><a href="#MultiClouds.build_stim-604"><span class="linenos">604</span></a>
</span><span id="MultiClouds.build_stim-605"><a href="#MultiClouds.build_stim-605"><span class="linenos">605</span></a>        <span class="k">if</span> <span class="n">which_stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-606"><a href="#MultiClouds.build_stim-606"><span class="linenos">606</span></a>            <span class="k">assert</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;CONSTRUCT_STIMULUS: cannot specify L if using which_stim (i.e. prepackaged stim)&quot;</span>
</span><span id="MultiClouds.build_stim-607"><a href="#MultiClouds.build_stim-607"><span class="linenos">607</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_stim</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="MultiClouds.build_stim-608"><a href="#MultiClouds.build_stim-608"><span class="linenos">608</span></a>                <span class="k">if</span> <span class="n">which_stim</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ET&#39;</span><span class="p">,</span> <span class="s1">&#39;et&#39;</span><span class="p">,</span> <span class="s1">&#39;stimET&#39;</span><span class="p">]:</span>
</span><span id="MultiClouds.build_stim-609"><a href="#MultiClouds.build_stim-609"><span class="linenos">609</span></a>                    <span class="n">which_stim</span><span class="o">=</span><span class="mi">0</span>
</span><span id="MultiClouds.build_stim-610"><a href="#MultiClouds.build_stim-610"><span class="linenos">610</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-611"><a href="#MultiClouds.build_stim-611"><span class="linenos">611</span></a>                    <span class="n">which_stim</span><span class="o">=</span><span class="mi">1</span>
</span><span id="MultiClouds.build_stim-612"><a href="#MultiClouds.build_stim-612"><span class="linenos">612</span></a>            <span class="k">if</span> <span class="n">which_stim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-613"><a href="#MultiClouds.build_stim-613"><span class="linenos">613</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Stim #</span><span class="si">%d</span><span class="s2">: using ET stimulus&quot;</span><span class="p">,</span> <span class="n">expt_n</span> <span class="p">)</span>
</span><span id="MultiClouds.build_stim-614"><a href="#MultiClouds.build_stim-614"><span class="linenos">614</span></a>                <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="MultiClouds.build_stim-615"><a href="#MultiClouds.build_stim-615"><span class="linenos">615</span></a>                <span class="c1">#self.stim_pos = self.stim_locationET[:,0]</span>
</span><span id="MultiClouds.build_stim-616"><a href="#MultiClouds.build_stim-616"><span class="linenos">616</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-617"><a href="#MultiClouds.build_stim-617"><span class="linenos">617</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Stim #</span><span class="si">%d</span><span class="s2">: using laminar probe stimulus&quot;</span><span class="p">,</span> <span class="n">expt_n</span> <span class="p">)</span>
</span><span id="MultiClouds.build_stim-618"><a href="#MultiClouds.build_stim-618"><span class="linenos">618</span></a>                <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="MultiClouds.build_stim-619"><a href="#MultiClouds.build_stim-619"><span class="linenos">619</span></a>                <span class="c1">#self.stim_pos = self.stim_location[:, 0]</span>
</span><span id="MultiClouds.build_stim-620"><a href="#MultiClouds.build_stim-620"><span class="linenos">620</span></a>
</span><span id="MultiClouds.build_stim-621"><a href="#MultiClouds.build_stim-621"><span class="linenos">621</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-622"><a href="#MultiClouds.build_stim-622"><span class="linenos">622</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="n">stim_tmp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-623"><a href="#MultiClouds.build_stim-623"><span class="linenos">623</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-624"><a href="#MultiClouds.build_stim-624"><span class="linenos">624</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="n">stim_tmp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-625"><a href="#MultiClouds.build_stim-625"><span class="linenos">625</span></a>            
</span><span id="MultiClouds.build_stim-626"><a href="#MultiClouds.build_stim-626"><span class="linenos">626</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">newstim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-627"><a href="#MultiClouds.build_stim-627"><span class="linenos">627</span></a>            <span class="c1"># Forget binocular for now</span>
</span><span id="MultiClouds.build_stim-628"><a href="#MultiClouds.build_stim-628"><span class="linenos">628</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-629"><a href="#MultiClouds.build_stim-629"><span class="linenos">629</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;currently not implemented&#39;</span><span class="p">)</span>
</span><span id="MultiClouds.build_stim-630"><a href="#MultiClouds.build_stim-630"><span class="linenos">630</span></a>
</span><span id="MultiClouds.build_stim-631"><a href="#MultiClouds.build_stim-631"><span class="linenos">631</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-632"><a href="#MultiClouds.build_stim-632"><span class="linenos">632</span></a>            <span class="c1"># Assemble from combination of ET and laminer probe (NP) stimulus</span>
</span><span id="MultiClouds.build_stim-633"><a href="#MultiClouds.build_stim-633"><span class="linenos">633</span></a>            <span class="k">assert</span> <span class="n">top_corner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need top corner if which_stim unspecified&quot;</span>
</span><span id="MultiClouds.build_stim-634"><a href="#MultiClouds.build_stim-634"><span class="linenos">634</span></a>            <span class="k">assert</span> <span class="n">stim_crop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Cannot specify stim_crop and top_corner&quot;</span>
</span><span id="MultiClouds.build_stim-635"><a href="#MultiClouds.build_stim-635"><span class="linenos">635</span></a>
</span><span id="MultiClouds.build_stim-636"><a href="#MultiClouds.build_stim-636"><span class="linenos">636</span></a>            <span class="c1"># Determine stim location</span>
</span><span id="MultiClouds.build_stim-637"><a href="#MultiClouds.build_stim-637"><span class="linenos">637</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_corner</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-638"><a href="#MultiClouds.build_stim-638"><span class="linenos">638</span></a>                <span class="n">stim_pos</span> <span class="o">=</span> <span class="n">top_corner</span>
</span><span id="MultiClouds.build_stim-639"><a href="#MultiClouds.build_stim-639"><span class="linenos">639</span></a>                <span class="c1">#L = self.stim_pos[2]-self.stim_pos[0]</span>
</span><span id="MultiClouds.build_stim-640"><a href="#MultiClouds.build_stim-640"><span class="linenos">640</span></a>                <span class="k">assert</span> <span class="n">stim_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">stim_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Stim must be square (for now)&quot;</span>
</span><span id="MultiClouds.build_stim-641"><a href="#MultiClouds.build_stim-641"><span class="linenos">641</span></a>                <span class="k">if</span> <span class="n">L</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-642"><a href="#MultiClouds.build_stim-642"><span class="linenos">642</span></a>                    <span class="k">assert</span> <span class="n">L</span> <span class="o">==</span> <span class="n">stim_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;L does not match specified stim size&quot;</span>
</span><span id="MultiClouds.build_stim-643"><a href="#MultiClouds.build_stim-643"><span class="linenos">643</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-644"><a href="#MultiClouds.build_stim-644"><span class="linenos">644</span></a>                    <span class="n">L</span> <span class="o">=</span> <span class="n">stim_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-645"><a href="#MultiClouds.build_stim-645"><span class="linenos">645</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-646"><a href="#MultiClouds.build_stim-646"><span class="linenos">646</span></a>                <span class="k">if</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-647"><a href="#MultiClouds.build_stim-647"><span class="linenos">647</span></a>                    <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span>
</span><span id="MultiClouds.build_stim-648"><a href="#MultiClouds.build_stim-648"><span class="linenos">648</span></a>                <span class="k">assert</span> <span class="n">L</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to specify stimulus size&quot;</span>
</span><span id="MultiClouds.build_stim-649"><a href="#MultiClouds.build_stim-649"><span class="linenos">649</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-650"><a href="#MultiClouds.build_stim-650"><span class="linenos">650</span></a>                    <span class="k">assert</span> <span class="n">L</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="s2">&quot;BUILD_STIM: size of stimuli much match. L=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span> 
</span><span id="MultiClouds.build_stim-651"><a href="#MultiClouds.build_stim-651"><span class="linenos">651</span></a>
</span><span id="MultiClouds.build_stim-652"><a href="#MultiClouds.build_stim-652"><span class="linenos">652</span></a>                <span class="n">stim_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">top_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">top_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">top_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">L</span><span class="p">,</span> <span class="n">top_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">L</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-653"><a href="#MultiClouds.build_stim-653"><span class="linenos">653</span></a>
</span><span id="MultiClouds.build_stim-654"><a href="#MultiClouds.build_stim-654"><span class="linenos">654</span></a>            <span class="k">if</span> <span class="n">eyepos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-655"><a href="#MultiClouds.build_stim-655"><span class="linenos">655</span></a>                <span class="n">need2crop</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="MultiClouds.build_stim-656"><a href="#MultiClouds.build_stim-656"><span class="linenos">656</span></a>                <span class="c1"># Extend stim window by BUFF-per-side in each direction</span>
</span><span id="MultiClouds.build_stim-657"><a href="#MultiClouds.build_stim-657"><span class="linenos">657</span></a>                <span class="n">stim_pos</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="MultiClouds.build_stim-658"><a href="#MultiClouds.build_stim-658"><span class="linenos">658</span></a>                    <span class="n">stim_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span>
</span><span id="MultiClouds.build_stim-659"><a href="#MultiClouds.build_stim-659"><span class="linenos">659</span></a>                    <span class="n">stim_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span>
</span><span id="MultiClouds.build_stim-660"><a href="#MultiClouds.build_stim-660"><span class="linenos">660</span></a>                    <span class="n">stim_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">BUF</span><span class="p">,</span>
</span><span id="MultiClouds.build_stim-661"><a href="#MultiClouds.build_stim-661"><span class="linenos">661</span></a>                    <span class="n">stim_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">BUF</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-662"><a href="#MultiClouds.build_stim-662"><span class="linenos">662</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Stim expansion for shift:&quot;</span><span class="p">,</span> <span class="n">stim_pos</span><span class="p">)</span>
</span><span id="MultiClouds.build_stim-663"><a href="#MultiClouds.build_stim-663"><span class="linenos">663</span></a>                <span class="n">L</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">BUF</span>
</span><span id="MultiClouds.build_stim-664"><a href="#MultiClouds.build_stim-664"><span class="linenos">664</span></a>
</span><span id="MultiClouds.build_stim-665"><a href="#MultiClouds.build_stim-665"><span class="linenos">665</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-666"><a href="#MultiClouds.build_stim-666"><span class="linenos">666</span></a>                <span class="n">num_clr</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MultiClouds.build_stim-667"><a href="#MultiClouds.build_stim-667"><span class="linenos">667</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-668"><a href="#MultiClouds.build_stim-668"><span class="linenos">668</span></a>                <span class="n">num_clr</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="MultiClouds.build_stim-669"><a href="#MultiClouds.build_stim-669"><span class="linenos">669</span></a>
</span><span id="MultiClouds.build_stim-670"><a href="#MultiClouds.build_stim-670"><span class="linenos">670</span></a>            <span class="c1"># Read in stimuli</span>
</span><span id="MultiClouds.build_stim-671"><a href="#MultiClouds.build_stim-671"><span class="linenos">671</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stimET&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-672"><a href="#MultiClouds.build_stim-672"><span class="linenos">672</span></a>                <span class="n">stimET_base</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MultiClouds.build_stim-673"><a href="#MultiClouds.build_stim-673"><span class="linenos">673</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-674"><a href="#MultiClouds.build_stim-674"><span class="linenos">674</span></a>                <span class="n">stimET_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stimET&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="MultiClouds.build_stim-675"><a href="#MultiClouds.build_stim-675"><span class="linenos">675</span></a>            
</span><span id="MultiClouds.build_stim-676"><a href="#MultiClouds.build_stim-676"><span class="linenos">676</span></a>            <span class="n">locsET</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stim_locsET&#39;</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-677"><a href="#MultiClouds.build_stim-677"><span class="linenos">677</span></a>            <span class="n">stimLP_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stim&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="MultiClouds.build_stim-678"><a href="#MultiClouds.build_stim-678"><span class="linenos">678</span></a>            <span class="n">locsLP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stim_locsLP&#39;</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-679"><a href="#MultiClouds.build_stim-679"><span class="linenos">679</span></a>            <span class="n">fhandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">expt_n</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-680"><a href="#MultiClouds.build_stim-680"><span class="linenos">680</span></a>            <span class="n">sz</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="MultiClouds.build_stim-681"><a href="#MultiClouds.build_stim-681"><span class="linenos">681</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds.build_stim-682"><a href="#MultiClouds.build_stim-682"><span class="linenos">682</span></a>
</span><span id="MultiClouds.build_stim-683"><a href="#MultiClouds.build_stim-683"><span class="linenos">683</span></a>            <span class="c1">#stimET_base = np.array(self.fhandles[expt_n][&#39;stimET&#39;][self.tranges[expt_n], ...], dtype=np.int8)</span>
</span><span id="MultiClouds.build_stim-684"><a href="#MultiClouds.build_stim-684"><span class="linenos">684</span></a>            <span class="c1">#stimLP_base = np.array(self.fhandles[expt_n][&#39;stim&#39;][self.tranges[expt_n], ...], dtype=np.int8)</span>
</span><span id="MultiClouds.build_stim-685"><a href="#MultiClouds.build_stim-685"><span class="linenos">685</span></a>            <span class="c1">#locsET = self.file_info[expt_n][&#39;stim_locsET&#39;]</span>
</span><span id="MultiClouds.build_stim-686"><a href="#MultiClouds.build_stim-686"><span class="linenos">686</span></a>            <span class="c1">#locsLP = self.file_info[expt_n][&#39;stim_locsLP&#39;]</span>
</span><span id="MultiClouds.build_stim-687"><a href="#MultiClouds.build_stim-687"><span class="linenos">687</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-688"><a href="#MultiClouds.build_stim-688"><span class="linenos">688</span></a>                <span class="n">num_clr</span> <span class="o">*=</span> <span class="mi">2</span>  <span class="c1"># make binocular be like just 2x more colors (channel dim)</span>
</span><span id="MultiClouds.build_stim-689"><a href="#MultiClouds.build_stim-689"><span class="linenos">689</span></a>                <span class="n">Lpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useLeye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-690"><a href="#MultiClouds.build_stim-690"><span class="linenos">690</span></a>                <span class="n">Rpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-691"><a href="#MultiClouds.build_stim-691"><span class="linenos">691</span></a>                <span class="n">LRpresent</span> <span class="o">=</span> <span class="n">Lpresent</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Rpresent</span>
</span><span id="MultiClouds.build_stim-692"><a href="#MultiClouds.build_stim-692"><span class="linenos">692</span></a>                <span class="n">Leye</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-693"><a href="#MultiClouds.build_stim-693"><span class="linenos">693</span></a>                <span class="n">Reye</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-694"><a href="#MultiClouds.build_stim-694"><span class="linenos">694</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">LRpresent</span><span class="p">),</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="MultiClouds.build_stim-695"><a href="#MultiClouds.build_stim-695"><span class="linenos">695</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span><span class="p">[</span><span class="n">LRpresent</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="MultiClouds.build_stim-696"><a href="#MultiClouds.build_stim-696"><span class="linenos">696</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span><span class="p">[</span><span class="n">LRpresent</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="MultiClouds.build_stim-697"><a href="#MultiClouds.build_stim-697"><span class="linenos">697</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span> 
</span><span id="MultiClouds.build_stim-698"><a href="#MultiClouds.build_stim-698"><span class="linenos">698</span></a>                    <span class="c1">#empty_stimET=np.zeros((np.shape(stimET)[0], 2, np.shape(stimET)[2], np.shape(stimET)[3]))</span>
</span><span id="MultiClouds.build_stim-699"><a href="#MultiClouds.build_stim-699"><span class="linenos">699</span></a>                    <span class="n">stimLP</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimLP_base</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimLP_base</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimLP_base</span><span class="p">)[</span><span class="mi">3</span><span class="p">]))</span>
</span><span id="MultiClouds.build_stim-700"><a href="#MultiClouds.build_stim-700"><span class="linenos">700</span></a>                    <span class="n">stimLP</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-701"><a href="#MultiClouds.build_stim-701"><span class="linenos">701</span></a>                    <span class="n">stimLP</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-702"><a href="#MultiClouds.build_stim-702"><span class="linenos">702</span></a>                    <span class="k">if</span> <span class="n">stimET_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-703"><a href="#MultiClouds.build_stim-703"><span class="linenos">703</span></a>                        <span class="n">stimET</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimET_base</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimET_base</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimET_base</span><span class="p">)[</span><span class="mi">3</span><span class="p">]))</span>
</span><span id="MultiClouds.build_stim-704"><a href="#MultiClouds.build_stim-704"><span class="linenos">704</span></a>                        <span class="n">stimET</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-705"><a href="#MultiClouds.build_stim-705"><span class="linenos">705</span></a>                        <span class="n">stimET</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-706"><a href="#MultiClouds.build_stim-706"><span class="linenos">706</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-707"><a href="#MultiClouds.build_stim-707"><span class="linenos">707</span></a>                    <span class="n">stimLP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimLP_base</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimLP_base</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimLP_base</span><span class="p">)[</span><span class="mi">3</span><span class="p">]))</span>
</span><span id="MultiClouds.build_stim-708"><a href="#MultiClouds.build_stim-708"><span class="linenos">708</span></a>                    <span class="n">stimLP</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-709"><a href="#MultiClouds.build_stim-709"><span class="linenos">709</span></a>                    <span class="n">stimLP</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-710"><a href="#MultiClouds.build_stim-710"><span class="linenos">710</span></a>                    <span class="k">if</span> <span class="n">stimET_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-711"><a href="#MultiClouds.build_stim-711"><span class="linenos">711</span></a>                        <span class="n">stimET</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimET_base</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimET_base</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">stimET_base</span><span class="p">)[</span><span class="mi">3</span><span class="p">]))</span>
</span><span id="MultiClouds.build_stim-712"><a href="#MultiClouds.build_stim-712"><span class="linenos">712</span></a>                        <span class="n">stimET</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-713"><a href="#MultiClouds.build_stim-713"><span class="linenos">713</span></a>                        <span class="n">stimET</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-714"><a href="#MultiClouds.build_stim-714"><span class="linenos">714</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-715"><a href="#MultiClouds.build_stim-715"><span class="linenos">715</span></a>                <span class="n">stimET</span><span class="o">=</span><span class="n">stimET_base</span>
</span><span id="MultiClouds.build_stim-716"><a href="#MultiClouds.build_stim-716"><span class="linenos">716</span></a>                <span class="n">stimLP</span><span class="o">=</span><span class="n">stimLP_base</span>
</span><span id="MultiClouds.build_stim-717"><a href="#MultiClouds.build_stim-717"><span class="linenos">717</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-718"><a href="#MultiClouds.build_stim-718"><span class="linenos">718</span></a>                    <span class="n">stimLP</span> <span class="o">=</span> <span class="n">stimLP</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-719"><a href="#MultiClouds.build_stim-719"><span class="linenos">719</span></a>                <span class="k">if</span> <span class="n">stimET_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-720"><a href="#MultiClouds.build_stim-720"><span class="linenos">720</span></a>                    <span class="c1"># stimET=stimET_base</span>
</span><span id="MultiClouds.build_stim-721"><a href="#MultiClouds.build_stim-721"><span class="linenos">721</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-722"><a href="#MultiClouds.build_stim-722"><span class="linenos">722</span></a>                        <span class="k">if</span> <span class="n">stimET_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
</span><span id="MultiClouds.build_stim-723"><a href="#MultiClouds.build_stim-723"><span class="linenos">723</span></a>                            <span class="n">stimET</span> <span class="o">=</span> <span class="n">stimET</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>  <span class="c1"># maintain 2nd dim (length 1)</span>
</span><span id="MultiClouds.build_stim-724"><a href="#MultiClouds.build_stim-724"><span class="linenos">724</span></a>         
</span><span id="MultiClouds.build_stim-725"><a href="#MultiClouds.build_stim-725"><span class="linenos">725</span></a>            <span class="n">NT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">expt_n</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-726"><a href="#MultiClouds.build_stim-726"><span class="linenos">726</span></a>            <span class="n">newstim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="n">num_clr</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span> <span class="p">)</span>
</span><span id="MultiClouds.build_stim-727"><a href="#MultiClouds.build_stim-727"><span class="linenos">727</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">locsLP</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="MultiClouds.build_stim-728"><a href="#MultiClouds.build_stim-728"><span class="linenos">728</span></a>                <span class="n">OVLP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_overlap_ranges</span><span class="p">(</span><span class="n">stim_pos</span><span class="p">,</span> <span class="n">locsLP</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">])</span>
</span><span id="MultiClouds.build_stim-729"><a href="#MultiClouds.build_stim-729"><span class="linenos">729</span></a>                <span class="k">if</span> <span class="n">OVLP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-730"><a href="#MultiClouds.build_stim-730"><span class="linenos">730</span></a>                    <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Writing lam stim </span><span class="si">%d</span><span class="s2">: overlap </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">])))</span>
</span><span id="MultiClouds.build_stim-731"><a href="#MultiClouds.build_stim-731"><span class="linenos">731</span></a>                    <span class="n">strip</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:])</span> <span class="c1">#np.zeros([self.NT, num_clr, len(OVLP[&#39;targetX&#39;]), L])</span>
</span><span id="MultiClouds.build_stim-732"><a href="#MultiClouds.build_stim-732"><span class="linenos">732</span></a>                    <span class="n">strip</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">((</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readX&#39;</span><span class="p">],</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readY&#39;</span><span class="p">]]))</span>
</span><span id="MultiClouds.build_stim-733"><a href="#MultiClouds.build_stim-733"><span class="linenos">733</span></a>                    <span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span>
</span><span id="MultiClouds.build_stim-734"><a href="#MultiClouds.build_stim-734"><span class="linenos">734</span></a>                
</span><span id="MultiClouds.build_stim-735"><a href="#MultiClouds.build_stim-735"><span class="linenos">735</span></a>            <span class="k">if</span> <span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>    
</span><span id="MultiClouds.build_stim-736"><a href="#MultiClouds.build_stim-736"><span class="linenos">736</span></a>                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">locsET</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="MultiClouds.build_stim-737"><a href="#MultiClouds.build_stim-737"><span class="linenos">737</span></a>                    <span class="n">OVLP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_overlap_ranges</span><span class="p">(</span><span class="n">stim_pos</span><span class="p">,</span> <span class="n">locsET</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">])</span>
</span><span id="MultiClouds.build_stim-738"><a href="#MultiClouds.build_stim-738"><span class="linenos">738</span></a>                    <span class="k">if</span> <span class="n">OVLP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-739"><a href="#MultiClouds.build_stim-739"><span class="linenos">739</span></a>                        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Writing ETstim </span><span class="si">%d</span><span class="s2">: overlap </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">])))</span>
</span><span id="MultiClouds.build_stim-740"><a href="#MultiClouds.build_stim-740"><span class="linenos">740</span></a>                        <span class="n">strip</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:])</span>
</span><span id="MultiClouds.build_stim-741"><a href="#MultiClouds.build_stim-741"><span class="linenos">741</span></a>                        <span class="n">strip</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">((</span><span class="n">stimET</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readX&#39;</span><span class="p">],</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readY&#39;</span><span class="p">]]))</span>
</span><span id="MultiClouds.build_stim-742"><a href="#MultiClouds.build_stim-742"><span class="linenos">742</span></a>                        <span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span> 
</span><span id="MultiClouds.build_stim-743"><a href="#MultiClouds.build_stim-743"><span class="linenos">743</span></a>
</span><span id="MultiClouds.build_stim-744"><a href="#MultiClouds.build_stim-744"><span class="linenos">744</span></a>            <span class="c1">#stim = torch.tensor( newstim, dtype=torch.float32, device=self.device )</span>
</span><span id="MultiClouds.build_stim-745"><a href="#MultiClouds.build_stim-745"><span class="linenos">745</span></a>        <span class="c1"># Note stim stored in numpy is being represented as full 3-d + 1 tensor (time, channels, NX, NY)</span>
</span><span id="MultiClouds.build_stim-746"><a href="#MultiClouds.build_stim-746"><span class="linenos">746</span></a>
</span><span id="MultiClouds.build_stim-747"><a href="#MultiClouds.build_stim-747"><span class="linenos">747</span></a>        <span class="c1"># Insert fixation point</span>
</span><span id="MultiClouds.build_stim-748"><a href="#MultiClouds.build_stim-748"><span class="linenos">748</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">fixdot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fixpoint_present</span><span class="p">(</span> <span class="n">stim_pos</span><span class="p">,</span> <span class="n">expt_n</span> <span class="p">):</span>
</span><span id="MultiClouds.build_stim-749"><a href="#MultiClouds.build_stim-749"><span class="linenos">749</span></a>            <span class="n">fixranges</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-750"><a href="#MultiClouds.build_stim-750"><span class="linenos">750</span></a>            <span class="n">fix_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;fix_loc&#39;</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-751"><a href="#MultiClouds.build_stim-751"><span class="linenos">751</span></a>            <span class="n">fix_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;fix_size&#39;</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-752"><a href="#MultiClouds.build_stim-752"><span class="linenos">752</span></a>            <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="MultiClouds.build_stim-753"><a href="#MultiClouds.build_stim-753"><span class="linenos">753</span></a>                <span class="n">fixranges</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
</span><span id="MultiClouds.build_stim-754"><a href="#MultiClouds.build_stim-754"><span class="linenos">754</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">fix_loc</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">-</span><span class="n">fix_size</span><span class="o">-</span><span class="n">stim_pos</span><span class="p">[</span><span class="n">dd</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="MultiClouds.build_stim-755"><a href="#MultiClouds.build_stim-755"><span class="linenos">755</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">fix_loc</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">+</span><span class="n">fix_size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">stim_pos</span><span class="p">[</span><span class="n">dd</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="n">stim_pos</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span> 
</span><span id="MultiClouds.build_stim-756"><a href="#MultiClouds.build_stim-756"><span class="linenos">756</span></a>                    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="MultiClouds.build_stim-757"><a href="#MultiClouds.build_stim-757"><span class="linenos">757</span></a>            <span class="c1"># Write the correct value to stim</span>
</span><span id="MultiClouds.build_stim-758"><a href="#MultiClouds.build_stim-758"><span class="linenos">758</span></a>            <span class="k">assert</span> <span class="n">fixdot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Haven&#39;t yet put in other fixdot settings than zero&quot;</span> 
</span><span id="MultiClouds.build_stim-759"><a href="#MultiClouds.build_stim-759"><span class="linenos">759</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Adding fixation point&#39;</span><span class="p">)</span>
</span><span id="MultiClouds.build_stim-760"><a href="#MultiClouds.build_stim-760"><span class="linenos">760</span></a>            <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">fixranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="MultiClouds.build_stim-761"><a href="#MultiClouds.build_stim-761"><span class="linenos">761</span></a>                <span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">fixranges</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds.build_stim-762"><a href="#MultiClouds.build_stim-762"><span class="linenos">762</span></a>
</span><span id="MultiClouds.build_stim-763"><a href="#MultiClouds.build_stim-763"><span class="linenos">763</span></a>        <span class="k">if</span> <span class="n">eyepos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-764"><a href="#MultiClouds.build_stim-764"><span class="linenos">764</span></a>            <span class="c1"># Would want to shift by input eye positions if input here</span>
</span><span id="MultiClouds.build_stim-765"><a href="#MultiClouds.build_stim-765"><span class="linenos">765</span></a>            <span class="c1">#print(&#39;eye-position shifting not implemented yet&#39;)</span>
</span><span id="MultiClouds.build_stim-766"><a href="#MultiClouds.build_stim-766"><span class="linenos">766</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Shifting stim...&#39;</span><span class="p">)</span>
</span><span id="MultiClouds.build_stim-767"><a href="#MultiClouds.build_stim-767"><span class="linenos">767</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eyepos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">newstim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="MultiClouds.build_stim-768"><a href="#MultiClouds.build_stim-768"><span class="linenos">768</span></a>                <span class="n">eyepos</span> <span class="o">=</span> <span class="n">eyepos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tranges</span><span class="p">[</span><span class="n">expt_n</span><span class="p">]]</span>
</span><span id="MultiClouds.build_stim-769"><a href="#MultiClouds.build_stim-769"><span class="linenos">769</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eyepos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">newstim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-770"><a href="#MultiClouds.build_stim-770"><span class="linenos">770</span></a>                <span class="n">eyepos_padded</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">newstim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="MultiClouds.build_stim-771"><a href="#MultiClouds.build_stim-771"><span class="linenos">771</span></a>                <span class="n">Lpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useLeye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-772"><a href="#MultiClouds.build_stim-772"><span class="linenos">772</span></a>                <span class="n">Rpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-773"><a href="#MultiClouds.build_stim-773"><span class="linenos">773</span></a>                <span class="n">LRpresent</span> <span class="o">=</span> <span class="n">Lpresent</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Rpresent</span>
</span><span id="MultiClouds.build_stim-774"><a href="#MultiClouds.build_stim-774"><span class="linenos">774</span></a>                <span class="n">bin_inds</span><span class="o">=</span><span class="n">inds</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span><span class="p">)]</span>
</span><span id="MultiClouds.build_stim-775"><a href="#MultiClouds.build_stim-775"><span class="linenos">775</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_inds</span><span class="p">)</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="n">eyepos</span><span class="p">):</span>
</span><span id="MultiClouds.build_stim-776"><a href="#MultiClouds.build_stim-776"><span class="linenos">776</span></a>                    <span class="n">eyepos_padded</span><span class="p">[</span><span class="n">bin_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">bin_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">eyepos</span><span class="p">)]</span><span class="o">=</span><span class="n">eyepos</span> <span class="c1">#Off by one errors, probably. </span>
</span><span id="MultiClouds.build_stim-777"><a href="#MultiClouds.build_stim-777"><span class="linenos">777</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-778"><a href="#MultiClouds.build_stim-778"><span class="linenos">778</span></a>                    <span class="n">eyepos_padded</span><span class="p">[</span><span class="n">bin_inds</span><span class="p">]</span><span class="o">=</span><span class="n">eyepos</span>
</span><span id="MultiClouds.build_stim-779"><a href="#MultiClouds.build_stim-779"><span class="linenos">779</span></a>                <span class="n">eyepos</span><span class="o">=</span><span class="n">eyepos_padded</span> 
</span><span id="MultiClouds.build_stim-780"><a href="#MultiClouds.build_stim-780"><span class="linenos">780</span></a>            <span class="k">if</span> <span class="n">num_clr</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>                 
</span><span id="MultiClouds.build_stim-781"><a href="#MultiClouds.build_stim-781"><span class="linenos">781</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_stim</span><span class="p">(</span> <span class="n">newstim</span><span class="p">,</span> <span class="n">eyepos</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="MultiClouds.build_stim-782"><a href="#MultiClouds.build_stim-782"><span class="linenos">782</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-783"><a href="#MultiClouds.build_stim-783"><span class="linenos">783</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_stim</span><span class="p">(</span><span class="n">newstim</span><span class="p">,</span> <span class="n">eyepos</span><span class="p">)</span> 
</span><span id="MultiClouds.build_stim-784"><a href="#MultiClouds.build_stim-784"><span class="linenos">784</span></a>
</span><span id="MultiClouds.build_stim-785"><a href="#MultiClouds.build_stim-785"><span class="linenos">785</span></a>        <span class="c1"># Reduce size back to original If expanded to handle shifts</span>
</span><span id="MultiClouds.build_stim-786"><a href="#MultiClouds.build_stim-786"><span class="linenos">786</span></a>        <span class="k">if</span> <span class="n">need2crop</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-787"><a href="#MultiClouds.build_stim-787"><span class="linenos">787</span></a>            <span class="c1">#assert self.stim_crop is None, &quot;Cannot crop stim at same time as shifting&quot;</span>
</span><span id="MultiClouds.build_stim-788"><a href="#MultiClouds.build_stim-788"><span class="linenos">788</span></a>            <span class="n">newstim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_stim</span><span class="p">(</span> <span class="n">newstim</span><span class="p">,</span> <span class="p">[</span><span class="n">BUF</span><span class="p">,</span> <span class="n">L</span><span class="o">-</span><span class="n">BUF</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">BUF</span><span class="p">,</span> <span class="n">L</span><span class="o">-</span><span class="n">BUF</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>  <span class="c1"># move back to original size</span>
</span><span id="MultiClouds.build_stim-789"><a href="#MultiClouds.build_stim-789"><span class="linenos">789</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">L</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">BUF</span>
</span><span id="MultiClouds.build_stim-790"><a href="#MultiClouds.build_stim-790"><span class="linenos">790</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-791"><a href="#MultiClouds.build_stim-791"><span class="linenos">791</span></a>            <span class="c1"># if used which_stim and added crop</span>
</span><span id="MultiClouds.build_stim-792"><a href="#MultiClouds.build_stim-792"><span class="linenos">792</span></a>            <span class="k">if</span> <span class="n">stim_crop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-793"><a href="#MultiClouds.build_stim-793"><span class="linenos">793</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_stim</span><span class="p">(</span> <span class="n">newstim</span><span class="p">,</span> <span class="n">stim_crop</span> <span class="p">)</span>
</span><span id="MultiClouds.build_stim-794"><a href="#MultiClouds.build_stim-794"><span class="linenos">794</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">newstim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MultiClouds.build_stim-795"><a href="#MultiClouds.build_stim-795"><span class="linenos">795</span></a>
</span><span id="MultiClouds.build_stim-796"><a href="#MultiClouds.build_stim-796"><span class="linenos">796</span></a>        <span class="c1"># Verify L matches current stim&#39;s L</span>
</span><span id="MultiClouds.build_stim-797"><a href="#MultiClouds.build_stim-797"><span class="linenos">797</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-798"><a href="#MultiClouds.build_stim-798"><span class="linenos">798</span></a>            <span class="k">assert</span> <span class="n">L</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="s2">&quot;BUILD_STIM: L mismatch (which_stim)&quot;</span>
</span><span id="MultiClouds.build_stim-799"><a href="#MultiClouds.build_stim-799"><span class="linenos">799</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">L</span>
</span><span id="MultiClouds.build_stim-800"><a href="#MultiClouds.build_stim-800"><span class="linenos">800</span></a>
</span><span id="MultiClouds.build_stim-801"><a href="#MultiClouds.build_stim-801"><span class="linenos">801</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-802"><a href="#MultiClouds.build_stim-802"><span class="linenos">802</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">=</span> <span class="n">time_embed</span>
</span><span id="MultiClouds.build_stim-803"><a href="#MultiClouds.build_stim-803"><span class="linenos">803</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-804"><a href="#MultiClouds.build_stim-804"><span class="linenos">804</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">==</span> <span class="n">time_embed</span><span class="p">,</span> <span class="s2">&quot;time_embed setting must match&quot;</span>
</span><span id="MultiClouds.build_stim-805"><a href="#MultiClouds.build_stim-805"><span class="linenos">805</span></a>            
</span><span id="MultiClouds.build_stim-806"><a href="#MultiClouds.build_stim-806"><span class="linenos">806</span></a>        <span class="k">if</span> <span class="n">time_embed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-807"><a href="#MultiClouds.build_stim-807"><span class="linenos">807</span></a>            <span class="c1">#self.stim_dims[3] = num_lags  # this is set by time-embedding</span>
</span><span id="MultiClouds.build_stim-808"><a href="#MultiClouds.build_stim-808"><span class="linenos">808</span></a>            <span class="k">if</span> <span class="n">time_embed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-809"><a href="#MultiClouds.build_stim-809"><span class="linenos">809</span></a>                <span class="n">newstim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embedding</span><span class="p">(</span> <span class="n">newstim</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span> <span class="p">)</span>
</span><span id="MultiClouds.build_stim-810"><a href="#MultiClouds.build_stim-810"><span class="linenos">810</span></a>        <span class="c1"># now stimulus is represented as full 4-d + 1 tensor (time, channels, NX, NY, num_lags)</span>
</span><span id="MultiClouds.build_stim-811"><a href="#MultiClouds.build_stim-811"><span class="linenos">811</span></a>
</span><span id="MultiClouds.build_stim-812"><a href="#MultiClouds.build_stim-812"><span class="linenos">812</span></a>        <span class="c1"># Translate to cone-isolating stimmulus if DKL is false</span>
</span><span id="MultiClouds.build_stim-813"><a href="#MultiClouds.build_stim-813"><span class="linenos">813</span></a>        <span class="k">if</span> <span class="n">LMS</span><span class="p">:</span>
</span><span id="MultiClouds.build_stim-814"><a href="#MultiClouds.build_stim-814"><span class="linenos">814</span></a>            <span class="c1"># Make LMS conversion matrix</span>
</span><span id="MultiClouds.build_stim-815"><a href="#MultiClouds.build_stim-815"><span class="linenos">815</span></a>            <span class="n">DKL2LMS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.7586</span><span class="p">,</span> <span class="mf">0.6515</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5536</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8328</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.8660</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds.build_stim-816"><a href="#MultiClouds.build_stim-816"><span class="linenos">816</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;  Converting to LMS space&#39;</span><span class="p">)</span>
</span><span id="MultiClouds.build_stim-817"><a href="#MultiClouds.build_stim-817"><span class="linenos">817</span></a>            <span class="n">newstim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span> <span class="s1">&#39;axcd,bx-&gt;abcd&#39;</span><span class="p">,</span> <span class="n">newstim</span><span class="p">,</span> <span class="n">DKL2LMS</span><span class="p">)</span>
</span><span id="MultiClouds.build_stim-818"><a href="#MultiClouds.build_stim-818"><span class="linenos">818</span></a>
</span><span id="MultiClouds.build_stim-819"><a href="#MultiClouds.build_stim-819"><span class="linenos">819</span></a>        <span class="c1"># Flatten stim </span>
</span><span id="MultiClouds.build_stim-820"><a href="#MultiClouds.build_stim-820"><span class="linenos">820</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">expt_stims</span><span class="p">[</span><span class="n">expt_n</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">newstim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">expt_n</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="MultiClouds.build_stim-821"><a href="#MultiClouds.build_stim-821"><span class="linenos">821</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Done: expt&quot;</span><span class="p">,</span> <span class="n">expt_n</span> <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This assembles a stimulus from the raw numpy-stored stimuli into self.stim
which_stim: determines what stimulus is assembled from 'ET'=0, 'lam'=1, None
    If none, will need top_corner present: can specify with four numbers (top-left, bot-right)
    or just top_corner and L
which is torch.tensor on default device
stim_wrap: only works if using 'which_stim', and will be [hwrap, vwrap]</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>expt_n (int):</strong>  index of the experiment</li>
<li><strong>which_stim (int or str):</strong>  which stimulus to use</li>
<li><strong>top_corner (list):</strong>  top corner of the stimulus</li>
<li><strong>L (int):</strong>  size of the stimulus</li>
<li><strong>time_embed (int):</strong>  time embedding</li>
<li><strong>eyepos (np.array):</strong>  eye position</li>
<li><strong>BUF (int):</strong>  buffer for eye position</li>
<li><strong>stim_crop (list):</strong>  crop the stimulus</li>
<li><strong>LMS (bool):</strong>  whether to use LMS</li>
<li><strong>fixdot (int):</strong>  fixation point</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiClouds.assemble_stim" class="classattr">
                                        <input id="MultiClouds.assemble_stim-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">assemble_stim</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.assemble_stim-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.assemble_stim"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.assemble_stim-824"><a href="#MultiClouds.assemble_stim-824"><span class="linenos">824</span></a>    <span class="k">def</span> <span class="nf">assemble_stim</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
</span><span id="MultiClouds.assemble_stim-825"><a href="#MultiClouds.assemble_stim-825"><span class="linenos">825</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.assemble_stim-826"><a href="#MultiClouds.assemble_stim-826"><span class="linenos">826</span></a><span class="sd">        Assemble stimulus from all experiments into self.stim</span>
</span><span id="MultiClouds.assemble_stim-827"><a href="#MultiClouds.assemble_stim-827"><span class="linenos">827</span></a>
</span><span id="MultiClouds.assemble_stim-828"><a href="#MultiClouds.assemble_stim-828"><span class="linenos">828</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds.assemble_stim-829"><a href="#MultiClouds.assemble_stim-829"><span class="linenos">829</span></a><span class="sd">            None</span>
</span><span id="MultiClouds.assemble_stim-830"><a href="#MultiClouds.assemble_stim-830"><span class="linenos">830</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.assemble_stim-831"><a href="#MultiClouds.assemble_stim-831"><span class="linenos">831</span></a>
</span><span id="MultiClouds.assemble_stim-832"><a href="#MultiClouds.assemble_stim-832"><span class="linenos">832</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds.assemble_stim-833"><a href="#MultiClouds.assemble_stim-833"><span class="linenos">833</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="MultiClouds.assemble_stim-834"><a href="#MultiClouds.assemble_stim-834"><span class="linenos">834</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MultiClouds.assemble_stim-835"><a href="#MultiClouds.assemble_stim-835"><span class="linenos">835</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="MultiClouds.assemble_stim-836"><a href="#MultiClouds.assemble_stim-836"><span class="linenos">836</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.assemble_stim-837"><a href="#MultiClouds.assemble_stim-837"><span class="linenos">837</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span><span class="p">:</span>
</span><span id="MultiClouds.assemble_stim-838"><a href="#MultiClouds.assemble_stim-838"><span class="linenos">838</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="MultiClouds.assemble_stim-839"><a href="#MultiClouds.assemble_stim-839"><span class="linenos">839</span></a>        <span class="n">num_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">)</span>
</span><span id="MultiClouds.assemble_stim-840"><a href="#MultiClouds.assemble_stim-840"><span class="linenos">840</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span> <span class="p">)</span>
</span><span id="MultiClouds.assemble_stim-841"><a href="#MultiClouds.assemble_stim-841"><span class="linenos">841</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nexpts</span><span class="p">):</span>
</span><span id="MultiClouds.assemble_stim-842"><a href="#MultiClouds.assemble_stim-842"><span class="linenos">842</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">expt_stims</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;ASSEMBLE_STIM: stim </span><span class="si">%d</span><span class="s1"> is not yet built.&#39;</span><span class="o">%</span><span class="n">ff</span>  
</span><span id="MultiClouds.assemble_stim-843"><a href="#MultiClouds.assemble_stim-843"><span class="linenos">843</span></a>            <span class="n">trange</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_tstart</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_tstart</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="MultiClouds.assemble_stim-844"><a href="#MultiClouds.assemble_stim-844"><span class="linenos">844</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">trange</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expt_stims</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span>
</span><span id="MultiClouds.assemble_stim-845"><a href="#MultiClouds.assemble_stim-845"><span class="linenos">845</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Stimulus assembly complete&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Assemble stimulus from all experiments into self.stim</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiClouds.time_embedding" class="classattr">
                                        <input id="MultiClouds.time_embedding-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">time_embedding</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">stim</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">nlags</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.time_embedding-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.time_embedding"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.time_embedding-848"><a href="#MultiClouds.time_embedding-848"><span class="linenos">848</span></a>    <span class="k">def</span> <span class="nf">time_embedding</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="MultiClouds.time_embedding-849"><a href="#MultiClouds.time_embedding-849"><span class="linenos">849</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.time_embedding-850"><a href="#MultiClouds.time_embedding-850"><span class="linenos">850</span></a><span class="sd">        Note this overloads SensoryBase because reshapes in full dimensions to handle folded_lags</span>
</span><span id="MultiClouds.time_embedding-851"><a href="#MultiClouds.time_embedding-851"><span class="linenos">851</span></a><span class="sd">        </span>
</span><span id="MultiClouds.time_embedding-852"><a href="#MultiClouds.time_embedding-852"><span class="linenos">852</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds.time_embedding-853"><a href="#MultiClouds.time_embedding-853"><span class="linenos">853</span></a><span class="sd">            stim (np.array): stimulus to time-embed</span>
</span><span id="MultiClouds.time_embedding-854"><a href="#MultiClouds.time_embedding-854"><span class="linenos">854</span></a><span class="sd">            nlags (int): number of lags</span>
</span><span id="MultiClouds.time_embedding-855"><a href="#MultiClouds.time_embedding-855"><span class="linenos">855</span></a>
</span><span id="MultiClouds.time_embedding-856"><a href="#MultiClouds.time_embedding-856"><span class="linenos">856</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds.time_embedding-857"><a href="#MultiClouds.time_embedding-857"><span class="linenos">857</span></a><span class="sd">            np.array: time-embedded stimulus</span>
</span><span id="MultiClouds.time_embedding-858"><a href="#MultiClouds.time_embedding-858"><span class="linenos">858</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.time_embedding-859"><a href="#MultiClouds.time_embedding-859"><span class="linenos">859</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to assemble stim before time-embedding.&quot;</span>
</span><span id="MultiClouds.time_embedding-860"><a href="#MultiClouds.time_embedding-860"><span class="linenos">860</span></a>
</span><span id="MultiClouds.time_embedding-861"><a href="#MultiClouds.time_embedding-861"><span class="linenos">861</span></a>        <span class="k">if</span> <span class="n">nlags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.time_embedding-862"><a href="#MultiClouds.time_embedding-862"><span class="linenos">862</span></a>            <span class="n">nlags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="MultiClouds.time_embedding-863"><a href="#MultiClouds.time_embedding-863"><span class="linenos">863</span></a>        <span class="c1">#if self.stim_dims[3] == 1:</span>
</span><span id="MultiClouds.time_embedding-864"><a href="#MultiClouds.time_embedding-864"><span class="linenos">864</span></a>        <span class="c1">#    self.stim_dims[3] = nlags</span>
</span><span id="MultiClouds.time_embedding-865"><a href="#MultiClouds.time_embedding-865"><span class="linenos">865</span></a>        <span class="c1">#if stim is None:</span>
</span><span id="MultiClouds.time_embedding-866"><a href="#MultiClouds.time_embedding-866"><span class="linenos">866</span></a>        <span class="c1">#    tmp_stim = deepcopy(self.stim)</span>
</span><span id="MultiClouds.time_embedding-867"><a href="#MultiClouds.time_embedding-867"><span class="linenos">867</span></a>    
</span><span id="MultiClouds.time_embedding-868"><a href="#MultiClouds.time_embedding-868"><span class="linenos">868</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.time_embedding-869"><a href="#MultiClouds.time_embedding-869"><span class="linenos">869</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Time embedding...&quot;</span><span class="p">)</span>
</span><span id="MultiClouds.time_embedding-870"><a href="#MultiClouds.time_embedding-870"><span class="linenos">870</span></a>        <span class="c1">#if len(tmp_stim.shape) == 2:</span>
</span><span id="MultiClouds.time_embedding-871"><a href="#MultiClouds.time_embedding-871"><span class="linenos">871</span></a>        <span class="c1">#    print( &quot;Time embed: reshaping stimulus -&gt;&quot;, self.stim_dims)</span>
</span><span id="MultiClouds.time_embedding-872"><a href="#MultiClouds.time_embedding-872"><span class="linenos">872</span></a>        <span class="c1">#    tmp_stim = tmp_stim.reshape([NT] + self.stim_dims)</span>
</span><span id="MultiClouds.time_embedding-873"><a href="#MultiClouds.time_embedding-873"><span class="linenos">873</span></a>
</span><span id="MultiClouds.time_embedding-874"><a href="#MultiClouds.time_embedding-874"><span class="linenos">874</span></a>        <span class="c1">#assert self.NT == NT, &quot;TIME EMBEDDING: stim length mismatch&quot;</span>
</span><span id="MultiClouds.time_embedding-875"><a href="#MultiClouds.time_embedding-875"><span class="linenos">875</span></a>
</span><span id="MultiClouds.time_embedding-876"><a href="#MultiClouds.time_embedding-876"><span class="linenos">876</span></a>        <span class="c1">#tmp_stim = tmp_stim[np.arange(NT)[:,None]-np.arange(nlags), :, :, :]</span>
</span><span id="MultiClouds.time_embedding-877"><a href="#MultiClouds.time_embedding-877"><span class="linenos">877</span></a>        <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nlags</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="MultiClouds.time_embedding-878"><a href="#MultiClouds.time_embedding-878"><span class="linenos">878</span></a>        <span class="c1">#if self.folded_lags:</span>
</span><span id="MultiClouds.time_embedding-879"><a href="#MultiClouds.time_embedding-879"><span class="linenos">879</span></a>        <span class="c1">#    #tmp_stim = np.transpose( tmp_stim, axes=[0,2,1,3,4] ) </span>
</span><span id="MultiClouds.time_embedding-880"><a href="#MultiClouds.time_embedding-880"><span class="linenos">880</span></a>        <span class="c1">#    tmp_stim = torch.permute( tmp_stim, (0,2,1,3,4) ) </span>
</span><span id="MultiClouds.time_embedding-881"><a href="#MultiClouds.time_embedding-881"><span class="linenos">881</span></a>        <span class="c1">#    print(&quot;Folded lags: stim-dim = &quot;, self.stim.shape)</span>
</span><span id="MultiClouds.time_embedding-882"><a href="#MultiClouds.time_embedding-882"><span class="linenos">882</span></a>        <span class="c1">#else:</span>
</span><span id="MultiClouds.time_embedding-883"><a href="#MultiClouds.time_embedding-883"><span class="linenos">883</span></a>        <span class="c1">#    #tmp_stim = np.transpose( tmp_stim, axes=[0,2,3,4,1] )</span>
</span><span id="MultiClouds.time_embedding-884"><a href="#MultiClouds.time_embedding-884"><span class="linenos">884</span></a>        <span class="c1">#    tmp_stim = torch.permute( tmp_stim, (0,2,3,4,1) )</span>
</span><span id="MultiClouds.time_embedding-885"><a href="#MultiClouds.time_embedding-885"><span class="linenos">885</span></a>        <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span> <span class="n">tmp_stim</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
</span><span id="MultiClouds.time_embedding-886"><a href="#MultiClouds.time_embedding-886"><span class="linenos">886</span></a>        <span class="k">return</span> <span class="n">tmp_stim</span>
</span></pre></div>


            <div class="docstring"><p>Note this overloads SensoryBase because reshapes in full dimensions to handle folded_lags</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>stim (np.array):</strong>  stimulus to time-embed</li>
<li><strong>nlags (int):</strong>  number of lags</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>np.array: time-embedded stimulus</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiClouds.rectangle_overlap_ranges" class="classattr">
                                        <input id="MultiClouds.rectangle_overlap_ranges-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">rectangle_overlap_ranges</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">A</span>, </span><span class="param"><span class="n">B</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.rectangle_overlap_ranges-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.rectangle_overlap_ranges"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.rectangle_overlap_ranges-889"><a href="#MultiClouds.rectangle_overlap_ranges-889"><span class="linenos">889</span></a>    <span class="nd">@staticmethod</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-890"><a href="#MultiClouds.rectangle_overlap_ranges-890"><span class="linenos">890</span></a>    <span class="k">def</span> <span class="nf">rectangle_overlap_ranges</span><span class="p">(</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span> <span class="p">):</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-891"><a href="#MultiClouds.rectangle_overlap_ranges-891"><span class="linenos">891</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-892"><a href="#MultiClouds.rectangle_overlap_ranges-892"><span class="linenos">892</span></a><span class="sd">        Figures out ranges to write relevant overlap of B onto A</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-893"><a href="#MultiClouds.rectangle_overlap_ranges-893"><span class="linenos">893</span></a><span class="sd">        All info is of form [x0, y0, x1, y1]</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-894"><a href="#MultiClouds.rectangle_overlap_ranges-894"><span class="linenos">894</span></a><span class="sd">        </span>
</span><span id="MultiClouds.rectangle_overlap_ranges-895"><a href="#MultiClouds.rectangle_overlap_ranges-895"><span class="linenos">895</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-896"><a href="#MultiClouds.rectangle_overlap_ranges-896"><span class="linenos">896</span></a><span class="sd">            A (list): first rectangle</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-897"><a href="#MultiClouds.rectangle_overlap_ranges-897"><span class="linenos">897</span></a><span class="sd">            B (list): second rectangle</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-898"><a href="#MultiClouds.rectangle_overlap_ranges-898"><span class="linenos">898</span></a>
</span><span id="MultiClouds.rectangle_overlap_ranges-899"><a href="#MultiClouds.rectangle_overlap_ranges-899"><span class="linenos">899</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-900"><a href="#MultiClouds.rectangle_overlap_ranges-900"><span class="linenos">900</span></a><span class="sd">            dict: dictionary of ranges</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-901"><a href="#MultiClouds.rectangle_overlap_ranges-901"><span class="linenos">901</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-902"><a href="#MultiClouds.rectangle_overlap_ranges-902"><span class="linenos">902</span></a>
</span><span id="MultiClouds.rectangle_overlap_ranges-903"><a href="#MultiClouds.rectangle_overlap_ranges-903"><span class="linenos">903</span></a>        <span class="n">C</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-904"><a href="#MultiClouds.rectangle_overlap_ranges-904"><span class="linenos">904</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-905"><a href="#MultiClouds.rectangle_overlap_ranges-905"><span class="linenos">905</span></a>            <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span> 
</span><span id="MultiClouds.rectangle_overlap_ranges-906"><a href="#MultiClouds.rectangle_overlap_ranges-906"><span class="linenos">906</span></a>                <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-907"><a href="#MultiClouds.rectangle_overlap_ranges-907"><span class="linenos">907</span></a>                <span class="n">D</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-908"><a href="#MultiClouds.rectangle_overlap_ranges-908"><span class="linenos">908</span></a>                <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]:</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-909"><a href="#MultiClouds.rectangle_overlap_ranges-909"><span class="linenos">909</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-910"><a href="#MultiClouds.rectangle_overlap_ranges-910"><span class="linenos">910</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> 
</span><span id="MultiClouds.rectangle_overlap_ranges-911"><a href="#MultiClouds.rectangle_overlap_ranges-911"><span class="linenos">911</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-912"><a href="#MultiClouds.rectangle_overlap_ranges-912"><span class="linenos">912</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-913"><a href="#MultiClouds.rectangle_overlap_ranges-913"><span class="linenos">913</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-914"><a href="#MultiClouds.rectangle_overlap_ranges-914"><span class="linenos">914</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-915"><a href="#MultiClouds.rectangle_overlap_ranges-915"><span class="linenos">915</span></a>                <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-916"><a href="#MultiClouds.rectangle_overlap_ranges-916"><span class="linenos">916</span></a>                <span class="n">D</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-917"><a href="#MultiClouds.rectangle_overlap_ranges-917"><span class="linenos">917</span></a>                <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]:</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-918"><a href="#MultiClouds.rectangle_overlap_ranges-918"><span class="linenos">918</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-919"><a href="#MultiClouds.rectangle_overlap_ranges-919"><span class="linenos">919</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-920"><a href="#MultiClouds.rectangle_overlap_ranges-920"><span class="linenos">920</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-921"><a href="#MultiClouds.rectangle_overlap_ranges-921"><span class="linenos">921</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-922"><a href="#MultiClouds.rectangle_overlap_ranges-922"><span class="linenos">922</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-923"><a href="#MultiClouds.rectangle_overlap_ranges-923"><span class="linenos">923</span></a>
</span><span id="MultiClouds.rectangle_overlap_ranges-924"><a href="#MultiClouds.rectangle_overlap_ranges-924"><span class="linenos">924</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-925"><a href="#MultiClouds.rectangle_overlap_ranges-925"><span class="linenos">925</span></a>            <span class="k">return</span> <span class="kc">None</span>  
</span><span id="MultiClouds.rectangle_overlap_ranges-926"><a href="#MultiClouds.rectangle_overlap_ranges-926"><span class="linenos">926</span></a>        <span class="n">ranges</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-927"><a href="#MultiClouds.rectangle_overlap_ranges-927"><span class="linenos">927</span></a>            <span class="s1">&#39;targetX&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-928"><a href="#MultiClouds.rectangle_overlap_ranges-928"><span class="linenos">928</span></a>            <span class="s1">&#39;targetY&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">C</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-929"><a href="#MultiClouds.rectangle_overlap_ranges-929"><span class="linenos">929</span></a>            <span class="s1">&#39;readX&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-930"><a href="#MultiClouds.rectangle_overlap_ranges-930"><span class="linenos">930</span></a>            <span class="s1">&#39;readY&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">D</span><span class="p">[</span><span class="mi">3</span><span class="p">])}</span>
</span><span id="MultiClouds.rectangle_overlap_ranges-931"><a href="#MultiClouds.rectangle_overlap_ranges-931"><span class="linenos">931</span></a>        <span class="k">return</span> <span class="n">ranges</span>
</span></pre></div>


            <div class="docstring"><p>Figures out ranges to write relevant overlap of B onto A
All info is of form [x0, y0, x1, y1]</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>A (list):</strong>  first rectangle</li>
<li><strong>B (list):</strong>  second rectangle</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>dict: dictionary of ranges</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiClouds.crop_stim" class="classattr">
                                        <input id="MultiClouds.crop_stim-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">crop_stim</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">stim0</span>, </span><span class="param"><span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.crop_stim-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.crop_stim"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.crop_stim-934"><a href="#MultiClouds.crop_stim-934"><span class="linenos">934</span></a>    <span class="k">def</span> <span class="nf">crop_stim</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim0</span><span class="p">,</span> <span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="MultiClouds.crop_stim-935"><a href="#MultiClouds.crop_stim-935"><span class="linenos">935</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.crop_stim-936"><a href="#MultiClouds.crop_stim-936"><span class="linenos">936</span></a><span class="sd">        Crop existing (torch) stimulus and change relevant variables [x1, x2, y1, y2]</span>
</span><span id="MultiClouds.crop_stim-937"><a href="#MultiClouds.crop_stim-937"><span class="linenos">937</span></a><span class="sd">        </span>
</span><span id="MultiClouds.crop_stim-938"><a href="#MultiClouds.crop_stim-938"><span class="linenos">938</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds.crop_stim-939"><a href="#MultiClouds.crop_stim-939"><span class="linenos">939</span></a><span class="sd">            stim0 (np.array): stimulus to crop</span>
</span><span id="MultiClouds.crop_stim-940"><a href="#MultiClouds.crop_stim-940"><span class="linenos">940</span></a><span class="sd">            stim_crop (list): crop the stimulus</span>
</span><span id="MultiClouds.crop_stim-941"><a href="#MultiClouds.crop_stim-941"><span class="linenos">941</span></a>
</span><span id="MultiClouds.crop_stim-942"><a href="#MultiClouds.crop_stim-942"><span class="linenos">942</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds.crop_stim-943"><a href="#MultiClouds.crop_stim-943"><span class="linenos">943</span></a><span class="sd">            np.array: cropped stimulus</span>
</span><span id="MultiClouds.crop_stim-944"><a href="#MultiClouds.crop_stim-944"><span class="linenos">944</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.crop_stim-945"><a href="#MultiClouds.crop_stim-945"><span class="linenos">945</span></a>
</span><span id="MultiClouds.crop_stim-946"><a href="#MultiClouds.crop_stim-946"><span class="linenos">946</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_crop</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;stim_crop must be of form: [x1, x2, y1, y2]&quot;</span>
</span><span id="MultiClouds.crop_stim-947"><a href="#MultiClouds.crop_stim-947"><span class="linenos">947</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;STIM_CROP: Will only work for unflattened stimulus&quot;</span>
</span><span id="MultiClouds.crop_stim-948"><a href="#MultiClouds.crop_stim-948"><span class="linenos">948</span></a>        
</span><span id="MultiClouds.crop_stim-949"><a href="#MultiClouds.crop_stim-949"><span class="linenos">949</span></a>        <span class="c1">#stim_crop = np.array(stim_crop, dtype=np.int64) # make sure array</span>
</span><span id="MultiClouds.crop_stim-950"><a href="#MultiClouds.crop_stim-950"><span class="linenos">950</span></a>        <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stim_crop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stim_crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MultiClouds.crop_stim-951"><a href="#MultiClouds.crop_stim-951"><span class="linenos">951</span></a>        <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stim_crop</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">stim_crop</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MultiClouds.crop_stim-952"><a href="#MultiClouds.crop_stim-952"><span class="linenos">952</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="MultiClouds.crop_stim-953"><a href="#MultiClouds.crop_stim-953"><span class="linenos">953</span></a>            <span class="n">newstim</span> <span class="o">=</span> <span class="n">stim0</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">ys</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">xs</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="MultiClouds.crop_stim-954"><a href="#MultiClouds.crop_stim-954"><span class="linenos">954</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># then lagged -- need extra dim</span>
</span><span id="MultiClouds.crop_stim-955"><a href="#MultiClouds.crop_stim-955"><span class="linenos">955</span></a>            <span class="n">newstim</span> <span class="o">=</span> <span class="n">stim0</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">ys</span><span class="p">,</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="n">xs</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="MultiClouds.crop_stim-956"><a href="#MultiClouds.crop_stim-956"><span class="linenos">956</span></a>
</span><span id="MultiClouds.crop_stim-957"><a href="#MultiClouds.crop_stim-957"><span class="linenos">957</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  CROP: New stim size: </span><span class="si">%d</span><span class="s2"> x </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)))</span>
</span><span id="MultiClouds.crop_stim-958"><a href="#MultiClouds.crop_stim-958"><span class="linenos">958</span></a>        <span class="k">return</span> <span class="n">newstim</span>
</span><span id="MultiClouds.crop_stim-959"><a href="#MultiClouds.crop_stim-959"><span class="linenos">959</span></a>    <span class="c1"># END MultiClouds.crop_stim()</span>
</span><span id="MultiClouds.crop_stim-960"><a href="#MultiClouds.crop_stim-960"><span class="linenos">960</span></a>
</span><span id="MultiClouds.crop_stim-961"><a href="#MultiClouds.crop_stim-961"><span class="linenos">961</span></a><span class="c1">#    def augment_dfs( self, new_dfs, cells=None ):</span>
</span><span id="MultiClouds.crop_stim-962"><a href="#MultiClouds.crop_stim-962"><span class="linenos">962</span></a><span class="c1">#        &quot;&quot;&quot;Replaces data-filter for given cells. note that new_df should be np.ndarray&quot;&quot;&quot;</span>
</span><span id="MultiClouds.crop_stim-963"><a href="#MultiClouds.crop_stim-963"><span class="linenos">963</span></a><span class="c1">#        </span>
</span><span id="MultiClouds.crop_stim-964"><a href="#MultiClouds.crop_stim-964"><span class="linenos">964</span></a><span class="c1">#        NTdf, NCdf = new_dfs.shape </span>
</span><span id="MultiClouds.crop_stim-965"><a href="#MultiClouds.crop_stim-965"><span class="linenos">965</span></a><span class="c1">#        if cells is None:</span>
</span><span id="MultiClouds.crop_stim-966"><a href="#MultiClouds.crop_stim-966"><span class="linenos">966</span></a><span class="c1">#            assert NCdf == self.dfs.shape[1], &quot;new DF is wrong shape to replace DF for all cells.&quot;</span>
</span><span id="MultiClouds.crop_stim-967"><a href="#MultiClouds.crop_stim-967"><span class="linenos">967</span></a><span class="c1">#            cells = range(self.dfs.shape[1])</span>
</span><span id="MultiClouds.crop_stim-968"><a href="#MultiClouds.crop_stim-968"><span class="linenos">968</span></a><span class="c1">#        if self.NT &lt; NTdf:</span>
</span><span id="MultiClouds.crop_stim-969"><a href="#MultiClouds.crop_stim-969"><span class="linenos">969</span></a><span class="c1">#            self.dfs[:, cells] *= torch.tensor(new_dfs[:self.NT, :], dtype=torch.float32)</span>
</span><span id="MultiClouds.crop_stim-970"><a href="#MultiClouds.crop_stim-970"><span class="linenos">970</span></a><span class="c1">#        else:</span>
</span><span id="MultiClouds.crop_stim-971"><a href="#MultiClouds.crop_stim-971"><span class="linenos">971</span></a><span class="c1">#            if self.NT &gt; NTdf:</span>
</span><span id="MultiClouds.crop_stim-972"><a href="#MultiClouds.crop_stim-972"><span class="linenos">972</span></a><span class="c1">#                # Assume dfs are 0 after new valid region</span>
</span><span id="MultiClouds.crop_stim-973"><a href="#MultiClouds.crop_stim-973"><span class="linenos">973</span></a><span class="c1">#                print(&quot;Truncating valid region to new datafilter length&quot;, NTdf)</span>
</span><span id="MultiClouds.crop_stim-974"><a href="#MultiClouds.crop_stim-974"><span class="linenos">974</span></a><span class="c1">#                new_dfs = np.concatenate( </span>
</span><span id="MultiClouds.crop_stim-975"><a href="#MultiClouds.crop_stim-975"><span class="linenos">975</span></a><span class="c1">#                    (new_dfs, np.zeros([self.NT-NTdf, len(cells)], dtype=np.float32)), </span>
</span><span id="MultiClouds.crop_stim-976"><a href="#MultiClouds.crop_stim-976"><span class="linenos">976</span></a><span class="c1">#                    axis=0)</span>
</span><span id="MultiClouds.crop_stim-977"><a href="#MultiClouds.crop_stim-977"><span class="linenos">977</span></a><span class="c1">#            self.dfs[:, cells] *= torch.tensor(new_dfs, dtype=torch.float32)</span>
</span><span id="MultiClouds.crop_stim-978"><a href="#MultiClouds.crop_stim-978"><span class="linenos">978</span></a>        <span class="c1"># END ColorClouds.augment_dfs()</span>
</span></pre></div>


            <div class="docstring"><p>Crop existing (torch) stimulus and change relevant variables [x1, x2, y1, y2]</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>stim0 (np.array):</strong>  stimulus to crop</li>
<li><strong>stim_crop (list):</strong>  crop the stimulus</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>np.array: cropped stimulus</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiClouds.draw_stim_locations" class="classattr">
                                        <input id="MultiClouds.draw_stim_locations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">draw_stim_locations</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">expt_n</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">top_corner</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">L</span><span class="o">=</span><span class="mi">60</span>, </span><span class="param"><span class="n">row_height</span><span class="o">=</span><span class="mf">5.0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.draw_stim_locations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.draw_stim_locations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.draw_stim_locations-980"><a href="#MultiClouds.draw_stim_locations-980"><span class="linenos"> 980</span></a>    <span class="k">def</span> <span class="nf">draw_stim_locations</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">expt_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_corner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">row_height</span><span class="o">=</span><span class="mf">5.0</span> <span class="p">):</span>
</span><span id="MultiClouds.draw_stim_locations-981"><a href="#MultiClouds.draw_stim_locations-981"><span class="linenos"> 981</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.draw_stim_locations-982"><a href="#MultiClouds.draw_stim_locations-982"><span class="linenos"> 982</span></a><span class="sd">        Draw stimulus locations for given experiment</span>
</span><span id="MultiClouds.draw_stim_locations-983"><a href="#MultiClouds.draw_stim_locations-983"><span class="linenos"> 983</span></a>
</span><span id="MultiClouds.draw_stim_locations-984"><a href="#MultiClouds.draw_stim_locations-984"><span class="linenos"> 984</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds.draw_stim_locations-985"><a href="#MultiClouds.draw_stim_locations-985"><span class="linenos"> 985</span></a><span class="sd">            expt_n (int): index of the experiment</span>
</span><span id="MultiClouds.draw_stim_locations-986"><a href="#MultiClouds.draw_stim_locations-986"><span class="linenos"> 986</span></a><span class="sd">            top_corner (list): top corner of the stimulus</span>
</span><span id="MultiClouds.draw_stim_locations-987"><a href="#MultiClouds.draw_stim_locations-987"><span class="linenos"> 987</span></a><span class="sd">            L (int): size of the stimulus</span>
</span><span id="MultiClouds.draw_stim_locations-988"><a href="#MultiClouds.draw_stim_locations-988"><span class="linenos"> 988</span></a><span class="sd">            row_height (float): height of the row</span>
</span><span id="MultiClouds.draw_stim_locations-989"><a href="#MultiClouds.draw_stim_locations-989"><span class="linenos"> 989</span></a>
</span><span id="MultiClouds.draw_stim_locations-990"><a href="#MultiClouds.draw_stim_locations-990"><span class="linenos"> 990</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds.draw_stim_locations-991"><a href="#MultiClouds.draw_stim_locations-991"><span class="linenos"> 991</span></a><span class="sd">            None</span>
</span><span id="MultiClouds.draw_stim_locations-992"><a href="#MultiClouds.draw_stim_locations-992"><span class="linenos"> 992</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.draw_stim_locations-993"><a href="#MultiClouds.draw_stim_locations-993"><span class="linenos"> 993</span></a>
</span><span id="MultiClouds.draw_stim_locations-994"><a href="#MultiClouds.draw_stim_locations-994"><span class="linenos"> 994</span></a>        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span id="MultiClouds.draw_stim_locations-995"><a href="#MultiClouds.draw_stim_locations-995"><span class="linenos"> 995</span></a>        <span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Rectangle</span>
</span><span id="MultiClouds.draw_stim_locations-996"><a href="#MultiClouds.draw_stim_locations-996"><span class="linenos"> 996</span></a>
</span><span id="MultiClouds.draw_stim_locations-997"><a href="#MultiClouds.draw_stim_locations-997"><span class="linenos"> 997</span></a>        <span class="n">lamlocs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stim_locsLP&#39;</span><span class="p">]</span>
</span><span id="MultiClouds.draw_stim_locations-998"><a href="#MultiClouds.draw_stim_locations-998"><span class="linenos"> 998</span></a>        <span class="n">ETlocs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;stim_locsET&#39;</span><span class="p">]</span>
</span><span id="MultiClouds.draw_stim_locations-999"><a href="#MultiClouds.draw_stim_locations-999"><span class="linenos"> 999</span></a>        <span class="n">fixloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;fix_loc&#39;</span><span class="p">]</span>
</span><span id="MultiClouds.draw_stim_locations-1000"><a href="#MultiClouds.draw_stim_locations-1000"><span class="linenos">1000</span></a>        <span class="n">fixsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_info</span><span class="p">[</span><span class="n">expt_n</span><span class="p">][</span><span class="s1">&#39;fix_size&#39;</span><span class="p">]</span>
</span><span id="MultiClouds.draw_stim_locations-1001"><a href="#MultiClouds.draw_stim_locations-1001"><span class="linenos">1001</span></a>
</span><span id="MultiClouds.draw_stim_locations-1002"><a href="#MultiClouds.draw_stim_locations-1002"><span class="linenos">1002</span></a>        <span class="n">BUF</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="MultiClouds.draw_stim_locations-1003"><a href="#MultiClouds.draw_stim_locations-1003"><span class="linenos">1003</span></a>        <span class="k">if</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.draw_stim_locations-1004"><a href="#MultiClouds.draw_stim_locations-1004"><span class="linenos">1004</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">lamlocs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.draw_stim_locations-1005"><a href="#MultiClouds.draw_stim_locations-1005"><span class="linenos">1005</span></a>
</span><span id="MultiClouds.draw_stim_locations-1006"><a href="#MultiClouds.draw_stim_locations-1006"><span class="linenos">1006</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="MultiClouds.draw_stim_locations-1007"><a href="#MultiClouds.draw_stim_locations-1007"><span class="linenos">1007</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">row_height</span><span class="p">,</span> <span class="n">row_height</span><span class="p">)</span>
</span><span id="MultiClouds.draw_stim_locations-1008"><a href="#MultiClouds.draw_stim_locations-1008"><span class="linenos">1008</span></a>        <span class="n">nET</span> <span class="o">=</span> <span class="n">ETlocs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds.draw_stim_locations-1009"><a href="#MultiClouds.draw_stim_locations-1009"><span class="linenos">1009</span></a>        <span class="n">nLAM</span> <span class="o">=</span> <span class="n">lamlocs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds.draw_stim_locations-1010"><a href="#MultiClouds.draw_stim_locations-1010"><span class="linenos">1010</span></a>        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="MultiClouds.draw_stim_locations-1011"><a href="#MultiClouds.draw_stim_locations-1011"><span class="linenos">1011</span></a>        <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="MultiClouds.draw_stim_locations-1012"><a href="#MultiClouds.draw_stim_locations-1012"><span class="linenos">1012</span></a>        <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="MultiClouds.draw_stim_locations-1013"><a href="#MultiClouds.draw_stim_locations-1013"><span class="linenos">1013</span></a>        <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">3</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">3</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="MultiClouds.draw_stim_locations-1014"><a href="#MultiClouds.draw_stim_locations-1014"><span class="linenos">1014</span></a>        <span class="c1">#print(x0,x1,y0,y1)</span>
</span><span id="MultiClouds.draw_stim_locations-1015"><a href="#MultiClouds.draw_stim_locations-1015"><span class="linenos">1015</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nLAM</span><span class="p">):</span>
</span><span id="MultiClouds.draw_stim_locations-1016"><a href="#MultiClouds.draw_stim_locations-1016"><span class="linenos">1016</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
</span><span id="MultiClouds.draw_stim_locations-1017"><a href="#MultiClouds.draw_stim_locations-1017"><span class="linenos">1017</span></a>                <span class="n">Rectangle</span><span class="p">((</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">lamlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ii</span><span class="p">]),</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> 
</span><span id="MultiClouds.draw_stim_locations-1018"><a href="#MultiClouds.draw_stim_locations-1018"><span class="linenos">1018</span></a>                <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">))</span>
</span><span id="MultiClouds.draw_stim_locations-1019"><a href="#MultiClouds.draw_stim_locations-1019"><span class="linenos">1019</span></a>        <span class="n">clrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">]</span>
</span><span id="MultiClouds.draw_stim_locations-1020"><a href="#MultiClouds.draw_stim_locations-1020"><span class="linenos">1020</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nET</span><span class="p">):</span>
</span><span id="MultiClouds.draw_stim_locations-1021"><a href="#MultiClouds.draw_stim_locations-1021"><span class="linenos">1021</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ii</span><span class="p">],</span> <span class="n">ETlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="p">]),</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> 
</span><span id="MultiClouds.draw_stim_locations-1022"><a href="#MultiClouds.draw_stim_locations-1022"><span class="linenos">1022</span></a>                                <span class="n">edgecolor</span><span class="o">=</span><span class="n">clrs</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span><span id="MultiClouds.draw_stim_locations-1023"><a href="#MultiClouds.draw_stim_locations-1023"><span class="linenos">1023</span></a>        <span class="k">if</span> <span class="n">fixloc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.draw_stim_locations-1024"><a href="#MultiClouds.draw_stim_locations-1024"><span class="linenos">1024</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">fixloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">fixsize</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fixloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">fixsize</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">fixsize</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">fixsize</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="MultiClouds.draw_stim_locations-1025"><a href="#MultiClouds.draw_stim_locations-1025"><span class="linenos">1025</span></a>                                <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</span><span id="MultiClouds.draw_stim_locations-1026"><a href="#MultiClouds.draw_stim_locations-1026"><span class="linenos">1026</span></a>        <span class="k">if</span> <span class="n">top_corner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.draw_stim_locations-1027"><a href="#MultiClouds.draw_stim_locations-1027"><span class="linenos">1027</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">(</span><span class="n">top_corner</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> 
</span><span id="MultiClouds.draw_stim_locations-1028"><a href="#MultiClouds.draw_stim_locations-1028"><span class="linenos">1028</span></a>                                <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">))</span>
</span><span id="MultiClouds.draw_stim_locations-1029"><a href="#MultiClouds.draw_stim_locations-1029"><span class="linenos">1029</span></a>            
</span><span id="MultiClouds.draw_stim_locations-1030"><a href="#MultiClouds.draw_stim_locations-1030"><span class="linenos">1030</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>
</span><span id="MultiClouds.draw_stim_locations-1031"><a href="#MultiClouds.draw_stim_locations-1031"><span class="linenos">1031</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">x0</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span><span class="n">x1</span><span class="o">+</span><span class="n">BUF</span><span class="p">])</span>
</span><span id="MultiClouds.draw_stim_locations-1032"><a href="#MultiClouds.draw_stim_locations-1032"><span class="linenos">1032</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="n">y0</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span><span class="n">y1</span><span class="o">+</span><span class="n">BUF</span><span class="p">])</span>
</span><span id="MultiClouds.draw_stim_locations-1033"><a href="#MultiClouds.draw_stim_locations-1033"><span class="linenos">1033</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Draw stimulus locations for given experiment</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>expt_n (int):</strong>  index of the experiment</li>
<li><strong>top_corner (list):</strong>  top corner of the stimulus</li>
<li><strong>L (int):</strong>  size of the stimulus</li>
<li><strong>row_height (float):</strong>  height of the row</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiClouds.avrates" class="classattr">
                                        <input id="MultiClouds.avrates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">avrates</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">inds</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.avrates-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.avrates"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.avrates-1036"><a href="#MultiClouds.avrates-1036"><span class="linenos">1036</span></a>    <span class="k">def</span> <span class="nf">avrates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="MultiClouds.avrates-1037"><a href="#MultiClouds.avrates-1037"><span class="linenos">1037</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.avrates-1038"><a href="#MultiClouds.avrates-1038"><span class="linenos">1038</span></a><span class="sd">        Calculates average firing probability across specified inds (or whole dataset)</span>
</span><span id="MultiClouds.avrates-1039"><a href="#MultiClouds.avrates-1039"><span class="linenos">1039</span></a><span class="sd">        -- Note will respect datafilters</span>
</span><span id="MultiClouds.avrates-1040"><a href="#MultiClouds.avrates-1040"><span class="linenos">1040</span></a><span class="sd">        -- will return precalc value to save time if already stored</span>
</span><span id="MultiClouds.avrates-1041"><a href="#MultiClouds.avrates-1041"><span class="linenos">1041</span></a>
</span><span id="MultiClouds.avrates-1042"><a href="#MultiClouds.avrates-1042"><span class="linenos">1042</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds.avrates-1043"><a href="#MultiClouds.avrates-1043"><span class="linenos">1043</span></a><span class="sd">            inds (list): indices to calculate across</span>
</span><span id="MultiClouds.avrates-1044"><a href="#MultiClouds.avrates-1044"><span class="linenos">1044</span></a>
</span><span id="MultiClouds.avrates-1045"><a href="#MultiClouds.avrates-1045"><span class="linenos">1045</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds.avrates-1046"><a href="#MultiClouds.avrates-1046"><span class="linenos">1046</span></a><span class="sd">            np.array: average firing rates</span>
</span><span id="MultiClouds.avrates-1047"><a href="#MultiClouds.avrates-1047"><span class="linenos">1047</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.avrates-1048"><a href="#MultiClouds.avrates-1048"><span class="linenos">1048</span></a>        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.avrates-1049"><a href="#MultiClouds.avrates-1049"><span class="linenos">1049</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="MultiClouds.avrates-1050"><a href="#MultiClouds.avrates-1050"><span class="linenos">1050</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="MultiClouds.avrates-1051"><a href="#MultiClouds.avrates-1051"><span class="linenos">1051</span></a>            <span class="c1"># then calculate across whole dataset</span>
</span><span id="MultiClouds.avrates-1052"><a href="#MultiClouds.avrates-1052"><span class="linenos">1052</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.avrates-1053"><a href="#MultiClouds.avrates-1053"><span class="linenos">1053</span></a>                <span class="c1"># then precalculated and do not need to do</span>
</span><span id="MultiClouds.avrates-1054"><a href="#MultiClouds.avrates-1054"><span class="linenos">1054</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span>
</span><span id="MultiClouds.avrates-1055"><a href="#MultiClouds.avrates-1055"><span class="linenos">1055</span></a>
</span><span id="MultiClouds.avrates-1056"><a href="#MultiClouds.avrates-1056"><span class="linenos">1056</span></a>        <span class="c1"># Otherwise calculate across all data</span>
</span><span id="MultiClouds.avrates-1057"><a href="#MultiClouds.avrates-1057"><span class="linenos">1057</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="MultiClouds.avrates-1058"><a href="#MultiClouds.avrates-1058"><span class="linenos">1058</span></a>            <span class="n">Reff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="MultiClouds.avrates-1059"><a href="#MultiClouds.avrates-1059"><span class="linenos">1059</span></a>            <span class="n">Teff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="MultiClouds.avrates-1060"><a href="#MultiClouds.avrates-1060"><span class="linenos">1060</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="o">/</span><span class="n">Teff</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="MultiClouds.avrates-1061"><a href="#MultiClouds.avrates-1061"><span class="linenos">1061</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.avrates-1062"><a href="#MultiClouds.avrates-1062"><span class="linenos">1062</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Still need to implement avRs without preloading&#39;</span><span class="p">)</span>
</span><span id="MultiClouds.avrates-1063"><a href="#MultiClouds.avrates-1063"><span class="linenos">1063</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Calculates average firing probability across specified inds (or whole dataset)
-- Note will respect datafilters
-- will return precalc value to save time if already stored</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>inds (list):</strong>  indices to calculate across</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>np.array: average firing rates</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiClouds.shift_stim_oldstyle" class="classattr">
                                        <input id="MultiClouds.shift_stim_oldstyle-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">shift_stim_oldstyle</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">stim</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">pos_shifts</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">metrics</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">metric_threshold</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">ts_thresh</span><span class="o">=</span><span class="mi">8</span>,</span><span class="param">	<span class="n">fix_n</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">shift_times</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.shift_stim_oldstyle-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.shift_stim_oldstyle"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.shift_stim_oldstyle-1070"><a href="#MultiClouds.shift_stim_oldstyle-1070"><span class="linenos">1070</span></a>    <span class="k">def</span> <span class="nf">shift_stim_oldstyle</span><span class="p">(</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1071"><a href="#MultiClouds.shift_stim_oldstyle-1071"><span class="linenos">1071</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pos_shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metric_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ts_thresh</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">fix_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1072"><a href="#MultiClouds.shift_stim_oldstyle-1072"><span class="linenos">1072</span></a>        <span class="n">shift_times</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1073"><a href="#MultiClouds.shift_stim_oldstyle-1073"><span class="linenos">1073</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1074"><a href="#MultiClouds.shift_stim_oldstyle-1074"><span class="linenos">1074</span></a><span class="sd">        Shift stimulus given standard shifting input (TBD)</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1075"><a href="#MultiClouds.shift_stim_oldstyle-1075"><span class="linenos">1075</span></a><span class="sd">        use &#39;shift-times&#39; if given shifts correspond to range of times</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1076"><a href="#MultiClouds.shift_stim_oldstyle-1076"><span class="linenos">1076</span></a><span class="sd">        </span>
</span><span id="MultiClouds.shift_stim_oldstyle-1077"><a href="#MultiClouds.shift_stim_oldstyle-1077"><span class="linenos">1077</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1078"><a href="#MultiClouds.shift_stim_oldstyle-1078"><span class="linenos">1078</span></a><span class="sd">            stim (np.array): stimulus to shift</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1079"><a href="#MultiClouds.shift_stim_oldstyle-1079"><span class="linenos">1079</span></a><span class="sd">            pos_shifts (np.array): shifts to apply</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1080"><a href="#MultiClouds.shift_stim_oldstyle-1080"><span class="linenos">1080</span></a><span class="sd">            metrics (np.array): metrics to apply</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1081"><a href="#MultiClouds.shift_stim_oldstyle-1081"><span class="linenos">1081</span></a><span class="sd">            metric_threshold (float): metric threshold</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1082"><a href="#MultiClouds.shift_stim_oldstyle-1082"><span class="linenos">1082</span></a><span class="sd">            ts_thresh (int): time threshold</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1083"><a href="#MultiClouds.shift_stim_oldstyle-1083"><span class="linenos">1083</span></a><span class="sd">            fix_n (np.array): fixations</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1084"><a href="#MultiClouds.shift_stim_oldstyle-1084"><span class="linenos">1084</span></a><span class="sd">            shift_times (np.array): times to shift</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1085"><a href="#MultiClouds.shift_stim_oldstyle-1085"><span class="linenos">1085</span></a>
</span><span id="MultiClouds.shift_stim_oldstyle-1086"><a href="#MultiClouds.shift_stim_oldstyle-1086"><span class="linenos">1086</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1087"><a href="#MultiClouds.shift_stim_oldstyle-1087"><span class="linenos">1087</span></a><span class="sd">            np.array: shifted stimulus</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1088"><a href="#MultiClouds.shift_stim_oldstyle-1088"><span class="linenos">1088</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1089"><a href="#MultiClouds.shift_stim_oldstyle-1089"><span class="linenos">1089</span></a>        <span class="n">NX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1090"><a href="#MultiClouds.shift_stim_oldstyle-1090"><span class="linenos">1090</span></a>        <span class="n">nlags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1091"><a href="#MultiClouds.shift_stim_oldstyle-1091"><span class="linenos">1091</span></a>
</span><span id="MultiClouds.shift_stim_oldstyle-1092"><a href="#MultiClouds.shift_stim_oldstyle-1092"><span class="linenos">1092</span></a>        <span class="c1"># Check if has been time-lagged yet</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1093"><a href="#MultiClouds.shift_stim_oldstyle-1093"><span class="linenos">1093</span></a>        <span class="k">if</span> <span class="n">stim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1094"><a href="#MultiClouds.shift_stim_oldstyle-1094"><span class="linenos">1094</span></a>            <span class="n">stim0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1095"><a href="#MultiClouds.shift_stim_oldstyle-1095"><span class="linenos">1095</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1096"><a href="#MultiClouds.shift_stim_oldstyle-1096"><span class="linenos">1096</span></a>            <span class="n">stim0</span> <span class="o">=</span> <span class="n">stim</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1097"><a href="#MultiClouds.shift_stim_oldstyle-1097"><span class="linenos">1097</span></a>
</span><span id="MultiClouds.shift_stim_oldstyle-1098"><a href="#MultiClouds.shift_stim_oldstyle-1098"><span class="linenos">1098</span></a>        <span class="n">already_lagged</span><span class="o">=</span><span class="kc">False</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1099"><a href="#MultiClouds.shift_stim_oldstyle-1099"><span class="linenos">1099</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1100"><a href="#MultiClouds.shift_stim_oldstyle-1100"><span class="linenos">1100</span></a>            <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="n">ND</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim0</span><span class="o">.</span><span class="n">shape</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1101"><a href="#MultiClouds.shift_stim_oldstyle-1101"><span class="linenos">1101</span></a>            <span class="k">if</span> <span class="n">ND</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">NX</span><span class="o">*</span><span class="n">NX</span><span class="p">:</span>  <span class="c1"># then lags in stim</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1102"><a href="#MultiClouds.shift_stim_oldstyle-1102"><span class="linenos">1102</span></a>                <span class="n">re_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1103"><a href="#MultiClouds.shift_stim_oldstyle-1103"><span class="linenos">1103</span></a>                <span class="n">already_lagged</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1104"><a href="#MultiClouds.shift_stim_oldstyle-1104"><span class="linenos">1104</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1105"><a href="#MultiClouds.shift_stim_oldstyle-1105"><span class="linenos">1105</span></a>                <span class="n">re_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1106"><a href="#MultiClouds.shift_stim_oldstyle-1106"><span class="linenos">1106</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1107"><a href="#MultiClouds.shift_stim_oldstyle-1107"><span class="linenos">1107</span></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Stim be already shaped according shape, but seems not&quot;</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1108"><a href="#MultiClouds.shift_stim_oldstyle-1108"><span class="linenos">1108</span></a>            <span class="n">re_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1109"><a href="#MultiClouds.shift_stim_oldstyle-1109"><span class="linenos">1109</span></a>
</span><span id="MultiClouds.shift_stim_oldstyle-1110"><a href="#MultiClouds.shift_stim_oldstyle-1110"><span class="linenos">1110</span></a>        <span class="k">if</span> <span class="n">fix_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1111"><a href="#MultiClouds.shift_stim_oldstyle-1111"><span class="linenos">1111</span></a>            <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1112"><a href="#MultiClouds.shift_stim_oldstyle-1112"><span class="linenos">1112</span></a>
</span><span id="MultiClouds.shift_stim_oldstyle-1113"><a href="#MultiClouds.shift_stim_oldstyle-1113"><span class="linenos">1113</span></a>        <span class="c1"># Apply shift-times (subset)</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1114"><a href="#MultiClouds.shift_stim_oldstyle-1114"><span class="linenos">1114</span></a>        <span class="k">if</span> <span class="n">shift_times</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1115"><a href="#MultiClouds.shift_stim_oldstyle-1115"><span class="linenos">1115</span></a>            <span class="n">fix_n</span> <span class="o">=</span> <span class="n">fix_n</span><span class="p">[</span><span class="n">shift_times</span><span class="p">]</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1116"><a href="#MultiClouds.shift_stim_oldstyle-1116"><span class="linenos">1116</span></a>            <span class="c1"># Find minimum fix_n and make = 1</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1117"><a href="#MultiClouds.shift_stim_oldstyle-1117"><span class="linenos">1117</span></a>            <span class="n">min_fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fix_n</span><span class="p">[</span><span class="n">fix_n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1118"><a href="#MultiClouds.shift_stim_oldstyle-1118"><span class="linenos">1118</span></a>            <span class="c1">#print(&#39;min_fix_n&#39;, min_fix_n, &#39;adjust&#39;, 1-min_fix_n)</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1119"><a href="#MultiClouds.shift_stim_oldstyle-1119"><span class="linenos">1119</span></a>            <span class="n">fix_n</span><span class="p">[</span><span class="n">fix_n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">-</span><span class="n">min_fix_n</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1120"><a href="#MultiClouds.shift_stim_oldstyle-1120"><span class="linenos">1120</span></a>            <span class="n">re_stim</span> <span class="o">=</span> <span class="n">re_stim</span><span class="p">[</span><span class="n">shift_times</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1121"><a href="#MultiClouds.shift_stim_oldstyle-1121"><span class="linenos">1121</span></a>            <span class="c1">#print(&#39;max fix&#39;, np.max(fix_n), fix_n.shape)</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1122"><a href="#MultiClouds.shift_stim_oldstyle-1122"><span class="linenos">1122</span></a>        
</span><span id="MultiClouds.shift_stim_oldstyle-1123"><a href="#MultiClouds.shift_stim_oldstyle-1123"><span class="linenos">1123</span></a>        <span class="n">NF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fix_n</span><span class="p">)</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1124"><a href="#MultiClouds.shift_stim_oldstyle-1124"><span class="linenos">1124</span></a>        <span class="n">NTtmp</span> <span class="o">=</span> <span class="n">re_stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1125"><a href="#MultiClouds.shift_stim_oldstyle-1125"><span class="linenos">1125</span></a>        <span class="n">nclr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1126"><a href="#MultiClouds.shift_stim_oldstyle-1126"><span class="linenos">1126</span></a>        <span class="c1">#sh0 = -(pos_shifts[:,0]-self.dims[1]//2)</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1127"><a href="#MultiClouds.shift_stim_oldstyle-1127"><span class="linenos">1127</span></a>        <span class="c1">#sh1 = -(pos_shifts[:,1]-self.dims[2]//2)</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1128"><a href="#MultiClouds.shift_stim_oldstyle-1128"><span class="linenos">1128</span></a>        <span class="n">sh0</span> <span class="o">=</span> <span class="n">pos_shifts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># this should be in units of pixels relative to 0</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1129"><a href="#MultiClouds.shift_stim_oldstyle-1129"><span class="linenos">1129</span></a>        <span class="n">sh1</span> <span class="o">=</span> <span class="n">pos_shifts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1130"><a href="#MultiClouds.shift_stim_oldstyle-1130"><span class="linenos">1130</span></a>
</span><span id="MultiClouds.shift_stim_oldstyle-1131"><a href="#MultiClouds.shift_stim_oldstyle-1131"><span class="linenos">1131</span></a>        <span class="n">sp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">re_stim</span><span class="p">)</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1132"><a href="#MultiClouds.shift_stim_oldstyle-1132"><span class="linenos">1132</span></a>        <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1133"><a href="#MultiClouds.shift_stim_oldstyle-1133"><span class="linenos">1133</span></a>            <span class="n">val_fix</span> <span class="o">=</span> <span class="n">metrics</span> <span class="o">&gt;</span> <span class="n">metric_threshold</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1134"><a href="#MultiClouds.shift_stim_oldstyle-1134"><span class="linenos">1134</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Applied metric threshold: </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">val_fix</span><span class="p">),</span> <span class="n">NF</span><span class="p">))</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1135"><a href="#MultiClouds.shift_stim_oldstyle-1135"><span class="linenos">1135</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1136"><a href="#MultiClouds.shift_stim_oldstyle-1136"><span class="linenos">1136</span></a>            <span class="n">val_fix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span><span class="o">*</span><span class="n">NF</span><span class="p">)</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1137"><a href="#MultiClouds.shift_stim_oldstyle-1137"><span class="linenos">1137</span></a>
</span><span id="MultiClouds.shift_stim_oldstyle-1138"><a href="#MultiClouds.shift_stim_oldstyle-1138"><span class="linenos">1138</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NF</span><span class="p">):</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1139"><a href="#MultiClouds.shift_stim_oldstyle-1139"><span class="linenos">1139</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fix_n</span> <span class="o">==</span> <span class="n">ff</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1140"><a href="#MultiClouds.shift_stim_oldstyle-1140"><span class="linenos">1140</span></a>            <span class="c1">#print(ff, len(ts), ts[0], ts[-1])</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1141"><a href="#MultiClouds.shift_stim_oldstyle-1141"><span class="linenos">1141</span></a>
</span><span id="MultiClouds.shift_stim_oldstyle-1142"><a href="#MultiClouds.shift_stim_oldstyle-1142"><span class="linenos">1142</span></a>            <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh0</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh1</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ts_thresh</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">val_fix</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">):</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1143"><a href="#MultiClouds.shift_stim_oldstyle-1143"><span class="linenos">1143</span></a>                <span class="c1"># FIRST SP DIM shift</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1144"><a href="#MultiClouds.shift_stim_oldstyle-1144"><span class="linenos">1144</span></a>                <span class="n">sh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sh0</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1145"><a href="#MultiClouds.shift_stim_oldstyle-1145"><span class="linenos">1145</span></a>                <span class="n">stim_seg</span> <span class="o">=</span> <span class="n">re_stim</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1146"><a href="#MultiClouds.shift_stim_oldstyle-1146"><span class="linenos">1146</span></a>                <span class="k">if</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1147"><a href="#MultiClouds.shift_stim_oldstyle-1147"><span class="linenos">1147</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span> <span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1148"><a href="#MultiClouds.shift_stim_oldstyle-1148"><span class="linenos">1148</span></a>                    <span class="n">stim_tmp</span><span class="p">[:,</span> <span class="p">:,</span><span class="n">sh</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_seg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="o">-</span><span class="n">sh</span><span class="p">),</span> <span class="p">:])</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1149"><a href="#MultiClouds.shift_stim_oldstyle-1149"><span class="linenos">1149</span></a>                <span class="k">elif</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1150"><a href="#MultiClouds.shift_stim_oldstyle-1150"><span class="linenos">1150</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span> <span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1151"><a href="#MultiClouds.shift_stim_oldstyle-1151"><span class="linenos">1151</span></a>                    <span class="n">stim_tmp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">sh</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_seg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">(</span><span class="o">-</span><span class="n">sh</span><span class="p">):,</span> <span class="p">:])</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1152"><a href="#MultiClouds.shift_stim_oldstyle-1152"><span class="linenos">1152</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1153"><a href="#MultiClouds.shift_stim_oldstyle-1153"><span class="linenos">1153</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_seg</span><span class="p">)</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1154"><a href="#MultiClouds.shift_stim_oldstyle-1154"><span class="linenos">1154</span></a>
</span><span id="MultiClouds.shift_stim_oldstyle-1155"><a href="#MultiClouds.shift_stim_oldstyle-1155"><span class="linenos">1155</span></a>                <span class="c1"># SECOND SP DIM shift</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1156"><a href="#MultiClouds.shift_stim_oldstyle-1156"><span class="linenos">1156</span></a>                <span class="n">sh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sh1</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1157"><a href="#MultiClouds.shift_stim_oldstyle-1157"><span class="linenos">1157</span></a>                <span class="k">if</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1158"><a href="#MultiClouds.shift_stim_oldstyle-1158"><span class="linenos">1158</span></a>                    <span class="n">stim_tmp2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1159"><a href="#MultiClouds.shift_stim_oldstyle-1159"><span class="linenos">1159</span></a>                    <span class="n">stim_tmp2</span><span class="p">[</span><span class="o">...</span> <span class="p">,</span> <span class="n">sh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:(</span><span class="o">-</span><span class="n">sh</span><span class="p">)])</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1160"><a href="#MultiClouds.shift_stim_oldstyle-1160"><span class="linenos">1160</span></a>                <span class="k">elif</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1161"><a href="#MultiClouds.shift_stim_oldstyle-1161"><span class="linenos">1161</span></a>                    <span class="n">stim_tmp2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1162"><a href="#MultiClouds.shift_stim_oldstyle-1162"><span class="linenos">1162</span></a>                    <span class="n">stim_tmp2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">sh</span><span class="p">):])</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1163"><a href="#MultiClouds.shift_stim_oldstyle-1163"><span class="linenos">1163</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1164"><a href="#MultiClouds.shift_stim_oldstyle-1164"><span class="linenos">1164</span></a>                    <span class="n">stim_tmp2</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1165"><a href="#MultiClouds.shift_stim_oldstyle-1165"><span class="linenos">1165</span></a>                    
</span><span id="MultiClouds.shift_stim_oldstyle-1166"><a href="#MultiClouds.shift_stim_oldstyle-1166"><span class="linenos">1166</span></a>                <span class="n">sp_stim</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="o">...</span> <span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp2</span><span class="p">)</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1167"><a href="#MultiClouds.shift_stim_oldstyle-1167"><span class="linenos">1167</span></a>
</span><span id="MultiClouds.shift_stim_oldstyle-1168"><a href="#MultiClouds.shift_stim_oldstyle-1168"><span class="linenos">1168</span></a>        <span class="k">if</span> <span class="n">already_lagged</span><span class="p">:</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1169"><a href="#MultiClouds.shift_stim_oldstyle-1169"><span class="linenos">1169</span></a>            <span class="c1"># Time-embed</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1170"><a href="#MultiClouds.shift_stim_oldstyle-1170"><span class="linenos">1170</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NTtmp</span><span class="p">)</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1171"><a href="#MultiClouds.shift_stim_oldstyle-1171"><span class="linenos">1171</span></a>            <span class="n">laggedstim</span> <span class="o">=</span> <span class="n">sp_stim</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NTtmp</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nlags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1172"><a href="#MultiClouds.shift_stim_oldstyle-1172"><span class="linenos">1172</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">laggedstim</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1173"><a href="#MultiClouds.shift_stim_oldstyle-1173"><span class="linenos">1173</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.shift_stim_oldstyle-1174"><a href="#MultiClouds.shift_stim_oldstyle-1174"><span class="linenos">1174</span></a>            <span class="k">return</span> <span class="n">sp_stim</span>
</span></pre></div>


            <div class="docstring"><p>Shift stimulus given standard shifting input (TBD)
use 'shift-times' if given shifts correspond to range of times</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>stim (np.array):</strong>  stimulus to shift</li>
<li><strong>pos_shifts (np.array):</strong>  shifts to apply</li>
<li><strong>metrics (np.array):</strong>  metrics to apply</li>
<li><strong>metric_threshold (float):</strong>  metric threshold</li>
<li><strong>ts_thresh (int):</strong>  time threshold</li>
<li><strong>fix_n (np.array):</strong>  fixations</li>
<li><strong>shift_times (np.array):</strong>  times to shift</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>np.array: shifted stimulus</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiClouds.process_fixations" class="classattr">
                                        <input id="MultiClouds.process_fixations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">process_fixations</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">sacc_in</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">expt_n</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">sacc_metrics</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">thresh</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">dur_thresh</span><span class="o">=</span><span class="mi">8</span>,</span><span class="param">	<span class="n">modify_dfs</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.process_fixations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.process_fixations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.process_fixations-1177"><a href="#MultiClouds.process_fixations-1177"><span class="linenos">1177</span></a>    <span class="k">def</span> <span class="nf">process_fixations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sacc_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expt_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
</span><span id="MultiClouds.process_fixations-1178"><a href="#MultiClouds.process_fixations-1178"><span class="linenos">1178</span></a>                          <span class="n">sacc_metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dur_thresh</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="MultiClouds.process_fixations-1179"><a href="#MultiClouds.process_fixations-1179"><span class="linenos">1179</span></a>                          <span class="n">modify_dfs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="MultiClouds.process_fixations-1180"><a href="#MultiClouds.process_fixations-1180"><span class="linenos">1180</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.process_fixations-1181"><a href="#MultiClouds.process_fixations-1181"><span class="linenos">1181</span></a><span class="sd">        Generates fix_n based on existing trial structure and imported fixations. Will only work for specified</span>
</span><span id="MultiClouds.process_fixations-1182"><a href="#MultiClouds.process_fixations-1182"><span class="linenos">1182</span></a><span class="sd">        experiment (expt_n variable) and assume timings are based on the beginning of that experiment.</span>
</span><span id="MultiClouds.process_fixations-1183"><a href="#MultiClouds.process_fixations-1183"><span class="linenos">1183</span></a><span class="sd">        Output: fix_n</span>
</span><span id="MultiClouds.process_fixations-1184"><a href="#MultiClouds.process_fixations-1184"><span class="linenos">1184</span></a>
</span><span id="MultiClouds.process_fixations-1185"><a href="#MultiClouds.process_fixations-1185"><span class="linenos">1185</span></a><span class="sd">        Default: modify_dfs=True will zero out data where there is no assigned fixation</span>
</span><span id="MultiClouds.process_fixations-1186"><a href="#MultiClouds.process_fixations-1186"><span class="linenos">1186</span></a><span class="sd">        </span>
</span><span id="MultiClouds.process_fixations-1187"><a href="#MultiClouds.process_fixations-1187"><span class="linenos">1187</span></a><span class="sd">        Note that this will assume that saccades correspond to relevant trange (e.g., binocular section) rather</span>
</span><span id="MultiClouds.process_fixations-1188"><a href="#MultiClouds.process_fixations-1188"><span class="linenos">1188</span></a><span class="sd">        than the whole experiment.</span>
</span><span id="MultiClouds.process_fixations-1189"><a href="#MultiClouds.process_fixations-1189"><span class="linenos">1189</span></a><span class="sd">        </span>
</span><span id="MultiClouds.process_fixations-1190"><a href="#MultiClouds.process_fixations-1190"><span class="linenos">1190</span></a><span class="sd">        Can also use metric criteria to only use fraction of total saccades: sacc_metrics can be amplitude, and </span>
</span><span id="MultiClouds.process_fixations-1191"><a href="#MultiClouds.process_fixations-1191"><span class="linenos">1191</span></a><span class="sd">        sacc_thresh be inclusion criteria (must be greater than sacc_thresh)</span>
</span><span id="MultiClouds.process_fixations-1192"><a href="#MultiClouds.process_fixations-1192"><span class="linenos">1192</span></a>
</span><span id="MultiClouds.process_fixations-1193"><a href="#MultiClouds.process_fixations-1193"><span class="linenos">1193</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds.process_fixations-1194"><a href="#MultiClouds.process_fixations-1194"><span class="linenos">1194</span></a><span class="sd">            sacc_in (np.array): saccade times</span>
</span><span id="MultiClouds.process_fixations-1195"><a href="#MultiClouds.process_fixations-1195"><span class="linenos">1195</span></a><span class="sd">            expt_n (int): index of the experiment</span>
</span><span id="MultiClouds.process_fixations-1196"><a href="#MultiClouds.process_fixations-1196"><span class="linenos">1196</span></a><span class="sd">            sacc_metrics (np.array): saccade metrics</span>
</span><span id="MultiClouds.process_fixations-1197"><a href="#MultiClouds.process_fixations-1197"><span class="linenos">1197</span></a><span class="sd">            thresh (float): threshold for saccade metrics</span>
</span><span id="MultiClouds.process_fixations-1198"><a href="#MultiClouds.process_fixations-1198"><span class="linenos">1198</span></a><span class="sd">            dur_thresh (int): duration threshold</span>
</span><span id="MultiClouds.process_fixations-1199"><a href="#MultiClouds.process_fixations-1199"><span class="linenos">1199</span></a><span class="sd">            modify_dfs (bool): modify dfs</span>
</span><span id="MultiClouds.process_fixations-1200"><a href="#MultiClouds.process_fixations-1200"><span class="linenos">1200</span></a>
</span><span id="MultiClouds.process_fixations-1201"><a href="#MultiClouds.process_fixations-1201"><span class="linenos">1201</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds.process_fixations-1202"><a href="#MultiClouds.process_fixations-1202"><span class="linenos">1202</span></a><span class="sd">            np.array: fixation numbers</span>
</span><span id="MultiClouds.process_fixations-1203"><a href="#MultiClouds.process_fixations-1203"><span class="linenos">1203</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.process_fixations-1204"><a href="#MultiClouds.process_fixations-1204"><span class="linenos">1204</span></a>
</span><span id="MultiClouds.process_fixations-1205"><a href="#MultiClouds.process_fixations-1205"><span class="linenos">1205</span></a>        <span class="k">assert</span> <span class="n">sacc_in</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to enter saccade times&quot;</span>
</span><span id="MultiClouds.process_fixations-1206"><a href="#MultiClouds.process_fixations-1206"><span class="linenos">1206</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileNT</span><span class="p">[</span><span class="n">expt_n</span><span class="p">]</span>
</span><span id="MultiClouds.process_fixations-1207"><a href="#MultiClouds.process_fixations-1207"><span class="linenos">1207</span></a>        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sacc_in</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">NT</span><span class="p">,</span> <span class="s2">&quot;sacc list is too long&quot;</span>
</span><span id="MultiClouds.process_fixations-1208"><a href="#MultiClouds.process_fixations-1208"><span class="linenos">1208</span></a>        <span class="k">if</span> <span class="n">sacc_metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.process_fixations-1209"><a href="#MultiClouds.process_fixations-1209"><span class="linenos">1209</span></a>            <span class="n">sac_ts</span> <span class="o">=</span> <span class="n">sacc_in</span>
</span><span id="MultiClouds.process_fixations-1210"><a href="#MultiClouds.process_fixations-1210"><span class="linenos">1210</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.process_fixations-1211"><a href="#MultiClouds.process_fixations-1211"><span class="linenos">1211</span></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sacc_metrics</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">sacc_in</span><span class="p">),</span> <span class="s2">&quot;Saccade metrics must match length of sacc_in&quot;</span>
</span><span id="MultiClouds.process_fixations-1212"><a href="#MultiClouds.process_fixations-1212"><span class="linenos">1212</span></a>            <span class="n">sac_ts</span> <span class="o">=</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sacc_metrics</span> <span class="o">&gt;=</span> <span class="n">thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="MultiClouds.process_fixations-1213"><a href="#MultiClouds.process_fixations-1213"><span class="linenos">1213</span></a>        <span class="n">sacc_rate</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sac_ts</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">NT</span><span class="o">/</span><span class="mf">60.0</span><span class="p">)</span>
</span><span id="MultiClouds.process_fixations-1214"><a href="#MultiClouds.process_fixations-1214"><span class="linenos">1214</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Generating fix_n for expt </span><span class="si">%d</span><span class="s2"> with </span><span class="si">%d</span><span class="s2"> valid saccades (</span><span class="si">%0.2f</span><span class="s2"> Hz)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">expt_n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sac_ts</span><span class="p">),</span> <span class="n">sacc_rate</span><span class="p">)</span> <span class="p">)</span>
</span><span id="MultiClouds.process_fixations-1215"><a href="#MultiClouds.process_fixations-1215"><span class="linenos">1215</span></a>
</span><span id="MultiClouds.process_fixations-1216"><a href="#MultiClouds.process_fixations-1216"><span class="linenos">1216</span></a>        <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> 
</span><span id="MultiClouds.process_fixations-1217"><a href="#MultiClouds.process_fixations-1217"><span class="linenos">1217</span></a>        <span class="n">fix_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds.process_fixations-1218"><a href="#MultiClouds.process_fixations-1218"><span class="linenos">1218</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)):</span>
</span><span id="MultiClouds.process_fixations-1219"><a href="#MultiClouds.process_fixations-1219"><span class="linenos">1219</span></a>            <span class="c1">#if self.block_inds[ii][0] &lt; self.NT:</span>
</span><span id="MultiClouds.process_fixations-1220"><a href="#MultiClouds.process_fixations-1220"><span class="linenos">1220</span></a>            <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="MultiClouds.process_fixations-1221"><a href="#MultiClouds.process_fixations-1221"><span class="linenos">1221</span></a>            <span class="c1">#self.block_inds.append(np.arange( blk_inds[ii,0], blk_inds[ii,1], dtype=np.int64))</span>
</span><span id="MultiClouds.process_fixations-1222"><a href="#MultiClouds.process_fixations-1222"><span class="linenos">1222</span></a>
</span><span id="MultiClouds.process_fixations-1223"><a href="#MultiClouds.process_fixations-1223"><span class="linenos">1223</span></a>            <span class="c1"># Parse fixation numbers within block</span>
</span><span id="MultiClouds.process_fixations-1224"><a href="#MultiClouds.process_fixations-1224"><span class="linenos">1224</span></a>            <span class="n">rel_saccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">sac_ts</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sac_ts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">5</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.process_fixations-1225"><a href="#MultiClouds.process_fixations-1225"><span class="linenos">1225</span></a>
</span><span id="MultiClouds.process_fixations-1226"><a href="#MultiClouds.process_fixations-1226"><span class="linenos">1226</span></a>            <span class="n">tfix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Beginning of fixation by definition</span>
</span><span id="MultiClouds.process_fixations-1227"><a href="#MultiClouds.process_fixations-1227"><span class="linenos">1227</span></a>            <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel_saccs</span><span class="p">)):</span>
</span><span id="MultiClouds.process_fixations-1228"><a href="#MultiClouds.process_fixations-1228"><span class="linenos">1228</span></a>                <span class="k">if</span> <span class="n">sac_ts</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]]</span><span class="o">-</span><span class="n">tfix</span> <span class="o">&gt;=</span> <span class="n">dur_thresh</span><span class="p">:</span>
</span><span id="MultiClouds.process_fixations-1229"><a href="#MultiClouds.process_fixations-1229"><span class="linenos">1229</span></a>                    <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MultiClouds.process_fixations-1230"><a href="#MultiClouds.process_fixations-1230"><span class="linenos">1230</span></a>                    <span class="c1"># Range goes to beginning of next fixation (note no gap)</span>
</span><span id="MultiClouds.process_fixations-1231"><a href="#MultiClouds.process_fixations-1231"><span class="linenos">1231</span></a>                    <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="n">sac_ts</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="MultiClouds.process_fixations-1232"><a href="#MultiClouds.process_fixations-1232"><span class="linenos">1232</span></a>                <span class="n">tfix</span> <span class="o">=</span> <span class="n">sac_ts</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]]</span>
</span><span id="MultiClouds.process_fixations-1233"><a href="#MultiClouds.process_fixations-1233"><span class="linenos">1233</span></a>            <span class="c1"># Put in last (or only) fixation number</span>
</span><span id="MultiClouds.process_fixations-1234"><a href="#MultiClouds.process_fixations-1234"><span class="linenos">1234</span></a>            <span class="k">if</span> <span class="n">tfix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="MultiClouds.process_fixations-1235"><a href="#MultiClouds.process_fixations-1235"><span class="linenos">1235</span></a>                <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MultiClouds.process_fixations-1236"><a href="#MultiClouds.process_fixations-1236"><span class="linenos">1236</span></a>                <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="MultiClouds.process_fixations-1237"><a href="#MultiClouds.process_fixations-1237"><span class="linenos">1237</span></a>
</span><span id="MultiClouds.process_fixations-1238"><a href="#MultiClouds.process_fixations-1238"><span class="linenos">1238</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Created </span><span class="si">%d</span><span class="s2"> fixations&quot;</span><span class="o">%</span><span class="n">fix_count</span><span class="p">)</span>
</span><span id="MultiClouds.process_fixations-1239"><a href="#MultiClouds.process_fixations-1239"><span class="linenos">1239</span></a>
</span><span id="MultiClouds.process_fixations-1240"><a href="#MultiClouds.process_fixations-1240"><span class="linenos">1240</span></a>        <span class="k">if</span> <span class="n">modify_dfs</span><span class="p">:</span>
</span><span id="MultiClouds.process_fixations-1241"><a href="#MultiClouds.process_fixations-1241"><span class="linenos">1241</span></a>            <span class="n">invalid_fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fix_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.process_fixations-1242"><a href="#MultiClouds.process_fixations-1242"><span class="linenos">1242</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">invalid_fix_n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds.process_fixations-1243"><a href="#MultiClouds.process_fixations-1243"><span class="linenos">1243</span></a>            
</span><span id="MultiClouds.process_fixations-1244"><a href="#MultiClouds.process_fixations-1244"><span class="linenos">1244</span></a>        <span class="k">return</span> <span class="n">fix_n</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Generates fix_n based on existing trial structure and imported fixations. Will only work for specified
experiment (expt_n variable) and assume timings are based on the beginning of that experiment.
Output: fix_n</p>

<p>Default: modify_dfs=True will zero out data where there is no assigned fixation</p>

<p>Note that this will assume that saccades correspond to relevant trange (e.g., binocular section) rather
than the whole experiment.</p>

<p>Can also use metric criteria to only use fraction of total saccades: sacc_metrics can be amplitude, and 
sacc_thresh be inclusion criteria (must be greater than sacc_thresh)</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>sacc_in (np.array):</strong>  saccade times</li>
<li><strong>expt_n (int):</strong>  index of the experiment</li>
<li><strong>sacc_metrics (np.array):</strong>  saccade metrics</li>
<li><strong>thresh (float):</strong>  threshold for saccade metrics</li>
<li><strong>dur_thresh (int):</strong>  duration threshold</li>
<li><strong>modify_dfs (bool):</strong>  modify dfs</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>np.array: fixation numbers</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiClouds.shift_stim" class="classattr">
                                        <input id="MultiClouds.shift_stim-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">shift_stim</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">stim</span>, </span><span class="param"><span class="n">eyepos</span>, </span><span class="param"><span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">batch_size</span><span class="o">=</span><span class="mi">5000</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.shift_stim-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.shift_stim"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.shift_stim-1247"><a href="#MultiClouds.shift_stim-1247"><span class="linenos">1247</span></a>    <span class="nd">@staticmethod</span> 
</span><span id="MultiClouds.shift_stim-1248"><a href="#MultiClouds.shift_stim-1248"><span class="linenos">1248</span></a>    <span class="k">def</span> <span class="nf">shift_stim</span><span class="p">(</span> <span class="n">stim</span><span class="p">,</span> <span class="n">eyepos</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">5000</span><span class="p">):</span>
</span><span id="MultiClouds.shift_stim-1249"><a href="#MultiClouds.shift_stim-1249"><span class="linenos">1249</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.shift_stim-1250"><a href="#MultiClouds.shift_stim-1250"><span class="linenos">1250</span></a><span class="sd">        Shift stimulus based on eye position</span>
</span><span id="MultiClouds.shift_stim-1251"><a href="#MultiClouds.shift_stim-1251"><span class="linenos">1251</span></a>
</span><span id="MultiClouds.shift_stim-1252"><a href="#MultiClouds.shift_stim-1252"><span class="linenos">1252</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds.shift_stim-1253"><a href="#MultiClouds.shift_stim-1253"><span class="linenos">1253</span></a><span class="sd">            stim (np.array): stimulus to shift</span>
</span><span id="MultiClouds.shift_stim-1254"><a href="#MultiClouds.shift_stim-1254"><span class="linenos">1254</span></a><span class="sd">            eyepos (np.array): eye position</span>
</span><span id="MultiClouds.shift_stim-1255"><a href="#MultiClouds.shift_stim-1255"><span class="linenos">1255</span></a><span class="sd">            input_dims (list): input dimensions</span>
</span><span id="MultiClouds.shift_stim-1256"><a href="#MultiClouds.shift_stim-1256"><span class="linenos">1256</span></a><span class="sd">            batch_size (int): batch size</span>
</span><span id="MultiClouds.shift_stim-1257"><a href="#MultiClouds.shift_stim-1257"><span class="linenos">1257</span></a>
</span><span id="MultiClouds.shift_stim-1258"><a href="#MultiClouds.shift_stim-1258"><span class="linenos">1258</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds.shift_stim-1259"><a href="#MultiClouds.shift_stim-1259"><span class="linenos">1259</span></a><span class="sd">            np.array: shifted stimulus</span>
</span><span id="MultiClouds.shift_stim-1260"><a href="#MultiClouds.shift_stim-1260"><span class="linenos">1260</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.shift_stim-1261"><a href="#MultiClouds.shift_stim-1261"><span class="linenos">1261</span></a>        <span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
</span><span id="MultiClouds.shift_stim-1262"><a href="#MultiClouds.shift_stim-1262"><span class="linenos">1262</span></a>        <span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span><span id="MultiClouds.shift_stim-1263"><a href="#MultiClouds.shift_stim-1263"><span class="linenos">1263</span></a>
</span><span id="MultiClouds.shift_stim-1264"><a href="#MultiClouds.shift_stim-1264"><span class="linenos">1264</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="MultiClouds.shift_stim-1265"><a href="#MultiClouds.shift_stim-1265"><span class="linenos">1265</span></a>            <span class="k">assert</span> <span class="n">input_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;  SHIFT_STIM: stim must be unflatteded or input_dims passed in&quot;</span>
</span><span id="MultiClouds.shift_stim-1266"><a href="#MultiClouds.shift_stim-1266"><span class="linenos">1266</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">input_dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
</span><span id="MultiClouds.shift_stim-1267"><a href="#MultiClouds.shift_stim-1267"><span class="linenos">1267</span></a>            <span class="n">to_flatten</span><span class="o">=</span><span class="kc">True</span>
</span><span id="MultiClouds.shift_stim-1268"><a href="#MultiClouds.shift_stim-1268"><span class="linenos">1268</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.shift_stim-1269"><a href="#MultiClouds.shift_stim-1269"><span class="linenos">1269</span></a>            <span class="n">to_flatten</span><span class="o">=</span><span class="kc">False</span>
</span><span id="MultiClouds.shift_stim-1270"><a href="#MultiClouds.shift_stim-1270"><span class="linenos">1270</span></a>
</span><span id="MultiClouds.shift_stim-1271"><a href="#MultiClouds.shift_stim-1271"><span class="linenos">1271</span></a>        <span class="c1"># Determine scaling for translation</span>
</span><span id="MultiClouds.shift_stim-1272"><a href="#MultiClouds.shift_stim-1272"><span class="linenos">1272</span></a>        <span class="n">Lscale</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">/</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MultiClouds.shift_stim-1273"><a href="#MultiClouds.shift_stim-1273"><span class="linenos">1273</span></a>
</span><span id="MultiClouds.shift_stim-1274"><a href="#MultiClouds.shift_stim-1274"><span class="linenos">1274</span></a>        <span class="n">stim_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="MultiClouds.shift_stim-1275"><a href="#MultiClouds.shift_stim-1275"><span class="linenos">1275</span></a>            <span class="s1">&#39;ts&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>  <span class="c1"># keep track of indices for remapping</span>
</span><span id="MultiClouds.shift_stim-1276"><a href="#MultiClouds.shift_stim-1276"><span class="linenos">1276</span></a>            <span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
</span><span id="MultiClouds.shift_stim-1277"><a href="#MultiClouds.shift_stim-1277"><span class="linenos">1277</span></a>            <span class="s1">&#39;eyepos&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">eyepos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">*</span><span class="n">Lscale</span> <span class="p">}</span>
</span><span id="MultiClouds.shift_stim-1278"><a href="#MultiClouds.shift_stim-1278"><span class="linenos">1278</span></a>
</span><span id="MultiClouds.shift_stim-1279"><a href="#MultiClouds.shift_stim-1279"><span class="linenos">1279</span></a>        <span class="n">ds</span> <span class="o">=</span> <span class="n">GenericDataset</span><span class="p">(</span><span class="n">stim_data</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="MultiClouds.shift_stim-1280"><a href="#MultiClouds.shift_stim-1280"><span class="linenos">1280</span></a>        <span class="c1">#ds.covariates[&#39;stim&#39;] = ds.covariates[&#39;stim&#39;].flatten(start_dim=1)</span>
</span><span id="MultiClouds.shift_stim-1281"><a href="#MultiClouds.shift_stim-1281"><span class="linenos">1281</span></a>        <span class="n">dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="MultiClouds.shift_stim-1282"><a href="#MultiClouds.shift_stim-1282"><span class="linenos">1282</span></a>
</span><span id="MultiClouds.shift_stim-1283"><a href="#MultiClouds.shift_stim-1283"><span class="linenos">1283</span></a>        <span class="n">stimSH</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_data</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">])</span>
</span><span id="MultiClouds.shift_stim-1284"><a href="#MultiClouds.shift_stim-1284"><span class="linenos">1284</span></a>        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dl</span><span class="p">):</span>
</span><span id="MultiClouds.shift_stim-1285"><a href="#MultiClouds.shift_stim-1285"><span class="linenos">1285</span></a>            <span class="n">stimSH</span><span class="p">[</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">MultiClouds</span><span class="o">.</span><span class="n">shift_im</span><span class="p">(</span>
</span><span id="MultiClouds.shift_stim-1286"><a href="#MultiClouds.shift_stim-1286"><span class="linenos">1286</span></a>                <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;eyepos&#39;</span><span class="p">][:,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> 
</span><span id="MultiClouds.shift_stim-1287"><a href="#MultiClouds.shift_stim-1287"><span class="linenos">1287</span></a>                <span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
</span><span id="MultiClouds.shift_stim-1288"><a href="#MultiClouds.shift_stim-1288"><span class="linenos">1288</span></a>        
</span><span id="MultiClouds.shift_stim-1289"><a href="#MultiClouds.shift_stim-1289"><span class="linenos">1289</span></a>        <span class="k">if</span> <span class="n">to_flatten</span><span class="p">:</span>
</span><span id="MultiClouds.shift_stim-1290"><a href="#MultiClouds.shift_stim-1290"><span class="linenos">1290</span></a>            <span class="n">stimSH</span> <span class="o">=</span> <span class="n">stimSH</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">start_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MultiClouds.shift_stim-1291"><a href="#MultiClouds.shift_stim-1291"><span class="linenos">1291</span></a>        <span class="k">return</span> <span class="n">stimSH</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Shift stimulus based on eye position</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>stim (np.array):</strong>  stimulus to shift</li>
<li><strong>eyepos (np.array):</strong>  eye position</li>
<li><strong>input_dims (list):</strong>  input dimensions</li>
<li><strong>batch_size (int):</strong>  batch size</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>np.array: shifted stimulus</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiClouds.shift_im" class="classattr">
                                        <input id="MultiClouds.shift_im-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">shift_im</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">stim</span>, </span><span class="param"><span class="n">shift</span>, </span><span class="param"><span class="n">affine</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span>, </span><span class="param"><span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.shift_im-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.shift_im"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.shift_im-1293"><a href="#MultiClouds.shift_im-1293"><span class="linenos">1293</span></a>    <span class="nd">@staticmethod</span>
</span><span id="MultiClouds.shift_im-1294"><a href="#MultiClouds.shift_im-1294"><span class="linenos">1294</span></a>    <span class="k">def</span> <span class="nf">shift_im</span><span class="p">(</span> <span class="n">stim</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="MultiClouds.shift_im-1295"><a href="#MultiClouds.shift_im-1295"><span class="linenos">1295</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.shift_im-1296"><a href="#MultiClouds.shift_im-1296"><span class="linenos">1296</span></a><span class="sd">        Primary function for shifting the intput stimulus</span>
</span><span id="MultiClouds.shift_im-1297"><a href="#MultiClouds.shift_im-1297"><span class="linenos">1297</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds.shift_im-1298"><a href="#MultiClouds.shift_im-1298"><span class="linenos">1298</span></a><span class="sd">            stim: [Batch x channels x height x width] (use Fold2d to fold lags if necessary)</span>
</span><span id="MultiClouds.shift_im-1299"><a href="#MultiClouds.shift_im-1299"><span class="linenos">1299</span></a><span class="sd">            shift: [Batch x 2] or [Batch x 4] if translation only or affine</span>
</span><span id="MultiClouds.shift_im-1300"><a href="#MultiClouds.shift_im-1300"><span class="linenos">1300</span></a><span class="sd">            affine: [Boolean] set to True if using affine transformation</span>
</span><span id="MultiClouds.shift_im-1301"><a href="#MultiClouds.shift_im-1301"><span class="linenos">1301</span></a><span class="sd">            mode: [str] &#39;bilinear&#39; (default) or &#39;nearest&#39;</span>
</span><span id="MultiClouds.shift_im-1302"><a href="#MultiClouds.shift_im-1302"><span class="linenos">1302</span></a><span class="sd">            batch_size: [int] if None, will use all data at once</span>
</span><span id="MultiClouds.shift_im-1303"><a href="#MultiClouds.shift_im-1303"><span class="linenos">1303</span></a><span class="sd">            NOTE: mode must be bilinear during fitting otherwise the gradients don&#39;t propogate well</span>
</span><span id="MultiClouds.shift_im-1304"><a href="#MultiClouds.shift_im-1304"><span class="linenos">1304</span></a>
</span><span id="MultiClouds.shift_im-1305"><a href="#MultiClouds.shift_im-1305"><span class="linenos">1305</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds.shift_im-1306"><a href="#MultiClouds.shift_im-1306"><span class="linenos">1306</span></a><span class="sd">            torch.tensor: shifted stimulus</span>
</span><span id="MultiClouds.shift_im-1307"><a href="#MultiClouds.shift_im-1307"><span class="linenos">1307</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.shift_im-1308"><a href="#MultiClouds.shift_im-1308"><span class="linenos">1308</span></a>        <span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
</span><span id="MultiClouds.shift_im-1309"><a href="#MultiClouds.shift_im-1309"><span class="linenos">1309</span></a>
</span><span id="MultiClouds.shift_im-1310"><a href="#MultiClouds.shift_im-1310"><span class="linenos">1310</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.shift_im-1311"><a href="#MultiClouds.shift_im-1311"><span class="linenos">1311</span></a>
</span><span id="MultiClouds.shift_im-1312"><a href="#MultiClouds.shift_im-1312"><span class="linenos">1312</span></a>        <span class="c1"># build affine transformation matrix size = [batch x 2 x 3]</span>
</span><span id="MultiClouds.shift_im-1313"><a href="#MultiClouds.shift_im-1313"><span class="linenos">1313</span></a>        <span class="n">affine_trans</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">stim</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">stim</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MultiClouds.shift_im-1314"><a href="#MultiClouds.shift_im-1314"><span class="linenos">1314</span></a>        
</span><span id="MultiClouds.shift_im-1315"><a href="#MultiClouds.shift_im-1315"><span class="linenos">1315</span></a>        <span class="k">if</span> <span class="n">affine</span><span class="p">:</span>
</span><span id="MultiClouds.shift_im-1316"><a href="#MultiClouds.shift_im-1316"><span class="linenos">1316</span></a>            <span class="c1"># fill in rotation and scaling</span>
</span><span id="MultiClouds.shift_im-1317"><a href="#MultiClouds.shift_im-1317"><span class="linenos">1317</span></a>            <span class="n">costheta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">shift</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">.5</span><span class="p">))</span>
</span><span id="MultiClouds.shift_im-1318"><a href="#MultiClouds.shift_im-1318"><span class="linenos">1318</span></a>            <span class="n">sintheta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">shift</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">.5</span><span class="p">))</span>
</span><span id="MultiClouds.shift_im-1319"><a href="#MultiClouds.shift_im-1319"><span class="linenos">1319</span></a>            
</span><span id="MultiClouds.shift_im-1320"><a href="#MultiClouds.shift_im-1320"><span class="linenos">1320</span></a>            <span class="n">scale</span> <span class="o">=</span> <span class="n">shift</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">1.0</span>
</span><span id="MultiClouds.shift_im-1321"><a href="#MultiClouds.shift_im-1321"><span class="linenos">1321</span></a>
</span><span id="MultiClouds.shift_im-1322"><a href="#MultiClouds.shift_im-1322"><span class="linenos">1322</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">costheta</span><span class="o">*</span><span class="n">scale</span>
</span><span id="MultiClouds.shift_im-1323"><a href="#MultiClouds.shift_im-1323"><span class="linenos">1323</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sintheta</span><span class="o">*</span><span class="n">scale</span>
</span><span id="MultiClouds.shift_im-1324"><a href="#MultiClouds.shift_im-1324"><span class="linenos">1324</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sintheta</span><span class="o">*</span><span class="n">scale</span>
</span><span id="MultiClouds.shift_im-1325"><a href="#MultiClouds.shift_im-1325"><span class="linenos">1325</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">costheta</span><span class="o">*</span><span class="n">scale</span>
</span><span id="MultiClouds.shift_im-1326"><a href="#MultiClouds.shift_im-1326"><span class="linenos">1326</span></a>
</span><span id="MultiClouds.shift_im-1327"><a href="#MultiClouds.shift_im-1327"><span class="linenos">1327</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.shift_im-1328"><a href="#MultiClouds.shift_im-1328"><span class="linenos">1328</span></a>            <span class="c1"># no rotation or scaling</span>
</span><span id="MultiClouds.shift_im-1329"><a href="#MultiClouds.shift_im-1329"><span class="linenos">1329</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MultiClouds.shift_im-1330"><a href="#MultiClouds.shift_im-1330"><span class="linenos">1330</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds.shift_im-1331"><a href="#MultiClouds.shift_im-1331"><span class="linenos">1331</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds.shift_im-1332"><a href="#MultiClouds.shift_im-1332"><span class="linenos">1332</span></a>            <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MultiClouds.shift_im-1333"><a href="#MultiClouds.shift_im-1333"><span class="linenos">1333</span></a>
</span><span id="MultiClouds.shift_im-1334"><a href="#MultiClouds.shift_im-1334"><span class="linenos">1334</span></a>        <span class="c1"># translation</span>
</span><span id="MultiClouds.shift_im-1335"><a href="#MultiClouds.shift_im-1335"><span class="linenos">1335</span></a>        <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.shift_im-1336"><a href="#MultiClouds.shift_im-1336"><span class="linenos">1336</span></a>        <span class="n">affine_trans</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds.shift_im-1337"><a href="#MultiClouds.shift_im-1337"><span class="linenos">1337</span></a>
</span><span id="MultiClouds.shift_im-1338"><a href="#MultiClouds.shift_im-1338"><span class="linenos">1338</span></a>        <span class="n">grid</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">affine_grid</span><span class="p">(</span><span class="n">affine_trans</span><span class="p">,</span> <span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MultiClouds.shift_im-1339"><a href="#MultiClouds.shift_im-1339"><span class="linenos">1339</span></a>
</span><span id="MultiClouds.shift_im-1340"><a href="#MultiClouds.shift_im-1340"><span class="linenos">1340</span></a>        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Primary function for shifting the intput stimulus</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>stim:</strong>  [Batch x channels x height x width] (use Fold2d to fold lags if necessary)</li>
<li><strong>shift:</strong>  [Batch x 2] or [Batch x 4] if translation only or affine</li>
<li><strong>affine:</strong>  [Boolean] set to True if using affine transformation</li>
<li><strong>mode:</strong>  [str] 'bilinear' (default) or 'nearest'</li>
<li><strong>batch_size:</strong>  [int] if None, will use all data at once</li>
<li><strong>NOTE:</strong>  mode must be bilinear during fitting otherwise the gradients don't propogate well</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>torch.tensor: shifted stimulus</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiClouds.get_max_samples" class="classattr">
                                        <input id="MultiClouds.get_max_samples-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_max_samples</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">gpu_n</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">history_size</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="n">nquad</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">buffer</span><span class="o">=</span><span class="mf">1.2</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.get_max_samples-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.get_max_samples"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.get_max_samples-1343"><a href="#MultiClouds.get_max_samples-1343"><span class="linenos">1343</span></a>    <span class="k">def</span> <span class="nf">get_max_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpu_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nquad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mf">1.2</span><span class="p">):</span>
</span><span id="MultiClouds.get_max_samples-1344"><a href="#MultiClouds.get_max_samples-1344"><span class="linenos">1344</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.get_max_samples-1345"><a href="#MultiClouds.get_max_samples-1345"><span class="linenos">1345</span></a><span class="sd">        get the maximum number of samples that fit in memory -- for GLM/GQM x LBFGS</span>
</span><span id="MultiClouds.get_max_samples-1346"><a href="#MultiClouds.get_max_samples-1346"><span class="linenos">1346</span></a>
</span><span id="MultiClouds.get_max_samples-1347"><a href="#MultiClouds.get_max_samples-1347"><span class="linenos">1347</span></a><span class="sd">        Args:</span>
</span><span id="MultiClouds.get_max_samples-1348"><a href="#MultiClouds.get_max_samples-1348"><span class="linenos">1348</span></a><span class="sd">            gpu_n (int): GPU number</span>
</span><span id="MultiClouds.get_max_samples-1349"><a href="#MultiClouds.get_max_samples-1349"><span class="linenos">1349</span></a><span class="sd">            history_size (int): history size</span>
</span><span id="MultiClouds.get_max_samples-1350"><a href="#MultiClouds.get_max_samples-1350"><span class="linenos">1350</span></a><span class="sd">            nquad (int): number of quadrature points</span>
</span><span id="MultiClouds.get_max_samples-1351"><a href="#MultiClouds.get_max_samples-1351"><span class="linenos">1351</span></a><span class="sd">            num_cells (int): number of cells</span>
</span><span id="MultiClouds.get_max_samples-1352"><a href="#MultiClouds.get_max_samples-1352"><span class="linenos">1352</span></a><span class="sd">            buffer (float): buffer size</span>
</span><span id="MultiClouds.get_max_samples-1353"><a href="#MultiClouds.get_max_samples-1353"><span class="linenos">1353</span></a>
</span><span id="MultiClouds.get_max_samples-1354"><a href="#MultiClouds.get_max_samples-1354"><span class="linenos">1354</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds.get_max_samples-1355"><a href="#MultiClouds.get_max_samples-1355"><span class="linenos">1355</span></a><span class="sd">            int: maximum number of samples</span>
</span><span id="MultiClouds.get_max_samples-1356"><a href="#MultiClouds.get_max_samples-1356"><span class="linenos">1356</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.get_max_samples-1357"><a href="#MultiClouds.get_max_samples-1357"><span class="linenos">1357</span></a>        <span class="k">if</span> <span class="n">gpu_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiClouds.get_max_samples-1358"><a href="#MultiClouds.get_max_samples-1358"><span class="linenos">1358</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
</span><span id="MultiClouds.get_max_samples-1359"><a href="#MultiClouds.get_max_samples-1359"><span class="linenos">1359</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.get_max_samples-1360"><a href="#MultiClouds.get_max_samples-1360"><span class="linenos">1360</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:1&#39;</span><span class="p">)</span>
</span><span id="MultiClouds.get_max_samples-1361"><a href="#MultiClouds.get_max_samples-1361"><span class="linenos">1361</span></a>
</span><span id="MultiClouds.get_max_samples-1362"><a href="#MultiClouds.get_max_samples-1362"><span class="linenos">1362</span></a>        <span class="k">if</span> <span class="n">num_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.get_max_samples-1363"><a href="#MultiClouds.get_max_samples-1363"><span class="linenos">1363</span></a>            <span class="n">num_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span>
</span><span id="MultiClouds.get_max_samples-1364"><a href="#MultiClouds.get_max_samples-1364"><span class="linenos">1364</span></a>        
</span><span id="MultiClouds.get_max_samples-1365"><a href="#MultiClouds.get_max_samples-1365"><span class="linenos">1365</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">total_memory</span>
</span><span id="MultiClouds.get_max_samples-1366"><a href="#MultiClouds.get_max_samples-1366"><span class="linenos">1366</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_reserved</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="MultiClouds.get_max_samples-1367"><a href="#MultiClouds.get_max_samples-1367"><span class="linenos">1367</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_allocated</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="MultiClouds.get_max_samples-1368"><a href="#MultiClouds.get_max_samples-1368"><span class="linenos">1368</span></a>        <span class="n">free</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">r</span><span class="p">)</span>
</span><span id="MultiClouds.get_max_samples-1369"><a href="#MultiClouds.get_max_samples-1369"><span class="linenos">1369</span></a>
</span><span id="MultiClouds.get_max_samples-1370"><a href="#MultiClouds.get_max_samples-1370"><span class="linenos">1370</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.get_max_samples-1371"><a href="#MultiClouds.get_max_samples-1371"><span class="linenos">1371</span></a>        <span class="n">mempersample</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span>
</span><span id="MultiClouds.get_max_samples-1372"><a href="#MultiClouds.get_max_samples-1372"><span class="linenos">1372</span></a>    
</span><span id="MultiClouds.get_max_samples-1373"><a href="#MultiClouds.get_max_samples-1373"><span class="linenos">1373</span></a>        <span class="n">mempercell</span> <span class="o">=</span> <span class="n">mempersample</span> <span class="o">*</span> <span class="p">(</span><span class="n">nquad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">history_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="MultiClouds.get_max_samples-1374"><a href="#MultiClouds.get_max_samples-1374"><span class="linenos">1374</span></a>        <span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">*</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span>
</span><span id="MultiClouds.get_max_samples-1375"><a href="#MultiClouds.get_max_samples-1375"><span class="linenos">1375</span></a>
</span><span id="MultiClouds.get_max_samples-1376"><a href="#MultiClouds.get_max_samples-1376"><span class="linenos">1376</span></a>        <span class="n">maxsamples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">free</span> <span class="o">-</span> <span class="n">mempercell</span><span class="o">*</span><span class="n">num_cells</span> <span class="o">-</span> <span class="n">buffer_bytes</span><span class="p">)</span> <span class="o">//</span> <span class="n">mempersample</span>
</span><span id="MultiClouds.get_max_samples-1377"><a href="#MultiClouds.get_max_samples-1377"><span class="linenos">1377</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# samples that can fit on device: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxsamples</span><span class="p">))</span>
</span><span id="MultiClouds.get_max_samples-1378"><a href="#MultiClouds.get_max_samples-1378"><span class="linenos">1378</span></a>        <span class="k">return</span> <span class="n">maxsamples</span>
</span><span id="MultiClouds.get_max_samples-1379"><a href="#MultiClouds.get_max_samples-1379"><span class="linenos">1379</span></a>    <span class="c1"># END .get_max_samples</span>
</span><span id="MultiClouds.get_max_samples-1380"><a href="#MultiClouds.get_max_samples-1380"><span class="linenos">1380</span></a>
</span><span id="MultiClouds.get_max_samples-1381"><a href="#MultiClouds.get_max_samples-1381"><span class="linenos">1381</span></a>        <span class="c1">### THIS IS NOT USED ANY MORE BUT STILL HAS SOME GOOD CODE INSIDE ###</span>
</span></pre></div>


            <div class="docstring"><p>get the maximum number of samples that fit in memory -- for GLM/GQM x LBFGS</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>gpu_n (int):</strong>  GPU number</li>
<li><strong>history_size (int):</strong>  history size</li>
<li><strong>nquad (int):</strong>  number of quadrature points</li>
<li><strong>num_cells (int):</strong>  number of cells</li>
<li><strong>buffer (float):</strong>  buffer size</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>int: maximum number of samples</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiClouds.preload_numpy" class="classattr">
                                        <input id="MultiClouds.preload_numpy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">preload_numpy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiClouds.preload_numpy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiClouds.preload_numpy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiClouds.preload_numpy-1382"><a href="#MultiClouds.preload_numpy-1382"><span class="linenos">1382</span></a>    <span class="k">def</span> <span class="nf">preload_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MultiClouds.preload_numpy-1383"><a href="#MultiClouds.preload_numpy-1383"><span class="linenos">1383</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiClouds.preload_numpy-1384"><a href="#MultiClouds.preload_numpy-1384"><span class="linenos">1384</span></a><span class="sd">        Note this loads stimulus but does not time-embed</span>
</span><span id="MultiClouds.preload_numpy-1385"><a href="#MultiClouds.preload_numpy-1385"><span class="linenos">1385</span></a><span class="sd">        </span>
</span><span id="MultiClouds.preload_numpy-1386"><a href="#MultiClouds.preload_numpy-1386"><span class="linenos">1386</span></a><span class="sd">        Returns:</span>
</span><span id="MultiClouds.preload_numpy-1387"><a href="#MultiClouds.preload_numpy-1387"><span class="linenos">1387</span></a><span class="sd">            None</span>
</span><span id="MultiClouds.preload_numpy-1388"><a href="#MultiClouds.preload_numpy-1388"><span class="linenos">1388</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiClouds.preload_numpy-1389"><a href="#MultiClouds.preload_numpy-1389"><span class="linenos">1389</span></a>
</span><span id="MultiClouds.preload_numpy-1390"><a href="#MultiClouds.preload_numpy-1390"><span class="linenos">1390</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span><span id="MultiClouds.preload_numpy-1391"><a href="#MultiClouds.preload_numpy-1391"><span class="linenos">1391</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="MultiClouds.preload_numpy-1392"><a href="#MultiClouds.preload_numpy-1392"><span class="linenos">1392</span></a><span class="sd">        Pre-allocate memory for data</span>
</span><span id="MultiClouds.preload_numpy-1393"><a href="#MultiClouds.preload_numpy-1393"><span class="linenos">1393</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="MultiClouds.preload_numpy-1394"><a href="#MultiClouds.preload_numpy-1394"><span class="linenos">1394</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds.preload_numpy-1395"><a href="#MultiClouds.preload_numpy-1395"><span class="linenos">1395</span></a>        <span class="k">if</span> <span class="s1">&#39;stimET&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="MultiClouds.preload_numpy-1396"><a href="#MultiClouds.preload_numpy-1396"><span class="linenos">1396</span></a>            <span class="c1"># Check to see if 1-d or 2-d eye tracking</span>
</span><span id="MultiClouds.preload_numpy-1397"><a href="#MultiClouds.preload_numpy-1397"><span class="linenos">1397</span></a>            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:</span><span class="mi">100</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.preload_numpy-1398"><a href="#MultiClouds.preload_numpy-1398"><span class="linenos">1398</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="MultiClouds.preload_numpy-1399"><a href="#MultiClouds.preload_numpy-1399"><span class="linenos">1399</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ET stimulus is 1-d bars.&quot;</span><span class="p">)</span>
</span><span id="MultiClouds.preload_numpy-1400"><a href="#MultiClouds.preload_numpy-1400"><span class="linenos">1400</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds.preload_numpy-1401"><a href="#MultiClouds.preload_numpy-1401"><span class="linenos">1401</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.preload_numpy-1402"><a href="#MultiClouds.preload_numpy-1402"><span class="linenos">1402</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds.preload_numpy-1403"><a href="#MultiClouds.preload_numpy-1403"><span class="linenos">1403</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.preload_numpy-1404"><a href="#MultiClouds.preload_numpy-1404"><span class="linenos">1404</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MultiClouds.preload_numpy-1405"><a href="#MultiClouds.preload_numpy-1405"><span class="linenos">1405</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Missing ETstimulus&#39;</span><span class="p">)</span>
</span><span id="MultiClouds.preload_numpy-1406"><a href="#MultiClouds.preload_numpy-1406"><span class="linenos">1406</span></a>
</span><span id="MultiClouds.preload_numpy-1407"><a href="#MultiClouds.preload_numpy-1407"><span class="linenos">1407</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds.preload_numpy-1408"><a href="#MultiClouds.preload_numpy-1408"><span class="linenos">1408</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds.preload_numpy-1409"><a href="#MultiClouds.preload_numpy-1409"><span class="linenos">1409</span></a>        <span class="c1">#self.eyepos = np.zeros([NT, 2], dtype=np.float32)</span>
</span><span id="MultiClouds.preload_numpy-1410"><a href="#MultiClouds.preload_numpy-1410"><span class="linenos">1410</span></a>        <span class="c1">#self.frame_times = np.zeros([NT,1], dtype=np.float32)</span>
</span><span id="MultiClouds.preload_numpy-1411"><a href="#MultiClouds.preload_numpy-1411"><span class="linenos">1411</span></a>
</span><span id="MultiClouds.preload_numpy-1412"><a href="#MultiClouds.preload_numpy-1412"><span class="linenos">1412</span></a>        <span class="n">t_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds.preload_numpy-1413"><a href="#MultiClouds.preload_numpy-1413"><span class="linenos">1413</span></a>        <span class="n">unit_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiClouds.preload_numpy-1414"><a href="#MultiClouds.preload_numpy-1414"><span class="linenos">1414</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">)):</span>
</span><span id="MultiClouds.preload_numpy-1415"><a href="#MultiClouds.preload_numpy-1415"><span class="linenos">1415</span></a>            
</span><span id="MultiClouds.preload_numpy-1416"><a href="#MultiClouds.preload_numpy-1416"><span class="linenos">1416</span></a>            <span class="n">fhandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="MultiClouds.preload_numpy-1417"><a href="#MultiClouds.preload_numpy-1417"><span class="linenos">1417</span></a>            <span class="n">sz</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="MultiClouds.preload_numpy-1418"><a href="#MultiClouds.preload_numpy-1418"><span class="linenos">1418</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_counter</span><span class="p">,</span> <span class="n">t_counter</span><span class="o">+</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiClouds.preload_numpy-1419"><a href="#MultiClouds.preload_numpy-1419"><span class="linenos">1419</span></a>            <span class="c1">#inds = self.stim_indices[expt][stim][&#39;inds&#39;]</span>
</span><span id="MultiClouds.preload_numpy-1420"><a href="#MultiClouds.preload_numpy-1420"><span class="linenos">1420</span></a>            <span class="c1">#self.stim[inds, ...] = np.transpose( np.array(fhandle[self.stimname], dtype=np.float32), axes=[0,3,1,2])</span>
</span><span id="MultiClouds.preload_numpy-1421"><a href="#MultiClouds.preload_numpy-1421"><span class="linenos">1421</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="MultiClouds.preload_numpy-1422"><a href="#MultiClouds.preload_numpy-1422"><span class="linenos">1422</span></a>                <span class="n">Leye</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="MultiClouds.preload_numpy-1423"><a href="#MultiClouds.preload_numpy-1423"><span class="linenos">1423</span></a>                <span class="n">Reye</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="MultiClouds.preload_numpy-1424"><a href="#MultiClouds.preload_numpy-1424"><span class="linenos">1424</span></a>                <span class="c1">#Leye = inds[np.where(self.LRpresent[inds] != 2)[0]]</span>
</span><span id="MultiClouds.preload_numpy-1425"><a href="#MultiClouds.preload_numpy-1425"><span class="linenos">1425</span></a>                <span class="c1">#Reye = inds[np.where(self.LRpresent[inds] != 1)[0]]</span>
</span><span id="MultiClouds.preload_numpy-1426"><a href="#MultiClouds.preload_numpy-1426"><span class="linenos">1426</span></a>                <span class="c1">#print(len(Leye), len(Reye))</span>
</span><span id="MultiClouds.preload_numpy-1427"><a href="#MultiClouds.preload_numpy-1427"><span class="linenos">1427</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="MultiClouds.preload_numpy-1428"><a href="#MultiClouds.preload_numpy-1428"><span class="linenos">1428</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.preload_numpy-1429"><a href="#MultiClouds.preload_numpy-1429"><span class="linenos">1429</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.preload_numpy-1430"><a href="#MultiClouds.preload_numpy-1430"><span class="linenos">1430</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.preload_numpy-1431"><a href="#MultiClouds.preload_numpy-1431"><span class="linenos">1431</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.preload_numpy-1432"><a href="#MultiClouds.preload_numpy-1432"><span class="linenos">1432</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.preload_numpy-1433"><a href="#MultiClouds.preload_numpy-1433"><span class="linenos">1433</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.preload_numpy-1434"><a href="#MultiClouds.preload_numpy-1434"><span class="linenos">1434</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="MultiClouds.preload_numpy-1435"><a href="#MultiClouds.preload_numpy-1435"><span class="linenos">1435</span></a>                    <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.preload_numpy-1436"><a href="#MultiClouds.preload_numpy-1436"><span class="linenos">1436</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="MultiClouds.preload_numpy-1437"><a href="#MultiClouds.preload_numpy-1437"><span class="linenos">1437</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="MultiClouds.preload_numpy-1438"><a href="#MultiClouds.preload_numpy-1438"><span class="linenos">1438</span></a>                    <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.preload_numpy-1439"><a href="#MultiClouds.preload_numpy-1439"><span class="linenos">1439</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="MultiClouds.preload_numpy-1440"><a href="#MultiClouds.preload_numpy-1440"><span class="linenos">1440</span></a>
</span><span id="MultiClouds.preload_numpy-1441"><a href="#MultiClouds.preload_numpy-1441"><span class="linenos">1441</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.preload_numpy-1442"><a href="#MultiClouds.preload_numpy-1442"><span class="linenos">1442</span></a>                        <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="MultiClouds.preload_numpy-1443"><a href="#MultiClouds.preload_numpy-1443"><span class="linenos">1443</span></a>                        <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.preload_numpy-1444"><a href="#MultiClouds.preload_numpy-1444"><span class="linenos">1444</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="MultiClouds.preload_numpy-1445"><a href="#MultiClouds.preload_numpy-1445"><span class="linenos">1445</span></a>                        <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="MultiClouds.preload_numpy-1446"><a href="#MultiClouds.preload_numpy-1446"><span class="linenos">1446</span></a>                        <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.preload_numpy-1447"><a href="#MultiClouds.preload_numpy-1447"><span class="linenos">1447</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="MultiClouds.preload_numpy-1448"><a href="#MultiClouds.preload_numpy-1448"><span class="linenos">1448</span></a>                        <span class="c1">#self.stimET[Leye, np.arange(3), ...] = np.array(fhandle[&#39;stimET&#39;], dtype=np.float32)[Leye, ...]</span>
</span><span id="MultiClouds.preload_numpy-1449"><a href="#MultiClouds.preload_numpy-1449"><span class="linenos">1449</span></a>                        <span class="c1">#self.stimET[Reye, np.arange(3,6), ...] = np.array(fhandle[&#39;stimET&#39;], dtype=np.float32)[Reye, ...]</span>
</span><span id="MultiClouds.preload_numpy-1450"><a href="#MultiClouds.preload_numpy-1450"><span class="linenos">1450</span></a>                        
</span><span id="MultiClouds.preload_numpy-1451"><a href="#MultiClouds.preload_numpy-1451"><span class="linenos">1451</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Monocular</span>
</span><span id="MultiClouds.preload_numpy-1452"><a href="#MultiClouds.preload_numpy-1452"><span class="linenos">1452</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="MultiClouds.preload_numpy-1453"><a href="#MultiClouds.preload_numpy-1453"><span class="linenos">1453</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.preload_numpy-1454"><a href="#MultiClouds.preload_numpy-1454"><span class="linenos">1454</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.preload_numpy-1455"><a href="#MultiClouds.preload_numpy-1455"><span class="linenos">1455</span></a>                        <span class="c1">#print(np.array(fhandle[&#39;stimET&#39;], dtype=np.float32).shape, self.stimET[inds, 0, ...].shape)</span>
</span><span id="MultiClouds.preload_numpy-1456"><a href="#MultiClouds.preload_numpy-1456"><span class="linenos">1456</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiClouds.preload_numpy-1457"><a href="#MultiClouds.preload_numpy-1457"><span class="linenos">1457</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiClouds.preload_numpy-1458"><a href="#MultiClouds.preload_numpy-1458"><span class="linenos">1458</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds.preload_numpy-1459"><a href="#MultiClouds.preload_numpy-1459"><span class="linenos">1459</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.preload_numpy-1460"><a href="#MultiClouds.preload_numpy-1460"><span class="linenos">1460</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiClouds.preload_numpy-1461"><a href="#MultiClouds.preload_numpy-1461"><span class="linenos">1461</span></a>
</span><span id="MultiClouds.preload_numpy-1462"><a href="#MultiClouds.preload_numpy-1462"><span class="linenos">1462</span></a>            <span class="n">t_counter</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiClouds.preload_numpy-1463"><a href="#MultiClouds.preload_numpy-1463"><span class="linenos">1463</span></a>            <span class="n">unit_counter</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="MultiClouds.preload_numpy-1464"><a href="#MultiClouds.preload_numpy-1464"><span class="linenos">1464</span></a>
</span><span id="MultiClouds.preload_numpy-1465"><a href="#MultiClouds.preload_numpy-1465"><span class="linenos">1465</span></a>        <span class="c1"># Adjust stimulus since stored as ints</span>
</span><span id="MultiClouds.preload_numpy-1466"><a href="#MultiClouds.preload_numpy-1466"><span class="linenos">1466</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span> 
</span><span id="MultiClouds.preload_numpy-1467"><a href="#MultiClouds.preload_numpy-1467"><span class="linenos">1467</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
</span><span id="MultiClouds.preload_numpy-1468"><a href="#MultiClouds.preload_numpy-1468"><span class="linenos">1468</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">127</span>
</span><span id="MultiClouds.preload_numpy-1469"><a href="#MultiClouds.preload_numpy-1469"><span class="linenos">1469</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.preload_numpy-1470"><a href="#MultiClouds.preload_numpy-1470"><span class="linenos">1470</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">127</span>
</span><span id="MultiClouds.preload_numpy-1471"><a href="#MultiClouds.preload_numpy-1471"><span class="linenos">1471</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">128</span>
</span><span id="MultiClouds.preload_numpy-1472"><a href="#MultiClouds.preload_numpy-1472"><span class="linenos">1472</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiClouds.preload_numpy-1473"><a href="#MultiClouds.preload_numpy-1473"><span class="linenos">1473</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">128</span>
</span><span id="MultiClouds.preload_numpy-1474"><a href="#MultiClouds.preload_numpy-1474"><span class="linenos">1474</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Adjusting stimulus read from disk: mean | std = </span><span class="si">%0.3f</span><span class="s2"> | </span><span class="si">%0.3f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">)))</span>
</span></pre></div>


            <div class="docstring"><p>Note this loads stimulus but does not time-embed</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="../sensory_base.html#SensoryBase">NTdatasets.sensory_base.SensoryBase</a></dt>
                                <dd id="MultiClouds.datadir" class="variable"><a href="../sensory_base.html#SensoryBase.datadir">datadir</a></dd>
                <dd id="MultiClouds.filenames" class="variable"><a href="../sensory_base.html#SensoryBase.filenames">filenames</a></dd>
                <dd id="MultiClouds.device" class="variable"><a href="../sensory_base.html#SensoryBase.device">device</a></dd>
                <dd id="MultiClouds.trial_sample" class="variable"><a href="../sensory_base.html#SensoryBase.trial_sample">trial_sample</a></dd>
                <dd id="MultiClouds.num_lags" class="variable"><a href="../sensory_base.html#SensoryBase.num_lags">num_lags</a></dd>
                <dd id="MultiClouds.stim_dims" class="variable"><a href="../sensory_base.html#SensoryBase.stim_dims">stim_dims</a></dd>
                <dd id="MultiClouds.preload" class="variable"><a href="../sensory_base.html#SensoryBase.preload">preload</a></dd>
                <dd id="MultiClouds.SUs" class="variable"><a href="../sensory_base.html#SensoryBase.SUs">SUs</a></dd>
                <dd id="MultiClouds.block_filemapping" class="variable"><a href="../sensory_base.html#SensoryBase.block_filemapping">block_filemapping</a></dd>
                <dd id="MultiClouds.include_MUs" class="variable"><a href="../sensory_base.html#SensoryBase.include_MUs">include_MUs</a></dd>
                <dd id="MultiClouds.SUinds" class="variable"><a href="../sensory_base.html#SensoryBase.SUinds">SUinds</a></dd>
                <dd id="MultiClouds.MUinds" class="variable"><a href="../sensory_base.html#SensoryBase.MUinds">MUinds</a></dd>
                <dd id="MultiClouds.cells_out" class="variable"><a href="../sensory_base.html#SensoryBase.cells_out">cells_out</a></dd>
                <dd id="MultiClouds.robs_out" class="variable"><a href="../sensory_base.html#SensoryBase.robs_out">robs_out</a></dd>
                <dd id="MultiClouds.dfs_out" class="variable"><a href="../sensory_base.html#SensoryBase.dfs_out">dfs_out</a></dd>
                <dd id="MultiClouds.avRs" class="variable"><a href="../sensory_base.html#SensoryBase.avRs">avRs</a></dd>
                <dd id="MultiClouds.test_inds" class="variable"><a href="../sensory_base.html#SensoryBase.test_inds">test_inds</a></dd>
                <dd id="MultiClouds.val_inds" class="variable"><a href="../sensory_base.html#SensoryBase.val_inds">val_inds</a></dd>
                <dd id="MultiClouds.train_inds" class="variable"><a href="../sensory_base.html#SensoryBase.train_inds">train_inds</a></dd>
                <dd id="MultiClouds.test_blks" class="variable"><a href="../sensory_base.html#SensoryBase.test_blks">test_blks</a></dd>
                <dd id="MultiClouds.val_blks" class="variable"><a href="../sensory_base.html#SensoryBase.val_blks">val_blks</a></dd>
                <dd id="MultiClouds.train_blks" class="variable"><a href="../sensory_base.html#SensoryBase.train_blks">train_blks</a></dd>
                <dd id="MultiClouds.speckled" class="variable"><a href="../sensory_base.html#SensoryBase.speckled">speckled</a></dd>
                <dd id="MultiClouds.Xdrift" class="variable"><a href="../sensory_base.html#SensoryBase.Xdrift">Xdrift</a></dd>
                <dd id="MultiClouds.stim" class="variable"><a href="../sensory_base.html#SensoryBase.stim">stim</a></dd>
                <dd id="MultiClouds.dfs" class="variable"><a href="../sensory_base.html#SensoryBase.dfs">dfs</a></dd>
                <dd id="MultiClouds.robs" class="variable"><a href="../sensory_base.html#SensoryBase.robs">robs</a></dd>
                <dd id="MultiClouds.covariates" class="variable"><a href="../sensory_base.html#SensoryBase.covariates">covariates</a></dd>
                <dd id="MultiClouds.cov_dims" class="variable"><a href="../sensory_base.html#SensoryBase.cov_dims">cov_dims</a></dd>
                <dd id="MultiClouds.add_covariate" class="function"><a href="../sensory_base.html#SensoryBase.add_covariate">add_covariate</a></dd>
                <dd id="MultiClouds.append_covariates" class="function"><a href="../sensory_base.html#SensoryBase.append_covariates">append_covariates</a></dd>
                <dd id="MultiClouds.prepare_stim" class="function"><a href="../sensory_base.html#SensoryBase.prepare_stim">prepare_stim</a></dd>
                <dd id="MultiClouds.set_cells" class="function"><a href="../sensory_base.html#SensoryBase.set_cells">set_cells</a></dd>
                <dd id="MultiClouds.construct_drift_design_matrix" class="function"><a href="../sensory_base.html#SensoryBase.construct_drift_design_matrix">construct_drift_design_matrix</a></dd>
                <dd id="MultiClouds.trial_psths" class="function"><a href="../sensory_base.html#SensoryBase.trial_psths">trial_psths</a></dd>
                <dd id="MultiClouds.construct_LVtents" class="function"><a href="../sensory_base.html#SensoryBase.construct_LVtents">construct_LVtents</a></dd>
                <dd id="MultiClouds.setup_trial_LVs" class="function"><a href="../sensory_base.html#SensoryBase.setup_trial_LVs">setup_trial_LVs</a></dd>
                <dd id="MultiClouds.setup_LVLayer_input" class="function"><a href="../sensory_base.html#SensoryBase.setup_LVLayer_input">setup_LVLayer_input</a></dd>
                <dd id="MultiClouds.design_matrix_drift" class="function"><a href="../sensory_base.html#SensoryBase.design_matrix_drift">design_matrix_drift</a></dd>
                <dd id="MultiClouds.construct_onehot_design_matrix" class="function"><a href="../sensory_base.html#SensoryBase.construct_onehot_design_matrix">construct_onehot_design_matrix</a></dd>
                <dd id="MultiClouds.crossval_setup" class="function"><a href="../sensory_base.html#SensoryBase.crossval_setup">crossval_setup</a></dd>
                <dd id="MultiClouds.fold_sample" class="function"><a href="../sensory_base.html#SensoryBase.fold_sample">fold_sample</a></dd>
                <dd id="MultiClouds.speckledXV_setup" class="function"><a href="../sensory_base.html#SensoryBase.speckledXV_setup">speckledXV_setup</a></dd>
                <dd id="MultiClouds.set_speckledXV" class="function"><a href="../sensory_base.html#SensoryBase.set_speckledXV">set_speckledXV</a></dd>
                <dd id="MultiClouds.make_data_dicts" class="function"><a href="../sensory_base.html#SensoryBase.make_data_dicts">make_data_dicts</a></dd>
                <dd id="MultiClouds.assemble_stimulus" class="function"><a href="../sensory_base.html#SensoryBase.assemble_stimulus">assemble_stimulus</a></dd>
                <dd id="MultiClouds.is_int" class="function"><a href="../sensory_base.html#SensoryBase.is_int">is_int</a></dd>
                <dd id="MultiClouds.index_to_array" class="function"><a href="../sensory_base.html#SensoryBase.index_to_array">index_to_array</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>
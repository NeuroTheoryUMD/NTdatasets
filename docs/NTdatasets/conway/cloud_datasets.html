<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.6.0"/>
    <title>NTdatasets.conway.cloud_datasets API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../conway.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;NTdatasets.conway</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#ColorClouds">ColorClouds</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ColorClouds.__init__">ColorClouds</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.stim_crop">stim_crop</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.folded_lags">folded_lags</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.eye_config">eye_config</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.binocular">binocular</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.luminance_only">luminance_only</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.generate_Xfix">generate_Xfix</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.output_separate_eye_stim">output_separate_eye_stim</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.start_t">start_t</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.drift_interval">drift_interval</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.fhandles">fhandles</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.avRs">avRs</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.fix_n">fix_n</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.used_inds">used_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.NT">NT</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.num_blks">num_blks</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.data_threshold">data_threshold</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.file_index">file_index</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.sacc_inds">sacc_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.stim_shifts">stim_shifts</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.LRpresent">LRpresent</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.binocular_gain">binocular_gain</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.startT">startT</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.train_inds">train_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.val_inds">val_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.train_blks">train_blks</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorClouds.val_blks">val_blks</a>
                        </li>
                        <li>
                                <a class="function" href="#ColorClouds.preload_numpy">preload_numpy</a>
                        </li>
                        <li>
                                <a class="function" href="#ColorClouds.is_fixpoint_present">is_fixpoint_present</a>
                        </li>
                        <li>
                                <a class="function" href="#ColorClouds.assemble_stimulus">assemble_stimulus</a>
                        </li>
                        <li>
                                <a class="function" href="#ColorClouds.to_tensor">to_tensor</a>
                        </li>
                        <li>
                                <a class="function" href="#ColorClouds.time_embedding">time_embedding</a>
                        </li>
                        <li>
                                <a class="function" href="#ColorClouds.rectangle_overlap_ranges">rectangle_overlap_ranges</a>
                        </li>
                        <li>
                                <a class="function" href="#ColorClouds.wrap_stim">wrap_stim</a>
                        </li>
                        <li>
                                <a class="function" href="#ColorClouds.crop_stim">crop_stim</a>
                        </li>
                        <li>
                                <a class="function" href="#ColorClouds.process_fixations">process_fixations</a>
                        </li>
                        <li>
                                <a class="function" href="#ColorClouds.augment_dfs">augment_dfs</a>
                        </li>
                        <li>
                                <a class="function" href="#ColorClouds.draw_stim_locations">draw_stim_locations</a>
                        </li>
                        <li>
                                <a class="function" href="#ColorClouds.avrates">avrates</a>
                        </li>
                        <li>
                                <a class="function" href="#ColorClouds.shift_stim">shift_stim</a>
                        </li>
                        <li>
                                <a class="function" href="#ColorClouds.shift_stim_fixation">shift_stim_fixation</a>
                        </li>
                        <li>
                                <a class="function" href="#ColorClouds.create_valid_indices">create_valid_indices</a>
                        </li>
                        <li>
                                <a class="function" href="#ColorClouds.crossval_setup">crossval_setup</a>
                        </li>
                        <li>
                                <a class="function" href="#ColorClouds.get_max_samples">get_max_samples</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../NTdatasets.html">NTdatasets</a><wbr>.<a href="./../conway.html">conway</a><wbr>.cloud_datasets    </h1>

                
                        <input id="mod-cloud_datasets-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-cloud_datasets-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">BlockFinder</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">sio</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">import</span> <span class="nn">NDNT.utils</span> <span class="k">as</span> <span class="nn">utils</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="c1">#from NDNT.utils import download_file, ensure_dir</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">import</span> <span class="nn">h5py</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">from</span> <span class="nn">NTdatasets.sensory_base</span> <span class="kn">import</span> <span class="n">SensoryBase</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="k">class</span> <span class="nc">ColorClouds</span><span class="p">(</span><span class="n">SensoryBase</span><span class="p">):</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="sd">    -- can load batches from multiple datasets</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="sd">    -- hdf5 files must have the following information:</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="sd">        Robs</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="sd">        RobsMU</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="sd">        stim: 4-d stimulus: time x nx x ny x color</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="sd">        block_inds: start and stop of &#39;trials&#39; (perhaps fixations for now)</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="sd">        other things: saccades? or should that be in trials? </span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="sd">    Constructor will take eye position, which for now is an input from data</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="sd">    generated in the session (not on disk). It should have the length size </span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="sd">    of the total number of fixations x1.</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="sd">    Input arguments (details):</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="sd">        stim_crop = None, should be of form [x1, x2, y1, y2] where each number is the </span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="sd">            extreme point to be include as an index, e.g. range(x1, x2+1), ... </span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a>        <span class="n">filenames</span><span class="p">,</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a>        <span class="n">datadir</span><span class="p">,</span> 
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>        <span class="n">time_embed</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="c1"># 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a>        <span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a>        <span class="n">include_MUs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a>        <span class="n">drift_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>        <span class="n">trial_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a>        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">),</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a>        <span class="c1"># Dataset-specitic inputs</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>        <span class="c1"># Stim setup -- if dont want to assemble stimulus: specify all things here for default options</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>        <span class="n">which_stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># &#39;et&#39; or 0, or 1 for lam, but default assemble later</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>        <span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># should be list/array of 4 numbers representing inds of edges</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>        <span class="n">luminance_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a>        <span class="n">ignore_saccades</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>        <span class="n">folded_lags</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>        <span class="n">binocular</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># whether to include separate filters for each eye</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>        <span class="n">eye_config</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 0 = all, 1, -1, and 2 are options (2 = binocular)</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a>        <span class="n">maxT</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="sd">        Constructor options</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="sd">        </span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="sd">        Args:</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="sd">            filenames (list): list of strings with filenames (without .mat) to load</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="sd">            datadir (str): directory where data is stored</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="sd">            time_embed (int): 0, 1, or 2. 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="sd">            num_lags (int): number of lags to use in time-embedding</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="sd">            include_MUs (bool): whether to include MUs in the dataset</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="sd">            drift_interval (int): number of blocks to include in drift term</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a><span class="sd">            trial_sample (bool): whether to sample trials randomly</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="sd">            device (torch.device): device to store data on</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a><span class="sd">            which_stim (str or int): &#39;et&#39; or 0, or 1 for lam, but default assemble later</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a><span class="sd">            stim_crop (list): should be list/array of 4 numbers representing inds of edges</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="sd">            luminance_only (bool): whether to use only luminance channel</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a><span class="sd">            ignore_saccades (bool): whether to ignore saccades</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="sd">            folded_lags (bool): whether to fold lags into channels</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a><span class="sd">            binocular (bool): whether to include separate filters for each eye</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a><span class="sd">            eye_config (int): 0 = all, 1, -1, and 2 are options (2 = binocular)</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a><span class="sd">            maxT (int): maximum number of time points to include</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>            <span class="n">filenames</span><span class="o">=</span><span class="n">filenames</span><span class="p">,</span> <span class="n">datadir</span><span class="o">=</span><span class="n">datadir</span><span class="p">,</span> 
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>            <span class="n">time_embed</span><span class="o">=</span><span class="n">time_embed</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">num_lags</span><span class="p">,</span> <span class="n">include_MUs</span><span class="o">=</span><span class="n">include_MUs</span><span class="p">,</span> 
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>            <span class="n">drift_interval</span><span class="o">=</span><span class="n">drift_interval</span><span class="p">,</span> <span class="n">trial_sample</span><span class="o">=</span><span class="n">trial_sample</span><span class="p">,</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>        <span class="c1"># Done in parent constructor</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>        <span class="c1">#self.datadir = datadir</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>        <span class="c1">#self.filenames = filenames</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>        <span class="c1">#self.device = device</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>        <span class="c1">#self.num_lags = 10  # default: to be set later</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>        <span class="c1">#if time_embed == 2:</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>        <span class="c1">#    assert preload, &quot;Cannot pre-time-embed without preloading.&quot;</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>        <span class="c1">#self.time_embed = time_embed</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>        <span class="c1">#self.preload = preload</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>        <span class="c1"># Stim-specific</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="o">=</span> <span class="kc">None</span> 
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span> <span class="o">=</span> <span class="n">folded_lags</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">=</span> <span class="n">eye_config</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span> <span class="o">=</span> <span class="n">binocular</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span> <span class="o">=</span> <span class="n">luminance_only</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_Xfix</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_separate_eye_stim</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span> <span class="o">=</span> <span class="n">drift_interval</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>        <span class="c1"># get hdf5 file handles</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">sess</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>        <span class="c1"># Set up to store default train_, val_, test_inds</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>        <span class="c1">#self.test_inds = None</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>        <span class="c1">#self.val_inds = None</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>        <span class="c1">#self.train_inds = None</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>        <span class="c1">#self.used_inds = []</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>        <span class="c1"># Data to construct and store in memory</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>        <span class="c1">#self.stim = []</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>        <span class="c1">#self.dfs = []</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>        <span class="c1">#self.robs = []</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>        <span class="c1"># build index map -- exclude variables already set in sensory-base</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_threshold</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># how many valid time points required to include saccade?</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_index</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># which file the block corresponds to</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_shifts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>        <span class="c1">#self.stim_dims = None</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>        <span class="c1">#self.unit_ids = []</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>        <span class="c1">#self.num_units, self.num_SUs, self.num_MUs = [], [], []</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>        <span class="c1">#self.SUs = []</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>        <span class="c1">#self.NC = 0    </span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>        <span class="c1">#self.block_inds = []</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>        <span class="c1">#self.block_filemapping = []</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>        <span class="c1">#self.include_MUs = include_MUs</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>        <span class="c1">#self.SUinds = []</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>        <span class="c1">#self.MUinds = []</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>        <span class="c1">#self.cells_out = []  # can be list to output specific cells in get_item</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>        <span class="c1">#self.avRs = None</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>        <span class="n">tcount</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>        <span class="k">for</span> <span class="n">fnum</span><span class="p">,</span> <span class="n">fhandle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">):</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>            <span class="n">NT</span><span class="p">,</span> <span class="n">NSUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>            <span class="c1"># Check for valid RobsMU</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>                <span class="n">NMUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>            <span class="k">else</span><span class="p">:</span> 
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>                <span class="n">NMUfile</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_SUs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NSUfile</span><span class="p">)</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_MUs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NMUfile</span><span class="p">)</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="o">+</span><span class="n">NSUfile</span><span class="p">))</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;block_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>            <span class="n">blk_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># convert to python so range works</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>            <span class="c1"># Check to make sure not inverted blk_inds (older version of data)</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>            <span class="k">if</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: blk_inds is stored old-style: transposing&#39;</span><span class="p">)</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>                <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapSU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">channel_rating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs_rating&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>            <span class="k">if</span> <span class="n">NMUfile</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">channelMU_rating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU_rating&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">channel_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_mapSU</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapMU</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapMU</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">channel_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapSU</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>            
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>            <span class="c1"># Stimulus information</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;fix_location&#39;</span><span class="p">])</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;fix_size&#39;</span><span class="p">])</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim_location&#39;</span><span class="p">])</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_locationET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;ETstim_location&#39;</span><span class="p">])</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimscale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimscale&#39;</span><span class="p">])</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">blockID</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;blockID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>            <span class="c1"># ETtrace information</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ETtrace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;ETtrace&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ETtraceHR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;ETtrace_raw&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>            <span class="n">NCfile</span> <span class="o">=</span> <span class="n">NSUfile</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>                <span class="n">NCfile</span> <span class="o">+=</span> <span class="n">NMUfile</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>            
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>            <span class="c1"># This will associate each block with each file</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_filemapping</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="n">fnum</span><span class="p">)</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span><span class="p">[</span><span class="n">fnum</span><span class="p">]</span><span class="o">=</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>  <span class="c1"># this is basis of data (stimLP and stimET)</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># # when stim is constructed</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; EYE configuration &quot;&quot;&quot;</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>            <span class="c1">#if self.eye_config &gt; 0:</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>            <span class="n">Lpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useLeye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>            <span class="n">Rpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>            <span class="n">LRpresent</span> <span class="o">=</span> <span class="n">Lpresent</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Rpresent</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>            <span class="k">if</span> <span class="n">luminance_only</span><span class="p">:</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reducing stimulus channels (</span><span class="si">%d</span><span class="s2">) to first dimension&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">2</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>            <span class="c1">#if self.time_embed &gt; 0:</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>            <span class="c1">#    self.dims[3] = self.num_lags</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>            <span class="c1">#print(&#39;Stim check:&#39;, folded_lags, self.dims)</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>            <span class="c1">#self.unit_ids.append(self.NC + np.asarray(range(NCfile)))</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NCfile</span><span class="p">)</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">+=</span> <span class="n">NCfile</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_saccades</span><span class="p">:</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>                <span class="n">sacc_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;sacc_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sacc_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>                    <span class="n">sacc_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># convert to python so range works</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ignoring sacc_inds. Assuming not valid&quot;</span><span class="p">)</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>                    <span class="n">sacc_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sacc_inds</span><span class="p">)</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>            <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;valid_data&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>  <span class="c1">#range(self.NT)  # default -- to be changed at end of init</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>            <span class="k">if</span> <span class="n">valid_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>   <span class="c1"># Make version-read proof</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>                <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">valid_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: Old-stype valid_inds saved. Transposing&#39;</span><span class="p">)</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>                <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">valid_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>            <span class="n">tcount</span> <span class="o">+=</span> <span class="n">NT</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>            <span class="c1"># make larger fix_n, valid_inds, sacc_inds, block_inds as self</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>  <span class="o">=</span> <span class="n">tcount</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>        <span class="c1"># For now let&#39;s just debug with one file</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: currently ignoring multiple files&#39;</span><span class="p">)</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">valid_inds</span><span class="p">)</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span> <span class="o">=</span> <span class="n">LRpresent</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>        <span class="c1"># Make binocular gain term</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">LRpresent</span><span class="p">),</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data into memory...&quot;</span><span class="p">)</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">preload_numpy</span><span class="p">()</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>            <span class="k">if</span> <span class="n">which_stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>                <span class="c1">#assert num_lags is not None, &quot;Need to specify num_lags and other stim params&quot;</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">assemble_stimulus</span><span class="p">(</span> <span class="n">which_stim</span><span class="o">=</span><span class="n">which_stim</span><span class="p">,</span> 
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>                    <span class="n">time_embed</span><span class="o">=</span><span class="n">time_embed</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">num_lags</span><span class="p">,</span> <span class="n">stim_crop</span><span class="o">=</span><span class="n">stim_crop</span> <span class="p">)</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>            <span class="c1"># Have data_filters represend used_inds (in case it gets through)</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>            <span class="n">unified_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>            <span class="n">unified_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*=</span> <span class="n">unified_df</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>        <span class="c1">### Process experiment to include relevant eye config</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># then want to return experiment part consistent with eye config</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>            <span class="n">eye_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LRpresent</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>            <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">eye_val</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">eye_val</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eye_val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">):</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;EYE CONFIG WARNING: non-contiguous blocks of correct eye position&quot;</span> <span class="p">)</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>                <span class="n">t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">eye_val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Taking first contiguous block up to </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">t1</span><span class="p">)</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>            <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">=</span> <span class="n">t0</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>        <span class="k">if</span> <span class="n">maxT</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>            <span class="n">t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span> <span class="n">t0</span><span class="o">+</span><span class="n">maxT</span><span class="p">,</span> <span class="n">t1</span> <span class="p">)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>        <span class="n">ts</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;T-range:&#39;</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>        <span class="c1"># Save for potential future adjustments of signal</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">startT</span> <span class="o">=</span> <span class="n">t0</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>        
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Trimming experiment </span><span class="si">%d</span><span class="s2">-&gt;</span><span class="si">%d</span><span class="s2"> time points based on eye_config and Tmax&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span> <span class="p">)</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">&gt;=</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">&lt;</span> <span class="n">t1</span><span class="p">)]</span> <span class="o">-</span> <span class="n">t0</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>            <span class="c1"># Only keep valid blocks/saccades</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">blk_inds</span> <span class="o">-</span> <span class="n">t0</span> 
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">blk_inds</span><span class="p">[</span> <span class="n">blk_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">blk_inds</span><span class="p">[</span> <span class="n">blk_inds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">-</span> <span class="n">t0</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>  
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span> <span class="n">sacc_inds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="p">:]</span>  
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>        <span class="c1">### Process blocks and fixations/saccades</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>            <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>        <span class="c1"># go to end of time range if extends beyond block range</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>        <span class="k">if</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extending final block at &#39;</span><span class="p">,</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">))</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>            <span class="c1"># This is to fix zeroing of last block in fix_n.... (I think?)</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">process_fixations</span><span class="p">()</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>        <span class="c1">### Construct drift term if relevant</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>            <span class="n">NBL</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>            <span class="n">Nanchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">NBL</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>            <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">):</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>                <span class="n">anchors</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span><span class="o">*</span><span class="n">bb</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>            <span class="c1">#self.Xdrift = utils.design_matrix_drift( self.NT, anchors, zero_left=False, const_right=True)</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>        <span class="c1"># Write all relevant data (other than stim) to pytorch tensors after organized</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="p">)</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>        <span class="c1"># Cross-validation setup</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>        <span class="c1"># Develop default train, validation, and test datasets </span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>        <span class="c1">#self.crossval_setup()</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>        <span class="c1">### SHOULD MAKE THIS INTO A FUNCTION THAT CAN BE RE-APPLIEd</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>        <span class="n">vblks</span><span class="p">,</span> <span class="n">trblks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">trblks</span><span class="p">:</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">vblks</span><span class="p">:</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>        <span class="c1"># Eliminate from time point any times when the datafilers are all zero</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>        <span class="c1"># this will include all places where used-inds is zero as well</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">trblks</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">vblks</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>    <span class="c1"># END ColorClouds.__init__</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>    <span class="k">def</span> <span class="nf">preload_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a><span class="sd">        Note this loads stimulus but does not time-embed</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a><span class="sd">        </span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a><span class="sd">        Args:</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a><span class="sd">            None</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a><span class="sd">        Returns:</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a><span class="sd">            None</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a><span class="sd">        Pre-allocate memory for data</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>        <span class="k">if</span> <span class="s1">&#39;stimET&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>            <span class="c1"># Check to see if 1-d or 2-d eye tracking</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:</span><span class="mi">100</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ET stimulus is 1-d bars.&quot;</span><span class="p">)</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Missing ETstimulus&#39;</span><span class="p">)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>        <span class="c1">#self.eyepos = np.zeros([NT, 2], dtype=np.float32)</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>        <span class="c1">#self.frame_times = np.zeros([NT,1], dtype=np.float32)</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>        <span class="n">t_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>        <span class="n">unit_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">)):</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>            
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>            <span class="n">fhandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>            <span class="n">sz</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_counter</span><span class="p">,</span> <span class="n">t_counter</span><span class="o">+</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>            <span class="c1">#inds = self.stim_indices[expt][stim][&#39;inds&#39;]</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>            <span class="c1">#self.stim[inds, ...] = np.transpose( np.array(fhandle[self.stimname], dtype=np.float32), axes=[0,3,1,2])</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>                <span class="n">Leye</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>                <span class="n">Reye</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>                <span class="c1">#Leye = inds[np.where(self.LRpresent[inds] != 2)[0]]</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>                <span class="c1">#Reye = inds[np.where(self.LRpresent[inds] != 1)[0]]</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>                <span class="c1">#print(len(Leye), len(Reye))</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>                    <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>                    <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>                        <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>                        <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>                        <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>                        <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>                        <span class="c1">#self.stimET[Leye, np.arange(3), ...] = np.array(fhandle[&#39;stimET&#39;], dtype=np.float32)[Leye, ...]</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>                        <span class="c1">#self.stimET[Reye, np.arange(3,6), ...] = np.array(fhandle[&#39;stimET&#39;], dtype=np.float32)[Reye, ...]</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>                        
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Monocular</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>                        <span class="c1">#print(np.array(fhandle[&#39;stimET&#39;], dtype=np.float32).shape, self.stimET[inds, 0, ...].shape)</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Robs and DATAFILTERS&quot;&quot;&quot;</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>            <span class="n">robs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>            <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>            <span class="n">num_sus</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>            <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="p">)</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>            <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>            <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;datafilts&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>                <span class="n">num_mus</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>                <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="o">+</span><span class="n">num_mus</span><span class="p">)</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>                <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>                <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;datafiltsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>            
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">robs_tmp</span><span class="p">)</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dfs_tmp</span><span class="p">)</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>            <span class="n">t_counter</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>            <span class="n">unit_counter</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>        <span class="c1"># Adjust stimulus since stored as ints</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span> 
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">127</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">127</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">128</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">128</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Adjusting stimulus read from disk: mean | std = </span><span class="si">%0.3f</span><span class="s2"> | </span><span class="si">%0.3f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">)))</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>    <span class="c1"># END .preload_numpy()</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>    <span class="k">def</span> <span class="nf">is_fixpoint_present</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">boxlim</span> <span class="p">):</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return if any of fixation point is within the box given by top-left to bottom-right corner&quot;&quot;&quot;</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>        <span class="n">fix_present</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>            <span class="c1"># if there is multiple windows, needs to be manual: so this is the automatic check:</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>            <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">-</span><span class="n">boxlim</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_size</span><span class="p">):</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>                    <span class="n">fix_present</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">-</span><span class="n">boxlim</span><span class="p">[</span><span class="n">dd</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_size</span><span class="p">):</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>                    <span class="n">fix_present</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>        <span class="k">return</span> <span class="n">fix_present</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>    <span class="c1"># END .is_fixpoint_present</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>    <span class="k">def</span> <span class="nf">assemble_stimulus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>        <span class="n">which_stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stim_wrap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># conventional stim: ET=0, lam=1,</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>        <span class="n">top_corner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># position of stim</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>        <span class="n">time_embed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>        <span class="n">luminance_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>        <span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">BUF</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="c1"># shift buffer</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>        <span class="n">shift_times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># So that can put partial-shifts over time range in stimulus</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>        <span class="n">LMS</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># if false, translate to cone-isolating stimulus </span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>        <span class="n">fixdot</span><span class="o">=</span><span class="mi">0</span> <span class="p">):</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a><span class="sd">        This assembles a stimulus from the raw numpy-stored stimuli into self.stim</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a><span class="sd">        which_stim: determines what stimulus is assembled from &#39;ET&#39;=0, &#39;lam&#39;=1, None</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a><span class="sd">            If none, will need top_corner present: can specify with four numbers (top-left, bot-right)</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a><span class="sd">            or just top_corner and L</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a><span class="sd">        which is torch.tensor on default device</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a><span class="sd">        stim_wrap: only works if using &#39;which_stim&#39;, and will be [hwrap, vwrap]</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a><span class="sd">        </span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a><span class="sd">        Args:</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a><span class="sd">            which_stim (int): 0 for ET, 1 for laminar probe, None for assembly from top_corner</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a><span class="sd">            stim_wrap (list): [hwrap, vwrap] for wrapping stimulus</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a><span class="sd">            stim_crop (list): [x1, x2, y1, y2] for cropping stimulus</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a><span class="sd">            top_corner (list): [x1, y1] for top corner of stimulus</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a><span class="sd">            L (int): length of stimulus</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a><span class="sd">            time_embed (int): number of time lags to embed</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a><span class="sd">            num_lags (int): number of lags to use</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a><span class="sd">            luminance_only (bool): whether to use only luminance channel</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a><span class="sd">            shifts (list): [dx, dy] for shifting stimulus</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a><span class="sd">            BUF (int): buffer for shifting stimulus</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a><span class="sd">            shift_times (list): times to shift stimulus</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a><span class="sd">            LMS (bool): whether to convert to cone-isolating stimulus</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a><span class="sd">            fixdot (int): value for fixation point</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a><span class="sd">        Returns:</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a><span class="sd">            None</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>        <span class="c1"># Delete existing stim and clear cache to prevent memory issues on GPU</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>            <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>        <span class="n">num_clr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>        <span class="k">if</span> <span class="n">LMS</span><span class="p">:</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">,</span> <span class="s2">&quot;Cannot convert color spaces if luminance-only.&quot;</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">LMS</span> <span class="o">=</span> <span class="n">LMS</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>        <span class="n">need2crop</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>        <span class="k">if</span> <span class="n">which_stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>            <span class="k">assert</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;ASSEMBLE_STIMULUS: cannot specify L if using which_stim (i.e. prepackaged stim)&quot;</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_stim</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>                <span class="k">if</span> <span class="n">which_stim</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ET&#39;</span><span class="p">,</span> <span class="s1">&#39;et&#39;</span><span class="p">,</span> <span class="s1">&#39;stimET&#39;</span><span class="p">]:</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>                    <span class="n">which_stim</span><span class="o">=</span><span class="mi">0</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>                    <span class="n">which_stim</span><span class="o">=</span><span class="mi">1</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>            <span class="k">if</span> <span class="n">which_stim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stim: using ET stimulus&quot;</span><span class="p">)</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="p">)</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_locationET</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stim: using laminar probe stimulus&quot;</span><span class="p">)</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="p">)</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>            <span class="k">assert</span> <span class="n">top_corner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need top corner if which_stim unspecified&quot;</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>            <span class="c1"># Assemble from combination of ET and laminer probe (NP) stimulus</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_corner</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="o">=</span> <span class="n">top_corner</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>                <span class="c1">#L = self.stim_pos[2]-self.stim_pos[0]</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Stim must be square (for now)&quot;</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>                <span class="k">if</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>                    <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">top_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">top_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">top_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">L</span><span class="p">,</span> <span class="n">top_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">L</span><span class="p">]</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>            <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>                <span class="n">need2crop</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>                <span class="c1"># Modify stim window by 20-per-side</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">BUF</span><span class="p">,</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">BUF</span><span class="p">]</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Stim expansion for shift:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">)</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">L</span><span class="p">,</span> <span class="s2">&quot;Stimulus not square&quot;</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>            <span class="n">newstim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">num_clr</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>                <span class="n">OVLP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_overlap_ranges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">])</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>                <span class="k">if</span> <span class="n">OVLP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Writing lam stim </span><span class="si">%d</span><span class="s2">: overlap </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">])))</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>                    <span class="n">strip</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:])</span> <span class="c1">#np.zeros([self.NT, num_clr, len(OVLP[&#39;targetX&#39;]), L])</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>                    <span class="n">strip</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readX&#39;</span><span class="p">],</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readY&#39;</span><span class="p">]]))</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>                    <span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>                
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_locationET</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>                    <span class="n">OVLP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_overlap_ranges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_locationET</span><span class="p">[:,</span><span class="n">ii</span><span class="p">])</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>                    <span class="k">if</span> <span class="n">OVLP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Writing ETstim </span><span class="si">%d</span><span class="s2">: overlap </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">])))</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>                        <span class="n">strip</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:])</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>                        <span class="n">strip</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readX&#39;</span><span class="p">],</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readY&#39;</span><span class="p">]]))</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>                        <span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span> 
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">newstim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="p">)</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>        <span class="c1">#print(&#39;Stim shape&#39;, self.stim.shape)</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>        <span class="c1"># Note stim stored in numpy is being represented as full 3-d + 1 tensor (time, channels, NX, NY)</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>        <span class="k">if</span> <span class="n">luminance_only</span><span class="p">:</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>                <span class="c1"># Resample first dimension of stimulus</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Shifting to luminance-only&#39;</span><span class="p">)</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>                <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">...</span><span class="p">])</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>            
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>        <span class="c1"># stim_wrap if &#39;which_stim&#39; chosen</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>        <span class="k">if</span> <span class="n">stim_wrap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>            <span class="k">assert</span> <span class="n">which_stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Should only use stim_wrap on conventional (ET or LAM) stimulus.&quot;</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>            <span class="n">hwrap</span> <span class="o">=</span> <span class="n">stim_wrap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>            <span class="n">vwrap</span> <span class="o">=</span> <span class="n">stim_wrap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wrap_stim</span><span class="p">(</span> <span class="n">hwrap</span><span class="o">=-</span><span class="n">hwrap</span><span class="p">,</span> <span class="n">vwrap</span><span class="o">=-</span><span class="n">vwrap</span> <span class="p">)</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="o">+=</span> <span class="p">[</span><span class="o">-</span><span class="n">hwrap</span><span class="p">,</span> <span class="o">-</span><span class="n">vwrap</span><span class="p">,</span> <span class="o">-</span><span class="n">hwrap</span><span class="p">,</span> <span class="o">-</span><span class="n">vwrap</span><span class="p">]</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>        <span class="c1"># Insert fixation point</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">fixdot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fixpoint_present</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="p">):</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>            <span class="n">fixranges</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>            <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>                <span class="n">fixranges</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_size</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="n">dd</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="n">dd</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span> 
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>                    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>            <span class="c1"># Write the correct value to stim</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>            <span class="c1">#print(fixranges)</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>            <span class="k">assert</span> <span class="n">fixdot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Haven&#39;t yet put in other fixdot settings than zero&quot;</span> 
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>            <span class="c1">#strip = deepcopy(self.stim[:, :, fixranges[0], :])</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>            <span class="c1">#strip[:, :, :, fixranges[1]] = 0</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>            <span class="c1">#self.stim[:, :, fixranges[0], :] = deepcopy(strip) </span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Adding fixation point&#39;</span><span class="p">)</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>            <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">fixranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">fixranges</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_shifts</span> <span class="o">=</span> <span class="n">shifts</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>            <span class="c1"># Would want to shift by input eye positions if input here</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>            <span class="c1">#print(&#39;eye-position shifting not implemented yet&#39;)</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Shifting stim...&#39;</span><span class="p">)</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>            <span class="k">if</span> <span class="n">shift_times</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_stim</span><span class="p">(</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">shift_times</span><span class="o">=</span><span class="n">shift_times</span><span class="p">,</span> <span class="n">already_lagged</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">shift_times</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_stim</span><span class="p">(</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">shift_times</span><span class="o">=</span><span class="n">shift_times</span><span class="p">,</span> <span class="n">already_lagged</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>        <span class="c1"># Reduce size back to original If expanded to handle shifts</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>        <span class="k">if</span> <span class="n">need2crop</span><span class="p">:</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>            <span class="c1">#assert self.stim_crop is None, &quot;Cannot crop stim at same time as shifting&quot;</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">crop_stim</span><span class="p">(</span> <span class="p">[</span><span class="n">BUF</span><span class="p">,</span> <span class="n">L</span><span class="o">-</span><span class="n">BUF</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">BUF</span><span class="p">,</span> <span class="n">L</span><span class="o">-</span><span class="n">BUF</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>  <span class="c1"># move back to original size</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">L</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">BUF</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="o">=</span> <span class="n">stim_crop</span> 
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">crop_stim</span><span class="p">()</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>        <span class="k">if</span> <span class="n">time_embed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">=</span> <span class="n">time_embed</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>        <span class="k">if</span> <span class="n">time_embed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>            <span class="c1">#self.stim_dims[3] = num_lags  # this is set by time-embedding</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>            <span class="k">if</span> <span class="n">time_embed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embedding</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">,</span> <span class="n">nlags</span> <span class="o">=</span> <span class="n">num_lags</span> <span class="p">)</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>        <span class="c1"># now stimulus is represented as full 4-d + 1 tensor (time, channels, NX, NY, num_lags)</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span> <span class="o">=</span> <span class="n">num_lags</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>        <span class="c1"># Translate to cone-isolating stimmulus if DKL is false</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>        <span class="k">if</span> <span class="n">LMS</span><span class="p">:</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>            <span class="c1"># Make cone-isolating stimulus conversion matrix</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>            <span class="c1">#DKL2CIS = torch.tensor([[0.0401,.522,0], [.0351,-0.4635,0], [0.0145,0,.985]], dtype=torch.float32)</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>            <span class="c1">#DKL2LMS = torch.tensor([[0.9737, 0.0799, -0.0836], [1.0155, -0.1210, -0.1135], [1.0890, -0.0138, 0.9183]], dtype=torch.float32)</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>            <span class="n">DKL2LMS</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mf">0.7586</span><span class="p">,</span> <span class="mf">0.6515</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5536</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8328</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.8660</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;  Converting to LMS space&#39;</span><span class="p">)</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span> <span class="s1">&#39;axcd,bx-&gt;abcd&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">,</span> <span class="n">DKL2LMS</span><span class="p">)</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>        <span class="c1"># Flatten stim </span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Done&quot;</span> <span class="p">)</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>    <span class="c1"># END ColorClouds.assemble_stimulus()</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>    <span class="k">def</span> <span class="nf">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a><span class="sd">        Converts all relevant data to torch.tensor on device</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a><span class="sd">        Args:</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a><span class="sd">            device (torch.device): device to move data to</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a><span class="sd">        Returns:</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a><span class="sd">            None</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>            <span class="c1"># then already converted: just moving device</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>            <span class="c1">#self.stim = self.stim.to(device)</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>            <span class="c1">#self.stim = torch.tensor(self.stim, dtype=torch.float32, device=device)</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>    <span class="k">def</span> <span class="nf">time_embedding</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a><span class="sd">        Note this overloads SensoryBase because reshapes in full dimensions to handle folded_lags</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a><span class="sd">        </span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a><span class="sd">        Args:</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a><span class="sd">            stim (torch.tensor): stimulus to time-embed</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a><span class="sd">            nlags (int): number of lags to use</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a><span class="sd">        Returns:</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a><span class="sd">            torch.tensor: time-embedded stimulus</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to assemble stim before time-embedding.&quot;</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>        <span class="k">if</span> <span class="n">nlags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>            <span class="n">nlags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlags</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>        <span class="k">if</span> <span class="n">stim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>                <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">stim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>                <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>        <span class="c1">#if not isinstance(tmp_stim, np.ndarray):</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>        <span class="c1">#    tmp_stim = tmp_stim.cpu().numpy()</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>    
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Time embedding...&quot;</span><span class="p">)</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Time embed: reshaping stimulus -&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">)</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">)</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">==</span> <span class="n">NT</span><span class="p">,</span> <span class="s2">&quot;TIME EMBEDDING: stim length mismatch&quot;</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>        <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nlags</span><span class="p">),</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span><span class="p">:</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>            <span class="c1">#tmp_stim = np.transpose( tmp_stim, axes=[0,2,1,3,4] ) </span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span> <span class="n">tmp_stim</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span> 
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Folded lags: stim-dim = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>            <span class="c1">#tmp_stim = np.transpose( tmp_stim, axes=[0,2,3,4,1] )</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span> <span class="n">tmp_stim</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>        <span class="k">return</span> <span class="n">tmp_stim</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>    <span class="c1"># END .time_embedding()</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>    <span class="k">def</span> <span class="nf">rectangle_overlap_ranges</span><span class="p">(</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span> <span class="p">):</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a><span class="sd">        Figures out ranges to write relevant overlap of B onto A</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a><span class="sd">        All info is of form [x0, y0, x1, y1]</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a><span class="sd">        </span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a><span class="sd">        Args:</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a><span class="sd">            A (list): [x0, y0, x1, y1]</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a><span class="sd">            B (list): [x0, y0, x1, y1]</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a><span class="sd">        Returns:</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a><span class="sd">            dict: ranges to write to A from B</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>        <span class="n">C</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>            <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span> 
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>                <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>                <span class="n">D</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>                <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]:</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> 
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>                <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>                <span class="n">D</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>                <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]:</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>            <span class="k">return</span> <span class="kc">None</span>  
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>        <span class="n">ranges</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>            <span class="s1">&#39;targetX&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>            <span class="s1">&#39;targetY&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">C</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>            <span class="s1">&#39;readX&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>            <span class="s1">&#39;readY&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">D</span><span class="p">[</span><span class="mi">3</span><span class="p">])}</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>        <span class="k">return</span> <span class="n">ranges</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>    <span class="k">def</span> <span class="nf">wrap_stim</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">vwrap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hwrap</span><span class="o">=</span><span class="mi">0</span> <span class="p">):</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a><span class="sd">        Take existing stimulus and move the whole thing around in horizontal and/or vertical dims,</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a><span class="sd">        including if time_embedded</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a><span class="sd">        </span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a><span class="sd">        Args:</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a><span class="sd">            vwrap (int): vertical wrap</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a><span class="sd">            hwrap (int): horizontal wrap</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a><span class="sd">        Returns:</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a><span class="sd">            None</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must assemble the stimulus before using wrap_stim.&quot;</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>        <span class="n">orig_stim_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>        <span class="k">if</span> <span class="n">orig_stim_dims</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>        <span class="k">elif</span> <span class="n">orig_stim_dims</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">])</span>  <span class="c1"># put in lags as one dim</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>        <span class="n">NY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>        <span class="k">if</span> <span class="n">vwrap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>            <span class="n">tmp2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tmp_stim</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">tmp_stim</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>            <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">vwrap</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">(</span><span class="n">NY</span><span class="o">-</span><span class="n">vwrap</span><span class="p">):,</span> <span class="p">:]</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>            <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">vwrap</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="n">NY</span><span class="o">-</span><span class="n">vwrap</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>        <span class="k">elif</span> <span class="n">vwrap</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>            <span class="n">tmp2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tmp_stim</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">tmp_stim</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>            <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">(</span><span class="n">NY</span><span class="o">+</span><span class="n">vwrap</span><span class="p">):,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="o">-</span><span class="n">vwrap</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>            <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="n">NY</span><span class="o">+</span><span class="n">vwrap</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">(</span><span class="o">-</span><span class="n">vwrap</span><span class="p">):,</span> <span class="p">:]</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>            <span class="n">tmp2</span> <span class="o">=</span> <span class="n">tmp_stim</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>        <span class="n">NX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>        <span class="k">if</span> <span class="n">hwrap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tmp2</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">tmp2</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">hwrap</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">(</span><span class="n">NX</span><span class="o">-</span><span class="n">hwrap</span><span class="p">):,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">hwrap</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="n">NX</span><span class="o">-</span><span class="n">hwrap</span><span class="p">),</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>        <span class="k">elif</span> <span class="n">hwrap</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tmp2</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">tmp2</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">(</span><span class="n">NX</span><span class="o">+</span><span class="n">hwrap</span><span class="p">):,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="o">-</span><span class="n">hwrap</span><span class="p">),</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="n">NX</span><span class="o">+</span><span class="n">hwrap</span><span class="p">),</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">(</span><span class="o">-</span><span class="n">hwrap</span><span class="p">):,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tmp2</span><span class="p">)</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>        <span class="k">if</span> <span class="n">orig_stim_dims</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>        <span class="k">elif</span> <span class="n">orig_stim_dims</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>            <span class="c1"># Take out extra lag dim</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>    <span class="c1"># END .wrap_stim()</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>    <span class="k">def</span> <span class="nf">crop_stim</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a><span class="sd">        Crop existing (torch) stimulus and change relevant variables [x1, x2, y1, y2]</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a><span class="sd">        </span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a><span class="sd">        Args:</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a><span class="sd">            stim_crop (list): [x1, x2, y1, y2]</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a><span class="sd">        Returns:</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a><span class="sd">            None</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>        <span class="k">if</span> <span class="n">stim_crop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>            <span class="n">stim_crop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="o">=</span> <span class="n">stim_crop</span> 
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_crop</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;stim_crop must be of form: [x1, x2, y1, y2]&quot;</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">)</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>            <span class="n">reshape</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>            <span class="c1">#print(&#39;  CROP: reshaping stim&#39;)</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>            <span class="n">reshape</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>        <span class="c1">#stim_crop = np.array(stim_crop, dtype=np.int64) # make sure array</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>        <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stim_crop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stim_crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>        <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stim_crop</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">stim_crop</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">ys</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">xs</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># then lagged -- need extra dim</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">ys</span><span class="p">,</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="n">xs</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  CROP: New stim size: </span><span class="si">%d</span><span class="s2"> x </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)))</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>        <span class="k">if</span> <span class="n">reshape</span><span class="p">:</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;reshaping back&#39;</span><span class="p">)</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>    <span class="c1"># END .crop_stim()</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>    <span class="k">def</span> <span class="nf">process_fixations</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sacc_in</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a><span class="sd">        Processes fixation informatiom from dataset, but also allows new saccade detection</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a><span class="sd">        to be input and put in the right format within the dataset (main use)</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a><span class="sd">        </span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a><span class="sd">        Args:</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a><span class="sd">            sacc_in (np.ndarray): saccade times</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a><span class="sd">        Returns:</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a><span class="sd">            None</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>        <span class="k">if</span> <span class="n">sacc_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>            <span class="n">sacc_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Redoing fix_n with saccade inputs: </span><span class="si">%d</span><span class="s2"> saccades&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">sacc_in</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  -&gt; Adjusting timing for non-zero start time in this dataset.&quot;</span><span class="p">)</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>            <span class="n">sacc_in</span> <span class="o">=</span> <span class="n">sacc_in</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>            <span class="n">sacc_in</span> <span class="o">=</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">sacc_in</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>        <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> 
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>        <span class="n">fix_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)):</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>            <span class="c1">#if self.block_inds[ii][0] &lt; self.NT:</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>            <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>            <span class="c1">#self.block_inds.append(np.arange( blk_inds[ii,0], blk_inds[ii,1], dtype=np.int64))</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>            <span class="c1"># Parse fixation numbers within block</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>            <span class="n">rel_saccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">sacc_in</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sacc_in</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">5</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>            <span class="n">tfix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Beginning of fixation by definition</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>            <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel_saccs</span><span class="p">)):</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>                <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>                <span class="c1"># Range goes to beginning of next fixation (note no gap)</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>                <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>                <span class="n">tfix</span> <span class="o">=</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]]</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>            <span class="c1"># Put in last (or only) fixation number</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>            <span class="k">if</span> <span class="n">tfix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>                <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>                <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>        <span class="c1"># Determine whether to be numpy or tensor</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">fix_n</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>    <span class="c1"># END: ColorClouds.process_fixations()</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>    <span class="k">def</span> <span class="nf">augment_dfs</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">new_dfs</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a><span class="sd">        Replaces data-filter for given cells. note that new_df should be np.ndarray</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a><span class="sd">        </span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a><span class="sd">        Args:</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a><span class="sd">            new_dfs (np.ndarray): new datafilters</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a><span class="sd">            cells (list): cells to replace datafilters for</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a><span class="sd">        Returns:</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a><span class="sd">            None</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>        
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>        <span class="n">NTdf</span><span class="p">,</span> <span class="n">NCdf</span> <span class="o">=</span> <span class="n">new_dfs</span><span class="o">.</span><span class="n">shape</span> 
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>        <span class="k">if</span> <span class="n">cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>            <span class="k">assert</span> <span class="n">NCdf</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;new DF is wrong shape to replace DF for all cells.&quot;</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>            <span class="n">cells</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">&lt;</span> <span class="n">NTdf</span><span class="p">:</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cells</span><span class="p">]</span> <span class="o">*=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">new_dfs</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">&gt;</span> <span class="n">NTdf</span><span class="p">:</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>                <span class="c1"># Assume dfs are 0 after new valid region</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Truncating valid region to new datafilter length&quot;</span><span class="p">,</span> <span class="n">NTdf</span><span class="p">)</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>                <span class="n">new_dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> 
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>                    <span class="p">(</span><span class="n">new_dfs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="o">-</span><span class="n">NTdf</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span> 
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>                    <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cells</span><span class="p">]</span> <span class="o">*=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">new_dfs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>        <span class="c1"># END ColorClouds.replace_dfs()</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>    <span class="k">def</span> <span class="nf">draw_stim_locations</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">top_corner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">row_height</span><span class="o">=</span><span class="mf">5.0</span> <span class="p">):</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a><span class="sd">        Draws stimulus locations</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a><span class="sd">        Args:</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a><span class="sd">            top_corner (list): top corner of stimulus</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a><span class="sd">            L (int): length of stimulus</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a><span class="sd">            row_height (float): height of row</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a><span class="sd">        Returns:</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a><span class="sd">            None</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>        <span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Rectangle</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>        <span class="n">lamlocs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>        <span class="n">ETlocs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_locationET</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>        <span class="n">fixloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>        <span class="n">fixsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_size</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>        <span class="n">BUF</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>        <span class="k">if</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">lamlocs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">row_height</span><span class="p">,</span> <span class="n">row_height</span><span class="p">)</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>        <span class="n">nET</span> <span class="o">=</span> <span class="n">ETlocs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>        <span class="n">nLAM</span> <span class="o">=</span> <span class="n">lamlocs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>        <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>        <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>        <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">3</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">3</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>        <span class="c1">#print(x0,x1,y0,y1)</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nLAM</span><span class="p">):</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>                <span class="n">Rectangle</span><span class="p">((</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">lamlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ii</span><span class="p">]),</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> 
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>                <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">))</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>        <span class="n">clrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">]</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nET</span><span class="p">):</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ii</span><span class="p">],</span> <span class="n">ETlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="p">]),</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> 
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>                                <span class="n">edgecolor</span><span class="o">=</span><span class="n">clrs</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>        <span class="k">if</span> <span class="n">fixloc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">fixloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">fixsize</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fixloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">fixsize</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">fixsize</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">fixsize</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>                                <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>        <span class="k">if</span> <span class="n">top_corner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">(</span><span class="n">top_corner</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> 
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>                                <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">))</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>            
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">x0</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span><span class="n">x1</span><span class="o">+</span><span class="n">BUF</span><span class="p">])</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="n">y0</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span><span class="n">y1</span><span class="o">+</span><span class="n">BUF</span><span class="p">])</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>    <span class="c1"># END .draw_stim_locations()</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>    
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>    <span class="k">def</span> <span class="nf">avrates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a><span class="sd">        Calculates average firing probability across specified inds (or whole dataset)</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a><span class="sd">        -- Note will respect datafilters</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a><span class="sd">        -- will return precalc value to save time if already stored</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a><span class="sd">        Args:</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a><span class="sd">            inds (list): indices to calculate across</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a><span class="sd">        Returns:</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a><span class="sd">            np.ndarray: average firing rates</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>            <span class="c1"># then calculate across whole dataset</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>                <span class="c1"># then precalculated and do not need to do</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>        <span class="c1"># Otherwise calculate across all data</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>            <span class="n">Reff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>            <span class="n">Teff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="o">/</span><span class="n">Teff</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Still need to implement avRs without preloading&#39;</span><span class="p">)</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>    <span class="c1"># END .avrates()</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>    <span class="k">def</span> <span class="nf">shift_stim</span><span class="p">(</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">pos_shifts</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metric_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ts_thresh</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>        <span class="n">shift_times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">already_lagged</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a><span class="sd">        Shift stimulus given standard shifting input (TBD)</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a><span class="sd">        use &#39;shift-times&#39; if given shifts correspond to range of times</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a><span class="sd">        </span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a><span class="sd">        Args:</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a><span class="sd">            pos_shifts (np.ndarray): shifts to apply</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a><span class="sd">            metrics (np.ndarray): metric to apply threshold</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a><span class="sd">            metric_threshold (float): threshold for metric</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a><span class="sd">            ts_thresh (int): threshold for number of timepoints</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a><span class="sd">            shift_times (list): times to shift stimulus</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a><span class="sd">            already_lagged (bool): whether stimulus is already lagged</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a><span class="sd">        Returns:</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a><span class="sd">            np.ndarray: shifted stimulus</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>        <span class="n">NX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>        <span class="n">nlags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>        <span class="c1"># Check if has been time-lagged yet</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>  
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>        <span class="k">if</span> <span class="n">already_lagged</span><span class="p">:</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>            <span class="n">re_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Should be already lagged, but seems not&quot;</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>            <span class="n">re_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>        <span class="c1"># Apply shift-times (subset)</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>        <span class="k">if</span> <span class="n">shift_times</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>            <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>            <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">[</span><span class="n">shift_times</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>            <span class="c1"># Find minimum fix_n and make = 1</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>            <span class="n">min_fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fix_n</span><span class="p">[</span><span class="n">fix_n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>            <span class="c1">#print(&#39;min_fix_n&#39;, min_fix_n, &#39;adjust&#39;, 1-min_fix_n)</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>            <span class="n">fix_n</span><span class="p">[</span><span class="n">fix_n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">-</span><span class="n">min_fix_n</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>            <span class="n">re_stim</span> <span class="o">=</span> <span class="n">re_stim</span><span class="p">[</span><span class="n">shift_times</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>            <span class="c1">#print(&#39;max fix&#39;, np.max(fix_n), fix_n.shape)</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>        
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>        <span class="n">NF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fix_n</span><span class="p">)</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>        <span class="n">NTtmp</span> <span class="o">=</span> <span class="n">re_stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>        <span class="n">nclr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>        <span class="c1">#sh0 = -(pos_shifts[:,0]-self.dims[1]//2)</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>        <span class="c1">#sh1 = -(pos_shifts[:,1]-self.dims[2]//2)</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>        <span class="n">sh0</span> <span class="o">=</span> <span class="n">pos_shifts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># this should be in units of pixels relative to 0</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>        <span class="n">sh1</span> <span class="o">=</span> <span class="n">pos_shifts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>        <span class="n">sp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">re_stim</span><span class="p">)</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>        <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>            <span class="n">val_fix</span> <span class="o">=</span> <span class="n">metrics</span> <span class="o">&gt;</span> <span class="n">metric_threshold</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Applied metric threshold: </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">val_fix</span><span class="p">),</span> <span class="n">NF</span><span class="p">))</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>            <span class="n">val_fix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span><span class="o">*</span><span class="n">NF</span><span class="p">)</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NF</span><span class="p">):</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fix_n</span> <span class="o">==</span> <span class="n">ff</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>            <span class="c1">#print(ff, len(ts), ts[0], ts[-1])</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>            <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh0</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh1</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ts_thresh</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">val_fix</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">):</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>                <span class="c1"># FIRST SP DIM shift</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>                <span class="n">sh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sh0</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>                <span class="n">stim_seg</span> <span class="o">=</span> <span class="n">re_stim</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>                <span class="k">if</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span> <span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>                    <span class="n">stim_tmp</span><span class="p">[:,</span> <span class="p">:,</span><span class="n">sh</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_seg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="o">-</span><span class="n">sh</span><span class="p">),</span> <span class="p">:])</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>                <span class="k">elif</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span> <span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>                    <span class="n">stim_tmp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">sh</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_seg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">(</span><span class="o">-</span><span class="n">sh</span><span class="p">):,</span> <span class="p">:])</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_seg</span><span class="p">)</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>                <span class="c1"># SECOND SP DIM shift</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>                <span class="n">sh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sh1</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>                <span class="k">if</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>                    <span class="n">stim_tmp2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>                    <span class="n">stim_tmp2</span><span class="p">[</span><span class="o">...</span> <span class="p">,</span> <span class="n">sh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:(</span><span class="o">-</span><span class="n">sh</span><span class="p">)])</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>                <span class="k">elif</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>                    <span class="n">stim_tmp2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>                    <span class="n">stim_tmp2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">sh</span><span class="p">):])</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>                    <span class="n">stim_tmp2</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>                    
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>                <span class="n">sp_stim</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="o">...</span> <span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp2</span><span class="p">)</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>        <span class="k">if</span> <span class="n">already_lagged</span><span class="p">:</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>            <span class="c1"># Time-embed</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NTtmp</span><span class="p">)</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>            <span class="n">laggedstim</span> <span class="o">=</span> <span class="n">sp_stim</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NTtmp</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nlags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">laggedstim</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>            <span class="k">return</span> <span class="n">sp_stim</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>    <span class="c1"># END ColorCloud.shift_stim -- note outputs stim rather than overwrites</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>    <span class="k">def</span> <span class="nf">shift_stim_fixation</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a><span class="sd">        Simple shift by integer (rounded shift) and zero padded. Note that this is not in </span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a><span class="sd">        is in units of number of bars, rather than -1 to +1. It assumes the stim</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a><span class="sd">        has a batch dimension (over a fixation), and shifts the whole stim by the same amount.</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a><span class="sd">        </span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a><span class="sd">        Args:</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a><span class="sd">            stim (torch.tensor): stimulus to shift</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a><span class="sd">            shift (float): shift amount</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a><span class="sd">        Returns:</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a><span class="sd">            torch.tensor: shifted stimulus</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Currently needs to be fixed to work with 2D&#39;</span><span class="p">)</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>        <span class="n">sh</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>        <span class="n">shstim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>        <span class="k">if</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="o">-</span><span class="n">sh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="p">:</span><span class="n">sh</span><span class="p">]</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>        <span class="k">elif</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="n">sh</span><span class="p">:]</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>            <span class="n">shstim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>        <span class="k">return</span> <span class="n">shstim</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>    <span class="c1"># END .shift_stim_fixation</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>    <span class="k">def</span> <span class="nf">create_valid_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post_sacc_gap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a><span class="sd">        This creates self.valid_inds vector that is used for __get_item__ </span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a><span class="sd">        -- Will default to num_lags following each saccade beginning</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a><span class="sd">        </span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a><span class="sd">        Args:</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a><span class="sd">            post_sacc_gap (int): gap following saccade</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a><span class="sd">        Returns:</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a><span class="sd">            None</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>        <span class="k">if</span> <span class="n">post_sacc_gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>            <span class="n">post_sacc_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>        <span class="c1"># first, throw out all data where all data_filters are zero</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>        <span class="n">is_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>        <span class="n">is_valid</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>        
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>        <span class="c1"># Now invalid post_sacc_gap following saccades</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span><span class="p">):</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:])</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>            <span class="n">sts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>            <span class="n">is_valid</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">post_sacc_gap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>        
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>        <span class="c1">#self.valid_inds = list(np.where(is_valid &gt; 0)[0])</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_valid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>    <span class="c1"># END .create_valid_indices</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>    <span class="k">def</span> <span class="nf">crossval_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test_set</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;This sets the cross-validation indices up We can add featuers here. Many ways to do this</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a><span class="sd">        but will stick to some standard for now. It sets the internal indices, which can be read out</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a><span class="sd">        directly or with helper functions. Perhaps helper_functions is the best way....</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a><span class="sd">        </span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a><span class="sd">        Args:</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a><span class="sd">            folds: number of folds </span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a><span class="sd">            test_set: whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a><span class="sd">            verbose: whether to print out information</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a><span class="sd">        Returns:</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a><span class="sd">            None: sets internal variables test_inds, train_inds, val_inds</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must first specify valid_indices before setting up cross-validation.&quot;</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>        <span class="c1"># Partition data by saccades, and then associate indices with each</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>        <span class="n">te_fixes</span><span class="p">,</span> <span class="n">tr_fixes</span><span class="p">,</span> <span class="n">val_fixes</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixation_grouping</span><span class="p">)):</span>  <span class="c1"># Loops across experiments</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>            <span class="n">fixations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixation_grouping</span><span class="p">[</span><span class="n">ee</span><span class="p">])</span>  <span class="c1"># fixations associated with each experiment</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>            <span class="n">val_fix1</span><span class="p">,</span> <span class="n">tr_fix1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fixations</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>            <span class="k">if</span> <span class="n">test_set</span><span class="p">:</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>                <span class="n">te_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">val_fix1</span><span class="p">])</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>                <span class="n">val_fix2</span><span class="p">,</span> <span class="n">tr_fix2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_fix1</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>                <span class="n">val_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">tr_fix1</span><span class="p">[</span><span class="n">val_fix2</span><span class="p">]])</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>                <span class="n">tr_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">tr_fix1</span><span class="p">[</span><span class="n">tr_fix2</span><span class="p">]])</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>                <span class="n">val_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">val_fix1</span><span class="p">])</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>                <span class="n">tr_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">tr_fix1</span><span class="p">])</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Partitioned </span><span class="si">%d</span><span class="s2"> fixations total: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>                <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">te_fixes</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_fixes</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">val_fixes</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_fixes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_fixes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">te_fixes</span><span class="p">)))</span>  
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>        <span class="c1"># Now pull  indices from each saccade </span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>        <span class="n">tr_inds</span><span class="p">,</span> <span class="n">te_inds</span><span class="p">,</span> <span class="n">val_inds</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">tr_fixes</span><span class="p">:</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>            <span class="n">tr_inds</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">val_fixes</span><span class="p">:</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>            <span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">te_fixes</span><span class="p">:</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>            <span class="n">te_inds</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Pre-valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">te_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>        <span class="c1"># Finally intersect with valid indices</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">)))</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">val_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">)))</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">te_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">)))</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>    <span class="c1"># END MultiDatasetFix.crossval_setup</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>    <span class="k">def</span> <span class="nf">get_max_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpu_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nquad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mf">1.2</span><span class="p">):</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a><span class="sd">        get the maximum number of samples that fit in memory -- for GLM/GQM x LBFGS</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a><span class="sd">        Args:</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a><span class="sd">            gpu_n (int): gpu number</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a><span class="sd">            history_size (int): history size</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a><span class="sd">            nquad (int): number of quadrature points</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a><span class="sd">            num_cells (int): number of cells</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a><span class="sd">            buffer (float): buffer size</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a><span class="sd">        Returns:</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a><span class="sd">            int: maximum number of samples that fit in memory</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>        <span class="k">if</span> <span class="n">gpu_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:1&#39;</span><span class="p">)</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>        <span class="k">if</span> <span class="n">num_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>            <span class="n">num_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>        
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">total_memory</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_reserved</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_allocated</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>        <span class="n">free</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>        <span class="n">mempersample</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>    
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>        <span class="n">mempercell</span> <span class="o">=</span> <span class="n">mempersample</span> <span class="o">*</span> <span class="p">(</span><span class="n">nquad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">history_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>        <span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">*</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>        <span class="n">maxsamples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">free</span> <span class="o">-</span> <span class="n">mempercell</span><span class="o">*</span><span class="n">num_cells</span> <span class="o">-</span> <span class="n">buffer_bytes</span><span class="p">)</span> <span class="o">//</span> <span class="n">mempersample</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# samples that can fit on device: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxsamples</span><span class="p">))</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>        <span class="k">return</span> <span class="n">maxsamples</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>    <span class="c1"># END .get_max_samples</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Have to specify stimulus before pulling data.&quot;</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>        <span class="c1">#if isinstance(idx, np.ndarray):</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>        <span class="c1">#    idx = list(idx)</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>        <span class="c1"># Convert trials to indices if trial-sample</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_sample</span><span class="p">:</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_to_array</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">))</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>                <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">ts</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_to_array</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;get_item time embedding not implemented yet&quot;</span><span class="p">)</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>                <span class="c1"># if self.folded_lags:</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>                <span class="c1">#    stim = np.transpose( tmp_stim, axes=[0,2,1,3,4] ) </span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>                <span class="c1">#else:</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>                <span class="c1">#    stim = np.transpose( tmp_stim, axes=[0,2,3,4,1] )</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>    
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>                    <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>                        <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>                        <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]}</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>                        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;fix_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>                        <span class="c1"># missing saccade timing vector -- not specified</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>                        <span class="n">robs_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs_out</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>                        <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs_out</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s1">&#39;cells_out must be a list&#39;</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>                        <span class="n">robs_tmp</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>                        <span class="n">dfs_tmp</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a> 
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>                    <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>                        <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="n">robs_tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>                        <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="n">dfs_tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]}</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>                        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;fix_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speckled</span><span class="p">:</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>                        <span class="n">M1tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mval</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>                        <span class="n">M2tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>                        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Mval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M1tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>                        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Mtrn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M2tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>                        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Mval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>                        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Mtrn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_separate_eye_stim</span><span class="p">:</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>                    <span class="c1"># Overwrite left stim with left eye only</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>                    <span class="n">tmp_dims</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tmp_dims</span><span class="p">])</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>                    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim_tmp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>                    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;stimR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim_tmp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>            
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>            <span class="n">robs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>            <span class="n">num_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Stim &quot;&quot;&quot;</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>            <span class="c1"># need file handle</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>            <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>            <span class="c1">#f = self.file_index[inds]  # problem is this could span across several files</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;stim&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>            <span class="c1"># reshape and flatten stim: currently its NT x NX x NY x Nclrs</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">permute</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">])</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a><span class="w">                </span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Spikes: needs padding so all are B x NC &quot;&quot;&quot;</span> 
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>            <span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;Robs&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>                <span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>                    <span class="p">(</span><span class="n">robs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span> 
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>                    <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a><span class="w">                </span><span class="sd">&quot;&quot;&quot; Datafilters: needs padding like robs &quot;&quot;&quot;</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;DFs&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>                <span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>                    <span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;DFsMU&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>                    <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="n">stim</span><span class="p">,</span> <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="n">robs</span><span class="p">,</span> <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="n">dfs</span><span class="p">,</span> <span class="s1">&#39;fix_n&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">[</span><span class="n">inds</span><span class="p">]}</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>        <span class="c1"># Addition whether-or-not preloaded</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Xdrift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;binocular&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>            
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">append_covariates</span><span class="p">(</span> <span class="n">out</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>        <span class="c1">### THIS IS NOT NEEDED WITH TIME-EMBEDDING: needs to be on fixation-process side...</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>        <span class="c1"># cushion DFs for number of lags (reducing stim)</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>        <span class="c1">#if (self.num_lags &gt; 0) &amp;  ~utils.is_int(idx):</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>        <span class="c1">#    if out[&#39;dfs&#39;].shape[0] &gt; self.num_lags:</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>        <span class="c1">#        out[&#39;dfs&#39;][:self.num_lags, :] = 0.0</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>        <span class="c1">#    else: </span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>        <span class="c1">#        print( &quot;Warning: requested batch smaller than num_lags %d &lt; %d&quot;%(out[&#39;dfs&#39;].shape[0], self.num_lags) )</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>     
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>        <span class="k">return</span> <span class="n">out</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>    <span class="c1"># END: CloudDataset.__get_item__</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>    <span class="c1">#@property</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>    <span class="c1">#def NT(self):</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>    <span class="c1">#    return len(self.used_inds)</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


            </section>
                <section id="ColorClouds">
                            <input id="ColorClouds-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ColorClouds</span><wbr>(<span class="base">typing.Generic[+T_co]</span>):

                <label class="view-source-button" for="ColorClouds-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ColorClouds"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ColorClouds-17"><a href="#ColorClouds-17"><span class="linenos">  17</span></a><span class="k">class</span> <span class="nc">ColorClouds</span><span class="p">(</span><span class="n">SensoryBase</span><span class="p">):</span>
</span><span id="ColorClouds-18"><a href="#ColorClouds-18"><span class="linenos">  18</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds-19"><a href="#ColorClouds-19"><span class="linenos">  19</span></a><span class="sd">    -- can load batches from multiple datasets</span>
</span><span id="ColorClouds-20"><a href="#ColorClouds-20"><span class="linenos">  20</span></a><span class="sd">    -- hdf5 files must have the following information:</span>
</span><span id="ColorClouds-21"><a href="#ColorClouds-21"><span class="linenos">  21</span></a><span class="sd">        Robs</span>
</span><span id="ColorClouds-22"><a href="#ColorClouds-22"><span class="linenos">  22</span></a><span class="sd">        RobsMU</span>
</span><span id="ColorClouds-23"><a href="#ColorClouds-23"><span class="linenos">  23</span></a><span class="sd">        stim: 4-d stimulus: time x nx x ny x color</span>
</span><span id="ColorClouds-24"><a href="#ColorClouds-24"><span class="linenos">  24</span></a><span class="sd">        block_inds: start and stop of &#39;trials&#39; (perhaps fixations for now)</span>
</span><span id="ColorClouds-25"><a href="#ColorClouds-25"><span class="linenos">  25</span></a><span class="sd">        other things: saccades? or should that be in trials? </span>
</span><span id="ColorClouds-26"><a href="#ColorClouds-26"><span class="linenos">  26</span></a>
</span><span id="ColorClouds-27"><a href="#ColorClouds-27"><span class="linenos">  27</span></a><span class="sd">    Constructor will take eye position, which for now is an input from data</span>
</span><span id="ColorClouds-28"><a href="#ColorClouds-28"><span class="linenos">  28</span></a><span class="sd">    generated in the session (not on disk). It should have the length size </span>
</span><span id="ColorClouds-29"><a href="#ColorClouds-29"><span class="linenos">  29</span></a><span class="sd">    of the total number of fixations x1.</span>
</span><span id="ColorClouds-30"><a href="#ColorClouds-30"><span class="linenos">  30</span></a>
</span><span id="ColorClouds-31"><a href="#ColorClouds-31"><span class="linenos">  31</span></a><span class="sd">    Input arguments (details):</span>
</span><span id="ColorClouds-32"><a href="#ColorClouds-32"><span class="linenos">  32</span></a><span class="sd">        stim_crop = None, should be of form [x1, x2, y1, y2] where each number is the </span>
</span><span id="ColorClouds-33"><a href="#ColorClouds-33"><span class="linenos">  33</span></a><span class="sd">            extreme point to be include as an index, e.g. range(x1, x2+1), ... </span>
</span><span id="ColorClouds-34"><a href="#ColorClouds-34"><span class="linenos">  34</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ColorClouds-35"><a href="#ColorClouds-35"><span class="linenos">  35</span></a>
</span><span id="ColorClouds-36"><a href="#ColorClouds-36"><span class="linenos">  36</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="ColorClouds-37"><a href="#ColorClouds-37"><span class="linenos">  37</span></a>        <span class="n">filenames</span><span class="p">,</span>
</span><span id="ColorClouds-38"><a href="#ColorClouds-38"><span class="linenos">  38</span></a>        <span class="n">datadir</span><span class="p">,</span> 
</span><span id="ColorClouds-39"><a href="#ColorClouds-39"><span class="linenos">  39</span></a>        <span class="n">time_embed</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="c1"># 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="ColorClouds-40"><a href="#ColorClouds-40"><span class="linenos">  40</span></a>        <span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
</span><span id="ColorClouds-41"><a href="#ColorClouds-41"><span class="linenos">  41</span></a>        <span class="n">include_MUs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ColorClouds-42"><a href="#ColorClouds-42"><span class="linenos">  42</span></a>        <span class="n">drift_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ColorClouds-43"><a href="#ColorClouds-43"><span class="linenos">  43</span></a>        <span class="n">trial_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ColorClouds-44"><a href="#ColorClouds-44"><span class="linenos">  44</span></a>        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">),</span>
</span><span id="ColorClouds-45"><a href="#ColorClouds-45"><span class="linenos">  45</span></a>        <span class="c1"># Dataset-specitic inputs</span>
</span><span id="ColorClouds-46"><a href="#ColorClouds-46"><span class="linenos">  46</span></a>        <span class="c1"># Stim setup -- if dont want to assemble stimulus: specify all things here for default options</span>
</span><span id="ColorClouds-47"><a href="#ColorClouds-47"><span class="linenos">  47</span></a>        <span class="n">which_stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># &#39;et&#39; or 0, or 1 for lam, but default assemble later</span>
</span><span id="ColorClouds-48"><a href="#ColorClouds-48"><span class="linenos">  48</span></a>        <span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># should be list/array of 4 numbers representing inds of edges</span>
</span><span id="ColorClouds-49"><a href="#ColorClouds-49"><span class="linenos">  49</span></a>        <span class="n">luminance_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="ColorClouds-50"><a href="#ColorClouds-50"><span class="linenos">  50</span></a>        <span class="n">ignore_saccades</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="ColorClouds-51"><a href="#ColorClouds-51"><span class="linenos">  51</span></a>        <span class="n">folded_lags</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="ColorClouds-52"><a href="#ColorClouds-52"><span class="linenos">  52</span></a>        <span class="n">binocular</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># whether to include separate filters for each eye</span>
</span><span id="ColorClouds-53"><a href="#ColorClouds-53"><span class="linenos">  53</span></a>        <span class="n">eye_config</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 0 = all, 1, -1, and 2 are options (2 = binocular)</span>
</span><span id="ColorClouds-54"><a href="#ColorClouds-54"><span class="linenos">  54</span></a>        <span class="n">maxT</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="ColorClouds-55"><a href="#ColorClouds-55"><span class="linenos">  55</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds-56"><a href="#ColorClouds-56"><span class="linenos">  56</span></a><span class="sd">        Constructor options</span>
</span><span id="ColorClouds-57"><a href="#ColorClouds-57"><span class="linenos">  57</span></a><span class="sd">        </span>
</span><span id="ColorClouds-58"><a href="#ColorClouds-58"><span class="linenos">  58</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds-59"><a href="#ColorClouds-59"><span class="linenos">  59</span></a><span class="sd">            filenames (list): list of strings with filenames (without .mat) to load</span>
</span><span id="ColorClouds-60"><a href="#ColorClouds-60"><span class="linenos">  60</span></a><span class="sd">            datadir (str): directory where data is stored</span>
</span><span id="ColorClouds-61"><a href="#ColorClouds-61"><span class="linenos">  61</span></a><span class="sd">            time_embed (int): 0, 1, or 2. 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="ColorClouds-62"><a href="#ColorClouds-62"><span class="linenos">  62</span></a><span class="sd">            num_lags (int): number of lags to use in time-embedding</span>
</span><span id="ColorClouds-63"><a href="#ColorClouds-63"><span class="linenos">  63</span></a><span class="sd">            include_MUs (bool): whether to include MUs in the dataset</span>
</span><span id="ColorClouds-64"><a href="#ColorClouds-64"><span class="linenos">  64</span></a><span class="sd">            drift_interval (int): number of blocks to include in drift term</span>
</span><span id="ColorClouds-65"><a href="#ColorClouds-65"><span class="linenos">  65</span></a><span class="sd">            trial_sample (bool): whether to sample trials randomly</span>
</span><span id="ColorClouds-66"><a href="#ColorClouds-66"><span class="linenos">  66</span></a><span class="sd">            device (torch.device): device to store data on</span>
</span><span id="ColorClouds-67"><a href="#ColorClouds-67"><span class="linenos">  67</span></a><span class="sd">            which_stim (str or int): &#39;et&#39; or 0, or 1 for lam, but default assemble later</span>
</span><span id="ColorClouds-68"><a href="#ColorClouds-68"><span class="linenos">  68</span></a><span class="sd">            stim_crop (list): should be list/array of 4 numbers representing inds of edges</span>
</span><span id="ColorClouds-69"><a href="#ColorClouds-69"><span class="linenos">  69</span></a><span class="sd">            luminance_only (bool): whether to use only luminance channel</span>
</span><span id="ColorClouds-70"><a href="#ColorClouds-70"><span class="linenos">  70</span></a><span class="sd">            ignore_saccades (bool): whether to ignore saccades</span>
</span><span id="ColorClouds-71"><a href="#ColorClouds-71"><span class="linenos">  71</span></a><span class="sd">            folded_lags (bool): whether to fold lags into channels</span>
</span><span id="ColorClouds-72"><a href="#ColorClouds-72"><span class="linenos">  72</span></a><span class="sd">            binocular (bool): whether to include separate filters for each eye</span>
</span><span id="ColorClouds-73"><a href="#ColorClouds-73"><span class="linenos">  73</span></a><span class="sd">            eye_config (int): 0 = all, 1, -1, and 2 are options (2 = binocular)</span>
</span><span id="ColorClouds-74"><a href="#ColorClouds-74"><span class="linenos">  74</span></a><span class="sd">            maxT (int): maximum number of time points to include</span>
</span><span id="ColorClouds-75"><a href="#ColorClouds-75"><span class="linenos">  75</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds-76"><a href="#ColorClouds-76"><span class="linenos">  76</span></a>
</span><span id="ColorClouds-77"><a href="#ColorClouds-77"><span class="linenos">  77</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="ColorClouds-78"><a href="#ColorClouds-78"><span class="linenos">  78</span></a>            <span class="n">filenames</span><span class="o">=</span><span class="n">filenames</span><span class="p">,</span> <span class="n">datadir</span><span class="o">=</span><span class="n">datadir</span><span class="p">,</span> 
</span><span id="ColorClouds-79"><a href="#ColorClouds-79"><span class="linenos">  79</span></a>            <span class="n">time_embed</span><span class="o">=</span><span class="n">time_embed</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">num_lags</span><span class="p">,</span> <span class="n">include_MUs</span><span class="o">=</span><span class="n">include_MUs</span><span class="p">,</span> 
</span><span id="ColorClouds-80"><a href="#ColorClouds-80"><span class="linenos">  80</span></a>            <span class="n">drift_interval</span><span class="o">=</span><span class="n">drift_interval</span><span class="p">,</span> <span class="n">trial_sample</span><span class="o">=</span><span class="n">trial_sample</span><span class="p">,</span>
</span><span id="ColorClouds-81"><a href="#ColorClouds-81"><span class="linenos">  81</span></a>            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds-82"><a href="#ColorClouds-82"><span class="linenos">  82</span></a>
</span><span id="ColorClouds-83"><a href="#ColorClouds-83"><span class="linenos">  83</span></a>        <span class="c1"># Done in parent constructor</span>
</span><span id="ColorClouds-84"><a href="#ColorClouds-84"><span class="linenos">  84</span></a>        <span class="c1">#self.datadir = datadir</span>
</span><span id="ColorClouds-85"><a href="#ColorClouds-85"><span class="linenos">  85</span></a>        <span class="c1">#self.filenames = filenames</span>
</span><span id="ColorClouds-86"><a href="#ColorClouds-86"><span class="linenos">  86</span></a>        <span class="c1">#self.device = device</span>
</span><span id="ColorClouds-87"><a href="#ColorClouds-87"><span class="linenos">  87</span></a>        <span class="c1">#self.num_lags = 10  # default: to be set later</span>
</span><span id="ColorClouds-88"><a href="#ColorClouds-88"><span class="linenos">  88</span></a>        <span class="c1">#if time_embed == 2:</span>
</span><span id="ColorClouds-89"><a href="#ColorClouds-89"><span class="linenos">  89</span></a>        <span class="c1">#    assert preload, &quot;Cannot pre-time-embed without preloading.&quot;</span>
</span><span id="ColorClouds-90"><a href="#ColorClouds-90"><span class="linenos">  90</span></a>        <span class="c1">#self.time_embed = time_embed</span>
</span><span id="ColorClouds-91"><a href="#ColorClouds-91"><span class="linenos">  91</span></a>        <span class="c1">#self.preload = preload</span>
</span><span id="ColorClouds-92"><a href="#ColorClouds-92"><span class="linenos">  92</span></a>
</span><span id="ColorClouds-93"><a href="#ColorClouds-93"><span class="linenos">  93</span></a>        <span class="c1"># Stim-specific</span>
</span><span id="ColorClouds-94"><a href="#ColorClouds-94"><span class="linenos">  94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="o">=</span> <span class="kc">None</span> 
</span><span id="ColorClouds-95"><a href="#ColorClouds-95"><span class="linenos">  95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span> <span class="o">=</span> <span class="n">folded_lags</span>
</span><span id="ColorClouds-96"><a href="#ColorClouds-96"><span class="linenos">  96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">=</span> <span class="n">eye_config</span>
</span><span id="ColorClouds-97"><a href="#ColorClouds-97"><span class="linenos">  97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span> <span class="o">=</span> <span class="n">binocular</span>
</span><span id="ColorClouds-98"><a href="#ColorClouds-98"><span class="linenos">  98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span> <span class="o">=</span> <span class="n">luminance_only</span>
</span><span id="ColorClouds-99"><a href="#ColorClouds-99"><span class="linenos">  99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_Xfix</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ColorClouds-100"><a href="#ColorClouds-100"><span class="linenos"> 100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_separate_eye_stim</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ColorClouds-101"><a href="#ColorClouds-101"><span class="linenos"> 101</span></a>
</span><span id="ColorClouds-102"><a href="#ColorClouds-102"><span class="linenos"> 102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds-103"><a href="#ColorClouds-103"><span class="linenos"> 103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span> <span class="o">=</span> <span class="n">drift_interval</span>
</span><span id="ColorClouds-104"><a href="#ColorClouds-104"><span class="linenos"> 104</span></a>
</span><span id="ColorClouds-105"><a href="#ColorClouds-105"><span class="linenos"> 105</span></a>        <span class="c1"># get hdf5 file handles</span>
</span><span id="ColorClouds-106"><a href="#ColorClouds-106"><span class="linenos"> 106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">sess</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>
</span><span id="ColorClouds-107"><a href="#ColorClouds-107"><span class="linenos"> 107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ColorClouds-108"><a href="#ColorClouds-108"><span class="linenos"> 108</span></a>
</span><span id="ColorClouds-109"><a href="#ColorClouds-109"><span class="linenos"> 109</span></a>        <span class="c1"># Set up to store default train_, val_, test_inds</span>
</span><span id="ColorClouds-110"><a href="#ColorClouds-110"><span class="linenos"> 110</span></a>        <span class="c1">#self.test_inds = None</span>
</span><span id="ColorClouds-111"><a href="#ColorClouds-111"><span class="linenos"> 111</span></a>        <span class="c1">#self.val_inds = None</span>
</span><span id="ColorClouds-112"><a href="#ColorClouds-112"><span class="linenos"> 112</span></a>        <span class="c1">#self.train_inds = None</span>
</span><span id="ColorClouds-113"><a href="#ColorClouds-113"><span class="linenos"> 113</span></a>        <span class="c1">#self.used_inds = []</span>
</span><span id="ColorClouds-114"><a href="#ColorClouds-114"><span class="linenos"> 114</span></a>
</span><span id="ColorClouds-115"><a href="#ColorClouds-115"><span class="linenos"> 115</span></a>        <span class="c1"># Data to construct and store in memory</span>
</span><span id="ColorClouds-116"><a href="#ColorClouds-116"><span class="linenos"> 116</span></a>        <span class="c1">#self.stim = []</span>
</span><span id="ColorClouds-117"><a href="#ColorClouds-117"><span class="linenos"> 117</span></a>        <span class="c1">#self.dfs = []</span>
</span><span id="ColorClouds-118"><a href="#ColorClouds-118"><span class="linenos"> 118</span></a>        <span class="c1">#self.robs = []</span>
</span><span id="ColorClouds-119"><a href="#ColorClouds-119"><span class="linenos"> 119</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ColorClouds-120"><a href="#ColorClouds-120"><span class="linenos"> 120</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ColorClouds-121"><a href="#ColorClouds-121"><span class="linenos"> 121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds-122"><a href="#ColorClouds-122"><span class="linenos"> 122</span></a>
</span><span id="ColorClouds-123"><a href="#ColorClouds-123"><span class="linenos"> 123</span></a>        <span class="c1"># build index map -- exclude variables already set in sensory-base</span>
</span><span id="ColorClouds-124"><a href="#ColorClouds-124"><span class="linenos"> 124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="ColorClouds-125"><a href="#ColorClouds-125"><span class="linenos"> 125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_threshold</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># how many valid time points required to include saccade?</span>
</span><span id="ColorClouds-126"><a href="#ColorClouds-126"><span class="linenos"> 126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_index</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># which file the block corresponds to</span>
</span><span id="ColorClouds-127"><a href="#ColorClouds-127"><span class="linenos"> 127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ColorClouds-128"><a href="#ColorClouds-128"><span class="linenos"> 128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_shifts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ColorClouds-129"><a href="#ColorClouds-129"><span class="linenos"> 129</span></a>        <span class="c1">#self.stim_dims = None</span>
</span><span id="ColorClouds-130"><a href="#ColorClouds-130"><span class="linenos"> 130</span></a>
</span><span id="ColorClouds-131"><a href="#ColorClouds-131"><span class="linenos"> 131</span></a>        <span class="c1">#self.unit_ids = []</span>
</span><span id="ColorClouds-132"><a href="#ColorClouds-132"><span class="linenos"> 132</span></a>        <span class="c1">#self.num_units, self.num_SUs, self.num_MUs = [], [], []</span>
</span><span id="ColorClouds-133"><a href="#ColorClouds-133"><span class="linenos"> 133</span></a>        <span class="c1">#self.SUs = []</span>
</span><span id="ColorClouds-134"><a href="#ColorClouds-134"><span class="linenos"> 134</span></a>        <span class="c1">#self.NC = 0    </span>
</span><span id="ColorClouds-135"><a href="#ColorClouds-135"><span class="linenos"> 135</span></a>        <span class="c1">#self.block_inds = []</span>
</span><span id="ColorClouds-136"><a href="#ColorClouds-136"><span class="linenos"> 136</span></a>        <span class="c1">#self.block_filemapping = []</span>
</span><span id="ColorClouds-137"><a href="#ColorClouds-137"><span class="linenos"> 137</span></a>        <span class="c1">#self.include_MUs = include_MUs</span>
</span><span id="ColorClouds-138"><a href="#ColorClouds-138"><span class="linenos"> 138</span></a>        <span class="c1">#self.SUinds = []</span>
</span><span id="ColorClouds-139"><a href="#ColorClouds-139"><span class="linenos"> 139</span></a>        <span class="c1">#self.MUinds = []</span>
</span><span id="ColorClouds-140"><a href="#ColorClouds-140"><span class="linenos"> 140</span></a>        <span class="c1">#self.cells_out = []  # can be list to output specific cells in get_item</span>
</span><span id="ColorClouds-141"><a href="#ColorClouds-141"><span class="linenos"> 141</span></a>        <span class="c1">#self.avRs = None</span>
</span><span id="ColorClouds-142"><a href="#ColorClouds-142"><span class="linenos"> 142</span></a>
</span><span id="ColorClouds-143"><a href="#ColorClouds-143"><span class="linenos"> 143</span></a>        <span class="n">tcount</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds-144"><a href="#ColorClouds-144"><span class="linenos"> 144</span></a>
</span><span id="ColorClouds-145"><a href="#ColorClouds-145"><span class="linenos"> 145</span></a>        <span class="k">for</span> <span class="n">fnum</span><span class="p">,</span> <span class="n">fhandle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">):</span>
</span><span id="ColorClouds-146"><a href="#ColorClouds-146"><span class="linenos"> 146</span></a>
</span><span id="ColorClouds-147"><a href="#ColorClouds-147"><span class="linenos"> 147</span></a>            <span class="n">NT</span><span class="p">,</span> <span class="n">NSUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="ColorClouds-148"><a href="#ColorClouds-148"><span class="linenos"> 148</span></a>            <span class="c1"># Check for valid RobsMU</span>
</span><span id="ColorClouds-149"><a href="#ColorClouds-149"><span class="linenos"> 149</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ColorClouds-150"><a href="#ColorClouds-150"><span class="linenos"> 150</span></a>                <span class="n">NMUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds-151"><a href="#ColorClouds-151"><span class="linenos"> 151</span></a>            <span class="k">else</span><span class="p">:</span> 
</span><span id="ColorClouds-152"><a href="#ColorClouds-152"><span class="linenos"> 152</span></a>                <span class="n">NMUfile</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds-153"><a href="#ColorClouds-153"><span class="linenos"> 153</span></a>
</span><span id="ColorClouds-154"><a href="#ColorClouds-154"><span class="linenos"> 154</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_SUs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NSUfile</span><span class="p">)</span>
</span><span id="ColorClouds-155"><a href="#ColorClouds-155"><span class="linenos"> 155</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_MUs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NMUfile</span><span class="p">)</span>
</span><span id="ColorClouds-156"><a href="#ColorClouds-156"><span class="linenos"> 156</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="o">+</span><span class="n">NSUfile</span><span class="p">))</span>
</span><span id="ColorClouds-157"><a href="#ColorClouds-157"><span class="linenos"> 157</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;block_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="ColorClouds-158"><a href="#ColorClouds-158"><span class="linenos"> 158</span></a>            <span class="n">blk_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># convert to python so range works</span>
</span><span id="ColorClouds-159"><a href="#ColorClouds-159"><span class="linenos"> 159</span></a>            <span class="c1"># Check to make sure not inverted blk_inds (older version of data)</span>
</span><span id="ColorClouds-160"><a href="#ColorClouds-160"><span class="linenos"> 160</span></a>            <span class="k">if</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="ColorClouds-161"><a href="#ColorClouds-161"><span class="linenos"> 161</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: blk_inds is stored old-style: transposing&#39;</span><span class="p">)</span>
</span><span id="ColorClouds-162"><a href="#ColorClouds-162"><span class="linenos"> 162</span></a>                <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">T</span>
</span><span id="ColorClouds-163"><a href="#ColorClouds-163"><span class="linenos"> 163</span></a>
</span><span id="ColorClouds-164"><a href="#ColorClouds-164"><span class="linenos"> 164</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapSU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds-165"><a href="#ColorClouds-165"><span class="linenos"> 165</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">channel_rating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs_rating&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds-166"><a href="#ColorClouds-166"><span class="linenos"> 166</span></a>            <span class="k">if</span> <span class="n">NMUfile</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds-167"><a href="#ColorClouds-167"><span class="linenos"> 167</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds-168"><a href="#ColorClouds-168"><span class="linenos"> 168</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">channelMU_rating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU_rating&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds-169"><a href="#ColorClouds-169"><span class="linenos"> 169</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">channel_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_mapSU</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapMU</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ColorClouds-170"><a href="#ColorClouds-170"><span class="linenos"> 170</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-171"><a href="#ColorClouds-171"><span class="linenos"> 171</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapMU</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ColorClouds-172"><a href="#ColorClouds-172"><span class="linenos"> 172</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">channel_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapSU</span>
</span><span id="ColorClouds-173"><a href="#ColorClouds-173"><span class="linenos"> 173</span></a>            
</span><span id="ColorClouds-174"><a href="#ColorClouds-174"><span class="linenos"> 174</span></a>            <span class="c1"># Stimulus information</span>
</span><span id="ColorClouds-175"><a href="#ColorClouds-175"><span class="linenos"> 175</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;fix_location&#39;</span><span class="p">])</span>
</span><span id="ColorClouds-176"><a href="#ColorClouds-176"><span class="linenos"> 176</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;fix_size&#39;</span><span class="p">])</span>
</span><span id="ColorClouds-177"><a href="#ColorClouds-177"><span class="linenos"> 177</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim_location&#39;</span><span class="p">])</span>
</span><span id="ColorClouds-178"><a href="#ColorClouds-178"><span class="linenos"> 178</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_locationET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;ETstim_location&#39;</span><span class="p">])</span>
</span><span id="ColorClouds-179"><a href="#ColorClouds-179"><span class="linenos"> 179</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimscale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimscale&#39;</span><span class="p">])</span>
</span><span id="ColorClouds-180"><a href="#ColorClouds-180"><span class="linenos"> 180</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ColorClouds-181"><a href="#ColorClouds-181"><span class="linenos"> 181</span></a>
</span><span id="ColorClouds-182"><a href="#ColorClouds-182"><span class="linenos"> 182</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">blockID</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;blockID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-183"><a href="#ColorClouds-183"><span class="linenos"> 183</span></a>
</span><span id="ColorClouds-184"><a href="#ColorClouds-184"><span class="linenos"> 184</span></a>            <span class="c1"># ETtrace information</span>
</span><span id="ColorClouds-185"><a href="#ColorClouds-185"><span class="linenos"> 185</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ETtrace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;ETtrace&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-186"><a href="#ColorClouds-186"><span class="linenos"> 186</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ETtraceHR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;ETtrace_raw&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-187"><a href="#ColorClouds-187"><span class="linenos"> 187</span></a>
</span><span id="ColorClouds-188"><a href="#ColorClouds-188"><span class="linenos"> 188</span></a>            <span class="n">NCfile</span> <span class="o">=</span> <span class="n">NSUfile</span>
</span><span id="ColorClouds-189"><a href="#ColorClouds-189"><span class="linenos"> 189</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="ColorClouds-190"><a href="#ColorClouds-190"><span class="linenos"> 190</span></a>                <span class="n">NCfile</span> <span class="o">+=</span> <span class="n">NMUfile</span>
</span><span id="ColorClouds-191"><a href="#ColorClouds-191"><span class="linenos"> 191</span></a>            
</span><span id="ColorClouds-192"><a href="#ColorClouds-192"><span class="linenos"> 192</span></a>            <span class="c1"># This will associate each block with each file</span>
</span><span id="ColorClouds-193"><a href="#ColorClouds-193"><span class="linenos"> 193</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_filemapping</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="n">fnum</span><span class="p">)</span>
</span><span id="ColorClouds-194"><a href="#ColorClouds-194"><span class="linenos"> 194</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span><span class="p">[</span><span class="n">fnum</span><span class="p">]</span><span class="o">=</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-195"><a href="#ColorClouds-195"><span class="linenos"> 195</span></a>
</span><span id="ColorClouds-196"><a href="#ColorClouds-196"><span class="linenos"> 196</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>  <span class="c1"># this is basis of data (stimLP and stimET)</span>
</span><span id="ColorClouds-197"><a href="#ColorClouds-197"><span class="linenos"> 197</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># # when stim is constructed</span>
</span><span id="ColorClouds-198"><a href="#ColorClouds-198"><span class="linenos"> 198</span></a>
</span><span id="ColorClouds-199"><a href="#ColorClouds-199"><span class="linenos"> 199</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; EYE configuration &quot;&quot;&quot;</span>
</span><span id="ColorClouds-200"><a href="#ColorClouds-200"><span class="linenos"> 200</span></a>            <span class="c1">#if self.eye_config &gt; 0:</span>
</span><span id="ColorClouds-201"><a href="#ColorClouds-201"><span class="linenos"> 201</span></a>            <span class="n">Lpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useLeye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-202"><a href="#ColorClouds-202"><span class="linenos"> 202</span></a>            <span class="n">Rpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-203"><a href="#ColorClouds-203"><span class="linenos"> 203</span></a>            <span class="n">LRpresent</span> <span class="o">=</span> <span class="n">Lpresent</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Rpresent</span>
</span><span id="ColorClouds-204"><a href="#ColorClouds-204"><span class="linenos"> 204</span></a>
</span><span id="ColorClouds-205"><a href="#ColorClouds-205"><span class="linenos"> 205</span></a>            <span class="k">if</span> <span class="n">luminance_only</span><span class="p">:</span>
</span><span id="ColorClouds-206"><a href="#ColorClouds-206"><span class="linenos"> 206</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ColorClouds-207"><a href="#ColorClouds-207"><span class="linenos"> 207</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reducing stimulus channels (</span><span class="si">%d</span><span class="s2">) to first dimension&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="ColorClouds-208"><a href="#ColorClouds-208"><span class="linenos"> 208</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ColorClouds-209"><a href="#ColorClouds-209"><span class="linenos"> 209</span></a>
</span><span id="ColorClouds-210"><a href="#ColorClouds-210"><span class="linenos"> 210</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="ColorClouds-211"><a href="#ColorClouds-211"><span class="linenos"> 211</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">2</span>
</span><span id="ColorClouds-212"><a href="#ColorClouds-212"><span class="linenos"> 212</span></a>
</span><span id="ColorClouds-213"><a href="#ColorClouds-213"><span class="linenos"> 213</span></a>            <span class="c1">#if self.time_embed &gt; 0:</span>
</span><span id="ColorClouds-214"><a href="#ColorClouds-214"><span class="linenos"> 214</span></a>            <span class="c1">#    self.dims[3] = self.num_lags</span>
</span><span id="ColorClouds-215"><a href="#ColorClouds-215"><span class="linenos"> 215</span></a>
</span><span id="ColorClouds-216"><a href="#ColorClouds-216"><span class="linenos"> 216</span></a>            <span class="c1">#print(&#39;Stim check:&#39;, folded_lags, self.dims)</span>
</span><span id="ColorClouds-217"><a href="#ColorClouds-217"><span class="linenos"> 217</span></a>
</span><span id="ColorClouds-218"><a href="#ColorClouds-218"><span class="linenos"> 218</span></a>            <span class="c1">#self.unit_ids.append(self.NC + np.asarray(range(NCfile)))</span>
</span><span id="ColorClouds-219"><a href="#ColorClouds-219"><span class="linenos"> 219</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NCfile</span><span class="p">)</span>
</span><span id="ColorClouds-220"><a href="#ColorClouds-220"><span class="linenos"> 220</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">+=</span> <span class="n">NCfile</span>
</span><span id="ColorClouds-221"><a href="#ColorClouds-221"><span class="linenos"> 221</span></a>
</span><span id="ColorClouds-222"><a href="#ColorClouds-222"><span class="linenos"> 222</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_saccades</span><span class="p">:</span>
</span><span id="ColorClouds-223"><a href="#ColorClouds-223"><span class="linenos"> 223</span></a>                <span class="n">sacc_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;sacc_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="ColorClouds-224"><a href="#ColorClouds-224"><span class="linenos"> 224</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sacc_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ColorClouds-225"><a href="#ColorClouds-225"><span class="linenos"> 225</span></a>                    <span class="n">sacc_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># convert to python so range works</span>
</span><span id="ColorClouds-226"><a href="#ColorClouds-226"><span class="linenos"> 226</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-227"><a href="#ColorClouds-227"><span class="linenos"> 227</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ignoring sacc_inds. Assuming not valid&quot;</span><span class="p">)</span>
</span><span id="ColorClouds-228"><a href="#ColorClouds-228"><span class="linenos"> 228</span></a>                    <span class="n">sacc_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ColorClouds-229"><a href="#ColorClouds-229"><span class="linenos"> 229</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sacc_inds</span><span class="p">)</span>
</span><span id="ColorClouds-230"><a href="#ColorClouds-230"><span class="linenos"> 230</span></a>
</span><span id="ColorClouds-231"><a href="#ColorClouds-231"><span class="linenos"> 231</span></a>            <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;valid_data&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>  <span class="c1">#range(self.NT)  # default -- to be changed at end of init</span>
</span><span id="ColorClouds-232"><a href="#ColorClouds-232"><span class="linenos"> 232</span></a>            <span class="k">if</span> <span class="n">valid_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>   <span class="c1"># Make version-read proof</span>
</span><span id="ColorClouds-233"><a href="#ColorClouds-233"><span class="linenos"> 233</span></a>                <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">valid_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds-234"><a href="#ColorClouds-234"><span class="linenos"> 234</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: Old-stype valid_inds saved. Transposing&#39;</span><span class="p">)</span>
</span><span id="ColorClouds-235"><a href="#ColorClouds-235"><span class="linenos"> 235</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-236"><a href="#ColorClouds-236"><span class="linenos"> 236</span></a>                <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">valid_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-237"><a href="#ColorClouds-237"><span class="linenos"> 237</span></a>            <span class="n">tcount</span> <span class="o">+=</span> <span class="n">NT</span>
</span><span id="ColorClouds-238"><a href="#ColorClouds-238"><span class="linenos"> 238</span></a>            <span class="c1"># make larger fix_n, valid_inds, sacc_inds, block_inds as self</span>
</span><span id="ColorClouds-239"><a href="#ColorClouds-239"><span class="linenos"> 239</span></a>
</span><span id="ColorClouds-240"><a href="#ColorClouds-240"><span class="linenos"> 240</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>  <span class="o">=</span> <span class="n">tcount</span>
</span><span id="ColorClouds-241"><a href="#ColorClouds-241"><span class="linenos"> 241</span></a>
</span><span id="ColorClouds-242"><a href="#ColorClouds-242"><span class="linenos"> 242</span></a>        <span class="c1"># For now let&#39;s just debug with one file</span>
</span><span id="ColorClouds-243"><a href="#ColorClouds-243"><span class="linenos"> 243</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ColorClouds-244"><a href="#ColorClouds-244"><span class="linenos"> 244</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: currently ignoring multiple files&#39;</span><span class="p">)</span>
</span><span id="ColorClouds-245"><a href="#ColorClouds-245"><span class="linenos"> 245</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">valid_inds</span><span class="p">)</span>
</span><span id="ColorClouds-246"><a href="#ColorClouds-246"><span class="linenos"> 246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span> <span class="o">=</span> <span class="n">LRpresent</span>
</span><span id="ColorClouds-247"><a href="#ColorClouds-247"><span class="linenos"> 247</span></a>
</span><span id="ColorClouds-248"><a href="#ColorClouds-248"><span class="linenos"> 248</span></a>        <span class="c1"># Make binocular gain term</span>
</span><span id="ColorClouds-249"><a href="#ColorClouds-249"><span class="linenos"> 249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">LRpresent</span><span class="p">),</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="ColorClouds-250"><a href="#ColorClouds-250"><span class="linenos"> 250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="ColorClouds-251"><a href="#ColorClouds-251"><span class="linenos"> 251</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="ColorClouds-252"><a href="#ColorClouds-252"><span class="linenos"> 252</span></a>
</span><span id="ColorClouds-253"><a href="#ColorClouds-253"><span class="linenos"> 253</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="ColorClouds-254"><a href="#ColorClouds-254"><span class="linenos"> 254</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data into memory...&quot;</span><span class="p">)</span>
</span><span id="ColorClouds-255"><a href="#ColorClouds-255"><span class="linenos"> 255</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">preload_numpy</span><span class="p">()</span>
</span><span id="ColorClouds-256"><a href="#ColorClouds-256"><span class="linenos"> 256</span></a>
</span><span id="ColorClouds-257"><a href="#ColorClouds-257"><span class="linenos"> 257</span></a>            <span class="k">if</span> <span class="n">which_stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-258"><a href="#ColorClouds-258"><span class="linenos"> 258</span></a>                <span class="c1">#assert num_lags is not None, &quot;Need to specify num_lags and other stim params&quot;</span>
</span><span id="ColorClouds-259"><a href="#ColorClouds-259"><span class="linenos"> 259</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">assemble_stimulus</span><span class="p">(</span> <span class="n">which_stim</span><span class="o">=</span><span class="n">which_stim</span><span class="p">,</span> 
</span><span id="ColorClouds-260"><a href="#ColorClouds-260"><span class="linenos"> 260</span></a>                    <span class="n">time_embed</span><span class="o">=</span><span class="n">time_embed</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">num_lags</span><span class="p">,</span> <span class="n">stim_crop</span><span class="o">=</span><span class="n">stim_crop</span> <span class="p">)</span>
</span><span id="ColorClouds-261"><a href="#ColorClouds-261"><span class="linenos"> 261</span></a>
</span><span id="ColorClouds-262"><a href="#ColorClouds-262"><span class="linenos"> 262</span></a>            <span class="c1"># Have data_filters represend used_inds (in case it gets through)</span>
</span><span id="ColorClouds-263"><a href="#ColorClouds-263"><span class="linenos"> 263</span></a>            <span class="n">unified_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-264"><a href="#ColorClouds-264"><span class="linenos"> 264</span></a>            <span class="n">unified_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="ColorClouds-265"><a href="#ColorClouds-265"><span class="linenos"> 265</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*=</span> <span class="n">unified_df</span>
</span><span id="ColorClouds-266"><a href="#ColorClouds-266"><span class="linenos"> 266</span></a>
</span><span id="ColorClouds-267"><a href="#ColorClouds-267"><span class="linenos"> 267</span></a>        <span class="c1">### Process experiment to include relevant eye config</span>
</span><span id="ColorClouds-268"><a href="#ColorClouds-268"><span class="linenos"> 268</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># then want to return experiment part consistent with eye config</span>
</span><span id="ColorClouds-269"><a href="#ColorClouds-269"><span class="linenos"> 269</span></a>            <span class="n">eye_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LRpresent</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-270"><a href="#ColorClouds-270"><span class="linenos"> 270</span></a>            <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">eye_val</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">eye_val</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
</span><span id="ColorClouds-271"><a href="#ColorClouds-271"><span class="linenos"> 271</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eye_val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">):</span>
</span><span id="ColorClouds-272"><a href="#ColorClouds-272"><span class="linenos"> 272</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;EYE CONFIG WARNING: non-contiguous blocks of correct eye position&quot;</span> <span class="p">)</span>
</span><span id="ColorClouds-273"><a href="#ColorClouds-273"><span class="linenos"> 273</span></a>                <span class="n">t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">eye_val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
</span><span id="ColorClouds-274"><a href="#ColorClouds-274"><span class="linenos"> 274</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Taking first contiguous block up to </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">t1</span><span class="p">)</span>
</span><span id="ColorClouds-275"><a href="#ColorClouds-275"><span class="linenos"> 275</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-276"><a href="#ColorClouds-276"><span class="linenos"> 276</span></a>            <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span><span id="ColorClouds-277"><a href="#ColorClouds-277"><span class="linenos"> 277</span></a>
</span><span id="ColorClouds-278"><a href="#ColorClouds-278"><span class="linenos"> 278</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">=</span> <span class="n">t0</span>
</span><span id="ColorClouds-279"><a href="#ColorClouds-279"><span class="linenos"> 279</span></a>        <span class="k">if</span> <span class="n">maxT</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-280"><a href="#ColorClouds-280"><span class="linenos"> 280</span></a>            <span class="n">t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span> <span class="n">t0</span><span class="o">+</span><span class="n">maxT</span><span class="p">,</span> <span class="n">t1</span> <span class="p">)</span>
</span><span id="ColorClouds-281"><a href="#ColorClouds-281"><span class="linenos"> 281</span></a>        <span class="n">ts</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
</span><span id="ColorClouds-282"><a href="#ColorClouds-282"><span class="linenos"> 282</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;T-range:&#39;</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
</span><span id="ColorClouds-283"><a href="#ColorClouds-283"><span class="linenos"> 283</span></a>
</span><span id="ColorClouds-284"><a href="#ColorClouds-284"><span class="linenos"> 284</span></a>        <span class="c1"># Save for potential future adjustments of signal</span>
</span><span id="ColorClouds-285"><a href="#ColorClouds-285"><span class="linenos"> 285</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">startT</span> <span class="o">=</span> <span class="n">t0</span>
</span><span id="ColorClouds-286"><a href="#ColorClouds-286"><span class="linenos"> 286</span></a>        
</span><span id="ColorClouds-287"><a href="#ColorClouds-287"><span class="linenos"> 287</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="ColorClouds-288"><a href="#ColorClouds-288"><span class="linenos"> 288</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Trimming experiment </span><span class="si">%d</span><span class="s2">-&gt;</span><span class="si">%d</span><span class="s2"> time points based on eye_config and Tmax&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span> <span class="p">)</span>
</span><span id="ColorClouds-289"><a href="#ColorClouds-289"><span class="linenos"> 289</span></a>
</span><span id="ColorClouds-290"><a href="#ColorClouds-290"><span class="linenos"> 290</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds-291"><a href="#ColorClouds-291"><span class="linenos"> 291</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-292"><a href="#ColorClouds-292"><span class="linenos"> 292</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds-293"><a href="#ColorClouds-293"><span class="linenos"> 293</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds-294"><a href="#ColorClouds-294"><span class="linenos"> 294</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds-295"><a href="#ColorClouds-295"><span class="linenos"> 295</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span>
</span><span id="ColorClouds-296"><a href="#ColorClouds-296"><span class="linenos"> 296</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds-297"><a href="#ColorClouds-297"><span class="linenos"> 297</span></a>
</span><span id="ColorClouds-298"><a href="#ColorClouds-298"><span class="linenos"> 298</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
</span><span id="ColorClouds-299"><a href="#ColorClouds-299"><span class="linenos"> 299</span></a>
</span><span id="ColorClouds-300"><a href="#ColorClouds-300"><span class="linenos"> 300</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">&gt;=</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">&lt;</span> <span class="n">t1</span><span class="p">)]</span> <span class="o">-</span> <span class="n">t0</span>
</span><span id="ColorClouds-301"><a href="#ColorClouds-301"><span class="linenos"> 301</span></a>
</span><span id="ColorClouds-302"><a href="#ColorClouds-302"><span class="linenos"> 302</span></a>            <span class="c1"># Only keep valid blocks/saccades</span>
</span><span id="ColorClouds-303"><a href="#ColorClouds-303"><span class="linenos"> 303</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">blk_inds</span> <span class="o">-</span> <span class="n">t0</span> 
</span><span id="ColorClouds-304"><a href="#ColorClouds-304"><span class="linenos"> 304</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">blk_inds</span><span class="p">[</span> <span class="n">blk_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds-305"><a href="#ColorClouds-305"><span class="linenos"> 305</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">blk_inds</span><span class="p">[</span> <span class="n">blk_inds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds-306"><a href="#ColorClouds-306"><span class="linenos"> 306</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-307"><a href="#ColorClouds-307"><span class="linenos"> 307</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">-</span> <span class="n">t0</span>
</span><span id="ColorClouds-308"><a href="#ColorClouds-308"><span class="linenos"> 308</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>  
</span><span id="ColorClouds-309"><a href="#ColorClouds-309"><span class="linenos"> 309</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span> <span class="n">sacc_inds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="p">:]</span>  
</span><span id="ColorClouds-310"><a href="#ColorClouds-310"><span class="linenos"> 310</span></a>
</span><span id="ColorClouds-311"><a href="#ColorClouds-311"><span class="linenos"> 311</span></a>        <span class="c1">### Process blocks and fixations/saccades</span>
</span><span id="ColorClouds-312"><a href="#ColorClouds-312"><span class="linenos"> 312</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="ColorClouds-313"><a href="#ColorClouds-313"><span class="linenos"> 313</span></a>            <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="ColorClouds-314"><a href="#ColorClouds-314"><span class="linenos"> 314</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="p">)</span>
</span><span id="ColorClouds-315"><a href="#ColorClouds-315"><span class="linenos"> 315</span></a>        <span class="c1"># go to end of time range if extends beyond block range</span>
</span><span id="ColorClouds-316"><a href="#ColorClouds-316"><span class="linenos"> 316</span></a>        <span class="k">if</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="ColorClouds-317"><a href="#ColorClouds-317"><span class="linenos"> 317</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extending final block at &#39;</span><span class="p">,</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="ColorClouds-318"><a href="#ColorClouds-318"><span class="linenos"> 318</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">))</span>
</span><span id="ColorClouds-319"><a href="#ColorClouds-319"><span class="linenos"> 319</span></a>            <span class="c1"># This is to fix zeroing of last block in fix_n.... (I think?)</span>
</span><span id="ColorClouds-320"><a href="#ColorClouds-320"><span class="linenos"> 320</span></a>
</span><span id="ColorClouds-321"><a href="#ColorClouds-321"><span class="linenos"> 321</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-322"><a href="#ColorClouds-322"><span class="linenos"> 322</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">process_fixations</span><span class="p">()</span>
</span><span id="ColorClouds-323"><a href="#ColorClouds-323"><span class="linenos"> 323</span></a>
</span><span id="ColorClouds-324"><a href="#ColorClouds-324"><span class="linenos"> 324</span></a>        <span class="c1">### Construct drift term if relevant</span>
</span><span id="ColorClouds-325"><a href="#ColorClouds-325"><span class="linenos"> 325</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-326"><a href="#ColorClouds-326"><span class="linenos"> 326</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ColorClouds-327"><a href="#ColorClouds-327"><span class="linenos"> 327</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-328"><a href="#ColorClouds-328"><span class="linenos"> 328</span></a>            <span class="n">NBL</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="ColorClouds-329"><a href="#ColorClouds-329"><span class="linenos"> 329</span></a>            <span class="n">Nanchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">NBL</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="ColorClouds-330"><a href="#ColorClouds-330"><span class="linenos"> 330</span></a>            <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="ColorClouds-331"><a href="#ColorClouds-331"><span class="linenos"> 331</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">):</span>
</span><span id="ColorClouds-332"><a href="#ColorClouds-332"><span class="linenos"> 332</span></a>                <span class="n">anchors</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span><span class="o">*</span><span class="n">bb</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-333"><a href="#ColorClouds-333"><span class="linenos"> 333</span></a>            <span class="c1">#self.Xdrift = utils.design_matrix_drift( self.NT, anchors, zero_left=False, const_right=True)</span>
</span><span id="ColorClouds-334"><a href="#ColorClouds-334"><span class="linenos"> 334</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="ColorClouds-335"><a href="#ColorClouds-335"><span class="linenos"> 335</span></a>
</span><span id="ColorClouds-336"><a href="#ColorClouds-336"><span class="linenos"> 336</span></a>        <span class="c1"># Write all relevant data (other than stim) to pytorch tensors after organized</span>
</span><span id="ColorClouds-337"><a href="#ColorClouds-337"><span class="linenos"> 337</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="p">)</span>
</span><span id="ColorClouds-338"><a href="#ColorClouds-338"><span class="linenos"> 338</span></a>
</span><span id="ColorClouds-339"><a href="#ColorClouds-339"><span class="linenos"> 339</span></a>        <span class="c1"># Cross-validation setup</span>
</span><span id="ColorClouds-340"><a href="#ColorClouds-340"><span class="linenos"> 340</span></a>        <span class="c1"># Develop default train, validation, and test datasets </span>
</span><span id="ColorClouds-341"><a href="#ColorClouds-341"><span class="linenos"> 341</span></a>        <span class="c1">#self.crossval_setup()</span>
</span><span id="ColorClouds-342"><a href="#ColorClouds-342"><span class="linenos"> 342</span></a>        <span class="c1">### SHOULD MAKE THIS INTO A FUNCTION THAT CAN BE RE-APPLIEd</span>
</span><span id="ColorClouds-343"><a href="#ColorClouds-343"><span class="linenos"> 343</span></a>        <span class="n">vblks</span><span class="p">,</span> <span class="n">trblks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="ColorClouds-344"><a href="#ColorClouds-344"><span class="linenos"> 344</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ColorClouds-345"><a href="#ColorClouds-345"><span class="linenos"> 345</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">trblks</span><span class="p">:</span>
</span><span id="ColorClouds-346"><a href="#ColorClouds-346"><span class="linenos"> 346</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="ColorClouds-347"><a href="#ColorClouds-347"><span class="linenos"> 347</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ColorClouds-348"><a href="#ColorClouds-348"><span class="linenos"> 348</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">vblks</span><span class="p">:</span>
</span><span id="ColorClouds-349"><a href="#ColorClouds-349"><span class="linenos"> 349</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="ColorClouds-350"><a href="#ColorClouds-350"><span class="linenos"> 350</span></a>
</span><span id="ColorClouds-351"><a href="#ColorClouds-351"><span class="linenos"> 351</span></a>        <span class="c1"># Eliminate from time point any times when the datafilers are all zero</span>
</span><span id="ColorClouds-352"><a href="#ColorClouds-352"><span class="linenos"> 352</span></a>        <span class="c1"># this will include all places where used-inds is zero as well</span>
</span><span id="ColorClouds-353"><a href="#ColorClouds-353"><span class="linenos"> 353</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="ColorClouds-354"><a href="#ColorClouds-354"><span class="linenos"> 354</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="ColorClouds-355"><a href="#ColorClouds-355"><span class="linenos"> 355</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">trblks</span>
</span><span id="ColorClouds-356"><a href="#ColorClouds-356"><span class="linenos"> 356</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">vblks</span>
</span><span id="ColorClouds-357"><a href="#ColorClouds-357"><span class="linenos"> 357</span></a>    <span class="c1"># END ColorClouds.__init__</span>
</span><span id="ColorClouds-358"><a href="#ColorClouds-358"><span class="linenos"> 358</span></a>
</span><span id="ColorClouds-359"><a href="#ColorClouds-359"><span class="linenos"> 359</span></a>    <span class="k">def</span> <span class="nf">preload_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ColorClouds-360"><a href="#ColorClouds-360"><span class="linenos"> 360</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds-361"><a href="#ColorClouds-361"><span class="linenos"> 361</span></a><span class="sd">        Note this loads stimulus but does not time-embed</span>
</span><span id="ColorClouds-362"><a href="#ColorClouds-362"><span class="linenos"> 362</span></a><span class="sd">        </span>
</span><span id="ColorClouds-363"><a href="#ColorClouds-363"><span class="linenos"> 363</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds-364"><a href="#ColorClouds-364"><span class="linenos"> 364</span></a><span class="sd">            None</span>
</span><span id="ColorClouds-365"><a href="#ColorClouds-365"><span class="linenos"> 365</span></a>
</span><span id="ColorClouds-366"><a href="#ColorClouds-366"><span class="linenos"> 366</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds-367"><a href="#ColorClouds-367"><span class="linenos"> 367</span></a><span class="sd">            None</span>
</span><span id="ColorClouds-368"><a href="#ColorClouds-368"><span class="linenos"> 368</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds-369"><a href="#ColorClouds-369"><span class="linenos"> 369</span></a>
</span><span id="ColorClouds-370"><a href="#ColorClouds-370"><span class="linenos"> 370</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span><span id="ColorClouds-371"><a href="#ColorClouds-371"><span class="linenos"> 371</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="ColorClouds-372"><a href="#ColorClouds-372"><span class="linenos"> 372</span></a><span class="sd">        Pre-allocate memory for data</span>
</span><span id="ColorClouds-373"><a href="#ColorClouds-373"><span class="linenos"> 373</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ColorClouds-374"><a href="#ColorClouds-374"><span class="linenos"> 374</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-375"><a href="#ColorClouds-375"><span class="linenos"> 375</span></a>        <span class="k">if</span> <span class="s1">&#39;stimET&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="ColorClouds-376"><a href="#ColorClouds-376"><span class="linenos"> 376</span></a>            <span class="c1"># Check to see if 1-d or 2-d eye tracking</span>
</span><span id="ColorClouds-377"><a href="#ColorClouds-377"><span class="linenos"> 377</span></a>            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:</span><span class="mi">100</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds-378"><a href="#ColorClouds-378"><span class="linenos"> 378</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="ColorClouds-379"><a href="#ColorClouds-379"><span class="linenos"> 379</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ET stimulus is 1-d bars.&quot;</span><span class="p">)</span>
</span><span id="ColorClouds-380"><a href="#ColorClouds-380"><span class="linenos"> 380</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-381"><a href="#ColorClouds-381"><span class="linenos"> 381</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-382"><a href="#ColorClouds-382"><span class="linenos"> 382</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-383"><a href="#ColorClouds-383"><span class="linenos"> 383</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-384"><a href="#ColorClouds-384"><span class="linenos"> 384</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ColorClouds-385"><a href="#ColorClouds-385"><span class="linenos"> 385</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Missing ETstimulus&#39;</span><span class="p">)</span>
</span><span id="ColorClouds-386"><a href="#ColorClouds-386"><span class="linenos"> 386</span></a>
</span><span id="ColorClouds-387"><a href="#ColorClouds-387"><span class="linenos"> 387</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-388"><a href="#ColorClouds-388"><span class="linenos"> 388</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-389"><a href="#ColorClouds-389"><span class="linenos"> 389</span></a>        <span class="c1">#self.eyepos = np.zeros([NT, 2], dtype=np.float32)</span>
</span><span id="ColorClouds-390"><a href="#ColorClouds-390"><span class="linenos"> 390</span></a>        <span class="c1">#self.frame_times = np.zeros([NT,1], dtype=np.float32)</span>
</span><span id="ColorClouds-391"><a href="#ColorClouds-391"><span class="linenos"> 391</span></a>
</span><span id="ColorClouds-392"><a href="#ColorClouds-392"><span class="linenos"> 392</span></a>        <span class="n">t_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds-393"><a href="#ColorClouds-393"><span class="linenos"> 393</span></a>        <span class="n">unit_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds-394"><a href="#ColorClouds-394"><span class="linenos"> 394</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">)):</span>
</span><span id="ColorClouds-395"><a href="#ColorClouds-395"><span class="linenos"> 395</span></a>            
</span><span id="ColorClouds-396"><a href="#ColorClouds-396"><span class="linenos"> 396</span></a>            <span class="n">fhandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="ColorClouds-397"><a href="#ColorClouds-397"><span class="linenos"> 397</span></a>            <span class="n">sz</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="ColorClouds-398"><a href="#ColorClouds-398"><span class="linenos"> 398</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_counter</span><span class="p">,</span> <span class="n">t_counter</span><span class="o">+</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="ColorClouds-399"><a href="#ColorClouds-399"><span class="linenos"> 399</span></a>            <span class="c1">#inds = self.stim_indices[expt][stim][&#39;inds&#39;]</span>
</span><span id="ColorClouds-400"><a href="#ColorClouds-400"><span class="linenos"> 400</span></a>            <span class="c1">#self.stim[inds, ...] = np.transpose( np.array(fhandle[self.stimname], dtype=np.float32), axes=[0,3,1,2])</span>
</span><span id="ColorClouds-401"><a href="#ColorClouds-401"><span class="linenos"> 401</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="ColorClouds-402"><a href="#ColorClouds-402"><span class="linenos"> 402</span></a>                <span class="n">Leye</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="ColorClouds-403"><a href="#ColorClouds-403"><span class="linenos"> 403</span></a>                <span class="n">Reye</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds-404"><a href="#ColorClouds-404"><span class="linenos"> 404</span></a>                <span class="c1">#Leye = inds[np.where(self.LRpresent[inds] != 2)[0]]</span>
</span><span id="ColorClouds-405"><a href="#ColorClouds-405"><span class="linenos"> 405</span></a>                <span class="c1">#Reye = inds[np.where(self.LRpresent[inds] != 1)[0]]</span>
</span><span id="ColorClouds-406"><a href="#ColorClouds-406"><span class="linenos"> 406</span></a>                <span class="c1">#print(len(Leye), len(Reye))</span>
</span><span id="ColorClouds-407"><a href="#ColorClouds-407"><span class="linenos"> 407</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="ColorClouds-408"><a href="#ColorClouds-408"><span class="linenos"> 408</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds-409"><a href="#ColorClouds-409"><span class="linenos"> 409</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds-410"><a href="#ColorClouds-410"><span class="linenos"> 410</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-411"><a href="#ColorClouds-411"><span class="linenos"> 411</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds-412"><a href="#ColorClouds-412"><span class="linenos"> 412</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds-413"><a href="#ColorClouds-413"><span class="linenos"> 413</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-414"><a href="#ColorClouds-414"><span class="linenos"> 414</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="ColorClouds-415"><a href="#ColorClouds-415"><span class="linenos"> 415</span></a>                    <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds-416"><a href="#ColorClouds-416"><span class="linenos"> 416</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="ColorClouds-417"><a href="#ColorClouds-417"><span class="linenos"> 417</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="ColorClouds-418"><a href="#ColorClouds-418"><span class="linenos"> 418</span></a>                    <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds-419"><a href="#ColorClouds-419"><span class="linenos"> 419</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="ColorClouds-420"><a href="#ColorClouds-420"><span class="linenos"> 420</span></a>
</span><span id="ColorClouds-421"><a href="#ColorClouds-421"><span class="linenos"> 421</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-422"><a href="#ColorClouds-422"><span class="linenos"> 422</span></a>                        <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="ColorClouds-423"><a href="#ColorClouds-423"><span class="linenos"> 423</span></a>                        <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds-424"><a href="#ColorClouds-424"><span class="linenos"> 424</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="ColorClouds-425"><a href="#ColorClouds-425"><span class="linenos"> 425</span></a>                        <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="ColorClouds-426"><a href="#ColorClouds-426"><span class="linenos"> 426</span></a>                        <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds-427"><a href="#ColorClouds-427"><span class="linenos"> 427</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="ColorClouds-428"><a href="#ColorClouds-428"><span class="linenos"> 428</span></a>                        <span class="c1">#self.stimET[Leye, np.arange(3), ...] = np.array(fhandle[&#39;stimET&#39;], dtype=np.float32)[Leye, ...]</span>
</span><span id="ColorClouds-429"><a href="#ColorClouds-429"><span class="linenos"> 429</span></a>                        <span class="c1">#self.stimET[Reye, np.arange(3,6), ...] = np.array(fhandle[&#39;stimET&#39;], dtype=np.float32)[Reye, ...]</span>
</span><span id="ColorClouds-430"><a href="#ColorClouds-430"><span class="linenos"> 430</span></a>                        
</span><span id="ColorClouds-431"><a href="#ColorClouds-431"><span class="linenos"> 431</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Monocular</span>
</span><span id="ColorClouds-432"><a href="#ColorClouds-432"><span class="linenos"> 432</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="ColorClouds-433"><a href="#ColorClouds-433"><span class="linenos"> 433</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds-434"><a href="#ColorClouds-434"><span class="linenos"> 434</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-435"><a href="#ColorClouds-435"><span class="linenos"> 435</span></a>                        <span class="c1">#print(np.array(fhandle[&#39;stimET&#39;], dtype=np.float32).shape, self.stimET[inds, 0, ...].shape)</span>
</span><span id="ColorClouds-436"><a href="#ColorClouds-436"><span class="linenos"> 436</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds-437"><a href="#ColorClouds-437"><span class="linenos"> 437</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-438"><a href="#ColorClouds-438"><span class="linenos"> 438</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-439"><a href="#ColorClouds-439"><span class="linenos"> 439</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-440"><a href="#ColorClouds-440"><span class="linenos"> 440</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-441"><a href="#ColorClouds-441"><span class="linenos"> 441</span></a>
</span><span id="ColorClouds-442"><a href="#ColorClouds-442"><span class="linenos"> 442</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Robs and DATAFILTERS&quot;&quot;&quot;</span>
</span><span id="ColorClouds-443"><a href="#ColorClouds-443"><span class="linenos"> 443</span></a>            <span class="n">robs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="ColorClouds-444"><a href="#ColorClouds-444"><span class="linenos"> 444</span></a>            <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="ColorClouds-445"><a href="#ColorClouds-445"><span class="linenos"> 445</span></a>            <span class="n">num_sus</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds-446"><a href="#ColorClouds-446"><span class="linenos"> 446</span></a>            <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="p">)</span>
</span><span id="ColorClouds-447"><a href="#ColorClouds-447"><span class="linenos"> 447</span></a>            <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-448"><a href="#ColorClouds-448"><span class="linenos"> 448</span></a>            <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;datafilts&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-449"><a href="#ColorClouds-449"><span class="linenos"> 449</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="ColorClouds-450"><a href="#ColorClouds-450"><span class="linenos"> 450</span></a>                <span class="n">num_mus</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds-451"><a href="#ColorClouds-451"><span class="linenos"> 451</span></a>                <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="o">+</span><span class="n">num_mus</span><span class="p">)</span>
</span><span id="ColorClouds-452"><a href="#ColorClouds-452"><span class="linenos"> 452</span></a>                <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-453"><a href="#ColorClouds-453"><span class="linenos"> 453</span></a>                <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;datafiltsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-454"><a href="#ColorClouds-454"><span class="linenos"> 454</span></a>            
</span><span id="ColorClouds-455"><a href="#ColorClouds-455"><span class="linenos"> 455</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">robs_tmp</span><span class="p">)</span>
</span><span id="ColorClouds-456"><a href="#ColorClouds-456"><span class="linenos"> 456</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dfs_tmp</span><span class="p">)</span>
</span><span id="ColorClouds-457"><a href="#ColorClouds-457"><span class="linenos"> 457</span></a>
</span><span id="ColorClouds-458"><a href="#ColorClouds-458"><span class="linenos"> 458</span></a>            <span class="n">t_counter</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-459"><a href="#ColorClouds-459"><span class="linenos"> 459</span></a>            <span class="n">unit_counter</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="ColorClouds-460"><a href="#ColorClouds-460"><span class="linenos"> 460</span></a>
</span><span id="ColorClouds-461"><a href="#ColorClouds-461"><span class="linenos"> 461</span></a>        <span class="c1"># Adjust stimulus since stored as ints</span>
</span><span id="ColorClouds-462"><a href="#ColorClouds-462"><span class="linenos"> 462</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span> 
</span><span id="ColorClouds-463"><a href="#ColorClouds-463"><span class="linenos"> 463</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
</span><span id="ColorClouds-464"><a href="#ColorClouds-464"><span class="linenos"> 464</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">127</span>
</span><span id="ColorClouds-465"><a href="#ColorClouds-465"><span class="linenos"> 465</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-466"><a href="#ColorClouds-466"><span class="linenos"> 466</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">127</span>
</span><span id="ColorClouds-467"><a href="#ColorClouds-467"><span class="linenos"> 467</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">128</span>
</span><span id="ColorClouds-468"><a href="#ColorClouds-468"><span class="linenos"> 468</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-469"><a href="#ColorClouds-469"><span class="linenos"> 469</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">128</span>
</span><span id="ColorClouds-470"><a href="#ColorClouds-470"><span class="linenos"> 470</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Adjusting stimulus read from disk: mean | std = </span><span class="si">%0.3f</span><span class="s2"> | </span><span class="si">%0.3f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">)))</span>
</span><span id="ColorClouds-471"><a href="#ColorClouds-471"><span class="linenos"> 471</span></a>    <span class="c1"># END .preload_numpy()</span>
</span><span id="ColorClouds-472"><a href="#ColorClouds-472"><span class="linenos"> 472</span></a>
</span><span id="ColorClouds-473"><a href="#ColorClouds-473"><span class="linenos"> 473</span></a>    <span class="k">def</span> <span class="nf">is_fixpoint_present</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">boxlim</span> <span class="p">):</span>
</span><span id="ColorClouds-474"><a href="#ColorClouds-474"><span class="linenos"> 474</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return if any of fixation point is within the box given by top-left to bottom-right corner&quot;&quot;&quot;</span>
</span><span id="ColorClouds-475"><a href="#ColorClouds-475"><span class="linenos"> 475</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-476"><a href="#ColorClouds-476"><span class="linenos"> 476</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="ColorClouds-477"><a href="#ColorClouds-477"><span class="linenos"> 477</span></a>        <span class="n">fix_present</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ColorClouds-478"><a href="#ColorClouds-478"><span class="linenos"> 478</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ColorClouds-479"><a href="#ColorClouds-479"><span class="linenos"> 479</span></a>            <span class="c1"># if there is multiple windows, needs to be manual: so this is the automatic check:</span>
</span><span id="ColorClouds-480"><a href="#ColorClouds-480"><span class="linenos"> 480</span></a>            <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="ColorClouds-481"><a href="#ColorClouds-481"><span class="linenos"> 481</span></a>                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">-</span><span class="n">boxlim</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_size</span><span class="p">):</span>
</span><span id="ColorClouds-482"><a href="#ColorClouds-482"><span class="linenos"> 482</span></a>                    <span class="n">fix_present</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ColorClouds-483"><a href="#ColorClouds-483"><span class="linenos"> 483</span></a>                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">-</span><span class="n">boxlim</span><span class="p">[</span><span class="n">dd</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_size</span><span class="p">):</span>
</span><span id="ColorClouds-484"><a href="#ColorClouds-484"><span class="linenos"> 484</span></a>                    <span class="n">fix_present</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ColorClouds-485"><a href="#ColorClouds-485"><span class="linenos"> 485</span></a>        <span class="k">return</span> <span class="n">fix_present</span>
</span><span id="ColorClouds-486"><a href="#ColorClouds-486"><span class="linenos"> 486</span></a>    <span class="c1"># END .is_fixpoint_present</span>
</span><span id="ColorClouds-487"><a href="#ColorClouds-487"><span class="linenos"> 487</span></a>
</span><span id="ColorClouds-488"><a href="#ColorClouds-488"><span class="linenos"> 488</span></a>    <span class="k">def</span> <span class="nf">assemble_stimulus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="ColorClouds-489"><a href="#ColorClouds-489"><span class="linenos"> 489</span></a>        <span class="n">which_stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stim_wrap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># conventional stim: ET=0, lam=1,</span>
</span><span id="ColorClouds-490"><a href="#ColorClouds-490"><span class="linenos"> 490</span></a>        <span class="n">top_corner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># position of stim</span>
</span><span id="ColorClouds-491"><a href="#ColorClouds-491"><span class="linenos"> 491</span></a>        <span class="n">time_embed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="ColorClouds-492"><a href="#ColorClouds-492"><span class="linenos"> 492</span></a>        <span class="n">luminance_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ColorClouds-493"><a href="#ColorClouds-493"><span class="linenos"> 493</span></a>        <span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">BUF</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="c1"># shift buffer</span>
</span><span id="ColorClouds-494"><a href="#ColorClouds-494"><span class="linenos"> 494</span></a>        <span class="n">shift_times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># So that can put partial-shifts over time range in stimulus</span>
</span><span id="ColorClouds-495"><a href="#ColorClouds-495"><span class="linenos"> 495</span></a>        <span class="n">LMS</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># if false, translate to cone-isolating stimulus </span>
</span><span id="ColorClouds-496"><a href="#ColorClouds-496"><span class="linenos"> 496</span></a>        <span class="n">fixdot</span><span class="o">=</span><span class="mi">0</span> <span class="p">):</span>
</span><span id="ColorClouds-497"><a href="#ColorClouds-497"><span class="linenos"> 497</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds-498"><a href="#ColorClouds-498"><span class="linenos"> 498</span></a><span class="sd">        This assembles a stimulus from the raw numpy-stored stimuli into self.stim</span>
</span><span id="ColorClouds-499"><a href="#ColorClouds-499"><span class="linenos"> 499</span></a><span class="sd">        which_stim: determines what stimulus is assembled from &#39;ET&#39;=0, &#39;lam&#39;=1, None</span>
</span><span id="ColorClouds-500"><a href="#ColorClouds-500"><span class="linenos"> 500</span></a><span class="sd">            If none, will need top_corner present: can specify with four numbers (top-left, bot-right)</span>
</span><span id="ColorClouds-501"><a href="#ColorClouds-501"><span class="linenos"> 501</span></a><span class="sd">            or just top_corner and L</span>
</span><span id="ColorClouds-502"><a href="#ColorClouds-502"><span class="linenos"> 502</span></a><span class="sd">        which is torch.tensor on default device</span>
</span><span id="ColorClouds-503"><a href="#ColorClouds-503"><span class="linenos"> 503</span></a><span class="sd">        stim_wrap: only works if using &#39;which_stim&#39;, and will be [hwrap, vwrap]</span>
</span><span id="ColorClouds-504"><a href="#ColorClouds-504"><span class="linenos"> 504</span></a><span class="sd">        </span>
</span><span id="ColorClouds-505"><a href="#ColorClouds-505"><span class="linenos"> 505</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds-506"><a href="#ColorClouds-506"><span class="linenos"> 506</span></a><span class="sd">            which_stim (int): 0 for ET, 1 for laminar probe, None for assembly from top_corner</span>
</span><span id="ColorClouds-507"><a href="#ColorClouds-507"><span class="linenos"> 507</span></a><span class="sd">            stim_wrap (list): [hwrap, vwrap] for wrapping stimulus</span>
</span><span id="ColorClouds-508"><a href="#ColorClouds-508"><span class="linenos"> 508</span></a><span class="sd">            stim_crop (list): [x1, x2, y1, y2] for cropping stimulus</span>
</span><span id="ColorClouds-509"><a href="#ColorClouds-509"><span class="linenos"> 509</span></a><span class="sd">            top_corner (list): [x1, y1] for top corner of stimulus</span>
</span><span id="ColorClouds-510"><a href="#ColorClouds-510"><span class="linenos"> 510</span></a><span class="sd">            L (int): length of stimulus</span>
</span><span id="ColorClouds-511"><a href="#ColorClouds-511"><span class="linenos"> 511</span></a><span class="sd">            time_embed (int): number of time lags to embed</span>
</span><span id="ColorClouds-512"><a href="#ColorClouds-512"><span class="linenos"> 512</span></a><span class="sd">            num_lags (int): number of lags to use</span>
</span><span id="ColorClouds-513"><a href="#ColorClouds-513"><span class="linenos"> 513</span></a><span class="sd">            luminance_only (bool): whether to use only luminance channel</span>
</span><span id="ColorClouds-514"><a href="#ColorClouds-514"><span class="linenos"> 514</span></a><span class="sd">            shifts (list): [dx, dy] for shifting stimulus</span>
</span><span id="ColorClouds-515"><a href="#ColorClouds-515"><span class="linenos"> 515</span></a><span class="sd">            BUF (int): buffer for shifting stimulus</span>
</span><span id="ColorClouds-516"><a href="#ColorClouds-516"><span class="linenos"> 516</span></a><span class="sd">            shift_times (list): times to shift stimulus</span>
</span><span id="ColorClouds-517"><a href="#ColorClouds-517"><span class="linenos"> 517</span></a><span class="sd">            LMS (bool): whether to convert to cone-isolating stimulus</span>
</span><span id="ColorClouds-518"><a href="#ColorClouds-518"><span class="linenos"> 518</span></a><span class="sd">            fixdot (int): value for fixation point</span>
</span><span id="ColorClouds-519"><a href="#ColorClouds-519"><span class="linenos"> 519</span></a>
</span><span id="ColorClouds-520"><a href="#ColorClouds-520"><span class="linenos"> 520</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds-521"><a href="#ColorClouds-521"><span class="linenos"> 521</span></a><span class="sd">            None</span>
</span><span id="ColorClouds-522"><a href="#ColorClouds-522"><span class="linenos"> 522</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds-523"><a href="#ColorClouds-523"><span class="linenos"> 523</span></a>
</span><span id="ColorClouds-524"><a href="#ColorClouds-524"><span class="linenos"> 524</span></a>        <span class="c1"># Delete existing stim and clear cache to prevent memory issues on GPU</span>
</span><span id="ColorClouds-525"><a href="#ColorClouds-525"><span class="linenos"> 525</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-526"><a href="#ColorClouds-526"><span class="linenos"> 526</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span>
</span><span id="ColorClouds-527"><a href="#ColorClouds-527"><span class="linenos"> 527</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ColorClouds-528"><a href="#ColorClouds-528"><span class="linenos"> 528</span></a>            <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
</span><span id="ColorClouds-529"><a href="#ColorClouds-529"><span class="linenos"> 529</span></a>        <span class="n">num_clr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-530"><a href="#ColorClouds-530"><span class="linenos"> 530</span></a>        <span class="k">if</span> <span class="n">LMS</span><span class="p">:</span>
</span><span id="ColorClouds-531"><a href="#ColorClouds-531"><span class="linenos"> 531</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">,</span> <span class="s2">&quot;Cannot convert color spaces if luminance-only.&quot;</span>
</span><span id="ColorClouds-532"><a href="#ColorClouds-532"><span class="linenos"> 532</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">LMS</span> <span class="o">=</span> <span class="n">LMS</span>
</span><span id="ColorClouds-533"><a href="#ColorClouds-533"><span class="linenos"> 533</span></a>
</span><span id="ColorClouds-534"><a href="#ColorClouds-534"><span class="linenos"> 534</span></a>        <span class="n">need2crop</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ColorClouds-535"><a href="#ColorClouds-535"><span class="linenos"> 535</span></a>
</span><span id="ColorClouds-536"><a href="#ColorClouds-536"><span class="linenos"> 536</span></a>        <span class="k">if</span> <span class="n">which_stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-537"><a href="#ColorClouds-537"><span class="linenos"> 537</span></a>            <span class="k">assert</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;ASSEMBLE_STIMULUS: cannot specify L if using which_stim (i.e. prepackaged stim)&quot;</span>
</span><span id="ColorClouds-538"><a href="#ColorClouds-538"><span class="linenos"> 538</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds-539"><a href="#ColorClouds-539"><span class="linenos"> 539</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_stim</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="ColorClouds-540"><a href="#ColorClouds-540"><span class="linenos"> 540</span></a>                <span class="k">if</span> <span class="n">which_stim</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ET&#39;</span><span class="p">,</span> <span class="s1">&#39;et&#39;</span><span class="p">,</span> <span class="s1">&#39;stimET&#39;</span><span class="p">]:</span>
</span><span id="ColorClouds-541"><a href="#ColorClouds-541"><span class="linenos"> 541</span></a>                    <span class="n">which_stim</span><span class="o">=</span><span class="mi">0</span>
</span><span id="ColorClouds-542"><a href="#ColorClouds-542"><span class="linenos"> 542</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-543"><a href="#ColorClouds-543"><span class="linenos"> 543</span></a>                    <span class="n">which_stim</span><span class="o">=</span><span class="mi">1</span>
</span><span id="ColorClouds-544"><a href="#ColorClouds-544"><span class="linenos"> 544</span></a>            <span class="k">if</span> <span class="n">which_stim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds-545"><a href="#ColorClouds-545"><span class="linenos"> 545</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stim: using ET stimulus&quot;</span><span class="p">)</span>
</span><span id="ColorClouds-546"><a href="#ColorClouds-546"><span class="linenos"> 546</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="p">)</span>
</span><span id="ColorClouds-547"><a href="#ColorClouds-547"><span class="linenos"> 547</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_locationET</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-548"><a href="#ColorClouds-548"><span class="linenos"> 548</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-549"><a href="#ColorClouds-549"><span class="linenos"> 549</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stim: using laminar probe stimulus&quot;</span><span class="p">)</span>
</span><span id="ColorClouds-550"><a href="#ColorClouds-550"><span class="linenos"> 550</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="p">)</span>
</span><span id="ColorClouds-551"><a href="#ColorClouds-551"><span class="linenos"> 551</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-552"><a href="#ColorClouds-552"><span class="linenos"> 552</span></a>
</span><span id="ColorClouds-553"><a href="#ColorClouds-553"><span class="linenos"> 553</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-554"><a href="#ColorClouds-554"><span class="linenos"> 554</span></a>            <span class="k">assert</span> <span class="n">top_corner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need top corner if which_stim unspecified&quot;</span>
</span><span id="ColorClouds-555"><a href="#ColorClouds-555"><span class="linenos"> 555</span></a>            <span class="c1"># Assemble from combination of ET and laminer probe (NP) stimulus</span>
</span><span id="ColorClouds-556"><a href="#ColorClouds-556"><span class="linenos"> 556</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_corner</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="ColorClouds-557"><a href="#ColorClouds-557"><span class="linenos"> 557</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="o">=</span> <span class="n">top_corner</span>
</span><span id="ColorClouds-558"><a href="#ColorClouds-558"><span class="linenos"> 558</span></a>                <span class="c1">#L = self.stim_pos[2]-self.stim_pos[0]</span>
</span><span id="ColorClouds-559"><a href="#ColorClouds-559"><span class="linenos"> 559</span></a>                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Stim must be square (for now)&quot;</span>
</span><span id="ColorClouds-560"><a href="#ColorClouds-560"><span class="linenos"> 560</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-561"><a href="#ColorClouds-561"><span class="linenos"> 561</span></a>                <span class="k">if</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-562"><a href="#ColorClouds-562"><span class="linenos"> 562</span></a>                    <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds-563"><a href="#ColorClouds-563"><span class="linenos"> 563</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">top_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">top_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">top_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">L</span><span class="p">,</span> <span class="n">top_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">L</span><span class="p">]</span>
</span><span id="ColorClouds-564"><a href="#ColorClouds-564"><span class="linenos"> 564</span></a>            <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-565"><a href="#ColorClouds-565"><span class="linenos"> 565</span></a>                <span class="n">need2crop</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ColorClouds-566"><a href="#ColorClouds-566"><span class="linenos"> 566</span></a>                <span class="c1"># Modify stim window by 20-per-side</span>
</span><span id="ColorClouds-567"><a href="#ColorClouds-567"><span class="linenos"> 567</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ColorClouds-568"><a href="#ColorClouds-568"><span class="linenos"> 568</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span>
</span><span id="ColorClouds-569"><a href="#ColorClouds-569"><span class="linenos"> 569</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span>
</span><span id="ColorClouds-570"><a href="#ColorClouds-570"><span class="linenos"> 570</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">BUF</span><span class="p">,</span>
</span><span id="ColorClouds-571"><a href="#ColorClouds-571"><span class="linenos"> 571</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">BUF</span><span class="p">]</span>
</span><span id="ColorClouds-572"><a href="#ColorClouds-572"><span class="linenos"> 572</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Stim expansion for shift:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">)</span>
</span><span id="ColorClouds-573"><a href="#ColorClouds-573"><span class="linenos"> 573</span></a>
</span><span id="ColorClouds-574"><a href="#ColorClouds-574"><span class="linenos"> 574</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-575"><a href="#ColorClouds-575"><span class="linenos"> 575</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">L</span><span class="p">,</span> <span class="s2">&quot;Stimulus not square&quot;</span>
</span><span id="ColorClouds-576"><a href="#ColorClouds-576"><span class="linenos"> 576</span></a>
</span><span id="ColorClouds-577"><a href="#ColorClouds-577"><span class="linenos"> 577</span></a>            <span class="n">newstim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">num_clr</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="ColorClouds-578"><a href="#ColorClouds-578"><span class="linenos"> 578</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="ColorClouds-579"><a href="#ColorClouds-579"><span class="linenos"> 579</span></a>                <span class="n">OVLP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_overlap_ranges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">])</span>
</span><span id="ColorClouds-580"><a href="#ColorClouds-580"><span class="linenos"> 580</span></a>                <span class="k">if</span> <span class="n">OVLP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-581"><a href="#ColorClouds-581"><span class="linenos"> 581</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Writing lam stim </span><span class="si">%d</span><span class="s2">: overlap </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">])))</span>
</span><span id="ColorClouds-582"><a href="#ColorClouds-582"><span class="linenos"> 582</span></a>                    <span class="n">strip</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:])</span> <span class="c1">#np.zeros([self.NT, num_clr, len(OVLP[&#39;targetX&#39;]), L])</span>
</span><span id="ColorClouds-583"><a href="#ColorClouds-583"><span class="linenos"> 583</span></a>                    <span class="n">strip</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readX&#39;</span><span class="p">],</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readY&#39;</span><span class="p">]]))</span>
</span><span id="ColorClouds-584"><a href="#ColorClouds-584"><span class="linenos"> 584</span></a>                    <span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span>
</span><span id="ColorClouds-585"><a href="#ColorClouds-585"><span class="linenos"> 585</span></a>                
</span><span id="ColorClouds-586"><a href="#ColorClouds-586"><span class="linenos"> 586</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-587"><a href="#ColorClouds-587"><span class="linenos"> 587</span></a>                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_locationET</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="ColorClouds-588"><a href="#ColorClouds-588"><span class="linenos"> 588</span></a>                    <span class="n">OVLP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_overlap_ranges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_locationET</span><span class="p">[:,</span><span class="n">ii</span><span class="p">])</span>
</span><span id="ColorClouds-589"><a href="#ColorClouds-589"><span class="linenos"> 589</span></a>                    <span class="k">if</span> <span class="n">OVLP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-590"><a href="#ColorClouds-590"><span class="linenos"> 590</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Writing ETstim </span><span class="si">%d</span><span class="s2">: overlap </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">])))</span>
</span><span id="ColorClouds-591"><a href="#ColorClouds-591"><span class="linenos"> 591</span></a>                        <span class="n">strip</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:])</span>
</span><span id="ColorClouds-592"><a href="#ColorClouds-592"><span class="linenos"> 592</span></a>                        <span class="n">strip</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readX&#39;</span><span class="p">],</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readY&#39;</span><span class="p">]]))</span>
</span><span id="ColorClouds-593"><a href="#ColorClouds-593"><span class="linenos"> 593</span></a>                        <span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span> 
</span><span id="ColorClouds-594"><a href="#ColorClouds-594"><span class="linenos"> 594</span></a>
</span><span id="ColorClouds-595"><a href="#ColorClouds-595"><span class="linenos"> 595</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">newstim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="p">)</span>
</span><span id="ColorClouds-596"><a href="#ColorClouds-596"><span class="linenos"> 596</span></a>
</span><span id="ColorClouds-597"><a href="#ColorClouds-597"><span class="linenos"> 597</span></a>        <span class="c1">#print(&#39;Stim shape&#39;, self.stim.shape)</span>
</span><span id="ColorClouds-598"><a href="#ColorClouds-598"><span class="linenos"> 598</span></a>        <span class="c1"># Note stim stored in numpy is being represented as full 3-d + 1 tensor (time, channels, NX, NY)</span>
</span><span id="ColorClouds-599"><a href="#ColorClouds-599"><span class="linenos"> 599</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds-600"><a href="#ColorClouds-600"><span class="linenos"> 600</span></a>        <span class="k">if</span> <span class="n">luminance_only</span><span class="p">:</span>
</span><span id="ColorClouds-601"><a href="#ColorClouds-601"><span class="linenos"> 601</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ColorClouds-602"><a href="#ColorClouds-602"><span class="linenos"> 602</span></a>                <span class="c1"># Resample first dimension of stimulus</span>
</span><span id="ColorClouds-603"><a href="#ColorClouds-603"><span class="linenos"> 603</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Shifting to luminance-only&#39;</span><span class="p">)</span>
</span><span id="ColorClouds-604"><a href="#ColorClouds-604"><span class="linenos"> 604</span></a>                <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))</span>
</span><span id="ColorClouds-605"><a href="#ColorClouds-605"><span class="linenos"> 605</span></a>                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span>
</span><span id="ColorClouds-606"><a href="#ColorClouds-606"><span class="linenos"> 606</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
</span><span id="ColorClouds-607"><a href="#ColorClouds-607"><span class="linenos"> 607</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">...</span><span class="p">])</span>
</span><span id="ColorClouds-608"><a href="#ColorClouds-608"><span class="linenos"> 608</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>            
</span><span id="ColorClouds-609"><a href="#ColorClouds-609"><span class="linenos"> 609</span></a>
</span><span id="ColorClouds-610"><a href="#ColorClouds-610"><span class="linenos"> 610</span></a>        <span class="c1"># stim_wrap if &#39;which_stim&#39; chosen</span>
</span><span id="ColorClouds-611"><a href="#ColorClouds-611"><span class="linenos"> 611</span></a>        <span class="k">if</span> <span class="n">stim_wrap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-612"><a href="#ColorClouds-612"><span class="linenos"> 612</span></a>            <span class="k">assert</span> <span class="n">which_stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Should only use stim_wrap on conventional (ET or LAM) stimulus.&quot;</span>
</span><span id="ColorClouds-613"><a href="#ColorClouds-613"><span class="linenos"> 613</span></a>            <span class="n">hwrap</span> <span class="o">=</span> <span class="n">stim_wrap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-614"><a href="#ColorClouds-614"><span class="linenos"> 614</span></a>            <span class="n">vwrap</span> <span class="o">=</span> <span class="n">stim_wrap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds-615"><a href="#ColorClouds-615"><span class="linenos"> 615</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wrap_stim</span><span class="p">(</span> <span class="n">hwrap</span><span class="o">=-</span><span class="n">hwrap</span><span class="p">,</span> <span class="n">vwrap</span><span class="o">=-</span><span class="n">vwrap</span> <span class="p">)</span>
</span><span id="ColorClouds-616"><a href="#ColorClouds-616"><span class="linenos"> 616</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="o">+=</span> <span class="p">[</span><span class="o">-</span><span class="n">hwrap</span><span class="p">,</span> <span class="o">-</span><span class="n">vwrap</span><span class="p">,</span> <span class="o">-</span><span class="n">hwrap</span><span class="p">,</span> <span class="o">-</span><span class="n">vwrap</span><span class="p">]</span>
</span><span id="ColorClouds-617"><a href="#ColorClouds-617"><span class="linenos"> 617</span></a>
</span><span id="ColorClouds-618"><a href="#ColorClouds-618"><span class="linenos"> 618</span></a>        <span class="c1"># Insert fixation point</span>
</span><span id="ColorClouds-619"><a href="#ColorClouds-619"><span class="linenos"> 619</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">fixdot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fixpoint_present</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="p">):</span>
</span><span id="ColorClouds-620"><a href="#ColorClouds-620"><span class="linenos"> 620</span></a>            <span class="n">fixranges</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="ColorClouds-621"><a href="#ColorClouds-621"><span class="linenos"> 621</span></a>            <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="ColorClouds-622"><a href="#ColorClouds-622"><span class="linenos"> 622</span></a>                <span class="n">fixranges</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
</span><span id="ColorClouds-623"><a href="#ColorClouds-623"><span class="linenos"> 623</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_size</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="n">dd</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="ColorClouds-624"><a href="#ColorClouds-624"><span class="linenos"> 624</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="n">dd</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span> 
</span><span id="ColorClouds-625"><a href="#ColorClouds-625"><span class="linenos"> 625</span></a>                    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="ColorClouds-626"><a href="#ColorClouds-626"><span class="linenos"> 626</span></a>            <span class="c1"># Write the correct value to stim</span>
</span><span id="ColorClouds-627"><a href="#ColorClouds-627"><span class="linenos"> 627</span></a>            <span class="c1">#print(fixranges)</span>
</span><span id="ColorClouds-628"><a href="#ColorClouds-628"><span class="linenos"> 628</span></a>            <span class="k">assert</span> <span class="n">fixdot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Haven&#39;t yet put in other fixdot settings than zero&quot;</span> 
</span><span id="ColorClouds-629"><a href="#ColorClouds-629"><span class="linenos"> 629</span></a>            <span class="c1">#strip = deepcopy(self.stim[:, :, fixranges[0], :])</span>
</span><span id="ColorClouds-630"><a href="#ColorClouds-630"><span class="linenos"> 630</span></a>            <span class="c1">#strip[:, :, :, fixranges[1]] = 0</span>
</span><span id="ColorClouds-631"><a href="#ColorClouds-631"><span class="linenos"> 631</span></a>            <span class="c1">#self.stim[:, :, fixranges[0], :] = deepcopy(strip) </span>
</span><span id="ColorClouds-632"><a href="#ColorClouds-632"><span class="linenos"> 632</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Adding fixation point&#39;</span><span class="p">)</span>
</span><span id="ColorClouds-633"><a href="#ColorClouds-633"><span class="linenos"> 633</span></a>            <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">fixranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="ColorClouds-634"><a href="#ColorClouds-634"><span class="linenos"> 634</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">fixranges</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds-635"><a href="#ColorClouds-635"><span class="linenos"> 635</span></a>
</span><span id="ColorClouds-636"><a href="#ColorClouds-636"><span class="linenos"> 636</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_shifts</span> <span class="o">=</span> <span class="n">shifts</span>
</span><span id="ColorClouds-637"><a href="#ColorClouds-637"><span class="linenos"> 637</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-638"><a href="#ColorClouds-638"><span class="linenos"> 638</span></a>            <span class="c1"># Would want to shift by input eye positions if input here</span>
</span><span id="ColorClouds-639"><a href="#ColorClouds-639"><span class="linenos"> 639</span></a>            <span class="c1">#print(&#39;eye-position shifting not implemented yet&#39;)</span>
</span><span id="ColorClouds-640"><a href="#ColorClouds-640"><span class="linenos"> 640</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Shifting stim...&#39;</span><span class="p">)</span>
</span><span id="ColorClouds-641"><a href="#ColorClouds-641"><span class="linenos"> 641</span></a>            <span class="k">if</span> <span class="n">shift_times</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-642"><a href="#ColorClouds-642"><span class="linenos"> 642</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_stim</span><span class="p">(</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">shift_times</span><span class="o">=</span><span class="n">shift_times</span><span class="p">,</span> <span class="n">already_lagged</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
</span><span id="ColorClouds-643"><a href="#ColorClouds-643"><span class="linenos"> 643</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-644"><a href="#ColorClouds-644"><span class="linenos"> 644</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">shift_times</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_stim</span><span class="p">(</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">shift_times</span><span class="o">=</span><span class="n">shift_times</span><span class="p">,</span> <span class="n">already_lagged</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
</span><span id="ColorClouds-645"><a href="#ColorClouds-645"><span class="linenos"> 645</span></a>
</span><span id="ColorClouds-646"><a href="#ColorClouds-646"><span class="linenos"> 646</span></a>        <span class="c1"># Reduce size back to original If expanded to handle shifts</span>
</span><span id="ColorClouds-647"><a href="#ColorClouds-647"><span class="linenos"> 647</span></a>        <span class="k">if</span> <span class="n">need2crop</span><span class="p">:</span>
</span><span id="ColorClouds-648"><a href="#ColorClouds-648"><span class="linenos"> 648</span></a>            <span class="c1">#assert self.stim_crop is None, &quot;Cannot crop stim at same time as shifting&quot;</span>
</span><span id="ColorClouds-649"><a href="#ColorClouds-649"><span class="linenos"> 649</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">crop_stim</span><span class="p">(</span> <span class="p">[</span><span class="n">BUF</span><span class="p">,</span> <span class="n">L</span><span class="o">-</span><span class="n">BUF</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">BUF</span><span class="p">,</span> <span class="n">L</span><span class="o">-</span><span class="n">BUF</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>  <span class="c1"># move back to original size</span>
</span><span id="ColorClouds-650"><a href="#ColorClouds-650"><span class="linenos"> 650</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ColorClouds-651"><a href="#ColorClouds-651"><span class="linenos"> 651</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">L</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">BUF</span>
</span><span id="ColorClouds-652"><a href="#ColorClouds-652"><span class="linenos"> 652</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span>
</span><span id="ColorClouds-653"><a href="#ColorClouds-653"><span class="linenos"> 653</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span>
</span><span id="ColorClouds-654"><a href="#ColorClouds-654"><span class="linenos"> 654</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-655"><a href="#ColorClouds-655"><span class="linenos"> 655</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="o">=</span> <span class="n">stim_crop</span> 
</span><span id="ColorClouds-656"><a href="#ColorClouds-656"><span class="linenos"> 656</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-657"><a href="#ColorClouds-657"><span class="linenos"> 657</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">crop_stim</span><span class="p">()</span>
</span><span id="ColorClouds-658"><a href="#ColorClouds-658"><span class="linenos"> 658</span></a>
</span><span id="ColorClouds-659"><a href="#ColorClouds-659"><span class="linenos"> 659</span></a>        <span class="k">if</span> <span class="n">time_embed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-660"><a href="#ColorClouds-660"><span class="linenos"> 660</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">=</span> <span class="n">time_embed</span>
</span><span id="ColorClouds-661"><a href="#ColorClouds-661"><span class="linenos"> 661</span></a>        <span class="k">if</span> <span class="n">time_embed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds-662"><a href="#ColorClouds-662"><span class="linenos"> 662</span></a>            <span class="c1">#self.stim_dims[3] = num_lags  # this is set by time-embedding</span>
</span><span id="ColorClouds-663"><a href="#ColorClouds-663"><span class="linenos"> 663</span></a>            <span class="k">if</span> <span class="n">time_embed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="ColorClouds-664"><a href="#ColorClouds-664"><span class="linenos"> 664</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embedding</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">,</span> <span class="n">nlags</span> <span class="o">=</span> <span class="n">num_lags</span> <span class="p">)</span>
</span><span id="ColorClouds-665"><a href="#ColorClouds-665"><span class="linenos"> 665</span></a>        <span class="c1"># now stimulus is represented as full 4-d + 1 tensor (time, channels, NX, NY, num_lags)</span>
</span><span id="ColorClouds-666"><a href="#ColorClouds-666"><span class="linenos"> 666</span></a>
</span><span id="ColorClouds-667"><a href="#ColorClouds-667"><span class="linenos"> 667</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span> <span class="o">=</span> <span class="n">num_lags</span>
</span><span id="ColorClouds-668"><a href="#ColorClouds-668"><span class="linenos"> 668</span></a>
</span><span id="ColorClouds-669"><a href="#ColorClouds-669"><span class="linenos"> 669</span></a>        <span class="c1"># Translate to cone-isolating stimmulus if DKL is false</span>
</span><span id="ColorClouds-670"><a href="#ColorClouds-670"><span class="linenos"> 670</span></a>        <span class="k">if</span> <span class="n">LMS</span><span class="p">:</span>
</span><span id="ColorClouds-671"><a href="#ColorClouds-671"><span class="linenos"> 671</span></a>            <span class="c1"># Make cone-isolating stimulus conversion matrix</span>
</span><span id="ColorClouds-672"><a href="#ColorClouds-672"><span class="linenos"> 672</span></a>            <span class="c1">#DKL2CIS = torch.tensor([[0.0401,.522,0], [.0351,-0.4635,0], [0.0145,0,.985]], dtype=torch.float32)</span>
</span><span id="ColorClouds-673"><a href="#ColorClouds-673"><span class="linenos"> 673</span></a>            <span class="c1">#DKL2LMS = torch.tensor([[0.9737, 0.0799, -0.0836], [1.0155, -0.1210, -0.1135], [1.0890, -0.0138, 0.9183]], dtype=torch.float32)</span>
</span><span id="ColorClouds-674"><a href="#ColorClouds-674"><span class="linenos"> 674</span></a>            <span class="n">DKL2LMS</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mf">0.7586</span><span class="p">,</span> <span class="mf">0.6515</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5536</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8328</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.8660</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-675"><a href="#ColorClouds-675"><span class="linenos"> 675</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;  Converting to LMS space&#39;</span><span class="p">)</span>
</span><span id="ColorClouds-676"><a href="#ColorClouds-676"><span class="linenos"> 676</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span> <span class="s1">&#39;axcd,bx-&gt;abcd&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">,</span> <span class="n">DKL2LMS</span><span class="p">)</span>
</span><span id="ColorClouds-677"><a href="#ColorClouds-677"><span class="linenos"> 677</span></a>
</span><span id="ColorClouds-678"><a href="#ColorClouds-678"><span class="linenos"> 678</span></a>        <span class="c1"># Flatten stim </span>
</span><span id="ColorClouds-679"><a href="#ColorClouds-679"><span class="linenos"> 679</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="ColorClouds-680"><a href="#ColorClouds-680"><span class="linenos"> 680</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Done&quot;</span> <span class="p">)</span>
</span><span id="ColorClouds-681"><a href="#ColorClouds-681"><span class="linenos"> 681</span></a>    <span class="c1"># END ColorClouds.assemble_stimulus()</span>
</span><span id="ColorClouds-682"><a href="#ColorClouds-682"><span class="linenos"> 682</span></a>
</span><span id="ColorClouds-683"><a href="#ColorClouds-683"><span class="linenos"> 683</span></a>    <span class="k">def</span> <span class="nf">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="ColorClouds-684"><a href="#ColorClouds-684"><span class="linenos"> 684</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds-685"><a href="#ColorClouds-685"><span class="linenos"> 685</span></a><span class="sd">        Converts all relevant data to torch.tensor on device</span>
</span><span id="ColorClouds-686"><a href="#ColorClouds-686"><span class="linenos"> 686</span></a>
</span><span id="ColorClouds-687"><a href="#ColorClouds-687"><span class="linenos"> 687</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds-688"><a href="#ColorClouds-688"><span class="linenos"> 688</span></a><span class="sd">            device (torch.device): device to move data to</span>
</span><span id="ColorClouds-689"><a href="#ColorClouds-689"><span class="linenos"> 689</span></a>
</span><span id="ColorClouds-690"><a href="#ColorClouds-690"><span class="linenos"> 690</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds-691"><a href="#ColorClouds-691"><span class="linenos"> 691</span></a><span class="sd">            None</span>
</span><span id="ColorClouds-692"><a href="#ColorClouds-692"><span class="linenos"> 692</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds-693"><a href="#ColorClouds-693"><span class="linenos"> 693</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="ColorClouds-694"><a href="#ColorClouds-694"><span class="linenos"> 694</span></a>            <span class="c1"># then already converted: just moving device</span>
</span><span id="ColorClouds-695"><a href="#ColorClouds-695"><span class="linenos"> 695</span></a>            <span class="c1">#self.stim = self.stim.to(device)</span>
</span><span id="ColorClouds-696"><a href="#ColorClouds-696"><span class="linenos"> 696</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds-697"><a href="#ColorClouds-697"><span class="linenos"> 697</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds-698"><a href="#ColorClouds-698"><span class="linenos"> 698</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds-699"><a href="#ColorClouds-699"><span class="linenos"> 699</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-700"><a href="#ColorClouds-700"><span class="linenos"> 700</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds-701"><a href="#ColorClouds-701"><span class="linenos"> 701</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-702"><a href="#ColorClouds-702"><span class="linenos"> 702</span></a>            <span class="c1">#self.stim = torch.tensor(self.stim, dtype=torch.float32, device=device)</span>
</span><span id="ColorClouds-703"><a href="#ColorClouds-703"><span class="linenos"> 703</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds-704"><a href="#ColorClouds-704"><span class="linenos"> 704</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds-705"><a href="#ColorClouds-705"><span class="linenos"> 705</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds-706"><a href="#ColorClouds-706"><span class="linenos"> 706</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-707"><a href="#ColorClouds-707"><span class="linenos"> 707</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds-708"><a href="#ColorClouds-708"><span class="linenos"> 708</span></a>
</span><span id="ColorClouds-709"><a href="#ColorClouds-709"><span class="linenos"> 709</span></a>    <span class="k">def</span> <span class="nf">time_embedding</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="ColorClouds-710"><a href="#ColorClouds-710"><span class="linenos"> 710</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds-711"><a href="#ColorClouds-711"><span class="linenos"> 711</span></a><span class="sd">        Note this overloads SensoryBase because reshapes in full dimensions to handle folded_lags</span>
</span><span id="ColorClouds-712"><a href="#ColorClouds-712"><span class="linenos"> 712</span></a><span class="sd">        </span>
</span><span id="ColorClouds-713"><a href="#ColorClouds-713"><span class="linenos"> 713</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds-714"><a href="#ColorClouds-714"><span class="linenos"> 714</span></a><span class="sd">            stim (torch.tensor): stimulus to time-embed</span>
</span><span id="ColorClouds-715"><a href="#ColorClouds-715"><span class="linenos"> 715</span></a><span class="sd">            nlags (int): number of lags to use</span>
</span><span id="ColorClouds-716"><a href="#ColorClouds-716"><span class="linenos"> 716</span></a>
</span><span id="ColorClouds-717"><a href="#ColorClouds-717"><span class="linenos"> 717</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds-718"><a href="#ColorClouds-718"><span class="linenos"> 718</span></a><span class="sd">            torch.tensor: time-embedded stimulus</span>
</span><span id="ColorClouds-719"><a href="#ColorClouds-719"><span class="linenos"> 719</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds-720"><a href="#ColorClouds-720"><span class="linenos"> 720</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to assemble stim before time-embedding.&quot;</span>
</span><span id="ColorClouds-721"><a href="#ColorClouds-721"><span class="linenos"> 721</span></a>        <span class="k">if</span> <span class="n">nlags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-722"><a href="#ColorClouds-722"><span class="linenos"> 722</span></a>            <span class="n">nlags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="ColorClouds-723"><a href="#ColorClouds-723"><span class="linenos"> 723</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ColorClouds-724"><a href="#ColorClouds-724"><span class="linenos"> 724</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlags</span>
</span><span id="ColorClouds-725"><a href="#ColorClouds-725"><span class="linenos"> 725</span></a>        <span class="k">if</span> <span class="n">stim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-726"><a href="#ColorClouds-726"><span class="linenos"> 726</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span>
</span><span id="ColorClouds-727"><a href="#ColorClouds-727"><span class="linenos"> 727</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-728"><a href="#ColorClouds-728"><span class="linenos"> 728</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="ColorClouds-729"><a href="#ColorClouds-729"><span class="linenos"> 729</span></a>                <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">stim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-730"><a href="#ColorClouds-730"><span class="linenos"> 730</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-731"><a href="#ColorClouds-731"><span class="linenos"> 731</span></a>                <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="ColorClouds-732"><a href="#ColorClouds-732"><span class="linenos"> 732</span></a>        <span class="c1">#if not isinstance(tmp_stim, np.ndarray):</span>
</span><span id="ColorClouds-733"><a href="#ColorClouds-733"><span class="linenos"> 733</span></a>        <span class="c1">#    tmp_stim = tmp_stim.cpu().numpy()</span>
</span><span id="ColorClouds-734"><a href="#ColorClouds-734"><span class="linenos"> 734</span></a>    
</span><span id="ColorClouds-735"><a href="#ColorClouds-735"><span class="linenos"> 735</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-736"><a href="#ColorClouds-736"><span class="linenos"> 736</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Time embedding...&quot;</span><span class="p">)</span>
</span><span id="ColorClouds-737"><a href="#ColorClouds-737"><span class="linenos"> 737</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="ColorClouds-738"><a href="#ColorClouds-738"><span class="linenos"> 738</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Time embed: reshaping stimulus -&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">)</span>
</span><span id="ColorClouds-739"><a href="#ColorClouds-739"><span class="linenos"> 739</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">)</span>
</span><span id="ColorClouds-740"><a href="#ColorClouds-740"><span class="linenos"> 740</span></a>
</span><span id="ColorClouds-741"><a href="#ColorClouds-741"><span class="linenos"> 741</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">==</span> <span class="n">NT</span><span class="p">,</span> <span class="s2">&quot;TIME EMBEDDING: stim length mismatch&quot;</span>
</span><span id="ColorClouds-742"><a href="#ColorClouds-742"><span class="linenos"> 742</span></a>
</span><span id="ColorClouds-743"><a href="#ColorClouds-743"><span class="linenos"> 743</span></a>        <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nlags</span><span class="p">),</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="ColorClouds-744"><a href="#ColorClouds-744"><span class="linenos"> 744</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span><span class="p">:</span>
</span><span id="ColorClouds-745"><a href="#ColorClouds-745"><span class="linenos"> 745</span></a>            <span class="c1">#tmp_stim = np.transpose( tmp_stim, axes=[0,2,1,3,4] ) </span>
</span><span id="ColorClouds-746"><a href="#ColorClouds-746"><span class="linenos"> 746</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span> <span class="n">tmp_stim</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span> 
</span><span id="ColorClouds-747"><a href="#ColorClouds-747"><span class="linenos"> 747</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Folded lags: stim-dim = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="ColorClouds-748"><a href="#ColorClouds-748"><span class="linenos"> 748</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-749"><a href="#ColorClouds-749"><span class="linenos"> 749</span></a>            <span class="c1">#tmp_stim = np.transpose( tmp_stim, axes=[0,2,3,4,1] )</span>
</span><span id="ColorClouds-750"><a href="#ColorClouds-750"><span class="linenos"> 750</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span> <span class="n">tmp_stim</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
</span><span id="ColorClouds-751"><a href="#ColorClouds-751"><span class="linenos"> 751</span></a>        <span class="k">return</span> <span class="n">tmp_stim</span>
</span><span id="ColorClouds-752"><a href="#ColorClouds-752"><span class="linenos"> 752</span></a>    <span class="c1"># END .time_embedding()</span>
</span><span id="ColorClouds-753"><a href="#ColorClouds-753"><span class="linenos"> 753</span></a>
</span><span id="ColorClouds-754"><a href="#ColorClouds-754"><span class="linenos"> 754</span></a>    <span class="nd">@staticmethod</span>
</span><span id="ColorClouds-755"><a href="#ColorClouds-755"><span class="linenos"> 755</span></a>    <span class="k">def</span> <span class="nf">rectangle_overlap_ranges</span><span class="p">(</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span> <span class="p">):</span>
</span><span id="ColorClouds-756"><a href="#ColorClouds-756"><span class="linenos"> 756</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds-757"><a href="#ColorClouds-757"><span class="linenos"> 757</span></a><span class="sd">        Figures out ranges to write relevant overlap of B onto A</span>
</span><span id="ColorClouds-758"><a href="#ColorClouds-758"><span class="linenos"> 758</span></a><span class="sd">        All info is of form [x0, y0, x1, y1]</span>
</span><span id="ColorClouds-759"><a href="#ColorClouds-759"><span class="linenos"> 759</span></a><span class="sd">        </span>
</span><span id="ColorClouds-760"><a href="#ColorClouds-760"><span class="linenos"> 760</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds-761"><a href="#ColorClouds-761"><span class="linenos"> 761</span></a><span class="sd">            A (list): [x0, y0, x1, y1]</span>
</span><span id="ColorClouds-762"><a href="#ColorClouds-762"><span class="linenos"> 762</span></a><span class="sd">            B (list): [x0, y0, x1, y1]</span>
</span><span id="ColorClouds-763"><a href="#ColorClouds-763"><span class="linenos"> 763</span></a>
</span><span id="ColorClouds-764"><a href="#ColorClouds-764"><span class="linenos"> 764</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds-765"><a href="#ColorClouds-765"><span class="linenos"> 765</span></a><span class="sd">            dict: ranges to write to A from B</span>
</span><span id="ColorClouds-766"><a href="#ColorClouds-766"><span class="linenos"> 766</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds-767"><a href="#ColorClouds-767"><span class="linenos"> 767</span></a>        <span class="n">C</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="ColorClouds-768"><a href="#ColorClouds-768"><span class="linenos"> 768</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="ColorClouds-769"><a href="#ColorClouds-769"><span class="linenos"> 769</span></a>            <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span> 
</span><span id="ColorClouds-770"><a href="#ColorClouds-770"><span class="linenos"> 770</span></a>                <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds-771"><a href="#ColorClouds-771"><span class="linenos"> 771</span></a>                <span class="n">D</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="ColorClouds-772"><a href="#ColorClouds-772"><span class="linenos"> 772</span></a>                <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]:</span>
</span><span id="ColorClouds-773"><a href="#ColorClouds-773"><span class="linenos"> 773</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="ColorClouds-774"><a href="#ColorClouds-774"><span class="linenos"> 774</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> 
</span><span id="ColorClouds-775"><a href="#ColorClouds-775"><span class="linenos"> 775</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-776"><a href="#ColorClouds-776"><span class="linenos"> 776</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="ColorClouds-777"><a href="#ColorClouds-777"><span class="linenos"> 777</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="ColorClouds-778"><a href="#ColorClouds-778"><span class="linenos"> 778</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-779"><a href="#ColorClouds-779"><span class="linenos"> 779</span></a>                <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="ColorClouds-780"><a href="#ColorClouds-780"><span class="linenos"> 780</span></a>                <span class="n">D</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds-781"><a href="#ColorClouds-781"><span class="linenos"> 781</span></a>                <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]:</span>
</span><span id="ColorClouds-782"><a href="#ColorClouds-782"><span class="linenos"> 782</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="ColorClouds-783"><a href="#ColorClouds-783"><span class="linenos"> 783</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="ColorClouds-784"><a href="#ColorClouds-784"><span class="linenos"> 784</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-785"><a href="#ColorClouds-785"><span class="linenos"> 785</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="ColorClouds-786"><a href="#ColorClouds-786"><span class="linenos"> 786</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="ColorClouds-787"><a href="#ColorClouds-787"><span class="linenos"> 787</span></a>
</span><span id="ColorClouds-788"><a href="#ColorClouds-788"><span class="linenos"> 788</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="ColorClouds-789"><a href="#ColorClouds-789"><span class="linenos"> 789</span></a>            <span class="k">return</span> <span class="kc">None</span>  
</span><span id="ColorClouds-790"><a href="#ColorClouds-790"><span class="linenos"> 790</span></a>        <span class="n">ranges</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ColorClouds-791"><a href="#ColorClouds-791"><span class="linenos"> 791</span></a>            <span class="s1">&#39;targetX&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="ColorClouds-792"><a href="#ColorClouds-792"><span class="linenos"> 792</span></a>            <span class="s1">&#39;targetY&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">C</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="ColorClouds-793"><a href="#ColorClouds-793"><span class="linenos"> 793</span></a>            <span class="s1">&#39;readX&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="ColorClouds-794"><a href="#ColorClouds-794"><span class="linenos"> 794</span></a>            <span class="s1">&#39;readY&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">D</span><span class="p">[</span><span class="mi">3</span><span class="p">])}</span>
</span><span id="ColorClouds-795"><a href="#ColorClouds-795"><span class="linenos"> 795</span></a>        <span class="k">return</span> <span class="n">ranges</span>
</span><span id="ColorClouds-796"><a href="#ColorClouds-796"><span class="linenos"> 796</span></a>
</span><span id="ColorClouds-797"><a href="#ColorClouds-797"><span class="linenos"> 797</span></a>    <span class="k">def</span> <span class="nf">wrap_stim</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">vwrap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hwrap</span><span class="o">=</span><span class="mi">0</span> <span class="p">):</span>
</span><span id="ColorClouds-798"><a href="#ColorClouds-798"><span class="linenos"> 798</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds-799"><a href="#ColorClouds-799"><span class="linenos"> 799</span></a><span class="sd">        Take existing stimulus and move the whole thing around in horizontal and/or vertical dims,</span>
</span><span id="ColorClouds-800"><a href="#ColorClouds-800"><span class="linenos"> 800</span></a><span class="sd">        including if time_embedded</span>
</span><span id="ColorClouds-801"><a href="#ColorClouds-801"><span class="linenos"> 801</span></a><span class="sd">        </span>
</span><span id="ColorClouds-802"><a href="#ColorClouds-802"><span class="linenos"> 802</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds-803"><a href="#ColorClouds-803"><span class="linenos"> 803</span></a><span class="sd">            vwrap (int): vertical wrap</span>
</span><span id="ColorClouds-804"><a href="#ColorClouds-804"><span class="linenos"> 804</span></a><span class="sd">            hwrap (int): horizontal wrap</span>
</span><span id="ColorClouds-805"><a href="#ColorClouds-805"><span class="linenos"> 805</span></a>
</span><span id="ColorClouds-806"><a href="#ColorClouds-806"><span class="linenos"> 806</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds-807"><a href="#ColorClouds-807"><span class="linenos"> 807</span></a><span class="sd">            None</span>
</span><span id="ColorClouds-808"><a href="#ColorClouds-808"><span class="linenos"> 808</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds-809"><a href="#ColorClouds-809"><span class="linenos"> 809</span></a>
</span><span id="ColorClouds-810"><a href="#ColorClouds-810"><span class="linenos"> 810</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must assemble the stimulus before using wrap_stim.&quot;</span>
</span><span id="ColorClouds-811"><a href="#ColorClouds-811"><span class="linenos"> 811</span></a>        <span class="n">orig_stim_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="ColorClouds-812"><a href="#ColorClouds-812"><span class="linenos"> 812</span></a>        <span class="k">if</span> <span class="n">orig_stim_dims</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="ColorClouds-813"><a href="#ColorClouds-813"><span class="linenos"> 813</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span>
</span><span id="ColorClouds-814"><a href="#ColorClouds-814"><span class="linenos"> 814</span></a>        <span class="k">elif</span> <span class="n">orig_stim_dims</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="ColorClouds-815"><a href="#ColorClouds-815"><span class="linenos"> 815</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">])</span>  <span class="c1"># put in lags as one dim</span>
</span><span id="ColorClouds-816"><a href="#ColorClouds-816"><span class="linenos"> 816</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-817"><a href="#ColorClouds-817"><span class="linenos"> 817</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</span><span id="ColorClouds-818"><a href="#ColorClouds-818"><span class="linenos"> 818</span></a>
</span><span id="ColorClouds-819"><a href="#ColorClouds-819"><span class="linenos"> 819</span></a>        <span class="n">NY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="ColorClouds-820"><a href="#ColorClouds-820"><span class="linenos"> 820</span></a>        <span class="k">if</span> <span class="n">vwrap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds-821"><a href="#ColorClouds-821"><span class="linenos"> 821</span></a>            <span class="n">tmp2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tmp_stim</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">tmp_stim</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds-822"><a href="#ColorClouds-822"><span class="linenos"> 822</span></a>            <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">vwrap</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">(</span><span class="n">NY</span><span class="o">-</span><span class="n">vwrap</span><span class="p">):,</span> <span class="p">:]</span>
</span><span id="ColorClouds-823"><a href="#ColorClouds-823"><span class="linenos"> 823</span></a>            <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">vwrap</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="n">NY</span><span class="o">-</span><span class="n">vwrap</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="ColorClouds-824"><a href="#ColorClouds-824"><span class="linenos"> 824</span></a>        <span class="k">elif</span> <span class="n">vwrap</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds-825"><a href="#ColorClouds-825"><span class="linenos"> 825</span></a>            <span class="n">tmp2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tmp_stim</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">tmp_stim</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds-826"><a href="#ColorClouds-826"><span class="linenos"> 826</span></a>            <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">(</span><span class="n">NY</span><span class="o">+</span><span class="n">vwrap</span><span class="p">):,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="o">-</span><span class="n">vwrap</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="ColorClouds-827"><a href="#ColorClouds-827"><span class="linenos"> 827</span></a>            <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="n">NY</span><span class="o">+</span><span class="n">vwrap</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">(</span><span class="o">-</span><span class="n">vwrap</span><span class="p">):,</span> <span class="p">:]</span>
</span><span id="ColorClouds-828"><a href="#ColorClouds-828"><span class="linenos"> 828</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-829"><a href="#ColorClouds-829"><span class="linenos"> 829</span></a>            <span class="n">tmp2</span> <span class="o">=</span> <span class="n">tmp_stim</span>
</span><span id="ColorClouds-830"><a href="#ColorClouds-830"><span class="linenos"> 830</span></a>
</span><span id="ColorClouds-831"><a href="#ColorClouds-831"><span class="linenos"> 831</span></a>        <span class="n">NX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds-832"><a href="#ColorClouds-832"><span class="linenos"> 832</span></a>        <span class="k">if</span> <span class="n">hwrap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds-833"><a href="#ColorClouds-833"><span class="linenos"> 833</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tmp2</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">tmp2</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds-834"><a href="#ColorClouds-834"><span class="linenos"> 834</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">hwrap</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">(</span><span class="n">NX</span><span class="o">-</span><span class="n">hwrap</span><span class="p">):,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="ColorClouds-835"><a href="#ColorClouds-835"><span class="linenos"> 835</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">hwrap</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="n">NX</span><span class="o">-</span><span class="n">hwrap</span><span class="p">),</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="ColorClouds-836"><a href="#ColorClouds-836"><span class="linenos"> 836</span></a>        <span class="k">elif</span> <span class="n">hwrap</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds-837"><a href="#ColorClouds-837"><span class="linenos"> 837</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tmp2</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">tmp2</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds-838"><a href="#ColorClouds-838"><span class="linenos"> 838</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">(</span><span class="n">NX</span><span class="o">+</span><span class="n">hwrap</span><span class="p">):,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="o">-</span><span class="n">hwrap</span><span class="p">),</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="ColorClouds-839"><a href="#ColorClouds-839"><span class="linenos"> 839</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="n">NX</span><span class="o">+</span><span class="n">hwrap</span><span class="p">),</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">(</span><span class="o">-</span><span class="n">hwrap</span><span class="p">):,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="ColorClouds-840"><a href="#ColorClouds-840"><span class="linenos"> 840</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-841"><a href="#ColorClouds-841"><span class="linenos"> 841</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tmp2</span><span class="p">)</span>
</span><span id="ColorClouds-842"><a href="#ColorClouds-842"><span class="linenos"> 842</span></a>
</span><span id="ColorClouds-843"><a href="#ColorClouds-843"><span class="linenos"> 843</span></a>        <span class="k">if</span> <span class="n">orig_stim_dims</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="ColorClouds-844"><a href="#ColorClouds-844"><span class="linenos"> 844</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="ColorClouds-845"><a href="#ColorClouds-845"><span class="linenos"> 845</span></a>        <span class="k">elif</span> <span class="n">orig_stim_dims</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="ColorClouds-846"><a href="#ColorClouds-846"><span class="linenos"> 846</span></a>            <span class="c1"># Take out extra lag dim</span>
</span><span id="ColorClouds-847"><a href="#ColorClouds-847"><span class="linenos"> 847</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-848"><a href="#ColorClouds-848"><span class="linenos"> 848</span></a>    <span class="c1"># END .wrap_stim()</span>
</span><span id="ColorClouds-849"><a href="#ColorClouds-849"><span class="linenos"> 849</span></a>
</span><span id="ColorClouds-850"><a href="#ColorClouds-850"><span class="linenos"> 850</span></a>    <span class="k">def</span> <span class="nf">crop_stim</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="ColorClouds-851"><a href="#ColorClouds-851"><span class="linenos"> 851</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds-852"><a href="#ColorClouds-852"><span class="linenos"> 852</span></a><span class="sd">        Crop existing (torch) stimulus and change relevant variables [x1, x2, y1, y2]</span>
</span><span id="ColorClouds-853"><a href="#ColorClouds-853"><span class="linenos"> 853</span></a><span class="sd">        </span>
</span><span id="ColorClouds-854"><a href="#ColorClouds-854"><span class="linenos"> 854</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds-855"><a href="#ColorClouds-855"><span class="linenos"> 855</span></a><span class="sd">            stim_crop (list): [x1, x2, y1, y2]</span>
</span><span id="ColorClouds-856"><a href="#ColorClouds-856"><span class="linenos"> 856</span></a>
</span><span id="ColorClouds-857"><a href="#ColorClouds-857"><span class="linenos"> 857</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds-858"><a href="#ColorClouds-858"><span class="linenos"> 858</span></a><span class="sd">            None</span>
</span><span id="ColorClouds-859"><a href="#ColorClouds-859"><span class="linenos"> 859</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds-860"><a href="#ColorClouds-860"><span class="linenos"> 860</span></a>        <span class="k">if</span> <span class="n">stim_crop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-861"><a href="#ColorClouds-861"><span class="linenos"> 861</span></a>            <span class="n">stim_crop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span>
</span><span id="ColorClouds-862"><a href="#ColorClouds-862"><span class="linenos"> 862</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-863"><a href="#ColorClouds-863"><span class="linenos"> 863</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="o">=</span> <span class="n">stim_crop</span> 
</span><span id="ColorClouds-864"><a href="#ColorClouds-864"><span class="linenos"> 864</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_crop</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;stim_crop must be of form: [x1, x2, y1, y2]&quot;</span>
</span><span id="ColorClouds-865"><a href="#ColorClouds-865"><span class="linenos"> 865</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="ColorClouds-866"><a href="#ColorClouds-866"><span class="linenos"> 866</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">)</span>
</span><span id="ColorClouds-867"><a href="#ColorClouds-867"><span class="linenos"> 867</span></a>            <span class="n">reshape</span><span class="o">=</span><span class="kc">True</span>
</span><span id="ColorClouds-868"><a href="#ColorClouds-868"><span class="linenos"> 868</span></a>            <span class="c1">#print(&#39;  CROP: reshaping stim&#39;)</span>
</span><span id="ColorClouds-869"><a href="#ColorClouds-869"><span class="linenos"> 869</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-870"><a href="#ColorClouds-870"><span class="linenos"> 870</span></a>            <span class="n">reshape</span><span class="o">=</span><span class="kc">False</span>
</span><span id="ColorClouds-871"><a href="#ColorClouds-871"><span class="linenos"> 871</span></a>        <span class="c1">#stim_crop = np.array(stim_crop, dtype=np.int64) # make sure array</span>
</span><span id="ColorClouds-872"><a href="#ColorClouds-872"><span class="linenos"> 872</span></a>        <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stim_crop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stim_crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ColorClouds-873"><a href="#ColorClouds-873"><span class="linenos"> 873</span></a>        <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stim_crop</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">stim_crop</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ColorClouds-874"><a href="#ColorClouds-874"><span class="linenos"> 874</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="ColorClouds-875"><a href="#ColorClouds-875"><span class="linenos"> 875</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">ys</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">xs</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds-876"><a href="#ColorClouds-876"><span class="linenos"> 876</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># then lagged -- need extra dim</span>
</span><span id="ColorClouds-877"><a href="#ColorClouds-877"><span class="linenos"> 877</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">ys</span><span class="p">,</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="n">xs</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="ColorClouds-878"><a href="#ColorClouds-878"><span class="linenos"> 878</span></a>
</span><span id="ColorClouds-879"><a href="#ColorClouds-879"><span class="linenos"> 879</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  CROP: New stim size: </span><span class="si">%d</span><span class="s2"> x </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)))</span>
</span><span id="ColorClouds-880"><a href="#ColorClouds-880"><span class="linenos"> 880</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
</span><span id="ColorClouds-881"><a href="#ColorClouds-881"><span class="linenos"> 881</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
</span><span id="ColorClouds-882"><a href="#ColorClouds-882"><span class="linenos"> 882</span></a>        <span class="k">if</span> <span class="n">reshape</span><span class="p">:</span>
</span><span id="ColorClouds-883"><a href="#ColorClouds-883"><span class="linenos"> 883</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;reshaping back&#39;</span><span class="p">)</span>
</span><span id="ColorClouds-884"><a href="#ColorClouds-884"><span class="linenos"> 884</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="ColorClouds-885"><a href="#ColorClouds-885"><span class="linenos"> 885</span></a>
</span><span id="ColorClouds-886"><a href="#ColorClouds-886"><span class="linenos"> 886</span></a>    <span class="c1"># END .crop_stim()</span>
</span><span id="ColorClouds-887"><a href="#ColorClouds-887"><span class="linenos"> 887</span></a>
</span><span id="ColorClouds-888"><a href="#ColorClouds-888"><span class="linenos"> 888</span></a>    <span class="k">def</span> <span class="nf">process_fixations</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sacc_in</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="ColorClouds-889"><a href="#ColorClouds-889"><span class="linenos"> 889</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds-890"><a href="#ColorClouds-890"><span class="linenos"> 890</span></a><span class="sd">        Processes fixation informatiom from dataset, but also allows new saccade detection</span>
</span><span id="ColorClouds-891"><a href="#ColorClouds-891"><span class="linenos"> 891</span></a><span class="sd">        to be input and put in the right format within the dataset (main use)</span>
</span><span id="ColorClouds-892"><a href="#ColorClouds-892"><span class="linenos"> 892</span></a><span class="sd">        </span>
</span><span id="ColorClouds-893"><a href="#ColorClouds-893"><span class="linenos"> 893</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds-894"><a href="#ColorClouds-894"><span class="linenos"> 894</span></a><span class="sd">            sacc_in (np.ndarray): saccade times</span>
</span><span id="ColorClouds-895"><a href="#ColorClouds-895"><span class="linenos"> 895</span></a>
</span><span id="ColorClouds-896"><a href="#ColorClouds-896"><span class="linenos"> 896</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds-897"><a href="#ColorClouds-897"><span class="linenos"> 897</span></a><span class="sd">            None</span>
</span><span id="ColorClouds-898"><a href="#ColorClouds-898"><span class="linenos"> 898</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds-899"><a href="#ColorClouds-899"><span class="linenos"> 899</span></a>        <span class="k">if</span> <span class="n">sacc_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-900"><a href="#ColorClouds-900"><span class="linenos"> 900</span></a>            <span class="n">sacc_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-901"><a href="#ColorClouds-901"><span class="linenos"> 901</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-902"><a href="#ColorClouds-902"><span class="linenos"> 902</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Redoing fix_n with saccade inputs: </span><span class="si">%d</span><span class="s2"> saccades&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">sacc_in</span><span class="p">)</span> <span class="p">)</span>
</span><span id="ColorClouds-903"><a href="#ColorClouds-903"><span class="linenos"> 903</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds-904"><a href="#ColorClouds-904"><span class="linenos"> 904</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  -&gt; Adjusting timing for non-zero start time in this dataset.&quot;</span><span class="p">)</span>
</span><span id="ColorClouds-905"><a href="#ColorClouds-905"><span class="linenos"> 905</span></a>            <span class="n">sacc_in</span> <span class="o">=</span> <span class="n">sacc_in</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span>
</span><span id="ColorClouds-906"><a href="#ColorClouds-906"><span class="linenos"> 906</span></a>            <span class="n">sacc_in</span> <span class="o">=</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">sacc_in</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-907"><a href="#ColorClouds-907"><span class="linenos"> 907</span></a>
</span><span id="ColorClouds-908"><a href="#ColorClouds-908"><span class="linenos"> 908</span></a>        <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> 
</span><span id="ColorClouds-909"><a href="#ColorClouds-909"><span class="linenos"> 909</span></a>        <span class="n">fix_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds-910"><a href="#ColorClouds-910"><span class="linenos"> 910</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)):</span>
</span><span id="ColorClouds-911"><a href="#ColorClouds-911"><span class="linenos"> 911</span></a>            <span class="c1">#if self.block_inds[ii][0] &lt; self.NT:</span>
</span><span id="ColorClouds-912"><a href="#ColorClouds-912"><span class="linenos"> 912</span></a>            <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="ColorClouds-913"><a href="#ColorClouds-913"><span class="linenos"> 913</span></a>            <span class="c1">#self.block_inds.append(np.arange( blk_inds[ii,0], blk_inds[ii,1], dtype=np.int64))</span>
</span><span id="ColorClouds-914"><a href="#ColorClouds-914"><span class="linenos"> 914</span></a>
</span><span id="ColorClouds-915"><a href="#ColorClouds-915"><span class="linenos"> 915</span></a>            <span class="c1"># Parse fixation numbers within block</span>
</span><span id="ColorClouds-916"><a href="#ColorClouds-916"><span class="linenos"> 916</span></a>            <span class="n">rel_saccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">sacc_in</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sacc_in</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">5</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-917"><a href="#ColorClouds-917"><span class="linenos"> 917</span></a>
</span><span id="ColorClouds-918"><a href="#ColorClouds-918"><span class="linenos"> 918</span></a>            <span class="n">tfix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Beginning of fixation by definition</span>
</span><span id="ColorClouds-919"><a href="#ColorClouds-919"><span class="linenos"> 919</span></a>            <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel_saccs</span><span class="p">)):</span>
</span><span id="ColorClouds-920"><a href="#ColorClouds-920"><span class="linenos"> 920</span></a>                <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ColorClouds-921"><a href="#ColorClouds-921"><span class="linenos"> 921</span></a>                <span class="c1"># Range goes to beginning of next fixation (note no gap)</span>
</span><span id="ColorClouds-922"><a href="#ColorClouds-922"><span class="linenos"> 922</span></a>                <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="ColorClouds-923"><a href="#ColorClouds-923"><span class="linenos"> 923</span></a>                <span class="n">tfix</span> <span class="o">=</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]]</span>
</span><span id="ColorClouds-924"><a href="#ColorClouds-924"><span class="linenos"> 924</span></a>            <span class="c1"># Put in last (or only) fixation number</span>
</span><span id="ColorClouds-925"><a href="#ColorClouds-925"><span class="linenos"> 925</span></a>            <span class="k">if</span> <span class="n">tfix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="ColorClouds-926"><a href="#ColorClouds-926"><span class="linenos"> 926</span></a>                <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ColorClouds-927"><a href="#ColorClouds-927"><span class="linenos"> 927</span></a>                <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="ColorClouds-928"><a href="#ColorClouds-928"><span class="linenos"> 928</span></a>
</span><span id="ColorClouds-929"><a href="#ColorClouds-929"><span class="linenos"> 929</span></a>        <span class="c1"># Determine whether to be numpy or tensor</span>
</span><span id="ColorClouds-930"><a href="#ColorClouds-930"><span class="linenos"> 930</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="ColorClouds-931"><a href="#ColorClouds-931"><span class="linenos"> 931</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds-932"><a href="#ColorClouds-932"><span class="linenos"> 932</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-933"><a href="#ColorClouds-933"><span class="linenos"> 933</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">fix_n</span>
</span><span id="ColorClouds-934"><a href="#ColorClouds-934"><span class="linenos"> 934</span></a>    <span class="c1"># END: ColorClouds.process_fixations()</span>
</span><span id="ColorClouds-935"><a href="#ColorClouds-935"><span class="linenos"> 935</span></a>
</span><span id="ColorClouds-936"><a href="#ColorClouds-936"><span class="linenos"> 936</span></a>    <span class="k">def</span> <span class="nf">augment_dfs</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">new_dfs</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="ColorClouds-937"><a href="#ColorClouds-937"><span class="linenos"> 937</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds-938"><a href="#ColorClouds-938"><span class="linenos"> 938</span></a><span class="sd">        Replaces data-filter for given cells. note that new_df should be np.ndarray</span>
</span><span id="ColorClouds-939"><a href="#ColorClouds-939"><span class="linenos"> 939</span></a><span class="sd">        </span>
</span><span id="ColorClouds-940"><a href="#ColorClouds-940"><span class="linenos"> 940</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds-941"><a href="#ColorClouds-941"><span class="linenos"> 941</span></a><span class="sd">            new_dfs (np.ndarray): new datafilters</span>
</span><span id="ColorClouds-942"><a href="#ColorClouds-942"><span class="linenos"> 942</span></a><span class="sd">            cells (list): cells to replace datafilters for</span>
</span><span id="ColorClouds-943"><a href="#ColorClouds-943"><span class="linenos"> 943</span></a>
</span><span id="ColorClouds-944"><a href="#ColorClouds-944"><span class="linenos"> 944</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds-945"><a href="#ColorClouds-945"><span class="linenos"> 945</span></a><span class="sd">            None</span>
</span><span id="ColorClouds-946"><a href="#ColorClouds-946"><span class="linenos"> 946</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds-947"><a href="#ColorClouds-947"><span class="linenos"> 947</span></a>        
</span><span id="ColorClouds-948"><a href="#ColorClouds-948"><span class="linenos"> 948</span></a>        <span class="n">NTdf</span><span class="p">,</span> <span class="n">NCdf</span> <span class="o">=</span> <span class="n">new_dfs</span><span class="o">.</span><span class="n">shape</span> 
</span><span id="ColorClouds-949"><a href="#ColorClouds-949"><span class="linenos"> 949</span></a>        <span class="k">if</span> <span class="n">cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-950"><a href="#ColorClouds-950"><span class="linenos"> 950</span></a>            <span class="k">assert</span> <span class="n">NCdf</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;new DF is wrong shape to replace DF for all cells.&quot;</span>
</span><span id="ColorClouds-951"><a href="#ColorClouds-951"><span class="linenos"> 951</span></a>            <span class="n">cells</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="ColorClouds-952"><a href="#ColorClouds-952"><span class="linenos"> 952</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">&lt;</span> <span class="n">NTdf</span><span class="p">:</span>
</span><span id="ColorClouds-953"><a href="#ColorClouds-953"><span class="linenos"> 953</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cells</span><span class="p">]</span> <span class="o">*=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">new_dfs</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-954"><a href="#ColorClouds-954"><span class="linenos"> 954</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-955"><a href="#ColorClouds-955"><span class="linenos"> 955</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">&gt;</span> <span class="n">NTdf</span><span class="p">:</span>
</span><span id="ColorClouds-956"><a href="#ColorClouds-956"><span class="linenos"> 956</span></a>                <span class="c1"># Assume dfs are 0 after new valid region</span>
</span><span id="ColorClouds-957"><a href="#ColorClouds-957"><span class="linenos"> 957</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Truncating valid region to new datafilter length&quot;</span><span class="p">,</span> <span class="n">NTdf</span><span class="p">)</span>
</span><span id="ColorClouds-958"><a href="#ColorClouds-958"><span class="linenos"> 958</span></a>                <span class="n">new_dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> 
</span><span id="ColorClouds-959"><a href="#ColorClouds-959"><span class="linenos"> 959</span></a>                    <span class="p">(</span><span class="n">new_dfs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="o">-</span><span class="n">NTdf</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span> 
</span><span id="ColorClouds-960"><a href="#ColorClouds-960"><span class="linenos"> 960</span></a>                    <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ColorClouds-961"><a href="#ColorClouds-961"><span class="linenos"> 961</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cells</span><span class="p">]</span> <span class="o">*=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">new_dfs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-962"><a href="#ColorClouds-962"><span class="linenos"> 962</span></a>        <span class="c1"># END ColorClouds.replace_dfs()</span>
</span><span id="ColorClouds-963"><a href="#ColorClouds-963"><span class="linenos"> 963</span></a>
</span><span id="ColorClouds-964"><a href="#ColorClouds-964"><span class="linenos"> 964</span></a>    <span class="k">def</span> <span class="nf">draw_stim_locations</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">top_corner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">row_height</span><span class="o">=</span><span class="mf">5.0</span> <span class="p">):</span>
</span><span id="ColorClouds-965"><a href="#ColorClouds-965"><span class="linenos"> 965</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds-966"><a href="#ColorClouds-966"><span class="linenos"> 966</span></a><span class="sd">        Draws stimulus locations</span>
</span><span id="ColorClouds-967"><a href="#ColorClouds-967"><span class="linenos"> 967</span></a>
</span><span id="ColorClouds-968"><a href="#ColorClouds-968"><span class="linenos"> 968</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds-969"><a href="#ColorClouds-969"><span class="linenos"> 969</span></a><span class="sd">            top_corner (list): top corner of stimulus</span>
</span><span id="ColorClouds-970"><a href="#ColorClouds-970"><span class="linenos"> 970</span></a><span class="sd">            L (int): length of stimulus</span>
</span><span id="ColorClouds-971"><a href="#ColorClouds-971"><span class="linenos"> 971</span></a><span class="sd">            row_height (float): height of row</span>
</span><span id="ColorClouds-972"><a href="#ColorClouds-972"><span class="linenos"> 972</span></a>
</span><span id="ColorClouds-973"><a href="#ColorClouds-973"><span class="linenos"> 973</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds-974"><a href="#ColorClouds-974"><span class="linenos"> 974</span></a><span class="sd">            None</span>
</span><span id="ColorClouds-975"><a href="#ColorClouds-975"><span class="linenos"> 975</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds-976"><a href="#ColorClouds-976"><span class="linenos"> 976</span></a>        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span id="ColorClouds-977"><a href="#ColorClouds-977"><span class="linenos"> 977</span></a>        <span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Rectangle</span>
</span><span id="ColorClouds-978"><a href="#ColorClouds-978"><span class="linenos"> 978</span></a>
</span><span id="ColorClouds-979"><a href="#ColorClouds-979"><span class="linenos"> 979</span></a>        <span class="n">lamlocs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span>
</span><span id="ColorClouds-980"><a href="#ColorClouds-980"><span class="linenos"> 980</span></a>        <span class="n">ETlocs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_locationET</span>
</span><span id="ColorClouds-981"><a href="#ColorClouds-981"><span class="linenos"> 981</span></a>        <span class="n">fixloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span>
</span><span id="ColorClouds-982"><a href="#ColorClouds-982"><span class="linenos"> 982</span></a>        <span class="n">fixsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_size</span>
</span><span id="ColorClouds-983"><a href="#ColorClouds-983"><span class="linenos"> 983</span></a>        <span class="n">BUF</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="ColorClouds-984"><a href="#ColorClouds-984"><span class="linenos"> 984</span></a>        <span class="k">if</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-985"><a href="#ColorClouds-985"><span class="linenos"> 985</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">lamlocs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-986"><a href="#ColorClouds-986"><span class="linenos"> 986</span></a>
</span><span id="ColorClouds-987"><a href="#ColorClouds-987"><span class="linenos"> 987</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="ColorClouds-988"><a href="#ColorClouds-988"><span class="linenos"> 988</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">row_height</span><span class="p">,</span> <span class="n">row_height</span><span class="p">)</span>
</span><span id="ColorClouds-989"><a href="#ColorClouds-989"><span class="linenos"> 989</span></a>        <span class="n">nET</span> <span class="o">=</span> <span class="n">ETlocs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds-990"><a href="#ColorClouds-990"><span class="linenos"> 990</span></a>        <span class="n">nLAM</span> <span class="o">=</span> <span class="n">lamlocs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds-991"><a href="#ColorClouds-991"><span class="linenos"> 991</span></a>        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="ColorClouds-992"><a href="#ColorClouds-992"><span class="linenos"> 992</span></a>        <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="ColorClouds-993"><a href="#ColorClouds-993"><span class="linenos"> 993</span></a>        <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="ColorClouds-994"><a href="#ColorClouds-994"><span class="linenos"> 994</span></a>        <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">3</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">3</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="ColorClouds-995"><a href="#ColorClouds-995"><span class="linenos"> 995</span></a>        <span class="c1">#print(x0,x1,y0,y1)</span>
</span><span id="ColorClouds-996"><a href="#ColorClouds-996"><span class="linenos"> 996</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nLAM</span><span class="p">):</span>
</span><span id="ColorClouds-997"><a href="#ColorClouds-997"><span class="linenos"> 997</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
</span><span id="ColorClouds-998"><a href="#ColorClouds-998"><span class="linenos"> 998</span></a>                <span class="n">Rectangle</span><span class="p">((</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">lamlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ii</span><span class="p">]),</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> 
</span><span id="ColorClouds-999"><a href="#ColorClouds-999"><span class="linenos"> 999</span></a>                <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">))</span>
</span><span id="ColorClouds-1000"><a href="#ColorClouds-1000"><span class="linenos">1000</span></a>        <span class="n">clrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">]</span>
</span><span id="ColorClouds-1001"><a href="#ColorClouds-1001"><span class="linenos">1001</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nET</span><span class="p">):</span>
</span><span id="ColorClouds-1002"><a href="#ColorClouds-1002"><span class="linenos">1002</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ii</span><span class="p">],</span> <span class="n">ETlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="p">]),</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> 
</span><span id="ColorClouds-1003"><a href="#ColorClouds-1003"><span class="linenos">1003</span></a>                                <span class="n">edgecolor</span><span class="o">=</span><span class="n">clrs</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span><span id="ColorClouds-1004"><a href="#ColorClouds-1004"><span class="linenos">1004</span></a>        <span class="k">if</span> <span class="n">fixloc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-1005"><a href="#ColorClouds-1005"><span class="linenos">1005</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">fixloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">fixsize</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fixloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">fixsize</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">fixsize</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">fixsize</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="ColorClouds-1006"><a href="#ColorClouds-1006"><span class="linenos">1006</span></a>                                <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</span><span id="ColorClouds-1007"><a href="#ColorClouds-1007"><span class="linenos">1007</span></a>        <span class="k">if</span> <span class="n">top_corner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-1008"><a href="#ColorClouds-1008"><span class="linenos">1008</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">(</span><span class="n">top_corner</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> 
</span><span id="ColorClouds-1009"><a href="#ColorClouds-1009"><span class="linenos">1009</span></a>                                <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">))</span>
</span><span id="ColorClouds-1010"><a href="#ColorClouds-1010"><span class="linenos">1010</span></a>            
</span><span id="ColorClouds-1011"><a href="#ColorClouds-1011"><span class="linenos">1011</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>
</span><span id="ColorClouds-1012"><a href="#ColorClouds-1012"><span class="linenos">1012</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">x0</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span><span class="n">x1</span><span class="o">+</span><span class="n">BUF</span><span class="p">])</span>
</span><span id="ColorClouds-1013"><a href="#ColorClouds-1013"><span class="linenos">1013</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="n">y0</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span><span class="n">y1</span><span class="o">+</span><span class="n">BUF</span><span class="p">])</span>
</span><span id="ColorClouds-1014"><a href="#ColorClouds-1014"><span class="linenos">1014</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="ColorClouds-1015"><a href="#ColorClouds-1015"><span class="linenos">1015</span></a>    <span class="c1"># END .draw_stim_locations()</span>
</span><span id="ColorClouds-1016"><a href="#ColorClouds-1016"><span class="linenos">1016</span></a>    
</span><span id="ColorClouds-1017"><a href="#ColorClouds-1017"><span class="linenos">1017</span></a>    <span class="k">def</span> <span class="nf">avrates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="ColorClouds-1018"><a href="#ColorClouds-1018"><span class="linenos">1018</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds-1019"><a href="#ColorClouds-1019"><span class="linenos">1019</span></a><span class="sd">        Calculates average firing probability across specified inds (or whole dataset)</span>
</span><span id="ColorClouds-1020"><a href="#ColorClouds-1020"><span class="linenos">1020</span></a><span class="sd">        -- Note will respect datafilters</span>
</span><span id="ColorClouds-1021"><a href="#ColorClouds-1021"><span class="linenos">1021</span></a><span class="sd">        -- will return precalc value to save time if already stored</span>
</span><span id="ColorClouds-1022"><a href="#ColorClouds-1022"><span class="linenos">1022</span></a>
</span><span id="ColorClouds-1023"><a href="#ColorClouds-1023"><span class="linenos">1023</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds-1024"><a href="#ColorClouds-1024"><span class="linenos">1024</span></a><span class="sd">            inds (list): indices to calculate across</span>
</span><span id="ColorClouds-1025"><a href="#ColorClouds-1025"><span class="linenos">1025</span></a>
</span><span id="ColorClouds-1026"><a href="#ColorClouds-1026"><span class="linenos">1026</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds-1027"><a href="#ColorClouds-1027"><span class="linenos">1027</span></a><span class="sd">            np.ndarray: average firing rates</span>
</span><span id="ColorClouds-1028"><a href="#ColorClouds-1028"><span class="linenos">1028</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds-1029"><a href="#ColorClouds-1029"><span class="linenos">1029</span></a>        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-1030"><a href="#ColorClouds-1030"><span class="linenos">1030</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="ColorClouds-1031"><a href="#ColorClouds-1031"><span class="linenos">1031</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="ColorClouds-1032"><a href="#ColorClouds-1032"><span class="linenos">1032</span></a>            <span class="c1"># then calculate across whole dataset</span>
</span><span id="ColorClouds-1033"><a href="#ColorClouds-1033"><span class="linenos">1033</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-1034"><a href="#ColorClouds-1034"><span class="linenos">1034</span></a>                <span class="c1"># then precalculated and do not need to do</span>
</span><span id="ColorClouds-1035"><a href="#ColorClouds-1035"><span class="linenos">1035</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span>
</span><span id="ColorClouds-1036"><a href="#ColorClouds-1036"><span class="linenos">1036</span></a>
</span><span id="ColorClouds-1037"><a href="#ColorClouds-1037"><span class="linenos">1037</span></a>        <span class="c1"># Otherwise calculate across all data</span>
</span><span id="ColorClouds-1038"><a href="#ColorClouds-1038"><span class="linenos">1038</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="ColorClouds-1039"><a href="#ColorClouds-1039"><span class="linenos">1039</span></a>            <span class="n">Reff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="ColorClouds-1040"><a href="#ColorClouds-1040"><span class="linenos">1040</span></a>            <span class="n">Teff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="ColorClouds-1041"><a href="#ColorClouds-1041"><span class="linenos">1041</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="o">/</span><span class="n">Teff</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="ColorClouds-1042"><a href="#ColorClouds-1042"><span class="linenos">1042</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-1043"><a href="#ColorClouds-1043"><span class="linenos">1043</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Still need to implement avRs without preloading&#39;</span><span class="p">)</span>
</span><span id="ColorClouds-1044"><a href="#ColorClouds-1044"><span class="linenos">1044</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="ColorClouds-1045"><a href="#ColorClouds-1045"><span class="linenos">1045</span></a>    <span class="c1"># END .avrates()</span>
</span><span id="ColorClouds-1046"><a href="#ColorClouds-1046"><span class="linenos">1046</span></a>
</span><span id="ColorClouds-1047"><a href="#ColorClouds-1047"><span class="linenos">1047</span></a>    <span class="k">def</span> <span class="nf">shift_stim</span><span class="p">(</span>
</span><span id="ColorClouds-1048"><a href="#ColorClouds-1048"><span class="linenos">1048</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">pos_shifts</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metric_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ts_thresh</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="ColorClouds-1049"><a href="#ColorClouds-1049"><span class="linenos">1049</span></a>        <span class="n">shift_times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">already_lagged</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="ColorClouds-1050"><a href="#ColorClouds-1050"><span class="linenos">1050</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds-1051"><a href="#ColorClouds-1051"><span class="linenos">1051</span></a><span class="sd">        Shift stimulus given standard shifting input (TBD)</span>
</span><span id="ColorClouds-1052"><a href="#ColorClouds-1052"><span class="linenos">1052</span></a><span class="sd">        use &#39;shift-times&#39; if given shifts correspond to range of times</span>
</span><span id="ColorClouds-1053"><a href="#ColorClouds-1053"><span class="linenos">1053</span></a><span class="sd">        </span>
</span><span id="ColorClouds-1054"><a href="#ColorClouds-1054"><span class="linenos">1054</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds-1055"><a href="#ColorClouds-1055"><span class="linenos">1055</span></a><span class="sd">            pos_shifts (np.ndarray): shifts to apply</span>
</span><span id="ColorClouds-1056"><a href="#ColorClouds-1056"><span class="linenos">1056</span></a><span class="sd">            metrics (np.ndarray): metric to apply threshold</span>
</span><span id="ColorClouds-1057"><a href="#ColorClouds-1057"><span class="linenos">1057</span></a><span class="sd">            metric_threshold (float): threshold for metric</span>
</span><span id="ColorClouds-1058"><a href="#ColorClouds-1058"><span class="linenos">1058</span></a><span class="sd">            ts_thresh (int): threshold for number of timepoints</span>
</span><span id="ColorClouds-1059"><a href="#ColorClouds-1059"><span class="linenos">1059</span></a><span class="sd">            shift_times (list): times to shift stimulus</span>
</span><span id="ColorClouds-1060"><a href="#ColorClouds-1060"><span class="linenos">1060</span></a><span class="sd">            already_lagged (bool): whether stimulus is already lagged</span>
</span><span id="ColorClouds-1061"><a href="#ColorClouds-1061"><span class="linenos">1061</span></a>
</span><span id="ColorClouds-1062"><a href="#ColorClouds-1062"><span class="linenos">1062</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds-1063"><a href="#ColorClouds-1063"><span class="linenos">1063</span></a><span class="sd">            np.ndarray: shifted stimulus</span>
</span><span id="ColorClouds-1064"><a href="#ColorClouds-1064"><span class="linenos">1064</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds-1065"><a href="#ColorClouds-1065"><span class="linenos">1065</span></a>        <span class="n">NX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds-1066"><a href="#ColorClouds-1066"><span class="linenos">1066</span></a>        <span class="n">nlags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="ColorClouds-1067"><a href="#ColorClouds-1067"><span class="linenos">1067</span></a>
</span><span id="ColorClouds-1068"><a href="#ColorClouds-1068"><span class="linenos">1068</span></a>        <span class="c1"># Check if has been time-lagged yet</span>
</span><span id="ColorClouds-1069"><a href="#ColorClouds-1069"><span class="linenos">1069</span></a>  
</span><span id="ColorClouds-1070"><a href="#ColorClouds-1070"><span class="linenos">1070</span></a>        <span class="k">if</span> <span class="n">already_lagged</span><span class="p">:</span>
</span><span id="ColorClouds-1071"><a href="#ColorClouds-1071"><span class="linenos">1071</span></a>            <span class="n">re_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-1072"><a href="#ColorClouds-1072"><span class="linenos">1072</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-1073"><a href="#ColorClouds-1073"><span class="linenos">1073</span></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Should be already lagged, but seems not&quot;</span>
</span><span id="ColorClouds-1074"><a href="#ColorClouds-1074"><span class="linenos">1074</span></a>            <span class="n">re_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span>
</span><span id="ColorClouds-1075"><a href="#ColorClouds-1075"><span class="linenos">1075</span></a>
</span><span id="ColorClouds-1076"><a href="#ColorClouds-1076"><span class="linenos">1076</span></a>        <span class="c1"># Apply shift-times (subset)</span>
</span><span id="ColorClouds-1077"><a href="#ColorClouds-1077"><span class="linenos">1077</span></a>        <span class="k">if</span> <span class="n">shift_times</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-1078"><a href="#ColorClouds-1078"><span class="linenos">1078</span></a>            <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="ColorClouds-1079"><a href="#ColorClouds-1079"><span class="linenos">1079</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-1080"><a href="#ColorClouds-1080"><span class="linenos">1080</span></a>            <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">[</span><span class="n">shift_times</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="ColorClouds-1081"><a href="#ColorClouds-1081"><span class="linenos">1081</span></a>            <span class="c1"># Find minimum fix_n and make = 1</span>
</span><span id="ColorClouds-1082"><a href="#ColorClouds-1082"><span class="linenos">1082</span></a>            <span class="n">min_fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fix_n</span><span class="p">[</span><span class="n">fix_n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="ColorClouds-1083"><a href="#ColorClouds-1083"><span class="linenos">1083</span></a>            <span class="c1">#print(&#39;min_fix_n&#39;, min_fix_n, &#39;adjust&#39;, 1-min_fix_n)</span>
</span><span id="ColorClouds-1084"><a href="#ColorClouds-1084"><span class="linenos">1084</span></a>            <span class="n">fix_n</span><span class="p">[</span><span class="n">fix_n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">-</span><span class="n">min_fix_n</span>
</span><span id="ColorClouds-1085"><a href="#ColorClouds-1085"><span class="linenos">1085</span></a>            <span class="n">re_stim</span> <span class="o">=</span> <span class="n">re_stim</span><span class="p">[</span><span class="n">shift_times</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds-1086"><a href="#ColorClouds-1086"><span class="linenos">1086</span></a>            <span class="c1">#print(&#39;max fix&#39;, np.max(fix_n), fix_n.shape)</span>
</span><span id="ColorClouds-1087"><a href="#ColorClouds-1087"><span class="linenos">1087</span></a>        
</span><span id="ColorClouds-1088"><a href="#ColorClouds-1088"><span class="linenos">1088</span></a>        <span class="n">NF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fix_n</span><span class="p">)</span>
</span><span id="ColorClouds-1089"><a href="#ColorClouds-1089"><span class="linenos">1089</span></a>        <span class="n">NTtmp</span> <span class="o">=</span> <span class="n">re_stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-1090"><a href="#ColorClouds-1090"><span class="linenos">1090</span></a>        <span class="n">nclr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-1091"><a href="#ColorClouds-1091"><span class="linenos">1091</span></a>        <span class="c1">#sh0 = -(pos_shifts[:,0]-self.dims[1]//2)</span>
</span><span id="ColorClouds-1092"><a href="#ColorClouds-1092"><span class="linenos">1092</span></a>        <span class="c1">#sh1 = -(pos_shifts[:,1]-self.dims[2]//2)</span>
</span><span id="ColorClouds-1093"><a href="#ColorClouds-1093"><span class="linenos">1093</span></a>        <span class="n">sh0</span> <span class="o">=</span> <span class="n">pos_shifts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># this should be in units of pixels relative to 0</span>
</span><span id="ColorClouds-1094"><a href="#ColorClouds-1094"><span class="linenos">1094</span></a>        <span class="n">sh1</span> <span class="o">=</span> <span class="n">pos_shifts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds-1095"><a href="#ColorClouds-1095"><span class="linenos">1095</span></a>
</span><span id="ColorClouds-1096"><a href="#ColorClouds-1096"><span class="linenos">1096</span></a>        <span class="n">sp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">re_stim</span><span class="p">)</span>
</span><span id="ColorClouds-1097"><a href="#ColorClouds-1097"><span class="linenos">1097</span></a>        <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-1098"><a href="#ColorClouds-1098"><span class="linenos">1098</span></a>            <span class="n">val_fix</span> <span class="o">=</span> <span class="n">metrics</span> <span class="o">&gt;</span> <span class="n">metric_threshold</span>
</span><span id="ColorClouds-1099"><a href="#ColorClouds-1099"><span class="linenos">1099</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Applied metric threshold: </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">val_fix</span><span class="p">),</span> <span class="n">NF</span><span class="p">))</span>
</span><span id="ColorClouds-1100"><a href="#ColorClouds-1100"><span class="linenos">1100</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-1101"><a href="#ColorClouds-1101"><span class="linenos">1101</span></a>            <span class="n">val_fix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span><span class="o">*</span><span class="n">NF</span><span class="p">)</span>
</span><span id="ColorClouds-1102"><a href="#ColorClouds-1102"><span class="linenos">1102</span></a>
</span><span id="ColorClouds-1103"><a href="#ColorClouds-1103"><span class="linenos">1103</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NF</span><span class="p">):</span>
</span><span id="ColorClouds-1104"><a href="#ColorClouds-1104"><span class="linenos">1104</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fix_n</span> <span class="o">==</span> <span class="n">ff</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-1105"><a href="#ColorClouds-1105"><span class="linenos">1105</span></a>            <span class="c1">#print(ff, len(ts), ts[0], ts[-1])</span>
</span><span id="ColorClouds-1106"><a href="#ColorClouds-1106"><span class="linenos">1106</span></a>
</span><span id="ColorClouds-1107"><a href="#ColorClouds-1107"><span class="linenos">1107</span></a>            <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh0</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh1</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ts_thresh</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">val_fix</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">):</span>
</span><span id="ColorClouds-1108"><a href="#ColorClouds-1108"><span class="linenos">1108</span></a>                <span class="c1"># FIRST SP DIM shift</span>
</span><span id="ColorClouds-1109"><a href="#ColorClouds-1109"><span class="linenos">1109</span></a>                <span class="n">sh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sh0</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="ColorClouds-1110"><a href="#ColorClouds-1110"><span class="linenos">1110</span></a>                <span class="n">stim_seg</span> <span class="o">=</span> <span class="n">re_stim</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds-1111"><a href="#ColorClouds-1111"><span class="linenos">1111</span></a>                <span class="k">if</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds-1112"><a href="#ColorClouds-1112"><span class="linenos">1112</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span> <span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-1113"><a href="#ColorClouds-1113"><span class="linenos">1113</span></a>                    <span class="n">stim_tmp</span><span class="p">[:,</span> <span class="p">:,</span><span class="n">sh</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_seg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="o">-</span><span class="n">sh</span><span class="p">),</span> <span class="p">:])</span>
</span><span id="ColorClouds-1114"><a href="#ColorClouds-1114"><span class="linenos">1114</span></a>                <span class="k">elif</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds-1115"><a href="#ColorClouds-1115"><span class="linenos">1115</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span> <span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-1116"><a href="#ColorClouds-1116"><span class="linenos">1116</span></a>                    <span class="n">stim_tmp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">sh</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_seg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">(</span><span class="o">-</span><span class="n">sh</span><span class="p">):,</span> <span class="p">:])</span>
</span><span id="ColorClouds-1117"><a href="#ColorClouds-1117"><span class="linenos">1117</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-1118"><a href="#ColorClouds-1118"><span class="linenos">1118</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_seg</span><span class="p">)</span>
</span><span id="ColorClouds-1119"><a href="#ColorClouds-1119"><span class="linenos">1119</span></a>
</span><span id="ColorClouds-1120"><a href="#ColorClouds-1120"><span class="linenos">1120</span></a>                <span class="c1"># SECOND SP DIM shift</span>
</span><span id="ColorClouds-1121"><a href="#ColorClouds-1121"><span class="linenos">1121</span></a>                <span class="n">sh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sh1</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="ColorClouds-1122"><a href="#ColorClouds-1122"><span class="linenos">1122</span></a>                <span class="k">if</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds-1123"><a href="#ColorClouds-1123"><span class="linenos">1123</span></a>                    <span class="n">stim_tmp2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-1124"><a href="#ColorClouds-1124"><span class="linenos">1124</span></a>                    <span class="n">stim_tmp2</span><span class="p">[</span><span class="o">...</span> <span class="p">,</span> <span class="n">sh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:(</span><span class="o">-</span><span class="n">sh</span><span class="p">)])</span>
</span><span id="ColorClouds-1125"><a href="#ColorClouds-1125"><span class="linenos">1125</span></a>                <span class="k">elif</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds-1126"><a href="#ColorClouds-1126"><span class="linenos">1126</span></a>                    <span class="n">stim_tmp2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-1127"><a href="#ColorClouds-1127"><span class="linenos">1127</span></a>                    <span class="n">stim_tmp2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">sh</span><span class="p">):])</span>
</span><span id="ColorClouds-1128"><a href="#ColorClouds-1128"><span class="linenos">1128</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-1129"><a href="#ColorClouds-1129"><span class="linenos">1129</span></a>                    <span class="n">stim_tmp2</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span>
</span><span id="ColorClouds-1130"><a href="#ColorClouds-1130"><span class="linenos">1130</span></a>                    
</span><span id="ColorClouds-1131"><a href="#ColorClouds-1131"><span class="linenos">1131</span></a>                <span class="n">sp_stim</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="o">...</span> <span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp2</span><span class="p">)</span>
</span><span id="ColorClouds-1132"><a href="#ColorClouds-1132"><span class="linenos">1132</span></a>
</span><span id="ColorClouds-1133"><a href="#ColorClouds-1133"><span class="linenos">1133</span></a>        <span class="k">if</span> <span class="n">already_lagged</span><span class="p">:</span>
</span><span id="ColorClouds-1134"><a href="#ColorClouds-1134"><span class="linenos">1134</span></a>            <span class="c1"># Time-embed</span>
</span><span id="ColorClouds-1135"><a href="#ColorClouds-1135"><span class="linenos">1135</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NTtmp</span><span class="p">)</span>
</span><span id="ColorClouds-1136"><a href="#ColorClouds-1136"><span class="linenos">1136</span></a>            <span class="n">laggedstim</span> <span class="o">=</span> <span class="n">sp_stim</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NTtmp</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nlags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds-1137"><a href="#ColorClouds-1137"><span class="linenos">1137</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">laggedstim</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="ColorClouds-1138"><a href="#ColorClouds-1138"><span class="linenos">1138</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-1139"><a href="#ColorClouds-1139"><span class="linenos">1139</span></a>            <span class="k">return</span> <span class="n">sp_stim</span>
</span><span id="ColorClouds-1140"><a href="#ColorClouds-1140"><span class="linenos">1140</span></a>    <span class="c1"># END ColorCloud.shift_stim -- note outputs stim rather than overwrites</span>
</span><span id="ColorClouds-1141"><a href="#ColorClouds-1141"><span class="linenos">1141</span></a>
</span><span id="ColorClouds-1142"><a href="#ColorClouds-1142"><span class="linenos">1142</span></a>    <span class="k">def</span> <span class="nf">shift_stim_fixation</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
</span><span id="ColorClouds-1143"><a href="#ColorClouds-1143"><span class="linenos">1143</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds-1144"><a href="#ColorClouds-1144"><span class="linenos">1144</span></a><span class="sd">        Simple shift by integer (rounded shift) and zero padded. Note that this is not in </span>
</span><span id="ColorClouds-1145"><a href="#ColorClouds-1145"><span class="linenos">1145</span></a><span class="sd">        is in units of number of bars, rather than -1 to +1. It assumes the stim</span>
</span><span id="ColorClouds-1146"><a href="#ColorClouds-1146"><span class="linenos">1146</span></a><span class="sd">        has a batch dimension (over a fixation), and shifts the whole stim by the same amount.</span>
</span><span id="ColorClouds-1147"><a href="#ColorClouds-1147"><span class="linenos">1147</span></a><span class="sd">        </span>
</span><span id="ColorClouds-1148"><a href="#ColorClouds-1148"><span class="linenos">1148</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds-1149"><a href="#ColorClouds-1149"><span class="linenos">1149</span></a><span class="sd">            stim (torch.tensor): stimulus to shift</span>
</span><span id="ColorClouds-1150"><a href="#ColorClouds-1150"><span class="linenos">1150</span></a><span class="sd">            shift (float): shift amount</span>
</span><span id="ColorClouds-1151"><a href="#ColorClouds-1151"><span class="linenos">1151</span></a>
</span><span id="ColorClouds-1152"><a href="#ColorClouds-1152"><span class="linenos">1152</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds-1153"><a href="#ColorClouds-1153"><span class="linenos">1153</span></a><span class="sd">            torch.tensor: shifted stimulus</span>
</span><span id="ColorClouds-1154"><a href="#ColorClouds-1154"><span class="linenos">1154</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds-1155"><a href="#ColorClouds-1155"><span class="linenos">1155</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Currently needs to be fixed to work with 2D&#39;</span><span class="p">)</span>
</span><span id="ColorClouds-1156"><a href="#ColorClouds-1156"><span class="linenos">1156</span></a>        <span class="n">sh</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span>
</span><span id="ColorClouds-1157"><a href="#ColorClouds-1157"><span class="linenos">1157</span></a>        <span class="n">shstim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="ColorClouds-1158"><a href="#ColorClouds-1158"><span class="linenos">1158</span></a>        <span class="k">if</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds-1159"><a href="#ColorClouds-1159"><span class="linenos">1159</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="o">-</span><span class="n">sh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="p">:</span><span class="n">sh</span><span class="p">]</span>
</span><span id="ColorClouds-1160"><a href="#ColorClouds-1160"><span class="linenos">1160</span></a>        <span class="k">elif</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds-1161"><a href="#ColorClouds-1161"><span class="linenos">1161</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="n">sh</span><span class="p">:]</span>
</span><span id="ColorClouds-1162"><a href="#ColorClouds-1162"><span class="linenos">1162</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-1163"><a href="#ColorClouds-1163"><span class="linenos">1163</span></a>            <span class="n">shstim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="ColorClouds-1164"><a href="#ColorClouds-1164"><span class="linenos">1164</span></a>
</span><span id="ColorClouds-1165"><a href="#ColorClouds-1165"><span class="linenos">1165</span></a>        <span class="k">return</span> <span class="n">shstim</span>
</span><span id="ColorClouds-1166"><a href="#ColorClouds-1166"><span class="linenos">1166</span></a>    <span class="c1"># END .shift_stim_fixation</span>
</span><span id="ColorClouds-1167"><a href="#ColorClouds-1167"><span class="linenos">1167</span></a>
</span><span id="ColorClouds-1168"><a href="#ColorClouds-1168"><span class="linenos">1168</span></a>    <span class="k">def</span> <span class="nf">create_valid_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post_sacc_gap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ColorClouds-1169"><a href="#ColorClouds-1169"><span class="linenos">1169</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds-1170"><a href="#ColorClouds-1170"><span class="linenos">1170</span></a><span class="sd">        This creates self.valid_inds vector that is used for __get_item__ </span>
</span><span id="ColorClouds-1171"><a href="#ColorClouds-1171"><span class="linenos">1171</span></a><span class="sd">        -- Will default to num_lags following each saccade beginning</span>
</span><span id="ColorClouds-1172"><a href="#ColorClouds-1172"><span class="linenos">1172</span></a><span class="sd">        </span>
</span><span id="ColorClouds-1173"><a href="#ColorClouds-1173"><span class="linenos">1173</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds-1174"><a href="#ColorClouds-1174"><span class="linenos">1174</span></a><span class="sd">            post_sacc_gap (int): gap following saccade</span>
</span><span id="ColorClouds-1175"><a href="#ColorClouds-1175"><span class="linenos">1175</span></a>
</span><span id="ColorClouds-1176"><a href="#ColorClouds-1176"><span class="linenos">1176</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds-1177"><a href="#ColorClouds-1177"><span class="linenos">1177</span></a><span class="sd">            None</span>
</span><span id="ColorClouds-1178"><a href="#ColorClouds-1178"><span class="linenos">1178</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds-1179"><a href="#ColorClouds-1179"><span class="linenos">1179</span></a>
</span><span id="ColorClouds-1180"><a href="#ColorClouds-1180"><span class="linenos">1180</span></a>        <span class="k">if</span> <span class="n">post_sacc_gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-1181"><a href="#ColorClouds-1181"><span class="linenos">1181</span></a>            <span class="n">post_sacc_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="ColorClouds-1182"><a href="#ColorClouds-1182"><span class="linenos">1182</span></a>
</span><span id="ColorClouds-1183"><a href="#ColorClouds-1183"><span class="linenos">1183</span></a>        <span class="c1"># first, throw out all data where all data_filters are zero</span>
</span><span id="ColorClouds-1184"><a href="#ColorClouds-1184"><span class="linenos">1184</span></a>        <span class="n">is_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="ColorClouds-1185"><a href="#ColorClouds-1185"><span class="linenos">1185</span></a>        <span class="n">is_valid</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ColorClouds-1186"><a href="#ColorClouds-1186"><span class="linenos">1186</span></a>        
</span><span id="ColorClouds-1187"><a href="#ColorClouds-1187"><span class="linenos">1187</span></a>        <span class="c1"># Now invalid post_sacc_gap following saccades</span>
</span><span id="ColorClouds-1188"><a href="#ColorClouds-1188"><span class="linenos">1188</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span><span class="p">):</span>
</span><span id="ColorClouds-1189"><a href="#ColorClouds-1189"><span class="linenos">1189</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:])</span>
</span><span id="ColorClouds-1190"><a href="#ColorClouds-1190"><span class="linenos">1190</span></a>            <span class="n">sts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds-1191"><a href="#ColorClouds-1191"><span class="linenos">1191</span></a>            <span class="n">is_valid</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">post_sacc_gap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds-1192"><a href="#ColorClouds-1192"><span class="linenos">1192</span></a>        
</span><span id="ColorClouds-1193"><a href="#ColorClouds-1193"><span class="linenos">1193</span></a>        <span class="c1">#self.valid_inds = list(np.where(is_valid &gt; 0)[0])</span>
</span><span id="ColorClouds-1194"><a href="#ColorClouds-1194"><span class="linenos">1194</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_valid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-1195"><a href="#ColorClouds-1195"><span class="linenos">1195</span></a>    <span class="c1"># END .create_valid_indices</span>
</span><span id="ColorClouds-1196"><a href="#ColorClouds-1196"><span class="linenos">1196</span></a>
</span><span id="ColorClouds-1197"><a href="#ColorClouds-1197"><span class="linenos">1197</span></a>    <span class="k">def</span> <span class="nf">crossval_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test_set</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="ColorClouds-1198"><a href="#ColorClouds-1198"><span class="linenos">1198</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;This sets the cross-validation indices up We can add featuers here. Many ways to do this</span>
</span><span id="ColorClouds-1199"><a href="#ColorClouds-1199"><span class="linenos">1199</span></a><span class="sd">        but will stick to some standard for now. It sets the internal indices, which can be read out</span>
</span><span id="ColorClouds-1200"><a href="#ColorClouds-1200"><span class="linenos">1200</span></a><span class="sd">        directly or with helper functions. Perhaps helper_functions is the best way....</span>
</span><span id="ColorClouds-1201"><a href="#ColorClouds-1201"><span class="linenos">1201</span></a><span class="sd">        </span>
</span><span id="ColorClouds-1202"><a href="#ColorClouds-1202"><span class="linenos">1202</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds-1203"><a href="#ColorClouds-1203"><span class="linenos">1203</span></a><span class="sd">            folds: number of folds </span>
</span><span id="ColorClouds-1204"><a href="#ColorClouds-1204"><span class="linenos">1204</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="ColorClouds-1205"><a href="#ColorClouds-1205"><span class="linenos">1205</span></a><span class="sd">            test_set: whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</span>
</span><span id="ColorClouds-1206"><a href="#ColorClouds-1206"><span class="linenos">1206</span></a><span class="sd">            verbose: whether to print out information</span>
</span><span id="ColorClouds-1207"><a href="#ColorClouds-1207"><span class="linenos">1207</span></a>
</span><span id="ColorClouds-1208"><a href="#ColorClouds-1208"><span class="linenos">1208</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds-1209"><a href="#ColorClouds-1209"><span class="linenos">1209</span></a><span class="sd">            None: sets internal variables test_inds, train_inds, val_inds</span>
</span><span id="ColorClouds-1210"><a href="#ColorClouds-1210"><span class="linenos">1210</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds-1211"><a href="#ColorClouds-1211"><span class="linenos">1211</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must first specify valid_indices before setting up cross-validation.&quot;</span>
</span><span id="ColorClouds-1212"><a href="#ColorClouds-1212"><span class="linenos">1212</span></a>
</span><span id="ColorClouds-1213"><a href="#ColorClouds-1213"><span class="linenos">1213</span></a>        <span class="c1"># Partition data by saccades, and then associate indices with each</span>
</span><span id="ColorClouds-1214"><a href="#ColorClouds-1214"><span class="linenos">1214</span></a>        <span class="n">te_fixes</span><span class="p">,</span> <span class="n">tr_fixes</span><span class="p">,</span> <span class="n">val_fixes</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="ColorClouds-1215"><a href="#ColorClouds-1215"><span class="linenos">1215</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixation_grouping</span><span class="p">)):</span>  <span class="c1"># Loops across experiments</span>
</span><span id="ColorClouds-1216"><a href="#ColorClouds-1216"><span class="linenos">1216</span></a>            <span class="n">fixations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixation_grouping</span><span class="p">[</span><span class="n">ee</span><span class="p">])</span>  <span class="c1"># fixations associated with each experiment</span>
</span><span id="ColorClouds-1217"><a href="#ColorClouds-1217"><span class="linenos">1217</span></a>            <span class="n">val_fix1</span><span class="p">,</span> <span class="n">tr_fix1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fixations</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="ColorClouds-1218"><a href="#ColorClouds-1218"><span class="linenos">1218</span></a>            <span class="k">if</span> <span class="n">test_set</span><span class="p">:</span>
</span><span id="ColorClouds-1219"><a href="#ColorClouds-1219"><span class="linenos">1219</span></a>                <span class="n">te_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">val_fix1</span><span class="p">])</span>
</span><span id="ColorClouds-1220"><a href="#ColorClouds-1220"><span class="linenos">1220</span></a>                <span class="n">val_fix2</span><span class="p">,</span> <span class="n">tr_fix2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_fix1</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="ColorClouds-1221"><a href="#ColorClouds-1221"><span class="linenos">1221</span></a>                <span class="n">val_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">tr_fix1</span><span class="p">[</span><span class="n">val_fix2</span><span class="p">]])</span>
</span><span id="ColorClouds-1222"><a href="#ColorClouds-1222"><span class="linenos">1222</span></a>                <span class="n">tr_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">tr_fix1</span><span class="p">[</span><span class="n">tr_fix2</span><span class="p">]])</span>
</span><span id="ColorClouds-1223"><a href="#ColorClouds-1223"><span class="linenos">1223</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-1224"><a href="#ColorClouds-1224"><span class="linenos">1224</span></a>                <span class="n">val_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">val_fix1</span><span class="p">])</span>
</span><span id="ColorClouds-1225"><a href="#ColorClouds-1225"><span class="linenos">1225</span></a>                <span class="n">tr_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">tr_fix1</span><span class="p">])</span>
</span><span id="ColorClouds-1226"><a href="#ColorClouds-1226"><span class="linenos">1226</span></a>
</span><span id="ColorClouds-1227"><a href="#ColorClouds-1227"><span class="linenos">1227</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="ColorClouds-1228"><a href="#ColorClouds-1228"><span class="linenos">1228</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Partitioned </span><span class="si">%d</span><span class="s2"> fixations total: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span>
</span><span id="ColorClouds-1229"><a href="#ColorClouds-1229"><span class="linenos">1229</span></a>                <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">te_fixes</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_fixes</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">val_fixes</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_fixes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_fixes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">te_fixes</span><span class="p">)))</span>  
</span><span id="ColorClouds-1230"><a href="#ColorClouds-1230"><span class="linenos">1230</span></a>
</span><span id="ColorClouds-1231"><a href="#ColorClouds-1231"><span class="linenos">1231</span></a>        <span class="c1"># Now pull  indices from each saccade </span>
</span><span id="ColorClouds-1232"><a href="#ColorClouds-1232"><span class="linenos">1232</span></a>        <span class="n">tr_inds</span><span class="p">,</span> <span class="n">te_inds</span><span class="p">,</span> <span class="n">val_inds</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="ColorClouds-1233"><a href="#ColorClouds-1233"><span class="linenos">1233</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">tr_fixes</span><span class="p">:</span>
</span><span id="ColorClouds-1234"><a href="#ColorClouds-1234"><span class="linenos">1234</span></a>            <span class="n">tr_inds</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="ColorClouds-1235"><a href="#ColorClouds-1235"><span class="linenos">1235</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">val_fixes</span><span class="p">:</span>
</span><span id="ColorClouds-1236"><a href="#ColorClouds-1236"><span class="linenos">1236</span></a>            <span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="ColorClouds-1237"><a href="#ColorClouds-1237"><span class="linenos">1237</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">te_fixes</span><span class="p">:</span>
</span><span id="ColorClouds-1238"><a href="#ColorClouds-1238"><span class="linenos">1238</span></a>            <span class="n">te_inds</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="ColorClouds-1239"><a href="#ColorClouds-1239"><span class="linenos">1239</span></a>
</span><span id="ColorClouds-1240"><a href="#ColorClouds-1240"><span class="linenos">1240</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="ColorClouds-1241"><a href="#ColorClouds-1241"><span class="linenos">1241</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Pre-valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">te_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="ColorClouds-1242"><a href="#ColorClouds-1242"><span class="linenos">1242</span></a>
</span><span id="ColorClouds-1243"><a href="#ColorClouds-1243"><span class="linenos">1243</span></a>        <span class="c1"># Finally intersect with valid indices</span>
</span><span id="ColorClouds-1244"><a href="#ColorClouds-1244"><span class="linenos">1244</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">)))</span>
</span><span id="ColorClouds-1245"><a href="#ColorClouds-1245"><span class="linenos">1245</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">val_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">)))</span>
</span><span id="ColorClouds-1246"><a href="#ColorClouds-1246"><span class="linenos">1246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">te_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">)))</span>
</span><span id="ColorClouds-1247"><a href="#ColorClouds-1247"><span class="linenos">1247</span></a>
</span><span id="ColorClouds-1248"><a href="#ColorClouds-1248"><span class="linenos">1248</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="ColorClouds-1249"><a href="#ColorClouds-1249"><span class="linenos">1249</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="ColorClouds-1250"><a href="#ColorClouds-1250"><span class="linenos">1250</span></a>
</span><span id="ColorClouds-1251"><a href="#ColorClouds-1251"><span class="linenos">1251</span></a>    <span class="c1"># END MultiDatasetFix.crossval_setup</span>
</span><span id="ColorClouds-1252"><a href="#ColorClouds-1252"><span class="linenos">1252</span></a>
</span><span id="ColorClouds-1253"><a href="#ColorClouds-1253"><span class="linenos">1253</span></a>    <span class="k">def</span> <span class="nf">get_max_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpu_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nquad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mf">1.2</span><span class="p">):</span>
</span><span id="ColorClouds-1254"><a href="#ColorClouds-1254"><span class="linenos">1254</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds-1255"><a href="#ColorClouds-1255"><span class="linenos">1255</span></a><span class="sd">        get the maximum number of samples that fit in memory -- for GLM/GQM x LBFGS</span>
</span><span id="ColorClouds-1256"><a href="#ColorClouds-1256"><span class="linenos">1256</span></a>
</span><span id="ColorClouds-1257"><a href="#ColorClouds-1257"><span class="linenos">1257</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds-1258"><a href="#ColorClouds-1258"><span class="linenos">1258</span></a><span class="sd">            gpu_n (int): gpu number</span>
</span><span id="ColorClouds-1259"><a href="#ColorClouds-1259"><span class="linenos">1259</span></a><span class="sd">            history_size (int): history size</span>
</span><span id="ColorClouds-1260"><a href="#ColorClouds-1260"><span class="linenos">1260</span></a><span class="sd">            nquad (int): number of quadrature points</span>
</span><span id="ColorClouds-1261"><a href="#ColorClouds-1261"><span class="linenos">1261</span></a><span class="sd">            num_cells (int): number of cells</span>
</span><span id="ColorClouds-1262"><a href="#ColorClouds-1262"><span class="linenos">1262</span></a><span class="sd">            buffer (float): buffer size</span>
</span><span id="ColorClouds-1263"><a href="#ColorClouds-1263"><span class="linenos">1263</span></a>
</span><span id="ColorClouds-1264"><a href="#ColorClouds-1264"><span class="linenos">1264</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds-1265"><a href="#ColorClouds-1265"><span class="linenos">1265</span></a><span class="sd">            int: maximum number of samples that fit in memory</span>
</span><span id="ColorClouds-1266"><a href="#ColorClouds-1266"><span class="linenos">1266</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds-1267"><a href="#ColorClouds-1267"><span class="linenos">1267</span></a>        <span class="k">if</span> <span class="n">gpu_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds-1268"><a href="#ColorClouds-1268"><span class="linenos">1268</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
</span><span id="ColorClouds-1269"><a href="#ColorClouds-1269"><span class="linenos">1269</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-1270"><a href="#ColorClouds-1270"><span class="linenos">1270</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:1&#39;</span><span class="p">)</span>
</span><span id="ColorClouds-1271"><a href="#ColorClouds-1271"><span class="linenos">1271</span></a>
</span><span id="ColorClouds-1272"><a href="#ColorClouds-1272"><span class="linenos">1272</span></a>        <span class="k">if</span> <span class="n">num_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-1273"><a href="#ColorClouds-1273"><span class="linenos">1273</span></a>            <span class="n">num_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span>
</span><span id="ColorClouds-1274"><a href="#ColorClouds-1274"><span class="linenos">1274</span></a>        
</span><span id="ColorClouds-1275"><a href="#ColorClouds-1275"><span class="linenos">1275</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">total_memory</span>
</span><span id="ColorClouds-1276"><a href="#ColorClouds-1276"><span class="linenos">1276</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_reserved</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds-1277"><a href="#ColorClouds-1277"><span class="linenos">1277</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_allocated</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds-1278"><a href="#ColorClouds-1278"><span class="linenos">1278</span></a>        <span class="n">free</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">r</span><span class="p">)</span>
</span><span id="ColorClouds-1279"><a href="#ColorClouds-1279"><span class="linenos">1279</span></a>
</span><span id="ColorClouds-1280"><a href="#ColorClouds-1280"><span class="linenos">1280</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds-1281"><a href="#ColorClouds-1281"><span class="linenos">1281</span></a>        <span class="n">mempersample</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span>
</span><span id="ColorClouds-1282"><a href="#ColorClouds-1282"><span class="linenos">1282</span></a>    
</span><span id="ColorClouds-1283"><a href="#ColorClouds-1283"><span class="linenos">1283</span></a>        <span class="n">mempercell</span> <span class="o">=</span> <span class="n">mempersample</span> <span class="o">*</span> <span class="p">(</span><span class="n">nquad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">history_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="ColorClouds-1284"><a href="#ColorClouds-1284"><span class="linenos">1284</span></a>        <span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">*</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span>
</span><span id="ColorClouds-1285"><a href="#ColorClouds-1285"><span class="linenos">1285</span></a>
</span><span id="ColorClouds-1286"><a href="#ColorClouds-1286"><span class="linenos">1286</span></a>        <span class="n">maxsamples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">free</span> <span class="o">-</span> <span class="n">mempercell</span><span class="o">*</span><span class="n">num_cells</span> <span class="o">-</span> <span class="n">buffer_bytes</span><span class="p">)</span> <span class="o">//</span> <span class="n">mempersample</span>
</span><span id="ColorClouds-1287"><a href="#ColorClouds-1287"><span class="linenos">1287</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# samples that can fit on device: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxsamples</span><span class="p">))</span>
</span><span id="ColorClouds-1288"><a href="#ColorClouds-1288"><span class="linenos">1288</span></a>        <span class="k">return</span> <span class="n">maxsamples</span>
</span><span id="ColorClouds-1289"><a href="#ColorClouds-1289"><span class="linenos">1289</span></a>    <span class="c1"># END .get_max_samples</span>
</span><span id="ColorClouds-1290"><a href="#ColorClouds-1290"><span class="linenos">1290</span></a>
</span><span id="ColorClouds-1291"><a href="#ColorClouds-1291"><span class="linenos">1291</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="ColorClouds-1292"><a href="#ColorClouds-1292"><span class="linenos">1292</span></a>
</span><span id="ColorClouds-1293"><a href="#ColorClouds-1293"><span class="linenos">1293</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Have to specify stimulus before pulling data.&quot;</span>
</span><span id="ColorClouds-1294"><a href="#ColorClouds-1294"><span class="linenos">1294</span></a>        <span class="c1">#if isinstance(idx, np.ndarray):</span>
</span><span id="ColorClouds-1295"><a href="#ColorClouds-1295"><span class="linenos">1295</span></a>        <span class="c1">#    idx = list(idx)</span>
</span><span id="ColorClouds-1296"><a href="#ColorClouds-1296"><span class="linenos">1296</span></a>        <span class="c1"># Convert trials to indices if trial-sample</span>
</span><span id="ColorClouds-1297"><a href="#ColorClouds-1297"><span class="linenos">1297</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_sample</span><span class="p">:</span>
</span><span id="ColorClouds-1298"><a href="#ColorClouds-1298"><span class="linenos">1298</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_to_array</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">))</span>
</span><span id="ColorClouds-1299"><a href="#ColorClouds-1299"><span class="linenos">1299</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="ColorClouds-1300"><a href="#ColorClouds-1300"><span class="linenos">1300</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span id="ColorClouds-1301"><a href="#ColorClouds-1301"><span class="linenos">1301</span></a>                <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
</span><span id="ColorClouds-1302"><a href="#ColorClouds-1302"><span class="linenos">1302</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">ts</span>
</span><span id="ColorClouds-1303"><a href="#ColorClouds-1303"><span class="linenos">1303</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-1304"><a href="#ColorClouds-1304"><span class="linenos">1304</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_to_array</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="ColorClouds-1305"><a href="#ColorClouds-1305"><span class="linenos">1305</span></a>
</span><span id="ColorClouds-1306"><a href="#ColorClouds-1306"><span class="linenos">1306</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="ColorClouds-1307"><a href="#ColorClouds-1307"><span class="linenos">1307</span></a>
</span><span id="ColorClouds-1308"><a href="#ColorClouds-1308"><span class="linenos">1308</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ColorClouds-1309"><a href="#ColorClouds-1309"><span class="linenos">1309</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;get_item time embedding not implemented yet&quot;</span><span class="p">)</span>
</span><span id="ColorClouds-1310"><a href="#ColorClouds-1310"><span class="linenos">1310</span></a>                <span class="c1"># if self.folded_lags:</span>
</span><span id="ColorClouds-1311"><a href="#ColorClouds-1311"><span class="linenos">1311</span></a>                <span class="c1">#    stim = np.transpose( tmp_stim, axes=[0,2,1,3,4] ) </span>
</span><span id="ColorClouds-1312"><a href="#ColorClouds-1312"><span class="linenos">1312</span></a>                <span class="c1">#else:</span>
</span><span id="ColorClouds-1313"><a href="#ColorClouds-1313"><span class="linenos">1313</span></a>                <span class="c1">#    stim = np.transpose( tmp_stim, axes=[0,2,3,4,1] )</span>
</span><span id="ColorClouds-1314"><a href="#ColorClouds-1314"><span class="linenos">1314</span></a>    
</span><span id="ColorClouds-1315"><a href="#ColorClouds-1315"><span class="linenos">1315</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-1316"><a href="#ColorClouds-1316"><span class="linenos">1316</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds-1317"><a href="#ColorClouds-1317"><span class="linenos">1317</span></a>                    <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="ColorClouds-1318"><a href="#ColorClouds-1318"><span class="linenos">1318</span></a>                        <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="ColorClouds-1319"><a href="#ColorClouds-1319"><span class="linenos">1319</span></a>                        <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]}</span>
</span><span id="ColorClouds-1320"><a href="#ColorClouds-1320"><span class="linenos">1320</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds-1321"><a href="#ColorClouds-1321"><span class="linenos">1321</span></a>                        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;fix_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="ColorClouds-1322"><a href="#ColorClouds-1322"><span class="linenos">1322</span></a>                        <span class="c1"># missing saccade timing vector -- not specified</span>
</span><span id="ColorClouds-1323"><a href="#ColorClouds-1323"><span class="linenos">1323</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-1324"><a href="#ColorClouds-1324"><span class="linenos">1324</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-1325"><a href="#ColorClouds-1325"><span class="linenos">1325</span></a>                        <span class="n">robs_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs_out</span>
</span><span id="ColorClouds-1326"><a href="#ColorClouds-1326"><span class="linenos">1326</span></a>                        <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs_out</span>
</span><span id="ColorClouds-1327"><a href="#ColorClouds-1327"><span class="linenos">1327</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-1328"><a href="#ColorClouds-1328"><span class="linenos">1328</span></a>                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s1">&#39;cells_out must be a list&#39;</span>
</span><span id="ColorClouds-1329"><a href="#ColorClouds-1329"><span class="linenos">1329</span></a>                        <span class="n">robs_tmp</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="ColorClouds-1330"><a href="#ColorClouds-1330"><span class="linenos">1330</span></a>                        <span class="n">dfs_tmp</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="ColorClouds-1331"><a href="#ColorClouds-1331"><span class="linenos">1331</span></a> 
</span><span id="ColorClouds-1332"><a href="#ColorClouds-1332"><span class="linenos">1332</span></a>                    <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="ColorClouds-1333"><a href="#ColorClouds-1333"><span class="linenos">1333</span></a>                        <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="n">robs_tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="ColorClouds-1334"><a href="#ColorClouds-1334"><span class="linenos">1334</span></a>                        <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="n">dfs_tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]}</span>
</span><span id="ColorClouds-1335"><a href="#ColorClouds-1335"><span class="linenos">1335</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds-1336"><a href="#ColorClouds-1336"><span class="linenos">1336</span></a>                        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;fix_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="ColorClouds-1337"><a href="#ColorClouds-1337"><span class="linenos">1337</span></a>
</span><span id="ColorClouds-1338"><a href="#ColorClouds-1338"><span class="linenos">1338</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speckled</span><span class="p">:</span>
</span><span id="ColorClouds-1339"><a href="#ColorClouds-1339"><span class="linenos">1339</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-1340"><a href="#ColorClouds-1340"><span class="linenos">1340</span></a>                        <span class="n">M1tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mval</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="ColorClouds-1341"><a href="#ColorClouds-1341"><span class="linenos">1341</span></a>                        <span class="n">M2tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="ColorClouds-1342"><a href="#ColorClouds-1342"><span class="linenos">1342</span></a>                        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Mval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M1tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds-1343"><a href="#ColorClouds-1343"><span class="linenos">1343</span></a>                        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Mtrn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M2tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds-1344"><a href="#ColorClouds-1344"><span class="linenos">1344</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-1345"><a href="#ColorClouds-1345"><span class="linenos">1345</span></a>                        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Mval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds-1346"><a href="#ColorClouds-1346"><span class="linenos">1346</span></a>                        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Mtrn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mtrn_out</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds-1347"><a href="#ColorClouds-1347"><span class="linenos">1347</span></a>
</span><span id="ColorClouds-1348"><a href="#ColorClouds-1348"><span class="linenos">1348</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_separate_eye_stim</span><span class="p">:</span>
</span><span id="ColorClouds-1349"><a href="#ColorClouds-1349"><span class="linenos">1349</span></a>                    <span class="c1"># Overwrite left stim with left eye only</span>
</span><span id="ColorClouds-1350"><a href="#ColorClouds-1350"><span class="linenos">1350</span></a>                    <span class="n">tmp_dims</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span>
</span><span id="ColorClouds-1351"><a href="#ColorClouds-1351"><span class="linenos">1351</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tmp_dims</span><span class="p">])</span>
</span><span id="ColorClouds-1352"><a href="#ColorClouds-1352"><span class="linenos">1352</span></a>                    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim_tmp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds-1353"><a href="#ColorClouds-1353"><span class="linenos">1353</span></a>                    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;stimR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim_tmp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>            
</span><span id="ColorClouds-1354"><a href="#ColorClouds-1354"><span class="linenos">1354</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds-1355"><a href="#ColorClouds-1355"><span class="linenos">1355</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="ColorClouds-1356"><a href="#ColorClouds-1356"><span class="linenos">1356</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ColorClouds-1357"><a href="#ColorClouds-1357"><span class="linenos">1357</span></a>            <span class="n">robs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ColorClouds-1358"><a href="#ColorClouds-1358"><span class="linenos">1358</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ColorClouds-1359"><a href="#ColorClouds-1359"><span class="linenos">1359</span></a>            <span class="n">num_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="ColorClouds-1360"><a href="#ColorClouds-1360"><span class="linenos">1360</span></a>
</span><span id="ColorClouds-1361"><a href="#ColorClouds-1361"><span class="linenos">1361</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Stim &quot;&quot;&quot;</span>
</span><span id="ColorClouds-1362"><a href="#ColorClouds-1362"><span class="linenos">1362</span></a>            <span class="c1"># need file handle</span>
</span><span id="ColorClouds-1363"><a href="#ColorClouds-1363"><span class="linenos">1363</span></a>            <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds-1364"><a href="#ColorClouds-1364"><span class="linenos">1364</span></a>            <span class="c1">#f = self.file_index[inds]  # problem is this could span across several files</span>
</span><span id="ColorClouds-1365"><a href="#ColorClouds-1365"><span class="linenos">1365</span></a>
</span><span id="ColorClouds-1366"><a href="#ColorClouds-1366"><span class="linenos">1366</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;stim&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-1367"><a href="#ColorClouds-1367"><span class="linenos">1367</span></a>            <span class="c1"># reshape and flatten stim: currently its NT x NX x NY x Nclrs</span>
</span><span id="ColorClouds-1368"><a href="#ColorClouds-1368"><span class="linenos">1368</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">permute</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">])</span>
</span><span id="ColorClouds-1369"><a href="#ColorClouds-1369"><span class="linenos">1369</span></a><span class="w">                </span>
</span><span id="ColorClouds-1370"><a href="#ColorClouds-1370"><span class="linenos">1370</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Spikes: needs padding so all are B x NC &quot;&quot;&quot;</span> 
</span><span id="ColorClouds-1371"><a href="#ColorClouds-1371"><span class="linenos">1371</span></a>            <span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;Robs&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-1372"><a href="#ColorClouds-1372"><span class="linenos">1372</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="ColorClouds-1373"><a href="#ColorClouds-1373"><span class="linenos">1373</span></a>                <span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="ColorClouds-1374"><a href="#ColorClouds-1374"><span class="linenos">1374</span></a>                    <span class="p">(</span><span class="n">robs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span> 
</span><span id="ColorClouds-1375"><a href="#ColorClouds-1375"><span class="linenos">1375</span></a>                    <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ColorClouds-1376"><a href="#ColorClouds-1376"><span class="linenos">1376</span></a>
</span><span id="ColorClouds-1377"><a href="#ColorClouds-1377"><span class="linenos">1377</span></a><span class="w">                </span><span class="sd">&quot;&quot;&quot; Datafilters: needs padding like robs &quot;&quot;&quot;</span>
</span><span id="ColorClouds-1378"><a href="#ColorClouds-1378"><span class="linenos">1378</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;DFs&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds-1379"><a href="#ColorClouds-1379"><span class="linenos">1379</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="ColorClouds-1380"><a href="#ColorClouds-1380"><span class="linenos">1380</span></a>                <span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="ColorClouds-1381"><a href="#ColorClouds-1381"><span class="linenos">1381</span></a>                    <span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;DFsMU&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span>
</span><span id="ColorClouds-1382"><a href="#ColorClouds-1382"><span class="linenos">1382</span></a>                    <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ColorClouds-1383"><a href="#ColorClouds-1383"><span class="linenos">1383</span></a>
</span><span id="ColorClouds-1384"><a href="#ColorClouds-1384"><span class="linenos">1384</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="n">stim</span><span class="p">,</span> <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="n">robs</span><span class="p">,</span> <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="n">dfs</span><span class="p">,</span> <span class="s1">&#39;fix_n&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">[</span><span class="n">inds</span><span class="p">]}</span>
</span><span id="ColorClouds-1385"><a href="#ColorClouds-1385"><span class="linenos">1385</span></a>
</span><span id="ColorClouds-1386"><a href="#ColorClouds-1386"><span class="linenos">1386</span></a>        <span class="c1"># Addition whether-or-not preloaded</span>
</span><span id="ColorClouds-1387"><a href="#ColorClouds-1387"><span class="linenos">1387</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds-1388"><a href="#ColorClouds-1388"><span class="linenos">1388</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Xdrift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds-1389"><a href="#ColorClouds-1389"><span class="linenos">1389</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="ColorClouds-1390"><a href="#ColorClouds-1390"><span class="linenos">1390</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;binocular&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds-1391"><a href="#ColorClouds-1391"><span class="linenos">1391</span></a>            
</span><span id="ColorClouds-1392"><a href="#ColorClouds-1392"><span class="linenos">1392</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds-1393"><a href="#ColorClouds-1393"><span class="linenos">1393</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">append_covariates</span><span class="p">(</span> <span class="n">out</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span><span id="ColorClouds-1394"><a href="#ColorClouds-1394"><span class="linenos">1394</span></a>
</span><span id="ColorClouds-1395"><a href="#ColorClouds-1395"><span class="linenos">1395</span></a>        <span class="c1">### THIS IS NOT NEEDED WITH TIME-EMBEDDING: needs to be on fixation-process side...</span>
</span><span id="ColorClouds-1396"><a href="#ColorClouds-1396"><span class="linenos">1396</span></a>        <span class="c1"># cushion DFs for number of lags (reducing stim)</span>
</span><span id="ColorClouds-1397"><a href="#ColorClouds-1397"><span class="linenos">1397</span></a>        <span class="c1">#if (self.num_lags &gt; 0) &amp;  ~utils.is_int(idx):</span>
</span><span id="ColorClouds-1398"><a href="#ColorClouds-1398"><span class="linenos">1398</span></a>        <span class="c1">#    if out[&#39;dfs&#39;].shape[0] &gt; self.num_lags:</span>
</span><span id="ColorClouds-1399"><a href="#ColorClouds-1399"><span class="linenos">1399</span></a>        <span class="c1">#        out[&#39;dfs&#39;][:self.num_lags, :] = 0.0</span>
</span><span id="ColorClouds-1400"><a href="#ColorClouds-1400"><span class="linenos">1400</span></a>        <span class="c1">#    else: </span>
</span><span id="ColorClouds-1401"><a href="#ColorClouds-1401"><span class="linenos">1401</span></a>        <span class="c1">#        print( &quot;Warning: requested batch smaller than num_lags %d &lt; %d&quot;%(out[&#39;dfs&#39;].shape[0], self.num_lags) )</span>
</span><span id="ColorClouds-1402"><a href="#ColorClouds-1402"><span class="linenos">1402</span></a>     
</span><span id="ColorClouds-1403"><a href="#ColorClouds-1403"><span class="linenos">1403</span></a>        <span class="k">return</span> <span class="n">out</span>
</span><span id="ColorClouds-1404"><a href="#ColorClouds-1404"><span class="linenos">1404</span></a>    <span class="c1"># END: CloudDataset.__get_item__</span>
</span><span id="ColorClouds-1405"><a href="#ColorClouds-1405"><span class="linenos">1405</span></a>
</span><span id="ColorClouds-1406"><a href="#ColorClouds-1406"><span class="linenos">1406</span></a>    <span class="c1">#@property</span>
</span><span id="ColorClouds-1407"><a href="#ColorClouds-1407"><span class="linenos">1407</span></a>    <span class="c1">#def NT(self):</span>
</span><span id="ColorClouds-1408"><a href="#ColorClouds-1408"><span class="linenos">1408</span></a>    <span class="c1">#    return len(self.used_inds)</span>
</span><span id="ColorClouds-1409"><a href="#ColorClouds-1409"><span class="linenos">1409</span></a>
</span><span id="ColorClouds-1410"><a href="#ColorClouds-1410"><span class="linenos">1410</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ColorClouds-1411"><a href="#ColorClouds-1411"><span class="linenos">1411</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>-- can load batches from multiple datasets
-- hdf5 files must have the following information:
    Robs
    RobsMU
    stim: 4-d stimulus: time x nx x ny x color
    block_inds: start and stop of 'trials' (perhaps fixations for now)
    other things: saccades? or should that be in trials? </p>

<p>Constructor will take eye position, which for now is an input from data
generated in the session (not on disk). It should have the length size 
of the total number of fixations x1.</p>

<p>Input arguments (details):
    stim_crop = None, should be of form [x1, x2, y1, y2] where each number is the 
        extreme point to be include as an index, e.g. range(x1, x2+1), ...</p>
</div>


                            <div id="ColorClouds.__init__" class="classattr">
                                        <input id="ColorClouds.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ColorClouds</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">filenames</span>,</span><span class="param">	<span class="n">datadir</span>,</span><span class="param">	<span class="n">time_embed</span><span class="o">=</span><span class="mi">2</span>,</span><span class="param">	<span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span>,</span><span class="param">	<span class="n">include_MUs</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">drift_interval</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">trial_sample</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>,</span><span class="param">	<span class="n">which_stim</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">luminance_only</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">ignore_saccades</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">folded_lags</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">binocular</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">eye_config</span><span class="o">=</span><span class="mi">2</span>,</span><span class="param">	<span class="n">maxT</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="ColorClouds.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ColorClouds.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ColorClouds.__init__-36"><a href="#ColorClouds.__init__-36"><span class="linenos"> 36</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="ColorClouds.__init__-37"><a href="#ColorClouds.__init__-37"><span class="linenos"> 37</span></a>        <span class="n">filenames</span><span class="p">,</span>
</span><span id="ColorClouds.__init__-38"><a href="#ColorClouds.__init__-38"><span class="linenos"> 38</span></a>        <span class="n">datadir</span><span class="p">,</span> 
</span><span id="ColorClouds.__init__-39"><a href="#ColorClouds.__init__-39"><span class="linenos"> 39</span></a>        <span class="n">time_embed</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="c1"># 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="ColorClouds.__init__-40"><a href="#ColorClouds.__init__-40"><span class="linenos"> 40</span></a>        <span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
</span><span id="ColorClouds.__init__-41"><a href="#ColorClouds.__init__-41"><span class="linenos"> 41</span></a>        <span class="n">include_MUs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ColorClouds.__init__-42"><a href="#ColorClouds.__init__-42"><span class="linenos"> 42</span></a>        <span class="n">drift_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ColorClouds.__init__-43"><a href="#ColorClouds.__init__-43"><span class="linenos"> 43</span></a>        <span class="n">trial_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ColorClouds.__init__-44"><a href="#ColorClouds.__init__-44"><span class="linenos"> 44</span></a>        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">),</span>
</span><span id="ColorClouds.__init__-45"><a href="#ColorClouds.__init__-45"><span class="linenos"> 45</span></a>        <span class="c1"># Dataset-specitic inputs</span>
</span><span id="ColorClouds.__init__-46"><a href="#ColorClouds.__init__-46"><span class="linenos"> 46</span></a>        <span class="c1"># Stim setup -- if dont want to assemble stimulus: specify all things here for default options</span>
</span><span id="ColorClouds.__init__-47"><a href="#ColorClouds.__init__-47"><span class="linenos"> 47</span></a>        <span class="n">which_stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># &#39;et&#39; or 0, or 1 for lam, but default assemble later</span>
</span><span id="ColorClouds.__init__-48"><a href="#ColorClouds.__init__-48"><span class="linenos"> 48</span></a>        <span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># should be list/array of 4 numbers representing inds of edges</span>
</span><span id="ColorClouds.__init__-49"><a href="#ColorClouds.__init__-49"><span class="linenos"> 49</span></a>        <span class="n">luminance_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="ColorClouds.__init__-50"><a href="#ColorClouds.__init__-50"><span class="linenos"> 50</span></a>        <span class="n">ignore_saccades</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="ColorClouds.__init__-51"><a href="#ColorClouds.__init__-51"><span class="linenos"> 51</span></a>        <span class="n">folded_lags</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="ColorClouds.__init__-52"><a href="#ColorClouds.__init__-52"><span class="linenos"> 52</span></a>        <span class="n">binocular</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># whether to include separate filters for each eye</span>
</span><span id="ColorClouds.__init__-53"><a href="#ColorClouds.__init__-53"><span class="linenos"> 53</span></a>        <span class="n">eye_config</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 0 = all, 1, -1, and 2 are options (2 = binocular)</span>
</span><span id="ColorClouds.__init__-54"><a href="#ColorClouds.__init__-54"><span class="linenos"> 54</span></a>        <span class="n">maxT</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="ColorClouds.__init__-55"><a href="#ColorClouds.__init__-55"><span class="linenos"> 55</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds.__init__-56"><a href="#ColorClouds.__init__-56"><span class="linenos"> 56</span></a><span class="sd">        Constructor options</span>
</span><span id="ColorClouds.__init__-57"><a href="#ColorClouds.__init__-57"><span class="linenos"> 57</span></a><span class="sd">        </span>
</span><span id="ColorClouds.__init__-58"><a href="#ColorClouds.__init__-58"><span class="linenos"> 58</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds.__init__-59"><a href="#ColorClouds.__init__-59"><span class="linenos"> 59</span></a><span class="sd">            filenames (list): list of strings with filenames (without .mat) to load</span>
</span><span id="ColorClouds.__init__-60"><a href="#ColorClouds.__init__-60"><span class="linenos"> 60</span></a><span class="sd">            datadir (str): directory where data is stored</span>
</span><span id="ColorClouds.__init__-61"><a href="#ColorClouds.__init__-61"><span class="linenos"> 61</span></a><span class="sd">            time_embed (int): 0, 1, or 2. 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="ColorClouds.__init__-62"><a href="#ColorClouds.__init__-62"><span class="linenos"> 62</span></a><span class="sd">            num_lags (int): number of lags to use in time-embedding</span>
</span><span id="ColorClouds.__init__-63"><a href="#ColorClouds.__init__-63"><span class="linenos"> 63</span></a><span class="sd">            include_MUs (bool): whether to include MUs in the dataset</span>
</span><span id="ColorClouds.__init__-64"><a href="#ColorClouds.__init__-64"><span class="linenos"> 64</span></a><span class="sd">            drift_interval (int): number of blocks to include in drift term</span>
</span><span id="ColorClouds.__init__-65"><a href="#ColorClouds.__init__-65"><span class="linenos"> 65</span></a><span class="sd">            trial_sample (bool): whether to sample trials randomly</span>
</span><span id="ColorClouds.__init__-66"><a href="#ColorClouds.__init__-66"><span class="linenos"> 66</span></a><span class="sd">            device (torch.device): device to store data on</span>
</span><span id="ColorClouds.__init__-67"><a href="#ColorClouds.__init__-67"><span class="linenos"> 67</span></a><span class="sd">            which_stim (str or int): &#39;et&#39; or 0, or 1 for lam, but default assemble later</span>
</span><span id="ColorClouds.__init__-68"><a href="#ColorClouds.__init__-68"><span class="linenos"> 68</span></a><span class="sd">            stim_crop (list): should be list/array of 4 numbers representing inds of edges</span>
</span><span id="ColorClouds.__init__-69"><a href="#ColorClouds.__init__-69"><span class="linenos"> 69</span></a><span class="sd">            luminance_only (bool): whether to use only luminance channel</span>
</span><span id="ColorClouds.__init__-70"><a href="#ColorClouds.__init__-70"><span class="linenos"> 70</span></a><span class="sd">            ignore_saccades (bool): whether to ignore saccades</span>
</span><span id="ColorClouds.__init__-71"><a href="#ColorClouds.__init__-71"><span class="linenos"> 71</span></a><span class="sd">            folded_lags (bool): whether to fold lags into channels</span>
</span><span id="ColorClouds.__init__-72"><a href="#ColorClouds.__init__-72"><span class="linenos"> 72</span></a><span class="sd">            binocular (bool): whether to include separate filters for each eye</span>
</span><span id="ColorClouds.__init__-73"><a href="#ColorClouds.__init__-73"><span class="linenos"> 73</span></a><span class="sd">            eye_config (int): 0 = all, 1, -1, and 2 are options (2 = binocular)</span>
</span><span id="ColorClouds.__init__-74"><a href="#ColorClouds.__init__-74"><span class="linenos"> 74</span></a><span class="sd">            maxT (int): maximum number of time points to include</span>
</span><span id="ColorClouds.__init__-75"><a href="#ColorClouds.__init__-75"><span class="linenos"> 75</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds.__init__-76"><a href="#ColorClouds.__init__-76"><span class="linenos"> 76</span></a>
</span><span id="ColorClouds.__init__-77"><a href="#ColorClouds.__init__-77"><span class="linenos"> 77</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="ColorClouds.__init__-78"><a href="#ColorClouds.__init__-78"><span class="linenos"> 78</span></a>            <span class="n">filenames</span><span class="o">=</span><span class="n">filenames</span><span class="p">,</span> <span class="n">datadir</span><span class="o">=</span><span class="n">datadir</span><span class="p">,</span> 
</span><span id="ColorClouds.__init__-79"><a href="#ColorClouds.__init__-79"><span class="linenos"> 79</span></a>            <span class="n">time_embed</span><span class="o">=</span><span class="n">time_embed</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">num_lags</span><span class="p">,</span> <span class="n">include_MUs</span><span class="o">=</span><span class="n">include_MUs</span><span class="p">,</span> 
</span><span id="ColorClouds.__init__-80"><a href="#ColorClouds.__init__-80"><span class="linenos"> 80</span></a>            <span class="n">drift_interval</span><span class="o">=</span><span class="n">drift_interval</span><span class="p">,</span> <span class="n">trial_sample</span><span class="o">=</span><span class="n">trial_sample</span><span class="p">,</span>
</span><span id="ColorClouds.__init__-81"><a href="#ColorClouds.__init__-81"><span class="linenos"> 81</span></a>            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-82"><a href="#ColorClouds.__init__-82"><span class="linenos"> 82</span></a>
</span><span id="ColorClouds.__init__-83"><a href="#ColorClouds.__init__-83"><span class="linenos"> 83</span></a>        <span class="c1"># Done in parent constructor</span>
</span><span id="ColorClouds.__init__-84"><a href="#ColorClouds.__init__-84"><span class="linenos"> 84</span></a>        <span class="c1">#self.datadir = datadir</span>
</span><span id="ColorClouds.__init__-85"><a href="#ColorClouds.__init__-85"><span class="linenos"> 85</span></a>        <span class="c1">#self.filenames = filenames</span>
</span><span id="ColorClouds.__init__-86"><a href="#ColorClouds.__init__-86"><span class="linenos"> 86</span></a>        <span class="c1">#self.device = device</span>
</span><span id="ColorClouds.__init__-87"><a href="#ColorClouds.__init__-87"><span class="linenos"> 87</span></a>        <span class="c1">#self.num_lags = 10  # default: to be set later</span>
</span><span id="ColorClouds.__init__-88"><a href="#ColorClouds.__init__-88"><span class="linenos"> 88</span></a>        <span class="c1">#if time_embed == 2:</span>
</span><span id="ColorClouds.__init__-89"><a href="#ColorClouds.__init__-89"><span class="linenos"> 89</span></a>        <span class="c1">#    assert preload, &quot;Cannot pre-time-embed without preloading.&quot;</span>
</span><span id="ColorClouds.__init__-90"><a href="#ColorClouds.__init__-90"><span class="linenos"> 90</span></a>        <span class="c1">#self.time_embed = time_embed</span>
</span><span id="ColorClouds.__init__-91"><a href="#ColorClouds.__init__-91"><span class="linenos"> 91</span></a>        <span class="c1">#self.preload = preload</span>
</span><span id="ColorClouds.__init__-92"><a href="#ColorClouds.__init__-92"><span class="linenos"> 92</span></a>
</span><span id="ColorClouds.__init__-93"><a href="#ColorClouds.__init__-93"><span class="linenos"> 93</span></a>        <span class="c1"># Stim-specific</span>
</span><span id="ColorClouds.__init__-94"><a href="#ColorClouds.__init__-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="o">=</span> <span class="kc">None</span> 
</span><span id="ColorClouds.__init__-95"><a href="#ColorClouds.__init__-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span> <span class="o">=</span> <span class="n">folded_lags</span>
</span><span id="ColorClouds.__init__-96"><a href="#ColorClouds.__init__-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">=</span> <span class="n">eye_config</span>
</span><span id="ColorClouds.__init__-97"><a href="#ColorClouds.__init__-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span> <span class="o">=</span> <span class="n">binocular</span>
</span><span id="ColorClouds.__init__-98"><a href="#ColorClouds.__init__-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span> <span class="o">=</span> <span class="n">luminance_only</span>
</span><span id="ColorClouds.__init__-99"><a href="#ColorClouds.__init__-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_Xfix</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ColorClouds.__init__-100"><a href="#ColorClouds.__init__-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_separate_eye_stim</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ColorClouds.__init__-101"><a href="#ColorClouds.__init__-101"><span class="linenos">101</span></a>
</span><span id="ColorClouds.__init__-102"><a href="#ColorClouds.__init__-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds.__init__-103"><a href="#ColorClouds.__init__-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span> <span class="o">=</span> <span class="n">drift_interval</span>
</span><span id="ColorClouds.__init__-104"><a href="#ColorClouds.__init__-104"><span class="linenos">104</span></a>
</span><span id="ColorClouds.__init__-105"><a href="#ColorClouds.__init__-105"><span class="linenos">105</span></a>        <span class="c1"># get hdf5 file handles</span>
</span><span id="ColorClouds.__init__-106"><a href="#ColorClouds.__init__-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">sess</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>
</span><span id="ColorClouds.__init__-107"><a href="#ColorClouds.__init__-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ColorClouds.__init__-108"><a href="#ColorClouds.__init__-108"><span class="linenos">108</span></a>
</span><span id="ColorClouds.__init__-109"><a href="#ColorClouds.__init__-109"><span class="linenos">109</span></a>        <span class="c1"># Set up to store default train_, val_, test_inds</span>
</span><span id="ColorClouds.__init__-110"><a href="#ColorClouds.__init__-110"><span class="linenos">110</span></a>        <span class="c1">#self.test_inds = None</span>
</span><span id="ColorClouds.__init__-111"><a href="#ColorClouds.__init__-111"><span class="linenos">111</span></a>        <span class="c1">#self.val_inds = None</span>
</span><span id="ColorClouds.__init__-112"><a href="#ColorClouds.__init__-112"><span class="linenos">112</span></a>        <span class="c1">#self.train_inds = None</span>
</span><span id="ColorClouds.__init__-113"><a href="#ColorClouds.__init__-113"><span class="linenos">113</span></a>        <span class="c1">#self.used_inds = []</span>
</span><span id="ColorClouds.__init__-114"><a href="#ColorClouds.__init__-114"><span class="linenos">114</span></a>
</span><span id="ColorClouds.__init__-115"><a href="#ColorClouds.__init__-115"><span class="linenos">115</span></a>        <span class="c1"># Data to construct and store in memory</span>
</span><span id="ColorClouds.__init__-116"><a href="#ColorClouds.__init__-116"><span class="linenos">116</span></a>        <span class="c1">#self.stim = []</span>
</span><span id="ColorClouds.__init__-117"><a href="#ColorClouds.__init__-117"><span class="linenos">117</span></a>        <span class="c1">#self.dfs = []</span>
</span><span id="ColorClouds.__init__-118"><a href="#ColorClouds.__init__-118"><span class="linenos">118</span></a>        <span class="c1">#self.robs = []</span>
</span><span id="ColorClouds.__init__-119"><a href="#ColorClouds.__init__-119"><span class="linenos">119</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ColorClouds.__init__-120"><a href="#ColorClouds.__init__-120"><span class="linenos">120</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ColorClouds.__init__-121"><a href="#ColorClouds.__init__-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds.__init__-122"><a href="#ColorClouds.__init__-122"><span class="linenos">122</span></a>
</span><span id="ColorClouds.__init__-123"><a href="#ColorClouds.__init__-123"><span class="linenos">123</span></a>        <span class="c1"># build index map -- exclude variables already set in sensory-base</span>
</span><span id="ColorClouds.__init__-124"><a href="#ColorClouds.__init__-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-125"><a href="#ColorClouds.__init__-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_threshold</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># how many valid time points required to include saccade?</span>
</span><span id="ColorClouds.__init__-126"><a href="#ColorClouds.__init__-126"><span class="linenos">126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_index</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># which file the block corresponds to</span>
</span><span id="ColorClouds.__init__-127"><a href="#ColorClouds.__init__-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ColorClouds.__init__-128"><a href="#ColorClouds.__init__-128"><span class="linenos">128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_shifts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ColorClouds.__init__-129"><a href="#ColorClouds.__init__-129"><span class="linenos">129</span></a>        <span class="c1">#self.stim_dims = None</span>
</span><span id="ColorClouds.__init__-130"><a href="#ColorClouds.__init__-130"><span class="linenos">130</span></a>
</span><span id="ColorClouds.__init__-131"><a href="#ColorClouds.__init__-131"><span class="linenos">131</span></a>        <span class="c1">#self.unit_ids = []</span>
</span><span id="ColorClouds.__init__-132"><a href="#ColorClouds.__init__-132"><span class="linenos">132</span></a>        <span class="c1">#self.num_units, self.num_SUs, self.num_MUs = [], [], []</span>
</span><span id="ColorClouds.__init__-133"><a href="#ColorClouds.__init__-133"><span class="linenos">133</span></a>        <span class="c1">#self.SUs = []</span>
</span><span id="ColorClouds.__init__-134"><a href="#ColorClouds.__init__-134"><span class="linenos">134</span></a>        <span class="c1">#self.NC = 0    </span>
</span><span id="ColorClouds.__init__-135"><a href="#ColorClouds.__init__-135"><span class="linenos">135</span></a>        <span class="c1">#self.block_inds = []</span>
</span><span id="ColorClouds.__init__-136"><a href="#ColorClouds.__init__-136"><span class="linenos">136</span></a>        <span class="c1">#self.block_filemapping = []</span>
</span><span id="ColorClouds.__init__-137"><a href="#ColorClouds.__init__-137"><span class="linenos">137</span></a>        <span class="c1">#self.include_MUs = include_MUs</span>
</span><span id="ColorClouds.__init__-138"><a href="#ColorClouds.__init__-138"><span class="linenos">138</span></a>        <span class="c1">#self.SUinds = []</span>
</span><span id="ColorClouds.__init__-139"><a href="#ColorClouds.__init__-139"><span class="linenos">139</span></a>        <span class="c1">#self.MUinds = []</span>
</span><span id="ColorClouds.__init__-140"><a href="#ColorClouds.__init__-140"><span class="linenos">140</span></a>        <span class="c1">#self.cells_out = []  # can be list to output specific cells in get_item</span>
</span><span id="ColorClouds.__init__-141"><a href="#ColorClouds.__init__-141"><span class="linenos">141</span></a>        <span class="c1">#self.avRs = None</span>
</span><span id="ColorClouds.__init__-142"><a href="#ColorClouds.__init__-142"><span class="linenos">142</span></a>
</span><span id="ColorClouds.__init__-143"><a href="#ColorClouds.__init__-143"><span class="linenos">143</span></a>        <span class="n">tcount</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds.__init__-144"><a href="#ColorClouds.__init__-144"><span class="linenos">144</span></a>
</span><span id="ColorClouds.__init__-145"><a href="#ColorClouds.__init__-145"><span class="linenos">145</span></a>        <span class="k">for</span> <span class="n">fnum</span><span class="p">,</span> <span class="n">fhandle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">):</span>
</span><span id="ColorClouds.__init__-146"><a href="#ColorClouds.__init__-146"><span class="linenos">146</span></a>
</span><span id="ColorClouds.__init__-147"><a href="#ColorClouds.__init__-147"><span class="linenos">147</span></a>            <span class="n">NT</span><span class="p">,</span> <span class="n">NSUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="ColorClouds.__init__-148"><a href="#ColorClouds.__init__-148"><span class="linenos">148</span></a>            <span class="c1"># Check for valid RobsMU</span>
</span><span id="ColorClouds.__init__-149"><a href="#ColorClouds.__init__-149"><span class="linenos">149</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-150"><a href="#ColorClouds.__init__-150"><span class="linenos">150</span></a>                <span class="n">NMUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds.__init__-151"><a href="#ColorClouds.__init__-151"><span class="linenos">151</span></a>            <span class="k">else</span><span class="p">:</span> 
</span><span id="ColorClouds.__init__-152"><a href="#ColorClouds.__init__-152"><span class="linenos">152</span></a>                <span class="n">NMUfile</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds.__init__-153"><a href="#ColorClouds.__init__-153"><span class="linenos">153</span></a>
</span><span id="ColorClouds.__init__-154"><a href="#ColorClouds.__init__-154"><span class="linenos">154</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_SUs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NSUfile</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-155"><a href="#ColorClouds.__init__-155"><span class="linenos">155</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_MUs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NMUfile</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-156"><a href="#ColorClouds.__init__-156"><span class="linenos">156</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="o">+</span><span class="n">NSUfile</span><span class="p">))</span>
</span><span id="ColorClouds.__init__-157"><a href="#ColorClouds.__init__-157"><span class="linenos">157</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;block_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-158"><a href="#ColorClouds.__init__-158"><span class="linenos">158</span></a>            <span class="n">blk_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># convert to python so range works</span>
</span><span id="ColorClouds.__init__-159"><a href="#ColorClouds.__init__-159"><span class="linenos">159</span></a>            <span class="c1"># Check to make sure not inverted blk_inds (older version of data)</span>
</span><span id="ColorClouds.__init__-160"><a href="#ColorClouds.__init__-160"><span class="linenos">160</span></a>            <span class="k">if</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-161"><a href="#ColorClouds.__init__-161"><span class="linenos">161</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: blk_inds is stored old-style: transposing&#39;</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-162"><a href="#ColorClouds.__init__-162"><span class="linenos">162</span></a>                <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">T</span>
</span><span id="ColorClouds.__init__-163"><a href="#ColorClouds.__init__-163"><span class="linenos">163</span></a>
</span><span id="ColorClouds.__init__-164"><a href="#ColorClouds.__init__-164"><span class="linenos">164</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapSU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds.__init__-165"><a href="#ColorClouds.__init__-165"><span class="linenos">165</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">channel_rating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs_rating&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds.__init__-166"><a href="#ColorClouds.__init__-166"><span class="linenos">166</span></a>            <span class="k">if</span> <span class="n">NMUfile</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-167"><a href="#ColorClouds.__init__-167"><span class="linenos">167</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds.__init__-168"><a href="#ColorClouds.__init__-168"><span class="linenos">168</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">channelMU_rating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU_rating&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds.__init__-169"><a href="#ColorClouds.__init__-169"><span class="linenos">169</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">channel_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_mapSU</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapMU</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-170"><a href="#ColorClouds.__init__-170"><span class="linenos">170</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-171"><a href="#ColorClouds.__init__-171"><span class="linenos">171</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapMU</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ColorClouds.__init__-172"><a href="#ColorClouds.__init__-172"><span class="linenos">172</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">channel_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_mapSU</span>
</span><span id="ColorClouds.__init__-173"><a href="#ColorClouds.__init__-173"><span class="linenos">173</span></a>            
</span><span id="ColorClouds.__init__-174"><a href="#ColorClouds.__init__-174"><span class="linenos">174</span></a>            <span class="c1"># Stimulus information</span>
</span><span id="ColorClouds.__init__-175"><a href="#ColorClouds.__init__-175"><span class="linenos">175</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;fix_location&#39;</span><span class="p">])</span>
</span><span id="ColorClouds.__init__-176"><a href="#ColorClouds.__init__-176"><span class="linenos">176</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;fix_size&#39;</span><span class="p">])</span>
</span><span id="ColorClouds.__init__-177"><a href="#ColorClouds.__init__-177"><span class="linenos">177</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim_location&#39;</span><span class="p">])</span>
</span><span id="ColorClouds.__init__-178"><a href="#ColorClouds.__init__-178"><span class="linenos">178</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_locationET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;ETstim_location&#39;</span><span class="p">])</span>
</span><span id="ColorClouds.__init__-179"><a href="#ColorClouds.__init__-179"><span class="linenos">179</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimscale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimscale&#39;</span><span class="p">])</span>
</span><span id="ColorClouds.__init__-180"><a href="#ColorClouds.__init__-180"><span class="linenos">180</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ColorClouds.__init__-181"><a href="#ColorClouds.__init__-181"><span class="linenos">181</span></a>
</span><span id="ColorClouds.__init__-182"><a href="#ColorClouds.__init__-182"><span class="linenos">182</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">blockID</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;blockID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.__init__-183"><a href="#ColorClouds.__init__-183"><span class="linenos">183</span></a>
</span><span id="ColorClouds.__init__-184"><a href="#ColorClouds.__init__-184"><span class="linenos">184</span></a>            <span class="c1"># ETtrace information</span>
</span><span id="ColorClouds.__init__-185"><a href="#ColorClouds.__init__-185"><span class="linenos">185</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ETtrace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;ETtrace&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-186"><a href="#ColorClouds.__init__-186"><span class="linenos">186</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ETtraceHR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;ETtrace_raw&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-187"><a href="#ColorClouds.__init__-187"><span class="linenos">187</span></a>
</span><span id="ColorClouds.__init__-188"><a href="#ColorClouds.__init__-188"><span class="linenos">188</span></a>            <span class="n">NCfile</span> <span class="o">=</span> <span class="n">NSUfile</span>
</span><span id="ColorClouds.__init__-189"><a href="#ColorClouds.__init__-189"><span class="linenos">189</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-190"><a href="#ColorClouds.__init__-190"><span class="linenos">190</span></a>                <span class="n">NCfile</span> <span class="o">+=</span> <span class="n">NMUfile</span>
</span><span id="ColorClouds.__init__-191"><a href="#ColorClouds.__init__-191"><span class="linenos">191</span></a>            
</span><span id="ColorClouds.__init__-192"><a href="#ColorClouds.__init__-192"><span class="linenos">192</span></a>            <span class="c1"># This will associate each block with each file</span>
</span><span id="ColorClouds.__init__-193"><a href="#ColorClouds.__init__-193"><span class="linenos">193</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_filemapping</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="n">fnum</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-194"><a href="#ColorClouds.__init__-194"><span class="linenos">194</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span><span class="p">[</span><span class="n">fnum</span><span class="p">]</span><span class="o">=</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.__init__-195"><a href="#ColorClouds.__init__-195"><span class="linenos">195</span></a>
</span><span id="ColorClouds.__init__-196"><a href="#ColorClouds.__init__-196"><span class="linenos">196</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>  <span class="c1"># this is basis of data (stimLP and stimET)</span>
</span><span id="ColorClouds.__init__-197"><a href="#ColorClouds.__init__-197"><span class="linenos">197</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># # when stim is constructed</span>
</span><span id="ColorClouds.__init__-198"><a href="#ColorClouds.__init__-198"><span class="linenos">198</span></a>
</span><span id="ColorClouds.__init__-199"><a href="#ColorClouds.__init__-199"><span class="linenos">199</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; EYE configuration &quot;&quot;&quot;</span>
</span><span id="ColorClouds.__init__-200"><a href="#ColorClouds.__init__-200"><span class="linenos">200</span></a>            <span class="c1">#if self.eye_config &gt; 0:</span>
</span><span id="ColorClouds.__init__-201"><a href="#ColorClouds.__init__-201"><span class="linenos">201</span></a>            <span class="n">Lpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useLeye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.__init__-202"><a href="#ColorClouds.__init__-202"><span class="linenos">202</span></a>            <span class="n">Rpresent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;useReye&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.__init__-203"><a href="#ColorClouds.__init__-203"><span class="linenos">203</span></a>            <span class="n">LRpresent</span> <span class="o">=</span> <span class="n">Lpresent</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Rpresent</span>
</span><span id="ColorClouds.__init__-204"><a href="#ColorClouds.__init__-204"><span class="linenos">204</span></a>
</span><span id="ColorClouds.__init__-205"><a href="#ColorClouds.__init__-205"><span class="linenos">205</span></a>            <span class="k">if</span> <span class="n">luminance_only</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-206"><a href="#ColorClouds.__init__-206"><span class="linenos">206</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-207"><a href="#ColorClouds.__init__-207"><span class="linenos">207</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reducing stimulus channels (</span><span class="si">%d</span><span class="s2">) to first dimension&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="ColorClouds.__init__-208"><a href="#ColorClouds.__init__-208"><span class="linenos">208</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ColorClouds.__init__-209"><a href="#ColorClouds.__init__-209"><span class="linenos">209</span></a>
</span><span id="ColorClouds.__init__-210"><a href="#ColorClouds.__init__-210"><span class="linenos">210</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-211"><a href="#ColorClouds.__init__-211"><span class="linenos">211</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">2</span>
</span><span id="ColorClouds.__init__-212"><a href="#ColorClouds.__init__-212"><span class="linenos">212</span></a>
</span><span id="ColorClouds.__init__-213"><a href="#ColorClouds.__init__-213"><span class="linenos">213</span></a>            <span class="c1">#if self.time_embed &gt; 0:</span>
</span><span id="ColorClouds.__init__-214"><a href="#ColorClouds.__init__-214"><span class="linenos">214</span></a>            <span class="c1">#    self.dims[3] = self.num_lags</span>
</span><span id="ColorClouds.__init__-215"><a href="#ColorClouds.__init__-215"><span class="linenos">215</span></a>
</span><span id="ColorClouds.__init__-216"><a href="#ColorClouds.__init__-216"><span class="linenos">216</span></a>            <span class="c1">#print(&#39;Stim check:&#39;, folded_lags, self.dims)</span>
</span><span id="ColorClouds.__init__-217"><a href="#ColorClouds.__init__-217"><span class="linenos">217</span></a>
</span><span id="ColorClouds.__init__-218"><a href="#ColorClouds.__init__-218"><span class="linenos">218</span></a>            <span class="c1">#self.unit_ids.append(self.NC + np.asarray(range(NCfile)))</span>
</span><span id="ColorClouds.__init__-219"><a href="#ColorClouds.__init__-219"><span class="linenos">219</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NCfile</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-220"><a href="#ColorClouds.__init__-220"><span class="linenos">220</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">+=</span> <span class="n">NCfile</span>
</span><span id="ColorClouds.__init__-221"><a href="#ColorClouds.__init__-221"><span class="linenos">221</span></a>
</span><span id="ColorClouds.__init__-222"><a href="#ColorClouds.__init__-222"><span class="linenos">222</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_saccades</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-223"><a href="#ColorClouds.__init__-223"><span class="linenos">223</span></a>                <span class="n">sacc_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;sacc_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-224"><a href="#ColorClouds.__init__-224"><span class="linenos">224</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sacc_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-225"><a href="#ColorClouds.__init__-225"><span class="linenos">225</span></a>                    <span class="n">sacc_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># convert to python so range works</span>
</span><span id="ColorClouds.__init__-226"><a href="#ColorClouds.__init__-226"><span class="linenos">226</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-227"><a href="#ColorClouds.__init__-227"><span class="linenos">227</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ignoring sacc_inds. Assuming not valid&quot;</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-228"><a href="#ColorClouds.__init__-228"><span class="linenos">228</span></a>                    <span class="n">sacc_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ColorClouds.__init__-229"><a href="#ColorClouds.__init__-229"><span class="linenos">229</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sacc_inds</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-230"><a href="#ColorClouds.__init__-230"><span class="linenos">230</span></a>
</span><span id="ColorClouds.__init__-231"><a href="#ColorClouds.__init__-231"><span class="linenos">231</span></a>            <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;valid_data&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>  <span class="c1">#range(self.NT)  # default -- to be changed at end of init</span>
</span><span id="ColorClouds.__init__-232"><a href="#ColorClouds.__init__-232"><span class="linenos">232</span></a>            <span class="k">if</span> <span class="n">valid_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>   <span class="c1"># Make version-read proof</span>
</span><span id="ColorClouds.__init__-233"><a href="#ColorClouds.__init__-233"><span class="linenos">233</span></a>                <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">valid_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds.__init__-234"><a href="#ColorClouds.__init__-234"><span class="linenos">234</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: Old-stype valid_inds saved. Transposing&#39;</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-235"><a href="#ColorClouds.__init__-235"><span class="linenos">235</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-236"><a href="#ColorClouds.__init__-236"><span class="linenos">236</span></a>                <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">valid_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.__init__-237"><a href="#ColorClouds.__init__-237"><span class="linenos">237</span></a>            <span class="n">tcount</span> <span class="o">+=</span> <span class="n">NT</span>
</span><span id="ColorClouds.__init__-238"><a href="#ColorClouds.__init__-238"><span class="linenos">238</span></a>            <span class="c1"># make larger fix_n, valid_inds, sacc_inds, block_inds as self</span>
</span><span id="ColorClouds.__init__-239"><a href="#ColorClouds.__init__-239"><span class="linenos">239</span></a>
</span><span id="ColorClouds.__init__-240"><a href="#ColorClouds.__init__-240"><span class="linenos">240</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>  <span class="o">=</span> <span class="n">tcount</span>
</span><span id="ColorClouds.__init__-241"><a href="#ColorClouds.__init__-241"><span class="linenos">241</span></a>
</span><span id="ColorClouds.__init__-242"><a href="#ColorClouds.__init__-242"><span class="linenos">242</span></a>        <span class="c1"># For now let&#39;s just debug with one file</span>
</span><span id="ColorClouds.__init__-243"><a href="#ColorClouds.__init__-243"><span class="linenos">243</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-244"><a href="#ColorClouds.__init__-244"><span class="linenos">244</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: currently ignoring multiple files&#39;</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-245"><a href="#ColorClouds.__init__-245"><span class="linenos">245</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">valid_inds</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-246"><a href="#ColorClouds.__init__-246"><span class="linenos">246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span> <span class="o">=</span> <span class="n">LRpresent</span>
</span><span id="ColorClouds.__init__-247"><a href="#ColorClouds.__init__-247"><span class="linenos">247</span></a>
</span><span id="ColorClouds.__init__-248"><a href="#ColorClouds.__init__-248"><span class="linenos">248</span></a>        <span class="c1"># Make binocular gain term</span>
</span><span id="ColorClouds.__init__-249"><a href="#ColorClouds.__init__-249"><span class="linenos">249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">LRpresent</span><span class="p">),</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="ColorClouds.__init__-250"><a href="#ColorClouds.__init__-250"><span class="linenos">250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="ColorClouds.__init__-251"><a href="#ColorClouds.__init__-251"><span class="linenos">251</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="ColorClouds.__init__-252"><a href="#ColorClouds.__init__-252"><span class="linenos">252</span></a>
</span><span id="ColorClouds.__init__-253"><a href="#ColorClouds.__init__-253"><span class="linenos">253</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-254"><a href="#ColorClouds.__init__-254"><span class="linenos">254</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data into memory...&quot;</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-255"><a href="#ColorClouds.__init__-255"><span class="linenos">255</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">preload_numpy</span><span class="p">()</span>
</span><span id="ColorClouds.__init__-256"><a href="#ColorClouds.__init__-256"><span class="linenos">256</span></a>
</span><span id="ColorClouds.__init__-257"><a href="#ColorClouds.__init__-257"><span class="linenos">257</span></a>            <span class="k">if</span> <span class="n">which_stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-258"><a href="#ColorClouds.__init__-258"><span class="linenos">258</span></a>                <span class="c1">#assert num_lags is not None, &quot;Need to specify num_lags and other stim params&quot;</span>
</span><span id="ColorClouds.__init__-259"><a href="#ColorClouds.__init__-259"><span class="linenos">259</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">assemble_stimulus</span><span class="p">(</span> <span class="n">which_stim</span><span class="o">=</span><span class="n">which_stim</span><span class="p">,</span> 
</span><span id="ColorClouds.__init__-260"><a href="#ColorClouds.__init__-260"><span class="linenos">260</span></a>                    <span class="n">time_embed</span><span class="o">=</span><span class="n">time_embed</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">num_lags</span><span class="p">,</span> <span class="n">stim_crop</span><span class="o">=</span><span class="n">stim_crop</span> <span class="p">)</span>
</span><span id="ColorClouds.__init__-261"><a href="#ColorClouds.__init__-261"><span class="linenos">261</span></a>
</span><span id="ColorClouds.__init__-262"><a href="#ColorClouds.__init__-262"><span class="linenos">262</span></a>            <span class="c1"># Have data_filters represend used_inds (in case it gets through)</span>
</span><span id="ColorClouds.__init__-263"><a href="#ColorClouds.__init__-263"><span class="linenos">263</span></a>            <span class="n">unified_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-264"><a href="#ColorClouds.__init__-264"><span class="linenos">264</span></a>            <span class="n">unified_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="ColorClouds.__init__-265"><a href="#ColorClouds.__init__-265"><span class="linenos">265</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*=</span> <span class="n">unified_df</span>
</span><span id="ColorClouds.__init__-266"><a href="#ColorClouds.__init__-266"><span class="linenos">266</span></a>
</span><span id="ColorClouds.__init__-267"><a href="#ColorClouds.__init__-267"><span class="linenos">267</span></a>        <span class="c1">### Process experiment to include relevant eye config</span>
</span><span id="ColorClouds.__init__-268"><a href="#ColorClouds.__init__-268"><span class="linenos">268</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># then want to return experiment part consistent with eye config</span>
</span><span id="ColorClouds.__init__-269"><a href="#ColorClouds.__init__-269"><span class="linenos">269</span></a>            <span class="n">eye_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LRpresent</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">eye_config</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.__init__-270"><a href="#ColorClouds.__init__-270"><span class="linenos">270</span></a>            <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">eye_val</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">eye_val</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
</span><span id="ColorClouds.__init__-271"><a href="#ColorClouds.__init__-271"><span class="linenos">271</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eye_val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">):</span>
</span><span id="ColorClouds.__init__-272"><a href="#ColorClouds.__init__-272"><span class="linenos">272</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;EYE CONFIG WARNING: non-contiguous blocks of correct eye position&quot;</span> <span class="p">)</span>
</span><span id="ColorClouds.__init__-273"><a href="#ColorClouds.__init__-273"><span class="linenos">273</span></a>                <span class="n">t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">eye_val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
</span><span id="ColorClouds.__init__-274"><a href="#ColorClouds.__init__-274"><span class="linenos">274</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Taking first contiguous block up to </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">t1</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-275"><a href="#ColorClouds.__init__-275"><span class="linenos">275</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-276"><a href="#ColorClouds.__init__-276"><span class="linenos">276</span></a>            <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span><span id="ColorClouds.__init__-277"><a href="#ColorClouds.__init__-277"><span class="linenos">277</span></a>
</span><span id="ColorClouds.__init__-278"><a href="#ColorClouds.__init__-278"><span class="linenos">278</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">=</span> <span class="n">t0</span>
</span><span id="ColorClouds.__init__-279"><a href="#ColorClouds.__init__-279"><span class="linenos">279</span></a>        <span class="k">if</span> <span class="n">maxT</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-280"><a href="#ColorClouds.__init__-280"><span class="linenos">280</span></a>            <span class="n">t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span> <span class="n">t0</span><span class="o">+</span><span class="n">maxT</span><span class="p">,</span> <span class="n">t1</span> <span class="p">)</span>
</span><span id="ColorClouds.__init__-281"><a href="#ColorClouds.__init__-281"><span class="linenos">281</span></a>        <span class="n">ts</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-282"><a href="#ColorClouds.__init__-282"><span class="linenos">282</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;T-range:&#39;</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-283"><a href="#ColorClouds.__init__-283"><span class="linenos">283</span></a>
</span><span id="ColorClouds.__init__-284"><a href="#ColorClouds.__init__-284"><span class="linenos">284</span></a>        <span class="c1"># Save for potential future adjustments of signal</span>
</span><span id="ColorClouds.__init__-285"><a href="#ColorClouds.__init__-285"><span class="linenos">285</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">startT</span> <span class="o">=</span> <span class="n">t0</span>
</span><span id="ColorClouds.__init__-286"><a href="#ColorClouds.__init__-286"><span class="linenos">286</span></a>        
</span><span id="ColorClouds.__init__-287"><a href="#ColorClouds.__init__-287"><span class="linenos">287</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-288"><a href="#ColorClouds.__init__-288"><span class="linenos">288</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Trimming experiment </span><span class="si">%d</span><span class="s2">-&gt;</span><span class="si">%d</span><span class="s2"> time points based on eye_config and Tmax&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span> <span class="p">)</span>
</span><span id="ColorClouds.__init__-289"><a href="#ColorClouds.__init__-289"><span class="linenos">289</span></a>
</span><span id="ColorClouds.__init__-290"><a href="#ColorClouds.__init__-290"><span class="linenos">290</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds.__init__-291"><a href="#ColorClouds.__init__-291"><span class="linenos">291</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-292"><a href="#ColorClouds.__init__-292"><span class="linenos">292</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds.__init__-293"><a href="#ColorClouds.__init__-293"><span class="linenos">293</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds.__init__-294"><a href="#ColorClouds.__init__-294"><span class="linenos">294</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds.__init__-295"><a href="#ColorClouds.__init__-295"><span class="linenos">295</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span>
</span><span id="ColorClouds.__init__-296"><a href="#ColorClouds.__init__-296"><span class="linenos">296</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular_gain</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds.__init__-297"><a href="#ColorClouds.__init__-297"><span class="linenos">297</span></a>
</span><span id="ColorClouds.__init__-298"><a href="#ColorClouds.__init__-298"><span class="linenos">298</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-299"><a href="#ColorClouds.__init__-299"><span class="linenos">299</span></a>
</span><span id="ColorClouds.__init__-300"><a href="#ColorClouds.__init__-300"><span class="linenos">300</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">&gt;=</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">&lt;</span> <span class="n">t1</span><span class="p">)]</span> <span class="o">-</span> <span class="n">t0</span>
</span><span id="ColorClouds.__init__-301"><a href="#ColorClouds.__init__-301"><span class="linenos">301</span></a>
</span><span id="ColorClouds.__init__-302"><a href="#ColorClouds.__init__-302"><span class="linenos">302</span></a>            <span class="c1"># Only keep valid blocks/saccades</span>
</span><span id="ColorClouds.__init__-303"><a href="#ColorClouds.__init__-303"><span class="linenos">303</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">blk_inds</span> <span class="o">-</span> <span class="n">t0</span> 
</span><span id="ColorClouds.__init__-304"><a href="#ColorClouds.__init__-304"><span class="linenos">304</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">blk_inds</span><span class="p">[</span> <span class="n">blk_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds.__init__-305"><a href="#ColorClouds.__init__-305"><span class="linenos">305</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">blk_inds</span><span class="p">[</span> <span class="n">blk_inds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds.__init__-306"><a href="#ColorClouds.__init__-306"><span class="linenos">306</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-307"><a href="#ColorClouds.__init__-307"><span class="linenos">307</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">-</span> <span class="n">t0</span>
</span><span id="ColorClouds.__init__-308"><a href="#ColorClouds.__init__-308"><span class="linenos">308</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>  
</span><span id="ColorClouds.__init__-309"><a href="#ColorClouds.__init__-309"><span class="linenos">309</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span> <span class="n">sacc_inds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="p">:]</span>  
</span><span id="ColorClouds.__init__-310"><a href="#ColorClouds.__init__-310"><span class="linenos">310</span></a>
</span><span id="ColorClouds.__init__-311"><a href="#ColorClouds.__init__-311"><span class="linenos">311</span></a>        <span class="c1">### Process blocks and fixations/saccades</span>
</span><span id="ColorClouds.__init__-312"><a href="#ColorClouds.__init__-312"><span class="linenos">312</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="ColorClouds.__init__-313"><a href="#ColorClouds.__init__-313"><span class="linenos">313</span></a>            <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="ColorClouds.__init__-314"><a href="#ColorClouds.__init__-314"><span class="linenos">314</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="p">)</span>
</span><span id="ColorClouds.__init__-315"><a href="#ColorClouds.__init__-315"><span class="linenos">315</span></a>        <span class="c1"># go to end of time range if extends beyond block range</span>
</span><span id="ColorClouds.__init__-316"><a href="#ColorClouds.__init__-316"><span class="linenos">316</span></a>        <span class="k">if</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-317"><a href="#ColorClouds.__init__-317"><span class="linenos">317</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Extending final block at &#39;</span><span class="p">,</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-318"><a href="#ColorClouds.__init__-318"><span class="linenos">318</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">))</span>
</span><span id="ColorClouds.__init__-319"><a href="#ColorClouds.__init__-319"><span class="linenos">319</span></a>            <span class="c1"># This is to fix zeroing of last block in fix_n.... (I think?)</span>
</span><span id="ColorClouds.__init__-320"><a href="#ColorClouds.__init__-320"><span class="linenos">320</span></a>
</span><span id="ColorClouds.__init__-321"><a href="#ColorClouds.__init__-321"><span class="linenos">321</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-322"><a href="#ColorClouds.__init__-322"><span class="linenos">322</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">process_fixations</span><span class="p">()</span>
</span><span id="ColorClouds.__init__-323"><a href="#ColorClouds.__init__-323"><span class="linenos">323</span></a>
</span><span id="ColorClouds.__init__-324"><a href="#ColorClouds.__init__-324"><span class="linenos">324</span></a>        <span class="c1">### Construct drift term if relevant</span>
</span><span id="ColorClouds.__init__-325"><a href="#ColorClouds.__init__-325"><span class="linenos">325</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-326"><a href="#ColorClouds.__init__-326"><span class="linenos">326</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ColorClouds.__init__-327"><a href="#ColorClouds.__init__-327"><span class="linenos">327</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-328"><a href="#ColorClouds.__init__-328"><span class="linenos">328</span></a>            <span class="n">NBL</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-329"><a href="#ColorClouds.__init__-329"><span class="linenos">329</span></a>            <span class="n">Nanchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">NBL</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-330"><a href="#ColorClouds.__init__-330"><span class="linenos">330</span></a>            <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-331"><a href="#ColorClouds.__init__-331"><span class="linenos">331</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nanchors</span><span class="p">):</span>
</span><span id="ColorClouds.__init__-332"><a href="#ColorClouds.__init__-332"><span class="linenos">332</span></a>                <span class="n">anchors</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_interval</span><span class="o">*</span><span class="n">bb</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.__init__-333"><a href="#ColorClouds.__init__-333"><span class="linenos">333</span></a>            <span class="c1">#self.Xdrift = utils.design_matrix_drift( self.NT, anchors, zero_left=False, const_right=True)</span>
</span><span id="ColorClouds.__init__-334"><a href="#ColorClouds.__init__-334"><span class="linenos">334</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-335"><a href="#ColorClouds.__init__-335"><span class="linenos">335</span></a>
</span><span id="ColorClouds.__init__-336"><a href="#ColorClouds.__init__-336"><span class="linenos">336</span></a>        <span class="c1"># Write all relevant data (other than stim) to pytorch tensors after organized</span>
</span><span id="ColorClouds.__init__-337"><a href="#ColorClouds.__init__-337"><span class="linenos">337</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="p">)</span>
</span><span id="ColorClouds.__init__-338"><a href="#ColorClouds.__init__-338"><span class="linenos">338</span></a>
</span><span id="ColorClouds.__init__-339"><a href="#ColorClouds.__init__-339"><span class="linenos">339</span></a>        <span class="c1"># Cross-validation setup</span>
</span><span id="ColorClouds.__init__-340"><a href="#ColorClouds.__init__-340"><span class="linenos">340</span></a>        <span class="c1"># Develop default train, validation, and test datasets </span>
</span><span id="ColorClouds.__init__-341"><a href="#ColorClouds.__init__-341"><span class="linenos">341</span></a>        <span class="c1">#self.crossval_setup()</span>
</span><span id="ColorClouds.__init__-342"><a href="#ColorClouds.__init__-342"><span class="linenos">342</span></a>        <span class="c1">### SHOULD MAKE THIS INTO A FUNCTION THAT CAN BE RE-APPLIEd</span>
</span><span id="ColorClouds.__init__-343"><a href="#ColorClouds.__init__-343"><span class="linenos">343</span></a>        <span class="n">vblks</span><span class="p">,</span> <span class="n">trblks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-344"><a href="#ColorClouds.__init__-344"><span class="linenos">344</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ColorClouds.__init__-345"><a href="#ColorClouds.__init__-345"><span class="linenos">345</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">trblks</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-346"><a href="#ColorClouds.__init__-346"><span class="linenos">346</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="ColorClouds.__init__-347"><a href="#ColorClouds.__init__-347"><span class="linenos">347</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ColorClouds.__init__-348"><a href="#ColorClouds.__init__-348"><span class="linenos">348</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">vblks</span><span class="p">:</span>
</span><span id="ColorClouds.__init__-349"><a href="#ColorClouds.__init__-349"><span class="linenos">349</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="ColorClouds.__init__-350"><a href="#ColorClouds.__init__-350"><span class="linenos">350</span></a>
</span><span id="ColorClouds.__init__-351"><a href="#ColorClouds.__init__-351"><span class="linenos">351</span></a>        <span class="c1"># Eliminate from time point any times when the datafilers are all zero</span>
</span><span id="ColorClouds.__init__-352"><a href="#ColorClouds.__init__-352"><span class="linenos">352</span></a>        <span class="c1"># this will include all places where used-inds is zero as well</span>
</span><span id="ColorClouds.__init__-353"><a href="#ColorClouds.__init__-353"><span class="linenos">353</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-354"><a href="#ColorClouds.__init__-354"><span class="linenos">354</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="ColorClouds.__init__-355"><a href="#ColorClouds.__init__-355"><span class="linenos">355</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">trblks</span>
</span><span id="ColorClouds.__init__-356"><a href="#ColorClouds.__init__-356"><span class="linenos">356</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">vblks</span>
</span></pre></div>


            <div class="docstring"><p>Constructor options</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>filenames (list):</strong>  list of strings with filenames (without .mat) to load</li>
<li><strong>datadir (str):</strong>  directory where data is stored</li>
<li><strong>time_embed (int):</strong>  0, 1, or 2. 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</li>
<li><strong>num_lags (int):</strong>  number of lags to use in time-embedding</li>
<li><strong>include_MUs (bool):</strong>  whether to include MUs in the dataset</li>
<li><strong>drift_interval (int):</strong>  number of blocks to include in drift term</li>
<li><strong>trial_sample (bool):</strong>  whether to sample trials randomly</li>
<li><strong>device (torch.device):</strong>  device to store data on</li>
<li><strong>which_stim (str or int):</strong>  'et' or 0, or 1 for lam, but default assemble later</li>
<li><strong>stim_crop (list):</strong>  should be list/array of 4 numbers representing inds of edges</li>
<li><strong>luminance_only (bool):</strong>  whether to use only luminance channel</li>
<li><strong>ignore_saccades (bool):</strong>  whether to ignore saccades</li>
<li><strong>folded_lags (bool):</strong>  whether to fold lags into channels</li>
<li><strong>binocular (bool):</strong>  whether to include separate filters for each eye</li>
<li><strong>eye_config (int):</strong>  0 = all, 1, -1, and 2 are options (2 = binocular)</li>
<li><strong>maxT (int):</strong>  maximum number of time points to include</li>
</ul>
</div>


                            </div>
                            <div id="ColorClouds.stim_crop" class="classattr">
                                <div class="attr variable">
            <span class="name">stim_crop</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.stim_crop"></a>
    
    

                            </div>
                            <div id="ColorClouds.folded_lags" class="classattr">
                                <div class="attr variable">
            <span class="name">folded_lags</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.folded_lags"></a>
    
    

                            </div>
                            <div id="ColorClouds.eye_config" class="classattr">
                                <div class="attr variable">
            <span class="name">eye_config</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.eye_config"></a>
    
    

                            </div>
                            <div id="ColorClouds.binocular" class="classattr">
                                <div class="attr variable">
            <span class="name">binocular</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.binocular"></a>
    
    

                            </div>
                            <div id="ColorClouds.luminance_only" class="classattr">
                                <div class="attr variable">
            <span class="name">luminance_only</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.luminance_only"></a>
    
    

                            </div>
                            <div id="ColorClouds.generate_Xfix" class="classattr">
                                <div class="attr variable">
            <span class="name">generate_Xfix</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.generate_Xfix"></a>
    
    

                            </div>
                            <div id="ColorClouds.output_separate_eye_stim" class="classattr">
                                <div class="attr variable">
            <span class="name">output_separate_eye_stim</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.output_separate_eye_stim"></a>
    
    

                            </div>
                            <div id="ColorClouds.start_t" class="classattr">
                                <div class="attr variable">
            <span class="name">start_t</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.start_t"></a>
    
    

                            </div>
                            <div id="ColorClouds.drift_interval" class="classattr">
                                <div class="attr variable">
            <span class="name">drift_interval</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.drift_interval"></a>
    
    

                            </div>
                            <div id="ColorClouds.fhandles" class="classattr">
                                <div class="attr variable">
            <span class="name">fhandles</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.fhandles"></a>
    
    

                            </div>
                            <div id="ColorClouds.avRs" class="classattr">
                                <div class="attr variable">
            <span class="name">avRs</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.avRs"></a>
    
    

                            </div>
                            <div id="ColorClouds.fix_n" class="classattr">
                                <div class="attr variable">
            <span class="name">fix_n</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.fix_n"></a>
    
    

                            </div>
                            <div id="ColorClouds.used_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">used_inds</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.used_inds"></a>
    
    

                            </div>
                            <div id="ColorClouds.NT" class="classattr">
                                <div class="attr variable">
            <span class="name">NT</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.NT"></a>
    
    

                            </div>
                            <div id="ColorClouds.num_blks" class="classattr">
                                <div class="attr variable">
            <span class="name">num_blks</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.num_blks"></a>
    
    

                            </div>
                            <div id="ColorClouds.data_threshold" class="classattr">
                                <div class="attr variable">
            <span class="name">data_threshold</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.data_threshold"></a>
    
    

                            </div>
                            <div id="ColorClouds.file_index" class="classattr">
                                <div class="attr variable">
            <span class="name">file_index</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.file_index"></a>
    
    

                            </div>
                            <div id="ColorClouds.sacc_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">sacc_inds</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.sacc_inds"></a>
    
    

                            </div>
                            <div id="ColorClouds.stim_shifts" class="classattr">
                                <div class="attr variable">
            <span class="name">stim_shifts</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.stim_shifts"></a>
    
    

                            </div>
                            <div id="ColorClouds.LRpresent" class="classattr">
                                <div class="attr variable">
            <span class="name">LRpresent</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.LRpresent"></a>
    
    

                            </div>
                            <div id="ColorClouds.binocular_gain" class="classattr">
                                <div class="attr variable">
            <span class="name">binocular_gain</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.binocular_gain"></a>
    
    

                            </div>
                            <div id="ColorClouds.startT" class="classattr">
                                <div class="attr variable">
            <span class="name">startT</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.startT"></a>
    
    

                            </div>
                            <div id="ColorClouds.train_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">train_inds</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.train_inds"></a>
    
    

                            </div>
                            <div id="ColorClouds.val_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">val_inds</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.val_inds"></a>
    
    

                            </div>
                            <div id="ColorClouds.train_blks" class="classattr">
                                <div class="attr variable">
            <span class="name">train_blks</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.train_blks"></a>
    
    

                            </div>
                            <div id="ColorClouds.val_blks" class="classattr">
                                <div class="attr variable">
            <span class="name">val_blks</span>

        
    </div>
    <a class="headerlink" href="#ColorClouds.val_blks"></a>
    
    

                            </div>
                            <div id="ColorClouds.preload_numpy" class="classattr">
                                        <input id="ColorClouds.preload_numpy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">preload_numpy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ColorClouds.preload_numpy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ColorClouds.preload_numpy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ColorClouds.preload_numpy-359"><a href="#ColorClouds.preload_numpy-359"><span class="linenos">359</span></a>    <span class="k">def</span> <span class="nf">preload_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ColorClouds.preload_numpy-360"><a href="#ColorClouds.preload_numpy-360"><span class="linenos">360</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds.preload_numpy-361"><a href="#ColorClouds.preload_numpy-361"><span class="linenos">361</span></a><span class="sd">        Note this loads stimulus but does not time-embed</span>
</span><span id="ColorClouds.preload_numpy-362"><a href="#ColorClouds.preload_numpy-362"><span class="linenos">362</span></a><span class="sd">        </span>
</span><span id="ColorClouds.preload_numpy-363"><a href="#ColorClouds.preload_numpy-363"><span class="linenos">363</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds.preload_numpy-364"><a href="#ColorClouds.preload_numpy-364"><span class="linenos">364</span></a><span class="sd">            None</span>
</span><span id="ColorClouds.preload_numpy-365"><a href="#ColorClouds.preload_numpy-365"><span class="linenos">365</span></a>
</span><span id="ColorClouds.preload_numpy-366"><a href="#ColorClouds.preload_numpy-366"><span class="linenos">366</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds.preload_numpy-367"><a href="#ColorClouds.preload_numpy-367"><span class="linenos">367</span></a><span class="sd">            None</span>
</span><span id="ColorClouds.preload_numpy-368"><a href="#ColorClouds.preload_numpy-368"><span class="linenos">368</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds.preload_numpy-369"><a href="#ColorClouds.preload_numpy-369"><span class="linenos">369</span></a>
</span><span id="ColorClouds.preload_numpy-370"><a href="#ColorClouds.preload_numpy-370"><span class="linenos">370</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span><span id="ColorClouds.preload_numpy-371"><a href="#ColorClouds.preload_numpy-371"><span class="linenos">371</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="ColorClouds.preload_numpy-372"><a href="#ColorClouds.preload_numpy-372"><span class="linenos">372</span></a><span class="sd">        Pre-allocate memory for data</span>
</span><span id="ColorClouds.preload_numpy-373"><a href="#ColorClouds.preload_numpy-373"><span class="linenos">373</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ColorClouds.preload_numpy-374"><a href="#ColorClouds.preload_numpy-374"><span class="linenos">374</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.preload_numpy-375"><a href="#ColorClouds.preload_numpy-375"><span class="linenos">375</span></a>        <span class="k">if</span> <span class="s1">&#39;stimET&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="ColorClouds.preload_numpy-376"><a href="#ColorClouds.preload_numpy-376"><span class="linenos">376</span></a>            <span class="c1"># Check to see if 1-d or 2-d eye tracking</span>
</span><span id="ColorClouds.preload_numpy-377"><a href="#ColorClouds.preload_numpy-377"><span class="linenos">377</span></a>            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:</span><span class="mi">100</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds.preload_numpy-378"><a href="#ColorClouds.preload_numpy-378"><span class="linenos">378</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="ColorClouds.preload_numpy-379"><a href="#ColorClouds.preload_numpy-379"><span class="linenos">379</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ET stimulus is 1-d bars.&quot;</span><span class="p">)</span>
</span><span id="ColorClouds.preload_numpy-380"><a href="#ColorClouds.preload_numpy-380"><span class="linenos">380</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.preload_numpy-381"><a href="#ColorClouds.preload_numpy-381"><span class="linenos">381</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.preload_numpy-382"><a href="#ColorClouds.preload_numpy-382"><span class="linenos">382</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.preload_numpy-383"><a href="#ColorClouds.preload_numpy-383"><span class="linenos">383</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.preload_numpy-384"><a href="#ColorClouds.preload_numpy-384"><span class="linenos">384</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ColorClouds.preload_numpy-385"><a href="#ColorClouds.preload_numpy-385"><span class="linenos">385</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Missing ETstimulus&#39;</span><span class="p">)</span>
</span><span id="ColorClouds.preload_numpy-386"><a href="#ColorClouds.preload_numpy-386"><span class="linenos">386</span></a>
</span><span id="ColorClouds.preload_numpy-387"><a href="#ColorClouds.preload_numpy-387"><span class="linenos">387</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.preload_numpy-388"><a href="#ColorClouds.preload_numpy-388"><span class="linenos">388</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.preload_numpy-389"><a href="#ColorClouds.preload_numpy-389"><span class="linenos">389</span></a>        <span class="c1">#self.eyepos = np.zeros([NT, 2], dtype=np.float32)</span>
</span><span id="ColorClouds.preload_numpy-390"><a href="#ColorClouds.preload_numpy-390"><span class="linenos">390</span></a>        <span class="c1">#self.frame_times = np.zeros([NT,1], dtype=np.float32)</span>
</span><span id="ColorClouds.preload_numpy-391"><a href="#ColorClouds.preload_numpy-391"><span class="linenos">391</span></a>
</span><span id="ColorClouds.preload_numpy-392"><a href="#ColorClouds.preload_numpy-392"><span class="linenos">392</span></a>        <span class="n">t_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds.preload_numpy-393"><a href="#ColorClouds.preload_numpy-393"><span class="linenos">393</span></a>        <span class="n">unit_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds.preload_numpy-394"><a href="#ColorClouds.preload_numpy-394"><span class="linenos">394</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">)):</span>
</span><span id="ColorClouds.preload_numpy-395"><a href="#ColorClouds.preload_numpy-395"><span class="linenos">395</span></a>            
</span><span id="ColorClouds.preload_numpy-396"><a href="#ColorClouds.preload_numpy-396"><span class="linenos">396</span></a>            <span class="n">fhandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="ColorClouds.preload_numpy-397"><a href="#ColorClouds.preload_numpy-397"><span class="linenos">397</span></a>            <span class="n">sz</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="ColorClouds.preload_numpy-398"><a href="#ColorClouds.preload_numpy-398"><span class="linenos">398</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_counter</span><span class="p">,</span> <span class="n">t_counter</span><span class="o">+</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="ColorClouds.preload_numpy-399"><a href="#ColorClouds.preload_numpy-399"><span class="linenos">399</span></a>            <span class="c1">#inds = self.stim_indices[expt][stim][&#39;inds&#39;]</span>
</span><span id="ColorClouds.preload_numpy-400"><a href="#ColorClouds.preload_numpy-400"><span class="linenos">400</span></a>            <span class="c1">#self.stim[inds, ...] = np.transpose( np.array(fhandle[self.stimname], dtype=np.float32), axes=[0,3,1,2])</span>
</span><span id="ColorClouds.preload_numpy-401"><a href="#ColorClouds.preload_numpy-401"><span class="linenos">401</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binocular</span><span class="p">:</span>
</span><span id="ColorClouds.preload_numpy-402"><a href="#ColorClouds.preload_numpy-402"><span class="linenos">402</span></a>                <span class="n">Leye</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="ColorClouds.preload_numpy-403"><a href="#ColorClouds.preload_numpy-403"><span class="linenos">403</span></a>                <span class="n">Reye</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LRpresent</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds.preload_numpy-404"><a href="#ColorClouds.preload_numpy-404"><span class="linenos">404</span></a>                <span class="c1">#Leye = inds[np.where(self.LRpresent[inds] != 2)[0]]</span>
</span><span id="ColorClouds.preload_numpy-405"><a href="#ColorClouds.preload_numpy-405"><span class="linenos">405</span></a>                <span class="c1">#Reye = inds[np.where(self.LRpresent[inds] != 1)[0]]</span>
</span><span id="ColorClouds.preload_numpy-406"><a href="#ColorClouds.preload_numpy-406"><span class="linenos">406</span></a>                <span class="c1">#print(len(Leye), len(Reye))</span>
</span><span id="ColorClouds.preload_numpy-407"><a href="#ColorClouds.preload_numpy-407"><span class="linenos">407</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="ColorClouds.preload_numpy-408"><a href="#ColorClouds.preload_numpy-408"><span class="linenos">408</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds.preload_numpy-409"><a href="#ColorClouds.preload_numpy-409"><span class="linenos">409</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds.preload_numpy-410"><a href="#ColorClouds.preload_numpy-410"><span class="linenos">410</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.preload_numpy-411"><a href="#ColorClouds.preload_numpy-411"><span class="linenos">411</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds.preload_numpy-412"><a href="#ColorClouds.preload_numpy-412"><span class="linenos">412</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds.preload_numpy-413"><a href="#ColorClouds.preload_numpy-413"><span class="linenos">413</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.preload_numpy-414"><a href="#ColorClouds.preload_numpy-414"><span class="linenos">414</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="ColorClouds.preload_numpy-415"><a href="#ColorClouds.preload_numpy-415"><span class="linenos">415</span></a>                    <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds.preload_numpy-416"><a href="#ColorClouds.preload_numpy-416"><span class="linenos">416</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="ColorClouds.preload_numpy-417"><a href="#ColorClouds.preload_numpy-417"><span class="linenos">417</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="ColorClouds.preload_numpy-418"><a href="#ColorClouds.preload_numpy-418"><span class="linenos">418</span></a>                    <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds.preload_numpy-419"><a href="#ColorClouds.preload_numpy-419"><span class="linenos">419</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="ColorClouds.preload_numpy-420"><a href="#ColorClouds.preload_numpy-420"><span class="linenos">420</span></a>
</span><span id="ColorClouds.preload_numpy-421"><a href="#ColorClouds.preload_numpy-421"><span class="linenos">421</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.preload_numpy-422"><a href="#ColorClouds.preload_numpy-422"><span class="linenos">422</span></a>                        <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="ColorClouds.preload_numpy-423"><a href="#ColorClouds.preload_numpy-423"><span class="linenos">423</span></a>                        <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Leye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds.preload_numpy-424"><a href="#ColorClouds.preload_numpy-424"><span class="linenos">424</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="ColorClouds.preload_numpy-425"><a href="#ColorClouds.preload_numpy-425"><span class="linenos">425</span></a>                        <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:,</span> <span class="o">...</span><span class="p">])</span>
</span><span id="ColorClouds.preload_numpy-426"><a href="#ColorClouds.preload_numpy-426"><span class="linenos">426</span></a>                        <span class="n">stim_tmp</span><span class="p">[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">Reye</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds.preload_numpy-427"><a href="#ColorClouds.preload_numpy-427"><span class="linenos">427</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span> <span class="c1"># this might not be necessary</span>
</span><span id="ColorClouds.preload_numpy-428"><a href="#ColorClouds.preload_numpy-428"><span class="linenos">428</span></a>                        <span class="c1">#self.stimET[Leye, np.arange(3), ...] = np.array(fhandle[&#39;stimET&#39;], dtype=np.float32)[Leye, ...]</span>
</span><span id="ColorClouds.preload_numpy-429"><a href="#ColorClouds.preload_numpy-429"><span class="linenos">429</span></a>                        <span class="c1">#self.stimET[Reye, np.arange(3,6), ...] = np.array(fhandle[&#39;stimET&#39;], dtype=np.float32)[Reye, ...]</span>
</span><span id="ColorClouds.preload_numpy-430"><a href="#ColorClouds.preload_numpy-430"><span class="linenos">430</span></a>                        
</span><span id="ColorClouds.preload_numpy-431"><a href="#ColorClouds.preload_numpy-431"><span class="linenos">431</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Monocular</span>
</span><span id="ColorClouds.preload_numpy-432"><a href="#ColorClouds.preload_numpy-432"><span class="linenos">432</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">:</span>
</span><span id="ColorClouds.preload_numpy-433"><a href="#ColorClouds.preload_numpy-433"><span class="linenos">433</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds.preload_numpy-434"><a href="#ColorClouds.preload_numpy-434"><span class="linenos">434</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.preload_numpy-435"><a href="#ColorClouds.preload_numpy-435"><span class="linenos">435</span></a>                        <span class="c1">#print(np.array(fhandle[&#39;stimET&#39;], dtype=np.float32).shape, self.stimET[inds, 0, ...].shape)</span>
</span><span id="ColorClouds.preload_numpy-436"><a href="#ColorClouds.preload_numpy-436"><span class="linenos">436</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds.preload_numpy-437"><a href="#ColorClouds.preload_numpy-437"><span class="linenos">437</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.preload_numpy-438"><a href="#ColorClouds.preload_numpy-438"><span class="linenos">438</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.preload_numpy-439"><a href="#ColorClouds.preload_numpy-439"><span class="linenos">439</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.preload_numpy-440"><a href="#ColorClouds.preload_numpy-440"><span class="linenos">440</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.preload_numpy-441"><a href="#ColorClouds.preload_numpy-441"><span class="linenos">441</span></a>
</span><span id="ColorClouds.preload_numpy-442"><a href="#ColorClouds.preload_numpy-442"><span class="linenos">442</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Robs and DATAFILTERS&quot;&quot;&quot;</span>
</span><span id="ColorClouds.preload_numpy-443"><a href="#ColorClouds.preload_numpy-443"><span class="linenos">443</span></a>            <span class="n">robs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="ColorClouds.preload_numpy-444"><a href="#ColorClouds.preload_numpy-444"><span class="linenos">444</span></a>            <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="ColorClouds.preload_numpy-445"><a href="#ColorClouds.preload_numpy-445"><span class="linenos">445</span></a>            <span class="n">num_sus</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds.preload_numpy-446"><a href="#ColorClouds.preload_numpy-446"><span class="linenos">446</span></a>            <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="p">)</span>
</span><span id="ColorClouds.preload_numpy-447"><a href="#ColorClouds.preload_numpy-447"><span class="linenos">447</span></a>            <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.preload_numpy-448"><a href="#ColorClouds.preload_numpy-448"><span class="linenos">448</span></a>            <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;datafilts&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.preload_numpy-449"><a href="#ColorClouds.preload_numpy-449"><span class="linenos">449</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="ColorClouds.preload_numpy-450"><a href="#ColorClouds.preload_numpy-450"><span class="linenos">450</span></a>                <span class="n">num_mus</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds.preload_numpy-451"><a href="#ColorClouds.preload_numpy-451"><span class="linenos">451</span></a>                <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="o">+</span><span class="n">num_mus</span><span class="p">)</span>
</span><span id="ColorClouds.preload_numpy-452"><a href="#ColorClouds.preload_numpy-452"><span class="linenos">452</span></a>                <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.preload_numpy-453"><a href="#ColorClouds.preload_numpy-453"><span class="linenos">453</span></a>                <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;datafiltsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.preload_numpy-454"><a href="#ColorClouds.preload_numpy-454"><span class="linenos">454</span></a>            
</span><span id="ColorClouds.preload_numpy-455"><a href="#ColorClouds.preload_numpy-455"><span class="linenos">455</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">robs_tmp</span><span class="p">)</span>
</span><span id="ColorClouds.preload_numpy-456"><a href="#ColorClouds.preload_numpy-456"><span class="linenos">456</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dfs_tmp</span><span class="p">)</span>
</span><span id="ColorClouds.preload_numpy-457"><a href="#ColorClouds.preload_numpy-457"><span class="linenos">457</span></a>
</span><span id="ColorClouds.preload_numpy-458"><a href="#ColorClouds.preload_numpy-458"><span class="linenos">458</span></a>            <span class="n">t_counter</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.preload_numpy-459"><a href="#ColorClouds.preload_numpy-459"><span class="linenos">459</span></a>            <span class="n">unit_counter</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="ColorClouds.preload_numpy-460"><a href="#ColorClouds.preload_numpy-460"><span class="linenos">460</span></a>
</span><span id="ColorClouds.preload_numpy-461"><a href="#ColorClouds.preload_numpy-461"><span class="linenos">461</span></a>        <span class="c1"># Adjust stimulus since stored as ints</span>
</span><span id="ColorClouds.preload_numpy-462"><a href="#ColorClouds.preload_numpy-462"><span class="linenos">462</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span> 
</span><span id="ColorClouds.preload_numpy-463"><a href="#ColorClouds.preload_numpy-463"><span class="linenos">463</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
</span><span id="ColorClouds.preload_numpy-464"><a href="#ColorClouds.preload_numpy-464"><span class="linenos">464</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">127</span>
</span><span id="ColorClouds.preload_numpy-465"><a href="#ColorClouds.preload_numpy-465"><span class="linenos">465</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.preload_numpy-466"><a href="#ColorClouds.preload_numpy-466"><span class="linenos">466</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">127</span>
</span><span id="ColorClouds.preload_numpy-467"><a href="#ColorClouds.preload_numpy-467"><span class="linenos">467</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">128</span>
</span><span id="ColorClouds.preload_numpy-468"><a href="#ColorClouds.preload_numpy-468"><span class="linenos">468</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.preload_numpy-469"><a href="#ColorClouds.preload_numpy-469"><span class="linenos">469</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">128</span>
</span><span id="ColorClouds.preload_numpy-470"><a href="#ColorClouds.preload_numpy-470"><span class="linenos">470</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Adjusting stimulus read from disk: mean | std = </span><span class="si">%0.3f</span><span class="s2"> | </span><span class="si">%0.3f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">)))</span>
</span></pre></div>


            <div class="docstring"><p>Note this loads stimulus but does not time-embed</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li>None</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="ColorClouds.is_fixpoint_present" class="classattr">
                                        <input id="ColorClouds.is_fixpoint_present-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">is_fixpoint_present</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">boxlim</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ColorClouds.is_fixpoint_present-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ColorClouds.is_fixpoint_present"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ColorClouds.is_fixpoint_present-473"><a href="#ColorClouds.is_fixpoint_present-473"><span class="linenos">473</span></a>    <span class="k">def</span> <span class="nf">is_fixpoint_present</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">boxlim</span> <span class="p">):</span>
</span><span id="ColorClouds.is_fixpoint_present-474"><a href="#ColorClouds.is_fixpoint_present-474"><span class="linenos">474</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return if any of fixation point is within the box given by top-left to bottom-right corner&quot;&quot;&quot;</span>
</span><span id="ColorClouds.is_fixpoint_present-475"><a href="#ColorClouds.is_fixpoint_present-475"><span class="linenos">475</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.is_fixpoint_present-476"><a href="#ColorClouds.is_fixpoint_present-476"><span class="linenos">476</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="ColorClouds.is_fixpoint_present-477"><a href="#ColorClouds.is_fixpoint_present-477"><span class="linenos">477</span></a>        <span class="n">fix_present</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ColorClouds.is_fixpoint_present-478"><a href="#ColorClouds.is_fixpoint_present-478"><span class="linenos">478</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ColorClouds.is_fixpoint_present-479"><a href="#ColorClouds.is_fixpoint_present-479"><span class="linenos">479</span></a>            <span class="c1"># if there is multiple windows, needs to be manual: so this is the automatic check:</span>
</span><span id="ColorClouds.is_fixpoint_present-480"><a href="#ColorClouds.is_fixpoint_present-480"><span class="linenos">480</span></a>            <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="ColorClouds.is_fixpoint_present-481"><a href="#ColorClouds.is_fixpoint_present-481"><span class="linenos">481</span></a>                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">-</span><span class="n">boxlim</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_size</span><span class="p">):</span>
</span><span id="ColorClouds.is_fixpoint_present-482"><a href="#ColorClouds.is_fixpoint_present-482"><span class="linenos">482</span></a>                    <span class="n">fix_present</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ColorClouds.is_fixpoint_present-483"><a href="#ColorClouds.is_fixpoint_present-483"><span class="linenos">483</span></a>                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">-</span><span class="n">boxlim</span><span class="p">[</span><span class="n">dd</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_size</span><span class="p">):</span>
</span><span id="ColorClouds.is_fixpoint_present-484"><a href="#ColorClouds.is_fixpoint_present-484"><span class="linenos">484</span></a>                    <span class="n">fix_present</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ColorClouds.is_fixpoint_present-485"><a href="#ColorClouds.is_fixpoint_present-485"><span class="linenos">485</span></a>        <span class="k">return</span> <span class="n">fix_present</span>
</span></pre></div>


            <div class="docstring"><p>Return if any of fixation point is within the box given by top-left to bottom-right corner</p>
</div>


                            </div>
                            <div id="ColorClouds.assemble_stimulus" class="classattr">
                                        <input id="ColorClouds.assemble_stimulus-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">assemble_stimulus</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">which_stim</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">stim_wrap</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">top_corner</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">L</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">time_embed</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span>,</span><span class="param">	<span class="n">luminance_only</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">shifts</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">BUF</span><span class="o">=</span><span class="mi">20</span>,</span><span class="param">	<span class="n">shift_times</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">LMS</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">fixdot</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ColorClouds.assemble_stimulus-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ColorClouds.assemble_stimulus"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ColorClouds.assemble_stimulus-488"><a href="#ColorClouds.assemble_stimulus-488"><span class="linenos">488</span></a>    <span class="k">def</span> <span class="nf">assemble_stimulus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="ColorClouds.assemble_stimulus-489"><a href="#ColorClouds.assemble_stimulus-489"><span class="linenos">489</span></a>        <span class="n">which_stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stim_wrap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># conventional stim: ET=0, lam=1,</span>
</span><span id="ColorClouds.assemble_stimulus-490"><a href="#ColorClouds.assemble_stimulus-490"><span class="linenos">490</span></a>        <span class="n">top_corner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># position of stim</span>
</span><span id="ColorClouds.assemble_stimulus-491"><a href="#ColorClouds.assemble_stimulus-491"><span class="linenos">491</span></a>        <span class="n">time_embed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="ColorClouds.assemble_stimulus-492"><a href="#ColorClouds.assemble_stimulus-492"><span class="linenos">492</span></a>        <span class="n">luminance_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ColorClouds.assemble_stimulus-493"><a href="#ColorClouds.assemble_stimulus-493"><span class="linenos">493</span></a>        <span class="n">shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">BUF</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="c1"># shift buffer</span>
</span><span id="ColorClouds.assemble_stimulus-494"><a href="#ColorClouds.assemble_stimulus-494"><span class="linenos">494</span></a>        <span class="n">shift_times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># So that can put partial-shifts over time range in stimulus</span>
</span><span id="ColorClouds.assemble_stimulus-495"><a href="#ColorClouds.assemble_stimulus-495"><span class="linenos">495</span></a>        <span class="n">LMS</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># if false, translate to cone-isolating stimulus </span>
</span><span id="ColorClouds.assemble_stimulus-496"><a href="#ColorClouds.assemble_stimulus-496"><span class="linenos">496</span></a>        <span class="n">fixdot</span><span class="o">=</span><span class="mi">0</span> <span class="p">):</span>
</span><span id="ColorClouds.assemble_stimulus-497"><a href="#ColorClouds.assemble_stimulus-497"><span class="linenos">497</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds.assemble_stimulus-498"><a href="#ColorClouds.assemble_stimulus-498"><span class="linenos">498</span></a><span class="sd">        This assembles a stimulus from the raw numpy-stored stimuli into self.stim</span>
</span><span id="ColorClouds.assemble_stimulus-499"><a href="#ColorClouds.assemble_stimulus-499"><span class="linenos">499</span></a><span class="sd">        which_stim: determines what stimulus is assembled from &#39;ET&#39;=0, &#39;lam&#39;=1, None</span>
</span><span id="ColorClouds.assemble_stimulus-500"><a href="#ColorClouds.assemble_stimulus-500"><span class="linenos">500</span></a><span class="sd">            If none, will need top_corner present: can specify with four numbers (top-left, bot-right)</span>
</span><span id="ColorClouds.assemble_stimulus-501"><a href="#ColorClouds.assemble_stimulus-501"><span class="linenos">501</span></a><span class="sd">            or just top_corner and L</span>
</span><span id="ColorClouds.assemble_stimulus-502"><a href="#ColorClouds.assemble_stimulus-502"><span class="linenos">502</span></a><span class="sd">        which is torch.tensor on default device</span>
</span><span id="ColorClouds.assemble_stimulus-503"><a href="#ColorClouds.assemble_stimulus-503"><span class="linenos">503</span></a><span class="sd">        stim_wrap: only works if using &#39;which_stim&#39;, and will be [hwrap, vwrap]</span>
</span><span id="ColorClouds.assemble_stimulus-504"><a href="#ColorClouds.assemble_stimulus-504"><span class="linenos">504</span></a><span class="sd">        </span>
</span><span id="ColorClouds.assemble_stimulus-505"><a href="#ColorClouds.assemble_stimulus-505"><span class="linenos">505</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds.assemble_stimulus-506"><a href="#ColorClouds.assemble_stimulus-506"><span class="linenos">506</span></a><span class="sd">            which_stim (int): 0 for ET, 1 for laminar probe, None for assembly from top_corner</span>
</span><span id="ColorClouds.assemble_stimulus-507"><a href="#ColorClouds.assemble_stimulus-507"><span class="linenos">507</span></a><span class="sd">            stim_wrap (list): [hwrap, vwrap] for wrapping stimulus</span>
</span><span id="ColorClouds.assemble_stimulus-508"><a href="#ColorClouds.assemble_stimulus-508"><span class="linenos">508</span></a><span class="sd">            stim_crop (list): [x1, x2, y1, y2] for cropping stimulus</span>
</span><span id="ColorClouds.assemble_stimulus-509"><a href="#ColorClouds.assemble_stimulus-509"><span class="linenos">509</span></a><span class="sd">            top_corner (list): [x1, y1] for top corner of stimulus</span>
</span><span id="ColorClouds.assemble_stimulus-510"><a href="#ColorClouds.assemble_stimulus-510"><span class="linenos">510</span></a><span class="sd">            L (int): length of stimulus</span>
</span><span id="ColorClouds.assemble_stimulus-511"><a href="#ColorClouds.assemble_stimulus-511"><span class="linenos">511</span></a><span class="sd">            time_embed (int): number of time lags to embed</span>
</span><span id="ColorClouds.assemble_stimulus-512"><a href="#ColorClouds.assemble_stimulus-512"><span class="linenos">512</span></a><span class="sd">            num_lags (int): number of lags to use</span>
</span><span id="ColorClouds.assemble_stimulus-513"><a href="#ColorClouds.assemble_stimulus-513"><span class="linenos">513</span></a><span class="sd">            luminance_only (bool): whether to use only luminance channel</span>
</span><span id="ColorClouds.assemble_stimulus-514"><a href="#ColorClouds.assemble_stimulus-514"><span class="linenos">514</span></a><span class="sd">            shifts (list): [dx, dy] for shifting stimulus</span>
</span><span id="ColorClouds.assemble_stimulus-515"><a href="#ColorClouds.assemble_stimulus-515"><span class="linenos">515</span></a><span class="sd">            BUF (int): buffer for shifting stimulus</span>
</span><span id="ColorClouds.assemble_stimulus-516"><a href="#ColorClouds.assemble_stimulus-516"><span class="linenos">516</span></a><span class="sd">            shift_times (list): times to shift stimulus</span>
</span><span id="ColorClouds.assemble_stimulus-517"><a href="#ColorClouds.assemble_stimulus-517"><span class="linenos">517</span></a><span class="sd">            LMS (bool): whether to convert to cone-isolating stimulus</span>
</span><span id="ColorClouds.assemble_stimulus-518"><a href="#ColorClouds.assemble_stimulus-518"><span class="linenos">518</span></a><span class="sd">            fixdot (int): value for fixation point</span>
</span><span id="ColorClouds.assemble_stimulus-519"><a href="#ColorClouds.assemble_stimulus-519"><span class="linenos">519</span></a>
</span><span id="ColorClouds.assemble_stimulus-520"><a href="#ColorClouds.assemble_stimulus-520"><span class="linenos">520</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds.assemble_stimulus-521"><a href="#ColorClouds.assemble_stimulus-521"><span class="linenos">521</span></a><span class="sd">            None</span>
</span><span id="ColorClouds.assemble_stimulus-522"><a href="#ColorClouds.assemble_stimulus-522"><span class="linenos">522</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds.assemble_stimulus-523"><a href="#ColorClouds.assemble_stimulus-523"><span class="linenos">523</span></a>
</span><span id="ColorClouds.assemble_stimulus-524"><a href="#ColorClouds.assemble_stimulus-524"><span class="linenos">524</span></a>        <span class="c1"># Delete existing stim and clear cache to prevent memory issues on GPU</span>
</span><span id="ColorClouds.assemble_stimulus-525"><a href="#ColorClouds.assemble_stimulus-525"><span class="linenos">525</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-526"><a href="#ColorClouds.assemble_stimulus-526"><span class="linenos">526</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span>
</span><span id="ColorClouds.assemble_stimulus-527"><a href="#ColorClouds.assemble_stimulus-527"><span class="linenos">527</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ColorClouds.assemble_stimulus-528"><a href="#ColorClouds.assemble_stimulus-528"><span class="linenos">528</span></a>            <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
</span><span id="ColorClouds.assemble_stimulus-529"><a href="#ColorClouds.assemble_stimulus-529"><span class="linenos">529</span></a>        <span class="n">num_clr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.assemble_stimulus-530"><a href="#ColorClouds.assemble_stimulus-530"><span class="linenos">530</span></a>        <span class="k">if</span> <span class="n">LMS</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-531"><a href="#ColorClouds.assemble_stimulus-531"><span class="linenos">531</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminance_only</span><span class="p">,</span> <span class="s2">&quot;Cannot convert color spaces if luminance-only.&quot;</span>
</span><span id="ColorClouds.assemble_stimulus-532"><a href="#ColorClouds.assemble_stimulus-532"><span class="linenos">532</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">LMS</span> <span class="o">=</span> <span class="n">LMS</span>
</span><span id="ColorClouds.assemble_stimulus-533"><a href="#ColorClouds.assemble_stimulus-533"><span class="linenos">533</span></a>
</span><span id="ColorClouds.assemble_stimulus-534"><a href="#ColorClouds.assemble_stimulus-534"><span class="linenos">534</span></a>        <span class="n">need2crop</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ColorClouds.assemble_stimulus-535"><a href="#ColorClouds.assemble_stimulus-535"><span class="linenos">535</span></a>
</span><span id="ColorClouds.assemble_stimulus-536"><a href="#ColorClouds.assemble_stimulus-536"><span class="linenos">536</span></a>        <span class="k">if</span> <span class="n">which_stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-537"><a href="#ColorClouds.assemble_stimulus-537"><span class="linenos">537</span></a>            <span class="k">assert</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;ASSEMBLE_STIMULUS: cannot specify L if using which_stim (i.e. prepackaged stim)&quot;</span>
</span><span id="ColorClouds.assemble_stimulus-538"><a href="#ColorClouds.assemble_stimulus-538"><span class="linenos">538</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds.assemble_stimulus-539"><a href="#ColorClouds.assemble_stimulus-539"><span class="linenos">539</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_stim</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="ColorClouds.assemble_stimulus-540"><a href="#ColorClouds.assemble_stimulus-540"><span class="linenos">540</span></a>                <span class="k">if</span> <span class="n">which_stim</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ET&#39;</span><span class="p">,</span> <span class="s1">&#39;et&#39;</span><span class="p">,</span> <span class="s1">&#39;stimET&#39;</span><span class="p">]:</span>
</span><span id="ColorClouds.assemble_stimulus-541"><a href="#ColorClouds.assemble_stimulus-541"><span class="linenos">541</span></a>                    <span class="n">which_stim</span><span class="o">=</span><span class="mi">0</span>
</span><span id="ColorClouds.assemble_stimulus-542"><a href="#ColorClouds.assemble_stimulus-542"><span class="linenos">542</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-543"><a href="#ColorClouds.assemble_stimulus-543"><span class="linenos">543</span></a>                    <span class="n">which_stim</span><span class="o">=</span><span class="mi">1</span>
</span><span id="ColorClouds.assemble_stimulus-544"><a href="#ColorClouds.assemble_stimulus-544"><span class="linenos">544</span></a>            <span class="k">if</span> <span class="n">which_stim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-545"><a href="#ColorClouds.assemble_stimulus-545"><span class="linenos">545</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stim: using ET stimulus&quot;</span><span class="p">)</span>
</span><span id="ColorClouds.assemble_stimulus-546"><a href="#ColorClouds.assemble_stimulus-546"><span class="linenos">546</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="p">)</span>
</span><span id="ColorClouds.assemble_stimulus-547"><a href="#ColorClouds.assemble_stimulus-547"><span class="linenos">547</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_locationET</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.assemble_stimulus-548"><a href="#ColorClouds.assemble_stimulus-548"><span class="linenos">548</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-549"><a href="#ColorClouds.assemble_stimulus-549"><span class="linenos">549</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stim: using laminar probe stimulus&quot;</span><span class="p">)</span>
</span><span id="ColorClouds.assemble_stimulus-550"><a href="#ColorClouds.assemble_stimulus-550"><span class="linenos">550</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="p">)</span>
</span><span id="ColorClouds.assemble_stimulus-551"><a href="#ColorClouds.assemble_stimulus-551"><span class="linenos">551</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.assemble_stimulus-552"><a href="#ColorClouds.assemble_stimulus-552"><span class="linenos">552</span></a>
</span><span id="ColorClouds.assemble_stimulus-553"><a href="#ColorClouds.assemble_stimulus-553"><span class="linenos">553</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-554"><a href="#ColorClouds.assemble_stimulus-554"><span class="linenos">554</span></a>            <span class="k">assert</span> <span class="n">top_corner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need top corner if which_stim unspecified&quot;</span>
</span><span id="ColorClouds.assemble_stimulus-555"><a href="#ColorClouds.assemble_stimulus-555"><span class="linenos">555</span></a>            <span class="c1"># Assemble from combination of ET and laminer probe (NP) stimulus</span>
</span><span id="ColorClouds.assemble_stimulus-556"><a href="#ColorClouds.assemble_stimulus-556"><span class="linenos">556</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_corner</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-557"><a href="#ColorClouds.assemble_stimulus-557"><span class="linenos">557</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="o">=</span> <span class="n">top_corner</span>
</span><span id="ColorClouds.assemble_stimulus-558"><a href="#ColorClouds.assemble_stimulus-558"><span class="linenos">558</span></a>                <span class="c1">#L = self.stim_pos[2]-self.stim_pos[0]</span>
</span><span id="ColorClouds.assemble_stimulus-559"><a href="#ColorClouds.assemble_stimulus-559"><span class="linenos">559</span></a>                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Stim must be square (for now)&quot;</span>
</span><span id="ColorClouds.assemble_stimulus-560"><a href="#ColorClouds.assemble_stimulus-560"><span class="linenos">560</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-561"><a href="#ColorClouds.assemble_stimulus-561"><span class="linenos">561</span></a>                <span class="k">if</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-562"><a href="#ColorClouds.assemble_stimulus-562"><span class="linenos">562</span></a>                    <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds.assemble_stimulus-563"><a href="#ColorClouds.assemble_stimulus-563"><span class="linenos">563</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">top_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">top_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">top_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">L</span><span class="p">,</span> <span class="n">top_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">L</span><span class="p">]</span>
</span><span id="ColorClouds.assemble_stimulus-564"><a href="#ColorClouds.assemble_stimulus-564"><span class="linenos">564</span></a>            <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-565"><a href="#ColorClouds.assemble_stimulus-565"><span class="linenos">565</span></a>                <span class="n">need2crop</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ColorClouds.assemble_stimulus-566"><a href="#ColorClouds.assemble_stimulus-566"><span class="linenos">566</span></a>                <span class="c1"># Modify stim window by 20-per-side</span>
</span><span id="ColorClouds.assemble_stimulus-567"><a href="#ColorClouds.assemble_stimulus-567"><span class="linenos">567</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ColorClouds.assemble_stimulus-568"><a href="#ColorClouds.assemble_stimulus-568"><span class="linenos">568</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span>
</span><span id="ColorClouds.assemble_stimulus-569"><a href="#ColorClouds.assemble_stimulus-569"><span class="linenos">569</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span>
</span><span id="ColorClouds.assemble_stimulus-570"><a href="#ColorClouds.assemble_stimulus-570"><span class="linenos">570</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">BUF</span><span class="p">,</span>
</span><span id="ColorClouds.assemble_stimulus-571"><a href="#ColorClouds.assemble_stimulus-571"><span class="linenos">571</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">BUF</span><span class="p">]</span>
</span><span id="ColorClouds.assemble_stimulus-572"><a href="#ColorClouds.assemble_stimulus-572"><span class="linenos">572</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Stim expansion for shift:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">)</span>
</span><span id="ColorClouds.assemble_stimulus-573"><a href="#ColorClouds.assemble_stimulus-573"><span class="linenos">573</span></a>
</span><span id="ColorClouds.assemble_stimulus-574"><a href="#ColorClouds.assemble_stimulus-574"><span class="linenos">574</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.assemble_stimulus-575"><a href="#ColorClouds.assemble_stimulus-575"><span class="linenos">575</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">L</span><span class="p">,</span> <span class="s2">&quot;Stimulus not square&quot;</span>
</span><span id="ColorClouds.assemble_stimulus-576"><a href="#ColorClouds.assemble_stimulus-576"><span class="linenos">576</span></a>
</span><span id="ColorClouds.assemble_stimulus-577"><a href="#ColorClouds.assemble_stimulus-577"><span class="linenos">577</span></a>            <span class="n">newstim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">num_clr</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="ColorClouds.assemble_stimulus-578"><a href="#ColorClouds.assemble_stimulus-578"><span class="linenos">578</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="ColorClouds.assemble_stimulus-579"><a href="#ColorClouds.assemble_stimulus-579"><span class="linenos">579</span></a>                <span class="n">OVLP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_overlap_ranges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">])</span>
</span><span id="ColorClouds.assemble_stimulus-580"><a href="#ColorClouds.assemble_stimulus-580"><span class="linenos">580</span></a>                <span class="k">if</span> <span class="n">OVLP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-581"><a href="#ColorClouds.assemble_stimulus-581"><span class="linenos">581</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Writing lam stim </span><span class="si">%d</span><span class="s2">: overlap </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">])))</span>
</span><span id="ColorClouds.assemble_stimulus-582"><a href="#ColorClouds.assemble_stimulus-582"><span class="linenos">582</span></a>                    <span class="n">strip</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:])</span> <span class="c1">#np.zeros([self.NT, num_clr, len(OVLP[&#39;targetX&#39;]), L])</span>
</span><span id="ColorClouds.assemble_stimulus-583"><a href="#ColorClouds.assemble_stimulus-583"><span class="linenos">583</span></a>                    <span class="n">strip</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">stimLP</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readX&#39;</span><span class="p">],</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readY&#39;</span><span class="p">]]))</span>
</span><span id="ColorClouds.assemble_stimulus-584"><a href="#ColorClouds.assemble_stimulus-584"><span class="linenos">584</span></a>                    <span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span>
</span><span id="ColorClouds.assemble_stimulus-585"><a href="#ColorClouds.assemble_stimulus-585"><span class="linenos">585</span></a>                
</span><span id="ColorClouds.assemble_stimulus-586"><a href="#ColorClouds.assemble_stimulus-586"><span class="linenos">586</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-587"><a href="#ColorClouds.assemble_stimulus-587"><span class="linenos">587</span></a>                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_locationET</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="ColorClouds.assemble_stimulus-588"><a href="#ColorClouds.assemble_stimulus-588"><span class="linenos">588</span></a>                    <span class="n">OVLP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_overlap_ranges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_locationET</span><span class="p">[:,</span><span class="n">ii</span><span class="p">])</span>
</span><span id="ColorClouds.assemble_stimulus-589"><a href="#ColorClouds.assemble_stimulus-589"><span class="linenos">589</span></a>                    <span class="k">if</span> <span class="n">OVLP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-590"><a href="#ColorClouds.assemble_stimulus-590"><span class="linenos">590</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Writing ETstim </span><span class="si">%d</span><span class="s2">: overlap </span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">])))</span>
</span><span id="ColorClouds.assemble_stimulus-591"><a href="#ColorClouds.assemble_stimulus-591"><span class="linenos">591</span></a>                        <span class="n">strip</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:])</span>
</span><span id="ColorClouds.assemble_stimulus-592"><a href="#ColorClouds.assemble_stimulus-592"><span class="linenos">592</span></a>                        <span class="n">strip</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetY&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">stimET</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readX&#39;</span><span class="p">],</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;readY&#39;</span><span class="p">]]))</span>
</span><span id="ColorClouds.assemble_stimulus-593"><a href="#ColorClouds.assemble_stimulus-593"><span class="linenos">593</span></a>                        <span class="n">newstim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">OVLP</span><span class="p">[</span><span class="s1">&#39;targetX&#39;</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span> 
</span><span id="ColorClouds.assemble_stimulus-594"><a href="#ColorClouds.assemble_stimulus-594"><span class="linenos">594</span></a>
</span><span id="ColorClouds.assemble_stimulus-595"><a href="#ColorClouds.assemble_stimulus-595"><span class="linenos">595</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">newstim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="p">)</span>
</span><span id="ColorClouds.assemble_stimulus-596"><a href="#ColorClouds.assemble_stimulus-596"><span class="linenos">596</span></a>
</span><span id="ColorClouds.assemble_stimulus-597"><a href="#ColorClouds.assemble_stimulus-597"><span class="linenos">597</span></a>        <span class="c1">#print(&#39;Stim shape&#39;, self.stim.shape)</span>
</span><span id="ColorClouds.assemble_stimulus-598"><a href="#ColorClouds.assemble_stimulus-598"><span class="linenos">598</span></a>        <span class="c1"># Note stim stored in numpy is being represented as full 3-d + 1 tensor (time, channels, NX, NY)</span>
</span><span id="ColorClouds.assemble_stimulus-599"><a href="#ColorClouds.assemble_stimulus-599"><span class="linenos">599</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds.assemble_stimulus-600"><a href="#ColorClouds.assemble_stimulus-600"><span class="linenos">600</span></a>        <span class="k">if</span> <span class="n">luminance_only</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-601"><a href="#ColorClouds.assemble_stimulus-601"><span class="linenos">601</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-602"><a href="#ColorClouds.assemble_stimulus-602"><span class="linenos">602</span></a>                <span class="c1"># Resample first dimension of stimulus</span>
</span><span id="ColorClouds.assemble_stimulus-603"><a href="#ColorClouds.assemble_stimulus-603"><span class="linenos">603</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Shifting to luminance-only&#39;</span><span class="p">)</span>
</span><span id="ColorClouds.assemble_stimulus-604"><a href="#ColorClouds.assemble_stimulus-604"><span class="linenos">604</span></a>                <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))</span>
</span><span id="ColorClouds.assemble_stimulus-605"><a href="#ColorClouds.assemble_stimulus-605"><span class="linenos">605</span></a>                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span>
</span><span id="ColorClouds.assemble_stimulus-606"><a href="#ColorClouds.assemble_stimulus-606"><span class="linenos">606</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
</span><span id="ColorClouds.assemble_stimulus-607"><a href="#ColorClouds.assemble_stimulus-607"><span class="linenos">607</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">...</span><span class="p">])</span>
</span><span id="ColorClouds.assemble_stimulus-608"><a href="#ColorClouds.assemble_stimulus-608"><span class="linenos">608</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>            
</span><span id="ColorClouds.assemble_stimulus-609"><a href="#ColorClouds.assemble_stimulus-609"><span class="linenos">609</span></a>
</span><span id="ColorClouds.assemble_stimulus-610"><a href="#ColorClouds.assemble_stimulus-610"><span class="linenos">610</span></a>        <span class="c1"># stim_wrap if &#39;which_stim&#39; chosen</span>
</span><span id="ColorClouds.assemble_stimulus-611"><a href="#ColorClouds.assemble_stimulus-611"><span class="linenos">611</span></a>        <span class="k">if</span> <span class="n">stim_wrap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-612"><a href="#ColorClouds.assemble_stimulus-612"><span class="linenos">612</span></a>            <span class="k">assert</span> <span class="n">which_stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Should only use stim_wrap on conventional (ET or LAM) stimulus.&quot;</span>
</span><span id="ColorClouds.assemble_stimulus-613"><a href="#ColorClouds.assemble_stimulus-613"><span class="linenos">613</span></a>            <span class="n">hwrap</span> <span class="o">=</span> <span class="n">stim_wrap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.assemble_stimulus-614"><a href="#ColorClouds.assemble_stimulus-614"><span class="linenos">614</span></a>            <span class="n">vwrap</span> <span class="o">=</span> <span class="n">stim_wrap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds.assemble_stimulus-615"><a href="#ColorClouds.assemble_stimulus-615"><span class="linenos">615</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wrap_stim</span><span class="p">(</span> <span class="n">hwrap</span><span class="o">=-</span><span class="n">hwrap</span><span class="p">,</span> <span class="n">vwrap</span><span class="o">=-</span><span class="n">vwrap</span> <span class="p">)</span>
</span><span id="ColorClouds.assemble_stimulus-616"><a href="#ColorClouds.assemble_stimulus-616"><span class="linenos">616</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="o">+=</span> <span class="p">[</span><span class="o">-</span><span class="n">hwrap</span><span class="p">,</span> <span class="o">-</span><span class="n">vwrap</span><span class="p">,</span> <span class="o">-</span><span class="n">hwrap</span><span class="p">,</span> <span class="o">-</span><span class="n">vwrap</span><span class="p">]</span>
</span><span id="ColorClouds.assemble_stimulus-617"><a href="#ColorClouds.assemble_stimulus-617"><span class="linenos">617</span></a>
</span><span id="ColorClouds.assemble_stimulus-618"><a href="#ColorClouds.assemble_stimulus-618"><span class="linenos">618</span></a>        <span class="c1"># Insert fixation point</span>
</span><span id="ColorClouds.assemble_stimulus-619"><a href="#ColorClouds.assemble_stimulus-619"><span class="linenos">619</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">fixdot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fixpoint_present</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span> <span class="p">):</span>
</span><span id="ColorClouds.assemble_stimulus-620"><a href="#ColorClouds.assemble_stimulus-620"><span class="linenos">620</span></a>            <span class="n">fixranges</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="ColorClouds.assemble_stimulus-621"><a href="#ColorClouds.assemble_stimulus-621"><span class="linenos">621</span></a>            <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="ColorClouds.assemble_stimulus-622"><a href="#ColorClouds.assemble_stimulus-622"><span class="linenos">622</span></a>                <span class="n">fixranges</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
</span><span id="ColorClouds.assemble_stimulus-623"><a href="#ColorClouds.assemble_stimulus-623"><span class="linenos">623</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_size</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="n">dd</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="ColorClouds.assemble_stimulus-624"><a href="#ColorClouds.assemble_stimulus-624"><span class="linenos">624</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="n">dd</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_pos</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span> 
</span><span id="ColorClouds.assemble_stimulus-625"><a href="#ColorClouds.assemble_stimulus-625"><span class="linenos">625</span></a>                    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="ColorClouds.assemble_stimulus-626"><a href="#ColorClouds.assemble_stimulus-626"><span class="linenos">626</span></a>            <span class="c1"># Write the correct value to stim</span>
</span><span id="ColorClouds.assemble_stimulus-627"><a href="#ColorClouds.assemble_stimulus-627"><span class="linenos">627</span></a>            <span class="c1">#print(fixranges)</span>
</span><span id="ColorClouds.assemble_stimulus-628"><a href="#ColorClouds.assemble_stimulus-628"><span class="linenos">628</span></a>            <span class="k">assert</span> <span class="n">fixdot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Haven&#39;t yet put in other fixdot settings than zero&quot;</span> 
</span><span id="ColorClouds.assemble_stimulus-629"><a href="#ColorClouds.assemble_stimulus-629"><span class="linenos">629</span></a>            <span class="c1">#strip = deepcopy(self.stim[:, :, fixranges[0], :])</span>
</span><span id="ColorClouds.assemble_stimulus-630"><a href="#ColorClouds.assemble_stimulus-630"><span class="linenos">630</span></a>            <span class="c1">#strip[:, :, :, fixranges[1]] = 0</span>
</span><span id="ColorClouds.assemble_stimulus-631"><a href="#ColorClouds.assemble_stimulus-631"><span class="linenos">631</span></a>            <span class="c1">#self.stim[:, :, fixranges[0], :] = deepcopy(strip) </span>
</span><span id="ColorClouds.assemble_stimulus-632"><a href="#ColorClouds.assemble_stimulus-632"><span class="linenos">632</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Adding fixation point&#39;</span><span class="p">)</span>
</span><span id="ColorClouds.assemble_stimulus-633"><a href="#ColorClouds.assemble_stimulus-633"><span class="linenos">633</span></a>            <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">fixranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="ColorClouds.assemble_stimulus-634"><a href="#ColorClouds.assemble_stimulus-634"><span class="linenos">634</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">fixranges</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds.assemble_stimulus-635"><a href="#ColorClouds.assemble_stimulus-635"><span class="linenos">635</span></a>
</span><span id="ColorClouds.assemble_stimulus-636"><a href="#ColorClouds.assemble_stimulus-636"><span class="linenos">636</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_shifts</span> <span class="o">=</span> <span class="n">shifts</span>
</span><span id="ColorClouds.assemble_stimulus-637"><a href="#ColorClouds.assemble_stimulus-637"><span class="linenos">637</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-638"><a href="#ColorClouds.assemble_stimulus-638"><span class="linenos">638</span></a>            <span class="c1"># Would want to shift by input eye positions if input here</span>
</span><span id="ColorClouds.assemble_stimulus-639"><a href="#ColorClouds.assemble_stimulus-639"><span class="linenos">639</span></a>            <span class="c1">#print(&#39;eye-position shifting not implemented yet&#39;)</span>
</span><span id="ColorClouds.assemble_stimulus-640"><a href="#ColorClouds.assemble_stimulus-640"><span class="linenos">640</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Shifting stim...&#39;</span><span class="p">)</span>
</span><span id="ColorClouds.assemble_stimulus-641"><a href="#ColorClouds.assemble_stimulus-641"><span class="linenos">641</span></a>            <span class="k">if</span> <span class="n">shift_times</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-642"><a href="#ColorClouds.assemble_stimulus-642"><span class="linenos">642</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_stim</span><span class="p">(</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">shift_times</span><span class="o">=</span><span class="n">shift_times</span><span class="p">,</span> <span class="n">already_lagged</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
</span><span id="ColorClouds.assemble_stimulus-643"><a href="#ColorClouds.assemble_stimulus-643"><span class="linenos">643</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-644"><a href="#ColorClouds.assemble_stimulus-644"><span class="linenos">644</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">shift_times</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_stim</span><span class="p">(</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">shift_times</span><span class="o">=</span><span class="n">shift_times</span><span class="p">,</span> <span class="n">already_lagged</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
</span><span id="ColorClouds.assemble_stimulus-645"><a href="#ColorClouds.assemble_stimulus-645"><span class="linenos">645</span></a>
</span><span id="ColorClouds.assemble_stimulus-646"><a href="#ColorClouds.assemble_stimulus-646"><span class="linenos">646</span></a>        <span class="c1"># Reduce size back to original If expanded to handle shifts</span>
</span><span id="ColorClouds.assemble_stimulus-647"><a href="#ColorClouds.assemble_stimulus-647"><span class="linenos">647</span></a>        <span class="k">if</span> <span class="n">need2crop</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-648"><a href="#ColorClouds.assemble_stimulus-648"><span class="linenos">648</span></a>            <span class="c1">#assert self.stim_crop is None, &quot;Cannot crop stim at same time as shifting&quot;</span>
</span><span id="ColorClouds.assemble_stimulus-649"><a href="#ColorClouds.assemble_stimulus-649"><span class="linenos">649</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">crop_stim</span><span class="p">(</span> <span class="p">[</span><span class="n">BUF</span><span class="p">,</span> <span class="n">L</span><span class="o">-</span><span class="n">BUF</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">BUF</span><span class="p">,</span> <span class="n">L</span><span class="o">-</span><span class="n">BUF</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>  <span class="c1"># move back to original size</span>
</span><span id="ColorClouds.assemble_stimulus-650"><a href="#ColorClouds.assemble_stimulus-650"><span class="linenos">650</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ColorClouds.assemble_stimulus-651"><a href="#ColorClouds.assemble_stimulus-651"><span class="linenos">651</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">L</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">BUF</span>
</span><span id="ColorClouds.assemble_stimulus-652"><a href="#ColorClouds.assemble_stimulus-652"><span class="linenos">652</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span>
</span><span id="ColorClouds.assemble_stimulus-653"><a href="#ColorClouds.assemble_stimulus-653"><span class="linenos">653</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span>
</span><span id="ColorClouds.assemble_stimulus-654"><a href="#ColorClouds.assemble_stimulus-654"><span class="linenos">654</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-655"><a href="#ColorClouds.assemble_stimulus-655"><span class="linenos">655</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="o">=</span> <span class="n">stim_crop</span> 
</span><span id="ColorClouds.assemble_stimulus-656"><a href="#ColorClouds.assemble_stimulus-656"><span class="linenos">656</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-657"><a href="#ColorClouds.assemble_stimulus-657"><span class="linenos">657</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">crop_stim</span><span class="p">()</span>
</span><span id="ColorClouds.assemble_stimulus-658"><a href="#ColorClouds.assemble_stimulus-658"><span class="linenos">658</span></a>
</span><span id="ColorClouds.assemble_stimulus-659"><a href="#ColorClouds.assemble_stimulus-659"><span class="linenos">659</span></a>        <span class="k">if</span> <span class="n">time_embed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-660"><a href="#ColorClouds.assemble_stimulus-660"><span class="linenos">660</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">=</span> <span class="n">time_embed</span>
</span><span id="ColorClouds.assemble_stimulus-661"><a href="#ColorClouds.assemble_stimulus-661"><span class="linenos">661</span></a>        <span class="k">if</span> <span class="n">time_embed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-662"><a href="#ColorClouds.assemble_stimulus-662"><span class="linenos">662</span></a>            <span class="c1">#self.stim_dims[3] = num_lags  # this is set by time-embedding</span>
</span><span id="ColorClouds.assemble_stimulus-663"><a href="#ColorClouds.assemble_stimulus-663"><span class="linenos">663</span></a>            <span class="k">if</span> <span class="n">time_embed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-664"><a href="#ColorClouds.assemble_stimulus-664"><span class="linenos">664</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embedding</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">,</span> <span class="n">nlags</span> <span class="o">=</span> <span class="n">num_lags</span> <span class="p">)</span>
</span><span id="ColorClouds.assemble_stimulus-665"><a href="#ColorClouds.assemble_stimulus-665"><span class="linenos">665</span></a>        <span class="c1"># now stimulus is represented as full 4-d + 1 tensor (time, channels, NX, NY, num_lags)</span>
</span><span id="ColorClouds.assemble_stimulus-666"><a href="#ColorClouds.assemble_stimulus-666"><span class="linenos">666</span></a>
</span><span id="ColorClouds.assemble_stimulus-667"><a href="#ColorClouds.assemble_stimulus-667"><span class="linenos">667</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span> <span class="o">=</span> <span class="n">num_lags</span>
</span><span id="ColorClouds.assemble_stimulus-668"><a href="#ColorClouds.assemble_stimulus-668"><span class="linenos">668</span></a>
</span><span id="ColorClouds.assemble_stimulus-669"><a href="#ColorClouds.assemble_stimulus-669"><span class="linenos">669</span></a>        <span class="c1"># Translate to cone-isolating stimmulus if DKL is false</span>
</span><span id="ColorClouds.assemble_stimulus-670"><a href="#ColorClouds.assemble_stimulus-670"><span class="linenos">670</span></a>        <span class="k">if</span> <span class="n">LMS</span><span class="p">:</span>
</span><span id="ColorClouds.assemble_stimulus-671"><a href="#ColorClouds.assemble_stimulus-671"><span class="linenos">671</span></a>            <span class="c1"># Make cone-isolating stimulus conversion matrix</span>
</span><span id="ColorClouds.assemble_stimulus-672"><a href="#ColorClouds.assemble_stimulus-672"><span class="linenos">672</span></a>            <span class="c1">#DKL2CIS = torch.tensor([[0.0401,.522,0], [.0351,-0.4635,0], [0.0145,0,.985]], dtype=torch.float32)</span>
</span><span id="ColorClouds.assemble_stimulus-673"><a href="#ColorClouds.assemble_stimulus-673"><span class="linenos">673</span></a>            <span class="c1">#DKL2LMS = torch.tensor([[0.9737, 0.0799, -0.0836], [1.0155, -0.1210, -0.1135], [1.0890, -0.0138, 0.9183]], dtype=torch.float32)</span>
</span><span id="ColorClouds.assemble_stimulus-674"><a href="#ColorClouds.assemble_stimulus-674"><span class="linenos">674</span></a>            <span class="n">DKL2LMS</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mf">0.7586</span><span class="p">,</span> <span class="mf">0.6515</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5536</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8328</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.8660</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.assemble_stimulus-675"><a href="#ColorClouds.assemble_stimulus-675"><span class="linenos">675</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;  Converting to LMS space&#39;</span><span class="p">)</span>
</span><span id="ColorClouds.assemble_stimulus-676"><a href="#ColorClouds.assemble_stimulus-676"><span class="linenos">676</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span> <span class="s1">&#39;axcd,bx-&gt;abcd&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">,</span> <span class="n">DKL2LMS</span><span class="p">)</span>
</span><span id="ColorClouds.assemble_stimulus-677"><a href="#ColorClouds.assemble_stimulus-677"><span class="linenos">677</span></a>
</span><span id="ColorClouds.assemble_stimulus-678"><a href="#ColorClouds.assemble_stimulus-678"><span class="linenos">678</span></a>        <span class="c1"># Flatten stim </span>
</span><span id="ColorClouds.assemble_stimulus-679"><a href="#ColorClouds.assemble_stimulus-679"><span class="linenos">679</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="ColorClouds.assemble_stimulus-680"><a href="#ColorClouds.assemble_stimulus-680"><span class="linenos">680</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Done&quot;</span> <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This assembles a stimulus from the raw numpy-stored stimuli into self.stim
which_stim: determines what stimulus is assembled from 'ET'=0, 'lam'=1, None
    If none, will need top_corner present: can specify with four numbers (top-left, bot-right)
    or just top_corner and L
which is torch.tensor on default device
stim_wrap: only works if using 'which_stim', and will be [hwrap, vwrap]</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>which_stim (int):</strong>  0 for ET, 1 for laminar probe, None for assembly from top_corner</li>
<li><strong>stim_wrap (list):</strong>  [hwrap, vwrap] for wrapping stimulus</li>
<li><strong>stim_crop (list):</strong>  [x1, x2, y1, y2] for cropping stimulus</li>
<li><strong>top_corner (list):</strong>  [x1, y1] for top corner of stimulus</li>
<li><strong>L (int):</strong>  length of stimulus</li>
<li><strong>time_embed (int):</strong>  number of time lags to embed</li>
<li><strong>num_lags (int):</strong>  number of lags to use</li>
<li><strong>luminance_only (bool):</strong>  whether to use only luminance channel</li>
<li><strong>shifts (list):</strong>  [dx, dy] for shifting stimulus</li>
<li><strong>BUF (int):</strong>  buffer for shifting stimulus</li>
<li><strong>shift_times (list):</strong>  times to shift stimulus</li>
<li><strong>LMS (bool):</strong>  whether to convert to cone-isolating stimulus</li>
<li><strong>fixdot (int):</strong>  value for fixation point</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="ColorClouds.to_tensor" class="classattr">
                                        <input id="ColorClouds.to_tensor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">to_tensor</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">device</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ColorClouds.to_tensor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ColorClouds.to_tensor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ColorClouds.to_tensor-683"><a href="#ColorClouds.to_tensor-683"><span class="linenos">683</span></a>    <span class="k">def</span> <span class="nf">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="ColorClouds.to_tensor-684"><a href="#ColorClouds.to_tensor-684"><span class="linenos">684</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds.to_tensor-685"><a href="#ColorClouds.to_tensor-685"><span class="linenos">685</span></a><span class="sd">        Converts all relevant data to torch.tensor on device</span>
</span><span id="ColorClouds.to_tensor-686"><a href="#ColorClouds.to_tensor-686"><span class="linenos">686</span></a>
</span><span id="ColorClouds.to_tensor-687"><a href="#ColorClouds.to_tensor-687"><span class="linenos">687</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds.to_tensor-688"><a href="#ColorClouds.to_tensor-688"><span class="linenos">688</span></a><span class="sd">            device (torch.device): device to move data to</span>
</span><span id="ColorClouds.to_tensor-689"><a href="#ColorClouds.to_tensor-689"><span class="linenos">689</span></a>
</span><span id="ColorClouds.to_tensor-690"><a href="#ColorClouds.to_tensor-690"><span class="linenos">690</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds.to_tensor-691"><a href="#ColorClouds.to_tensor-691"><span class="linenos">691</span></a><span class="sd">            None</span>
</span><span id="ColorClouds.to_tensor-692"><a href="#ColorClouds.to_tensor-692"><span class="linenos">692</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds.to_tensor-693"><a href="#ColorClouds.to_tensor-693"><span class="linenos">693</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="ColorClouds.to_tensor-694"><a href="#ColorClouds.to_tensor-694"><span class="linenos">694</span></a>            <span class="c1"># then already converted: just moving device</span>
</span><span id="ColorClouds.to_tensor-695"><a href="#ColorClouds.to_tensor-695"><span class="linenos">695</span></a>            <span class="c1">#self.stim = self.stim.to(device)</span>
</span><span id="ColorClouds.to_tensor-696"><a href="#ColorClouds.to_tensor-696"><span class="linenos">696</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds.to_tensor-697"><a href="#ColorClouds.to_tensor-697"><span class="linenos">697</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds.to_tensor-698"><a href="#ColorClouds.to_tensor-698"><span class="linenos">698</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds.to_tensor-699"><a href="#ColorClouds.to_tensor-699"><span class="linenos">699</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.to_tensor-700"><a href="#ColorClouds.to_tensor-700"><span class="linenos">700</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds.to_tensor-701"><a href="#ColorClouds.to_tensor-701"><span class="linenos">701</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.to_tensor-702"><a href="#ColorClouds.to_tensor-702"><span class="linenos">702</span></a>            <span class="c1">#self.stim = torch.tensor(self.stim, dtype=torch.float32, device=device)</span>
</span><span id="ColorClouds.to_tensor-703"><a href="#ColorClouds.to_tensor-703"><span class="linenos">703</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds.to_tensor-704"><a href="#ColorClouds.to_tensor-704"><span class="linenos">704</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds.to_tensor-705"><a href="#ColorClouds.to_tensor-705"><span class="linenos">705</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds.to_tensor-706"><a href="#ColorClouds.to_tensor-706"><span class="linenos">706</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.to_tensor-707"><a href="#ColorClouds.to_tensor-707"><span class="linenos">707</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Converts all relevant data to torch.tensor on device</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>device (torch.device):</strong>  device to move data to</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="ColorClouds.time_embedding" class="classattr">
                                        <input id="ColorClouds.time_embedding-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">time_embedding</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">stim</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">nlags</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ColorClouds.time_embedding-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ColorClouds.time_embedding"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ColorClouds.time_embedding-709"><a href="#ColorClouds.time_embedding-709"><span class="linenos">709</span></a>    <span class="k">def</span> <span class="nf">time_embedding</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="ColorClouds.time_embedding-710"><a href="#ColorClouds.time_embedding-710"><span class="linenos">710</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds.time_embedding-711"><a href="#ColorClouds.time_embedding-711"><span class="linenos">711</span></a><span class="sd">        Note this overloads SensoryBase because reshapes in full dimensions to handle folded_lags</span>
</span><span id="ColorClouds.time_embedding-712"><a href="#ColorClouds.time_embedding-712"><span class="linenos">712</span></a><span class="sd">        </span>
</span><span id="ColorClouds.time_embedding-713"><a href="#ColorClouds.time_embedding-713"><span class="linenos">713</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds.time_embedding-714"><a href="#ColorClouds.time_embedding-714"><span class="linenos">714</span></a><span class="sd">            stim (torch.tensor): stimulus to time-embed</span>
</span><span id="ColorClouds.time_embedding-715"><a href="#ColorClouds.time_embedding-715"><span class="linenos">715</span></a><span class="sd">            nlags (int): number of lags to use</span>
</span><span id="ColorClouds.time_embedding-716"><a href="#ColorClouds.time_embedding-716"><span class="linenos">716</span></a>
</span><span id="ColorClouds.time_embedding-717"><a href="#ColorClouds.time_embedding-717"><span class="linenos">717</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds.time_embedding-718"><a href="#ColorClouds.time_embedding-718"><span class="linenos">718</span></a><span class="sd">            torch.tensor: time-embedded stimulus</span>
</span><span id="ColorClouds.time_embedding-719"><a href="#ColorClouds.time_embedding-719"><span class="linenos">719</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds.time_embedding-720"><a href="#ColorClouds.time_embedding-720"><span class="linenos">720</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to assemble stim before time-embedding.&quot;</span>
</span><span id="ColorClouds.time_embedding-721"><a href="#ColorClouds.time_embedding-721"><span class="linenos">721</span></a>        <span class="k">if</span> <span class="n">nlags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.time_embedding-722"><a href="#ColorClouds.time_embedding-722"><span class="linenos">722</span></a>            <span class="n">nlags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="ColorClouds.time_embedding-723"><a href="#ColorClouds.time_embedding-723"><span class="linenos">723</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ColorClouds.time_embedding-724"><a href="#ColorClouds.time_embedding-724"><span class="linenos">724</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlags</span>
</span><span id="ColorClouds.time_embedding-725"><a href="#ColorClouds.time_embedding-725"><span class="linenos">725</span></a>        <span class="k">if</span> <span class="n">stim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.time_embedding-726"><a href="#ColorClouds.time_embedding-726"><span class="linenos">726</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span>
</span><span id="ColorClouds.time_embedding-727"><a href="#ColorClouds.time_embedding-727"><span class="linenos">727</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.time_embedding-728"><a href="#ColorClouds.time_embedding-728"><span class="linenos">728</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="ColorClouds.time_embedding-729"><a href="#ColorClouds.time_embedding-729"><span class="linenos">729</span></a>                <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">stim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.time_embedding-730"><a href="#ColorClouds.time_embedding-730"><span class="linenos">730</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.time_embedding-731"><a href="#ColorClouds.time_embedding-731"><span class="linenos">731</span></a>                <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="ColorClouds.time_embedding-732"><a href="#ColorClouds.time_embedding-732"><span class="linenos">732</span></a>        <span class="c1">#if not isinstance(tmp_stim, np.ndarray):</span>
</span><span id="ColorClouds.time_embedding-733"><a href="#ColorClouds.time_embedding-733"><span class="linenos">733</span></a>        <span class="c1">#    tmp_stim = tmp_stim.cpu().numpy()</span>
</span><span id="ColorClouds.time_embedding-734"><a href="#ColorClouds.time_embedding-734"><span class="linenos">734</span></a>    
</span><span id="ColorClouds.time_embedding-735"><a href="#ColorClouds.time_embedding-735"><span class="linenos">735</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.time_embedding-736"><a href="#ColorClouds.time_embedding-736"><span class="linenos">736</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Time embedding...&quot;</span><span class="p">)</span>
</span><span id="ColorClouds.time_embedding-737"><a href="#ColorClouds.time_embedding-737"><span class="linenos">737</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="ColorClouds.time_embedding-738"><a href="#ColorClouds.time_embedding-738"><span class="linenos">738</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Time embed: reshaping stimulus -&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">)</span>
</span><span id="ColorClouds.time_embedding-739"><a href="#ColorClouds.time_embedding-739"><span class="linenos">739</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">)</span>
</span><span id="ColorClouds.time_embedding-740"><a href="#ColorClouds.time_embedding-740"><span class="linenos">740</span></a>
</span><span id="ColorClouds.time_embedding-741"><a href="#ColorClouds.time_embedding-741"><span class="linenos">741</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">==</span> <span class="n">NT</span><span class="p">,</span> <span class="s2">&quot;TIME EMBEDDING: stim length mismatch&quot;</span>
</span><span id="ColorClouds.time_embedding-742"><a href="#ColorClouds.time_embedding-742"><span class="linenos">742</span></a>
</span><span id="ColorClouds.time_embedding-743"><a href="#ColorClouds.time_embedding-743"><span class="linenos">743</span></a>        <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nlags</span><span class="p">),</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="ColorClouds.time_embedding-744"><a href="#ColorClouds.time_embedding-744"><span class="linenos">744</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span><span class="p">:</span>
</span><span id="ColorClouds.time_embedding-745"><a href="#ColorClouds.time_embedding-745"><span class="linenos">745</span></a>            <span class="c1">#tmp_stim = np.transpose( tmp_stim, axes=[0,2,1,3,4] ) </span>
</span><span id="ColorClouds.time_embedding-746"><a href="#ColorClouds.time_embedding-746"><span class="linenos">746</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span> <span class="n">tmp_stim</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span> 
</span><span id="ColorClouds.time_embedding-747"><a href="#ColorClouds.time_embedding-747"><span class="linenos">747</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Folded lags: stim-dim = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="ColorClouds.time_embedding-748"><a href="#ColorClouds.time_embedding-748"><span class="linenos">748</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.time_embedding-749"><a href="#ColorClouds.time_embedding-749"><span class="linenos">749</span></a>            <span class="c1">#tmp_stim = np.transpose( tmp_stim, axes=[0,2,3,4,1] )</span>
</span><span id="ColorClouds.time_embedding-750"><a href="#ColorClouds.time_embedding-750"><span class="linenos">750</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span> <span class="n">tmp_stim</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
</span><span id="ColorClouds.time_embedding-751"><a href="#ColorClouds.time_embedding-751"><span class="linenos">751</span></a>        <span class="k">return</span> <span class="n">tmp_stim</span>
</span></pre></div>


            <div class="docstring"><p>Note this overloads SensoryBase because reshapes in full dimensions to handle folded_lags</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>stim (torch.tensor):</strong>  stimulus to time-embed</li>
<li><strong>nlags (int):</strong>  number of lags to use</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>torch.tensor: time-embedded stimulus</p>
</blockquote>
</div>


                            </div>
                            <div id="ColorClouds.rectangle_overlap_ranges" class="classattr">
                                        <input id="ColorClouds.rectangle_overlap_ranges-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">rectangle_overlap_ranges</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">A</span>, </span><span class="param"><span class="n">B</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ColorClouds.rectangle_overlap_ranges-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ColorClouds.rectangle_overlap_ranges"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ColorClouds.rectangle_overlap_ranges-754"><a href="#ColorClouds.rectangle_overlap_ranges-754"><span class="linenos">754</span></a>    <span class="nd">@staticmethod</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-755"><a href="#ColorClouds.rectangle_overlap_ranges-755"><span class="linenos">755</span></a>    <span class="k">def</span> <span class="nf">rectangle_overlap_ranges</span><span class="p">(</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span> <span class="p">):</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-756"><a href="#ColorClouds.rectangle_overlap_ranges-756"><span class="linenos">756</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-757"><a href="#ColorClouds.rectangle_overlap_ranges-757"><span class="linenos">757</span></a><span class="sd">        Figures out ranges to write relevant overlap of B onto A</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-758"><a href="#ColorClouds.rectangle_overlap_ranges-758"><span class="linenos">758</span></a><span class="sd">        All info is of form [x0, y0, x1, y1]</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-759"><a href="#ColorClouds.rectangle_overlap_ranges-759"><span class="linenos">759</span></a><span class="sd">        </span>
</span><span id="ColorClouds.rectangle_overlap_ranges-760"><a href="#ColorClouds.rectangle_overlap_ranges-760"><span class="linenos">760</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-761"><a href="#ColorClouds.rectangle_overlap_ranges-761"><span class="linenos">761</span></a><span class="sd">            A (list): [x0, y0, x1, y1]</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-762"><a href="#ColorClouds.rectangle_overlap_ranges-762"><span class="linenos">762</span></a><span class="sd">            B (list): [x0, y0, x1, y1]</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-763"><a href="#ColorClouds.rectangle_overlap_ranges-763"><span class="linenos">763</span></a>
</span><span id="ColorClouds.rectangle_overlap_ranges-764"><a href="#ColorClouds.rectangle_overlap_ranges-764"><span class="linenos">764</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-765"><a href="#ColorClouds.rectangle_overlap_ranges-765"><span class="linenos">765</span></a><span class="sd">            dict: ranges to write to A from B</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-766"><a href="#ColorClouds.rectangle_overlap_ranges-766"><span class="linenos">766</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-767"><a href="#ColorClouds.rectangle_overlap_ranges-767"><span class="linenos">767</span></a>        <span class="n">C</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-768"><a href="#ColorClouds.rectangle_overlap_ranges-768"><span class="linenos">768</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-769"><a href="#ColorClouds.rectangle_overlap_ranges-769"><span class="linenos">769</span></a>            <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span> 
</span><span id="ColorClouds.rectangle_overlap_ranges-770"><a href="#ColorClouds.rectangle_overlap_ranges-770"><span class="linenos">770</span></a>                <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-771"><a href="#ColorClouds.rectangle_overlap_ranges-771"><span class="linenos">771</span></a>                <span class="n">D</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-772"><a href="#ColorClouds.rectangle_overlap_ranges-772"><span class="linenos">772</span></a>                <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]:</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-773"><a href="#ColorClouds.rectangle_overlap_ranges-773"><span class="linenos">773</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-774"><a href="#ColorClouds.rectangle_overlap_ranges-774"><span class="linenos">774</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> 
</span><span id="ColorClouds.rectangle_overlap_ranges-775"><a href="#ColorClouds.rectangle_overlap_ranges-775"><span class="linenos">775</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-776"><a href="#ColorClouds.rectangle_overlap_ranges-776"><span class="linenos">776</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-777"><a href="#ColorClouds.rectangle_overlap_ranges-777"><span class="linenos">777</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-778"><a href="#ColorClouds.rectangle_overlap_ranges-778"><span class="linenos">778</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-779"><a href="#ColorClouds.rectangle_overlap_ranges-779"><span class="linenos">779</span></a>                <span class="n">C</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-780"><a href="#ColorClouds.rectangle_overlap_ranges-780"><span class="linenos">780</span></a>                <span class="n">D</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-781"><a href="#ColorClouds.rectangle_overlap_ranges-781"><span class="linenos">781</span></a>                <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]:</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-782"><a href="#ColorClouds.rectangle_overlap_ranges-782"><span class="linenos">782</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-783"><a href="#ColorClouds.rectangle_overlap_ranges-783"><span class="linenos">783</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-784"><a href="#ColorClouds.rectangle_overlap_ranges-784"><span class="linenos">784</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-785"><a href="#ColorClouds.rectangle_overlap_ranges-785"><span class="linenos">785</span></a>                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-786"><a href="#ColorClouds.rectangle_overlap_ranges-786"><span class="linenos">786</span></a>                    <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">B</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-787"><a href="#ColorClouds.rectangle_overlap_ranges-787"><span class="linenos">787</span></a>
</span><span id="ColorClouds.rectangle_overlap_ranges-788"><a href="#ColorClouds.rectangle_overlap_ranges-788"><span class="linenos">788</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-789"><a href="#ColorClouds.rectangle_overlap_ranges-789"><span class="linenos">789</span></a>            <span class="k">return</span> <span class="kc">None</span>  
</span><span id="ColorClouds.rectangle_overlap_ranges-790"><a href="#ColorClouds.rectangle_overlap_ranges-790"><span class="linenos">790</span></a>        <span class="n">ranges</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-791"><a href="#ColorClouds.rectangle_overlap_ranges-791"><span class="linenos">791</span></a>            <span class="s1">&#39;targetX&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-792"><a href="#ColorClouds.rectangle_overlap_ranges-792"><span class="linenos">792</span></a>            <span class="s1">&#39;targetY&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">C</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-793"><a href="#ColorClouds.rectangle_overlap_ranges-793"><span class="linenos">793</span></a>            <span class="s1">&#39;readX&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-794"><a href="#ColorClouds.rectangle_overlap_ranges-794"><span class="linenos">794</span></a>            <span class="s1">&#39;readY&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">D</span><span class="p">[</span><span class="mi">3</span><span class="p">])}</span>
</span><span id="ColorClouds.rectangle_overlap_ranges-795"><a href="#ColorClouds.rectangle_overlap_ranges-795"><span class="linenos">795</span></a>        <span class="k">return</span> <span class="n">ranges</span>
</span></pre></div>


            <div class="docstring"><p>Figures out ranges to write relevant overlap of B onto A
All info is of form [x0, y0, x1, y1]</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>A (list):</strong>  [x0, y0, x1, y1]</li>
<li><strong>B (list):</strong>  [x0, y0, x1, y1]</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>dict: ranges to write to A from B</p>
</blockquote>
</div>


                            </div>
                            <div id="ColorClouds.wrap_stim" class="classattr">
                                        <input id="ColorClouds.wrap_stim-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wrap_stim</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">vwrap</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">hwrap</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ColorClouds.wrap_stim-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ColorClouds.wrap_stim"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ColorClouds.wrap_stim-797"><a href="#ColorClouds.wrap_stim-797"><span class="linenos">797</span></a>    <span class="k">def</span> <span class="nf">wrap_stim</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">vwrap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hwrap</span><span class="o">=</span><span class="mi">0</span> <span class="p">):</span>
</span><span id="ColorClouds.wrap_stim-798"><a href="#ColorClouds.wrap_stim-798"><span class="linenos">798</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds.wrap_stim-799"><a href="#ColorClouds.wrap_stim-799"><span class="linenos">799</span></a><span class="sd">        Take existing stimulus and move the whole thing around in horizontal and/or vertical dims,</span>
</span><span id="ColorClouds.wrap_stim-800"><a href="#ColorClouds.wrap_stim-800"><span class="linenos">800</span></a><span class="sd">        including if time_embedded</span>
</span><span id="ColorClouds.wrap_stim-801"><a href="#ColorClouds.wrap_stim-801"><span class="linenos">801</span></a><span class="sd">        </span>
</span><span id="ColorClouds.wrap_stim-802"><a href="#ColorClouds.wrap_stim-802"><span class="linenos">802</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds.wrap_stim-803"><a href="#ColorClouds.wrap_stim-803"><span class="linenos">803</span></a><span class="sd">            vwrap (int): vertical wrap</span>
</span><span id="ColorClouds.wrap_stim-804"><a href="#ColorClouds.wrap_stim-804"><span class="linenos">804</span></a><span class="sd">            hwrap (int): horizontal wrap</span>
</span><span id="ColorClouds.wrap_stim-805"><a href="#ColorClouds.wrap_stim-805"><span class="linenos">805</span></a>
</span><span id="ColorClouds.wrap_stim-806"><a href="#ColorClouds.wrap_stim-806"><span class="linenos">806</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds.wrap_stim-807"><a href="#ColorClouds.wrap_stim-807"><span class="linenos">807</span></a><span class="sd">            None</span>
</span><span id="ColorClouds.wrap_stim-808"><a href="#ColorClouds.wrap_stim-808"><span class="linenos">808</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds.wrap_stim-809"><a href="#ColorClouds.wrap_stim-809"><span class="linenos">809</span></a>
</span><span id="ColorClouds.wrap_stim-810"><a href="#ColorClouds.wrap_stim-810"><span class="linenos">810</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must assemble the stimulus before using wrap_stim.&quot;</span>
</span><span id="ColorClouds.wrap_stim-811"><a href="#ColorClouds.wrap_stim-811"><span class="linenos">811</span></a>        <span class="n">orig_stim_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="ColorClouds.wrap_stim-812"><a href="#ColorClouds.wrap_stim-812"><span class="linenos">812</span></a>        <span class="k">if</span> <span class="n">orig_stim_dims</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="ColorClouds.wrap_stim-813"><a href="#ColorClouds.wrap_stim-813"><span class="linenos">813</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span>
</span><span id="ColorClouds.wrap_stim-814"><a href="#ColorClouds.wrap_stim-814"><span class="linenos">814</span></a>        <span class="k">elif</span> <span class="n">orig_stim_dims</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="ColorClouds.wrap_stim-815"><a href="#ColorClouds.wrap_stim-815"><span class="linenos">815</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">])</span>  <span class="c1"># put in lags as one dim</span>
</span><span id="ColorClouds.wrap_stim-816"><a href="#ColorClouds.wrap_stim-816"><span class="linenos">816</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.wrap_stim-817"><a href="#ColorClouds.wrap_stim-817"><span class="linenos">817</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</span><span id="ColorClouds.wrap_stim-818"><a href="#ColorClouds.wrap_stim-818"><span class="linenos">818</span></a>
</span><span id="ColorClouds.wrap_stim-819"><a href="#ColorClouds.wrap_stim-819"><span class="linenos">819</span></a>        <span class="n">NY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="ColorClouds.wrap_stim-820"><a href="#ColorClouds.wrap_stim-820"><span class="linenos">820</span></a>        <span class="k">if</span> <span class="n">vwrap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds.wrap_stim-821"><a href="#ColorClouds.wrap_stim-821"><span class="linenos">821</span></a>            <span class="n">tmp2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tmp_stim</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">tmp_stim</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds.wrap_stim-822"><a href="#ColorClouds.wrap_stim-822"><span class="linenos">822</span></a>            <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">vwrap</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">(</span><span class="n">NY</span><span class="o">-</span><span class="n">vwrap</span><span class="p">):,</span> <span class="p">:]</span>
</span><span id="ColorClouds.wrap_stim-823"><a href="#ColorClouds.wrap_stim-823"><span class="linenos">823</span></a>            <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">vwrap</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="n">NY</span><span class="o">-</span><span class="n">vwrap</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="ColorClouds.wrap_stim-824"><a href="#ColorClouds.wrap_stim-824"><span class="linenos">824</span></a>        <span class="k">elif</span> <span class="n">vwrap</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds.wrap_stim-825"><a href="#ColorClouds.wrap_stim-825"><span class="linenos">825</span></a>            <span class="n">tmp2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tmp_stim</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">tmp_stim</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds.wrap_stim-826"><a href="#ColorClouds.wrap_stim-826"><span class="linenos">826</span></a>            <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">(</span><span class="n">NY</span><span class="o">+</span><span class="n">vwrap</span><span class="p">):,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="o">-</span><span class="n">vwrap</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="ColorClouds.wrap_stim-827"><a href="#ColorClouds.wrap_stim-827"><span class="linenos">827</span></a>            <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="n">NY</span><span class="o">+</span><span class="n">vwrap</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp_stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">(</span><span class="o">-</span><span class="n">vwrap</span><span class="p">):,</span> <span class="p">:]</span>
</span><span id="ColorClouds.wrap_stim-828"><a href="#ColorClouds.wrap_stim-828"><span class="linenos">828</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.wrap_stim-829"><a href="#ColorClouds.wrap_stim-829"><span class="linenos">829</span></a>            <span class="n">tmp2</span> <span class="o">=</span> <span class="n">tmp_stim</span>
</span><span id="ColorClouds.wrap_stim-830"><a href="#ColorClouds.wrap_stim-830"><span class="linenos">830</span></a>
</span><span id="ColorClouds.wrap_stim-831"><a href="#ColorClouds.wrap_stim-831"><span class="linenos">831</span></a>        <span class="n">NX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds.wrap_stim-832"><a href="#ColorClouds.wrap_stim-832"><span class="linenos">832</span></a>        <span class="k">if</span> <span class="n">hwrap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds.wrap_stim-833"><a href="#ColorClouds.wrap_stim-833"><span class="linenos">833</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tmp2</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">tmp2</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds.wrap_stim-834"><a href="#ColorClouds.wrap_stim-834"><span class="linenos">834</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">hwrap</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">(</span><span class="n">NX</span><span class="o">-</span><span class="n">hwrap</span><span class="p">):,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="ColorClouds.wrap_stim-835"><a href="#ColorClouds.wrap_stim-835"><span class="linenos">835</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">hwrap</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="n">NX</span><span class="o">-</span><span class="n">hwrap</span><span class="p">),</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="ColorClouds.wrap_stim-836"><a href="#ColorClouds.wrap_stim-836"><span class="linenos">836</span></a>        <span class="k">elif</span> <span class="n">hwrap</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds.wrap_stim-837"><a href="#ColorClouds.wrap_stim-837"><span class="linenos">837</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tmp2</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">tmp2</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds.wrap_stim-838"><a href="#ColorClouds.wrap_stim-838"><span class="linenos">838</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">(</span><span class="n">NX</span><span class="o">+</span><span class="n">hwrap</span><span class="p">):,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="o">-</span><span class="n">hwrap</span><span class="p">),</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="ColorClouds.wrap_stim-839"><a href="#ColorClouds.wrap_stim-839"><span class="linenos">839</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="n">NX</span><span class="o">+</span><span class="n">hwrap</span><span class="p">),</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">(</span><span class="o">-</span><span class="n">hwrap</span><span class="p">):,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="ColorClouds.wrap_stim-840"><a href="#ColorClouds.wrap_stim-840"><span class="linenos">840</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.wrap_stim-841"><a href="#ColorClouds.wrap_stim-841"><span class="linenos">841</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tmp2</span><span class="p">)</span>
</span><span id="ColorClouds.wrap_stim-842"><a href="#ColorClouds.wrap_stim-842"><span class="linenos">842</span></a>
</span><span id="ColorClouds.wrap_stim-843"><a href="#ColorClouds.wrap_stim-843"><span class="linenos">843</span></a>        <span class="k">if</span> <span class="n">orig_stim_dims</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="ColorClouds.wrap_stim-844"><a href="#ColorClouds.wrap_stim-844"><span class="linenos">844</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="ColorClouds.wrap_stim-845"><a href="#ColorClouds.wrap_stim-845"><span class="linenos">845</span></a>        <span class="k">elif</span> <span class="n">orig_stim_dims</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="ColorClouds.wrap_stim-846"><a href="#ColorClouds.wrap_stim-846"><span class="linenos">846</span></a>            <span class="c1"># Take out extra lag dim</span>
</span><span id="ColorClouds.wrap_stim-847"><a href="#ColorClouds.wrap_stim-847"><span class="linenos">847</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Take existing stimulus and move the whole thing around in horizontal and/or vertical dims,
including if time_embedded</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>vwrap (int):</strong>  vertical wrap</li>
<li><strong>hwrap (int):</strong>  horizontal wrap</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="ColorClouds.crop_stim" class="classattr">
                                        <input id="ColorClouds.crop_stim-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">crop_stim</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ColorClouds.crop_stim-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ColorClouds.crop_stim"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ColorClouds.crop_stim-850"><a href="#ColorClouds.crop_stim-850"><span class="linenos">850</span></a>    <span class="k">def</span> <span class="nf">crop_stim</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="ColorClouds.crop_stim-851"><a href="#ColorClouds.crop_stim-851"><span class="linenos">851</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds.crop_stim-852"><a href="#ColorClouds.crop_stim-852"><span class="linenos">852</span></a><span class="sd">        Crop existing (torch) stimulus and change relevant variables [x1, x2, y1, y2]</span>
</span><span id="ColorClouds.crop_stim-853"><a href="#ColorClouds.crop_stim-853"><span class="linenos">853</span></a><span class="sd">        </span>
</span><span id="ColorClouds.crop_stim-854"><a href="#ColorClouds.crop_stim-854"><span class="linenos">854</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds.crop_stim-855"><a href="#ColorClouds.crop_stim-855"><span class="linenos">855</span></a><span class="sd">            stim_crop (list): [x1, x2, y1, y2]</span>
</span><span id="ColorClouds.crop_stim-856"><a href="#ColorClouds.crop_stim-856"><span class="linenos">856</span></a>
</span><span id="ColorClouds.crop_stim-857"><a href="#ColorClouds.crop_stim-857"><span class="linenos">857</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds.crop_stim-858"><a href="#ColorClouds.crop_stim-858"><span class="linenos">858</span></a><span class="sd">            None</span>
</span><span id="ColorClouds.crop_stim-859"><a href="#ColorClouds.crop_stim-859"><span class="linenos">859</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds.crop_stim-860"><a href="#ColorClouds.crop_stim-860"><span class="linenos">860</span></a>        <span class="k">if</span> <span class="n">stim_crop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.crop_stim-861"><a href="#ColorClouds.crop_stim-861"><span class="linenos">861</span></a>            <span class="n">stim_crop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span>
</span><span id="ColorClouds.crop_stim-862"><a href="#ColorClouds.crop_stim-862"><span class="linenos">862</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.crop_stim-863"><a href="#ColorClouds.crop_stim-863"><span class="linenos">863</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="o">=</span> <span class="n">stim_crop</span> 
</span><span id="ColorClouds.crop_stim-864"><a href="#ColorClouds.crop_stim-864"><span class="linenos">864</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_crop</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;stim_crop must be of form: [x1, x2, y1, y2]&quot;</span>
</span><span id="ColorClouds.crop_stim-865"><a href="#ColorClouds.crop_stim-865"><span class="linenos">865</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="ColorClouds.crop_stim-866"><a href="#ColorClouds.crop_stim-866"><span class="linenos">866</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">)</span>
</span><span id="ColorClouds.crop_stim-867"><a href="#ColorClouds.crop_stim-867"><span class="linenos">867</span></a>            <span class="n">reshape</span><span class="o">=</span><span class="kc">True</span>
</span><span id="ColorClouds.crop_stim-868"><a href="#ColorClouds.crop_stim-868"><span class="linenos">868</span></a>            <span class="c1">#print(&#39;  CROP: reshaping stim&#39;)</span>
</span><span id="ColorClouds.crop_stim-869"><a href="#ColorClouds.crop_stim-869"><span class="linenos">869</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.crop_stim-870"><a href="#ColorClouds.crop_stim-870"><span class="linenos">870</span></a>            <span class="n">reshape</span><span class="o">=</span><span class="kc">False</span>
</span><span id="ColorClouds.crop_stim-871"><a href="#ColorClouds.crop_stim-871"><span class="linenos">871</span></a>        <span class="c1">#stim_crop = np.array(stim_crop, dtype=np.int64) # make sure array</span>
</span><span id="ColorClouds.crop_stim-872"><a href="#ColorClouds.crop_stim-872"><span class="linenos">872</span></a>        <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stim_crop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stim_crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ColorClouds.crop_stim-873"><a href="#ColorClouds.crop_stim-873"><span class="linenos">873</span></a>        <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stim_crop</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">stim_crop</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ColorClouds.crop_stim-874"><a href="#ColorClouds.crop_stim-874"><span class="linenos">874</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="ColorClouds.crop_stim-875"><a href="#ColorClouds.crop_stim-875"><span class="linenos">875</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">ys</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">xs</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds.crop_stim-876"><a href="#ColorClouds.crop_stim-876"><span class="linenos">876</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># then lagged -- need extra dim</span>
</span><span id="ColorClouds.crop_stim-877"><a href="#ColorClouds.crop_stim-877"><span class="linenos">877</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">ys</span><span class="p">,</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="n">xs</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="ColorClouds.crop_stim-878"><a href="#ColorClouds.crop_stim-878"><span class="linenos">878</span></a>
</span><span id="ColorClouds.crop_stim-879"><a href="#ColorClouds.crop_stim-879"><span class="linenos">879</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  CROP: New stim size: </span><span class="si">%d</span><span class="s2"> x </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)))</span>
</span><span id="ColorClouds.crop_stim-880"><a href="#ColorClouds.crop_stim-880"><span class="linenos">880</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
</span><span id="ColorClouds.crop_stim-881"><a href="#ColorClouds.crop_stim-881"><span class="linenos">881</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
</span><span id="ColorClouds.crop_stim-882"><a href="#ColorClouds.crop_stim-882"><span class="linenos">882</span></a>        <span class="k">if</span> <span class="n">reshape</span><span class="p">:</span>
</span><span id="ColorClouds.crop_stim-883"><a href="#ColorClouds.crop_stim-883"><span class="linenos">883</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;reshaping back&#39;</span><span class="p">)</span>
</span><span id="ColorClouds.crop_stim-884"><a href="#ColorClouds.crop_stim-884"><span class="linenos">884</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Crop existing (torch) stimulus and change relevant variables [x1, x2, y1, y2]</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>stim_crop (list):</strong>  [x1, x2, y1, y2]</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="ColorClouds.process_fixations" class="classattr">
                                        <input id="ColorClouds.process_fixations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">process_fixations</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">sacc_in</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ColorClouds.process_fixations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ColorClouds.process_fixations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ColorClouds.process_fixations-888"><a href="#ColorClouds.process_fixations-888"><span class="linenos">888</span></a>    <span class="k">def</span> <span class="nf">process_fixations</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sacc_in</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="ColorClouds.process_fixations-889"><a href="#ColorClouds.process_fixations-889"><span class="linenos">889</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds.process_fixations-890"><a href="#ColorClouds.process_fixations-890"><span class="linenos">890</span></a><span class="sd">        Processes fixation informatiom from dataset, but also allows new saccade detection</span>
</span><span id="ColorClouds.process_fixations-891"><a href="#ColorClouds.process_fixations-891"><span class="linenos">891</span></a><span class="sd">        to be input and put in the right format within the dataset (main use)</span>
</span><span id="ColorClouds.process_fixations-892"><a href="#ColorClouds.process_fixations-892"><span class="linenos">892</span></a><span class="sd">        </span>
</span><span id="ColorClouds.process_fixations-893"><a href="#ColorClouds.process_fixations-893"><span class="linenos">893</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds.process_fixations-894"><a href="#ColorClouds.process_fixations-894"><span class="linenos">894</span></a><span class="sd">            sacc_in (np.ndarray): saccade times</span>
</span><span id="ColorClouds.process_fixations-895"><a href="#ColorClouds.process_fixations-895"><span class="linenos">895</span></a>
</span><span id="ColorClouds.process_fixations-896"><a href="#ColorClouds.process_fixations-896"><span class="linenos">896</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds.process_fixations-897"><a href="#ColorClouds.process_fixations-897"><span class="linenos">897</span></a><span class="sd">            None</span>
</span><span id="ColorClouds.process_fixations-898"><a href="#ColorClouds.process_fixations-898"><span class="linenos">898</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds.process_fixations-899"><a href="#ColorClouds.process_fixations-899"><span class="linenos">899</span></a>        <span class="k">if</span> <span class="n">sacc_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.process_fixations-900"><a href="#ColorClouds.process_fixations-900"><span class="linenos">900</span></a>            <span class="n">sacc_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.process_fixations-901"><a href="#ColorClouds.process_fixations-901"><span class="linenos">901</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.process_fixations-902"><a href="#ColorClouds.process_fixations-902"><span class="linenos">902</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Redoing fix_n with saccade inputs: </span><span class="si">%d</span><span class="s2"> saccades&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">sacc_in</span><span class="p">)</span> <span class="p">)</span>
</span><span id="ColorClouds.process_fixations-903"><a href="#ColorClouds.process_fixations-903"><span class="linenos">903</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds.process_fixations-904"><a href="#ColorClouds.process_fixations-904"><span class="linenos">904</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  -&gt; Adjusting timing for non-zero start time in this dataset.&quot;</span><span class="p">)</span>
</span><span id="ColorClouds.process_fixations-905"><a href="#ColorClouds.process_fixations-905"><span class="linenos">905</span></a>            <span class="n">sacc_in</span> <span class="o">=</span> <span class="n">sacc_in</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span>
</span><span id="ColorClouds.process_fixations-906"><a href="#ColorClouds.process_fixations-906"><span class="linenos">906</span></a>            <span class="n">sacc_in</span> <span class="o">=</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">sacc_in</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.process_fixations-907"><a href="#ColorClouds.process_fixations-907"><span class="linenos">907</span></a>
</span><span id="ColorClouds.process_fixations-908"><a href="#ColorClouds.process_fixations-908"><span class="linenos">908</span></a>        <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> 
</span><span id="ColorClouds.process_fixations-909"><a href="#ColorClouds.process_fixations-909"><span class="linenos">909</span></a>        <span class="n">fix_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds.process_fixations-910"><a href="#ColorClouds.process_fixations-910"><span class="linenos">910</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">)):</span>
</span><span id="ColorClouds.process_fixations-911"><a href="#ColorClouds.process_fixations-911"><span class="linenos">911</span></a>            <span class="c1">#if self.block_inds[ii][0] &lt; self.NT:</span>
</span><span id="ColorClouds.process_fixations-912"><a href="#ColorClouds.process_fixations-912"><span class="linenos">912</span></a>            <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="ColorClouds.process_fixations-913"><a href="#ColorClouds.process_fixations-913"><span class="linenos">913</span></a>            <span class="c1">#self.block_inds.append(np.arange( blk_inds[ii,0], blk_inds[ii,1], dtype=np.int64))</span>
</span><span id="ColorClouds.process_fixations-914"><a href="#ColorClouds.process_fixations-914"><span class="linenos">914</span></a>
</span><span id="ColorClouds.process_fixations-915"><a href="#ColorClouds.process_fixations-915"><span class="linenos">915</span></a>            <span class="c1"># Parse fixation numbers within block</span>
</span><span id="ColorClouds.process_fixations-916"><a href="#ColorClouds.process_fixations-916"><span class="linenos">916</span></a>            <span class="n">rel_saccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">sacc_in</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sacc_in</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">5</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.process_fixations-917"><a href="#ColorClouds.process_fixations-917"><span class="linenos">917</span></a>
</span><span id="ColorClouds.process_fixations-918"><a href="#ColorClouds.process_fixations-918"><span class="linenos">918</span></a>            <span class="n">tfix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Beginning of fixation by definition</span>
</span><span id="ColorClouds.process_fixations-919"><a href="#ColorClouds.process_fixations-919"><span class="linenos">919</span></a>            <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel_saccs</span><span class="p">)):</span>
</span><span id="ColorClouds.process_fixations-920"><a href="#ColorClouds.process_fixations-920"><span class="linenos">920</span></a>                <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ColorClouds.process_fixations-921"><a href="#ColorClouds.process_fixations-921"><span class="linenos">921</span></a>                <span class="c1"># Range goes to beginning of next fixation (note no gap)</span>
</span><span id="ColorClouds.process_fixations-922"><a href="#ColorClouds.process_fixations-922"><span class="linenos">922</span></a>                <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="ColorClouds.process_fixations-923"><a href="#ColorClouds.process_fixations-923"><span class="linenos">923</span></a>                <span class="n">tfix</span> <span class="o">=</span> <span class="n">sacc_in</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">]]</span>
</span><span id="ColorClouds.process_fixations-924"><a href="#ColorClouds.process_fixations-924"><span class="linenos">924</span></a>            <span class="c1"># Put in last (or only) fixation number</span>
</span><span id="ColorClouds.process_fixations-925"><a href="#ColorClouds.process_fixations-925"><span class="linenos">925</span></a>            <span class="k">if</span> <span class="n">tfix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="ColorClouds.process_fixations-926"><a href="#ColorClouds.process_fixations-926"><span class="linenos">926</span></a>                <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ColorClouds.process_fixations-927"><a href="#ColorClouds.process_fixations-927"><span class="linenos">927</span></a>                <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">tfix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="ColorClouds.process_fixations-928"><a href="#ColorClouds.process_fixations-928"><span class="linenos">928</span></a>
</span><span id="ColorClouds.process_fixations-929"><a href="#ColorClouds.process_fixations-929"><span class="linenos">929</span></a>        <span class="c1"># Determine whether to be numpy or tensor</span>
</span><span id="ColorClouds.process_fixations-930"><a href="#ColorClouds.process_fixations-930"><span class="linenos">930</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="ColorClouds.process_fixations-931"><a href="#ColorClouds.process_fixations-931"><span class="linenos">931</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds.process_fixations-932"><a href="#ColorClouds.process_fixations-932"><span class="linenos">932</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.process_fixations-933"><a href="#ColorClouds.process_fixations-933"><span class="linenos">933</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">fix_n</span>
</span></pre></div>


            <div class="docstring"><p>Processes fixation informatiom from dataset, but also allows new saccade detection
to be input and put in the right format within the dataset (main use)</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>sacc_in (np.ndarray):</strong>  saccade times</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="ColorClouds.augment_dfs" class="classattr">
                                        <input id="ColorClouds.augment_dfs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">augment_dfs</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">new_dfs</span>, </span><span class="param"><span class="n">cells</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ColorClouds.augment_dfs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ColorClouds.augment_dfs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ColorClouds.augment_dfs-936"><a href="#ColorClouds.augment_dfs-936"><span class="linenos">936</span></a>    <span class="k">def</span> <span class="nf">augment_dfs</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">new_dfs</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="ColorClouds.augment_dfs-937"><a href="#ColorClouds.augment_dfs-937"><span class="linenos">937</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds.augment_dfs-938"><a href="#ColorClouds.augment_dfs-938"><span class="linenos">938</span></a><span class="sd">        Replaces data-filter for given cells. note that new_df should be np.ndarray</span>
</span><span id="ColorClouds.augment_dfs-939"><a href="#ColorClouds.augment_dfs-939"><span class="linenos">939</span></a><span class="sd">        </span>
</span><span id="ColorClouds.augment_dfs-940"><a href="#ColorClouds.augment_dfs-940"><span class="linenos">940</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds.augment_dfs-941"><a href="#ColorClouds.augment_dfs-941"><span class="linenos">941</span></a><span class="sd">            new_dfs (np.ndarray): new datafilters</span>
</span><span id="ColorClouds.augment_dfs-942"><a href="#ColorClouds.augment_dfs-942"><span class="linenos">942</span></a><span class="sd">            cells (list): cells to replace datafilters for</span>
</span><span id="ColorClouds.augment_dfs-943"><a href="#ColorClouds.augment_dfs-943"><span class="linenos">943</span></a>
</span><span id="ColorClouds.augment_dfs-944"><a href="#ColorClouds.augment_dfs-944"><span class="linenos">944</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds.augment_dfs-945"><a href="#ColorClouds.augment_dfs-945"><span class="linenos">945</span></a><span class="sd">            None</span>
</span><span id="ColorClouds.augment_dfs-946"><a href="#ColorClouds.augment_dfs-946"><span class="linenos">946</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds.augment_dfs-947"><a href="#ColorClouds.augment_dfs-947"><span class="linenos">947</span></a>        
</span><span id="ColorClouds.augment_dfs-948"><a href="#ColorClouds.augment_dfs-948"><span class="linenos">948</span></a>        <span class="n">NTdf</span><span class="p">,</span> <span class="n">NCdf</span> <span class="o">=</span> <span class="n">new_dfs</span><span class="o">.</span><span class="n">shape</span> 
</span><span id="ColorClouds.augment_dfs-949"><a href="#ColorClouds.augment_dfs-949"><span class="linenos">949</span></a>        <span class="k">if</span> <span class="n">cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.augment_dfs-950"><a href="#ColorClouds.augment_dfs-950"><span class="linenos">950</span></a>            <span class="k">assert</span> <span class="n">NCdf</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;new DF is wrong shape to replace DF for all cells.&quot;</span>
</span><span id="ColorClouds.augment_dfs-951"><a href="#ColorClouds.augment_dfs-951"><span class="linenos">951</span></a>            <span class="n">cells</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="ColorClouds.augment_dfs-952"><a href="#ColorClouds.augment_dfs-952"><span class="linenos">952</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">&lt;</span> <span class="n">NTdf</span><span class="p">:</span>
</span><span id="ColorClouds.augment_dfs-953"><a href="#ColorClouds.augment_dfs-953"><span class="linenos">953</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cells</span><span class="p">]</span> <span class="o">*=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">new_dfs</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.augment_dfs-954"><a href="#ColorClouds.augment_dfs-954"><span class="linenos">954</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.augment_dfs-955"><a href="#ColorClouds.augment_dfs-955"><span class="linenos">955</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">&gt;</span> <span class="n">NTdf</span><span class="p">:</span>
</span><span id="ColorClouds.augment_dfs-956"><a href="#ColorClouds.augment_dfs-956"><span class="linenos">956</span></a>                <span class="c1"># Assume dfs are 0 after new valid region</span>
</span><span id="ColorClouds.augment_dfs-957"><a href="#ColorClouds.augment_dfs-957"><span class="linenos">957</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Truncating valid region to new datafilter length&quot;</span><span class="p">,</span> <span class="n">NTdf</span><span class="p">)</span>
</span><span id="ColorClouds.augment_dfs-958"><a href="#ColorClouds.augment_dfs-958"><span class="linenos">958</span></a>                <span class="n">new_dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> 
</span><span id="ColorClouds.augment_dfs-959"><a href="#ColorClouds.augment_dfs-959"><span class="linenos">959</span></a>                    <span class="p">(</span><span class="n">new_dfs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="o">-</span><span class="n">NTdf</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span> 
</span><span id="ColorClouds.augment_dfs-960"><a href="#ColorClouds.augment_dfs-960"><span class="linenos">960</span></a>                    <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ColorClouds.augment_dfs-961"><a href="#ColorClouds.augment_dfs-961"><span class="linenos">961</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cells</span><span class="p">]</span> <span class="o">*=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">new_dfs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.augment_dfs-962"><a href="#ColorClouds.augment_dfs-962"><span class="linenos">962</span></a>        <span class="c1"># END ColorClouds.replace_dfs()</span>
</span></pre></div>


            <div class="docstring"><p>Replaces data-filter for given cells. note that new_df should be np.ndarray</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>new_dfs (np.ndarray):</strong>  new datafilters</li>
<li><strong>cells (list):</strong>  cells to replace datafilters for</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="ColorClouds.draw_stim_locations" class="classattr">
                                        <input id="ColorClouds.draw_stim_locations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">draw_stim_locations</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">top_corner</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">L</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">row_height</span><span class="o">=</span><span class="mf">5.0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ColorClouds.draw_stim_locations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ColorClouds.draw_stim_locations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ColorClouds.draw_stim_locations-964"><a href="#ColorClouds.draw_stim_locations-964"><span class="linenos"> 964</span></a>    <span class="k">def</span> <span class="nf">draw_stim_locations</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">top_corner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">row_height</span><span class="o">=</span><span class="mf">5.0</span> <span class="p">):</span>
</span><span id="ColorClouds.draw_stim_locations-965"><a href="#ColorClouds.draw_stim_locations-965"><span class="linenos"> 965</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds.draw_stim_locations-966"><a href="#ColorClouds.draw_stim_locations-966"><span class="linenos"> 966</span></a><span class="sd">        Draws stimulus locations</span>
</span><span id="ColorClouds.draw_stim_locations-967"><a href="#ColorClouds.draw_stim_locations-967"><span class="linenos"> 967</span></a>
</span><span id="ColorClouds.draw_stim_locations-968"><a href="#ColorClouds.draw_stim_locations-968"><span class="linenos"> 968</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds.draw_stim_locations-969"><a href="#ColorClouds.draw_stim_locations-969"><span class="linenos"> 969</span></a><span class="sd">            top_corner (list): top corner of stimulus</span>
</span><span id="ColorClouds.draw_stim_locations-970"><a href="#ColorClouds.draw_stim_locations-970"><span class="linenos"> 970</span></a><span class="sd">            L (int): length of stimulus</span>
</span><span id="ColorClouds.draw_stim_locations-971"><a href="#ColorClouds.draw_stim_locations-971"><span class="linenos"> 971</span></a><span class="sd">            row_height (float): height of row</span>
</span><span id="ColorClouds.draw_stim_locations-972"><a href="#ColorClouds.draw_stim_locations-972"><span class="linenos"> 972</span></a>
</span><span id="ColorClouds.draw_stim_locations-973"><a href="#ColorClouds.draw_stim_locations-973"><span class="linenos"> 973</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds.draw_stim_locations-974"><a href="#ColorClouds.draw_stim_locations-974"><span class="linenos"> 974</span></a><span class="sd">            None</span>
</span><span id="ColorClouds.draw_stim_locations-975"><a href="#ColorClouds.draw_stim_locations-975"><span class="linenos"> 975</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds.draw_stim_locations-976"><a href="#ColorClouds.draw_stim_locations-976"><span class="linenos"> 976</span></a>        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span id="ColorClouds.draw_stim_locations-977"><a href="#ColorClouds.draw_stim_locations-977"><span class="linenos"> 977</span></a>        <span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Rectangle</span>
</span><span id="ColorClouds.draw_stim_locations-978"><a href="#ColorClouds.draw_stim_locations-978"><span class="linenos"> 978</span></a>
</span><span id="ColorClouds.draw_stim_locations-979"><a href="#ColorClouds.draw_stim_locations-979"><span class="linenos"> 979</span></a>        <span class="n">lamlocs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_location</span>
</span><span id="ColorClouds.draw_stim_locations-980"><a href="#ColorClouds.draw_stim_locations-980"><span class="linenos"> 980</span></a>        <span class="n">ETlocs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_locationET</span>
</span><span id="ColorClouds.draw_stim_locations-981"><a href="#ColorClouds.draw_stim_locations-981"><span class="linenos"> 981</span></a>        <span class="n">fixloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span>
</span><span id="ColorClouds.draw_stim_locations-982"><a href="#ColorClouds.draw_stim_locations-982"><span class="linenos"> 982</span></a>        <span class="n">fixsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_size</span>
</span><span id="ColorClouds.draw_stim_locations-983"><a href="#ColorClouds.draw_stim_locations-983"><span class="linenos"> 983</span></a>        <span class="n">BUF</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="ColorClouds.draw_stim_locations-984"><a href="#ColorClouds.draw_stim_locations-984"><span class="linenos"> 984</span></a>        <span class="k">if</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.draw_stim_locations-985"><a href="#ColorClouds.draw_stim_locations-985"><span class="linenos"> 985</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">lamlocs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.draw_stim_locations-986"><a href="#ColorClouds.draw_stim_locations-986"><span class="linenos"> 986</span></a>
</span><span id="ColorClouds.draw_stim_locations-987"><a href="#ColorClouds.draw_stim_locations-987"><span class="linenos"> 987</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
</span><span id="ColorClouds.draw_stim_locations-988"><a href="#ColorClouds.draw_stim_locations-988"><span class="linenos"> 988</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">row_height</span><span class="p">,</span> <span class="n">row_height</span><span class="p">)</span>
</span><span id="ColorClouds.draw_stim_locations-989"><a href="#ColorClouds.draw_stim_locations-989"><span class="linenos"> 989</span></a>        <span class="n">nET</span> <span class="o">=</span> <span class="n">ETlocs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds.draw_stim_locations-990"><a href="#ColorClouds.draw_stim_locations-990"><span class="linenos"> 990</span></a>        <span class="n">nLAM</span> <span class="o">=</span> <span class="n">lamlocs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds.draw_stim_locations-991"><a href="#ColorClouds.draw_stim_locations-991"><span class="linenos"> 991</span></a>        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="ColorClouds.draw_stim_locations-992"><a href="#ColorClouds.draw_stim_locations-992"><span class="linenos"> 992</span></a>        <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">2</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="ColorClouds.draw_stim_locations-993"><a href="#ColorClouds.draw_stim_locations-993"><span class="linenos"> 993</span></a>        <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="ColorClouds.draw_stim_locations-994"><a href="#ColorClouds.draw_stim_locations-994"><span class="linenos"> 994</span></a>        <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">3</span><span class="p">,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">3</span><span class="p">,:])</span> <span class="p">)</span>
</span><span id="ColorClouds.draw_stim_locations-995"><a href="#ColorClouds.draw_stim_locations-995"><span class="linenos"> 995</span></a>        <span class="c1">#print(x0,x1,y0,y1)</span>
</span><span id="ColorClouds.draw_stim_locations-996"><a href="#ColorClouds.draw_stim_locations-996"><span class="linenos"> 996</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nLAM</span><span class="p">):</span>
</span><span id="ColorClouds.draw_stim_locations-997"><a href="#ColorClouds.draw_stim_locations-997"><span class="linenos"> 997</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
</span><span id="ColorClouds.draw_stim_locations-998"><a href="#ColorClouds.draw_stim_locations-998"><span class="linenos"> 998</span></a>                <span class="n">Rectangle</span><span class="p">((</span><span class="n">lamlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">lamlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ii</span><span class="p">]),</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> 
</span><span id="ColorClouds.draw_stim_locations-999"><a href="#ColorClouds.draw_stim_locations-999"><span class="linenos"> 999</span></a>                <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">))</span>
</span><span id="ColorClouds.draw_stim_locations-1000"><a href="#ColorClouds.draw_stim_locations-1000"><span class="linenos">1000</span></a>        <span class="n">clrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">]</span>
</span><span id="ColorClouds.draw_stim_locations-1001"><a href="#ColorClouds.draw_stim_locations-1001"><span class="linenos">1001</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nET</span><span class="p">):</span>
</span><span id="ColorClouds.draw_stim_locations-1002"><a href="#ColorClouds.draw_stim_locations-1002"><span class="linenos">1002</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">ETlocs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ii</span><span class="p">],</span> <span class="n">ETlocs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="p">]),</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> 
</span><span id="ColorClouds.draw_stim_locations-1003"><a href="#ColorClouds.draw_stim_locations-1003"><span class="linenos">1003</span></a>                                <span class="n">edgecolor</span><span class="o">=</span><span class="n">clrs</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span><span id="ColorClouds.draw_stim_locations-1004"><a href="#ColorClouds.draw_stim_locations-1004"><span class="linenos">1004</span></a>        <span class="k">if</span> <span class="n">fixloc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.draw_stim_locations-1005"><a href="#ColorClouds.draw_stim_locations-1005"><span class="linenos">1005</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">fixloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">fixsize</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fixloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">fixsize</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">fixsize</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">fixsize</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> 
</span><span id="ColorClouds.draw_stim_locations-1006"><a href="#ColorClouds.draw_stim_locations-1006"><span class="linenos">1006</span></a>                                <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</span><span id="ColorClouds.draw_stim_locations-1007"><a href="#ColorClouds.draw_stim_locations-1007"><span class="linenos">1007</span></a>        <span class="k">if</span> <span class="n">top_corner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.draw_stim_locations-1008"><a href="#ColorClouds.draw_stim_locations-1008"><span class="linenos">1008</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">(</span><span class="n">top_corner</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> 
</span><span id="ColorClouds.draw_stim_locations-1009"><a href="#ColorClouds.draw_stim_locations-1009"><span class="linenos">1009</span></a>                                <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">))</span>
</span><span id="ColorClouds.draw_stim_locations-1010"><a href="#ColorClouds.draw_stim_locations-1010"><span class="linenos">1010</span></a>            
</span><span id="ColorClouds.draw_stim_locations-1011"><a href="#ColorClouds.draw_stim_locations-1011"><span class="linenos">1011</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>
</span><span id="ColorClouds.draw_stim_locations-1012"><a href="#ColorClouds.draw_stim_locations-1012"><span class="linenos">1012</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">x0</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span><span class="n">x1</span><span class="o">+</span><span class="n">BUF</span><span class="p">])</span>
</span><span id="ColorClouds.draw_stim_locations-1013"><a href="#ColorClouds.draw_stim_locations-1013"><span class="linenos">1013</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="n">y0</span><span class="o">-</span><span class="n">BUF</span><span class="p">,</span><span class="n">y1</span><span class="o">+</span><span class="n">BUF</span><span class="p">])</span>
</span><span id="ColorClouds.draw_stim_locations-1014"><a href="#ColorClouds.draw_stim_locations-1014"><span class="linenos">1014</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Draws stimulus locations</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>top_corner (list):</strong>  top corner of stimulus</li>
<li><strong>L (int):</strong>  length of stimulus</li>
<li><strong>row_height (float):</strong>  height of row</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="ColorClouds.avrates" class="classattr">
                                        <input id="ColorClouds.avrates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">avrates</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">inds</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ColorClouds.avrates-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ColorClouds.avrates"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ColorClouds.avrates-1017"><a href="#ColorClouds.avrates-1017"><span class="linenos">1017</span></a>    <span class="k">def</span> <span class="nf">avrates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="ColorClouds.avrates-1018"><a href="#ColorClouds.avrates-1018"><span class="linenos">1018</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds.avrates-1019"><a href="#ColorClouds.avrates-1019"><span class="linenos">1019</span></a><span class="sd">        Calculates average firing probability across specified inds (or whole dataset)</span>
</span><span id="ColorClouds.avrates-1020"><a href="#ColorClouds.avrates-1020"><span class="linenos">1020</span></a><span class="sd">        -- Note will respect datafilters</span>
</span><span id="ColorClouds.avrates-1021"><a href="#ColorClouds.avrates-1021"><span class="linenos">1021</span></a><span class="sd">        -- will return precalc value to save time if already stored</span>
</span><span id="ColorClouds.avrates-1022"><a href="#ColorClouds.avrates-1022"><span class="linenos">1022</span></a>
</span><span id="ColorClouds.avrates-1023"><a href="#ColorClouds.avrates-1023"><span class="linenos">1023</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds.avrates-1024"><a href="#ColorClouds.avrates-1024"><span class="linenos">1024</span></a><span class="sd">            inds (list): indices to calculate across</span>
</span><span id="ColorClouds.avrates-1025"><a href="#ColorClouds.avrates-1025"><span class="linenos">1025</span></a>
</span><span id="ColorClouds.avrates-1026"><a href="#ColorClouds.avrates-1026"><span class="linenos">1026</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds.avrates-1027"><a href="#ColorClouds.avrates-1027"><span class="linenos">1027</span></a><span class="sd">            np.ndarray: average firing rates</span>
</span><span id="ColorClouds.avrates-1028"><a href="#ColorClouds.avrates-1028"><span class="linenos">1028</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds.avrates-1029"><a href="#ColorClouds.avrates-1029"><span class="linenos">1029</span></a>        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.avrates-1030"><a href="#ColorClouds.avrates-1030"><span class="linenos">1030</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="ColorClouds.avrates-1031"><a href="#ColorClouds.avrates-1031"><span class="linenos">1031</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="ColorClouds.avrates-1032"><a href="#ColorClouds.avrates-1032"><span class="linenos">1032</span></a>            <span class="c1"># then calculate across whole dataset</span>
</span><span id="ColorClouds.avrates-1033"><a href="#ColorClouds.avrates-1033"><span class="linenos">1033</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.avrates-1034"><a href="#ColorClouds.avrates-1034"><span class="linenos">1034</span></a>                <span class="c1"># then precalculated and do not need to do</span>
</span><span id="ColorClouds.avrates-1035"><a href="#ColorClouds.avrates-1035"><span class="linenos">1035</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span>
</span><span id="ColorClouds.avrates-1036"><a href="#ColorClouds.avrates-1036"><span class="linenos">1036</span></a>
</span><span id="ColorClouds.avrates-1037"><a href="#ColorClouds.avrates-1037"><span class="linenos">1037</span></a>        <span class="c1"># Otherwise calculate across all data</span>
</span><span id="ColorClouds.avrates-1038"><a href="#ColorClouds.avrates-1038"><span class="linenos">1038</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="ColorClouds.avrates-1039"><a href="#ColorClouds.avrates-1039"><span class="linenos">1039</span></a>            <span class="n">Reff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="ColorClouds.avrates-1040"><a href="#ColorClouds.avrates-1040"><span class="linenos">1040</span></a>            <span class="n">Teff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="ColorClouds.avrates-1041"><a href="#ColorClouds.avrates-1041"><span class="linenos">1041</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="o">/</span><span class="n">Teff</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="ColorClouds.avrates-1042"><a href="#ColorClouds.avrates-1042"><span class="linenos">1042</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.avrates-1043"><a href="#ColorClouds.avrates-1043"><span class="linenos">1043</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Still need to implement avRs without preloading&#39;</span><span class="p">)</span>
</span><span id="ColorClouds.avrates-1044"><a href="#ColorClouds.avrates-1044"><span class="linenos">1044</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Calculates average firing probability across specified inds (or whole dataset)
-- Note will respect datafilters
-- will return precalc value to save time if already stored</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>inds (list):</strong>  indices to calculate across</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>np.ndarray: average firing rates</p>
</blockquote>
</div>


                            </div>
                            <div id="ColorClouds.shift_stim" class="classattr">
                                        <input id="ColorClouds.shift_stim-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">shift_stim</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">pos_shifts</span>,</span><span class="param">	<span class="n">metrics</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">metric_threshold</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">ts_thresh</span><span class="o">=</span><span class="mi">8</span>,</span><span class="param">	<span class="n">shift_times</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">already_lagged</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ColorClouds.shift_stim-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ColorClouds.shift_stim"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ColorClouds.shift_stim-1047"><a href="#ColorClouds.shift_stim-1047"><span class="linenos">1047</span></a>    <span class="k">def</span> <span class="nf">shift_stim</span><span class="p">(</span>
</span><span id="ColorClouds.shift_stim-1048"><a href="#ColorClouds.shift_stim-1048"><span class="linenos">1048</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">pos_shifts</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metric_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ts_thresh</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="ColorClouds.shift_stim-1049"><a href="#ColorClouds.shift_stim-1049"><span class="linenos">1049</span></a>        <span class="n">shift_times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">already_lagged</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="ColorClouds.shift_stim-1050"><a href="#ColorClouds.shift_stim-1050"><span class="linenos">1050</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds.shift_stim-1051"><a href="#ColorClouds.shift_stim-1051"><span class="linenos">1051</span></a><span class="sd">        Shift stimulus given standard shifting input (TBD)</span>
</span><span id="ColorClouds.shift_stim-1052"><a href="#ColorClouds.shift_stim-1052"><span class="linenos">1052</span></a><span class="sd">        use &#39;shift-times&#39; if given shifts correspond to range of times</span>
</span><span id="ColorClouds.shift_stim-1053"><a href="#ColorClouds.shift_stim-1053"><span class="linenos">1053</span></a><span class="sd">        </span>
</span><span id="ColorClouds.shift_stim-1054"><a href="#ColorClouds.shift_stim-1054"><span class="linenos">1054</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds.shift_stim-1055"><a href="#ColorClouds.shift_stim-1055"><span class="linenos">1055</span></a><span class="sd">            pos_shifts (np.ndarray): shifts to apply</span>
</span><span id="ColorClouds.shift_stim-1056"><a href="#ColorClouds.shift_stim-1056"><span class="linenos">1056</span></a><span class="sd">            metrics (np.ndarray): metric to apply threshold</span>
</span><span id="ColorClouds.shift_stim-1057"><a href="#ColorClouds.shift_stim-1057"><span class="linenos">1057</span></a><span class="sd">            metric_threshold (float): threshold for metric</span>
</span><span id="ColorClouds.shift_stim-1058"><a href="#ColorClouds.shift_stim-1058"><span class="linenos">1058</span></a><span class="sd">            ts_thresh (int): threshold for number of timepoints</span>
</span><span id="ColorClouds.shift_stim-1059"><a href="#ColorClouds.shift_stim-1059"><span class="linenos">1059</span></a><span class="sd">            shift_times (list): times to shift stimulus</span>
</span><span id="ColorClouds.shift_stim-1060"><a href="#ColorClouds.shift_stim-1060"><span class="linenos">1060</span></a><span class="sd">            already_lagged (bool): whether stimulus is already lagged</span>
</span><span id="ColorClouds.shift_stim-1061"><a href="#ColorClouds.shift_stim-1061"><span class="linenos">1061</span></a>
</span><span id="ColorClouds.shift_stim-1062"><a href="#ColorClouds.shift_stim-1062"><span class="linenos">1062</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds.shift_stim-1063"><a href="#ColorClouds.shift_stim-1063"><span class="linenos">1063</span></a><span class="sd">            np.ndarray: shifted stimulus</span>
</span><span id="ColorClouds.shift_stim-1064"><a href="#ColorClouds.shift_stim-1064"><span class="linenos">1064</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds.shift_stim-1065"><a href="#ColorClouds.shift_stim-1065"><span class="linenos">1065</span></a>        <span class="n">NX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds.shift_stim-1066"><a href="#ColorClouds.shift_stim-1066"><span class="linenos">1066</span></a>        <span class="n">nlags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="ColorClouds.shift_stim-1067"><a href="#ColorClouds.shift_stim-1067"><span class="linenos">1067</span></a>
</span><span id="ColorClouds.shift_stim-1068"><a href="#ColorClouds.shift_stim-1068"><span class="linenos">1068</span></a>        <span class="c1"># Check if has been time-lagged yet</span>
</span><span id="ColorClouds.shift_stim-1069"><a href="#ColorClouds.shift_stim-1069"><span class="linenos">1069</span></a>  
</span><span id="ColorClouds.shift_stim-1070"><a href="#ColorClouds.shift_stim-1070"><span class="linenos">1070</span></a>        <span class="k">if</span> <span class="n">already_lagged</span><span class="p">:</span>
</span><span id="ColorClouds.shift_stim-1071"><a href="#ColorClouds.shift_stim-1071"><span class="linenos">1071</span></a>            <span class="n">re_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.shift_stim-1072"><a href="#ColorClouds.shift_stim-1072"><span class="linenos">1072</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.shift_stim-1073"><a href="#ColorClouds.shift_stim-1073"><span class="linenos">1073</span></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Should be already lagged, but seems not&quot;</span>
</span><span id="ColorClouds.shift_stim-1074"><a href="#ColorClouds.shift_stim-1074"><span class="linenos">1074</span></a>            <span class="n">re_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">)</span>
</span><span id="ColorClouds.shift_stim-1075"><a href="#ColorClouds.shift_stim-1075"><span class="linenos">1075</span></a>
</span><span id="ColorClouds.shift_stim-1076"><a href="#ColorClouds.shift_stim-1076"><span class="linenos">1076</span></a>        <span class="c1"># Apply shift-times (subset)</span>
</span><span id="ColorClouds.shift_stim-1077"><a href="#ColorClouds.shift_stim-1077"><span class="linenos">1077</span></a>        <span class="k">if</span> <span class="n">shift_times</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.shift_stim-1078"><a href="#ColorClouds.shift_stim-1078"><span class="linenos">1078</span></a>            <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="ColorClouds.shift_stim-1079"><a href="#ColorClouds.shift_stim-1079"><span class="linenos">1079</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.shift_stim-1080"><a href="#ColorClouds.shift_stim-1080"><span class="linenos">1080</span></a>            <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">[</span><span class="n">shift_times</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="ColorClouds.shift_stim-1081"><a href="#ColorClouds.shift_stim-1081"><span class="linenos">1081</span></a>            <span class="c1"># Find minimum fix_n and make = 1</span>
</span><span id="ColorClouds.shift_stim-1082"><a href="#ColorClouds.shift_stim-1082"><span class="linenos">1082</span></a>            <span class="n">min_fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fix_n</span><span class="p">[</span><span class="n">fix_n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="ColorClouds.shift_stim-1083"><a href="#ColorClouds.shift_stim-1083"><span class="linenos">1083</span></a>            <span class="c1">#print(&#39;min_fix_n&#39;, min_fix_n, &#39;adjust&#39;, 1-min_fix_n)</span>
</span><span id="ColorClouds.shift_stim-1084"><a href="#ColorClouds.shift_stim-1084"><span class="linenos">1084</span></a>            <span class="n">fix_n</span><span class="p">[</span><span class="n">fix_n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">-</span><span class="n">min_fix_n</span>
</span><span id="ColorClouds.shift_stim-1085"><a href="#ColorClouds.shift_stim-1085"><span class="linenos">1085</span></a>            <span class="n">re_stim</span> <span class="o">=</span> <span class="n">re_stim</span><span class="p">[</span><span class="n">shift_times</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds.shift_stim-1086"><a href="#ColorClouds.shift_stim-1086"><span class="linenos">1086</span></a>            <span class="c1">#print(&#39;max fix&#39;, np.max(fix_n), fix_n.shape)</span>
</span><span id="ColorClouds.shift_stim-1087"><a href="#ColorClouds.shift_stim-1087"><span class="linenos">1087</span></a>        
</span><span id="ColorClouds.shift_stim-1088"><a href="#ColorClouds.shift_stim-1088"><span class="linenos">1088</span></a>        <span class="n">NF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fix_n</span><span class="p">)</span>
</span><span id="ColorClouds.shift_stim-1089"><a href="#ColorClouds.shift_stim-1089"><span class="linenos">1089</span></a>        <span class="n">NTtmp</span> <span class="o">=</span> <span class="n">re_stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.shift_stim-1090"><a href="#ColorClouds.shift_stim-1090"><span class="linenos">1090</span></a>        <span class="n">nclr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.shift_stim-1091"><a href="#ColorClouds.shift_stim-1091"><span class="linenos">1091</span></a>        <span class="c1">#sh0 = -(pos_shifts[:,0]-self.dims[1]//2)</span>
</span><span id="ColorClouds.shift_stim-1092"><a href="#ColorClouds.shift_stim-1092"><span class="linenos">1092</span></a>        <span class="c1">#sh1 = -(pos_shifts[:,1]-self.dims[2]//2)</span>
</span><span id="ColorClouds.shift_stim-1093"><a href="#ColorClouds.shift_stim-1093"><span class="linenos">1093</span></a>        <span class="n">sh0</span> <span class="o">=</span> <span class="n">pos_shifts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># this should be in units of pixels relative to 0</span>
</span><span id="ColorClouds.shift_stim-1094"><a href="#ColorClouds.shift_stim-1094"><span class="linenos">1094</span></a>        <span class="n">sh1</span> <span class="o">=</span> <span class="n">pos_shifts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="ColorClouds.shift_stim-1095"><a href="#ColorClouds.shift_stim-1095"><span class="linenos">1095</span></a>
</span><span id="ColorClouds.shift_stim-1096"><a href="#ColorClouds.shift_stim-1096"><span class="linenos">1096</span></a>        <span class="n">sp_stim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">re_stim</span><span class="p">)</span>
</span><span id="ColorClouds.shift_stim-1097"><a href="#ColorClouds.shift_stim-1097"><span class="linenos">1097</span></a>        <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.shift_stim-1098"><a href="#ColorClouds.shift_stim-1098"><span class="linenos">1098</span></a>            <span class="n">val_fix</span> <span class="o">=</span> <span class="n">metrics</span> <span class="o">&gt;</span> <span class="n">metric_threshold</span>
</span><span id="ColorClouds.shift_stim-1099"><a href="#ColorClouds.shift_stim-1099"><span class="linenos">1099</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Applied metric threshold: </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">val_fix</span><span class="p">),</span> <span class="n">NF</span><span class="p">))</span>
</span><span id="ColorClouds.shift_stim-1100"><a href="#ColorClouds.shift_stim-1100"><span class="linenos">1100</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.shift_stim-1101"><a href="#ColorClouds.shift_stim-1101"><span class="linenos">1101</span></a>            <span class="n">val_fix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span><span class="o">*</span><span class="n">NF</span><span class="p">)</span>
</span><span id="ColorClouds.shift_stim-1102"><a href="#ColorClouds.shift_stim-1102"><span class="linenos">1102</span></a>
</span><span id="ColorClouds.shift_stim-1103"><a href="#ColorClouds.shift_stim-1103"><span class="linenos">1103</span></a>        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NF</span><span class="p">):</span>
</span><span id="ColorClouds.shift_stim-1104"><a href="#ColorClouds.shift_stim-1104"><span class="linenos">1104</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fix_n</span> <span class="o">==</span> <span class="n">ff</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.shift_stim-1105"><a href="#ColorClouds.shift_stim-1105"><span class="linenos">1105</span></a>            <span class="c1">#print(ff, len(ts), ts[0], ts[-1])</span>
</span><span id="ColorClouds.shift_stim-1106"><a href="#ColorClouds.shift_stim-1106"><span class="linenos">1106</span></a>
</span><span id="ColorClouds.shift_stim-1107"><a href="#ColorClouds.shift_stim-1107"><span class="linenos">1107</span></a>            <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh0</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">sh1</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ts_thresh</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">val_fix</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">):</span>
</span><span id="ColorClouds.shift_stim-1108"><a href="#ColorClouds.shift_stim-1108"><span class="linenos">1108</span></a>                <span class="c1"># FIRST SP DIM shift</span>
</span><span id="ColorClouds.shift_stim-1109"><a href="#ColorClouds.shift_stim-1109"><span class="linenos">1109</span></a>                <span class="n">sh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sh0</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="ColorClouds.shift_stim-1110"><a href="#ColorClouds.shift_stim-1110"><span class="linenos">1110</span></a>                <span class="n">stim_seg</span> <span class="o">=</span> <span class="n">re_stim</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds.shift_stim-1111"><a href="#ColorClouds.shift_stim-1111"><span class="linenos">1111</span></a>                <span class="k">if</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds.shift_stim-1112"><a href="#ColorClouds.shift_stim-1112"><span class="linenos">1112</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span> <span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.shift_stim-1113"><a href="#ColorClouds.shift_stim-1113"><span class="linenos">1113</span></a>                    <span class="n">stim_tmp</span><span class="p">[:,</span> <span class="p">:,</span><span class="n">sh</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_seg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:(</span><span class="o">-</span><span class="n">sh</span><span class="p">),</span> <span class="p">:])</span>
</span><span id="ColorClouds.shift_stim-1114"><a href="#ColorClouds.shift_stim-1114"><span class="linenos">1114</span></a>                <span class="k">elif</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds.shift_stim-1115"><a href="#ColorClouds.shift_stim-1115"><span class="linenos">1115</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span> <span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.shift_stim-1116"><a href="#ColorClouds.shift_stim-1116"><span class="linenos">1116</span></a>                    <span class="n">stim_tmp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">sh</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_seg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">(</span><span class="o">-</span><span class="n">sh</span><span class="p">):,</span> <span class="p">:])</span>
</span><span id="ColorClouds.shift_stim-1117"><a href="#ColorClouds.shift_stim-1117"><span class="linenos">1117</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.shift_stim-1118"><a href="#ColorClouds.shift_stim-1118"><span class="linenos">1118</span></a>                    <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_seg</span><span class="p">)</span>
</span><span id="ColorClouds.shift_stim-1119"><a href="#ColorClouds.shift_stim-1119"><span class="linenos">1119</span></a>
</span><span id="ColorClouds.shift_stim-1120"><a href="#ColorClouds.shift_stim-1120"><span class="linenos">1120</span></a>                <span class="c1"># SECOND SP DIM shift</span>
</span><span id="ColorClouds.shift_stim-1121"><a href="#ColorClouds.shift_stim-1121"><span class="linenos">1121</span></a>                <span class="n">sh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sh1</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span>
</span><span id="ColorClouds.shift_stim-1122"><a href="#ColorClouds.shift_stim-1122"><span class="linenos">1122</span></a>                <span class="k">if</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds.shift_stim-1123"><a href="#ColorClouds.shift_stim-1123"><span class="linenos">1123</span></a>                    <span class="n">stim_tmp2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.shift_stim-1124"><a href="#ColorClouds.shift_stim-1124"><span class="linenos">1124</span></a>                    <span class="n">stim_tmp2</span><span class="p">[</span><span class="o">...</span> <span class="p">,</span> <span class="n">sh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:(</span><span class="o">-</span><span class="n">sh</span><span class="p">)])</span>
</span><span id="ColorClouds.shift_stim-1125"><a href="#ColorClouds.shift_stim-1125"><span class="linenos">1125</span></a>                <span class="k">elif</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds.shift_stim-1126"><a href="#ColorClouds.shift_stim-1126"><span class="linenos">1126</span></a>                    <span class="n">stim_tmp2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">nclr</span><span class="p">,</span> <span class="n">NX</span><span class="p">,</span><span class="n">NX</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ColorClouds.shift_stim-1127"><a href="#ColorClouds.shift_stim-1127"><span class="linenos">1127</span></a>                    <span class="n">stim_tmp2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">sh</span><span class="p">):])</span>
</span><span id="ColorClouds.shift_stim-1128"><a href="#ColorClouds.shift_stim-1128"><span class="linenos">1128</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.shift_stim-1129"><a href="#ColorClouds.shift_stim-1129"><span class="linenos">1129</span></a>                    <span class="n">stim_tmp2</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span>
</span><span id="ColorClouds.shift_stim-1130"><a href="#ColorClouds.shift_stim-1130"><span class="linenos">1130</span></a>                    
</span><span id="ColorClouds.shift_stim-1131"><a href="#ColorClouds.shift_stim-1131"><span class="linenos">1131</span></a>                <span class="n">sp_stim</span><span class="p">[</span><span class="n">ts</span><span class="p">,</span> <span class="o">...</span> <span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim_tmp2</span><span class="p">)</span>
</span><span id="ColorClouds.shift_stim-1132"><a href="#ColorClouds.shift_stim-1132"><span class="linenos">1132</span></a>
</span><span id="ColorClouds.shift_stim-1133"><a href="#ColorClouds.shift_stim-1133"><span class="linenos">1133</span></a>        <span class="k">if</span> <span class="n">already_lagged</span><span class="p">:</span>
</span><span id="ColorClouds.shift_stim-1134"><a href="#ColorClouds.shift_stim-1134"><span class="linenos">1134</span></a>            <span class="c1"># Time-embed</span>
</span><span id="ColorClouds.shift_stim-1135"><a href="#ColorClouds.shift_stim-1135"><span class="linenos">1135</span></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NTtmp</span><span class="p">)</span>
</span><span id="ColorClouds.shift_stim-1136"><a href="#ColorClouds.shift_stim-1136"><span class="linenos">1136</span></a>            <span class="n">laggedstim</span> <span class="o">=</span> <span class="n">sp_stim</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NTtmp</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nlags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="ColorClouds.shift_stim-1137"><a href="#ColorClouds.shift_stim-1137"><span class="linenos">1137</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">laggedstim</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="ColorClouds.shift_stim-1138"><a href="#ColorClouds.shift_stim-1138"><span class="linenos">1138</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.shift_stim-1139"><a href="#ColorClouds.shift_stim-1139"><span class="linenos">1139</span></a>            <span class="k">return</span> <span class="n">sp_stim</span>
</span></pre></div>


            <div class="docstring"><p>Shift stimulus given standard shifting input (TBD)
use 'shift-times' if given shifts correspond to range of times</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>pos_shifts (np.ndarray):</strong>  shifts to apply</li>
<li><strong>metrics (np.ndarray):</strong>  metric to apply threshold</li>
<li><strong>metric_threshold (float):</strong>  threshold for metric</li>
<li><strong>ts_thresh (int):</strong>  threshold for number of timepoints</li>
<li><strong>shift_times (list):</strong>  times to shift stimulus</li>
<li><strong>already_lagged (bool):</strong>  whether stimulus is already lagged</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>np.ndarray: shifted stimulus</p>
</blockquote>
</div>


                            </div>
                            <div id="ColorClouds.shift_stim_fixation" class="classattr">
                                        <input id="ColorClouds.shift_stim_fixation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">shift_stim_fixation</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">stim</span>, </span><span class="param"><span class="n">shift</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ColorClouds.shift_stim_fixation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ColorClouds.shift_stim_fixation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ColorClouds.shift_stim_fixation-1142"><a href="#ColorClouds.shift_stim_fixation-1142"><span class="linenos">1142</span></a>    <span class="k">def</span> <span class="nf">shift_stim_fixation</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
</span><span id="ColorClouds.shift_stim_fixation-1143"><a href="#ColorClouds.shift_stim_fixation-1143"><span class="linenos">1143</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds.shift_stim_fixation-1144"><a href="#ColorClouds.shift_stim_fixation-1144"><span class="linenos">1144</span></a><span class="sd">        Simple shift by integer (rounded shift) and zero padded. Note that this is not in </span>
</span><span id="ColorClouds.shift_stim_fixation-1145"><a href="#ColorClouds.shift_stim_fixation-1145"><span class="linenos">1145</span></a><span class="sd">        is in units of number of bars, rather than -1 to +1. It assumes the stim</span>
</span><span id="ColorClouds.shift_stim_fixation-1146"><a href="#ColorClouds.shift_stim_fixation-1146"><span class="linenos">1146</span></a><span class="sd">        has a batch dimension (over a fixation), and shifts the whole stim by the same amount.</span>
</span><span id="ColorClouds.shift_stim_fixation-1147"><a href="#ColorClouds.shift_stim_fixation-1147"><span class="linenos">1147</span></a><span class="sd">        </span>
</span><span id="ColorClouds.shift_stim_fixation-1148"><a href="#ColorClouds.shift_stim_fixation-1148"><span class="linenos">1148</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds.shift_stim_fixation-1149"><a href="#ColorClouds.shift_stim_fixation-1149"><span class="linenos">1149</span></a><span class="sd">            stim (torch.tensor): stimulus to shift</span>
</span><span id="ColorClouds.shift_stim_fixation-1150"><a href="#ColorClouds.shift_stim_fixation-1150"><span class="linenos">1150</span></a><span class="sd">            shift (float): shift amount</span>
</span><span id="ColorClouds.shift_stim_fixation-1151"><a href="#ColorClouds.shift_stim_fixation-1151"><span class="linenos">1151</span></a>
</span><span id="ColorClouds.shift_stim_fixation-1152"><a href="#ColorClouds.shift_stim_fixation-1152"><span class="linenos">1152</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds.shift_stim_fixation-1153"><a href="#ColorClouds.shift_stim_fixation-1153"><span class="linenos">1153</span></a><span class="sd">            torch.tensor: shifted stimulus</span>
</span><span id="ColorClouds.shift_stim_fixation-1154"><a href="#ColorClouds.shift_stim_fixation-1154"><span class="linenos">1154</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds.shift_stim_fixation-1155"><a href="#ColorClouds.shift_stim_fixation-1155"><span class="linenos">1155</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Currently needs to be fixed to work with 2D&#39;</span><span class="p">)</span>
</span><span id="ColorClouds.shift_stim_fixation-1156"><a href="#ColorClouds.shift_stim_fixation-1156"><span class="linenos">1156</span></a>        <span class="n">sh</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span>
</span><span id="ColorClouds.shift_stim_fixation-1157"><a href="#ColorClouds.shift_stim_fixation-1157"><span class="linenos">1157</span></a>        <span class="n">shstim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="ColorClouds.shift_stim_fixation-1158"><a href="#ColorClouds.shift_stim_fixation-1158"><span class="linenos">1158</span></a>        <span class="k">if</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds.shift_stim_fixation-1159"><a href="#ColorClouds.shift_stim_fixation-1159"><span class="linenos">1159</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="o">-</span><span class="n">sh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="p">:</span><span class="n">sh</span><span class="p">]</span>
</span><span id="ColorClouds.shift_stim_fixation-1160"><a href="#ColorClouds.shift_stim_fixation-1160"><span class="linenos">1160</span></a>        <span class="k">elif</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds.shift_stim_fixation-1161"><a href="#ColorClouds.shift_stim_fixation-1161"><span class="linenos">1161</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="n">sh</span><span class="p">:]</span>
</span><span id="ColorClouds.shift_stim_fixation-1162"><a href="#ColorClouds.shift_stim_fixation-1162"><span class="linenos">1162</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.shift_stim_fixation-1163"><a href="#ColorClouds.shift_stim_fixation-1163"><span class="linenos">1163</span></a>            <span class="n">shstim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="ColorClouds.shift_stim_fixation-1164"><a href="#ColorClouds.shift_stim_fixation-1164"><span class="linenos">1164</span></a>
</span><span id="ColorClouds.shift_stim_fixation-1165"><a href="#ColorClouds.shift_stim_fixation-1165"><span class="linenos">1165</span></a>        <span class="k">return</span> <span class="n">shstim</span>
</span></pre></div>


            <div class="docstring"><p>Simple shift by integer (rounded shift) and zero padded. Note that this is not in 
is in units of number of bars, rather than -1 to +1. It assumes the stim
has a batch dimension (over a fixation), and shifts the whole stim by the same amount.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>stim (torch.tensor):</strong>  stimulus to shift</li>
<li><strong>shift (float):</strong>  shift amount</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>torch.tensor: shifted stimulus</p>
</blockquote>
</div>


                            </div>
                            <div id="ColorClouds.create_valid_indices" class="classattr">
                                        <input id="ColorClouds.create_valid_indices-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_valid_indices</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">post_sacc_gap</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ColorClouds.create_valid_indices-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ColorClouds.create_valid_indices"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ColorClouds.create_valid_indices-1168"><a href="#ColorClouds.create_valid_indices-1168"><span class="linenos">1168</span></a>    <span class="k">def</span> <span class="nf">create_valid_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post_sacc_gap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ColorClouds.create_valid_indices-1169"><a href="#ColorClouds.create_valid_indices-1169"><span class="linenos">1169</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds.create_valid_indices-1170"><a href="#ColorClouds.create_valid_indices-1170"><span class="linenos">1170</span></a><span class="sd">        This creates self.valid_inds vector that is used for __get_item__ </span>
</span><span id="ColorClouds.create_valid_indices-1171"><a href="#ColorClouds.create_valid_indices-1171"><span class="linenos">1171</span></a><span class="sd">        -- Will default to num_lags following each saccade beginning</span>
</span><span id="ColorClouds.create_valid_indices-1172"><a href="#ColorClouds.create_valid_indices-1172"><span class="linenos">1172</span></a><span class="sd">        </span>
</span><span id="ColorClouds.create_valid_indices-1173"><a href="#ColorClouds.create_valid_indices-1173"><span class="linenos">1173</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds.create_valid_indices-1174"><a href="#ColorClouds.create_valid_indices-1174"><span class="linenos">1174</span></a><span class="sd">            post_sacc_gap (int): gap following saccade</span>
</span><span id="ColorClouds.create_valid_indices-1175"><a href="#ColorClouds.create_valid_indices-1175"><span class="linenos">1175</span></a>
</span><span id="ColorClouds.create_valid_indices-1176"><a href="#ColorClouds.create_valid_indices-1176"><span class="linenos">1176</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds.create_valid_indices-1177"><a href="#ColorClouds.create_valid_indices-1177"><span class="linenos">1177</span></a><span class="sd">            None</span>
</span><span id="ColorClouds.create_valid_indices-1178"><a href="#ColorClouds.create_valid_indices-1178"><span class="linenos">1178</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds.create_valid_indices-1179"><a href="#ColorClouds.create_valid_indices-1179"><span class="linenos">1179</span></a>
</span><span id="ColorClouds.create_valid_indices-1180"><a href="#ColorClouds.create_valid_indices-1180"><span class="linenos">1180</span></a>        <span class="k">if</span> <span class="n">post_sacc_gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.create_valid_indices-1181"><a href="#ColorClouds.create_valid_indices-1181"><span class="linenos">1181</span></a>            <span class="n">post_sacc_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="ColorClouds.create_valid_indices-1182"><a href="#ColorClouds.create_valid_indices-1182"><span class="linenos">1182</span></a>
</span><span id="ColorClouds.create_valid_indices-1183"><a href="#ColorClouds.create_valid_indices-1183"><span class="linenos">1183</span></a>        <span class="c1"># first, throw out all data where all data_filters are zero</span>
</span><span id="ColorClouds.create_valid_indices-1184"><a href="#ColorClouds.create_valid_indices-1184"><span class="linenos">1184</span></a>        <span class="n">is_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="ColorClouds.create_valid_indices-1185"><a href="#ColorClouds.create_valid_indices-1185"><span class="linenos">1185</span></a>        <span class="n">is_valid</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ColorClouds.create_valid_indices-1186"><a href="#ColorClouds.create_valid_indices-1186"><span class="linenos">1186</span></a>        
</span><span id="ColorClouds.create_valid_indices-1187"><a href="#ColorClouds.create_valid_indices-1187"><span class="linenos">1187</span></a>        <span class="c1"># Now invalid post_sacc_gap following saccades</span>
</span><span id="ColorClouds.create_valid_indices-1188"><a href="#ColorClouds.create_valid_indices-1188"><span class="linenos">1188</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span><span class="p">):</span>
</span><span id="ColorClouds.create_valid_indices-1189"><a href="#ColorClouds.create_valid_indices-1189"><span class="linenos">1189</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:])</span>
</span><span id="ColorClouds.create_valid_indices-1190"><a href="#ColorClouds.create_valid_indices-1190"><span class="linenos">1190</span></a>            <span class="n">sts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ColorClouds.create_valid_indices-1191"><a href="#ColorClouds.create_valid_indices-1191"><span class="linenos">1191</span></a>            <span class="n">is_valid</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">post_sacc_gap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ColorClouds.create_valid_indices-1192"><a href="#ColorClouds.create_valid_indices-1192"><span class="linenos">1192</span></a>        
</span><span id="ColorClouds.create_valid_indices-1193"><a href="#ColorClouds.create_valid_indices-1193"><span class="linenos">1193</span></a>        <span class="c1">#self.valid_inds = list(np.where(is_valid &gt; 0)[0])</span>
</span><span id="ColorClouds.create_valid_indices-1194"><a href="#ColorClouds.create_valid_indices-1194"><span class="linenos">1194</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_valid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>This creates self.valid_inds vector that is used for __get_item__ 
-- Will default to num_lags following each saccade beginning</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>post_sacc_gap (int):</strong>  gap following saccade</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="ColorClouds.crossval_setup" class="classattr">
                                        <input id="ColorClouds.crossval_setup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">crossval_setup</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">folds</span><span class="o">=</span><span class="mi">5</span>, </span><span class="param"><span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">test_set</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ColorClouds.crossval_setup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ColorClouds.crossval_setup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ColorClouds.crossval_setup-1197"><a href="#ColorClouds.crossval_setup-1197"><span class="linenos">1197</span></a>    <span class="k">def</span> <span class="nf">crossval_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test_set</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="ColorClouds.crossval_setup-1198"><a href="#ColorClouds.crossval_setup-1198"><span class="linenos">1198</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;This sets the cross-validation indices up We can add featuers here. Many ways to do this</span>
</span><span id="ColorClouds.crossval_setup-1199"><a href="#ColorClouds.crossval_setup-1199"><span class="linenos">1199</span></a><span class="sd">        but will stick to some standard for now. It sets the internal indices, which can be read out</span>
</span><span id="ColorClouds.crossval_setup-1200"><a href="#ColorClouds.crossval_setup-1200"><span class="linenos">1200</span></a><span class="sd">        directly or with helper functions. Perhaps helper_functions is the best way....</span>
</span><span id="ColorClouds.crossval_setup-1201"><a href="#ColorClouds.crossval_setup-1201"><span class="linenos">1201</span></a><span class="sd">        </span>
</span><span id="ColorClouds.crossval_setup-1202"><a href="#ColorClouds.crossval_setup-1202"><span class="linenos">1202</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds.crossval_setup-1203"><a href="#ColorClouds.crossval_setup-1203"><span class="linenos">1203</span></a><span class="sd">            folds: number of folds </span>
</span><span id="ColorClouds.crossval_setup-1204"><a href="#ColorClouds.crossval_setup-1204"><span class="linenos">1204</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="ColorClouds.crossval_setup-1205"><a href="#ColorClouds.crossval_setup-1205"><span class="linenos">1205</span></a><span class="sd">            test_set: whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</span>
</span><span id="ColorClouds.crossval_setup-1206"><a href="#ColorClouds.crossval_setup-1206"><span class="linenos">1206</span></a><span class="sd">            verbose: whether to print out information</span>
</span><span id="ColorClouds.crossval_setup-1207"><a href="#ColorClouds.crossval_setup-1207"><span class="linenos">1207</span></a>
</span><span id="ColorClouds.crossval_setup-1208"><a href="#ColorClouds.crossval_setup-1208"><span class="linenos">1208</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds.crossval_setup-1209"><a href="#ColorClouds.crossval_setup-1209"><span class="linenos">1209</span></a><span class="sd">            None: sets internal variables test_inds, train_inds, val_inds</span>
</span><span id="ColorClouds.crossval_setup-1210"><a href="#ColorClouds.crossval_setup-1210"><span class="linenos">1210</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds.crossval_setup-1211"><a href="#ColorClouds.crossval_setup-1211"><span class="linenos">1211</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must first specify valid_indices before setting up cross-validation.&quot;</span>
</span><span id="ColorClouds.crossval_setup-1212"><a href="#ColorClouds.crossval_setup-1212"><span class="linenos">1212</span></a>
</span><span id="ColorClouds.crossval_setup-1213"><a href="#ColorClouds.crossval_setup-1213"><span class="linenos">1213</span></a>        <span class="c1"># Partition data by saccades, and then associate indices with each</span>
</span><span id="ColorClouds.crossval_setup-1214"><a href="#ColorClouds.crossval_setup-1214"><span class="linenos">1214</span></a>        <span class="n">te_fixes</span><span class="p">,</span> <span class="n">tr_fixes</span><span class="p">,</span> <span class="n">val_fixes</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="ColorClouds.crossval_setup-1215"><a href="#ColorClouds.crossval_setup-1215"><span class="linenos">1215</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixation_grouping</span><span class="p">)):</span>  <span class="c1"># Loops across experiments</span>
</span><span id="ColorClouds.crossval_setup-1216"><a href="#ColorClouds.crossval_setup-1216"><span class="linenos">1216</span></a>            <span class="n">fixations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixation_grouping</span><span class="p">[</span><span class="n">ee</span><span class="p">])</span>  <span class="c1"># fixations associated with each experiment</span>
</span><span id="ColorClouds.crossval_setup-1217"><a href="#ColorClouds.crossval_setup-1217"><span class="linenos">1217</span></a>            <span class="n">val_fix1</span><span class="p">,</span> <span class="n">tr_fix1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fixations</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="ColorClouds.crossval_setup-1218"><a href="#ColorClouds.crossval_setup-1218"><span class="linenos">1218</span></a>            <span class="k">if</span> <span class="n">test_set</span><span class="p">:</span>
</span><span id="ColorClouds.crossval_setup-1219"><a href="#ColorClouds.crossval_setup-1219"><span class="linenos">1219</span></a>                <span class="n">te_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">val_fix1</span><span class="p">])</span>
</span><span id="ColorClouds.crossval_setup-1220"><a href="#ColorClouds.crossval_setup-1220"><span class="linenos">1220</span></a>                <span class="n">val_fix2</span><span class="p">,</span> <span class="n">tr_fix2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_fix1</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="ColorClouds.crossval_setup-1221"><a href="#ColorClouds.crossval_setup-1221"><span class="linenos">1221</span></a>                <span class="n">val_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">tr_fix1</span><span class="p">[</span><span class="n">val_fix2</span><span class="p">]])</span>
</span><span id="ColorClouds.crossval_setup-1222"><a href="#ColorClouds.crossval_setup-1222"><span class="linenos">1222</span></a>                <span class="n">tr_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">tr_fix1</span><span class="p">[</span><span class="n">tr_fix2</span><span class="p">]])</span>
</span><span id="ColorClouds.crossval_setup-1223"><a href="#ColorClouds.crossval_setup-1223"><span class="linenos">1223</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.crossval_setup-1224"><a href="#ColorClouds.crossval_setup-1224"><span class="linenos">1224</span></a>                <span class="n">val_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">val_fix1</span><span class="p">])</span>
</span><span id="ColorClouds.crossval_setup-1225"><a href="#ColorClouds.crossval_setup-1225"><span class="linenos">1225</span></a>                <span class="n">tr_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">tr_fix1</span><span class="p">])</span>
</span><span id="ColorClouds.crossval_setup-1226"><a href="#ColorClouds.crossval_setup-1226"><span class="linenos">1226</span></a>
</span><span id="ColorClouds.crossval_setup-1227"><a href="#ColorClouds.crossval_setup-1227"><span class="linenos">1227</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="ColorClouds.crossval_setup-1228"><a href="#ColorClouds.crossval_setup-1228"><span class="linenos">1228</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Partitioned </span><span class="si">%d</span><span class="s2"> fixations total: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span>
</span><span id="ColorClouds.crossval_setup-1229"><a href="#ColorClouds.crossval_setup-1229"><span class="linenos">1229</span></a>                <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">te_fixes</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_fixes</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">val_fixes</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_fixes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_fixes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">te_fixes</span><span class="p">)))</span>  
</span><span id="ColorClouds.crossval_setup-1230"><a href="#ColorClouds.crossval_setup-1230"><span class="linenos">1230</span></a>
</span><span id="ColorClouds.crossval_setup-1231"><a href="#ColorClouds.crossval_setup-1231"><span class="linenos">1231</span></a>        <span class="c1"># Now pull  indices from each saccade </span>
</span><span id="ColorClouds.crossval_setup-1232"><a href="#ColorClouds.crossval_setup-1232"><span class="linenos">1232</span></a>        <span class="n">tr_inds</span><span class="p">,</span> <span class="n">te_inds</span><span class="p">,</span> <span class="n">val_inds</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="ColorClouds.crossval_setup-1233"><a href="#ColorClouds.crossval_setup-1233"><span class="linenos">1233</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">tr_fixes</span><span class="p">:</span>
</span><span id="ColorClouds.crossval_setup-1234"><a href="#ColorClouds.crossval_setup-1234"><span class="linenos">1234</span></a>            <span class="n">tr_inds</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="ColorClouds.crossval_setup-1235"><a href="#ColorClouds.crossval_setup-1235"><span class="linenos">1235</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">val_fixes</span><span class="p">:</span>
</span><span id="ColorClouds.crossval_setup-1236"><a href="#ColorClouds.crossval_setup-1236"><span class="linenos">1236</span></a>            <span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="ColorClouds.crossval_setup-1237"><a href="#ColorClouds.crossval_setup-1237"><span class="linenos">1237</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">te_fixes</span><span class="p">:</span>
</span><span id="ColorClouds.crossval_setup-1238"><a href="#ColorClouds.crossval_setup-1238"><span class="linenos">1238</span></a>            <span class="n">te_inds</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="ColorClouds.crossval_setup-1239"><a href="#ColorClouds.crossval_setup-1239"><span class="linenos">1239</span></a>
</span><span id="ColorClouds.crossval_setup-1240"><a href="#ColorClouds.crossval_setup-1240"><span class="linenos">1240</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="ColorClouds.crossval_setup-1241"><a href="#ColorClouds.crossval_setup-1241"><span class="linenos">1241</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Pre-valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">te_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="ColorClouds.crossval_setup-1242"><a href="#ColorClouds.crossval_setup-1242"><span class="linenos">1242</span></a>
</span><span id="ColorClouds.crossval_setup-1243"><a href="#ColorClouds.crossval_setup-1243"><span class="linenos">1243</span></a>        <span class="c1"># Finally intersect with valid indices</span>
</span><span id="ColorClouds.crossval_setup-1244"><a href="#ColorClouds.crossval_setup-1244"><span class="linenos">1244</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">)))</span>
</span><span id="ColorClouds.crossval_setup-1245"><a href="#ColorClouds.crossval_setup-1245"><span class="linenos">1245</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">val_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">)))</span>
</span><span id="ColorClouds.crossval_setup-1246"><a href="#ColorClouds.crossval_setup-1246"><span class="linenos">1246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">te_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">)))</span>
</span><span id="ColorClouds.crossval_setup-1247"><a href="#ColorClouds.crossval_setup-1247"><span class="linenos">1247</span></a>
</span><span id="ColorClouds.crossval_setup-1248"><a href="#ColorClouds.crossval_setup-1248"><span class="linenos">1248</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="ColorClouds.crossval_setup-1249"><a href="#ColorClouds.crossval_setup-1249"><span class="linenos">1249</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span><span class="p">))</span> <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This sets the cross-validation indices up We can add featuers here. Many ways to do this
but will stick to some standard for now. It sets the internal indices, which can be read out
directly or with helper functions. Perhaps helper_functions is the best way....</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>folds:</strong>  number of folds </li>
<li><strong>random_gen:</strong>  whether to pick random fixations for validation or uniformly distributed</li>
<li><strong>test_set:</strong>  whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</li>
<li><strong>verbose:</strong>  whether to print out information</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: sets internal variables test_inds, train_inds, val_inds</p>
</blockquote>
</div>


                            </div>
                            <div id="ColorClouds.get_max_samples" class="classattr">
                                        <input id="ColorClouds.get_max_samples-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_max_samples</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">gpu_n</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">history_size</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="n">nquad</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">buffer</span><span class="o">=</span><span class="mf">1.2</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ColorClouds.get_max_samples-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ColorClouds.get_max_samples"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ColorClouds.get_max_samples-1253"><a href="#ColorClouds.get_max_samples-1253"><span class="linenos">1253</span></a>    <span class="k">def</span> <span class="nf">get_max_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpu_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nquad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mf">1.2</span><span class="p">):</span>
</span><span id="ColorClouds.get_max_samples-1254"><a href="#ColorClouds.get_max_samples-1254"><span class="linenos">1254</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ColorClouds.get_max_samples-1255"><a href="#ColorClouds.get_max_samples-1255"><span class="linenos">1255</span></a><span class="sd">        get the maximum number of samples that fit in memory -- for GLM/GQM x LBFGS</span>
</span><span id="ColorClouds.get_max_samples-1256"><a href="#ColorClouds.get_max_samples-1256"><span class="linenos">1256</span></a>
</span><span id="ColorClouds.get_max_samples-1257"><a href="#ColorClouds.get_max_samples-1257"><span class="linenos">1257</span></a><span class="sd">        Args:</span>
</span><span id="ColorClouds.get_max_samples-1258"><a href="#ColorClouds.get_max_samples-1258"><span class="linenos">1258</span></a><span class="sd">            gpu_n (int): gpu number</span>
</span><span id="ColorClouds.get_max_samples-1259"><a href="#ColorClouds.get_max_samples-1259"><span class="linenos">1259</span></a><span class="sd">            history_size (int): history size</span>
</span><span id="ColorClouds.get_max_samples-1260"><a href="#ColorClouds.get_max_samples-1260"><span class="linenos">1260</span></a><span class="sd">            nquad (int): number of quadrature points</span>
</span><span id="ColorClouds.get_max_samples-1261"><a href="#ColorClouds.get_max_samples-1261"><span class="linenos">1261</span></a><span class="sd">            num_cells (int): number of cells</span>
</span><span id="ColorClouds.get_max_samples-1262"><a href="#ColorClouds.get_max_samples-1262"><span class="linenos">1262</span></a><span class="sd">            buffer (float): buffer size</span>
</span><span id="ColorClouds.get_max_samples-1263"><a href="#ColorClouds.get_max_samples-1263"><span class="linenos">1263</span></a>
</span><span id="ColorClouds.get_max_samples-1264"><a href="#ColorClouds.get_max_samples-1264"><span class="linenos">1264</span></a><span class="sd">        Returns:</span>
</span><span id="ColorClouds.get_max_samples-1265"><a href="#ColorClouds.get_max_samples-1265"><span class="linenos">1265</span></a><span class="sd">            int: maximum number of samples that fit in memory</span>
</span><span id="ColorClouds.get_max_samples-1266"><a href="#ColorClouds.get_max_samples-1266"><span class="linenos">1266</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ColorClouds.get_max_samples-1267"><a href="#ColorClouds.get_max_samples-1267"><span class="linenos">1267</span></a>        <span class="k">if</span> <span class="n">gpu_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ColorClouds.get_max_samples-1268"><a href="#ColorClouds.get_max_samples-1268"><span class="linenos">1268</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
</span><span id="ColorClouds.get_max_samples-1269"><a href="#ColorClouds.get_max_samples-1269"><span class="linenos">1269</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ColorClouds.get_max_samples-1270"><a href="#ColorClouds.get_max_samples-1270"><span class="linenos">1270</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:1&#39;</span><span class="p">)</span>
</span><span id="ColorClouds.get_max_samples-1271"><a href="#ColorClouds.get_max_samples-1271"><span class="linenos">1271</span></a>
</span><span id="ColorClouds.get_max_samples-1272"><a href="#ColorClouds.get_max_samples-1272"><span class="linenos">1272</span></a>        <span class="k">if</span> <span class="n">num_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ColorClouds.get_max_samples-1273"><a href="#ColorClouds.get_max_samples-1273"><span class="linenos">1273</span></a>            <span class="n">num_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span>
</span><span id="ColorClouds.get_max_samples-1274"><a href="#ColorClouds.get_max_samples-1274"><span class="linenos">1274</span></a>        
</span><span id="ColorClouds.get_max_samples-1275"><a href="#ColorClouds.get_max_samples-1275"><span class="linenos">1275</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">total_memory</span>
</span><span id="ColorClouds.get_max_samples-1276"><a href="#ColorClouds.get_max_samples-1276"><span class="linenos">1276</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_reserved</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds.get_max_samples-1277"><a href="#ColorClouds.get_max_samples-1277"><span class="linenos">1277</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_allocated</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="ColorClouds.get_max_samples-1278"><a href="#ColorClouds.get_max_samples-1278"><span class="linenos">1278</span></a>        <span class="n">free</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">r</span><span class="p">)</span>
</span><span id="ColorClouds.get_max_samples-1279"><a href="#ColorClouds.get_max_samples-1279"><span class="linenos">1279</span></a>
</span><span id="ColorClouds.get_max_samples-1280"><a href="#ColorClouds.get_max_samples-1280"><span class="linenos">1280</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ColorClouds.get_max_samples-1281"><a href="#ColorClouds.get_max_samples-1281"><span class="linenos">1281</span></a>        <span class="n">mempersample</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span>
</span><span id="ColorClouds.get_max_samples-1282"><a href="#ColorClouds.get_max_samples-1282"><span class="linenos">1282</span></a>    
</span><span id="ColorClouds.get_max_samples-1283"><a href="#ColorClouds.get_max_samples-1283"><span class="linenos">1283</span></a>        <span class="n">mempercell</span> <span class="o">=</span> <span class="n">mempersample</span> <span class="o">*</span> <span class="p">(</span><span class="n">nquad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">history_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="ColorClouds.get_max_samples-1284"><a href="#ColorClouds.get_max_samples-1284"><span class="linenos">1284</span></a>        <span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">*</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span>
</span><span id="ColorClouds.get_max_samples-1285"><a href="#ColorClouds.get_max_samples-1285"><span class="linenos">1285</span></a>
</span><span id="ColorClouds.get_max_samples-1286"><a href="#ColorClouds.get_max_samples-1286"><span class="linenos">1286</span></a>        <span class="n">maxsamples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">free</span> <span class="o">-</span> <span class="n">mempercell</span><span class="o">*</span><span class="n">num_cells</span> <span class="o">-</span> <span class="n">buffer_bytes</span><span class="p">)</span> <span class="o">//</span> <span class="n">mempersample</span>
</span><span id="ColorClouds.get_max_samples-1287"><a href="#ColorClouds.get_max_samples-1287"><span class="linenos">1287</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# samples that can fit on device: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxsamples</span><span class="p">))</span>
</span><span id="ColorClouds.get_max_samples-1288"><a href="#ColorClouds.get_max_samples-1288"><span class="linenos">1288</span></a>        <span class="k">return</span> <span class="n">maxsamples</span>
</span></pre></div>


            <div class="docstring"><p>get the maximum number of samples that fit in memory -- for GLM/GQM x LBFGS</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>gpu_n (int):</strong>  gpu number</li>
<li><strong>history_size (int):</strong>  history size</li>
<li><strong>nquad (int):</strong>  number of quadrature points</li>
<li><strong>num_cells (int):</strong>  number of cells</li>
<li><strong>buffer (float):</strong>  buffer size</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>int: maximum number of samples that fit in memory</p>
</blockquote>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="../sensory_base.html#SensoryBase">NTdatasets.sensory_base.SensoryBase</a></dt>
                                <dd id="ColorClouds.datadir" class="variable"><a href="../sensory_base.html#SensoryBase.datadir">datadir</a></dd>
                <dd id="ColorClouds.filenames" class="variable"><a href="../sensory_base.html#SensoryBase.filenames">filenames</a></dd>
                <dd id="ColorClouds.device" class="variable"><a href="../sensory_base.html#SensoryBase.device">device</a></dd>
                <dd id="ColorClouds.block_sample" class="variable"><a href="../sensory_base.html#SensoryBase.block_sample">block_sample</a></dd>
                <dd id="ColorClouds.num_lags" class="variable"><a href="../sensory_base.html#SensoryBase.num_lags">num_lags</a></dd>
                <dd id="ColorClouds.stim_dims" class="variable"><a href="../sensory_base.html#SensoryBase.stim_dims">stim_dims</a></dd>
                <dd id="ColorClouds.time_embed" class="variable"><a href="../sensory_base.html#SensoryBase.time_embed">time_embed</a></dd>
                <dd id="ColorClouds.preload" class="variable"><a href="../sensory_base.html#SensoryBase.preload">preload</a></dd>
                <dd id="ColorClouds.SUs" class="variable"><a href="../sensory_base.html#SensoryBase.SUs">SUs</a></dd>
                <dd id="ColorClouds.NC" class="variable"><a href="../sensory_base.html#SensoryBase.NC">NC</a></dd>
                <dd id="ColorClouds.block_inds" class="variable"><a href="../sensory_base.html#SensoryBase.block_inds">block_inds</a></dd>
                <dd id="ColorClouds.block_filemapping" class="variable"><a href="../sensory_base.html#SensoryBase.block_filemapping">block_filemapping</a></dd>
                <dd id="ColorClouds.include_MUs" class="variable"><a href="../sensory_base.html#SensoryBase.include_MUs">include_MUs</a></dd>
                <dd id="ColorClouds.SUinds" class="variable"><a href="../sensory_base.html#SensoryBase.SUinds">SUinds</a></dd>
                <dd id="ColorClouds.MUinds" class="variable"><a href="../sensory_base.html#SensoryBase.MUinds">MUinds</a></dd>
                <dd id="ColorClouds.cells_out" class="variable"><a href="../sensory_base.html#SensoryBase.cells_out">cells_out</a></dd>
                <dd id="ColorClouds.robs_out" class="variable"><a href="../sensory_base.html#SensoryBase.robs_out">robs_out</a></dd>
                <dd id="ColorClouds.dfs_out" class="variable"><a href="../sensory_base.html#SensoryBase.dfs_out">dfs_out</a></dd>
                <dd id="ColorClouds.test_inds" class="variable"><a href="../sensory_base.html#SensoryBase.test_inds">test_inds</a></dd>
                <dd id="ColorClouds.test_blks" class="variable"><a href="../sensory_base.html#SensoryBase.test_blks">test_blks</a></dd>
                <dd id="ColorClouds.speckled" class="variable"><a href="../sensory_base.html#SensoryBase.speckled">speckled</a></dd>
                <dd id="ColorClouds.Xdrift" class="variable"><a href="../sensory_base.html#SensoryBase.Xdrift">Xdrift</a></dd>
                <dd id="ColorClouds.stim" class="variable"><a href="../sensory_base.html#SensoryBase.stim">stim</a></dd>
                <dd id="ColorClouds.dfs" class="variable"><a href="../sensory_base.html#SensoryBase.dfs">dfs</a></dd>
                <dd id="ColorClouds.robs" class="variable"><a href="../sensory_base.html#SensoryBase.robs">robs</a></dd>
                <dd id="ColorClouds.covariates" class="variable"><a href="../sensory_base.html#SensoryBase.covariates">covariates</a></dd>
                <dd id="ColorClouds.cov_dims" class="variable"><a href="../sensory_base.html#SensoryBase.cov_dims">cov_dims</a></dd>
                <dd id="ColorClouds.add_covariate" class="function"><a href="../sensory_base.html#SensoryBase.add_covariate">add_covariate</a></dd>
                <dd id="ColorClouds.append_covariates" class="function"><a href="../sensory_base.html#SensoryBase.append_covariates">append_covariates</a></dd>
                <dd id="ColorClouds.prepare_stim" class="function"><a href="../sensory_base.html#SensoryBase.prepare_stim">prepare_stim</a></dd>
                <dd id="ColorClouds.set_cells" class="function"><a href="../sensory_base.html#SensoryBase.set_cells">set_cells</a></dd>
                <dd id="ColorClouds.construct_drift_design_matrix" class="function"><a href="../sensory_base.html#SensoryBase.construct_drift_design_matrix">construct_drift_design_matrix</a></dd>
                <dd id="ColorClouds.trial_psths" class="function"><a href="../sensory_base.html#SensoryBase.trial_psths">trial_psths</a></dd>
                <dd id="ColorClouds.trial_averaged_rates" class="function"><a href="../sensory_base.html#SensoryBase.trial_averaged_rates">trial_averaged_rates</a></dd>
                <dd id="ColorClouds.construct_LVtents" class="function"><a href="../sensory_base.html#SensoryBase.construct_LVtents">construct_LVtents</a></dd>
                <dd id="ColorClouds.setup_trial_LVs" class="function"><a href="../sensory_base.html#SensoryBase.setup_trial_LVs">setup_trial_LVs</a></dd>
                <dd id="ColorClouds.setup_LVLayer_input" class="function"><a href="../sensory_base.html#SensoryBase.setup_LVLayer_input">setup_LVLayer_input</a></dd>
                <dd id="ColorClouds.design_matrix_drift" class="function"><a href="../sensory_base.html#SensoryBase.design_matrix_drift">design_matrix_drift</a></dd>
                <dd id="ColorClouds.construct_onehot_design_matrix" class="function"><a href="../sensory_base.html#SensoryBase.construct_onehot_design_matrix">construct_onehot_design_matrix</a></dd>
                <dd id="ColorClouds.fold_sample" class="function"><a href="../sensory_base.html#SensoryBase.fold_sample">fold_sample</a></dd>
                <dd id="ColorClouds.speckledXV_setup" class="function"><a href="../sensory_base.html#SensoryBase.speckledXV_setup">speckledXV_setup</a></dd>
                <dd id="ColorClouds.set_speckledXV" class="function"><a href="../sensory_base.html#SensoryBase.set_speckledXV">set_speckledXV</a></dd>
                <dd id="ColorClouds.make_data_dicts" class="function"><a href="../sensory_base.html#SensoryBase.make_data_dicts">make_data_dicts</a></dd>
                <dd id="ColorClouds.is_int" class="function"><a href="../sensory_base.html#SensoryBase.is_int">is_int</a></dd>
                <dd id="ColorClouds.index_to_array" class="function"><a href="../sensory_base.html#SensoryBase.index_to_array">index_to_array</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>
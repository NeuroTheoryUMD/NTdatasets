<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.6.0"/>
    <title>NTdatasets.conway.bar1d_datasets_single API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../conway.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;NTdatasets.conway</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Bar1D">Bar1D</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Bar1D.__init__">Bar1D</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.datadir">datadir</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.sess_list">sess_list</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.device">device</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.num_lags">num_lags</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.time_embed">time_embed</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.preload">preload</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.stim_crop">stim_crop</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.folded_lags">folded_lags</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.fhandles">fhandles</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.ETstim_location">ETstim_location</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.fix_location">fix_location</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.probeIDs">probeIDs</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.probeIDsMU">probeIDsMU</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.dt">dt</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.pixel_size">pixel_size</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.exptdate">exptdate</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.data_threshold">data_threshold</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.file_index">file_index</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.sacc_inds">sacc_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.sus">sus</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.NC">NC</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.eyepos">eyepos</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.generate_Xfix">generate_Xfix</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.num_blks">num_blks</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.block_inds">block_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.block_filemapping">block_filemapping</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.include_MUs">include_MUs</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.SUinds">SUinds</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.MUinds">MUinds</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.cells_out">cells_out</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.avRs">avRs</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.test_inds">test_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.val_inds">val_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.train_inds">train_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.fix_n">fix_n</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.sacc_on">sacc_on</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.sacc_off">sacc_off</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.used_inds">used_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.stimname">stimname</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.NT">NT</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.sac_on">sac_on</a>
                        </li>
                        <li>
                                <a class="variable" href="#Bar1D.sac_off">sac_off</a>
                        </li>
                        <li>
                                <a class="function" href="#Bar1D.preload_numpy">preload_numpy</a>
                        </li>
                        <li>
                                <a class="function" href="#Bar1D.to_tensor">to_tensor</a>
                        </li>
                        <li>
                                <a class="function" href="#Bar1D.avrates">avrates</a>
                        </li>
                        <li>
                                <a class="function" href="#Bar1D.shift_stim_fixation">shift_stim_fixation</a>
                        </li>
                        <li>
                                <a class="function" href="#Bar1D.create_valid_indices">create_valid_indices</a>
                        </li>
                        <li>
                                <a class="function" href="#Bar1D.crossval_setup">crossval_setup</a>
                        </li>
                        <li>
                                <a class="function" href="#Bar1D.fold_sample">fold_sample</a>
                        </li>
                        <li>
                                <a class="function" href="#Bar1D.get_max_samples">get_max_samples</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../NTdatasets.html">NTdatasets</a><wbr>.<a href="./../conway.html">conway</a><wbr>.bar1d_datasets_single    </h1>

                
                        <input id="mod-bar1d_datasets_single-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-bar1d_datasets_single-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">sio</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">import</span> <span class="nn">NDNT.utils</span> <span class="k">as</span> <span class="nn">utils</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="c1">#from NDNT.utils import download_file, ensure_dir</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">import</span> <span class="nn">h5py</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="k">class</span> <span class="nc">Bar1D</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">    -- can load batches from multiple datasets</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">    -- hdf5 files must have the following information:</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">        Robs</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">        RobsMU</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">        stim: 4-d stimulus: time x nx x ny x color</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">        block_inds: start and stop of &#39;trials&#39; (perhaps fixations for now)</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">        other things: saccades? or should that be in trials? </span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">    Constructor will take eye position, which for now is an input from data</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">    generated in the session (not on disk). It should have the length size </span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">    of the total number of fixations x1.</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>        <span class="n">sess_list</span><span class="p">,</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>        <span class="n">datadir</span><span class="p">,</span> 
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>        <span class="c1"># Stim setup</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>        <span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>        <span class="c1">#which_stim = &#39;stimET&#39;,</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>        <span class="n">stim_crop</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>        <span class="n">time_embed</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>        <span class="n">folded_lags</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>        <span class="c1">#luminance_only=True,</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>        <span class="c1"># other</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>        <span class="n">ignore_saccades</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>        <span class="n">include_MUs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>        <span class="n">preload</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>        <span class="n">eyepos</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">        Constructor options.</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">        Args:</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">            sess_list: list of strings of session names</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">            datadir: directory where data is stored</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">            num_lags: number of lags to include in stimulus</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">            stim_crop: cropping of stimulus</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">            time_embed: 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">            folded_lags: whether to fold lags into channel dimension</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">            ignore_saccades: whether to ignore saccades in the data</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">            include_MUs: whether to include multi-units in the data</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="sd">            preload: whether to preload data into memory</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">            eyepos: eye position data</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">            device: device to put data on</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">datadir</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sess_list</span> <span class="o">=</span> <span class="n">sess_list</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>        
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span> <span class="o">=</span> <span class="n">num_lags</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>        <span class="k">if</span> <span class="n">time_embed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>            <span class="k">assert</span> <span class="n">preload</span><span class="p">,</span> <span class="s2">&quot;Cannot pre-time-embed without preloading.&quot;</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">=</span> <span class="n">time_embed</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preload</span> <span class="o">=</span> <span class="n">preload</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="o">=</span> <span class="n">stim_crop</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span> <span class="o">=</span> <span class="n">folded_lags</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>        <span class="c1"># get hdf5 file handles</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">sess</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_list</span><span class="p">]</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>        
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>        <span class="c1"># Data to just read in and store</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ETstim_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ETstim_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;fix_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probeIDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Robs_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probeIDsMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;RobsMU_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dt&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;pixel_size&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exptdate</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># need to learn matlab strings in HDF5 format (not saved as HDF5 string)</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>        <span class="c1"># build index map</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_threshold</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># how many valid time points required to include saccade?</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_index</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># which file the block corresponds to</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>        <span class="c1">#self.unit_ids = []</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_sus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_mus</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sus</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">=</span> <span class="mi">0</span>    
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>        <span class="c1">#self.stim_dims = None</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span> <span class="o">=</span> <span class="n">eyepos</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_Xfix</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sess_list</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_filemapping</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span> <span class="o">=</span> <span class="n">include_MUs</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">SUinds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">MUinds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># can be list to output specific cells in get_item</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>        <span class="c1"># Set up to store default train_, val_, test_inds</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>        <span class="c1"># Data to construct and store in memory</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_on</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_off</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>        <span class="n">tcount</span><span class="p">,</span> <span class="n">fix_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>        <span class="c1">#if which_stim is None:</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>        <span class="c1">#    stimname = &#39;stimET&#39;</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>        <span class="c1">#else:</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>        <span class="c1">#    stimname = which_stim</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span> <span class="o">=</span> <span class="s1">&#39;stimET&#39;</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>        <span class="k">for</span> <span class="n">fnum</span><span class="p">,</span> <span class="n">fhandle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">):</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>            <span class="n">NT</span><span class="p">,</span> <span class="n">NSUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>            <span class="n">NX</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>            <span class="n">NMUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_sus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NSUfile</span><span class="p">)</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_mus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NMUfile</span><span class="p">)</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sus</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="o">+</span><span class="n">NSUfile</span><span class="p">))</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;block_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>            <span class="n">NCfile</span> <span class="o">=</span> <span class="n">NSUfile</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>                <span class="n">NCfile</span> <span class="o">+=</span> <span class="n">NMUfile</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>            
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>            <span class="c1"># This will associate each block with each file</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_filemapping</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="n">fnum</span><span class="p">)</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span><span class="p">[</span><span class="n">fnum</span><span class="p">]</span><span class="o">=</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span><span class="p">[</span><span class="n">fnum</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>            <span class="c1">#if self.stim_dims is None:</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>            <span class="c1">#if folded_lags:</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">([</span><span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="c1">#list(fhandle[stimname].shape[1:4]) + [1]</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>            <span class="c1">#else:</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>            <span class="c1">#    self.dims = list(fhandle[stimname].shape[1:4]) + [1]</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>            
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>            <span class="c1">#self.luminance_only = luminance_only</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>            <span class="c1">#if luminance_only:</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>            <span class="c1">#    if self.dims[0] &gt; 1:</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>            <span class="c1">#        print(&quot;Reducing stimulus channels (%d) to first dimension&quot;%self.dims[0])</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>            <span class="c1">#    self.dims[0] = 1</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>            
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stim check:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">,</span> <span class="n">folded_lags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>            <span class="c1">#self.unit_ids.append(self.NC + np.asarray(range(NCfile)))</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NCfile</span><span class="p">)</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">+=</span> <span class="n">NCfile</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>            <span class="n">sacc_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;sacc_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>            <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>  <span class="c1"># each time point labels fixation number</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>            <span class="n">sacc_on</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># each time point labels fixation number</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>            <span class="n">sacc_on</span><span class="p">[</span><span class="n">sacc_inds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>            <span class="n">sacc_off</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># each time point labels fixation number</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>            <span class="n">sacc_off</span><span class="p">[</span><span class="n">sacc_inds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>            <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;valid_data&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="mi">1</span>  <span class="c1">#range(self.NT)  # default -- to be changed at end of init</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>            <span class="c1"># Got through each block to segment into fixations</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>            <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>                <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>                <span class="n">t0</span> <span class="o">=</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>                <span class="c1">#valid_inds[range(t0, t0+num_lags)] = 0  # this already adjusted for?</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>                <span class="c1"># Parse fixation numbers within block</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_saccades</span><span class="p">:</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>                    <span class="n">rel_saccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">sacc_inds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sacc_inds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>                    <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel_saccs</span><span class="p">)):</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>                        <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>                        <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">sacc_inds</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>                        <span class="n">t0</span> <span class="o">=</span> <span class="n">sacc_inds</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>                <span class="c1"># Put in last (or only) fixation number</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>                <span class="k">if</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>                    <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>                    <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>            
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>            <span class="n">tcount</span> <span class="o">+=</span> <span class="n">NT</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>            <span class="c1"># make larger fix_n, valid_inds, sacc_inds, block_inds as self</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>  <span class="o">=</span> <span class="n">tcount</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>        <span class="c1"># For now let&#39;s just debug with one file</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sess_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: currently ignoring multiple files&#39;</span><span class="p">)</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">valid_inds</span><span class="p">)</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">fix_n</span><span class="p">)</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sac_on</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sacc_on</span><span class="p">)</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sac_off</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sacc_off</span><span class="p">)</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sacc_inds</span><span class="p">)</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>        
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>        <span class="c1"># Go through saccades to establish val_indices and produce saccade timing vector </span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>        <span class="c1"># Note that sacc_ts will be generated even without preload -- small enough that doesnt matter</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>    <span class="c1">#    self.sacc_ts = np.zeros([self.NT, 1], dtype=np.float32)</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>    <span class="c1">#    self.fix_n = np.zeros(self.NT, dtype=np.int64)  # label of which fixation is in each range</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>    <span class="c1">#    for nn in range(self.num_fixations):</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>    <span class="c1">#        print(nn, self.sacc_inds[nn][0], self.sacc_inds[nn][1] )</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>    <span class="c1">#        self.sacc_ts[self.sacc_inds[nn][0]] = 1 </span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>    <span class="c1">#        self.fix_n[range(self.sacc_inds[nn][0], self.sacc_inds[nn][1])] = nn</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>        <span class="c1">#self.fix_n = list(self.fix_n)  # better list than numpy</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>        <span class="c1">#self.dims = np.unique(np.asarray(self.dims)) # assumes they&#39;re all the same    </span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span><span class="p">,</span> \
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>                <span class="s2">&quot;eyepos input should have </span><span class="si">%d</span><span class="s2"> fixations.&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>        <span class="k">if</span> <span class="n">preload</span><span class="p">:</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data into memory...&quot;</span><span class="p">)</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">preload_numpy</span><span class="p">()</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stim shape&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>            <span class="c1"># Note stim is being represented as full 3-d + 1 tensor (time, channels, NX, NY)</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>                <span class="c1"># Would want to shift by input eye positions if input here</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;eye-position shifting not implemented yet&#39;</span><span class="p">)</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;stimulus cropping not implemented yet&#39;</span><span class="p">)</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>            <span class="k">if</span> <span class="n">time_embed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time embedding...&quot;</span><span class="p">)</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>                <span class="n">tmp_stimH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>                <span class="n">tmp_stimV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span><span class="p">:</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">tmp_stimH</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">tmp_stimV</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Folded lags: stim-dim = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimH</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimV</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>            <span class="c1"># now stimulus is represented as full 4-d + 1 tensor (time, channels, NX, NY, num_lags)</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>            <span class="c1"># Flatten stim </span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>            <span class="c1"># Have data_filters represend used_inds (in case it gets through)</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>            <span class="n">unified_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>            <span class="n">unified_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*=</span> <span class="n">unified_df</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>            <span class="c1"># Convert data to tensors</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>            <span class="c1">#if self.device is not None:</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>        <span class="c1"># Create valid indices and first pass of cross-validation indices</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>        <span class="c1">#self.create_valid_indices()</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>        <span class="c1"># Develop default train, validation, and test datasets </span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>        <span class="c1">#self.crossval_setup()</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>        <span class="c1"># Reflects block structure</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>        <span class="n">vblks</span><span class="p">,</span> <span class="n">trblks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">trblks</span><span class="p">:</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">vblks</span><span class="p">:</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>    <span class="c1"># END ColorClouds.__init__</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>    <span class="k">def</span> <span class="nf">preload_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a><span class="sd">        Note this loads stimulus but does not time-embed.</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a><span class="sd">        Args:</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a><span class="sd">            None</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a><span class="sd">        Returns:</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a><span class="sd">            None: sets self.stim, self.robs, self.dfs, self.eyepos, self.frame_times</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a><span class="sd">        Pre-allocate memory for data</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>        <span class="c1">#self.eyepos = np.zeros([NT, 2], dtype=np.float32)</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>        <span class="c1">#self.frame_times = np.zeros([NT,1], dtype=np.float32)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>        <span class="n">t_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>        <span class="n">unit_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">)):</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>            
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>            <span class="n">fhandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>            <span class="n">sz</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_counter</span><span class="p">,</span> <span class="n">t_counter</span><span class="o">+</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>            <span class="c1">#inds = self.stim_indices[expt][stim][&#39;inds&#39;]</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>            <span class="c1">#self.stim[inds, ...] = np.transpose( np.array(fhandle[self.stimname], dtype=np.float32), axes=[0,3,1,2])</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tmp_stim</span><span class="p">)</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp_stim</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>            <span class="n">stim_ori</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimETori&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>            <span class="n">Hinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_ori</span> <span class="o">&lt;</span> <span class="mi">45</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>            <span class="n">Vinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_ori</span> <span class="o">&gt;</span> <span class="mi">45</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">Vinds</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">Hinds</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; EYE POSITION &quot;&quot;&quot;</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>            <span class="c1">#ppd = fhandle[stim][self.stimset][&#39;Stim&#39;].attrs[&#39;ppd&#39;][0]</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>            <span class="c1">#centerpix = fhandle[stim][self.stimset][&#39;Stim&#39;].attrs[&#39;center&#39;][:]</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>            <span class="c1">#eye_tmp = fhandle[stim][self.stimset][&#39;eyeAtFrame&#39;][1:3,:].T</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>            <span class="c1">#eye_tmp[:,0] -= centerpix[0]</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>            <span class="c1">#eye_tmp[:,1] -= centerpix[1]</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>            <span class="c1">#eye_tmp/= ppd</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>            <span class="c1">#self.eyepos[inds,:] = eye_tmp</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Robs and DATAFILTERS&quot;&quot;&quot;</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>            <span class="n">robs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>            <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>            <span class="n">num_sus</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>            <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="p">)</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>            <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>            <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;datafilts&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>                <span class="n">num_mus</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>                <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="o">+</span><span class="n">num_mus</span><span class="p">)</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>                <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>                <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;DFsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>            
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">robs_tmp</span><span class="p">)</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dfs_tmp</span><span class="p">)</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>            <span class="n">t_counter</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>            <span class="n">unit_counter</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span> <span class="o">=</span> <span class="s1">&#39;stimH&#39;</span>  <span class="c1"># either work I think</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>    <span class="c1"># END .preload_numpy()</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>    <span class="k">def</span> <span class="nf">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>            <span class="c1"># then already converted: just moving device</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>    <span class="c1">#    self.sacc_ts = torch.tensor(self.sacc_ts, dtype=torch.float32, device=device)</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>        <span class="c1">#self.eyepos = torch.tensor(self.eyepos.astype(&#39;float32&#39;), dtype=self.dtype, device=device)</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>        <span class="c1">#self.frame_times = torch.tensor(self.frame_times.astype(&#39;float32&#39;), dtype=self.dtype, device=device)</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>    <span class="k">def</span> <span class="nf">avrates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a><span class="sd">        Calculates average firing probability across specified inds (or whole dataset)</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a><span class="sd">        -- Note will respect datafilters</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a><span class="sd">        -- will return precalc value to save time if already stored</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a><span class="sd">        Args:</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a><span class="sd">            inds: indices to calculate average rates over</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a><span class="sd">        Returns:</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a><span class="sd">            avRs: average firing rates across specified indices</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>            <span class="c1"># then calculate across whole dataset</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>                <span class="c1"># then precalculated and do not need to do</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>        <span class="c1"># Otherwise calculate across all data</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>            <span class="n">Reff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>            <span class="n">Teff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="o">/</span><span class="n">Teff</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Still need to implement avRs without preloading&#39;</span><span class="p">)</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>    <span class="c1"># END .avrates()</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>    <span class="k">def</span> <span class="nf">shift_stim_fixation</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a><span class="sd">        Simple shift by integer (rounded shift) and zero padded. Note that this is not in </span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a><span class="sd">        is in units of number of bars, rather than -1 to +1. It assumes the stim</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="sd">        has a batch dimension (over a fixation), and shifts the whole stim by the same amount.</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a><span class="sd">        </span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a><span class="sd">        Args:</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a><span class="sd">            stim: stimulus tensor to shift</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a><span class="sd">            shift: amount to shift by (in units of bars)</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a><span class="sd">        Returns:</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a><span class="sd">            shstim: shifted stimulus tensor</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Currently needs to be fixed to work with 2D&#39;</span><span class="p">)</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>        <span class="n">sh</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>        <span class="n">shstim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>        <span class="k">if</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="o">-</span><span class="n">sh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="p">:</span><span class="n">sh</span><span class="p">]</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>        <span class="k">elif</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="n">sh</span><span class="p">:]</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>            <span class="n">shstim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>        <span class="k">return</span> <span class="n">shstim</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>    <span class="c1"># END .shift_stim_fixation</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>    <span class="k">def</span> <span class="nf">create_valid_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post_sacc_gap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a><span class="sd">        This creates self.valid_inds vector that is used for __get_item__ </span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a><span class="sd">        -- Will default to num_lags following each saccade beginning</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a><span class="sd">        </span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a><span class="sd">        Args:</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a><span class="sd">            post_sacc_gap: number of lags to ignore following each saccade</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a><span class="sd">        Returns:</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a><span class="sd">            None: sets self.valid_inds</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>        <span class="k">if</span> <span class="n">post_sacc_gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>            <span class="n">post_sacc_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>        <span class="c1"># first, throw out all data where all data_filters are zero</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>        <span class="n">is_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>        <span class="n">is_valid</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>        
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>        <span class="c1"># Now invalid post_sacc_gap following saccades</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span><span class="p">):</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:])</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>            <span class="n">sts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>            <span class="n">is_valid</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">post_sacc_gap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>        
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>        <span class="c1">#self.valid_inds = list(np.where(is_valid &gt; 0)[0])</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_valid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>    <span class="c1"># END .create_valid_indices</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>    <span class="k">def</span> <span class="nf">crossval_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test_set</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a><span class="sd">        This sets the cross-validation indices up We can add featuers here. Many ways to do this</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a><span class="sd">        but will stick to some standard for now. It sets the internal indices, which can be read out</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a><span class="sd">        directly or with helper functions. Perhaps helper_functions is the best way....</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a><span class="sd">        </span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a><span class="sd">        Args: </span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a><span class="sd">            folds: number of folds to partition data into</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a><span class="sd">            test_set: whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a><span class="sd">            verbose: whether to print out information about the partitioning</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a><span class="sd">        Returns:</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a><span class="sd">            None: sets internal variables test_inds, train_inds, val_inds</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must first specify valid_indices before setting up cross-validation.&quot;</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>        <span class="c1"># Partition data by saccades, and then associate indices with each</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>        <span class="n">te_fixes</span><span class="p">,</span> <span class="n">tr_fixes</span><span class="p">,</span> <span class="n">val_fixes</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixation_grouping</span><span class="p">)):</span>  <span class="c1"># Loops across experiments</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>            <span class="n">fixations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixation_grouping</span><span class="p">[</span><span class="n">ee</span><span class="p">])</span>  <span class="c1"># fixations associated with each experiment</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>            <span class="n">val_fix1</span><span class="p">,</span> <span class="n">tr_fix1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fixations</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>            <span class="k">if</span> <span class="n">test_set</span><span class="p">:</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>                <span class="n">te_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">val_fix1</span><span class="p">])</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>                <span class="n">val_fix2</span><span class="p">,</span> <span class="n">tr_fix2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_fix1</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>                <span class="n">val_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">tr_fix1</span><span class="p">[</span><span class="n">val_fix2</span><span class="p">]])</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>                <span class="n">tr_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">tr_fix1</span><span class="p">[</span><span class="n">tr_fix2</span><span class="p">]])</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>                <span class="n">val_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">val_fix1</span><span class="p">])</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>                <span class="n">tr_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">tr_fix1</span><span class="p">])</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Partitioned </span><span class="si">%d</span><span class="s2"> fixations total: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>                <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">te_fixes</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_fixes</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">val_fixes</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_fixes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_fixes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">te_fixes</span><span class="p">)))</span>  
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>        <span class="c1"># Now pull  indices from each saccade </span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>        <span class="n">tr_inds</span><span class="p">,</span> <span class="n">te_inds</span><span class="p">,</span> <span class="n">val_inds</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">tr_fixes</span><span class="p">:</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>            <span class="n">tr_inds</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">val_fixes</span><span class="p">:</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>            <span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">te_fixes</span><span class="p">:</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>            <span class="n">te_inds</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Pre-valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">te_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>        <span class="c1"># Finally intersect with valid indices</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">)))</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">val_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">)))</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">te_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">)))</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>    <span class="c1"># END MultiDatasetFix.crossval_setup</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>    <span class="k">def</span> <span class="nf">fold_sample</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a><span class="sd">        This really should be a general method not associated with self.</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a><span class="sd">        </span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a><span class="sd">        Args:</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a><span class="sd">            num_items: number of items to partition</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a><span class="sd">            folds: number of folds to partition into</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a><span class="sd">            random_gen: whether to randomly partition or not</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a><span class="sd">        Returns:</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a><span class="sd">            val_items: indices of items to be used for validation</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a><span class="sd">            rem_items: indices of items to be used for remainder</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>        <span class="k">if</span> <span class="n">random_gen</span><span class="p">:</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>            <span class="n">num_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_items</span><span class="o">/</span><span class="n">folds</span><span class="p">)</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>            <span class="n">tmp_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">num_items</span><span class="p">)</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[:</span><span class="n">num_val</span><span class="p">])</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[</span><span class="n">num_val</span><span class="p">:])</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>            <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">folds</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">),</span> <span class="n">val_items</span><span class="p">)</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>        <span class="k">return</span> <span class="n">val_items</span><span class="p">,</span> <span class="n">rem_items</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>    <span class="k">def</span> <span class="nf">get_max_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpu_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nquad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mf">1.2</span><span class="p">):</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a><span class="sd">        get the maximum number of samples that fit in memory -- for GLM/GQM x LBFGS</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a><span class="sd">        Args:</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a><span class="sd">            dataset: the dataset to get the samples from</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a><span class="sd">            device: the device to put the samples on</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a><span class="sd">        Returns:</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a><span class="sd">            maxsamples: the maximum number of samples that can fit on the device</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>        <span class="k">if</span> <span class="n">gpu_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:1&#39;</span><span class="p">)</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>        <span class="k">if</span> <span class="n">num_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>            <span class="n">num_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>        
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">total_memory</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_reserved</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_allocated</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>        <span class="n">free</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>        <span class="n">mempersample</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>    
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>        <span class="n">mempercell</span> <span class="o">=</span> <span class="n">mempersample</span> <span class="o">*</span> <span class="p">(</span><span class="n">nquad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">history_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>        <span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">*</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>        <span class="n">maxsamples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">free</span> <span class="o">-</span> <span class="n">mempercell</span><span class="o">*</span><span class="n">num_cells</span> <span class="o">-</span> <span class="n">buffer_bytes</span><span class="p">)</span> <span class="o">//</span> <span class="n">mempersample</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# samples that can fit on device: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxsamples</span><span class="p">))</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>        <span class="k">return</span> <span class="n">maxsamples</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>    <span class="c1"># END .get_max_samples</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>        
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;get_item time embedding not implemented yet&quot;</span><span class="p">)</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>                <span class="c1"># if self.folded_lags:</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>                <span class="c1">#    stim = np.transpose( tmp_stim, axes=[0,2,1,3,4] ) </span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>                <span class="c1">#else:</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>                <span class="c1">#    stim = np.transpose( tmp_stim, axes=[0,2,3,4,1] )</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>    
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>                    <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>                        <span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>  <span class="c1"># one stim has to be called stim </span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>                        <span class="s1">&#39;stimV&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>                        <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>                        <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>                        <span class="s1">&#39;fix_n&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">[</span><span class="n">idx</span><span class="p">]}</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>                        <span class="c1"># missing saccade timing vector -- not specified</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s1">&#39;cells_out must be a list&#39;</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>                    <span class="n">robs_tmp</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>                    <span class="n">dfs_tmp</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>                    <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>                        <span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>                        <span class="s1">&#39;stimV&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>                        <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="n">robs_tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>                        <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="n">dfs_tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>                        <span class="s1">&#39;fix_n&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">[</span><span class="n">idx</span><span class="p">]}</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>            
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>            <span class="n">stim</span><span class="p">,</span> <span class="n">stimV</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>            <span class="n">robs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>            <span class="n">num_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Stim &quot;&quot;&quot;</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>            <span class="c1"># need file handle</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>            <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>            <span class="c1">#f = self.file_index[inds]  # problem is this could span across several files</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NOT DONE YET&quot;</span><span class="p">)</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">stimname</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>            <span class="c1"># reshape and flatten stim: currently its NT x NX x NY x Nclrs</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">permute</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">])</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a><span class="w">                </span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Spikes: needs padding so all are B x NC &quot;&quot;&quot;</span> 
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>            <span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;Robs&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>                <span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>                    <span class="p">(</span><span class="n">robs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span> 
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>                    <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a><span class="w">                </span><span class="sd">&quot;&quot;&quot; Datafilters: needs padding like robs &quot;&quot;&quot;</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;DFs&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>                <span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>                    <span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;DFsMU&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>                    <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="n">stim</span><span class="p">,</span> <span class="s1">&#39;stimV&#39;</span><span class="p">:</span> <span class="n">stimV</span><span class="p">,</span> <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="n">robs</span><span class="p">,</span> <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="n">dfs</span><span class="p">,</span> <span class="s1">&#39;fix_n&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">[</span><span class="n">inds</span><span class="p">]}</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>        <span class="k">return</span> <span class="n">out</span>                
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="Bar1D">
                            <input id="Bar1D-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Bar1D</span><wbr>(<span class="base">typing.Generic[+T_co]</span>):

                <label class="view-source-button" for="Bar1D-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1D"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1D-15"><a href="#Bar1D-15"><span class="linenos"> 15</span></a><span class="k">class</span> <span class="nc">Bar1D</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span><span id="Bar1D-16"><a href="#Bar1D-16"><span class="linenos"> 16</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1D-17"><a href="#Bar1D-17"><span class="linenos"> 17</span></a><span class="sd">    -- can load batches from multiple datasets</span>
</span><span id="Bar1D-18"><a href="#Bar1D-18"><span class="linenos"> 18</span></a><span class="sd">    -- hdf5 files must have the following information:</span>
</span><span id="Bar1D-19"><a href="#Bar1D-19"><span class="linenos"> 19</span></a><span class="sd">        Robs</span>
</span><span id="Bar1D-20"><a href="#Bar1D-20"><span class="linenos"> 20</span></a><span class="sd">        RobsMU</span>
</span><span id="Bar1D-21"><a href="#Bar1D-21"><span class="linenos"> 21</span></a><span class="sd">        stim: 4-d stimulus: time x nx x ny x color</span>
</span><span id="Bar1D-22"><a href="#Bar1D-22"><span class="linenos"> 22</span></a><span class="sd">        block_inds: start and stop of &#39;trials&#39; (perhaps fixations for now)</span>
</span><span id="Bar1D-23"><a href="#Bar1D-23"><span class="linenos"> 23</span></a><span class="sd">        other things: saccades? or should that be in trials? </span>
</span><span id="Bar1D-24"><a href="#Bar1D-24"><span class="linenos"> 24</span></a>
</span><span id="Bar1D-25"><a href="#Bar1D-25"><span class="linenos"> 25</span></a><span class="sd">    Constructor will take eye position, which for now is an input from data</span>
</span><span id="Bar1D-26"><a href="#Bar1D-26"><span class="linenos"> 26</span></a><span class="sd">    generated in the session (not on disk). It should have the length size </span>
</span><span id="Bar1D-27"><a href="#Bar1D-27"><span class="linenos"> 27</span></a><span class="sd">    of the total number of fixations x1.</span>
</span><span id="Bar1D-28"><a href="#Bar1D-28"><span class="linenos"> 28</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Bar1D-29"><a href="#Bar1D-29"><span class="linenos"> 29</span></a>
</span><span id="Bar1D-30"><a href="#Bar1D-30"><span class="linenos"> 30</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="Bar1D-31"><a href="#Bar1D-31"><span class="linenos"> 31</span></a>        <span class="n">sess_list</span><span class="p">,</span>
</span><span id="Bar1D-32"><a href="#Bar1D-32"><span class="linenos"> 32</span></a>        <span class="n">datadir</span><span class="p">,</span> 
</span><span id="Bar1D-33"><a href="#Bar1D-33"><span class="linenos"> 33</span></a>        <span class="c1"># Stim setup</span>
</span><span id="Bar1D-34"><a href="#Bar1D-34"><span class="linenos"> 34</span></a>        <span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
</span><span id="Bar1D-35"><a href="#Bar1D-35"><span class="linenos"> 35</span></a>        <span class="c1">#which_stim = &#39;stimET&#39;,</span>
</span><span id="Bar1D-36"><a href="#Bar1D-36"><span class="linenos"> 36</span></a>        <span class="n">stim_crop</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Bar1D-37"><a href="#Bar1D-37"><span class="linenos"> 37</span></a>        <span class="n">time_embed</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="Bar1D-38"><a href="#Bar1D-38"><span class="linenos"> 38</span></a>        <span class="n">folded_lags</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
</span><span id="Bar1D-39"><a href="#Bar1D-39"><span class="linenos"> 39</span></a>        <span class="c1">#luminance_only=True,</span>
</span><span id="Bar1D-40"><a href="#Bar1D-40"><span class="linenos"> 40</span></a>        <span class="c1"># other</span>
</span><span id="Bar1D-41"><a href="#Bar1D-41"><span class="linenos"> 41</span></a>        <span class="n">ignore_saccades</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Bar1D-42"><a href="#Bar1D-42"><span class="linenos"> 42</span></a>        <span class="n">include_MUs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Bar1D-43"><a href="#Bar1D-43"><span class="linenos"> 43</span></a>        <span class="n">preload</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Bar1D-44"><a href="#Bar1D-44"><span class="linenos"> 44</span></a>        <span class="n">eyepos</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="Bar1D-45"><a href="#Bar1D-45"><span class="linenos"> 45</span></a>        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
</span><span id="Bar1D-46"><a href="#Bar1D-46"><span class="linenos"> 46</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1D-47"><a href="#Bar1D-47"><span class="linenos"> 47</span></a><span class="sd">        Constructor options.</span>
</span><span id="Bar1D-48"><a href="#Bar1D-48"><span class="linenos"> 48</span></a>
</span><span id="Bar1D-49"><a href="#Bar1D-49"><span class="linenos"> 49</span></a><span class="sd">        Args:</span>
</span><span id="Bar1D-50"><a href="#Bar1D-50"><span class="linenos"> 50</span></a><span class="sd">            sess_list: list of strings of session names</span>
</span><span id="Bar1D-51"><a href="#Bar1D-51"><span class="linenos"> 51</span></a><span class="sd">            datadir: directory where data is stored</span>
</span><span id="Bar1D-52"><a href="#Bar1D-52"><span class="linenos"> 52</span></a><span class="sd">            num_lags: number of lags to include in stimulus</span>
</span><span id="Bar1D-53"><a href="#Bar1D-53"><span class="linenos"> 53</span></a><span class="sd">            stim_crop: cropping of stimulus</span>
</span><span id="Bar1D-54"><a href="#Bar1D-54"><span class="linenos"> 54</span></a><span class="sd">            time_embed: 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="Bar1D-55"><a href="#Bar1D-55"><span class="linenos"> 55</span></a><span class="sd">            folded_lags: whether to fold lags into channel dimension</span>
</span><span id="Bar1D-56"><a href="#Bar1D-56"><span class="linenos"> 56</span></a><span class="sd">            ignore_saccades: whether to ignore saccades in the data</span>
</span><span id="Bar1D-57"><a href="#Bar1D-57"><span class="linenos"> 57</span></a><span class="sd">            include_MUs: whether to include multi-units in the data</span>
</span><span id="Bar1D-58"><a href="#Bar1D-58"><span class="linenos"> 58</span></a><span class="sd">            preload: whether to preload data into memory</span>
</span><span id="Bar1D-59"><a href="#Bar1D-59"><span class="linenos"> 59</span></a><span class="sd">            eyepos: eye position data</span>
</span><span id="Bar1D-60"><a href="#Bar1D-60"><span class="linenos"> 60</span></a><span class="sd">            device: device to put data on</span>
</span><span id="Bar1D-61"><a href="#Bar1D-61"><span class="linenos"> 61</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1D-62"><a href="#Bar1D-62"><span class="linenos"> 62</span></a>
</span><span id="Bar1D-63"><a href="#Bar1D-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">datadir</span>
</span><span id="Bar1D-64"><a href="#Bar1D-64"><span class="linenos"> 64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sess_list</span> <span class="o">=</span> <span class="n">sess_list</span>
</span><span id="Bar1D-65"><a href="#Bar1D-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
</span><span id="Bar1D-66"><a href="#Bar1D-66"><span class="linenos"> 66</span></a>        
</span><span id="Bar1D-67"><a href="#Bar1D-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span> <span class="o">=</span> <span class="n">num_lags</span>
</span><span id="Bar1D-68"><a href="#Bar1D-68"><span class="linenos"> 68</span></a>        <span class="k">if</span> <span class="n">time_embed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Bar1D-69"><a href="#Bar1D-69"><span class="linenos"> 69</span></a>            <span class="k">assert</span> <span class="n">preload</span><span class="p">,</span> <span class="s2">&quot;Cannot pre-time-embed without preloading.&quot;</span>
</span><span id="Bar1D-70"><a href="#Bar1D-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">=</span> <span class="n">time_embed</span>
</span><span id="Bar1D-71"><a href="#Bar1D-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preload</span> <span class="o">=</span> <span class="n">preload</span>
</span><span id="Bar1D-72"><a href="#Bar1D-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="o">=</span> <span class="n">stim_crop</span>
</span><span id="Bar1D-73"><a href="#Bar1D-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span> <span class="o">=</span> <span class="n">folded_lags</span>
</span><span id="Bar1D-74"><a href="#Bar1D-74"><span class="linenos"> 74</span></a>
</span><span id="Bar1D-75"><a href="#Bar1D-75"><span class="linenos"> 75</span></a>        <span class="c1"># get hdf5 file handles</span>
</span><span id="Bar1D-76"><a href="#Bar1D-76"><span class="linenos"> 76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">sess</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_list</span><span class="p">]</span>
</span><span id="Bar1D-77"><a href="#Bar1D-77"><span class="linenos"> 77</span></a>        
</span><span id="Bar1D-78"><a href="#Bar1D-78"><span class="linenos"> 78</span></a>        <span class="c1"># Data to just read in and store</span>
</span><span id="Bar1D-79"><a href="#Bar1D-79"><span class="linenos"> 79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ETstim_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ETstim_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Bar1D-80"><a href="#Bar1D-80"><span class="linenos"> 80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;fix_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D-81"><a href="#Bar1D-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probeIDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Robs_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="Bar1D-82"><a href="#Bar1D-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probeIDsMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;RobsMU_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D-83"><a href="#Bar1D-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dt&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D-84"><a href="#Bar1D-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;pixel_size&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D-85"><a href="#Bar1D-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exptdate</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># need to learn matlab strings in HDF5 format (not saved as HDF5 string)</span>
</span><span id="Bar1D-86"><a href="#Bar1D-86"><span class="linenos"> 86</span></a>
</span><span id="Bar1D-87"><a href="#Bar1D-87"><span class="linenos"> 87</span></a>        <span class="c1"># build index map</span>
</span><span id="Bar1D-88"><a href="#Bar1D-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_threshold</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># how many valid time points required to include saccade?</span>
</span><span id="Bar1D-89"><a href="#Bar1D-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_index</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># which file the block corresponds to</span>
</span><span id="Bar1D-90"><a href="#Bar1D-90"><span class="linenos"> 90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D-91"><a href="#Bar1D-91"><span class="linenos"> 91</span></a>        <span class="c1">#self.unit_ids = []</span>
</span><span id="Bar1D-92"><a href="#Bar1D-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_sus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_mus</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="Bar1D-93"><a href="#Bar1D-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sus</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D-94"><a href="#Bar1D-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">=</span> <span class="mi">0</span>    
</span><span id="Bar1D-95"><a href="#Bar1D-95"><span class="linenos"> 95</span></a>        <span class="c1">#self.stim_dims = None</span>
</span><span id="Bar1D-96"><a href="#Bar1D-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span> <span class="o">=</span> <span class="n">eyepos</span>
</span><span id="Bar1D-97"><a href="#Bar1D-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_Xfix</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Bar1D-98"><a href="#Bar1D-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sess_list</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Bar1D-99"><a href="#Bar1D-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D-100"><a href="#Bar1D-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_filemapping</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D-101"><a href="#Bar1D-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span> <span class="o">=</span> <span class="n">include_MUs</span>
</span><span id="Bar1D-102"><a href="#Bar1D-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">SUinds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D-103"><a href="#Bar1D-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">MUinds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D-104"><a href="#Bar1D-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># can be list to output specific cells in get_item</span>
</span><span id="Bar1D-105"><a href="#Bar1D-105"><span class="linenos">105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1D-106"><a href="#Bar1D-106"><span class="linenos">106</span></a>
</span><span id="Bar1D-107"><a href="#Bar1D-107"><span class="linenos">107</span></a>        <span class="c1"># Set up to store default train_, val_, test_inds</span>
</span><span id="Bar1D-108"><a href="#Bar1D-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1D-109"><a href="#Bar1D-109"><span class="linenos">109</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1D-110"><a href="#Bar1D-110"><span class="linenos">110</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1D-111"><a href="#Bar1D-111"><span class="linenos">111</span></a>
</span><span id="Bar1D-112"><a href="#Bar1D-112"><span class="linenos">112</span></a>        <span class="c1"># Data to construct and store in memory</span>
</span><span id="Bar1D-113"><a href="#Bar1D-113"><span class="linenos">113</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D-114"><a href="#Bar1D-114"><span class="linenos">114</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_on</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D-115"><a href="#Bar1D-115"><span class="linenos">115</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_off</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D-116"><a href="#Bar1D-116"><span class="linenos">116</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D-117"><a href="#Bar1D-117"><span class="linenos">117</span></a>
</span><span id="Bar1D-118"><a href="#Bar1D-118"><span class="linenos">118</span></a>        <span class="n">tcount</span><span class="p">,</span> <span class="n">fix_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="Bar1D-119"><a href="#Bar1D-119"><span class="linenos">119</span></a>
</span><span id="Bar1D-120"><a href="#Bar1D-120"><span class="linenos">120</span></a>        <span class="c1">#if which_stim is None:</span>
</span><span id="Bar1D-121"><a href="#Bar1D-121"><span class="linenos">121</span></a>        <span class="c1">#    stimname = &#39;stimET&#39;</span>
</span><span id="Bar1D-122"><a href="#Bar1D-122"><span class="linenos">122</span></a>        <span class="c1">#else:</span>
</span><span id="Bar1D-123"><a href="#Bar1D-123"><span class="linenos">123</span></a>        <span class="c1">#    stimname = which_stim</span>
</span><span id="Bar1D-124"><a href="#Bar1D-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span> <span class="o">=</span> <span class="s1">&#39;stimET&#39;</span>
</span><span id="Bar1D-125"><a href="#Bar1D-125"><span class="linenos">125</span></a>
</span><span id="Bar1D-126"><a href="#Bar1D-126"><span class="linenos">126</span></a>        <span class="k">for</span> <span class="n">fnum</span><span class="p">,</span> <span class="n">fhandle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">):</span>
</span><span id="Bar1D-127"><a href="#Bar1D-127"><span class="linenos">127</span></a>
</span><span id="Bar1D-128"><a href="#Bar1D-128"><span class="linenos">128</span></a>            <span class="n">NT</span><span class="p">,</span> <span class="n">NSUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="Bar1D-129"><a href="#Bar1D-129"><span class="linenos">129</span></a>            <span class="n">NX</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Bar1D-130"><a href="#Bar1D-130"><span class="linenos">130</span></a>            <span class="n">NMUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Bar1D-131"><a href="#Bar1D-131"><span class="linenos">131</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_sus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NSUfile</span><span class="p">)</span>
</span><span id="Bar1D-132"><a href="#Bar1D-132"><span class="linenos">132</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_mus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NMUfile</span><span class="p">)</span>
</span><span id="Bar1D-133"><a href="#Bar1D-133"><span class="linenos">133</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sus</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="o">+</span><span class="n">NSUfile</span><span class="p">))</span>
</span><span id="Bar1D-134"><a href="#Bar1D-134"><span class="linenos">134</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;block_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span id="Bar1D-135"><a href="#Bar1D-135"><span class="linenos">135</span></a>
</span><span id="Bar1D-136"><a href="#Bar1D-136"><span class="linenos">136</span></a>            <span class="n">NCfile</span> <span class="o">=</span> <span class="n">NSUfile</span>
</span><span id="Bar1D-137"><a href="#Bar1D-137"><span class="linenos">137</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="Bar1D-138"><a href="#Bar1D-138"><span class="linenos">138</span></a>                <span class="n">NCfile</span> <span class="o">+=</span> <span class="n">NMUfile</span>
</span><span id="Bar1D-139"><a href="#Bar1D-139"><span class="linenos">139</span></a>            
</span><span id="Bar1D-140"><a href="#Bar1D-140"><span class="linenos">140</span></a>            <span class="c1"># This will associate each block with each file</span>
</span><span id="Bar1D-141"><a href="#Bar1D-141"><span class="linenos">141</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_filemapping</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="n">fnum</span><span class="p">)</span>
</span><span id="Bar1D-142"><a href="#Bar1D-142"><span class="linenos">142</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span><span class="p">[</span><span class="n">fnum</span><span class="p">]</span><span class="o">=</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D-143"><a href="#Bar1D-143"><span class="linenos">143</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span><span class="p">[</span><span class="n">fnum</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1D-144"><a href="#Bar1D-144"><span class="linenos">144</span></a>            <span class="c1">#if self.stim_dims is None:</span>
</span><span id="Bar1D-145"><a href="#Bar1D-145"><span class="linenos">145</span></a>            <span class="c1">#if folded_lags:</span>
</span><span id="Bar1D-146"><a href="#Bar1D-146"><span class="linenos">146</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">([</span><span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="c1">#list(fhandle[stimname].shape[1:4]) + [1]</span>
</span><span id="Bar1D-147"><a href="#Bar1D-147"><span class="linenos">147</span></a>            <span class="c1">#else:</span>
</span><span id="Bar1D-148"><a href="#Bar1D-148"><span class="linenos">148</span></a>            <span class="c1">#    self.dims = list(fhandle[stimname].shape[1:4]) + [1]</span>
</span><span id="Bar1D-149"><a href="#Bar1D-149"><span class="linenos">149</span></a>            
</span><span id="Bar1D-150"><a href="#Bar1D-150"><span class="linenos">150</span></a>            <span class="c1">#self.luminance_only = luminance_only</span>
</span><span id="Bar1D-151"><a href="#Bar1D-151"><span class="linenos">151</span></a>            <span class="c1">#if luminance_only:</span>
</span><span id="Bar1D-152"><a href="#Bar1D-152"><span class="linenos">152</span></a>            <span class="c1">#    if self.dims[0] &gt; 1:</span>
</span><span id="Bar1D-153"><a href="#Bar1D-153"><span class="linenos">153</span></a>            <span class="c1">#        print(&quot;Reducing stimulus channels (%d) to first dimension&quot;%self.dims[0])</span>
</span><span id="Bar1D-154"><a href="#Bar1D-154"><span class="linenos">154</span></a>            <span class="c1">#    self.dims[0] = 1</span>
</span><span id="Bar1D-155"><a href="#Bar1D-155"><span class="linenos">155</span></a>            
</span><span id="Bar1D-156"><a href="#Bar1D-156"><span class="linenos">156</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1D-157"><a href="#Bar1D-157"><span class="linenos">157</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="Bar1D-158"><a href="#Bar1D-158"><span class="linenos">158</span></a>
</span><span id="Bar1D-159"><a href="#Bar1D-159"><span class="linenos">159</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stim check:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">,</span> <span class="n">folded_lags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</span><span id="Bar1D-160"><a href="#Bar1D-160"><span class="linenos">160</span></a>
</span><span id="Bar1D-161"><a href="#Bar1D-161"><span class="linenos">161</span></a>            <span class="c1">#self.unit_ids.append(self.NC + np.asarray(range(NCfile)))</span>
</span><span id="Bar1D-162"><a href="#Bar1D-162"><span class="linenos">162</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NCfile</span><span class="p">)</span>
</span><span id="Bar1D-163"><a href="#Bar1D-163"><span class="linenos">163</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">+=</span> <span class="n">NCfile</span>
</span><span id="Bar1D-164"><a href="#Bar1D-164"><span class="linenos">164</span></a>
</span><span id="Bar1D-165"><a href="#Bar1D-165"><span class="linenos">165</span></a>            <span class="n">sacc_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;sacc_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="Bar1D-166"><a href="#Bar1D-166"><span class="linenos">166</span></a>            <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>  <span class="c1"># each time point labels fixation number</span>
</span><span id="Bar1D-167"><a href="#Bar1D-167"><span class="linenos">167</span></a>            <span class="n">sacc_on</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># each time point labels fixation number</span>
</span><span id="Bar1D-168"><a href="#Bar1D-168"><span class="linenos">168</span></a>            <span class="n">sacc_on</span><span class="p">[</span><span class="n">sacc_inds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="Bar1D-169"><a href="#Bar1D-169"><span class="linenos">169</span></a>            <span class="n">sacc_off</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># each time point labels fixation number</span>
</span><span id="Bar1D-170"><a href="#Bar1D-170"><span class="linenos">170</span></a>            <span class="n">sacc_off</span><span class="p">[</span><span class="n">sacc_inds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="Bar1D-171"><a href="#Bar1D-171"><span class="linenos">171</span></a>
</span><span id="Bar1D-172"><a href="#Bar1D-172"><span class="linenos">172</span></a>            <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;valid_data&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="mi">1</span>  <span class="c1">#range(self.NT)  # default -- to be changed at end of init</span>
</span><span id="Bar1D-173"><a href="#Bar1D-173"><span class="linenos">173</span></a>
</span><span id="Bar1D-174"><a href="#Bar1D-174"><span class="linenos">174</span></a>            <span class="c1"># Got through each block to segment into fixations</span>
</span><span id="Bar1D-175"><a href="#Bar1D-175"><span class="linenos">175</span></a>            <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="Bar1D-176"><a href="#Bar1D-176"><span class="linenos">176</span></a>                <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="Bar1D-177"><a href="#Bar1D-177"><span class="linenos">177</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>
</span><span id="Bar1D-178"><a href="#Bar1D-178"><span class="linenos">178</span></a>                <span class="n">t0</span> <span class="o">=</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="Bar1D-179"><a href="#Bar1D-179"><span class="linenos">179</span></a>                <span class="c1">#valid_inds[range(t0, t0+num_lags)] = 0  # this already adjusted for?</span>
</span><span id="Bar1D-180"><a href="#Bar1D-180"><span class="linenos">180</span></a>
</span><span id="Bar1D-181"><a href="#Bar1D-181"><span class="linenos">181</span></a>                <span class="c1"># Parse fixation numbers within block</span>
</span><span id="Bar1D-182"><a href="#Bar1D-182"><span class="linenos">182</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_saccades</span><span class="p">:</span>
</span><span id="Bar1D-183"><a href="#Bar1D-183"><span class="linenos">183</span></a>                    <span class="n">rel_saccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">sacc_inds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sacc_inds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D-184"><a href="#Bar1D-184"><span class="linenos">184</span></a>                    <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel_saccs</span><span class="p">)):</span>
</span><span id="Bar1D-185"><a href="#Bar1D-185"><span class="linenos">185</span></a>                        <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Bar1D-186"><a href="#Bar1D-186"><span class="linenos">186</span></a>                        <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">sacc_inds</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="Bar1D-187"><a href="#Bar1D-187"><span class="linenos">187</span></a>                        <span class="n">t0</span> <span class="o">=</span> <span class="n">sacc_inds</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="Bar1D-188"><a href="#Bar1D-188"><span class="linenos">188</span></a>                <span class="c1"># Put in last (or only) fixation number</span>
</span><span id="Bar1D-189"><a href="#Bar1D-189"><span class="linenos">189</span></a>                <span class="k">if</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
</span><span id="Bar1D-190"><a href="#Bar1D-190"><span class="linenos">190</span></a>                    <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Bar1D-191"><a href="#Bar1D-191"><span class="linenos">191</span></a>                    <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="Bar1D-192"><a href="#Bar1D-192"><span class="linenos">192</span></a>            
</span><span id="Bar1D-193"><a href="#Bar1D-193"><span class="linenos">193</span></a>            <span class="n">tcount</span> <span class="o">+=</span> <span class="n">NT</span>
</span><span id="Bar1D-194"><a href="#Bar1D-194"><span class="linenos">194</span></a>            <span class="c1"># make larger fix_n, valid_inds, sacc_inds, block_inds as self</span>
</span><span id="Bar1D-195"><a href="#Bar1D-195"><span class="linenos">195</span></a>
</span><span id="Bar1D-196"><a href="#Bar1D-196"><span class="linenos">196</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>  <span class="o">=</span> <span class="n">tcount</span>
</span><span id="Bar1D-197"><a href="#Bar1D-197"><span class="linenos">197</span></a>
</span><span id="Bar1D-198"><a href="#Bar1D-198"><span class="linenos">198</span></a>        <span class="c1"># For now let&#39;s just debug with one file</span>
</span><span id="Bar1D-199"><a href="#Bar1D-199"><span class="linenos">199</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sess_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Bar1D-200"><a href="#Bar1D-200"><span class="linenos">200</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: currently ignoring multiple files&#39;</span><span class="p">)</span>
</span><span id="Bar1D-201"><a href="#Bar1D-201"><span class="linenos">201</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">valid_inds</span><span class="p">)</span>
</span><span id="Bar1D-202"><a href="#Bar1D-202"><span class="linenos">202</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">fix_n</span><span class="p">)</span>
</span><span id="Bar1D-203"><a href="#Bar1D-203"><span class="linenos">203</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sac_on</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sacc_on</span><span class="p">)</span>
</span><span id="Bar1D-204"><a href="#Bar1D-204"><span class="linenos">204</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sac_off</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sacc_off</span><span class="p">)</span>
</span><span id="Bar1D-205"><a href="#Bar1D-205"><span class="linenos">205</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sacc_inds</span><span class="p">)</span>
</span><span id="Bar1D-206"><a href="#Bar1D-206"><span class="linenos">206</span></a>        
</span><span id="Bar1D-207"><a href="#Bar1D-207"><span class="linenos">207</span></a>        <span class="c1"># Go through saccades to establish val_indices and produce saccade timing vector </span>
</span><span id="Bar1D-208"><a href="#Bar1D-208"><span class="linenos">208</span></a>        <span class="c1"># Note that sacc_ts will be generated even without preload -- small enough that doesnt matter</span>
</span><span id="Bar1D-209"><a href="#Bar1D-209"><span class="linenos">209</span></a>    <span class="c1">#    self.sacc_ts = np.zeros([self.NT, 1], dtype=np.float32)</span>
</span><span id="Bar1D-210"><a href="#Bar1D-210"><span class="linenos">210</span></a>    <span class="c1">#    self.fix_n = np.zeros(self.NT, dtype=np.int64)  # label of which fixation is in each range</span>
</span><span id="Bar1D-211"><a href="#Bar1D-211"><span class="linenos">211</span></a>    <span class="c1">#    for nn in range(self.num_fixations):</span>
</span><span id="Bar1D-212"><a href="#Bar1D-212"><span class="linenos">212</span></a>    <span class="c1">#        print(nn, self.sacc_inds[nn][0], self.sacc_inds[nn][1] )</span>
</span><span id="Bar1D-213"><a href="#Bar1D-213"><span class="linenos">213</span></a>    <span class="c1">#        self.sacc_ts[self.sacc_inds[nn][0]] = 1 </span>
</span><span id="Bar1D-214"><a href="#Bar1D-214"><span class="linenos">214</span></a>    <span class="c1">#        self.fix_n[range(self.sacc_inds[nn][0], self.sacc_inds[nn][1])] = nn</span>
</span><span id="Bar1D-215"><a href="#Bar1D-215"><span class="linenos">215</span></a>        <span class="c1">#self.fix_n = list(self.fix_n)  # better list than numpy</span>
</span><span id="Bar1D-216"><a href="#Bar1D-216"><span class="linenos">216</span></a>
</span><span id="Bar1D-217"><a href="#Bar1D-217"><span class="linenos">217</span></a>        <span class="c1">#self.dims = np.unique(np.asarray(self.dims)) # assumes they&#39;re all the same    </span>
</span><span id="Bar1D-218"><a href="#Bar1D-218"><span class="linenos">218</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1D-219"><a href="#Bar1D-219"><span class="linenos">219</span></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span><span class="p">,</span> \
</span><span id="Bar1D-220"><a href="#Bar1D-220"><span class="linenos">220</span></a>                <span class="s2">&quot;eyepos input should have </span><span class="si">%d</span><span class="s2"> fixations.&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span>
</span><span id="Bar1D-221"><a href="#Bar1D-221"><span class="linenos">221</span></a>
</span><span id="Bar1D-222"><a href="#Bar1D-222"><span class="linenos">222</span></a>        <span class="k">if</span> <span class="n">preload</span><span class="p">:</span>
</span><span id="Bar1D-223"><a href="#Bar1D-223"><span class="linenos">223</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data into memory...&quot;</span><span class="p">)</span>
</span><span id="Bar1D-224"><a href="#Bar1D-224"><span class="linenos">224</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">preload_numpy</span><span class="p">()</span>
</span><span id="Bar1D-225"><a href="#Bar1D-225"><span class="linenos">225</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stim shape&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Bar1D-226"><a href="#Bar1D-226"><span class="linenos">226</span></a>            <span class="c1"># Note stim is being represented as full 3-d + 1 tensor (time, channels, NX, NY)</span>
</span><span id="Bar1D-227"><a href="#Bar1D-227"><span class="linenos">227</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1D-228"><a href="#Bar1D-228"><span class="linenos">228</span></a>                <span class="c1"># Would want to shift by input eye positions if input here</span>
</span><span id="Bar1D-229"><a href="#Bar1D-229"><span class="linenos">229</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;eye-position shifting not implemented yet&#39;</span><span class="p">)</span>
</span><span id="Bar1D-230"><a href="#Bar1D-230"><span class="linenos">230</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1D-231"><a href="#Bar1D-231"><span class="linenos">231</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;stimulus cropping not implemented yet&#39;</span><span class="p">)</span>
</span><span id="Bar1D-232"><a href="#Bar1D-232"><span class="linenos">232</span></a>
</span><span id="Bar1D-233"><a href="#Bar1D-233"><span class="linenos">233</span></a>            <span class="k">if</span> <span class="n">time_embed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Bar1D-234"><a href="#Bar1D-234"><span class="linenos">234</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time embedding...&quot;</span><span class="p">)</span>
</span><span id="Bar1D-235"><a href="#Bar1D-235"><span class="linenos">235</span></a>                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="Bar1D-236"><a href="#Bar1D-236"><span class="linenos">236</span></a>                <span class="n">tmp_stimH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="Bar1D-237"><a href="#Bar1D-237"><span class="linenos">237</span></a>                <span class="n">tmp_stimV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="Bar1D-238"><a href="#Bar1D-238"><span class="linenos">238</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span><span class="p">:</span>
</span><span id="Bar1D-239"><a href="#Bar1D-239"><span class="linenos">239</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">tmp_stimH</span>
</span><span id="Bar1D-240"><a href="#Bar1D-240"><span class="linenos">240</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">tmp_stimV</span>
</span><span id="Bar1D-241"><a href="#Bar1D-241"><span class="linenos">241</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Folded lags: stim-dim = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Bar1D-242"><a href="#Bar1D-242"><span class="linenos">242</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1D-243"><a href="#Bar1D-243"><span class="linenos">243</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimH</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="Bar1D-244"><a href="#Bar1D-244"><span class="linenos">244</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimV</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="Bar1D-245"><a href="#Bar1D-245"><span class="linenos">245</span></a>
</span><span id="Bar1D-246"><a href="#Bar1D-246"><span class="linenos">246</span></a>            <span class="c1"># now stimulus is represented as full 4-d + 1 tensor (time, channels, NX, NY, num_lags)</span>
</span><span id="Bar1D-247"><a href="#Bar1D-247"><span class="linenos">247</span></a>
</span><span id="Bar1D-248"><a href="#Bar1D-248"><span class="linenos">248</span></a>            <span class="c1"># Flatten stim </span>
</span><span id="Bar1D-249"><a href="#Bar1D-249"><span class="linenos">249</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Bar1D-250"><a href="#Bar1D-250"><span class="linenos">250</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Bar1D-251"><a href="#Bar1D-251"><span class="linenos">251</span></a>
</span><span id="Bar1D-252"><a href="#Bar1D-252"><span class="linenos">252</span></a>            <span class="c1"># Have data_filters represend used_inds (in case it gets through)</span>
</span><span id="Bar1D-253"><a href="#Bar1D-253"><span class="linenos">253</span></a>            <span class="n">unified_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D-254"><a href="#Bar1D-254"><span class="linenos">254</span></a>            <span class="n">unified_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="Bar1D-255"><a href="#Bar1D-255"><span class="linenos">255</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*=</span> <span class="n">unified_df</span>
</span><span id="Bar1D-256"><a href="#Bar1D-256"><span class="linenos">256</span></a>            <span class="c1"># Convert data to tensors</span>
</span><span id="Bar1D-257"><a href="#Bar1D-257"><span class="linenos">257</span></a>            <span class="c1">#if self.device is not None:</span>
</span><span id="Bar1D-258"><a href="#Bar1D-258"><span class="linenos">258</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D-259"><a href="#Bar1D-259"><span class="linenos">259</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span>
</span><span id="Bar1D-260"><a href="#Bar1D-260"><span class="linenos">260</span></a>
</span><span id="Bar1D-261"><a href="#Bar1D-261"><span class="linenos">261</span></a>        <span class="c1"># Create valid indices and first pass of cross-validation indices</span>
</span><span id="Bar1D-262"><a href="#Bar1D-262"><span class="linenos">262</span></a>        <span class="c1">#self.create_valid_indices()</span>
</span><span id="Bar1D-263"><a href="#Bar1D-263"><span class="linenos">263</span></a>        <span class="c1"># Develop default train, validation, and test datasets </span>
</span><span id="Bar1D-264"><a href="#Bar1D-264"><span class="linenos">264</span></a>        <span class="c1">#self.crossval_setup()</span>
</span><span id="Bar1D-265"><a href="#Bar1D-265"><span class="linenos">265</span></a>
</span><span id="Bar1D-266"><a href="#Bar1D-266"><span class="linenos">266</span></a>        <span class="c1"># Reflects block structure</span>
</span><span id="Bar1D-267"><a href="#Bar1D-267"><span class="linenos">267</span></a>        <span class="n">vblks</span><span class="p">,</span> <span class="n">trblks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Bar1D-268"><a href="#Bar1D-268"><span class="linenos">268</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D-269"><a href="#Bar1D-269"><span class="linenos">269</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">trblks</span><span class="p">:</span>
</span><span id="Bar1D-270"><a href="#Bar1D-270"><span class="linenos">270</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="Bar1D-271"><a href="#Bar1D-271"><span class="linenos">271</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D-272"><a href="#Bar1D-272"><span class="linenos">272</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">vblks</span><span class="p">:</span>
</span><span id="Bar1D-273"><a href="#Bar1D-273"><span class="linenos">273</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="Bar1D-274"><a href="#Bar1D-274"><span class="linenos">274</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="Bar1D-275"><a href="#Bar1D-275"><span class="linenos">275</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="Bar1D-276"><a href="#Bar1D-276"><span class="linenos">276</span></a>    <span class="c1"># END ColorClouds.__init__</span>
</span><span id="Bar1D-277"><a href="#Bar1D-277"><span class="linenos">277</span></a>
</span><span id="Bar1D-278"><a href="#Bar1D-278"><span class="linenos">278</span></a>    <span class="k">def</span> <span class="nf">preload_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Bar1D-279"><a href="#Bar1D-279"><span class="linenos">279</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1D-280"><a href="#Bar1D-280"><span class="linenos">280</span></a><span class="sd">        Note this loads stimulus but does not time-embed.</span>
</span><span id="Bar1D-281"><a href="#Bar1D-281"><span class="linenos">281</span></a>
</span><span id="Bar1D-282"><a href="#Bar1D-282"><span class="linenos">282</span></a><span class="sd">        Args:</span>
</span><span id="Bar1D-283"><a href="#Bar1D-283"><span class="linenos">283</span></a><span class="sd">            None</span>
</span><span id="Bar1D-284"><a href="#Bar1D-284"><span class="linenos">284</span></a>
</span><span id="Bar1D-285"><a href="#Bar1D-285"><span class="linenos">285</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1D-286"><a href="#Bar1D-286"><span class="linenos">286</span></a><span class="sd">            None: sets self.stim, self.robs, self.dfs, self.eyepos, self.frame_times</span>
</span><span id="Bar1D-287"><a href="#Bar1D-287"><span class="linenos">287</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1D-288"><a href="#Bar1D-288"><span class="linenos">288</span></a>
</span><span id="Bar1D-289"><a href="#Bar1D-289"><span class="linenos">289</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span><span id="Bar1D-290"><a href="#Bar1D-290"><span class="linenos">290</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="Bar1D-291"><a href="#Bar1D-291"><span class="linenos">291</span></a><span class="sd">        Pre-allocate memory for data</span>
</span><span id="Bar1D-292"><a href="#Bar1D-292"><span class="linenos">292</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="Bar1D-293"><a href="#Bar1D-293"><span class="linenos">293</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D-294"><a href="#Bar1D-294"><span class="linenos">294</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D-295"><a href="#Bar1D-295"><span class="linenos">295</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D-296"><a href="#Bar1D-296"><span class="linenos">296</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D-297"><a href="#Bar1D-297"><span class="linenos">297</span></a>        <span class="c1">#self.eyepos = np.zeros([NT, 2], dtype=np.float32)</span>
</span><span id="Bar1D-298"><a href="#Bar1D-298"><span class="linenos">298</span></a>        <span class="c1">#self.frame_times = np.zeros([NT,1], dtype=np.float32)</span>
</span><span id="Bar1D-299"><a href="#Bar1D-299"><span class="linenos">299</span></a>
</span><span id="Bar1D-300"><a href="#Bar1D-300"><span class="linenos">300</span></a>        <span class="n">t_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1D-301"><a href="#Bar1D-301"><span class="linenos">301</span></a>        <span class="n">unit_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1D-302"><a href="#Bar1D-302"><span class="linenos">302</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">)):</span>
</span><span id="Bar1D-303"><a href="#Bar1D-303"><span class="linenos">303</span></a>            
</span><span id="Bar1D-304"><a href="#Bar1D-304"><span class="linenos">304</span></a>            <span class="n">fhandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="Bar1D-305"><a href="#Bar1D-305"><span class="linenos">305</span></a>            <span class="n">sz</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="Bar1D-306"><a href="#Bar1D-306"><span class="linenos">306</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_counter</span><span class="p">,</span> <span class="n">t_counter</span><span class="o">+</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="Bar1D-307"><a href="#Bar1D-307"><span class="linenos">307</span></a>            <span class="c1">#inds = self.stim_indices[expt][stim][&#39;inds&#39;]</span>
</span><span id="Bar1D-308"><a href="#Bar1D-308"><span class="linenos">308</span></a>            <span class="c1">#self.stim[inds, ...] = np.transpose( np.array(fhandle[self.stimname], dtype=np.float32), axes=[0,3,1,2])</span>
</span><span id="Bar1D-309"><a href="#Bar1D-309"><span class="linenos">309</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D-310"><a href="#Bar1D-310"><span class="linenos">310</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tmp_stim</span><span class="p">)</span>
</span><span id="Bar1D-311"><a href="#Bar1D-311"><span class="linenos">311</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp_stim</span>
</span><span id="Bar1D-312"><a href="#Bar1D-312"><span class="linenos">312</span></a>            <span class="n">stim_ori</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimETori&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D-313"><a href="#Bar1D-313"><span class="linenos">313</span></a>            <span class="n">Hinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_ori</span> <span class="o">&lt;</span> <span class="mi">45</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D-314"><a href="#Bar1D-314"><span class="linenos">314</span></a>            <span class="n">Vinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_ori</span> <span class="o">&gt;</span> <span class="mi">45</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D-315"><a href="#Bar1D-315"><span class="linenos">315</span></a>
</span><span id="Bar1D-316"><a href="#Bar1D-316"><span class="linenos">316</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">Vinds</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="Bar1D-317"><a href="#Bar1D-317"><span class="linenos">317</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">Hinds</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="Bar1D-318"><a href="#Bar1D-318"><span class="linenos">318</span></a>
</span><span id="Bar1D-319"><a href="#Bar1D-319"><span class="linenos">319</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; EYE POSITION &quot;&quot;&quot;</span>
</span><span id="Bar1D-320"><a href="#Bar1D-320"><span class="linenos">320</span></a>            <span class="c1">#ppd = fhandle[stim][self.stimset][&#39;Stim&#39;].attrs[&#39;ppd&#39;][0]</span>
</span><span id="Bar1D-321"><a href="#Bar1D-321"><span class="linenos">321</span></a>            <span class="c1">#centerpix = fhandle[stim][self.stimset][&#39;Stim&#39;].attrs[&#39;center&#39;][:]</span>
</span><span id="Bar1D-322"><a href="#Bar1D-322"><span class="linenos">322</span></a>            <span class="c1">#eye_tmp = fhandle[stim][self.stimset][&#39;eyeAtFrame&#39;][1:3,:].T</span>
</span><span id="Bar1D-323"><a href="#Bar1D-323"><span class="linenos">323</span></a>            <span class="c1">#eye_tmp[:,0] -= centerpix[0]</span>
</span><span id="Bar1D-324"><a href="#Bar1D-324"><span class="linenos">324</span></a>            <span class="c1">#eye_tmp[:,1] -= centerpix[1]</span>
</span><span id="Bar1D-325"><a href="#Bar1D-325"><span class="linenos">325</span></a>            <span class="c1">#eye_tmp/= ppd</span>
</span><span id="Bar1D-326"><a href="#Bar1D-326"><span class="linenos">326</span></a>            <span class="c1">#self.eyepos[inds,:] = eye_tmp</span>
</span><span id="Bar1D-327"><a href="#Bar1D-327"><span class="linenos">327</span></a>
</span><span id="Bar1D-328"><a href="#Bar1D-328"><span class="linenos">328</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Robs and DATAFILTERS&quot;&quot;&quot;</span>
</span><span id="Bar1D-329"><a href="#Bar1D-329"><span class="linenos">329</span></a>            <span class="n">robs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="Bar1D-330"><a href="#Bar1D-330"><span class="linenos">330</span></a>            <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="Bar1D-331"><a href="#Bar1D-331"><span class="linenos">331</span></a>            <span class="n">num_sus</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Bar1D-332"><a href="#Bar1D-332"><span class="linenos">332</span></a>            <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="p">)</span>
</span><span id="Bar1D-333"><a href="#Bar1D-333"><span class="linenos">333</span></a>            <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D-334"><a href="#Bar1D-334"><span class="linenos">334</span></a>            <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;datafilts&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D-335"><a href="#Bar1D-335"><span class="linenos">335</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="Bar1D-336"><a href="#Bar1D-336"><span class="linenos">336</span></a>                <span class="n">num_mus</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Bar1D-337"><a href="#Bar1D-337"><span class="linenos">337</span></a>                <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="o">+</span><span class="n">num_mus</span><span class="p">)</span>
</span><span id="Bar1D-338"><a href="#Bar1D-338"><span class="linenos">338</span></a>                <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D-339"><a href="#Bar1D-339"><span class="linenos">339</span></a>                <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;DFsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D-340"><a href="#Bar1D-340"><span class="linenos">340</span></a>            
</span><span id="Bar1D-341"><a href="#Bar1D-341"><span class="linenos">341</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">robs_tmp</span><span class="p">)</span>
</span><span id="Bar1D-342"><a href="#Bar1D-342"><span class="linenos">342</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dfs_tmp</span><span class="p">)</span>
</span><span id="Bar1D-343"><a href="#Bar1D-343"><span class="linenos">343</span></a>
</span><span id="Bar1D-344"><a href="#Bar1D-344"><span class="linenos">344</span></a>            <span class="n">t_counter</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D-345"><a href="#Bar1D-345"><span class="linenos">345</span></a>            <span class="n">unit_counter</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="Bar1D-346"><a href="#Bar1D-346"><span class="linenos">346</span></a>
</span><span id="Bar1D-347"><a href="#Bar1D-347"><span class="linenos">347</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span> <span class="o">=</span> <span class="s1">&#39;stimH&#39;</span>  <span class="c1"># either work I think</span>
</span><span id="Bar1D-348"><a href="#Bar1D-348"><span class="linenos">348</span></a>    <span class="c1"># END .preload_numpy()</span>
</span><span id="Bar1D-349"><a href="#Bar1D-349"><span class="linenos">349</span></a>
</span><span id="Bar1D-350"><a href="#Bar1D-350"><span class="linenos">350</span></a>    <span class="k">def</span> <span class="nf">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="Bar1D-351"><a href="#Bar1D-351"><span class="linenos">351</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="Bar1D-352"><a href="#Bar1D-352"><span class="linenos">352</span></a>            <span class="c1"># then already converted: just moving device</span>
</span><span id="Bar1D-353"><a href="#Bar1D-353"><span class="linenos">353</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D-354"><a href="#Bar1D-354"><span class="linenos">354</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D-355"><a href="#Bar1D-355"><span class="linenos">355</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D-356"><a href="#Bar1D-356"><span class="linenos">356</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D-357"><a href="#Bar1D-357"><span class="linenos">357</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D-358"><a href="#Bar1D-358"><span class="linenos">358</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1D-359"><a href="#Bar1D-359"><span class="linenos">359</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D-360"><a href="#Bar1D-360"><span class="linenos">360</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D-361"><a href="#Bar1D-361"><span class="linenos">361</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D-362"><a href="#Bar1D-362"><span class="linenos">362</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D-363"><a href="#Bar1D-363"><span class="linenos">363</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D-364"><a href="#Bar1D-364"><span class="linenos">364</span></a>
</span><span id="Bar1D-365"><a href="#Bar1D-365"><span class="linenos">365</span></a>    <span class="c1">#    self.sacc_ts = torch.tensor(self.sacc_ts, dtype=torch.float32, device=device)</span>
</span><span id="Bar1D-366"><a href="#Bar1D-366"><span class="linenos">366</span></a>        <span class="c1">#self.eyepos = torch.tensor(self.eyepos.astype(&#39;float32&#39;), dtype=self.dtype, device=device)</span>
</span><span id="Bar1D-367"><a href="#Bar1D-367"><span class="linenos">367</span></a>        <span class="c1">#self.frame_times = torch.tensor(self.frame_times.astype(&#39;float32&#39;), dtype=self.dtype, device=device)</span>
</span><span id="Bar1D-368"><a href="#Bar1D-368"><span class="linenos">368</span></a>
</span><span id="Bar1D-369"><a href="#Bar1D-369"><span class="linenos">369</span></a>    <span class="k">def</span> <span class="nf">avrates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="Bar1D-370"><a href="#Bar1D-370"><span class="linenos">370</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1D-371"><a href="#Bar1D-371"><span class="linenos">371</span></a><span class="sd">        Calculates average firing probability across specified inds (or whole dataset)</span>
</span><span id="Bar1D-372"><a href="#Bar1D-372"><span class="linenos">372</span></a><span class="sd">        -- Note will respect datafilters</span>
</span><span id="Bar1D-373"><a href="#Bar1D-373"><span class="linenos">373</span></a><span class="sd">        -- will return precalc value to save time if already stored</span>
</span><span id="Bar1D-374"><a href="#Bar1D-374"><span class="linenos">374</span></a>
</span><span id="Bar1D-375"><a href="#Bar1D-375"><span class="linenos">375</span></a><span class="sd">        Args:</span>
</span><span id="Bar1D-376"><a href="#Bar1D-376"><span class="linenos">376</span></a><span class="sd">            inds: indices to calculate average rates over</span>
</span><span id="Bar1D-377"><a href="#Bar1D-377"><span class="linenos">377</span></a>
</span><span id="Bar1D-378"><a href="#Bar1D-378"><span class="linenos">378</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1D-379"><a href="#Bar1D-379"><span class="linenos">379</span></a><span class="sd">            avRs: average firing rates across specified indices</span>
</span><span id="Bar1D-380"><a href="#Bar1D-380"><span class="linenos">380</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1D-381"><a href="#Bar1D-381"><span class="linenos">381</span></a>        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1D-382"><a href="#Bar1D-382"><span class="linenos">382</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="Bar1D-383"><a href="#Bar1D-383"><span class="linenos">383</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="Bar1D-384"><a href="#Bar1D-384"><span class="linenos">384</span></a>            <span class="c1"># then calculate across whole dataset</span>
</span><span id="Bar1D-385"><a href="#Bar1D-385"><span class="linenos">385</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1D-386"><a href="#Bar1D-386"><span class="linenos">386</span></a>                <span class="c1"># then precalculated and do not need to do</span>
</span><span id="Bar1D-387"><a href="#Bar1D-387"><span class="linenos">387</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span>
</span><span id="Bar1D-388"><a href="#Bar1D-388"><span class="linenos">388</span></a>
</span><span id="Bar1D-389"><a href="#Bar1D-389"><span class="linenos">389</span></a>        <span class="c1"># Otherwise calculate across all data</span>
</span><span id="Bar1D-390"><a href="#Bar1D-390"><span class="linenos">390</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="Bar1D-391"><a href="#Bar1D-391"><span class="linenos">391</span></a>            <span class="n">Reff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="Bar1D-392"><a href="#Bar1D-392"><span class="linenos">392</span></a>            <span class="n">Teff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="Bar1D-393"><a href="#Bar1D-393"><span class="linenos">393</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="o">/</span><span class="n">Teff</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="Bar1D-394"><a href="#Bar1D-394"><span class="linenos">394</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1D-395"><a href="#Bar1D-395"><span class="linenos">395</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Still need to implement avRs without preloading&#39;</span><span class="p">)</span>
</span><span id="Bar1D-396"><a href="#Bar1D-396"><span class="linenos">396</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="Bar1D-397"><a href="#Bar1D-397"><span class="linenos">397</span></a>    <span class="c1"># END .avrates()</span>
</span><span id="Bar1D-398"><a href="#Bar1D-398"><span class="linenos">398</span></a>
</span><span id="Bar1D-399"><a href="#Bar1D-399"><span class="linenos">399</span></a>    <span class="k">def</span> <span class="nf">shift_stim_fixation</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
</span><span id="Bar1D-400"><a href="#Bar1D-400"><span class="linenos">400</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1D-401"><a href="#Bar1D-401"><span class="linenos">401</span></a><span class="sd">        Simple shift by integer (rounded shift) and zero padded. Note that this is not in </span>
</span><span id="Bar1D-402"><a href="#Bar1D-402"><span class="linenos">402</span></a><span class="sd">        is in units of number of bars, rather than -1 to +1. It assumes the stim</span>
</span><span id="Bar1D-403"><a href="#Bar1D-403"><span class="linenos">403</span></a><span class="sd">        has a batch dimension (over a fixation), and shifts the whole stim by the same amount.</span>
</span><span id="Bar1D-404"><a href="#Bar1D-404"><span class="linenos">404</span></a><span class="sd">        </span>
</span><span id="Bar1D-405"><a href="#Bar1D-405"><span class="linenos">405</span></a><span class="sd">        Args:</span>
</span><span id="Bar1D-406"><a href="#Bar1D-406"><span class="linenos">406</span></a><span class="sd">            stim: stimulus tensor to shift</span>
</span><span id="Bar1D-407"><a href="#Bar1D-407"><span class="linenos">407</span></a><span class="sd">            shift: amount to shift by (in units of bars)</span>
</span><span id="Bar1D-408"><a href="#Bar1D-408"><span class="linenos">408</span></a>
</span><span id="Bar1D-409"><a href="#Bar1D-409"><span class="linenos">409</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1D-410"><a href="#Bar1D-410"><span class="linenos">410</span></a><span class="sd">            shstim: shifted stimulus tensor</span>
</span><span id="Bar1D-411"><a href="#Bar1D-411"><span class="linenos">411</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1D-412"><a href="#Bar1D-412"><span class="linenos">412</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Currently needs to be fixed to work with 2D&#39;</span><span class="p">)</span>
</span><span id="Bar1D-413"><a href="#Bar1D-413"><span class="linenos">413</span></a>        <span class="n">sh</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span>
</span><span id="Bar1D-414"><a href="#Bar1D-414"><span class="linenos">414</span></a>        <span class="n">shstim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Bar1D-415"><a href="#Bar1D-415"><span class="linenos">415</span></a>        <span class="k">if</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1D-416"><a href="#Bar1D-416"><span class="linenos">416</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="o">-</span><span class="n">sh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="p">:</span><span class="n">sh</span><span class="p">]</span>
</span><span id="Bar1D-417"><a href="#Bar1D-417"><span class="linenos">417</span></a>        <span class="k">elif</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1D-418"><a href="#Bar1D-418"><span class="linenos">418</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="n">sh</span><span class="p">:]</span>
</span><span id="Bar1D-419"><a href="#Bar1D-419"><span class="linenos">419</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1D-420"><a href="#Bar1D-420"><span class="linenos">420</span></a>            <span class="n">shstim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="Bar1D-421"><a href="#Bar1D-421"><span class="linenos">421</span></a>
</span><span id="Bar1D-422"><a href="#Bar1D-422"><span class="linenos">422</span></a>        <span class="k">return</span> <span class="n">shstim</span>
</span><span id="Bar1D-423"><a href="#Bar1D-423"><span class="linenos">423</span></a>    <span class="c1"># END .shift_stim_fixation</span>
</span><span id="Bar1D-424"><a href="#Bar1D-424"><span class="linenos">424</span></a>
</span><span id="Bar1D-425"><a href="#Bar1D-425"><span class="linenos">425</span></a>    <span class="k">def</span> <span class="nf">create_valid_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post_sacc_gap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Bar1D-426"><a href="#Bar1D-426"><span class="linenos">426</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1D-427"><a href="#Bar1D-427"><span class="linenos">427</span></a><span class="sd">        This creates self.valid_inds vector that is used for __get_item__ </span>
</span><span id="Bar1D-428"><a href="#Bar1D-428"><span class="linenos">428</span></a><span class="sd">        -- Will default to num_lags following each saccade beginning</span>
</span><span id="Bar1D-429"><a href="#Bar1D-429"><span class="linenos">429</span></a><span class="sd">        </span>
</span><span id="Bar1D-430"><a href="#Bar1D-430"><span class="linenos">430</span></a><span class="sd">        Args:</span>
</span><span id="Bar1D-431"><a href="#Bar1D-431"><span class="linenos">431</span></a><span class="sd">            post_sacc_gap: number of lags to ignore following each saccade</span>
</span><span id="Bar1D-432"><a href="#Bar1D-432"><span class="linenos">432</span></a>
</span><span id="Bar1D-433"><a href="#Bar1D-433"><span class="linenos">433</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1D-434"><a href="#Bar1D-434"><span class="linenos">434</span></a><span class="sd">            None: sets self.valid_inds</span>
</span><span id="Bar1D-435"><a href="#Bar1D-435"><span class="linenos">435</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1D-436"><a href="#Bar1D-436"><span class="linenos">436</span></a>
</span><span id="Bar1D-437"><a href="#Bar1D-437"><span class="linenos">437</span></a>        <span class="k">if</span> <span class="n">post_sacc_gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1D-438"><a href="#Bar1D-438"><span class="linenos">438</span></a>            <span class="n">post_sacc_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="Bar1D-439"><a href="#Bar1D-439"><span class="linenos">439</span></a>
</span><span id="Bar1D-440"><a href="#Bar1D-440"><span class="linenos">440</span></a>        <span class="c1"># first, throw out all data where all data_filters are zero</span>
</span><span id="Bar1D-441"><a href="#Bar1D-441"><span class="linenos">441</span></a>        <span class="n">is_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="Bar1D-442"><a href="#Bar1D-442"><span class="linenos">442</span></a>        <span class="n">is_valid</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Bar1D-443"><a href="#Bar1D-443"><span class="linenos">443</span></a>        
</span><span id="Bar1D-444"><a href="#Bar1D-444"><span class="linenos">444</span></a>        <span class="c1"># Now invalid post_sacc_gap following saccades</span>
</span><span id="Bar1D-445"><a href="#Bar1D-445"><span class="linenos">445</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span><span class="p">):</span>
</span><span id="Bar1D-446"><a href="#Bar1D-446"><span class="linenos">446</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:])</span>
</span><span id="Bar1D-447"><a href="#Bar1D-447"><span class="linenos">447</span></a>            <span class="n">sts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="Bar1D-448"><a href="#Bar1D-448"><span class="linenos">448</span></a>            <span class="n">is_valid</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">post_sacc_gap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1D-449"><a href="#Bar1D-449"><span class="linenos">449</span></a>        
</span><span id="Bar1D-450"><a href="#Bar1D-450"><span class="linenos">450</span></a>        <span class="c1">#self.valid_inds = list(np.where(is_valid &gt; 0)[0])</span>
</span><span id="Bar1D-451"><a href="#Bar1D-451"><span class="linenos">451</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_valid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D-452"><a href="#Bar1D-452"><span class="linenos">452</span></a>    <span class="c1"># END .create_valid_indices</span>
</span><span id="Bar1D-453"><a href="#Bar1D-453"><span class="linenos">453</span></a>
</span><span id="Bar1D-454"><a href="#Bar1D-454"><span class="linenos">454</span></a>    <span class="k">def</span> <span class="nf">crossval_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test_set</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Bar1D-455"><a href="#Bar1D-455"><span class="linenos">455</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1D-456"><a href="#Bar1D-456"><span class="linenos">456</span></a><span class="sd">        This sets the cross-validation indices up We can add featuers here. Many ways to do this</span>
</span><span id="Bar1D-457"><a href="#Bar1D-457"><span class="linenos">457</span></a><span class="sd">        but will stick to some standard for now. It sets the internal indices, which can be read out</span>
</span><span id="Bar1D-458"><a href="#Bar1D-458"><span class="linenos">458</span></a><span class="sd">        directly or with helper functions. Perhaps helper_functions is the best way....</span>
</span><span id="Bar1D-459"><a href="#Bar1D-459"><span class="linenos">459</span></a><span class="sd">        </span>
</span><span id="Bar1D-460"><a href="#Bar1D-460"><span class="linenos">460</span></a><span class="sd">        Args: </span>
</span><span id="Bar1D-461"><a href="#Bar1D-461"><span class="linenos">461</span></a><span class="sd">            folds: number of folds to partition data into</span>
</span><span id="Bar1D-462"><a href="#Bar1D-462"><span class="linenos">462</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="Bar1D-463"><a href="#Bar1D-463"><span class="linenos">463</span></a><span class="sd">            test_set: whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</span>
</span><span id="Bar1D-464"><a href="#Bar1D-464"><span class="linenos">464</span></a><span class="sd">            verbose: whether to print out information about the partitioning</span>
</span><span id="Bar1D-465"><a href="#Bar1D-465"><span class="linenos">465</span></a>
</span><span id="Bar1D-466"><a href="#Bar1D-466"><span class="linenos">466</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1D-467"><a href="#Bar1D-467"><span class="linenos">467</span></a><span class="sd">            None: sets internal variables test_inds, train_inds, val_inds</span>
</span><span id="Bar1D-468"><a href="#Bar1D-468"><span class="linenos">468</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1D-469"><a href="#Bar1D-469"><span class="linenos">469</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must first specify valid_indices before setting up cross-validation.&quot;</span>
</span><span id="Bar1D-470"><a href="#Bar1D-470"><span class="linenos">470</span></a>
</span><span id="Bar1D-471"><a href="#Bar1D-471"><span class="linenos">471</span></a>        <span class="c1"># Partition data by saccades, and then associate indices with each</span>
</span><span id="Bar1D-472"><a href="#Bar1D-472"><span class="linenos">472</span></a>        <span class="n">te_fixes</span><span class="p">,</span> <span class="n">tr_fixes</span><span class="p">,</span> <span class="n">val_fixes</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="Bar1D-473"><a href="#Bar1D-473"><span class="linenos">473</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixation_grouping</span><span class="p">)):</span>  <span class="c1"># Loops across experiments</span>
</span><span id="Bar1D-474"><a href="#Bar1D-474"><span class="linenos">474</span></a>            <span class="n">fixations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixation_grouping</span><span class="p">[</span><span class="n">ee</span><span class="p">])</span>  <span class="c1"># fixations associated with each experiment</span>
</span><span id="Bar1D-475"><a href="#Bar1D-475"><span class="linenos">475</span></a>            <span class="n">val_fix1</span><span class="p">,</span> <span class="n">tr_fix1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fixations</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="Bar1D-476"><a href="#Bar1D-476"><span class="linenos">476</span></a>            <span class="k">if</span> <span class="n">test_set</span><span class="p">:</span>
</span><span id="Bar1D-477"><a href="#Bar1D-477"><span class="linenos">477</span></a>                <span class="n">te_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">val_fix1</span><span class="p">])</span>
</span><span id="Bar1D-478"><a href="#Bar1D-478"><span class="linenos">478</span></a>                <span class="n">val_fix2</span><span class="p">,</span> <span class="n">tr_fix2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_fix1</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="Bar1D-479"><a href="#Bar1D-479"><span class="linenos">479</span></a>                <span class="n">val_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">tr_fix1</span><span class="p">[</span><span class="n">val_fix2</span><span class="p">]])</span>
</span><span id="Bar1D-480"><a href="#Bar1D-480"><span class="linenos">480</span></a>                <span class="n">tr_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">tr_fix1</span><span class="p">[</span><span class="n">tr_fix2</span><span class="p">]])</span>
</span><span id="Bar1D-481"><a href="#Bar1D-481"><span class="linenos">481</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1D-482"><a href="#Bar1D-482"><span class="linenos">482</span></a>                <span class="n">val_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">val_fix1</span><span class="p">])</span>
</span><span id="Bar1D-483"><a href="#Bar1D-483"><span class="linenos">483</span></a>                <span class="n">tr_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">tr_fix1</span><span class="p">])</span>
</span><span id="Bar1D-484"><a href="#Bar1D-484"><span class="linenos">484</span></a>
</span><span id="Bar1D-485"><a href="#Bar1D-485"><span class="linenos">485</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Bar1D-486"><a href="#Bar1D-486"><span class="linenos">486</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Partitioned </span><span class="si">%d</span><span class="s2"> fixations total: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span>
</span><span id="Bar1D-487"><a href="#Bar1D-487"><span class="linenos">487</span></a>                <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">te_fixes</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_fixes</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">val_fixes</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_fixes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_fixes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">te_fixes</span><span class="p">)))</span>  
</span><span id="Bar1D-488"><a href="#Bar1D-488"><span class="linenos">488</span></a>
</span><span id="Bar1D-489"><a href="#Bar1D-489"><span class="linenos">489</span></a>        <span class="c1"># Now pull  indices from each saccade </span>
</span><span id="Bar1D-490"><a href="#Bar1D-490"><span class="linenos">490</span></a>        <span class="n">tr_inds</span><span class="p">,</span> <span class="n">te_inds</span><span class="p">,</span> <span class="n">val_inds</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="Bar1D-491"><a href="#Bar1D-491"><span class="linenos">491</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">tr_fixes</span><span class="p">:</span>
</span><span id="Bar1D-492"><a href="#Bar1D-492"><span class="linenos">492</span></a>            <span class="n">tr_inds</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Bar1D-493"><a href="#Bar1D-493"><span class="linenos">493</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">val_fixes</span><span class="p">:</span>
</span><span id="Bar1D-494"><a href="#Bar1D-494"><span class="linenos">494</span></a>            <span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Bar1D-495"><a href="#Bar1D-495"><span class="linenos">495</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">te_fixes</span><span class="p">:</span>
</span><span id="Bar1D-496"><a href="#Bar1D-496"><span class="linenos">496</span></a>            <span class="n">te_inds</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Bar1D-497"><a href="#Bar1D-497"><span class="linenos">497</span></a>
</span><span id="Bar1D-498"><a href="#Bar1D-498"><span class="linenos">498</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Bar1D-499"><a href="#Bar1D-499"><span class="linenos">499</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Pre-valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">te_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="Bar1D-500"><a href="#Bar1D-500"><span class="linenos">500</span></a>
</span><span id="Bar1D-501"><a href="#Bar1D-501"><span class="linenos">501</span></a>        <span class="c1"># Finally intersect with valid indices</span>
</span><span id="Bar1D-502"><a href="#Bar1D-502"><span class="linenos">502</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">)))</span>
</span><span id="Bar1D-503"><a href="#Bar1D-503"><span class="linenos">503</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">val_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">)))</span>
</span><span id="Bar1D-504"><a href="#Bar1D-504"><span class="linenos">504</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">te_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">)))</span>
</span><span id="Bar1D-505"><a href="#Bar1D-505"><span class="linenos">505</span></a>
</span><span id="Bar1D-506"><a href="#Bar1D-506"><span class="linenos">506</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Bar1D-507"><a href="#Bar1D-507"><span class="linenos">507</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="Bar1D-508"><a href="#Bar1D-508"><span class="linenos">508</span></a>
</span><span id="Bar1D-509"><a href="#Bar1D-509"><span class="linenos">509</span></a>    <span class="c1"># END MultiDatasetFix.crossval_setup</span>
</span><span id="Bar1D-510"><a href="#Bar1D-510"><span class="linenos">510</span></a>
</span><span id="Bar1D-511"><a href="#Bar1D-511"><span class="linenos">511</span></a>    <span class="k">def</span> <span class="nf">fold_sample</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Bar1D-512"><a href="#Bar1D-512"><span class="linenos">512</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1D-513"><a href="#Bar1D-513"><span class="linenos">513</span></a><span class="sd">        This really should be a general method not associated with self.</span>
</span><span id="Bar1D-514"><a href="#Bar1D-514"><span class="linenos">514</span></a><span class="sd">        </span>
</span><span id="Bar1D-515"><a href="#Bar1D-515"><span class="linenos">515</span></a><span class="sd">        Args:</span>
</span><span id="Bar1D-516"><a href="#Bar1D-516"><span class="linenos">516</span></a><span class="sd">            num_items: number of items to partition</span>
</span><span id="Bar1D-517"><a href="#Bar1D-517"><span class="linenos">517</span></a><span class="sd">            folds: number of folds to partition into</span>
</span><span id="Bar1D-518"><a href="#Bar1D-518"><span class="linenos">518</span></a><span class="sd">            random_gen: whether to randomly partition or not</span>
</span><span id="Bar1D-519"><a href="#Bar1D-519"><span class="linenos">519</span></a>
</span><span id="Bar1D-520"><a href="#Bar1D-520"><span class="linenos">520</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1D-521"><a href="#Bar1D-521"><span class="linenos">521</span></a><span class="sd">            val_items: indices of items to be used for validation</span>
</span><span id="Bar1D-522"><a href="#Bar1D-522"><span class="linenos">522</span></a><span class="sd">            rem_items: indices of items to be used for remainder</span>
</span><span id="Bar1D-523"><a href="#Bar1D-523"><span class="linenos">523</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1D-524"><a href="#Bar1D-524"><span class="linenos">524</span></a>        <span class="k">if</span> <span class="n">random_gen</span><span class="p">:</span>
</span><span id="Bar1D-525"><a href="#Bar1D-525"><span class="linenos">525</span></a>            <span class="n">num_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_items</span><span class="o">/</span><span class="n">folds</span><span class="p">)</span>
</span><span id="Bar1D-526"><a href="#Bar1D-526"><span class="linenos">526</span></a>            <span class="n">tmp_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">num_items</span><span class="p">)</span>
</span><span id="Bar1D-527"><a href="#Bar1D-527"><span class="linenos">527</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[:</span><span class="n">num_val</span><span class="p">])</span>
</span><span id="Bar1D-528"><a href="#Bar1D-528"><span class="linenos">528</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[</span><span class="n">num_val</span><span class="p">:])</span>
</span><span id="Bar1D-529"><a href="#Bar1D-529"><span class="linenos">529</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1D-530"><a href="#Bar1D-530"><span class="linenos">530</span></a>            <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">folds</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="Bar1D-531"><a href="#Bar1D-531"><span class="linenos">531</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
</span><span id="Bar1D-532"><a href="#Bar1D-532"><span class="linenos">532</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">),</span> <span class="n">val_items</span><span class="p">)</span>
</span><span id="Bar1D-533"><a href="#Bar1D-533"><span class="linenos">533</span></a>        <span class="k">return</span> <span class="n">val_items</span><span class="p">,</span> <span class="n">rem_items</span>
</span><span id="Bar1D-534"><a href="#Bar1D-534"><span class="linenos">534</span></a>
</span><span id="Bar1D-535"><a href="#Bar1D-535"><span class="linenos">535</span></a>    <span class="k">def</span> <span class="nf">get_max_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpu_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nquad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mf">1.2</span><span class="p">):</span>
</span><span id="Bar1D-536"><a href="#Bar1D-536"><span class="linenos">536</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1D-537"><a href="#Bar1D-537"><span class="linenos">537</span></a><span class="sd">        get the maximum number of samples that fit in memory -- for GLM/GQM x LBFGS</span>
</span><span id="Bar1D-538"><a href="#Bar1D-538"><span class="linenos">538</span></a>
</span><span id="Bar1D-539"><a href="#Bar1D-539"><span class="linenos">539</span></a><span class="sd">        Args:</span>
</span><span id="Bar1D-540"><a href="#Bar1D-540"><span class="linenos">540</span></a><span class="sd">            dataset: the dataset to get the samples from</span>
</span><span id="Bar1D-541"><a href="#Bar1D-541"><span class="linenos">541</span></a><span class="sd">            device: the device to put the samples on</span>
</span><span id="Bar1D-542"><a href="#Bar1D-542"><span class="linenos">542</span></a>
</span><span id="Bar1D-543"><a href="#Bar1D-543"><span class="linenos">543</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1D-544"><a href="#Bar1D-544"><span class="linenos">544</span></a><span class="sd">            maxsamples: the maximum number of samples that can fit on the device</span>
</span><span id="Bar1D-545"><a href="#Bar1D-545"><span class="linenos">545</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1D-546"><a href="#Bar1D-546"><span class="linenos">546</span></a>        <span class="k">if</span> <span class="n">gpu_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1D-547"><a href="#Bar1D-547"><span class="linenos">547</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
</span><span id="Bar1D-548"><a href="#Bar1D-548"><span class="linenos">548</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1D-549"><a href="#Bar1D-549"><span class="linenos">549</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:1&#39;</span><span class="p">)</span>
</span><span id="Bar1D-550"><a href="#Bar1D-550"><span class="linenos">550</span></a>
</span><span id="Bar1D-551"><a href="#Bar1D-551"><span class="linenos">551</span></a>        <span class="k">if</span> <span class="n">num_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1D-552"><a href="#Bar1D-552"><span class="linenos">552</span></a>            <span class="n">num_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span>
</span><span id="Bar1D-553"><a href="#Bar1D-553"><span class="linenos">553</span></a>        
</span><span id="Bar1D-554"><a href="#Bar1D-554"><span class="linenos">554</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">total_memory</span>
</span><span id="Bar1D-555"><a href="#Bar1D-555"><span class="linenos">555</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_reserved</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D-556"><a href="#Bar1D-556"><span class="linenos">556</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_allocated</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D-557"><a href="#Bar1D-557"><span class="linenos">557</span></a>        <span class="n">free</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">r</span><span class="p">)</span>
</span><span id="Bar1D-558"><a href="#Bar1D-558"><span class="linenos">558</span></a>
</span><span id="Bar1D-559"><a href="#Bar1D-559"><span class="linenos">559</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D-560"><a href="#Bar1D-560"><span class="linenos">560</span></a>        <span class="n">mempersample</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span>
</span><span id="Bar1D-561"><a href="#Bar1D-561"><span class="linenos">561</span></a>    
</span><span id="Bar1D-562"><a href="#Bar1D-562"><span class="linenos">562</span></a>        <span class="n">mempercell</span> <span class="o">=</span> <span class="n">mempersample</span> <span class="o">*</span> <span class="p">(</span><span class="n">nquad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">history_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Bar1D-563"><a href="#Bar1D-563"><span class="linenos">563</span></a>        <span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">*</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span>
</span><span id="Bar1D-564"><a href="#Bar1D-564"><span class="linenos">564</span></a>
</span><span id="Bar1D-565"><a href="#Bar1D-565"><span class="linenos">565</span></a>        <span class="n">maxsamples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">free</span> <span class="o">-</span> <span class="n">mempercell</span><span class="o">*</span><span class="n">num_cells</span> <span class="o">-</span> <span class="n">buffer_bytes</span><span class="p">)</span> <span class="o">//</span> <span class="n">mempersample</span>
</span><span id="Bar1D-566"><a href="#Bar1D-566"><span class="linenos">566</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# samples that can fit on device: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxsamples</span><span class="p">))</span>
</span><span id="Bar1D-567"><a href="#Bar1D-567"><span class="linenos">567</span></a>        <span class="k">return</span> <span class="n">maxsamples</span>
</span><span id="Bar1D-568"><a href="#Bar1D-568"><span class="linenos">568</span></a>    <span class="c1"># END .get_max_samples</span>
</span><span id="Bar1D-569"><a href="#Bar1D-569"><span class="linenos">569</span></a>
</span><span id="Bar1D-570"><a href="#Bar1D-570"><span class="linenos">570</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="Bar1D-571"><a href="#Bar1D-571"><span class="linenos">571</span></a>        
</span><span id="Bar1D-572"><a href="#Bar1D-572"><span class="linenos">572</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="Bar1D-573"><a href="#Bar1D-573"><span class="linenos">573</span></a>
</span><span id="Bar1D-574"><a href="#Bar1D-574"><span class="linenos">574</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Bar1D-575"><a href="#Bar1D-575"><span class="linenos">575</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;get_item time embedding not implemented yet&quot;</span><span class="p">)</span>
</span><span id="Bar1D-576"><a href="#Bar1D-576"><span class="linenos">576</span></a>                <span class="c1"># if self.folded_lags:</span>
</span><span id="Bar1D-577"><a href="#Bar1D-577"><span class="linenos">577</span></a>                <span class="c1">#    stim = np.transpose( tmp_stim, axes=[0,2,1,3,4] ) </span>
</span><span id="Bar1D-578"><a href="#Bar1D-578"><span class="linenos">578</span></a>                <span class="c1">#else:</span>
</span><span id="Bar1D-579"><a href="#Bar1D-579"><span class="linenos">579</span></a>                <span class="c1">#    stim = np.transpose( tmp_stim, axes=[0,2,3,4,1] )</span>
</span><span id="Bar1D-580"><a href="#Bar1D-580"><span class="linenos">580</span></a>    
</span><span id="Bar1D-581"><a href="#Bar1D-581"><span class="linenos">581</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1D-582"><a href="#Bar1D-582"><span class="linenos">582</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1D-583"><a href="#Bar1D-583"><span class="linenos">583</span></a>                    <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Bar1D-584"><a href="#Bar1D-584"><span class="linenos">584</span></a>                        <span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>  <span class="c1"># one stim has to be called stim </span>
</span><span id="Bar1D-585"><a href="#Bar1D-585"><span class="linenos">585</span></a>                        <span class="s1">&#39;stimV&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="Bar1D-586"><a href="#Bar1D-586"><span class="linenos">586</span></a>                        <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="Bar1D-587"><a href="#Bar1D-587"><span class="linenos">587</span></a>                        <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="Bar1D-588"><a href="#Bar1D-588"><span class="linenos">588</span></a>                        <span class="s1">&#39;fix_n&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">[</span><span class="n">idx</span><span class="p">]}</span>
</span><span id="Bar1D-589"><a href="#Bar1D-589"><span class="linenos">589</span></a>                        <span class="c1"># missing saccade timing vector -- not specified</span>
</span><span id="Bar1D-590"><a href="#Bar1D-590"><span class="linenos">590</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1D-591"><a href="#Bar1D-591"><span class="linenos">591</span></a>                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s1">&#39;cells_out must be a list&#39;</span>
</span><span id="Bar1D-592"><a href="#Bar1D-592"><span class="linenos">592</span></a>                    <span class="n">robs_tmp</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="Bar1D-593"><a href="#Bar1D-593"><span class="linenos">593</span></a>                    <span class="n">dfs_tmp</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span>
</span><span id="Bar1D-594"><a href="#Bar1D-594"><span class="linenos">594</span></a>                    <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Bar1D-595"><a href="#Bar1D-595"><span class="linenos">595</span></a>                        <span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="Bar1D-596"><a href="#Bar1D-596"><span class="linenos">596</span></a>                        <span class="s1">&#39;stimV&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="Bar1D-597"><a href="#Bar1D-597"><span class="linenos">597</span></a>                        <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="n">robs_tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="Bar1D-598"><a href="#Bar1D-598"><span class="linenos">598</span></a>                        <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="n">dfs_tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="Bar1D-599"><a href="#Bar1D-599"><span class="linenos">599</span></a>                        <span class="s1">&#39;fix_n&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">[</span><span class="n">idx</span><span class="p">]}</span>
</span><span id="Bar1D-600"><a href="#Bar1D-600"><span class="linenos">600</span></a>            
</span><span id="Bar1D-601"><a href="#Bar1D-601"><span class="linenos">601</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1D-602"><a href="#Bar1D-602"><span class="linenos">602</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="Bar1D-603"><a href="#Bar1D-603"><span class="linenos">603</span></a>            <span class="n">stim</span><span class="p">,</span> <span class="n">stimV</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="Bar1D-604"><a href="#Bar1D-604"><span class="linenos">604</span></a>            <span class="n">robs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D-605"><a href="#Bar1D-605"><span class="linenos">605</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D-606"><a href="#Bar1D-606"><span class="linenos">606</span></a>            <span class="n">num_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Bar1D-607"><a href="#Bar1D-607"><span class="linenos">607</span></a>
</span><span id="Bar1D-608"><a href="#Bar1D-608"><span class="linenos">608</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Stim &quot;&quot;&quot;</span>
</span><span id="Bar1D-609"><a href="#Bar1D-609"><span class="linenos">609</span></a>            <span class="c1"># need file handle</span>
</span><span id="Bar1D-610"><a href="#Bar1D-610"><span class="linenos">610</span></a>            <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1D-611"><a href="#Bar1D-611"><span class="linenos">611</span></a>            <span class="c1">#f = self.file_index[inds]  # problem is this could span across several files</span>
</span><span id="Bar1D-612"><a href="#Bar1D-612"><span class="linenos">612</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NOT DONE YET&quot;</span><span class="p">)</span>
</span><span id="Bar1D-613"><a href="#Bar1D-613"><span class="linenos">613</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">stimname</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D-614"><a href="#Bar1D-614"><span class="linenos">614</span></a>            <span class="c1"># reshape and flatten stim: currently its NT x NX x NY x Nclrs</span>
</span><span id="Bar1D-615"><a href="#Bar1D-615"><span class="linenos">615</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">permute</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">])</span>
</span><span id="Bar1D-616"><a href="#Bar1D-616"><span class="linenos">616</span></a><span class="w">                </span>
</span><span id="Bar1D-617"><a href="#Bar1D-617"><span class="linenos">617</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Spikes: needs padding so all are B x NC &quot;&quot;&quot;</span> 
</span><span id="Bar1D-618"><a href="#Bar1D-618"><span class="linenos">618</span></a>            <span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;Robs&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D-619"><a href="#Bar1D-619"><span class="linenos">619</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="Bar1D-620"><a href="#Bar1D-620"><span class="linenos">620</span></a>                <span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="Bar1D-621"><a href="#Bar1D-621"><span class="linenos">621</span></a>                    <span class="p">(</span><span class="n">robs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span> 
</span><span id="Bar1D-622"><a href="#Bar1D-622"><span class="linenos">622</span></a>                    <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Bar1D-623"><a href="#Bar1D-623"><span class="linenos">623</span></a>
</span><span id="Bar1D-624"><a href="#Bar1D-624"><span class="linenos">624</span></a><span class="w">                </span><span class="sd">&quot;&quot;&quot; Datafilters: needs padding like robs &quot;&quot;&quot;</span>
</span><span id="Bar1D-625"><a href="#Bar1D-625"><span class="linenos">625</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;DFs&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D-626"><a href="#Bar1D-626"><span class="linenos">626</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="Bar1D-627"><a href="#Bar1D-627"><span class="linenos">627</span></a>                <span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="Bar1D-628"><a href="#Bar1D-628"><span class="linenos">628</span></a>                    <span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;DFsMU&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span>
</span><span id="Bar1D-629"><a href="#Bar1D-629"><span class="linenos">629</span></a>                    <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Bar1D-630"><a href="#Bar1D-630"><span class="linenos">630</span></a>
</span><span id="Bar1D-631"><a href="#Bar1D-631"><span class="linenos">631</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="n">stim</span><span class="p">,</span> <span class="s1">&#39;stimV&#39;</span><span class="p">:</span> <span class="n">stimV</span><span class="p">,</span> <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="n">robs</span><span class="p">,</span> <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="n">dfs</span><span class="p">,</span> <span class="s1">&#39;fix_n&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">[</span><span class="n">inds</span><span class="p">]}</span>
</span><span id="Bar1D-632"><a href="#Bar1D-632"><span class="linenos">632</span></a>
</span><span id="Bar1D-633"><a href="#Bar1D-633"><span class="linenos">633</span></a>        <span class="k">return</span> <span class="n">out</span>                
</span><span id="Bar1D-634"><a href="#Bar1D-634"><span class="linenos">634</span></a>
</span><span id="Bar1D-635"><a href="#Bar1D-635"><span class="linenos">635</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Bar1D-636"><a href="#Bar1D-636"><span class="linenos">636</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>-- can load batches from multiple datasets
-- hdf5 files must have the following information:
    Robs
    RobsMU
    stim: 4-d stimulus: time x nx x ny x color
    block_inds: start and stop of 'trials' (perhaps fixations for now)
    other things: saccades? or should that be in trials? </p>

<p>Constructor will take eye position, which for now is an input from data
generated in the session (not on disk). It should have the length size 
of the total number of fixations x1.</p>
</div>


                            <div id="Bar1D.__init__" class="classattr">
                                        <input id="Bar1D.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Bar1D</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">sess_list</span>,</span><span class="param">	<span class="n">datadir</span>,</span><span class="param">	<span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span>,</span><span class="param">	<span class="n">stim_crop</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">time_embed</span><span class="o">=</span><span class="mi">2</span>,</span><span class="param">	<span class="n">folded_lags</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">ignore_saccades</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">include_MUs</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">preload</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">eyepos</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span></span>)</span>

                <label class="view-source-button" for="Bar1D.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1D.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1D.__init__-30"><a href="#Bar1D.__init__-30"><span class="linenos"> 30</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="Bar1D.__init__-31"><a href="#Bar1D.__init__-31"><span class="linenos"> 31</span></a>        <span class="n">sess_list</span><span class="p">,</span>
</span><span id="Bar1D.__init__-32"><a href="#Bar1D.__init__-32"><span class="linenos"> 32</span></a>        <span class="n">datadir</span><span class="p">,</span> 
</span><span id="Bar1D.__init__-33"><a href="#Bar1D.__init__-33"><span class="linenos"> 33</span></a>        <span class="c1"># Stim setup</span>
</span><span id="Bar1D.__init__-34"><a href="#Bar1D.__init__-34"><span class="linenos"> 34</span></a>        <span class="n">num_lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
</span><span id="Bar1D.__init__-35"><a href="#Bar1D.__init__-35"><span class="linenos"> 35</span></a>        <span class="c1">#which_stim = &#39;stimET&#39;,</span>
</span><span id="Bar1D.__init__-36"><a href="#Bar1D.__init__-36"><span class="linenos"> 36</span></a>        <span class="n">stim_crop</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Bar1D.__init__-37"><a href="#Bar1D.__init__-37"><span class="linenos"> 37</span></a>        <span class="n">time_embed</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="Bar1D.__init__-38"><a href="#Bar1D.__init__-38"><span class="linenos"> 38</span></a>        <span class="n">folded_lags</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
</span><span id="Bar1D.__init__-39"><a href="#Bar1D.__init__-39"><span class="linenos"> 39</span></a>        <span class="c1">#luminance_only=True,</span>
</span><span id="Bar1D.__init__-40"><a href="#Bar1D.__init__-40"><span class="linenos"> 40</span></a>        <span class="c1"># other</span>
</span><span id="Bar1D.__init__-41"><a href="#Bar1D.__init__-41"><span class="linenos"> 41</span></a>        <span class="n">ignore_saccades</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Bar1D.__init__-42"><a href="#Bar1D.__init__-42"><span class="linenos"> 42</span></a>        <span class="n">include_MUs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Bar1D.__init__-43"><a href="#Bar1D.__init__-43"><span class="linenos"> 43</span></a>        <span class="n">preload</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Bar1D.__init__-44"><a href="#Bar1D.__init__-44"><span class="linenos"> 44</span></a>        <span class="n">eyepos</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="Bar1D.__init__-45"><a href="#Bar1D.__init__-45"><span class="linenos"> 45</span></a>        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
</span><span id="Bar1D.__init__-46"><a href="#Bar1D.__init__-46"><span class="linenos"> 46</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1D.__init__-47"><a href="#Bar1D.__init__-47"><span class="linenos"> 47</span></a><span class="sd">        Constructor options.</span>
</span><span id="Bar1D.__init__-48"><a href="#Bar1D.__init__-48"><span class="linenos"> 48</span></a>
</span><span id="Bar1D.__init__-49"><a href="#Bar1D.__init__-49"><span class="linenos"> 49</span></a><span class="sd">        Args:</span>
</span><span id="Bar1D.__init__-50"><a href="#Bar1D.__init__-50"><span class="linenos"> 50</span></a><span class="sd">            sess_list: list of strings of session names</span>
</span><span id="Bar1D.__init__-51"><a href="#Bar1D.__init__-51"><span class="linenos"> 51</span></a><span class="sd">            datadir: directory where data is stored</span>
</span><span id="Bar1D.__init__-52"><a href="#Bar1D.__init__-52"><span class="linenos"> 52</span></a><span class="sd">            num_lags: number of lags to include in stimulus</span>
</span><span id="Bar1D.__init__-53"><a href="#Bar1D.__init__-53"><span class="linenos"> 53</span></a><span class="sd">            stim_crop: cropping of stimulus</span>
</span><span id="Bar1D.__init__-54"><a href="#Bar1D.__init__-54"><span class="linenos"> 54</span></a><span class="sd">            time_embed: 0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</span>
</span><span id="Bar1D.__init__-55"><a href="#Bar1D.__init__-55"><span class="linenos"> 55</span></a><span class="sd">            folded_lags: whether to fold lags into channel dimension</span>
</span><span id="Bar1D.__init__-56"><a href="#Bar1D.__init__-56"><span class="linenos"> 56</span></a><span class="sd">            ignore_saccades: whether to ignore saccades in the data</span>
</span><span id="Bar1D.__init__-57"><a href="#Bar1D.__init__-57"><span class="linenos"> 57</span></a><span class="sd">            include_MUs: whether to include multi-units in the data</span>
</span><span id="Bar1D.__init__-58"><a href="#Bar1D.__init__-58"><span class="linenos"> 58</span></a><span class="sd">            preload: whether to preload data into memory</span>
</span><span id="Bar1D.__init__-59"><a href="#Bar1D.__init__-59"><span class="linenos"> 59</span></a><span class="sd">            eyepos: eye position data</span>
</span><span id="Bar1D.__init__-60"><a href="#Bar1D.__init__-60"><span class="linenos"> 60</span></a><span class="sd">            device: device to put data on</span>
</span><span id="Bar1D.__init__-61"><a href="#Bar1D.__init__-61"><span class="linenos"> 61</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1D.__init__-62"><a href="#Bar1D.__init__-62"><span class="linenos"> 62</span></a>
</span><span id="Bar1D.__init__-63"><a href="#Bar1D.__init__-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">datadir</span>
</span><span id="Bar1D.__init__-64"><a href="#Bar1D.__init__-64"><span class="linenos"> 64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sess_list</span> <span class="o">=</span> <span class="n">sess_list</span>
</span><span id="Bar1D.__init__-65"><a href="#Bar1D.__init__-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
</span><span id="Bar1D.__init__-66"><a href="#Bar1D.__init__-66"><span class="linenos"> 66</span></a>        
</span><span id="Bar1D.__init__-67"><a href="#Bar1D.__init__-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span> <span class="o">=</span> <span class="n">num_lags</span>
</span><span id="Bar1D.__init__-68"><a href="#Bar1D.__init__-68"><span class="linenos"> 68</span></a>        <span class="k">if</span> <span class="n">time_embed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Bar1D.__init__-69"><a href="#Bar1D.__init__-69"><span class="linenos"> 69</span></a>            <span class="k">assert</span> <span class="n">preload</span><span class="p">,</span> <span class="s2">&quot;Cannot pre-time-embed without preloading.&quot;</span>
</span><span id="Bar1D.__init__-70"><a href="#Bar1D.__init__-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">=</span> <span class="n">time_embed</span>
</span><span id="Bar1D.__init__-71"><a href="#Bar1D.__init__-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preload</span> <span class="o">=</span> <span class="n">preload</span>
</span><span id="Bar1D.__init__-72"><a href="#Bar1D.__init__-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="o">=</span> <span class="n">stim_crop</span>
</span><span id="Bar1D.__init__-73"><a href="#Bar1D.__init__-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span> <span class="o">=</span> <span class="n">folded_lags</span>
</span><span id="Bar1D.__init__-74"><a href="#Bar1D.__init__-74"><span class="linenos"> 74</span></a>
</span><span id="Bar1D.__init__-75"><a href="#Bar1D.__init__-75"><span class="linenos"> 75</span></a>        <span class="c1"># get hdf5 file handles</span>
</span><span id="Bar1D.__init__-76"><a href="#Bar1D.__init__-76"><span class="linenos"> 76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">sess</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_list</span><span class="p">]</span>
</span><span id="Bar1D.__init__-77"><a href="#Bar1D.__init__-77"><span class="linenos"> 77</span></a>        
</span><span id="Bar1D.__init__-78"><a href="#Bar1D.__init__-78"><span class="linenos"> 78</span></a>        <span class="c1"># Data to just read in and store</span>
</span><span id="Bar1D.__init__-79"><a href="#Bar1D.__init__-79"><span class="linenos"> 79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ETstim_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ETstim_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Bar1D.__init__-80"><a href="#Bar1D.__init__-80"><span class="linenos"> 80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;fix_location&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D.__init__-81"><a href="#Bar1D.__init__-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probeIDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Robs_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="Bar1D.__init__-82"><a href="#Bar1D.__init__-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probeIDsMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;RobsMU_probe_ID&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D.__init__-83"><a href="#Bar1D.__init__-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dt&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D.__init__-84"><a href="#Bar1D.__init__-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;pixel_size&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D.__init__-85"><a href="#Bar1D.__init__-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exptdate</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># need to learn matlab strings in HDF5 format (not saved as HDF5 string)</span>
</span><span id="Bar1D.__init__-86"><a href="#Bar1D.__init__-86"><span class="linenos"> 86</span></a>
</span><span id="Bar1D.__init__-87"><a href="#Bar1D.__init__-87"><span class="linenos"> 87</span></a>        <span class="c1"># build index map</span>
</span><span id="Bar1D.__init__-88"><a href="#Bar1D.__init__-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_threshold</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># how many valid time points required to include saccade?</span>
</span><span id="Bar1D.__init__-89"><a href="#Bar1D.__init__-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_index</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># which file the block corresponds to</span>
</span><span id="Bar1D.__init__-90"><a href="#Bar1D.__init__-90"><span class="linenos"> 90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D.__init__-91"><a href="#Bar1D.__init__-91"><span class="linenos"> 91</span></a>        <span class="c1">#self.unit_ids = []</span>
</span><span id="Bar1D.__init__-92"><a href="#Bar1D.__init__-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_sus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_mus</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="Bar1D.__init__-93"><a href="#Bar1D.__init__-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sus</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D.__init__-94"><a href="#Bar1D.__init__-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">=</span> <span class="mi">0</span>    
</span><span id="Bar1D.__init__-95"><a href="#Bar1D.__init__-95"><span class="linenos"> 95</span></a>        <span class="c1">#self.stim_dims = None</span>
</span><span id="Bar1D.__init__-96"><a href="#Bar1D.__init__-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span> <span class="o">=</span> <span class="n">eyepos</span>
</span><span id="Bar1D.__init__-97"><a href="#Bar1D.__init__-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_Xfix</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Bar1D.__init__-98"><a href="#Bar1D.__init__-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sess_list</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Bar1D.__init__-99"><a href="#Bar1D.__init__-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D.__init__-100"><a href="#Bar1D.__init__-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_filemapping</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D.__init__-101"><a href="#Bar1D.__init__-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span> <span class="o">=</span> <span class="n">include_MUs</span>
</span><span id="Bar1D.__init__-102"><a href="#Bar1D.__init__-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">SUinds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D.__init__-103"><a href="#Bar1D.__init__-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">MUinds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D.__init__-104"><a href="#Bar1D.__init__-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># can be list to output specific cells in get_item</span>
</span><span id="Bar1D.__init__-105"><a href="#Bar1D.__init__-105"><span class="linenos">105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1D.__init__-106"><a href="#Bar1D.__init__-106"><span class="linenos">106</span></a>
</span><span id="Bar1D.__init__-107"><a href="#Bar1D.__init__-107"><span class="linenos">107</span></a>        <span class="c1"># Set up to store default train_, val_, test_inds</span>
</span><span id="Bar1D.__init__-108"><a href="#Bar1D.__init__-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1D.__init__-109"><a href="#Bar1D.__init__-109"><span class="linenos">109</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1D.__init__-110"><a href="#Bar1D.__init__-110"><span class="linenos">110</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Bar1D.__init__-111"><a href="#Bar1D.__init__-111"><span class="linenos">111</span></a>
</span><span id="Bar1D.__init__-112"><a href="#Bar1D.__init__-112"><span class="linenos">112</span></a>        <span class="c1"># Data to construct and store in memory</span>
</span><span id="Bar1D.__init__-113"><a href="#Bar1D.__init__-113"><span class="linenos">113</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D.__init__-114"><a href="#Bar1D.__init__-114"><span class="linenos">114</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_on</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D.__init__-115"><a href="#Bar1D.__init__-115"><span class="linenos">115</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_off</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D.__init__-116"><a href="#Bar1D.__init__-116"><span class="linenos">116</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D.__init__-117"><a href="#Bar1D.__init__-117"><span class="linenos">117</span></a>
</span><span id="Bar1D.__init__-118"><a href="#Bar1D.__init__-118"><span class="linenos">118</span></a>        <span class="n">tcount</span><span class="p">,</span> <span class="n">fix_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="Bar1D.__init__-119"><a href="#Bar1D.__init__-119"><span class="linenos">119</span></a>
</span><span id="Bar1D.__init__-120"><a href="#Bar1D.__init__-120"><span class="linenos">120</span></a>        <span class="c1">#if which_stim is None:</span>
</span><span id="Bar1D.__init__-121"><a href="#Bar1D.__init__-121"><span class="linenos">121</span></a>        <span class="c1">#    stimname = &#39;stimET&#39;</span>
</span><span id="Bar1D.__init__-122"><a href="#Bar1D.__init__-122"><span class="linenos">122</span></a>        <span class="c1">#else:</span>
</span><span id="Bar1D.__init__-123"><a href="#Bar1D.__init__-123"><span class="linenos">123</span></a>        <span class="c1">#    stimname = which_stim</span>
</span><span id="Bar1D.__init__-124"><a href="#Bar1D.__init__-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span> <span class="o">=</span> <span class="s1">&#39;stimET&#39;</span>
</span><span id="Bar1D.__init__-125"><a href="#Bar1D.__init__-125"><span class="linenos">125</span></a>
</span><span id="Bar1D.__init__-126"><a href="#Bar1D.__init__-126"><span class="linenos">126</span></a>        <span class="k">for</span> <span class="n">fnum</span><span class="p">,</span> <span class="n">fhandle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">):</span>
</span><span id="Bar1D.__init__-127"><a href="#Bar1D.__init__-127"><span class="linenos">127</span></a>
</span><span id="Bar1D.__init__-128"><a href="#Bar1D.__init__-128"><span class="linenos">128</span></a>            <span class="n">NT</span><span class="p">,</span> <span class="n">NSUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="Bar1D.__init__-129"><a href="#Bar1D.__init__-129"><span class="linenos">129</span></a>            <span class="n">NX</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimET&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Bar1D.__init__-130"><a href="#Bar1D.__init__-130"><span class="linenos">130</span></a>            <span class="n">NMUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Bar1D.__init__-131"><a href="#Bar1D.__init__-131"><span class="linenos">131</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_sus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NSUfile</span><span class="p">)</span>
</span><span id="Bar1D.__init__-132"><a href="#Bar1D.__init__-132"><span class="linenos">132</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_mus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NMUfile</span><span class="p">)</span>
</span><span id="Bar1D.__init__-133"><a href="#Bar1D.__init__-133"><span class="linenos">133</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sus</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="o">+</span><span class="n">NSUfile</span><span class="p">))</span>
</span><span id="Bar1D.__init__-134"><a href="#Bar1D.__init__-134"><span class="linenos">134</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;block_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span id="Bar1D.__init__-135"><a href="#Bar1D.__init__-135"><span class="linenos">135</span></a>
</span><span id="Bar1D.__init__-136"><a href="#Bar1D.__init__-136"><span class="linenos">136</span></a>            <span class="n">NCfile</span> <span class="o">=</span> <span class="n">NSUfile</span>
</span><span id="Bar1D.__init__-137"><a href="#Bar1D.__init__-137"><span class="linenos">137</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="Bar1D.__init__-138"><a href="#Bar1D.__init__-138"><span class="linenos">138</span></a>                <span class="n">NCfile</span> <span class="o">+=</span> <span class="n">NMUfile</span>
</span><span id="Bar1D.__init__-139"><a href="#Bar1D.__init__-139"><span class="linenos">139</span></a>            
</span><span id="Bar1D.__init__-140"><a href="#Bar1D.__init__-140"><span class="linenos">140</span></a>            <span class="c1"># This will associate each block with each file</span>
</span><span id="Bar1D.__init__-141"><a href="#Bar1D.__init__-141"><span class="linenos">141</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_filemapping</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="n">fnum</span><span class="p">)</span>
</span><span id="Bar1D.__init__-142"><a href="#Bar1D.__init__-142"><span class="linenos">142</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span><span class="p">[</span><span class="n">fnum</span><span class="p">]</span><span class="o">=</span> <span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D.__init__-143"><a href="#Bar1D.__init__-143"><span class="linenos">143</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blks</span><span class="p">[</span><span class="n">fnum</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1D.__init__-144"><a href="#Bar1D.__init__-144"><span class="linenos">144</span></a>            <span class="c1">#if self.stim_dims is None:</span>
</span><span id="Bar1D.__init__-145"><a href="#Bar1D.__init__-145"><span class="linenos">145</span></a>            <span class="c1">#if folded_lags:</span>
</span><span id="Bar1D.__init__-146"><a href="#Bar1D.__init__-146"><span class="linenos">146</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">([</span><span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="c1">#list(fhandle[stimname].shape[1:4]) + [1]</span>
</span><span id="Bar1D.__init__-147"><a href="#Bar1D.__init__-147"><span class="linenos">147</span></a>            <span class="c1">#else:</span>
</span><span id="Bar1D.__init__-148"><a href="#Bar1D.__init__-148"><span class="linenos">148</span></a>            <span class="c1">#    self.dims = list(fhandle[stimname].shape[1:4]) + [1]</span>
</span><span id="Bar1D.__init__-149"><a href="#Bar1D.__init__-149"><span class="linenos">149</span></a>            
</span><span id="Bar1D.__init__-150"><a href="#Bar1D.__init__-150"><span class="linenos">150</span></a>            <span class="c1">#self.luminance_only = luminance_only</span>
</span><span id="Bar1D.__init__-151"><a href="#Bar1D.__init__-151"><span class="linenos">151</span></a>            <span class="c1">#if luminance_only:</span>
</span><span id="Bar1D.__init__-152"><a href="#Bar1D.__init__-152"><span class="linenos">152</span></a>            <span class="c1">#    if self.dims[0] &gt; 1:</span>
</span><span id="Bar1D.__init__-153"><a href="#Bar1D.__init__-153"><span class="linenos">153</span></a>            <span class="c1">#        print(&quot;Reducing stimulus channels (%d) to first dimension&quot;%self.dims[0])</span>
</span><span id="Bar1D.__init__-154"><a href="#Bar1D.__init__-154"><span class="linenos">154</span></a>            <span class="c1">#    self.dims[0] = 1</span>
</span><span id="Bar1D.__init__-155"><a href="#Bar1D.__init__-155"><span class="linenos">155</span></a>            
</span><span id="Bar1D.__init__-156"><a href="#Bar1D.__init__-156"><span class="linenos">156</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1D.__init__-157"><a href="#Bar1D.__init__-157"><span class="linenos">157</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="Bar1D.__init__-158"><a href="#Bar1D.__init__-158"><span class="linenos">158</span></a>
</span><span id="Bar1D.__init__-159"><a href="#Bar1D.__init__-159"><span class="linenos">159</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stim check:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">,</span> <span class="n">folded_lags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</span><span id="Bar1D.__init__-160"><a href="#Bar1D.__init__-160"><span class="linenos">160</span></a>
</span><span id="Bar1D.__init__-161"><a href="#Bar1D.__init__-161"><span class="linenos">161</span></a>            <span class="c1">#self.unit_ids.append(self.NC + np.asarray(range(NCfile)))</span>
</span><span id="Bar1D.__init__-162"><a href="#Bar1D.__init__-162"><span class="linenos">162</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NCfile</span><span class="p">)</span>
</span><span id="Bar1D.__init__-163"><a href="#Bar1D.__init__-163"><span class="linenos">163</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">+=</span> <span class="n">NCfile</span>
</span><span id="Bar1D.__init__-164"><a href="#Bar1D.__init__-164"><span class="linenos">164</span></a>
</span><span id="Bar1D.__init__-165"><a href="#Bar1D.__init__-165"><span class="linenos">165</span></a>            <span class="n">sacc_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;sacc_inds&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="Bar1D.__init__-166"><a href="#Bar1D.__init__-166"><span class="linenos">166</span></a>            <span class="n">fix_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>  <span class="c1"># each time point labels fixation number</span>
</span><span id="Bar1D.__init__-167"><a href="#Bar1D.__init__-167"><span class="linenos">167</span></a>            <span class="n">sacc_on</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># each time point labels fixation number</span>
</span><span id="Bar1D.__init__-168"><a href="#Bar1D.__init__-168"><span class="linenos">168</span></a>            <span class="n">sacc_on</span><span class="p">[</span><span class="n">sacc_inds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="Bar1D.__init__-169"><a href="#Bar1D.__init__-169"><span class="linenos">169</span></a>            <span class="n">sacc_off</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># each time point labels fixation number</span>
</span><span id="Bar1D.__init__-170"><a href="#Bar1D.__init__-170"><span class="linenos">170</span></a>            <span class="n">sacc_off</span><span class="p">[</span><span class="n">sacc_inds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="Bar1D.__init__-171"><a href="#Bar1D.__init__-171"><span class="linenos">171</span></a>
</span><span id="Bar1D.__init__-172"><a href="#Bar1D.__init__-172"><span class="linenos">172</span></a>            <span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;valid_data&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="mi">1</span>  <span class="c1">#range(self.NT)  # default -- to be changed at end of init</span>
</span><span id="Bar1D.__init__-173"><a href="#Bar1D.__init__-173"><span class="linenos">173</span></a>
</span><span id="Bar1D.__init__-174"><a href="#Bar1D.__init__-174"><span class="linenos">174</span></a>            <span class="c1"># Got through each block to segment into fixations</span>
</span><span id="Bar1D.__init__-175"><a href="#Bar1D.__init__-175"><span class="linenos">175</span></a>            <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blk_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="Bar1D.__init__-176"><a href="#Bar1D.__init__-176"><span class="linenos">176</span></a>                <span class="c1"># note this will be the inds in each file -- file offset must be added for mult files</span>
</span><span id="Bar1D.__init__-177"><a href="#Bar1D.__init__-177"><span class="linenos">177</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>
</span><span id="Bar1D.__init__-178"><a href="#Bar1D.__init__-178"><span class="linenos">178</span></a>                <span class="n">t0</span> <span class="o">=</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="Bar1D.__init__-179"><a href="#Bar1D.__init__-179"><span class="linenos">179</span></a>                <span class="c1">#valid_inds[range(t0, t0+num_lags)] = 0  # this already adjusted for?</span>
</span><span id="Bar1D.__init__-180"><a href="#Bar1D.__init__-180"><span class="linenos">180</span></a>
</span><span id="Bar1D.__init__-181"><a href="#Bar1D.__init__-181"><span class="linenos">181</span></a>                <span class="c1"># Parse fixation numbers within block</span>
</span><span id="Bar1D.__init__-182"><a href="#Bar1D.__init__-182"><span class="linenos">182</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_saccades</span><span class="p">:</span>
</span><span id="Bar1D.__init__-183"><a href="#Bar1D.__init__-183"><span class="linenos">183</span></a>                    <span class="n">rel_saccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">sacc_inds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sacc_inds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D.__init__-184"><a href="#Bar1D.__init__-184"><span class="linenos">184</span></a>                    <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel_saccs</span><span class="p">)):</span>
</span><span id="Bar1D.__init__-185"><a href="#Bar1D.__init__-185"><span class="linenos">185</span></a>                        <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Bar1D.__init__-186"><a href="#Bar1D.__init__-186"><span class="linenos">186</span></a>                        <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">sacc_inds</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="Bar1D.__init__-187"><a href="#Bar1D.__init__-187"><span class="linenos">187</span></a>                        <span class="n">t0</span> <span class="o">=</span> <span class="n">sacc_inds</span><span class="p">[</span><span class="n">rel_saccs</span><span class="p">[</span><span class="n">mm</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
</span><span id="Bar1D.__init__-188"><a href="#Bar1D.__init__-188"><span class="linenos">188</span></a>                <span class="c1"># Put in last (or only) fixation number</span>
</span><span id="Bar1D.__init__-189"><a href="#Bar1D.__init__-189"><span class="linenos">189</span></a>                <span class="k">if</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
</span><span id="Bar1D.__init__-190"><a href="#Bar1D.__init__-190"><span class="linenos">190</span></a>                    <span class="n">fix_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Bar1D.__init__-191"><a href="#Bar1D.__init__-191"><span class="linenos">191</span></a>                    <span class="n">fix_n</span><span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">blk_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fix_count</span>
</span><span id="Bar1D.__init__-192"><a href="#Bar1D.__init__-192"><span class="linenos">192</span></a>            
</span><span id="Bar1D.__init__-193"><a href="#Bar1D.__init__-193"><span class="linenos">193</span></a>            <span class="n">tcount</span> <span class="o">+=</span> <span class="n">NT</span>
</span><span id="Bar1D.__init__-194"><a href="#Bar1D.__init__-194"><span class="linenos">194</span></a>            <span class="c1"># make larger fix_n, valid_inds, sacc_inds, block_inds as self</span>
</span><span id="Bar1D.__init__-195"><a href="#Bar1D.__init__-195"><span class="linenos">195</span></a>
</span><span id="Bar1D.__init__-196"><a href="#Bar1D.__init__-196"><span class="linenos">196</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>  <span class="o">=</span> <span class="n">tcount</span>
</span><span id="Bar1D.__init__-197"><a href="#Bar1D.__init__-197"><span class="linenos">197</span></a>
</span><span id="Bar1D.__init__-198"><a href="#Bar1D.__init__-198"><span class="linenos">198</span></a>        <span class="c1"># For now let&#39;s just debug with one file</span>
</span><span id="Bar1D.__init__-199"><a href="#Bar1D.__init__-199"><span class="linenos">199</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sess_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Bar1D.__init__-200"><a href="#Bar1D.__init__-200"><span class="linenos">200</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: currently ignoring multiple files&#39;</span><span class="p">)</span>
</span><span id="Bar1D.__init__-201"><a href="#Bar1D.__init__-201"><span class="linenos">201</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">valid_inds</span><span class="p">)</span>
</span><span id="Bar1D.__init__-202"><a href="#Bar1D.__init__-202"><span class="linenos">202</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">fix_n</span><span class="p">)</span>
</span><span id="Bar1D.__init__-203"><a href="#Bar1D.__init__-203"><span class="linenos">203</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sac_on</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sacc_on</span><span class="p">)</span>
</span><span id="Bar1D.__init__-204"><a href="#Bar1D.__init__-204"><span class="linenos">204</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sac_off</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sacc_off</span><span class="p">)</span>
</span><span id="Bar1D.__init__-205"><a href="#Bar1D.__init__-205"><span class="linenos">205</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sacc_inds</span><span class="p">)</span>
</span><span id="Bar1D.__init__-206"><a href="#Bar1D.__init__-206"><span class="linenos">206</span></a>        
</span><span id="Bar1D.__init__-207"><a href="#Bar1D.__init__-207"><span class="linenos">207</span></a>        <span class="c1"># Go through saccades to establish val_indices and produce saccade timing vector </span>
</span><span id="Bar1D.__init__-208"><a href="#Bar1D.__init__-208"><span class="linenos">208</span></a>        <span class="c1"># Note that sacc_ts will be generated even without preload -- small enough that doesnt matter</span>
</span><span id="Bar1D.__init__-209"><a href="#Bar1D.__init__-209"><span class="linenos">209</span></a>    <span class="c1">#    self.sacc_ts = np.zeros([self.NT, 1], dtype=np.float32)</span>
</span><span id="Bar1D.__init__-210"><a href="#Bar1D.__init__-210"><span class="linenos">210</span></a>    <span class="c1">#    self.fix_n = np.zeros(self.NT, dtype=np.int64)  # label of which fixation is in each range</span>
</span><span id="Bar1D.__init__-211"><a href="#Bar1D.__init__-211"><span class="linenos">211</span></a>    <span class="c1">#    for nn in range(self.num_fixations):</span>
</span><span id="Bar1D.__init__-212"><a href="#Bar1D.__init__-212"><span class="linenos">212</span></a>    <span class="c1">#        print(nn, self.sacc_inds[nn][0], self.sacc_inds[nn][1] )</span>
</span><span id="Bar1D.__init__-213"><a href="#Bar1D.__init__-213"><span class="linenos">213</span></a>    <span class="c1">#        self.sacc_ts[self.sacc_inds[nn][0]] = 1 </span>
</span><span id="Bar1D.__init__-214"><a href="#Bar1D.__init__-214"><span class="linenos">214</span></a>    <span class="c1">#        self.fix_n[range(self.sacc_inds[nn][0], self.sacc_inds[nn][1])] = nn</span>
</span><span id="Bar1D.__init__-215"><a href="#Bar1D.__init__-215"><span class="linenos">215</span></a>        <span class="c1">#self.fix_n = list(self.fix_n)  # better list than numpy</span>
</span><span id="Bar1D.__init__-216"><a href="#Bar1D.__init__-216"><span class="linenos">216</span></a>
</span><span id="Bar1D.__init__-217"><a href="#Bar1D.__init__-217"><span class="linenos">217</span></a>        <span class="c1">#self.dims = np.unique(np.asarray(self.dims)) # assumes they&#39;re all the same    </span>
</span><span id="Bar1D.__init__-218"><a href="#Bar1D.__init__-218"><span class="linenos">218</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1D.__init__-219"><a href="#Bar1D.__init__-219"><span class="linenos">219</span></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span><span class="p">,</span> \
</span><span id="Bar1D.__init__-220"><a href="#Bar1D.__init__-220"><span class="linenos">220</span></a>                <span class="s2">&quot;eyepos input should have </span><span class="si">%d</span><span class="s2"> fixations.&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span>
</span><span id="Bar1D.__init__-221"><a href="#Bar1D.__init__-221"><span class="linenos">221</span></a>
</span><span id="Bar1D.__init__-222"><a href="#Bar1D.__init__-222"><span class="linenos">222</span></a>        <span class="k">if</span> <span class="n">preload</span><span class="p">:</span>
</span><span id="Bar1D.__init__-223"><a href="#Bar1D.__init__-223"><span class="linenos">223</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data into memory...&quot;</span><span class="p">)</span>
</span><span id="Bar1D.__init__-224"><a href="#Bar1D.__init__-224"><span class="linenos">224</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">preload_numpy</span><span class="p">()</span>
</span><span id="Bar1D.__init__-225"><a href="#Bar1D.__init__-225"><span class="linenos">225</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stim shape&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Bar1D.__init__-226"><a href="#Bar1D.__init__-226"><span class="linenos">226</span></a>            <span class="c1"># Note stim is being represented as full 3-d + 1 tensor (time, channels, NX, NY)</span>
</span><span id="Bar1D.__init__-227"><a href="#Bar1D.__init__-227"><span class="linenos">227</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eyepos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1D.__init__-228"><a href="#Bar1D.__init__-228"><span class="linenos">228</span></a>                <span class="c1"># Would want to shift by input eye positions if input here</span>
</span><span id="Bar1D.__init__-229"><a href="#Bar1D.__init__-229"><span class="linenos">229</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;eye-position shifting not implemented yet&#39;</span><span class="p">)</span>
</span><span id="Bar1D.__init__-230"><a href="#Bar1D.__init__-230"><span class="linenos">230</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_crop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1D.__init__-231"><a href="#Bar1D.__init__-231"><span class="linenos">231</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;stimulus cropping not implemented yet&#39;</span><span class="p">)</span>
</span><span id="Bar1D.__init__-232"><a href="#Bar1D.__init__-232"><span class="linenos">232</span></a>
</span><span id="Bar1D.__init__-233"><a href="#Bar1D.__init__-233"><span class="linenos">233</span></a>            <span class="k">if</span> <span class="n">time_embed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Bar1D.__init__-234"><a href="#Bar1D.__init__-234"><span class="linenos">234</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time embedding...&quot;</span><span class="p">)</span>
</span><span id="Bar1D.__init__-235"><a href="#Bar1D.__init__-235"><span class="linenos">235</span></a>                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="Bar1D.__init__-236"><a href="#Bar1D.__init__-236"><span class="linenos">236</span></a>                <span class="n">tmp_stimH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="Bar1D.__init__-237"><a href="#Bar1D.__init__-237"><span class="linenos">237</span></a>                <span class="n">tmp_stimV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_lags</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
</span><span id="Bar1D.__init__-238"><a href="#Bar1D.__init__-238"><span class="linenos">238</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span><span class="p">:</span>
</span><span id="Bar1D.__init__-239"><a href="#Bar1D.__init__-239"><span class="linenos">239</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">tmp_stimH</span>
</span><span id="Bar1D.__init__-240"><a href="#Bar1D.__init__-240"><span class="linenos">240</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">tmp_stimV</span>
</span><span id="Bar1D.__init__-241"><a href="#Bar1D.__init__-241"><span class="linenos">241</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Folded lags: stim-dim = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Bar1D.__init__-242"><a href="#Bar1D.__init__-242"><span class="linenos">242</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1D.__init__-243"><a href="#Bar1D.__init__-243"><span class="linenos">243</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimH</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="Bar1D.__init__-244"><a href="#Bar1D.__init__-244"><span class="linenos">244</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">tmp_stimV</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="Bar1D.__init__-245"><a href="#Bar1D.__init__-245"><span class="linenos">245</span></a>
</span><span id="Bar1D.__init__-246"><a href="#Bar1D.__init__-246"><span class="linenos">246</span></a>            <span class="c1"># now stimulus is represented as full 4-d + 1 tensor (time, channels, NX, NY, num_lags)</span>
</span><span id="Bar1D.__init__-247"><a href="#Bar1D.__init__-247"><span class="linenos">247</span></a>
</span><span id="Bar1D.__init__-248"><a href="#Bar1D.__init__-248"><span class="linenos">248</span></a>            <span class="c1"># Flatten stim </span>
</span><span id="Bar1D.__init__-249"><a href="#Bar1D.__init__-249"><span class="linenos">249</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Bar1D.__init__-250"><a href="#Bar1D.__init__-250"><span class="linenos">250</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Bar1D.__init__-251"><a href="#Bar1D.__init__-251"><span class="linenos">251</span></a>
</span><span id="Bar1D.__init__-252"><a href="#Bar1D.__init__-252"><span class="linenos">252</span></a>            <span class="c1"># Have data_filters represend used_inds (in case it gets through)</span>
</span><span id="Bar1D.__init__-253"><a href="#Bar1D.__init__-253"><span class="linenos">253</span></a>            <span class="n">unified_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D.__init__-254"><a href="#Bar1D.__init__-254"><span class="linenos">254</span></a>            <span class="n">unified_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">used_inds</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="Bar1D.__init__-255"><a href="#Bar1D.__init__-255"><span class="linenos">255</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*=</span> <span class="n">unified_df</span>
</span><span id="Bar1D.__init__-256"><a href="#Bar1D.__init__-256"><span class="linenos">256</span></a>            <span class="c1"># Convert data to tensors</span>
</span><span id="Bar1D.__init__-257"><a href="#Bar1D.__init__-257"><span class="linenos">257</span></a>            <span class="c1">#if self.device is not None:</span>
</span><span id="Bar1D.__init__-258"><a href="#Bar1D.__init__-258"><span class="linenos">258</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D.__init__-259"><a href="#Bar1D.__init__-259"><span class="linenos">259</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span>
</span><span id="Bar1D.__init__-260"><a href="#Bar1D.__init__-260"><span class="linenos">260</span></a>
</span><span id="Bar1D.__init__-261"><a href="#Bar1D.__init__-261"><span class="linenos">261</span></a>        <span class="c1"># Create valid indices and first pass of cross-validation indices</span>
</span><span id="Bar1D.__init__-262"><a href="#Bar1D.__init__-262"><span class="linenos">262</span></a>        <span class="c1">#self.create_valid_indices()</span>
</span><span id="Bar1D.__init__-263"><a href="#Bar1D.__init__-263"><span class="linenos">263</span></a>        <span class="c1"># Develop default train, validation, and test datasets </span>
</span><span id="Bar1D.__init__-264"><a href="#Bar1D.__init__-264"><span class="linenos">264</span></a>        <span class="c1">#self.crossval_setup()</span>
</span><span id="Bar1D.__init__-265"><a href="#Bar1D.__init__-265"><span class="linenos">265</span></a>
</span><span id="Bar1D.__init__-266"><a href="#Bar1D.__init__-266"><span class="linenos">266</span></a>        <span class="c1"># Reflects block structure</span>
</span><span id="Bar1D.__init__-267"><a href="#Bar1D.__init__-267"><span class="linenos">267</span></a>        <span class="n">vblks</span><span class="p">,</span> <span class="n">trblks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Bar1D.__init__-268"><a href="#Bar1D.__init__-268"><span class="linenos">268</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D.__init__-269"><a href="#Bar1D.__init__-269"><span class="linenos">269</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">trblks</span><span class="p">:</span>
</span><span id="Bar1D.__init__-270"><a href="#Bar1D.__init__-270"><span class="linenos">270</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="Bar1D.__init__-271"><a href="#Bar1D.__init__-271"><span class="linenos">271</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Bar1D.__init__-272"><a href="#Bar1D.__init__-272"><span class="linenos">272</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">vblks</span><span class="p">:</span>
</span><span id="Bar1D.__init__-273"><a href="#Bar1D.__init__-273"><span class="linenos">273</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
</span><span id="Bar1D.__init__-274"><a href="#Bar1D.__init__-274"><span class="linenos">274</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="Bar1D.__init__-275"><a href="#Bar1D.__init__-275"><span class="linenos">275</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Constructor options.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>sess_list:</strong>  list of strings of session names</li>
<li><strong>datadir:</strong>  directory where data is stored</li>
<li><strong>num_lags:</strong>  number of lags to include in stimulus</li>
<li><strong>stim_crop:</strong>  cropping of stimulus</li>
<li><strong>time_embed:</strong>  0 is no time embedding, 1 is time_embedding with get_item, 2 is pre-time_embedded</li>
<li><strong>folded_lags:</strong>  whether to fold lags into channel dimension</li>
<li><strong>ignore_saccades:</strong>  whether to ignore saccades in the data</li>
<li><strong>include_MUs:</strong>  whether to include multi-units in the data</li>
<li><strong>preload:</strong>  whether to preload data into memory</li>
<li><strong>eyepos:</strong>  eye position data</li>
<li><strong>device:</strong>  device to put data on</li>
</ul>
</div>


                            </div>
                            <div id="Bar1D.datadir" class="classattr">
                                <div class="attr variable">
            <span class="name">datadir</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.datadir"></a>
    
    

                            </div>
                            <div id="Bar1D.sess_list" class="classattr">
                                <div class="attr variable">
            <span class="name">sess_list</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.sess_list"></a>
    
    

                            </div>
                            <div id="Bar1D.device" class="classattr">
                                <div class="attr variable">
            <span class="name">device</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.device"></a>
    
    

                            </div>
                            <div id="Bar1D.num_lags" class="classattr">
                                <div class="attr variable">
            <span class="name">num_lags</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.num_lags"></a>
    
    

                            </div>
                            <div id="Bar1D.time_embed" class="classattr">
                                <div class="attr variable">
            <span class="name">time_embed</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.time_embed"></a>
    
    

                            </div>
                            <div id="Bar1D.preload" class="classattr">
                                <div class="attr variable">
            <span class="name">preload</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.preload"></a>
    
    

                            </div>
                            <div id="Bar1D.stim_crop" class="classattr">
                                <div class="attr variable">
            <span class="name">stim_crop</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.stim_crop"></a>
    
    

                            </div>
                            <div id="Bar1D.folded_lags" class="classattr">
                                <div class="attr variable">
            <span class="name">folded_lags</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.folded_lags"></a>
    
    

                            </div>
                            <div id="Bar1D.fhandles" class="classattr">
                                <div class="attr variable">
            <span class="name">fhandles</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.fhandles"></a>
    
    

                            </div>
                            <div id="Bar1D.ETstim_location" class="classattr">
                                <div class="attr variable">
            <span class="name">ETstim_location</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.ETstim_location"></a>
    
    

                            </div>
                            <div id="Bar1D.fix_location" class="classattr">
                                <div class="attr variable">
            <span class="name">fix_location</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.fix_location"></a>
    
    

                            </div>
                            <div id="Bar1D.probeIDs" class="classattr">
                                <div class="attr variable">
            <span class="name">probeIDs</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.probeIDs"></a>
    
    

                            </div>
                            <div id="Bar1D.probeIDsMU" class="classattr">
                                <div class="attr variable">
            <span class="name">probeIDsMU</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.probeIDsMU"></a>
    
    

                            </div>
                            <div id="Bar1D.dt" class="classattr">
                                <div class="attr variable">
            <span class="name">dt</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.dt"></a>
    
    

                            </div>
                            <div id="Bar1D.pixel_size" class="classattr">
                                <div class="attr variable">
            <span class="name">pixel_size</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.pixel_size"></a>
    
    

                            </div>
                            <div id="Bar1D.exptdate" class="classattr">
                                <div class="attr variable">
            <span class="name">exptdate</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.exptdate"></a>
    
    

                            </div>
                            <div id="Bar1D.data_threshold" class="classattr">
                                <div class="attr variable">
            <span class="name">data_threshold</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.data_threshold"></a>
    
    

                            </div>
                            <div id="Bar1D.file_index" class="classattr">
                                <div class="attr variable">
            <span class="name">file_index</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.file_index"></a>
    
    

                            </div>
                            <div id="Bar1D.sacc_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">sacc_inds</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.sacc_inds"></a>
    
    

                            </div>
                            <div id="Bar1D.sus" class="classattr">
                                <div class="attr variable">
            <span class="name">sus</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.sus"></a>
    
    

                            </div>
                            <div id="Bar1D.NC" class="classattr">
                                <div class="attr variable">
            <span class="name">NC</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.NC"></a>
    
    

                            </div>
                            <div id="Bar1D.eyepos" class="classattr">
                                <div class="attr variable">
            <span class="name">eyepos</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.eyepos"></a>
    
    

                            </div>
                            <div id="Bar1D.generate_Xfix" class="classattr">
                                <div class="attr variable">
            <span class="name">generate_Xfix</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.generate_Xfix"></a>
    
    

                            </div>
                            <div id="Bar1D.num_blks" class="classattr">
                                <div class="attr variable">
            <span class="name">num_blks</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.num_blks"></a>
    
    

                            </div>
                            <div id="Bar1D.block_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">block_inds</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.block_inds"></a>
    
    

                            </div>
                            <div id="Bar1D.block_filemapping" class="classattr">
                                <div class="attr variable">
            <span class="name">block_filemapping</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.block_filemapping"></a>
    
    

                            </div>
                            <div id="Bar1D.include_MUs" class="classattr">
                                <div class="attr variable">
            <span class="name">include_MUs</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.include_MUs"></a>
    
    

                            </div>
                            <div id="Bar1D.SUinds" class="classattr">
                                <div class="attr variable">
            <span class="name">SUinds</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.SUinds"></a>
    
    

                            </div>
                            <div id="Bar1D.MUinds" class="classattr">
                                <div class="attr variable">
            <span class="name">MUinds</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.MUinds"></a>
    
    

                            </div>
                            <div id="Bar1D.cells_out" class="classattr">
                                <div class="attr variable">
            <span class="name">cells_out</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.cells_out"></a>
    
    

                            </div>
                            <div id="Bar1D.avRs" class="classattr">
                                <div class="attr variable">
            <span class="name">avRs</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.avRs"></a>
    
    

                            </div>
                            <div id="Bar1D.test_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">test_inds</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.test_inds"></a>
    
    

                            </div>
                            <div id="Bar1D.val_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">val_inds</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.val_inds"></a>
    
    

                            </div>
                            <div id="Bar1D.train_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">train_inds</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.train_inds"></a>
    
    

                            </div>
                            <div id="Bar1D.fix_n" class="classattr">
                                <div class="attr variable">
            <span class="name">fix_n</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.fix_n"></a>
    
    

                            </div>
                            <div id="Bar1D.sacc_on" class="classattr">
                                <div class="attr variable">
            <span class="name">sacc_on</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.sacc_on"></a>
    
    

                            </div>
                            <div id="Bar1D.sacc_off" class="classattr">
                                <div class="attr variable">
            <span class="name">sacc_off</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.sacc_off"></a>
    
    

                            </div>
                            <div id="Bar1D.used_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">used_inds</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.used_inds"></a>
    
    

                            </div>
                            <div id="Bar1D.stimname" class="classattr">
                                <div class="attr variable">
            <span class="name">stimname</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.stimname"></a>
    
    

                            </div>
                            <div id="Bar1D.NT" class="classattr">
                                <div class="attr variable">
            <span class="name">NT</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.NT"></a>
    
    

                            </div>
                            <div id="Bar1D.sac_on" class="classattr">
                                <div class="attr variable">
            <span class="name">sac_on</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.sac_on"></a>
    
    

                            </div>
                            <div id="Bar1D.sac_off" class="classattr">
                                <div class="attr variable">
            <span class="name">sac_off</span>

        
    </div>
    <a class="headerlink" href="#Bar1D.sac_off"></a>
    
    

                            </div>
                            <div id="Bar1D.preload_numpy" class="classattr">
                                        <input id="Bar1D.preload_numpy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">preload_numpy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Bar1D.preload_numpy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1D.preload_numpy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1D.preload_numpy-278"><a href="#Bar1D.preload_numpy-278"><span class="linenos">278</span></a>    <span class="k">def</span> <span class="nf">preload_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Bar1D.preload_numpy-279"><a href="#Bar1D.preload_numpy-279"><span class="linenos">279</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1D.preload_numpy-280"><a href="#Bar1D.preload_numpy-280"><span class="linenos">280</span></a><span class="sd">        Note this loads stimulus but does not time-embed.</span>
</span><span id="Bar1D.preload_numpy-281"><a href="#Bar1D.preload_numpy-281"><span class="linenos">281</span></a>
</span><span id="Bar1D.preload_numpy-282"><a href="#Bar1D.preload_numpy-282"><span class="linenos">282</span></a><span class="sd">        Args:</span>
</span><span id="Bar1D.preload_numpy-283"><a href="#Bar1D.preload_numpy-283"><span class="linenos">283</span></a><span class="sd">            None</span>
</span><span id="Bar1D.preload_numpy-284"><a href="#Bar1D.preload_numpy-284"><span class="linenos">284</span></a>
</span><span id="Bar1D.preload_numpy-285"><a href="#Bar1D.preload_numpy-285"><span class="linenos">285</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1D.preload_numpy-286"><a href="#Bar1D.preload_numpy-286"><span class="linenos">286</span></a><span class="sd">            None: sets self.stim, self.robs, self.dfs, self.eyepos, self.frame_times</span>
</span><span id="Bar1D.preload_numpy-287"><a href="#Bar1D.preload_numpy-287"><span class="linenos">287</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1D.preload_numpy-288"><a href="#Bar1D.preload_numpy-288"><span class="linenos">288</span></a>
</span><span id="Bar1D.preload_numpy-289"><a href="#Bar1D.preload_numpy-289"><span class="linenos">289</span></a>        <span class="n">NT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span><span id="Bar1D.preload_numpy-290"><a href="#Bar1D.preload_numpy-290"><span class="linenos">290</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
</span><span id="Bar1D.preload_numpy-291"><a href="#Bar1D.preload_numpy-291"><span class="linenos">291</span></a><span class="sd">        Pre-allocate memory for data</span>
</span><span id="Bar1D.preload_numpy-292"><a href="#Bar1D.preload_numpy-292"><span class="linenos">292</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="Bar1D.preload_numpy-293"><a href="#Bar1D.preload_numpy-293"><span class="linenos">293</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D.preload_numpy-294"><a href="#Bar1D.preload_numpy-294"><span class="linenos">294</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D.preload_numpy-295"><a href="#Bar1D.preload_numpy-295"><span class="linenos">295</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D.preload_numpy-296"><a href="#Bar1D.preload_numpy-296"><span class="linenos">296</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="p">[</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D.preload_numpy-297"><a href="#Bar1D.preload_numpy-297"><span class="linenos">297</span></a>        <span class="c1">#self.eyepos = np.zeros([NT, 2], dtype=np.float32)</span>
</span><span id="Bar1D.preload_numpy-298"><a href="#Bar1D.preload_numpy-298"><span class="linenos">298</span></a>        <span class="c1">#self.frame_times = np.zeros([NT,1], dtype=np.float32)</span>
</span><span id="Bar1D.preload_numpy-299"><a href="#Bar1D.preload_numpy-299"><span class="linenos">299</span></a>
</span><span id="Bar1D.preload_numpy-300"><a href="#Bar1D.preload_numpy-300"><span class="linenos">300</span></a>        <span class="n">t_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1D.preload_numpy-301"><a href="#Bar1D.preload_numpy-301"><span class="linenos">301</span></a>        <span class="n">unit_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1D.preload_numpy-302"><a href="#Bar1D.preload_numpy-302"><span class="linenos">302</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">)):</span>
</span><span id="Bar1D.preload_numpy-303"><a href="#Bar1D.preload_numpy-303"><span class="linenos">303</span></a>            
</span><span id="Bar1D.preload_numpy-304"><a href="#Bar1D.preload_numpy-304"><span class="linenos">304</span></a>            <span class="n">fhandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="Bar1D.preload_numpy-305"><a href="#Bar1D.preload_numpy-305"><span class="linenos">305</span></a>            <span class="n">sz</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="Bar1D.preload_numpy-306"><a href="#Bar1D.preload_numpy-306"><span class="linenos">306</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t_counter</span><span class="p">,</span> <span class="n">t_counter</span><span class="o">+</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="Bar1D.preload_numpy-307"><a href="#Bar1D.preload_numpy-307"><span class="linenos">307</span></a>            <span class="c1">#inds = self.stim_indices[expt][stim][&#39;inds&#39;]</span>
</span><span id="Bar1D.preload_numpy-308"><a href="#Bar1D.preload_numpy-308"><span class="linenos">308</span></a>            <span class="c1">#self.stim[inds, ...] = np.transpose( np.array(fhandle[self.stimname], dtype=np.float32), axes=[0,3,1,2])</span>
</span><span id="Bar1D.preload_numpy-309"><a href="#Bar1D.preload_numpy-309"><span class="linenos">309</span></a>            <span class="n">tmp_stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D.preload_numpy-310"><a href="#Bar1D.preload_numpy-310"><span class="linenos">310</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tmp_stim</span><span class="p">)</span>
</span><span id="Bar1D.preload_numpy-311"><a href="#Bar1D.preload_numpy-311"><span class="linenos">311</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp_stim</span>
</span><span id="Bar1D.preload_numpy-312"><a href="#Bar1D.preload_numpy-312"><span class="linenos">312</span></a>            <span class="n">stim_ori</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stimETori&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D.preload_numpy-313"><a href="#Bar1D.preload_numpy-313"><span class="linenos">313</span></a>            <span class="n">Hinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_ori</span> <span class="o">&lt;</span> <span class="mi">45</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D.preload_numpy-314"><a href="#Bar1D.preload_numpy-314"><span class="linenos">314</span></a>            <span class="n">Vinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_ori</span> <span class="o">&gt;</span> <span class="mi">45</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D.preload_numpy-315"><a href="#Bar1D.preload_numpy-315"><span class="linenos">315</span></a>
</span><span id="Bar1D.preload_numpy-316"><a href="#Bar1D.preload_numpy-316"><span class="linenos">316</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">Vinds</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="Bar1D.preload_numpy-317"><a href="#Bar1D.preload_numpy-317"><span class="linenos">317</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">Hinds</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="Bar1D.preload_numpy-318"><a href="#Bar1D.preload_numpy-318"><span class="linenos">318</span></a>
</span><span id="Bar1D.preload_numpy-319"><a href="#Bar1D.preload_numpy-319"><span class="linenos">319</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; EYE POSITION &quot;&quot;&quot;</span>
</span><span id="Bar1D.preload_numpy-320"><a href="#Bar1D.preload_numpy-320"><span class="linenos">320</span></a>            <span class="c1">#ppd = fhandle[stim][self.stimset][&#39;Stim&#39;].attrs[&#39;ppd&#39;][0]</span>
</span><span id="Bar1D.preload_numpy-321"><a href="#Bar1D.preload_numpy-321"><span class="linenos">321</span></a>            <span class="c1">#centerpix = fhandle[stim][self.stimset][&#39;Stim&#39;].attrs[&#39;center&#39;][:]</span>
</span><span id="Bar1D.preload_numpy-322"><a href="#Bar1D.preload_numpy-322"><span class="linenos">322</span></a>            <span class="c1">#eye_tmp = fhandle[stim][self.stimset][&#39;eyeAtFrame&#39;][1:3,:].T</span>
</span><span id="Bar1D.preload_numpy-323"><a href="#Bar1D.preload_numpy-323"><span class="linenos">323</span></a>            <span class="c1">#eye_tmp[:,0] -= centerpix[0]</span>
</span><span id="Bar1D.preload_numpy-324"><a href="#Bar1D.preload_numpy-324"><span class="linenos">324</span></a>            <span class="c1">#eye_tmp[:,1] -= centerpix[1]</span>
</span><span id="Bar1D.preload_numpy-325"><a href="#Bar1D.preload_numpy-325"><span class="linenos">325</span></a>            <span class="c1">#eye_tmp/= ppd</span>
</span><span id="Bar1D.preload_numpy-326"><a href="#Bar1D.preload_numpy-326"><span class="linenos">326</span></a>            <span class="c1">#self.eyepos[inds,:] = eye_tmp</span>
</span><span id="Bar1D.preload_numpy-327"><a href="#Bar1D.preload_numpy-327"><span class="linenos">327</span></a>
</span><span id="Bar1D.preload_numpy-328"><a href="#Bar1D.preload_numpy-328"><span class="linenos">328</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot; Robs and DATAFILTERS&quot;&quot;&quot;</span>
</span><span id="Bar1D.preload_numpy-329"><a href="#Bar1D.preload_numpy-329"><span class="linenos">329</span></a>            <span class="n">robs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="Bar1D.preload_numpy-330"><a href="#Bar1D.preload_numpy-330"><span class="linenos">330</span></a>            <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="Bar1D.preload_numpy-331"><a href="#Bar1D.preload_numpy-331"><span class="linenos">331</span></a>            <span class="n">num_sus</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Bar1D.preload_numpy-332"><a href="#Bar1D.preload_numpy-332"><span class="linenos">332</span></a>            <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="p">)</span>
</span><span id="Bar1D.preload_numpy-333"><a href="#Bar1D.preload_numpy-333"><span class="linenos">333</span></a>            <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;Robs&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D.preload_numpy-334"><a href="#Bar1D.preload_numpy-334"><span class="linenos">334</span></a>            <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;datafilts&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D.preload_numpy-335"><a href="#Bar1D.preload_numpy-335"><span class="linenos">335</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="Bar1D.preload_numpy-336"><a href="#Bar1D.preload_numpy-336"><span class="linenos">336</span></a>                <span class="n">num_mus</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Bar1D.preload_numpy-337"><a href="#Bar1D.preload_numpy-337"><span class="linenos">337</span></a>                <span class="n">units</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="p">,</span> <span class="n">unit_counter</span><span class="o">+</span><span class="n">num_sus</span><span class="o">+</span><span class="n">num_mus</span><span class="p">)</span>
</span><span id="Bar1D.preload_numpy-338"><a href="#Bar1D.preload_numpy-338"><span class="linenos">338</span></a>                <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;RobsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D.preload_numpy-339"><a href="#Bar1D.preload_numpy-339"><span class="linenos">339</span></a>                <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">units</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;DFsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Bar1D.preload_numpy-340"><a href="#Bar1D.preload_numpy-340"><span class="linenos">340</span></a>            
</span><span id="Bar1D.preload_numpy-341"><a href="#Bar1D.preload_numpy-341"><span class="linenos">341</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">robs_tmp</span><span class="p">)</span>
</span><span id="Bar1D.preload_numpy-342"><a href="#Bar1D.preload_numpy-342"><span class="linenos">342</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dfs_tmp</span><span class="p">)</span>
</span><span id="Bar1D.preload_numpy-343"><a href="#Bar1D.preload_numpy-343"><span class="linenos">343</span></a>
</span><span id="Bar1D.preload_numpy-344"><a href="#Bar1D.preload_numpy-344"><span class="linenos">344</span></a>            <span class="n">t_counter</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D.preload_numpy-345"><a href="#Bar1D.preload_numpy-345"><span class="linenos">345</span></a>            <span class="n">unit_counter</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="Bar1D.preload_numpy-346"><a href="#Bar1D.preload_numpy-346"><span class="linenos">346</span></a>
</span><span id="Bar1D.preload_numpy-347"><a href="#Bar1D.preload_numpy-347"><span class="linenos">347</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stimname</span> <span class="o">=</span> <span class="s1">&#39;stimH&#39;</span>  <span class="c1"># either work I think</span>
</span></pre></div>


            <div class="docstring"><p>Note this loads stimulus but does not time-embed.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li>None</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: sets self.stim, self.robs, self.dfs, self.eyepos, self.frame_times</p>
</blockquote>
</div>


                            </div>
                            <div id="Bar1D.to_tensor" class="classattr">
                                        <input id="Bar1D.to_tensor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">to_tensor</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">device</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Bar1D.to_tensor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1D.to_tensor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1D.to_tensor-350"><a href="#Bar1D.to_tensor-350"><span class="linenos">350</span></a>    <span class="k">def</span> <span class="nf">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="Bar1D.to_tensor-351"><a href="#Bar1D.to_tensor-351"><span class="linenos">351</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="Bar1D.to_tensor-352"><a href="#Bar1D.to_tensor-352"><span class="linenos">352</span></a>            <span class="c1"># then already converted: just moving device</span>
</span><span id="Bar1D.to_tensor-353"><a href="#Bar1D.to_tensor-353"><span class="linenos">353</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D.to_tensor-354"><a href="#Bar1D.to_tensor-354"><span class="linenos">354</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D.to_tensor-355"><a href="#Bar1D.to_tensor-355"><span class="linenos">355</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D.to_tensor-356"><a href="#Bar1D.to_tensor-356"><span class="linenos">356</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D.to_tensor-357"><a href="#Bar1D.to_tensor-357"><span class="linenos">357</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D.to_tensor-358"><a href="#Bar1D.to_tensor-358"><span class="linenos">358</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1D.to_tensor-359"><a href="#Bar1D.to_tensor-359"><span class="linenos">359</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimH</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimH</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D.to_tensor-360"><a href="#Bar1D.to_tensor-360"><span class="linenos">360</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stimV</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimV</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D.to_tensor-361"><a href="#Bar1D.to_tensor-361"><span class="linenos">361</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D.to_tensor-362"><a href="#Bar1D.to_tensor-362"><span class="linenos">362</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D.to_tensor-363"><a href="#Bar1D.to_tensor-363"><span class="linenos">363</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D.to_tensor-364"><a href="#Bar1D.to_tensor-364"><span class="linenos">364</span></a>
</span><span id="Bar1D.to_tensor-365"><a href="#Bar1D.to_tensor-365"><span class="linenos">365</span></a>    <span class="c1">#    self.sacc_ts = torch.tensor(self.sacc_ts, dtype=torch.float32, device=device)</span>
</span><span id="Bar1D.to_tensor-366"><a href="#Bar1D.to_tensor-366"><span class="linenos">366</span></a>        <span class="c1">#self.eyepos = torch.tensor(self.eyepos.astype(&#39;float32&#39;), dtype=self.dtype, device=device)</span>
</span><span id="Bar1D.to_tensor-367"><a href="#Bar1D.to_tensor-367"><span class="linenos">367</span></a>        <span class="c1">#self.frame_times = torch.tensor(self.frame_times.astype(&#39;float32&#39;), dtype=self.dtype, device=device)</span>
</span></pre></div>


    

                            </div>
                            <div id="Bar1D.avrates" class="classattr">
                                        <input id="Bar1D.avrates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">avrates</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">inds</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Bar1D.avrates-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1D.avrates"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1D.avrates-369"><a href="#Bar1D.avrates-369"><span class="linenos">369</span></a>    <span class="k">def</span> <span class="nf">avrates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="Bar1D.avrates-370"><a href="#Bar1D.avrates-370"><span class="linenos">370</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1D.avrates-371"><a href="#Bar1D.avrates-371"><span class="linenos">371</span></a><span class="sd">        Calculates average firing probability across specified inds (or whole dataset)</span>
</span><span id="Bar1D.avrates-372"><a href="#Bar1D.avrates-372"><span class="linenos">372</span></a><span class="sd">        -- Note will respect datafilters</span>
</span><span id="Bar1D.avrates-373"><a href="#Bar1D.avrates-373"><span class="linenos">373</span></a><span class="sd">        -- will return precalc value to save time if already stored</span>
</span><span id="Bar1D.avrates-374"><a href="#Bar1D.avrates-374"><span class="linenos">374</span></a>
</span><span id="Bar1D.avrates-375"><a href="#Bar1D.avrates-375"><span class="linenos">375</span></a><span class="sd">        Args:</span>
</span><span id="Bar1D.avrates-376"><a href="#Bar1D.avrates-376"><span class="linenos">376</span></a><span class="sd">            inds: indices to calculate average rates over</span>
</span><span id="Bar1D.avrates-377"><a href="#Bar1D.avrates-377"><span class="linenos">377</span></a>
</span><span id="Bar1D.avrates-378"><a href="#Bar1D.avrates-378"><span class="linenos">378</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1D.avrates-379"><a href="#Bar1D.avrates-379"><span class="linenos">379</span></a><span class="sd">            avRs: average firing rates across specified indices</span>
</span><span id="Bar1D.avrates-380"><a href="#Bar1D.avrates-380"><span class="linenos">380</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1D.avrates-381"><a href="#Bar1D.avrates-381"><span class="linenos">381</span></a>        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1D.avrates-382"><a href="#Bar1D.avrates-382"><span class="linenos">382</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="Bar1D.avrates-383"><a href="#Bar1D.avrates-383"><span class="linenos">383</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="Bar1D.avrates-384"><a href="#Bar1D.avrates-384"><span class="linenos">384</span></a>            <span class="c1"># then calculate across whole dataset</span>
</span><span id="Bar1D.avrates-385"><a href="#Bar1D.avrates-385"><span class="linenos">385</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1D.avrates-386"><a href="#Bar1D.avrates-386"><span class="linenos">386</span></a>                <span class="c1"># then precalculated and do not need to do</span>
</span><span id="Bar1D.avrates-387"><a href="#Bar1D.avrates-387"><span class="linenos">387</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span>
</span><span id="Bar1D.avrates-388"><a href="#Bar1D.avrates-388"><span class="linenos">388</span></a>
</span><span id="Bar1D.avrates-389"><a href="#Bar1D.avrates-389"><span class="linenos">389</span></a>        <span class="c1"># Otherwise calculate across all data</span>
</span><span id="Bar1D.avrates-390"><a href="#Bar1D.avrates-390"><span class="linenos">390</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="Bar1D.avrates-391"><a href="#Bar1D.avrates-391"><span class="linenos">391</span></a>            <span class="n">Reff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="Bar1D.avrates-392"><a href="#Bar1D.avrates-392"><span class="linenos">392</span></a>            <span class="n">Teff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="Bar1D.avrates-393"><a href="#Bar1D.avrates-393"><span class="linenos">393</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="o">/</span><span class="n">Teff</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="Bar1D.avrates-394"><a href="#Bar1D.avrates-394"><span class="linenos">394</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1D.avrates-395"><a href="#Bar1D.avrates-395"><span class="linenos">395</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Still need to implement avRs without preloading&#39;</span><span class="p">)</span>
</span><span id="Bar1D.avrates-396"><a href="#Bar1D.avrates-396"><span class="linenos">396</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Calculates average firing probability across specified inds (or whole dataset)
-- Note will respect datafilters
-- will return precalc value to save time if already stored</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>inds:</strong>  indices to calculate average rates over</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>avRs: average firing rates across specified indices</p>
</blockquote>
</div>


                            </div>
                            <div id="Bar1D.shift_stim_fixation" class="classattr">
                                        <input id="Bar1D.shift_stim_fixation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">shift_stim_fixation</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">stim</span>, </span><span class="param"><span class="n">shift</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Bar1D.shift_stim_fixation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1D.shift_stim_fixation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1D.shift_stim_fixation-399"><a href="#Bar1D.shift_stim_fixation-399"><span class="linenos">399</span></a>    <span class="k">def</span> <span class="nf">shift_stim_fixation</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
</span><span id="Bar1D.shift_stim_fixation-400"><a href="#Bar1D.shift_stim_fixation-400"><span class="linenos">400</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1D.shift_stim_fixation-401"><a href="#Bar1D.shift_stim_fixation-401"><span class="linenos">401</span></a><span class="sd">        Simple shift by integer (rounded shift) and zero padded. Note that this is not in </span>
</span><span id="Bar1D.shift_stim_fixation-402"><a href="#Bar1D.shift_stim_fixation-402"><span class="linenos">402</span></a><span class="sd">        is in units of number of bars, rather than -1 to +1. It assumes the stim</span>
</span><span id="Bar1D.shift_stim_fixation-403"><a href="#Bar1D.shift_stim_fixation-403"><span class="linenos">403</span></a><span class="sd">        has a batch dimension (over a fixation), and shifts the whole stim by the same amount.</span>
</span><span id="Bar1D.shift_stim_fixation-404"><a href="#Bar1D.shift_stim_fixation-404"><span class="linenos">404</span></a><span class="sd">        </span>
</span><span id="Bar1D.shift_stim_fixation-405"><a href="#Bar1D.shift_stim_fixation-405"><span class="linenos">405</span></a><span class="sd">        Args:</span>
</span><span id="Bar1D.shift_stim_fixation-406"><a href="#Bar1D.shift_stim_fixation-406"><span class="linenos">406</span></a><span class="sd">            stim: stimulus tensor to shift</span>
</span><span id="Bar1D.shift_stim_fixation-407"><a href="#Bar1D.shift_stim_fixation-407"><span class="linenos">407</span></a><span class="sd">            shift: amount to shift by (in units of bars)</span>
</span><span id="Bar1D.shift_stim_fixation-408"><a href="#Bar1D.shift_stim_fixation-408"><span class="linenos">408</span></a>
</span><span id="Bar1D.shift_stim_fixation-409"><a href="#Bar1D.shift_stim_fixation-409"><span class="linenos">409</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1D.shift_stim_fixation-410"><a href="#Bar1D.shift_stim_fixation-410"><span class="linenos">410</span></a><span class="sd">            shstim: shifted stimulus tensor</span>
</span><span id="Bar1D.shift_stim_fixation-411"><a href="#Bar1D.shift_stim_fixation-411"><span class="linenos">411</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1D.shift_stim_fixation-412"><a href="#Bar1D.shift_stim_fixation-412"><span class="linenos">412</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Currently needs to be fixed to work with 2D&#39;</span><span class="p">)</span>
</span><span id="Bar1D.shift_stim_fixation-413"><a href="#Bar1D.shift_stim_fixation-413"><span class="linenos">413</span></a>        <span class="n">sh</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span>
</span><span id="Bar1D.shift_stim_fixation-414"><a href="#Bar1D.shift_stim_fixation-414"><span class="linenos">414</span></a>        <span class="n">shstim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Bar1D.shift_stim_fixation-415"><a href="#Bar1D.shift_stim_fixation-415"><span class="linenos">415</span></a>        <span class="k">if</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1D.shift_stim_fixation-416"><a href="#Bar1D.shift_stim_fixation-416"><span class="linenos">416</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="o">-</span><span class="n">sh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="p">:</span><span class="n">sh</span><span class="p">]</span>
</span><span id="Bar1D.shift_stim_fixation-417"><a href="#Bar1D.shift_stim_fixation-417"><span class="linenos">417</span></a>        <span class="k">elif</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1D.shift_stim_fixation-418"><a href="#Bar1D.shift_stim_fixation-418"><span class="linenos">418</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="n">sh</span><span class="p">:]</span>
</span><span id="Bar1D.shift_stim_fixation-419"><a href="#Bar1D.shift_stim_fixation-419"><span class="linenos">419</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1D.shift_stim_fixation-420"><a href="#Bar1D.shift_stim_fixation-420"><span class="linenos">420</span></a>            <span class="n">shstim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="Bar1D.shift_stim_fixation-421"><a href="#Bar1D.shift_stim_fixation-421"><span class="linenos">421</span></a>
</span><span id="Bar1D.shift_stim_fixation-422"><a href="#Bar1D.shift_stim_fixation-422"><span class="linenos">422</span></a>        <span class="k">return</span> <span class="n">shstim</span>
</span></pre></div>


            <div class="docstring"><p>Simple shift by integer (rounded shift) and zero padded. Note that this is not in 
is in units of number of bars, rather than -1 to +1. It assumes the stim
has a batch dimension (over a fixation), and shifts the whole stim by the same amount.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>stim:</strong>  stimulus tensor to shift</li>
<li><strong>shift:</strong>  amount to shift by (in units of bars)</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>shstim: shifted stimulus tensor</p>
</blockquote>
</div>


                            </div>
                            <div id="Bar1D.create_valid_indices" class="classattr">
                                        <input id="Bar1D.create_valid_indices-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_valid_indices</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">post_sacc_gap</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Bar1D.create_valid_indices-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1D.create_valid_indices"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1D.create_valid_indices-425"><a href="#Bar1D.create_valid_indices-425"><span class="linenos">425</span></a>    <span class="k">def</span> <span class="nf">create_valid_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post_sacc_gap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Bar1D.create_valid_indices-426"><a href="#Bar1D.create_valid_indices-426"><span class="linenos">426</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1D.create_valid_indices-427"><a href="#Bar1D.create_valid_indices-427"><span class="linenos">427</span></a><span class="sd">        This creates self.valid_inds vector that is used for __get_item__ </span>
</span><span id="Bar1D.create_valid_indices-428"><a href="#Bar1D.create_valid_indices-428"><span class="linenos">428</span></a><span class="sd">        -- Will default to num_lags following each saccade beginning</span>
</span><span id="Bar1D.create_valid_indices-429"><a href="#Bar1D.create_valid_indices-429"><span class="linenos">429</span></a><span class="sd">        </span>
</span><span id="Bar1D.create_valid_indices-430"><a href="#Bar1D.create_valid_indices-430"><span class="linenos">430</span></a><span class="sd">        Args:</span>
</span><span id="Bar1D.create_valid_indices-431"><a href="#Bar1D.create_valid_indices-431"><span class="linenos">431</span></a><span class="sd">            post_sacc_gap: number of lags to ignore following each saccade</span>
</span><span id="Bar1D.create_valid_indices-432"><a href="#Bar1D.create_valid_indices-432"><span class="linenos">432</span></a>
</span><span id="Bar1D.create_valid_indices-433"><a href="#Bar1D.create_valid_indices-433"><span class="linenos">433</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1D.create_valid_indices-434"><a href="#Bar1D.create_valid_indices-434"><span class="linenos">434</span></a><span class="sd">            None: sets self.valid_inds</span>
</span><span id="Bar1D.create_valid_indices-435"><a href="#Bar1D.create_valid_indices-435"><span class="linenos">435</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1D.create_valid_indices-436"><a href="#Bar1D.create_valid_indices-436"><span class="linenos">436</span></a>
</span><span id="Bar1D.create_valid_indices-437"><a href="#Bar1D.create_valid_indices-437"><span class="linenos">437</span></a>        <span class="k">if</span> <span class="n">post_sacc_gap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1D.create_valid_indices-438"><a href="#Bar1D.create_valid_indices-438"><span class="linenos">438</span></a>            <span class="n">post_sacc_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="Bar1D.create_valid_indices-439"><a href="#Bar1D.create_valid_indices-439"><span class="linenos">439</span></a>
</span><span id="Bar1D.create_valid_indices-440"><a href="#Bar1D.create_valid_indices-440"><span class="linenos">440</span></a>        <span class="c1"># first, throw out all data where all data_filters are zero</span>
</span><span id="Bar1D.create_valid_indices-441"><a href="#Bar1D.create_valid_indices-441"><span class="linenos">441</span></a>        <span class="n">is_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="Bar1D.create_valid_indices-442"><a href="#Bar1D.create_valid_indices-442"><span class="linenos">442</span></a>        <span class="n">is_valid</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Bar1D.create_valid_indices-443"><a href="#Bar1D.create_valid_indices-443"><span class="linenos">443</span></a>        
</span><span id="Bar1D.create_valid_indices-444"><a href="#Bar1D.create_valid_indices-444"><span class="linenos">444</span></a>        <span class="c1"># Now invalid post_sacc_gap following saccades</span>
</span><span id="Bar1D.create_valid_indices-445"><a href="#Bar1D.create_valid_indices-445"><span class="linenos">445</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_fixations</span><span class="p">):</span>
</span><span id="Bar1D.create_valid_indices-446"><a href="#Bar1D.create_valid_indices-446"><span class="linenos">446</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:])</span>
</span><span id="Bar1D.create_valid_indices-447"><a href="#Bar1D.create_valid_indices-447"><span class="linenos">447</span></a>            <span class="n">sts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="Bar1D.create_valid_indices-448"><a href="#Bar1D.create_valid_indices-448"><span class="linenos">448</span></a>            <span class="n">is_valid</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">post_sacc_gap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Bar1D.create_valid_indices-449"><a href="#Bar1D.create_valid_indices-449"><span class="linenos">449</span></a>        
</span><span id="Bar1D.create_valid_indices-450"><a href="#Bar1D.create_valid_indices-450"><span class="linenos">450</span></a>        <span class="c1">#self.valid_inds = list(np.where(is_valid &gt; 0)[0])</span>
</span><span id="Bar1D.create_valid_indices-451"><a href="#Bar1D.create_valid_indices-451"><span class="linenos">451</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_valid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>This creates self.valid_inds vector that is used for __get_item__ 
-- Will default to num_lags following each saccade beginning</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>post_sacc_gap:</strong>  number of lags to ignore following each saccade</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: sets self.valid_inds</p>
</blockquote>
</div>


                            </div>
                            <div id="Bar1D.crossval_setup" class="classattr">
                                        <input id="Bar1D.crossval_setup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">crossval_setup</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">folds</span><span class="o">=</span><span class="mi">5</span>, </span><span class="param"><span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">test_set</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Bar1D.crossval_setup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1D.crossval_setup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1D.crossval_setup-454"><a href="#Bar1D.crossval_setup-454"><span class="linenos">454</span></a>    <span class="k">def</span> <span class="nf">crossval_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test_set</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Bar1D.crossval_setup-455"><a href="#Bar1D.crossval_setup-455"><span class="linenos">455</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1D.crossval_setup-456"><a href="#Bar1D.crossval_setup-456"><span class="linenos">456</span></a><span class="sd">        This sets the cross-validation indices up We can add featuers here. Many ways to do this</span>
</span><span id="Bar1D.crossval_setup-457"><a href="#Bar1D.crossval_setup-457"><span class="linenos">457</span></a><span class="sd">        but will stick to some standard for now. It sets the internal indices, which can be read out</span>
</span><span id="Bar1D.crossval_setup-458"><a href="#Bar1D.crossval_setup-458"><span class="linenos">458</span></a><span class="sd">        directly or with helper functions. Perhaps helper_functions is the best way....</span>
</span><span id="Bar1D.crossval_setup-459"><a href="#Bar1D.crossval_setup-459"><span class="linenos">459</span></a><span class="sd">        </span>
</span><span id="Bar1D.crossval_setup-460"><a href="#Bar1D.crossval_setup-460"><span class="linenos">460</span></a><span class="sd">        Args: </span>
</span><span id="Bar1D.crossval_setup-461"><a href="#Bar1D.crossval_setup-461"><span class="linenos">461</span></a><span class="sd">            folds: number of folds to partition data into</span>
</span><span id="Bar1D.crossval_setup-462"><a href="#Bar1D.crossval_setup-462"><span class="linenos">462</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="Bar1D.crossval_setup-463"><a href="#Bar1D.crossval_setup-463"><span class="linenos">463</span></a><span class="sd">            test_set: whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</span>
</span><span id="Bar1D.crossval_setup-464"><a href="#Bar1D.crossval_setup-464"><span class="linenos">464</span></a><span class="sd">            verbose: whether to print out information about the partitioning</span>
</span><span id="Bar1D.crossval_setup-465"><a href="#Bar1D.crossval_setup-465"><span class="linenos">465</span></a>
</span><span id="Bar1D.crossval_setup-466"><a href="#Bar1D.crossval_setup-466"><span class="linenos">466</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1D.crossval_setup-467"><a href="#Bar1D.crossval_setup-467"><span class="linenos">467</span></a><span class="sd">            None: sets internal variables test_inds, train_inds, val_inds</span>
</span><span id="Bar1D.crossval_setup-468"><a href="#Bar1D.crossval_setup-468"><span class="linenos">468</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1D.crossval_setup-469"><a href="#Bar1D.crossval_setup-469"><span class="linenos">469</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must first specify valid_indices before setting up cross-validation.&quot;</span>
</span><span id="Bar1D.crossval_setup-470"><a href="#Bar1D.crossval_setup-470"><span class="linenos">470</span></a>
</span><span id="Bar1D.crossval_setup-471"><a href="#Bar1D.crossval_setup-471"><span class="linenos">471</span></a>        <span class="c1"># Partition data by saccades, and then associate indices with each</span>
</span><span id="Bar1D.crossval_setup-472"><a href="#Bar1D.crossval_setup-472"><span class="linenos">472</span></a>        <span class="n">te_fixes</span><span class="p">,</span> <span class="n">tr_fixes</span><span class="p">,</span> <span class="n">val_fixes</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="Bar1D.crossval_setup-473"><a href="#Bar1D.crossval_setup-473"><span class="linenos">473</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixation_grouping</span><span class="p">)):</span>  <span class="c1"># Loops across experiments</span>
</span><span id="Bar1D.crossval_setup-474"><a href="#Bar1D.crossval_setup-474"><span class="linenos">474</span></a>            <span class="n">fixations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixation_grouping</span><span class="p">[</span><span class="n">ee</span><span class="p">])</span>  <span class="c1"># fixations associated with each experiment</span>
</span><span id="Bar1D.crossval_setup-475"><a href="#Bar1D.crossval_setup-475"><span class="linenos">475</span></a>            <span class="n">val_fix1</span><span class="p">,</span> <span class="n">tr_fix1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fixations</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="Bar1D.crossval_setup-476"><a href="#Bar1D.crossval_setup-476"><span class="linenos">476</span></a>            <span class="k">if</span> <span class="n">test_set</span><span class="p">:</span>
</span><span id="Bar1D.crossval_setup-477"><a href="#Bar1D.crossval_setup-477"><span class="linenos">477</span></a>                <span class="n">te_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">val_fix1</span><span class="p">])</span>
</span><span id="Bar1D.crossval_setup-478"><a href="#Bar1D.crossval_setup-478"><span class="linenos">478</span></a>                <span class="n">val_fix2</span><span class="p">,</span> <span class="n">tr_fix2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_fix1</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="Bar1D.crossval_setup-479"><a href="#Bar1D.crossval_setup-479"><span class="linenos">479</span></a>                <span class="n">val_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">tr_fix1</span><span class="p">[</span><span class="n">val_fix2</span><span class="p">]])</span>
</span><span id="Bar1D.crossval_setup-480"><a href="#Bar1D.crossval_setup-480"><span class="linenos">480</span></a>                <span class="n">tr_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">tr_fix1</span><span class="p">[</span><span class="n">tr_fix2</span><span class="p">]])</span>
</span><span id="Bar1D.crossval_setup-481"><a href="#Bar1D.crossval_setup-481"><span class="linenos">481</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1D.crossval_setup-482"><a href="#Bar1D.crossval_setup-482"><span class="linenos">482</span></a>                <span class="n">val_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">val_fix1</span><span class="p">])</span>
</span><span id="Bar1D.crossval_setup-483"><a href="#Bar1D.crossval_setup-483"><span class="linenos">483</span></a>                <span class="n">tr_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fixations</span><span class="p">[</span><span class="n">tr_fix1</span><span class="p">])</span>
</span><span id="Bar1D.crossval_setup-484"><a href="#Bar1D.crossval_setup-484"><span class="linenos">484</span></a>
</span><span id="Bar1D.crossval_setup-485"><a href="#Bar1D.crossval_setup-485"><span class="linenos">485</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Bar1D.crossval_setup-486"><a href="#Bar1D.crossval_setup-486"><span class="linenos">486</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Partitioned </span><span class="si">%d</span><span class="s2"> fixations total: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span>
</span><span id="Bar1D.crossval_setup-487"><a href="#Bar1D.crossval_setup-487"><span class="linenos">487</span></a>                <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">te_fixes</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_fixes</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">val_fixes</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_fixes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_fixes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">te_fixes</span><span class="p">)))</span>  
</span><span id="Bar1D.crossval_setup-488"><a href="#Bar1D.crossval_setup-488"><span class="linenos">488</span></a>
</span><span id="Bar1D.crossval_setup-489"><a href="#Bar1D.crossval_setup-489"><span class="linenos">489</span></a>        <span class="c1"># Now pull  indices from each saccade </span>
</span><span id="Bar1D.crossval_setup-490"><a href="#Bar1D.crossval_setup-490"><span class="linenos">490</span></a>        <span class="n">tr_inds</span><span class="p">,</span> <span class="n">te_inds</span><span class="p">,</span> <span class="n">val_inds</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="Bar1D.crossval_setup-491"><a href="#Bar1D.crossval_setup-491"><span class="linenos">491</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">tr_fixes</span><span class="p">:</span>
</span><span id="Bar1D.crossval_setup-492"><a href="#Bar1D.crossval_setup-492"><span class="linenos">492</span></a>            <span class="n">tr_inds</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Bar1D.crossval_setup-493"><a href="#Bar1D.crossval_setup-493"><span class="linenos">493</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">val_fixes</span><span class="p">:</span>
</span><span id="Bar1D.crossval_setup-494"><a href="#Bar1D.crossval_setup-494"><span class="linenos">494</span></a>            <span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Bar1D.crossval_setup-495"><a href="#Bar1D.crossval_setup-495"><span class="linenos">495</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">te_fixes</span><span class="p">:</span>
</span><span id="Bar1D.crossval_setup-496"><a href="#Bar1D.crossval_setup-496"><span class="linenos">496</span></a>            <span class="n">te_inds</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sacc_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Bar1D.crossval_setup-497"><a href="#Bar1D.crossval_setup-497"><span class="linenos">497</span></a>
</span><span id="Bar1D.crossval_setup-498"><a href="#Bar1D.crossval_setup-498"><span class="linenos">498</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Bar1D.crossval_setup-499"><a href="#Bar1D.crossval_setup-499"><span class="linenos">499</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Pre-valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">te_inds</span><span class="p">))</span> <span class="p">)</span>
</span><span id="Bar1D.crossval_setup-500"><a href="#Bar1D.crossval_setup-500"><span class="linenos">500</span></a>
</span><span id="Bar1D.crossval_setup-501"><a href="#Bar1D.crossval_setup-501"><span class="linenos">501</span></a>        <span class="c1"># Finally intersect with valid indices</span>
</span><span id="Bar1D.crossval_setup-502"><a href="#Bar1D.crossval_setup-502"><span class="linenos">502</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tr_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">)))</span>
</span><span id="Bar1D.crossval_setup-503"><a href="#Bar1D.crossval_setup-503"><span class="linenos">503</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">val_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">)))</span>
</span><span id="Bar1D.crossval_setup-504"><a href="#Bar1D.crossval_setup-504"><span class="linenos">504</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">te_inds</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_inds</span><span class="p">)))</span>
</span><span id="Bar1D.crossval_setup-505"><a href="#Bar1D.crossval_setup-505"><span class="linenos">505</span></a>
</span><span id="Bar1D.crossval_setup-506"><a href="#Bar1D.crossval_setup-506"><span class="linenos">506</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Bar1D.crossval_setup-507"><a href="#Bar1D.crossval_setup-507"><span class="linenos">507</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Valid data indices: tr </span><span class="si">%d</span><span class="s2">, val </span><span class="si">%d</span><span class="s2">, te </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span><span class="p">))</span> <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This sets the cross-validation indices up We can add featuers here. Many ways to do this
but will stick to some standard for now. It sets the internal indices, which can be read out
directly or with helper functions. Perhaps helper_functions is the best way....</p>

<p>Args: 
    folds: number of folds to partition data into
    random_gen: whether to pick random fixations for validation or uniformly distributed
    test_set: whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets
    verbose: whether to print out information about the partitioning</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: sets internal variables test_inds, train_inds, val_inds</p>
</blockquote>
</div>


                            </div>
                            <div id="Bar1D.fold_sample" class="classattr">
                                        <input id="Bar1D.fold_sample-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fold_sample</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">num_items</span>, </span><span class="param"><span class="n">folds</span>, </span><span class="param"><span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Bar1D.fold_sample-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1D.fold_sample"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1D.fold_sample-511"><a href="#Bar1D.fold_sample-511"><span class="linenos">511</span></a>    <span class="k">def</span> <span class="nf">fold_sample</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Bar1D.fold_sample-512"><a href="#Bar1D.fold_sample-512"><span class="linenos">512</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1D.fold_sample-513"><a href="#Bar1D.fold_sample-513"><span class="linenos">513</span></a><span class="sd">        This really should be a general method not associated with self.</span>
</span><span id="Bar1D.fold_sample-514"><a href="#Bar1D.fold_sample-514"><span class="linenos">514</span></a><span class="sd">        </span>
</span><span id="Bar1D.fold_sample-515"><a href="#Bar1D.fold_sample-515"><span class="linenos">515</span></a><span class="sd">        Args:</span>
</span><span id="Bar1D.fold_sample-516"><a href="#Bar1D.fold_sample-516"><span class="linenos">516</span></a><span class="sd">            num_items: number of items to partition</span>
</span><span id="Bar1D.fold_sample-517"><a href="#Bar1D.fold_sample-517"><span class="linenos">517</span></a><span class="sd">            folds: number of folds to partition into</span>
</span><span id="Bar1D.fold_sample-518"><a href="#Bar1D.fold_sample-518"><span class="linenos">518</span></a><span class="sd">            random_gen: whether to randomly partition or not</span>
</span><span id="Bar1D.fold_sample-519"><a href="#Bar1D.fold_sample-519"><span class="linenos">519</span></a>
</span><span id="Bar1D.fold_sample-520"><a href="#Bar1D.fold_sample-520"><span class="linenos">520</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1D.fold_sample-521"><a href="#Bar1D.fold_sample-521"><span class="linenos">521</span></a><span class="sd">            val_items: indices of items to be used for validation</span>
</span><span id="Bar1D.fold_sample-522"><a href="#Bar1D.fold_sample-522"><span class="linenos">522</span></a><span class="sd">            rem_items: indices of items to be used for remainder</span>
</span><span id="Bar1D.fold_sample-523"><a href="#Bar1D.fold_sample-523"><span class="linenos">523</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1D.fold_sample-524"><a href="#Bar1D.fold_sample-524"><span class="linenos">524</span></a>        <span class="k">if</span> <span class="n">random_gen</span><span class="p">:</span>
</span><span id="Bar1D.fold_sample-525"><a href="#Bar1D.fold_sample-525"><span class="linenos">525</span></a>            <span class="n">num_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_items</span><span class="o">/</span><span class="n">folds</span><span class="p">)</span>
</span><span id="Bar1D.fold_sample-526"><a href="#Bar1D.fold_sample-526"><span class="linenos">526</span></a>            <span class="n">tmp_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">num_items</span><span class="p">)</span>
</span><span id="Bar1D.fold_sample-527"><a href="#Bar1D.fold_sample-527"><span class="linenos">527</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[:</span><span class="n">num_val</span><span class="p">])</span>
</span><span id="Bar1D.fold_sample-528"><a href="#Bar1D.fold_sample-528"><span class="linenos">528</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[</span><span class="n">num_val</span><span class="p">:])</span>
</span><span id="Bar1D.fold_sample-529"><a href="#Bar1D.fold_sample-529"><span class="linenos">529</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1D.fold_sample-530"><a href="#Bar1D.fold_sample-530"><span class="linenos">530</span></a>            <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">folds</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="Bar1D.fold_sample-531"><a href="#Bar1D.fold_sample-531"><span class="linenos">531</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
</span><span id="Bar1D.fold_sample-532"><a href="#Bar1D.fold_sample-532"><span class="linenos">532</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">),</span> <span class="n">val_items</span><span class="p">)</span>
</span><span id="Bar1D.fold_sample-533"><a href="#Bar1D.fold_sample-533"><span class="linenos">533</span></a>        <span class="k">return</span> <span class="n">val_items</span><span class="p">,</span> <span class="n">rem_items</span>
</span></pre></div>


            <div class="docstring"><p>This really should be a general method not associated with self.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>num_items:</strong>  number of items to partition</li>
<li><strong>folds:</strong>  number of folds to partition into</li>
<li><strong>random_gen:</strong>  whether to randomly partition or not</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>val_items: indices of items to be used for validation
  rem_items: indices of items to be used for remainder</p>
</blockquote>
</div>


                            </div>
                            <div id="Bar1D.get_max_samples" class="classattr">
                                        <input id="Bar1D.get_max_samples-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_max_samples</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">gpu_n</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">history_size</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="n">nquad</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">buffer</span><span class="o">=</span><span class="mf">1.2</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Bar1D.get_max_samples-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Bar1D.get_max_samples"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Bar1D.get_max_samples-535"><a href="#Bar1D.get_max_samples-535"><span class="linenos">535</span></a>    <span class="k">def</span> <span class="nf">get_max_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpu_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nquad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mf">1.2</span><span class="p">):</span>
</span><span id="Bar1D.get_max_samples-536"><a href="#Bar1D.get_max_samples-536"><span class="linenos">536</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Bar1D.get_max_samples-537"><a href="#Bar1D.get_max_samples-537"><span class="linenos">537</span></a><span class="sd">        get the maximum number of samples that fit in memory -- for GLM/GQM x LBFGS</span>
</span><span id="Bar1D.get_max_samples-538"><a href="#Bar1D.get_max_samples-538"><span class="linenos">538</span></a>
</span><span id="Bar1D.get_max_samples-539"><a href="#Bar1D.get_max_samples-539"><span class="linenos">539</span></a><span class="sd">        Args:</span>
</span><span id="Bar1D.get_max_samples-540"><a href="#Bar1D.get_max_samples-540"><span class="linenos">540</span></a><span class="sd">            dataset: the dataset to get the samples from</span>
</span><span id="Bar1D.get_max_samples-541"><a href="#Bar1D.get_max_samples-541"><span class="linenos">541</span></a><span class="sd">            device: the device to put the samples on</span>
</span><span id="Bar1D.get_max_samples-542"><a href="#Bar1D.get_max_samples-542"><span class="linenos">542</span></a>
</span><span id="Bar1D.get_max_samples-543"><a href="#Bar1D.get_max_samples-543"><span class="linenos">543</span></a><span class="sd">        Returns:</span>
</span><span id="Bar1D.get_max_samples-544"><a href="#Bar1D.get_max_samples-544"><span class="linenos">544</span></a><span class="sd">            maxsamples: the maximum number of samples that can fit on the device</span>
</span><span id="Bar1D.get_max_samples-545"><a href="#Bar1D.get_max_samples-545"><span class="linenos">545</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Bar1D.get_max_samples-546"><a href="#Bar1D.get_max_samples-546"><span class="linenos">546</span></a>        <span class="k">if</span> <span class="n">gpu_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Bar1D.get_max_samples-547"><a href="#Bar1D.get_max_samples-547"><span class="linenos">547</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
</span><span id="Bar1D.get_max_samples-548"><a href="#Bar1D.get_max_samples-548"><span class="linenos">548</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Bar1D.get_max_samples-549"><a href="#Bar1D.get_max_samples-549"><span class="linenos">549</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:1&#39;</span><span class="p">)</span>
</span><span id="Bar1D.get_max_samples-550"><a href="#Bar1D.get_max_samples-550"><span class="linenos">550</span></a>
</span><span id="Bar1D.get_max_samples-551"><a href="#Bar1D.get_max_samples-551"><span class="linenos">551</span></a>        <span class="k">if</span> <span class="n">num_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Bar1D.get_max_samples-552"><a href="#Bar1D.get_max_samples-552"><span class="linenos">552</span></a>            <span class="n">num_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span>
</span><span id="Bar1D.get_max_samples-553"><a href="#Bar1D.get_max_samples-553"><span class="linenos">553</span></a>        
</span><span id="Bar1D.get_max_samples-554"><a href="#Bar1D.get_max_samples-554"><span class="linenos">554</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">total_memory</span>
</span><span id="Bar1D.get_max_samples-555"><a href="#Bar1D.get_max_samples-555"><span class="linenos">555</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_reserved</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D.get_max_samples-556"><a href="#Bar1D.get_max_samples-556"><span class="linenos">556</span></a>        <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">memory_allocated</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Bar1D.get_max_samples-557"><a href="#Bar1D.get_max_samples-557"><span class="linenos">557</span></a>        <span class="n">free</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">r</span><span class="p">)</span>
</span><span id="Bar1D.get_max_samples-558"><a href="#Bar1D.get_max_samples-558"><span class="linenos">558</span></a>
</span><span id="Bar1D.get_max_samples-559"><a href="#Bar1D.get_max_samples-559"><span class="linenos">559</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Bar1D.get_max_samples-560"><a href="#Bar1D.get_max_samples-560"><span class="linenos">560</span></a>        <span class="n">mempersample</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stimname</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nelement</span><span class="p">()</span>
</span><span id="Bar1D.get_max_samples-561"><a href="#Bar1D.get_max_samples-561"><span class="linenos">561</span></a>    
</span><span id="Bar1D.get_max_samples-562"><a href="#Bar1D.get_max_samples-562"><span class="linenos">562</span></a>        <span class="n">mempercell</span> <span class="o">=</span> <span class="n">mempersample</span> <span class="o">*</span> <span class="p">(</span><span class="n">nquad</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">history_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Bar1D.get_max_samples-563"><a href="#Bar1D.get_max_samples-563"><span class="linenos">563</span></a>        <span class="n">buffer_bytes</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">*</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span>
</span><span id="Bar1D.get_max_samples-564"><a href="#Bar1D.get_max_samples-564"><span class="linenos">564</span></a>
</span><span id="Bar1D.get_max_samples-565"><a href="#Bar1D.get_max_samples-565"><span class="linenos">565</span></a>        <span class="n">maxsamples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">free</span> <span class="o">-</span> <span class="n">mempercell</span><span class="o">*</span><span class="n">num_cells</span> <span class="o">-</span> <span class="n">buffer_bytes</span><span class="p">)</span> <span class="o">//</span> <span class="n">mempersample</span>
</span><span id="Bar1D.get_max_samples-566"><a href="#Bar1D.get_max_samples-566"><span class="linenos">566</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# samples that can fit on device: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxsamples</span><span class="p">))</span>
</span><span id="Bar1D.get_max_samples-567"><a href="#Bar1D.get_max_samples-567"><span class="linenos">567</span></a>        <span class="k">return</span> <span class="n">maxsamples</span>
</span></pre></div>


            <div class="docstring"><p>get the maximum number of samples that fit in memory -- for GLM/GQM x LBFGS</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>dataset:</strong>  the dataset to get the samples from</li>
<li><strong>device:</strong>  the device to put the samples on</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>maxsamples: the maximum number of samples that can fit on the device</p>
</blockquote>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>
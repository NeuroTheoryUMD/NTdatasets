<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.6.0"/>
    <title>NTdatasets.cumming.monocular API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../cumming.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;NTdatasets.cumming</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#MultiDataset">MultiDataset</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#MultiDataset.__init__">MultiDataset</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiDataset.fhandles">fhandles</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiDataset.file_index">file_index</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiDataset.block_inds">block_inds</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiDataset.NTfile">NTfile</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiDataset.unit_ids">unit_ids</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiDataset.dims_file">dims_file</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiDataset.num_blocks">num_blocks</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiDataset.block_assign">block_assign</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiDataset.block_grouping">block_grouping</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiDataset.trial_size">trial_size</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiDataset.dims">dims</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiDataset.stim_dims">stim_dims</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiDataset.SUs">SUs</a>
                        </li>
                        <li>
                                <a class="variable" href="#MultiDataset.avRs">avRs</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiDataset.to_tensor">to_tensor</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiDataset.avrates">avrates</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiDataset.subset">subset</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiDataset.shift_stim_fixation">shift_stim_fixation</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiDataset.crossval_setup">crossval_setup</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiDataset.fold_sample">fold_sample</a>
                        </li>
                        <li>
                                <a class="function" href="#MultiDataset.collate_blocks">collate_blocks</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#get_stim_url">get_stim_url</a>
            </li>
            <li>
                    <a class="function" href="#download_set">download_set</a>
            </li>
            <li>
                    <a class="function" href="#time_in_blocks">time_in_blocks</a>
            </li>
            <li>
                    <a class="function" href="#make_block_inds">make_block_inds</a>
            </li>
            <li>
                    <a class="function" href="#monocular_data_import">monocular_data_import</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../NTdatasets.html">NTdatasets</a><wbr>.<a href="./../cumming.html">cumming</a><wbr>.monocular    </h1>

                
                        <input id="mod-monocular-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-monocular-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">from</span> <span class="nn">tkinter</span> <span class="kn">import</span> <span class="n">N</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">sio</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">import</span> <span class="nn">NDNT.utils</span> <span class="k">as</span> <span class="nn">utils</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="c1">#from NDNT.utils import download_file, ensure_dir</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">import</span> <span class="nn">h5py</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">from</span> <span class="nn">NTdatasets.sensory_base</span> <span class="kn">import</span> <span class="n">SensoryBase</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="k">class</span> <span class="nc">MultiDataset</span><span class="p">(</span><span class="n">SensoryBase</span><span class="p">):</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">    MULTIDATASET can load batches from multiple datasets</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">    args specific to this init:</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">        filenames</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">        datadir</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">        num_lags: how many lags back will the presumed model require (for establishing DFs too)</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">    kwargs handled by SensoryBase:</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">        drift_interval: to build drift terms (spacing based on trials)</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">        time_embed: whether to time-embed or not</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">        trial_sample: whether dataset returns time-contiguous trials for each index or individual time points </span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">        device</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>        <span class="n">filenames</span><span class="p">,</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>        <span class="n">datadir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>        <span class="c1">#preload=False,</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>        <span class="n">num_lags</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>        <span class="c1">#time_embed=True,</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>        <span class="c1">#includeMUs=False,</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">        Initialize the MultiDataset class.</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">        Args:</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">            filenames: list of strings of the filenames (without extension) to load</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">            datadir: directory where the data is stored</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">            num_lags: how many lags back will the presumed model require (for establishing DFs too)</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">            time_embed: whether to time-embed or not</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">            trial_sample: whether dataset returns time-contiguous trials for each index or individual time points </span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">            device: device to put the tensors on</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">            preload: whether to load all data into memory at once</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">            includeMUs: whether to include MUs in the dataset</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>        <span class="c1"># call parent constructor</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>            <span class="n">filenames</span><span class="p">,</span> <span class="n">datadir</span><span class="o">=</span><span class="n">datadir</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">num_lags</span><span class="p">,</span> <span class="c1"># default to cut out of each trial block</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>            <span class="c1">#time_embed=time_embed,</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>        <span class="c1">#print( &quot;Loading&quot;, self.datadir + self.filenames)</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>        <span class="c1"># get hdf5 file handles</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">sess</span> <span class="o">+</span> <span class="s1">&#39;.hdf5&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>        <span class="c1"># build index map</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_index</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># which file the block corresponds to</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NTfile</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unit_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>        <span class="c1">#self.includeMUs = include_MUs</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>        <span class="c1">#self.num_units, self.num_sus, self.num_mus = [], [], []</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dims_file</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">):</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>            <span class="n">preload</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: switching preload to True so device argument is meaningful.&quot;</span><span class="p">)</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>        
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>        <span class="c1">#self.preload = preload</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>        <span class="c1">#self.device = device</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>        <span class="c1">#self.NT = 0</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>        <span class="c1">#self.NC = 0</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_assign</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_grouping</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>        <span class="n">nfiles</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trial_size</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">fhandle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">):</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>            <span class="n">NTfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>            <span class="n">NCfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>            <span class="n">NMUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;robsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_SUs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NCfile</span><span class="p">)</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_MUs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NMUfile</span><span class="p">)</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="o">+</span><span class="n">NCfile</span><span class="p">))</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims_file</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>                <span class="n">NCfile</span> <span class="o">+=</span> <span class="n">NMUfile</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">unit_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">NCfile</span><span class="p">)))</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>            
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NCfile</span><span class="p">)</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NTfile</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NTfile</span><span class="p">)</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>            <span class="c1"># Pull blocks from data_filters</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>            <span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">][:,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>            <span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># set invalid first sample</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>            <span class="n">blocks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># set invalid last sample</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>            <span class="n">blockstart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span><span class="o">==-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>            <span class="n">blockend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>            <span class="n">nblocks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">blockstart</span><span class="p">)</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>                <span class="n">trsize_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="p">):</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>                    <span class="n">trsize_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blockend</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">-</span><span class="n">blockstart</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">trial_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">trsize_list</span><span class="p">))</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="p">):</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">file_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">blockstart</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">blockend</span><span class="p">[</span><span class="n">b</span><span class="p">]))</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>            
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>            <span class="c1"># Assign each block to a file</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_assign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_assign</span><span class="p">,</span> <span class="n">nfiles</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">NTfile</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_grouping</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nblocks</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">+=</span> <span class="n">NTfile</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">+=</span> <span class="n">NCfile</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span> <span class="o">+=</span> <span class="n">nblocks</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>            <span class="n">nfiles</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>        <span class="c1"># Set overall dataset variables</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>        <span class="n">NX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dims_file</span><span class="p">))</span> <span class="c1"># assumes they&#39;re all the same</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">NX</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;problems&#39;</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">NX</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span><span class="p">:</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>        <span class="c1"># For now do this without using assemble_stimlus</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>            <span class="n">tcount</span><span class="p">,</span> <span class="n">ccount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">fhandle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">):</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>                <span class="n">NT</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>                <span class="n">NC</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>                <span class="n">trange</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">tcount</span><span class="p">,</span> <span class="n">tcount</span><span class="o">+</span><span class="n">NT</span><span class="p">)</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>                <span class="n">crange</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">ccount</span><span class="p">,</span> <span class="n">ccount</span><span class="o">+</span><span class="n">NC</span><span class="p">)</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>                
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>                <span class="c1"># Stimulus</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span><span class="p">:</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">trange</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>                    <span class="c1"># Time embed stimulus -- simple way</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>                    <span class="c1">#idx = np.arange(NT)</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>                    <span class="c1">#tmp = np.array(self.fhandles[f][&#39;stim&#39;], dtype=&#39;float32&#39;)</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>                    <span class="c1">#self.stim[trange, :] = np.reshape( </span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>                    <span class="c1">#    np.transpose(</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>                    <span class="c1">#        tmp[np.arange(NT)[:,None]-np.arange(self.num_lags), :], </span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>                    <span class="c1">#        [0,2,1]),</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>                    <span class="c1">#    [NT, -1])</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">trange</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embedding</span><span class="p">(</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>                        <span class="n">stim</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">))</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>                <span class="c1"># Robs and DFs</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>                <span class="n">robs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>                <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>                <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">crange</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;robs&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>                <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">crange</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;dfs&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>                    <span class="n">NMU</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;robsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>                    <span class="n">crange</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">ccount</span><span class="o">+</span><span class="n">NC</span><span class="p">,</span> <span class="n">ccount</span><span class="o">+</span><span class="n">NC</span><span class="o">+</span><span class="n">NMU</span><span class="p">)</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>                    <span class="n">NC</span> <span class="o">+=</span> <span class="n">NMU</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>                    <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">crange</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;robsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>                    <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">crange</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;dfsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">trange</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">robs_tmp</span><span class="p">)</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">trange</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dfs_tmp</span><span class="p">)</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>                <span class="n">tcount</span> <span class="o">+=</span> <span class="n">NT</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>                <span class="n">ccount</span> <span class="o">+=</span> <span class="n">NC</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>            <span class="c1"># Convert data to tensor</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">()</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SUs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>        <span class="c1"># Set average rates across dataset (so can be quickly accessed)</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># need to set to None so can will pre-calculate</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avrates</span><span class="p">()</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>        <span class="c1"># Make sure beginning of trial-blocks are not used to fit (with num_lags specified)</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">):</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>        <span class="c1"># Generate drift matrix if selected</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">construct_drift_design_matrix</span><span class="p">()</span> 
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>        <span class="c1"># Set up default cross-validation config</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crossval_setup</span><span class="p">()</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>    <span class="c1"># END MultiDataset.__init__</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>    <span class="k">def</span> <span class="nf">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a><span class="sd">        Convert all data to tensors</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a><span class="sd">        Args:</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a><span class="sd">            device: device to put the tensors on</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a><span class="sd">        Returns:</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a><span class="sd">            None</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>                <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>                <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span> <span class="o">!=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>            <span class="c1"># Simply move to device:</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">to</span><span class="p">(</span> <span class="n">device</span> <span class="p">)</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span> <span class="n">device</span> <span class="p">)</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span> <span class="n">device</span> <span class="p">)</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>    <span class="c1"># END MultiDataset.to_tensor</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a><span class="sd">        Called by the DataLoader to build the batch up one item at a time.</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a><span class="sd">        </span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a><span class="sd">        Args:</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a><span class="sd">            index: index to use for this batch</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a><span class="sd">        </span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="sd">        Returns:</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a><span class="sd">            dictionary of tensors for this batch</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>        <span class="c1"># Convert trials to indices if trial-sample</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_sample</span><span class="p">:</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>                <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span>  <span class="c1"># convert to array</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>            <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_int</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>                <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>                <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>            <span class="n">index</span> <span class="o">=</span> <span class="n">ts</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>            <span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>            <span class="n">robs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>                <span class="n">inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>                <span class="n">NT</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>                <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_index</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="w">                </span><span class="sd">&quot;&quot;&quot; Stim &quot;&quot;&quot;</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>                <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;stim&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="w">                </span><span class="sd">&quot;&quot;&quot; Spikes: needs padding so all are B x NC &quot;&quot;&quot;</span> 
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>                <span class="n">robs_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;robs&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>                <span class="n">NCbefore</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">[:</span><span class="n">f</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>                <span class="n">NCafter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">[</span><span class="n">f</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>                <span class="n">robs_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>                    <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">NCbefore</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>                    <span class="n">robs_tmp</span><span class="p">,</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>                    <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">NCafter</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>                    <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a><span class="w">                </span><span class="sd">&quot;&quot;&quot; Datafilters: needs padding like robs &quot;&quot;&quot;</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>                <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;dfs&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>                <span class="n">dfs_tmp</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># invalidate the filter length</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>                <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>                    <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">NCbefore</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>                    <span class="n">dfs_tmp</span><span class="p">,</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>                    <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">NCafter</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>                    <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>                <span class="n">stim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>                <span class="n">robs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">robs_tmp</span><span class="p">)</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>                <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfs_tmp</span><span class="p">)</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>            <span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">robs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>            <span class="n">cells_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;DATASET: cells_out must be a non-zero length&quot;</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="s2">&quot;DATASET: cells_out must be a non-zero length&quot;</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="n">stim</span><span class="p">,</span> <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="n">robs</span><span class="p">[:,</span> <span class="n">cells_out</span><span class="p">],</span> <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="n">dfs</span><span class="p">[:,</span> <span class="n">cells_out</span><span class="p">]}</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="n">stim</span><span class="p">,</span> <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="n">robs</span><span class="p">,</span> <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="n">dfs</span><span class="p">}</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>        
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Xdrift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>        <span class="k">return</span> <span class="n">out</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>    <span class="c1"># END MultiDataset.__get_item__</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>    
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>    <span class="c1">###### Additional functions that might not be useful yet #####</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>    <span class="k">def</span> <span class="nf">avrates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a><span class="sd">        Calculates average firing probability across specified inds (or whole dataset)</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a><span class="sd">        -- Note will respect datafilters</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a><span class="sd">        -- will return precalc value to save time if already stored</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a><span class="sd">        Args:</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a><span class="sd">            inds: indices to calculate across</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a><span class="sd">        Returns:</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a><span class="sd">            avRs: average firing rates across the dataset</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>            <span class="c1"># then calculate across whole dataset</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avRs</span><span class="p">):</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>                    <span class="c1"># then precalculated and do not need to do</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>        <span class="c1"># Otherwise calculate across all data</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>            <span class="n">Reff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>            <span class="n">Teff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>                    <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span><span class="o">/</span><span class="n">Teff</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">])</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="o">/</span><span class="n">Teff</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Still need to implement avRs without preloading&#39;</span><span class="p">)</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>    <span class="c1"># END MultiDatasset.avrates()</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>    <span class="k">def</span> <span class="nf">subset</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">indxs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a><span class="sd">        Subsets the dataset to only include the specified indices.</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a><span class="sd">        Args:</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a><span class="sd">            indxs: indices to subset the dataset to</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a><span class="sd">            train: whether to subset the training set</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a><span class="sd">            val: whether to subset the validation set</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a><span class="sd">            device: device to put the tensors on</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a><span class="sd">        Returns:</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a><span class="sd">            None</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">,</span> <span class="s2">&quot;Need preloaded data for this to work&quot;</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>        <span class="k">if</span> <span class="n">indxs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>            <span class="k">if</span> <span class="n">train</span><span class="p">:</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>                <span class="k">assert</span> <span class="ow">not</span> <span class="n">val</span><span class="p">,</span> <span class="s2">&quot;Either train or val must be false.&quot;</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>                <span class="n">indxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>                <span class="k">assert</span> <span class="n">val</span><span class="p">,</span> <span class="s2">&quot;Either train or val must be true&quot;</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>                <span class="n">indxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>        
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>        <span class="c1"># Crop all preloaded data down to indices</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">indxs</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">indxs</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">indxs</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indxs</span><span class="p">)</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>    <span class="c1"># End Subset</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>    <span class="k">def</span> <span class="nf">shift_stim_fixation</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a><span class="sd">        Simple shift by integer (rounded shift) and zero padded. Note that this is not in </span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a><span class="sd">        is in units of number of bars, rather than -1 to +1. It assumes the stim</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a><span class="sd">        has a batch dimension (over a fixation), and shifts the whole stim by the same amount.</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a><span class="sd">        </span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a><span class="sd">        Args:</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a><span class="sd">            stim: stimulus tensor to shift</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a><span class="sd">            shift: amount to shift the stimulus by</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a><span class="sd">        Returns:</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a><span class="sd">            shstim: shifted stimulus tensor</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>        <span class="n">sh</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>        <span class="n">shstim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>        <span class="k">if</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="o">-</span><span class="n">sh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="p">:</span><span class="n">sh</span><span class="p">]</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>        <span class="k">elif</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="n">sh</span><span class="p">:]</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>            <span class="n">shstim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>        <span class="k">return</span> <span class="n">shstim</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>    <span class="c1"># END MultiDatasetFix.shift_stim_fixation</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>    <span class="k">def</span> <span class="nf">crossval_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test_set</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a><span class="sd">        This sets the cross-validation indices up We can add featuers here. Many ways to do this</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a><span class="sd">        but will stick to some standard for now. It sets the internal indices, which can be read out</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a><span class="sd">        directly or with helper functions. Perhaps helper_functions is the best way....</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a><span class="sd">        </span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a><span class="sd">        Args:</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a><span class="sd">            folds: number of folds to use for cross-validation</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a><span class="sd">            test_set: whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a><span class="sd">        </span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a><span class="sd">        Returns:</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a><span class="sd">            None: sets internal variables test_inds, train_inds, val_inds</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>        <span class="n">test_fixes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>        <span class="n">tfixes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>        <span class="n">vfixes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_grouping</span><span class="p">)):</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_grouping</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>            <span class="n">vfix1</span><span class="p">,</span> <span class="n">tfix1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>            <span class="k">if</span> <span class="n">test_set</span><span class="p">:</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>                <span class="n">test_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">[</span><span class="n">vfix1</span><span class="p">])</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>                <span class="n">vfix2</span><span class="p">,</span> <span class="n">tfix2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tfix1</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>                <span class="n">vfixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">[</span><span class="n">tfix1</span><span class="p">[</span><span class="n">vfix2</span><span class="p">]])</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>                <span class="n">tfixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">[</span><span class="n">tfix1</span><span class="p">[</span><span class="n">tfix2</span><span class="p">]])</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>                <span class="n">vfixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">[</span><span class="n">vfix1</span><span class="p">])</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>                <span class="n">tfixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">[</span><span class="n">tfix1</span><span class="p">])</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>        <span class="n">val_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vfixes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>        <span class="n">train_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tfixes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>        
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">val_blks</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">train_blks</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="n">test_fixes</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>        <span class="c1"># Assign indexes based on validation by block</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>        <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="n">train_blks</span><span class="p">:</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">])</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>        <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="n">val_blks</span><span class="p">:</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">])</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>        <span class="k">if</span> <span class="n">test_set</span><span class="p">:</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>            <span class="n">test_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_fixes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="n">test_blks</span><span class="p">:</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">])</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>        <span class="c1"># finally convert to np.array</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">)</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">)</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span><span class="p">)</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>    <span class="c1"># END MultiDatasetFix.crossval_setup</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>    <span class="k">def</span> <span class="nf">fold_sample</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a><span class="sd">        This really should be a general method not associated with self.</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a><span class="sd">        </span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a><span class="sd">        Args:</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a><span class="sd">            num_items: number of items to fold</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a><span class="sd">            folds: number of folds to use</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a><span class="sd">        Returns:</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a><span class="sd">            val_items: indices for the validation set</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a><span class="sd">            rem_items: indices for the remaining set</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>        <span class="k">if</span> <span class="n">random_gen</span><span class="p">:</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>            <span class="n">num_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_items</span><span class="o">/</span><span class="n">folds</span><span class="p">)</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>            <span class="n">tmp_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">num_items</span><span class="p">)</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[:</span><span class="n">num_val</span><span class="p">])</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[</span><span class="n">num_val</span><span class="p">:])</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>            <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">folds</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">),</span> <span class="n">val_items</span><span class="p">)</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>        <span class="k">return</span> <span class="n">val_items</span><span class="p">,</span> <span class="n">rem_items</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>    <span class="k">def</span> <span class="nf">collate_blocks</span><span class="p">(</span> <span class="n">data</span> <span class="p">):</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Alternative to the collate function that attaches blocks labeled by one index together</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a><span class="sd">        To explain: if you ask for one index (of a block) from the dataset like [1] and get back </span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a><span class="sd">        a block of data (B x M), the default collate_fn will still treat this as one data sample </span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a><span class="sd">        (1 x B x M) rather than the B data samples in the block. This is a simple flatten...</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a><span class="sd">        Note: assumes that this is getting a dictionary, of course&quot;&quot;&quot;</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>        <span class="c1">#print(len(data))</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>        <span class="n">data_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>            <span class="k">for</span> <span class="n">dsub</span> <span class="ow">in</span> <span class="n">data_out</span><span class="p">:</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>                <span class="n">data_out</span><span class="p">[</span><span class="n">dsub</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span> <span class="p">(</span><span class="n">data_out</span><span class="p">[</span><span class="n">dsub</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">dsub</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>            <span class="c1"># if trainer concatentates batches incorrectly --- this is a kluge</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>            <span class="c1"># if len(data[dsub].shape) &gt; 2:  # more general without this &#39;if&#39;, assuming above</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>            <span class="c1">#print(dsub)</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>            <span class="c1">#print(data[dsub].shape)</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>            <span class="c1">#data[dsub] = data[dsub].flatten(end_dim=1) </span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>        <span class="k">return</span> <span class="n">data</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a><span class="k">def</span> <span class="nf">get_stim_url</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a><span class="sd">    Get the stimulus URL for the specified experiment ID.</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a><span class="sd">    Args:</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a><span class="sd">        id: experiment ID</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a><span class="sd">    Returns:</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a><span class="sd">        URL for the specified experiment ID</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>    <span class="n">urlpath</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>            <span class="s1">&#39;expt01&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/mn70kyohmp3kjnl/expt01.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>            <span class="s1">&#39;expt02&#39;</span><span class="p">:</span><span class="s1">&#39;https://www.dropbox.com/s/pods4w89tbu2x57/expt02.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>            <span class="s1">&#39;expt03&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/p08375vcunrf9rh/expt03.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>            <span class="s1">&#39;expt04&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/zs1vcaz3sm01ncn/expt04.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>            <span class="s1">&#39;expt05&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/f3mpp3mlsrhof8k/expt05.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>            <span class="s1">&#39;expt06&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/saqjo7yibc6y8ut/expt06.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>            <span class="s1">&#39;expt07&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/op0rw7obzfvnm53/expt07.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>            <span class="s1">&#39;expt08&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/fwmtdegmlcdk9wo/expt08.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>            <span class="s1">&#39;expt09&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/yo8xo58ldiyrktm/expt09.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>            <span class="s1">&#39;expt10&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/k2zldzv7zfe7x06/expt10.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>            <span class="s1">&#39;expt11&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/rsc7h4njqntts39/expt11.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>            <span class="s1">&#39;expt12&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/yf1mm805j53yaj2/expt12.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>            <span class="s1">&#39;expt13&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/gidll8bgg5uie8h/expt13.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>            <span class="s1">&#39;expt14&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/kfof5m08g1v3rfe/expt14.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>            <span class="s1">&#39;expt15&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/zpcc7a2iy9bmkjd/expt15.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>            <span class="s1">&#39;expt16&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/b19kwdwy18d14hl/expt16.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>        <span class="p">}</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>    
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>    <span class="k">if</span> <span class="nb">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">urlpath</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Stimulus URL not found&#39;</span><span class="p">)</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>    
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>    <span class="k">return</span> <span class="n">urlpath</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a><span class="k">def</span> <span class="nf">download_set</span><span class="p">(</span><span class="n">sessname</span><span class="p">,</span> <span class="n">fpath</span><span class="p">):</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a><span class="sd">    Download the specified data set.</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a><span class="sd">    Args:</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a><span class="sd">        sessname: name of the session</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a><span class="sd">        fpath: path to save the data set</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a><span class="sd">    Returns:</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a><span class="sd">        None</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>    <span class="n">ensure_dir</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>    <span class="c1"># Download the data set</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>    <span class="n">url</span> <span class="o">=</span> <span class="n">get_stim_url</span><span class="p">(</span><span class="n">sessname</span><span class="p">)</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>    <span class="n">fout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">sessname</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span><span class="p">)</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>    <span class="n">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">fout</span><span class="p">)</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a><span class="c1"># --- Define data-helpers</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a><span class="k">def</span> <span class="nf">time_in_blocks</span><span class="p">(</span><span class="n">block_inds</span><span class="p">):</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a><span class="sd">    Calculate the total time in blocks.</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a><span class="sd">    Args:</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a><span class="sd">        block_inds: block indices</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a><span class="sd">    Returns:</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a><span class="sd">        total time in blocks</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>    <span class="n">num_blocks</span> <span class="o">=</span> <span class="n">block_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>    <span class="c1">#print( &quot;%d number of blocks.&quot; %num_blocks)</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>    <span class="n">NT</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>    <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_blocks</span><span class="p">):</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>        <span class="n">NT</span> <span class="o">+=</span> <span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>    <span class="k">return</span> <span class="n">NT</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a><span class="k">def</span> <span class="nf">make_block_inds</span><span class="p">(</span> <span class="n">block_lims</span><span class="p">,</span> <span class="n">gap</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">separate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a><span class="sd">    Make block indices from block limits.</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a><span class="sd">    Args:</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a><span class="sd">        block_lims: block limits</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a><span class="sd">        gap: gap between blocks</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a><span class="sd">        separate: whether to separate the blocks</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a><span class="sd">    Returns:</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a><span class="sd">        block indices</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>    <span class="n">block_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>    <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">block_lims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>        <span class="k">if</span> <span class="n">separate</span><span class="p">:</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>            <span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">block_lims</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">gap</span><span class="p">,</span> <span class="n">block_lims</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>            <span class="n">block_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> 
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>                <span class="p">(</span><span class="n">block_inds</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">block_lims</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">gap</span><span class="p">,</span> <span class="n">block_lims</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>    <span class="k">return</span> <span class="n">block_inds</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a><span class="k">def</span> <span class="nf">monocular_data_import</span><span class="p">(</span> <span class="n">datadir</span><span class="p">,</span> <span class="n">exptn</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="mi">20</span> <span class="p">):</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a><span class="sd">    Import monocular data.</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a><span class="sd">    Args:</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a><span class="sd">        datadir: directory where the data is stored</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a><span class="sd">        exptn: experiment name</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a><span class="sd">        num_lags: number of lags</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a><span class="sd">    Returns:</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a><span class="sd">        stim_all: stimulus</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a><span class="sd">        Robs_all: response</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a><span class="sd">        DFs_all: data filters</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a><span class="sd">        Eadd_info: additional information</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>    <span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>    <span class="n">time_shift</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>    <span class="n">filename</span> <span class="o">=</span> <span class="n">exptn</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>    <span class="n">matdata</span> <span class="o">=</span> <span class="n">sio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>    <span class="n">sus</span> <span class="o">=</span> <span class="n">matdata</span><span class="p">[</span><span class="s1">&#39;goodSUs&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># switch from matlab indexing</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SUs:&#39;</span><span class="p">,</span> <span class="n">sus</span><span class="p">)</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>    <span class="n">NC</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sus</span><span class="p">)</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>    <span class="n">layers</span> <span class="o">=</span> <span class="n">matdata</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:]</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>    <span class="n">block_list</span> <span class="o">=</span> <span class="n">matdata</span><span class="p">[</span><span class="s1">&#39;block_inds&#39;</span><span class="p">]</span> <span class="c1"># note matlab indexing</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>    <span class="n">stim_all</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">shift_mat_zpad</span><span class="p">(</span><span class="n">matdata</span><span class="p">[</span><span class="s1">&#39;stimulus&#39;</span><span class="p">],</span> <span class="n">time_shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>    <span class="n">NTtot</span><span class="p">,</span> <span class="n">NX</span> <span class="o">=</span> <span class="n">stim_all</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>    <span class="n">DFs_all</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">matdata</span><span class="p">[</span><span class="s1">&#39;data_filters&#39;</span><span class="p">][:,</span><span class="n">sus</span><span class="p">])</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>    <span class="n">Robs_all</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">matdata</span><span class="p">[</span><span class="s1">&#39;binned_SU&#39;</span><span class="p">][:,</span><span class="n">sus</span><span class="p">])</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>    
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>    <span class="c1"># Break up into train and test blocks</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>    <span class="c1"># Assemble train and test indices based on BIlist</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>    <span class="n">NBL</span> <span class="o">=</span> <span class="n">block_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>    <span class="n">Xb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">NBL</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># Every fifth trial is cross-validation</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>    <span class="n">Ub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">NBL</span><span class="p">)))</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">Xb</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>    
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>    <span class="n">used_inds</span> <span class="o">=</span> <span class="n">make_block_inds</span><span class="p">(</span> <span class="n">block_list</span><span class="p">,</span> <span class="n">gap</span><span class="o">=</span><span class="n">num_lags</span> <span class="p">)</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>    <span class="n">Ui</span><span class="p">,</span> <span class="n">Xi</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">generate_xv_folds</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">used_inds</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>    <span class="n">TRinds</span><span class="p">,</span> <span class="n">TEinds</span> <span class="o">=</span> <span class="n">used_inds</span><span class="p">[</span><span class="n">Ui</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">used_inds</span><span class="p">[</span><span class="n">Xi</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>    <span class="n">Eadd_info</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>        <span class="s1">&#39;cortical_layer&#39;</span><span class="p">:</span><span class="n">layers</span><span class="p">,</span> <span class="s1">&#39;used_inds&#39;</span><span class="p">:</span> <span class="n">used_inds</span><span class="p">,</span> 
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>        <span class="s1">&#39;TRinds&#39;</span><span class="p">:</span><span class="n">TRinds</span><span class="p">,</span> <span class="s1">&#39;TEinds&#39;</span><span class="p">:</span> <span class="n">TEinds</span><span class="p">,</span> <span class="c1">#&#39;TRinds&#39;: Ui, &#39;TEinds&#39;: Xi, </span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>        <span class="s1">&#39;block_list&#39;</span><span class="p">:</span> <span class="n">block_list</span><span class="p">,</span> <span class="s1">&#39;TRblocks&#39;</span><span class="p">:</span> <span class="n">Ub</span><span class="p">,</span> <span class="s1">&#39;TEblocks&#39;</span><span class="p">:</span> <span class="n">Xb</span><span class="p">}</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>    <span class="k">return</span> <span class="n">stim_all</span><span class="p">,</span> <span class="n">Robs_all</span><span class="p">,</span> <span class="n">DFs_all</span><span class="p">,</span> <span class="n">Eadd_info</span>
</span></pre></div>


            </section>
                <section id="MultiDataset">
                            <input id="MultiDataset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MultiDataset</span><wbr>(<span class="base">typing.Generic[+T_co]</span>):

                <label class="view-source-button" for="MultiDataset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiDataset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiDataset-18"><a href="#MultiDataset-18"><span class="linenos"> 18</span></a><span class="k">class</span> <span class="nc">MultiDataset</span><span class="p">(</span><span class="n">SensoryBase</span><span class="p">):</span>
</span><span id="MultiDataset-19"><a href="#MultiDataset-19"><span class="linenos"> 19</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiDataset-20"><a href="#MultiDataset-20"><span class="linenos"> 20</span></a><span class="sd">    MULTIDATASET can load batches from multiple datasets</span>
</span><span id="MultiDataset-21"><a href="#MultiDataset-21"><span class="linenos"> 21</span></a>
</span><span id="MultiDataset-22"><a href="#MultiDataset-22"><span class="linenos"> 22</span></a><span class="sd">    args specific to this init:</span>
</span><span id="MultiDataset-23"><a href="#MultiDataset-23"><span class="linenos"> 23</span></a><span class="sd">        filenames</span>
</span><span id="MultiDataset-24"><a href="#MultiDataset-24"><span class="linenos"> 24</span></a><span class="sd">        datadir</span>
</span><span id="MultiDataset-25"><a href="#MultiDataset-25"><span class="linenos"> 25</span></a><span class="sd">        num_lags: how many lags back will the presumed model require (for establishing DFs too)</span>
</span><span id="MultiDataset-26"><a href="#MultiDataset-26"><span class="linenos"> 26</span></a><span class="sd">    kwargs handled by SensoryBase:</span>
</span><span id="MultiDataset-27"><a href="#MultiDataset-27"><span class="linenos"> 27</span></a><span class="sd">        drift_interval: to build drift terms (spacing based on trials)</span>
</span><span id="MultiDataset-28"><a href="#MultiDataset-28"><span class="linenos"> 28</span></a><span class="sd">        time_embed: whether to time-embed or not</span>
</span><span id="MultiDataset-29"><a href="#MultiDataset-29"><span class="linenos"> 29</span></a><span class="sd">        trial_sample: whether dataset returns time-contiguous trials for each index or individual time points </span>
</span><span id="MultiDataset-30"><a href="#MultiDataset-30"><span class="linenos"> 30</span></a><span class="sd">        device</span>
</span><span id="MultiDataset-31"><a href="#MultiDataset-31"><span class="linenos"> 31</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="MultiDataset-32"><a href="#MultiDataset-32"><span class="linenos"> 32</span></a>
</span><span id="MultiDataset-33"><a href="#MultiDataset-33"><span class="linenos"> 33</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="MultiDataset-34"><a href="#MultiDataset-34"><span class="linenos"> 34</span></a>        <span class="n">filenames</span><span class="p">,</span>
</span><span id="MultiDataset-35"><a href="#MultiDataset-35"><span class="linenos"> 35</span></a>        <span class="n">datadir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MultiDataset-36"><a href="#MultiDataset-36"><span class="linenos"> 36</span></a>        <span class="c1">#preload=False,</span>
</span><span id="MultiDataset-37"><a href="#MultiDataset-37"><span class="linenos"> 37</span></a>        <span class="n">num_lags</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="MultiDataset-38"><a href="#MultiDataset-38"><span class="linenos"> 38</span></a>        <span class="c1">#time_embed=True,</span>
</span><span id="MultiDataset-39"><a href="#MultiDataset-39"><span class="linenos"> 39</span></a>        <span class="c1">#includeMUs=False,</span>
</span><span id="MultiDataset-40"><a href="#MultiDataset-40"><span class="linenos"> 40</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="MultiDataset-41"><a href="#MultiDataset-41"><span class="linenos"> 41</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiDataset-42"><a href="#MultiDataset-42"><span class="linenos"> 42</span></a><span class="sd">        Initialize the MultiDataset class.</span>
</span><span id="MultiDataset-43"><a href="#MultiDataset-43"><span class="linenos"> 43</span></a>
</span><span id="MultiDataset-44"><a href="#MultiDataset-44"><span class="linenos"> 44</span></a><span class="sd">        Args:</span>
</span><span id="MultiDataset-45"><a href="#MultiDataset-45"><span class="linenos"> 45</span></a><span class="sd">            filenames: list of strings of the filenames (without extension) to load</span>
</span><span id="MultiDataset-46"><a href="#MultiDataset-46"><span class="linenos"> 46</span></a><span class="sd">            datadir: directory where the data is stored</span>
</span><span id="MultiDataset-47"><a href="#MultiDataset-47"><span class="linenos"> 47</span></a><span class="sd">            num_lags: how many lags back will the presumed model require (for establishing DFs too)</span>
</span><span id="MultiDataset-48"><a href="#MultiDataset-48"><span class="linenos"> 48</span></a><span class="sd">            time_embed: whether to time-embed or not</span>
</span><span id="MultiDataset-49"><a href="#MultiDataset-49"><span class="linenos"> 49</span></a><span class="sd">            trial_sample: whether dataset returns time-contiguous trials for each index or individual time points </span>
</span><span id="MultiDataset-50"><a href="#MultiDataset-50"><span class="linenos"> 50</span></a><span class="sd">            device: device to put the tensors on</span>
</span><span id="MultiDataset-51"><a href="#MultiDataset-51"><span class="linenos"> 51</span></a><span class="sd">            preload: whether to load all data into memory at once</span>
</span><span id="MultiDataset-52"><a href="#MultiDataset-52"><span class="linenos"> 52</span></a><span class="sd">            includeMUs: whether to include MUs in the dataset</span>
</span><span id="MultiDataset-53"><a href="#MultiDataset-53"><span class="linenos"> 53</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiDataset-54"><a href="#MultiDataset-54"><span class="linenos"> 54</span></a>
</span><span id="MultiDataset-55"><a href="#MultiDataset-55"><span class="linenos"> 55</span></a>        <span class="c1"># call parent constructor</span>
</span><span id="MultiDataset-56"><a href="#MultiDataset-56"><span class="linenos"> 56</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="MultiDataset-57"><a href="#MultiDataset-57"><span class="linenos"> 57</span></a>            <span class="n">filenames</span><span class="p">,</span> <span class="n">datadir</span><span class="o">=</span><span class="n">datadir</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">num_lags</span><span class="p">,</span> <span class="c1"># default to cut out of each trial block</span>
</span><span id="MultiDataset-58"><a href="#MultiDataset-58"><span class="linenos"> 58</span></a>            <span class="c1">#time_embed=time_embed,</span>
</span><span id="MultiDataset-59"><a href="#MultiDataset-59"><span class="linenos"> 59</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="MultiDataset-60"><a href="#MultiDataset-60"><span class="linenos"> 60</span></a>        <span class="c1">#print( &quot;Loading&quot;, self.datadir + self.filenames)</span>
</span><span id="MultiDataset-61"><a href="#MultiDataset-61"><span class="linenos"> 61</span></a>
</span><span id="MultiDataset-62"><a href="#MultiDataset-62"><span class="linenos"> 62</span></a>        <span class="c1"># get hdf5 file handles</span>
</span><span id="MultiDataset-63"><a href="#MultiDataset-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">sess</span> <span class="o">+</span> <span class="s1">&#39;.hdf5&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>
</span><span id="MultiDataset-64"><a href="#MultiDataset-64"><span class="linenos"> 64</span></a>
</span><span id="MultiDataset-65"><a href="#MultiDataset-65"><span class="linenos"> 65</span></a>        <span class="c1"># build index map</span>
</span><span id="MultiDataset-66"><a href="#MultiDataset-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_index</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># which file the block corresponds to</span>
</span><span id="MultiDataset-67"><a href="#MultiDataset-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset-68"><a href="#MultiDataset-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NTfile</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset-69"><a href="#MultiDataset-69"><span class="linenos"> 69</span></a>
</span><span id="MultiDataset-70"><a href="#MultiDataset-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unit_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset-71"><a href="#MultiDataset-71"><span class="linenos"> 71</span></a>        <span class="c1">#self.includeMUs = include_MUs</span>
</span><span id="MultiDataset-72"><a href="#MultiDataset-72"><span class="linenos"> 72</span></a>        <span class="c1">#self.num_units, self.num_sus, self.num_mus = [], [], []</span>
</span><span id="MultiDataset-73"><a href="#MultiDataset-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dims_file</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset-74"><a href="#MultiDataset-74"><span class="linenos"> 74</span></a>
</span><span id="MultiDataset-75"><a href="#MultiDataset-75"><span class="linenos"> 75</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">):</span>
</span><span id="MultiDataset-76"><a href="#MultiDataset-76"><span class="linenos"> 76</span></a>            <span class="n">preload</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="MultiDataset-77"><a href="#MultiDataset-77"><span class="linenos"> 77</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: switching preload to True so device argument is meaningful.&quot;</span><span class="p">)</span>
</span><span id="MultiDataset-78"><a href="#MultiDataset-78"><span class="linenos"> 78</span></a>        
</span><span id="MultiDataset-79"><a href="#MultiDataset-79"><span class="linenos"> 79</span></a>        <span class="c1">#self.preload = preload</span>
</span><span id="MultiDataset-80"><a href="#MultiDataset-80"><span class="linenos"> 80</span></a>        <span class="c1">#self.device = device</span>
</span><span id="MultiDataset-81"><a href="#MultiDataset-81"><span class="linenos"> 81</span></a>
</span><span id="MultiDataset-82"><a href="#MultiDataset-82"><span class="linenos"> 82</span></a>        <span class="c1">#self.NT = 0</span>
</span><span id="MultiDataset-83"><a href="#MultiDataset-83"><span class="linenos"> 83</span></a>        <span class="c1">#self.NC = 0</span>
</span><span id="MultiDataset-84"><a href="#MultiDataset-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiDataset-85"><a href="#MultiDataset-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_assign</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset-86"><a href="#MultiDataset-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_grouping</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset-87"><a href="#MultiDataset-87"><span class="linenos"> 87</span></a>        <span class="n">nfiles</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiDataset-88"><a href="#MultiDataset-88"><span class="linenos"> 88</span></a>
</span><span id="MultiDataset-89"><a href="#MultiDataset-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trial_size</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MultiDataset-90"><a href="#MultiDataset-90"><span class="linenos"> 90</span></a>
</span><span id="MultiDataset-91"><a href="#MultiDataset-91"><span class="linenos"> 91</span></a>        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">fhandle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">):</span>
</span><span id="MultiDataset-92"><a href="#MultiDataset-92"><span class="linenos"> 92</span></a>            <span class="n">NTfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiDataset-93"><a href="#MultiDataset-93"><span class="linenos"> 93</span></a>            <span class="n">NCfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiDataset-94"><a href="#MultiDataset-94"><span class="linenos"> 94</span></a>            <span class="n">NMUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;robsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiDataset-95"><a href="#MultiDataset-95"><span class="linenos"> 95</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_SUs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NCfile</span><span class="p">)</span>
</span><span id="MultiDataset-96"><a href="#MultiDataset-96"><span class="linenos"> 96</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_MUs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NMUfile</span><span class="p">)</span>
</span><span id="MultiDataset-97"><a href="#MultiDataset-97"><span class="linenos"> 97</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="o">+</span><span class="n">NCfile</span><span class="p">))</span>
</span><span id="MultiDataset-98"><a href="#MultiDataset-98"><span class="linenos"> 98</span></a>
</span><span id="MultiDataset-99"><a href="#MultiDataset-99"><span class="linenos"> 99</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims_file</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="MultiDataset-100"><a href="#MultiDataset-100"><span class="linenos">100</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="MultiDataset-101"><a href="#MultiDataset-101"><span class="linenos">101</span></a>                <span class="n">NCfile</span> <span class="o">+=</span> <span class="n">NMUfile</span>
</span><span id="MultiDataset-102"><a href="#MultiDataset-102"><span class="linenos">102</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">unit_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">NCfile</span><span class="p">)))</span>
</span><span id="MultiDataset-103"><a href="#MultiDataset-103"><span class="linenos">103</span></a>            
</span><span id="MultiDataset-104"><a href="#MultiDataset-104"><span class="linenos">104</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NCfile</span><span class="p">)</span>
</span><span id="MultiDataset-105"><a href="#MultiDataset-105"><span class="linenos">105</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NTfile</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NTfile</span><span class="p">)</span>
</span><span id="MultiDataset-106"><a href="#MultiDataset-106"><span class="linenos">106</span></a>
</span><span id="MultiDataset-107"><a href="#MultiDataset-107"><span class="linenos">107</span></a>            <span class="c1"># Pull blocks from data_filters</span>
</span><span id="MultiDataset-108"><a href="#MultiDataset-108"><span class="linenos">108</span></a>            <span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">][:,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiDataset-109"><a href="#MultiDataset-109"><span class="linenos">109</span></a>            <span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># set invalid first sample</span>
</span><span id="MultiDataset-110"><a href="#MultiDataset-110"><span class="linenos">110</span></a>            <span class="n">blocks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># set invalid last sample</span>
</span><span id="MultiDataset-111"><a href="#MultiDataset-111"><span class="linenos">111</span></a>
</span><span id="MultiDataset-112"><a href="#MultiDataset-112"><span class="linenos">112</span></a>            <span class="n">blockstart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span><span class="o">==-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiDataset-113"><a href="#MultiDataset-113"><span class="linenos">113</span></a>            <span class="n">blockend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiDataset-114"><a href="#MultiDataset-114"><span class="linenos">114</span></a>            <span class="n">nblocks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">blockstart</span><span class="p">)</span>
</span><span id="MultiDataset-115"><a href="#MultiDataset-115"><span class="linenos">115</span></a>
</span><span id="MultiDataset-116"><a href="#MultiDataset-116"><span class="linenos">116</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiDataset-117"><a href="#MultiDataset-117"><span class="linenos">117</span></a>                <span class="n">trsize_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset-118"><a href="#MultiDataset-118"><span class="linenos">118</span></a>                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="p">):</span>
</span><span id="MultiDataset-119"><a href="#MultiDataset-119"><span class="linenos">119</span></a>                    <span class="n">trsize_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blockend</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">-</span><span class="n">blockstart</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
</span><span id="MultiDataset-120"><a href="#MultiDataset-120"><span class="linenos">120</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">trial_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">trsize_list</span><span class="p">))</span>
</span><span id="MultiDataset-121"><a href="#MultiDataset-121"><span class="linenos">121</span></a>
</span><span id="MultiDataset-122"><a href="#MultiDataset-122"><span class="linenos">122</span></a>            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="p">):</span>
</span><span id="MultiDataset-123"><a href="#MultiDataset-123"><span class="linenos">123</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">file_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="MultiDataset-124"><a href="#MultiDataset-124"><span class="linenos">124</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">blockstart</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">blockend</span><span class="p">[</span><span class="n">b</span><span class="p">]))</span>
</span><span id="MultiDataset-125"><a href="#MultiDataset-125"><span class="linenos">125</span></a>            
</span><span id="MultiDataset-126"><a href="#MultiDataset-126"><span class="linenos">126</span></a>            <span class="c1"># Assign each block to a file</span>
</span><span id="MultiDataset-127"><a href="#MultiDataset-127"><span class="linenos">127</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_assign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
</span><span id="MultiDataset-128"><a href="#MultiDataset-128"><span class="linenos">128</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_assign</span><span class="p">,</span> <span class="n">nfiles</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">NTfile</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MultiDataset-129"><a href="#MultiDataset-129"><span class="linenos">129</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_grouping</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nblocks</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="p">)</span>
</span><span id="MultiDataset-130"><a href="#MultiDataset-130"><span class="linenos">130</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">+=</span> <span class="n">NTfile</span>
</span><span id="MultiDataset-131"><a href="#MultiDataset-131"><span class="linenos">131</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">+=</span> <span class="n">NCfile</span>
</span><span id="MultiDataset-132"><a href="#MultiDataset-132"><span class="linenos">132</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span> <span class="o">+=</span> <span class="n">nblocks</span>
</span><span id="MultiDataset-133"><a href="#MultiDataset-133"><span class="linenos">133</span></a>            <span class="n">nfiles</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MultiDataset-134"><a href="#MultiDataset-134"><span class="linenos">134</span></a>
</span><span id="MultiDataset-135"><a href="#MultiDataset-135"><span class="linenos">135</span></a>        <span class="c1"># Set overall dataset variables</span>
</span><span id="MultiDataset-136"><a href="#MultiDataset-136"><span class="linenos">136</span></a>        <span class="n">NX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dims_file</span><span class="p">))</span> <span class="c1"># assumes they&#39;re all the same</span>
</span><span id="MultiDataset-137"><a href="#MultiDataset-137"><span class="linenos">137</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">NX</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;problems&#39;</span>
</span><span id="MultiDataset-138"><a href="#MultiDataset-138"><span class="linenos">138</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">NX</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="MultiDataset-139"><a href="#MultiDataset-139"><span class="linenos">139</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span><span class="p">:</span>
</span><span id="MultiDataset-140"><a href="#MultiDataset-140"><span class="linenos">140</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="MultiDataset-141"><a href="#MultiDataset-141"><span class="linenos">141</span></a>        <span class="c1"># For now do this without using assemble_stimlus</span>
</span><span id="MultiDataset-142"><a href="#MultiDataset-142"><span class="linenos">142</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</span><span id="MultiDataset-143"><a href="#MultiDataset-143"><span class="linenos">143</span></a>
</span><span id="MultiDataset-144"><a href="#MultiDataset-144"><span class="linenos">144</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="MultiDataset-145"><a href="#MultiDataset-145"><span class="linenos">145</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiDataset-146"><a href="#MultiDataset-146"><span class="linenos">146</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiDataset-147"><a href="#MultiDataset-147"><span class="linenos">147</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiDataset-148"><a href="#MultiDataset-148"><span class="linenos">148</span></a>            <span class="n">tcount</span><span class="p">,</span> <span class="n">ccount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="MultiDataset-149"><a href="#MultiDataset-149"><span class="linenos">149</span></a>            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">fhandle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">):</span>
</span><span id="MultiDataset-150"><a href="#MultiDataset-150"><span class="linenos">150</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>
</span><span id="MultiDataset-151"><a href="#MultiDataset-151"><span class="linenos">151</span></a>                <span class="n">NT</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiDataset-152"><a href="#MultiDataset-152"><span class="linenos">152</span></a>                <span class="n">NC</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiDataset-153"><a href="#MultiDataset-153"><span class="linenos">153</span></a>                <span class="n">trange</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">tcount</span><span class="p">,</span> <span class="n">tcount</span><span class="o">+</span><span class="n">NT</span><span class="p">)</span>
</span><span id="MultiDataset-154"><a href="#MultiDataset-154"><span class="linenos">154</span></a>                <span class="n">crange</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">ccount</span><span class="p">,</span> <span class="n">ccount</span><span class="o">+</span><span class="n">NC</span><span class="p">)</span>
</span><span id="MultiDataset-155"><a href="#MultiDataset-155"><span class="linenos">155</span></a>                
</span><span id="MultiDataset-156"><a href="#MultiDataset-156"><span class="linenos">156</span></a>                <span class="c1"># Stimulus</span>
</span><span id="MultiDataset-157"><a href="#MultiDataset-157"><span class="linenos">157</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span><span class="p">:</span>
</span><span id="MultiDataset-158"><a href="#MultiDataset-158"><span class="linenos">158</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">trange</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="MultiDataset-159"><a href="#MultiDataset-159"><span class="linenos">159</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiDataset-160"><a href="#MultiDataset-160"><span class="linenos">160</span></a>                    <span class="c1"># Time embed stimulus -- simple way</span>
</span><span id="MultiDataset-161"><a href="#MultiDataset-161"><span class="linenos">161</span></a>                    <span class="c1">#idx = np.arange(NT)</span>
</span><span id="MultiDataset-162"><a href="#MultiDataset-162"><span class="linenos">162</span></a>                    <span class="c1">#tmp = np.array(self.fhandles[f][&#39;stim&#39;], dtype=&#39;float32&#39;)</span>
</span><span id="MultiDataset-163"><a href="#MultiDataset-163"><span class="linenos">163</span></a>                    <span class="c1">#self.stim[trange, :] = np.reshape( </span>
</span><span id="MultiDataset-164"><a href="#MultiDataset-164"><span class="linenos">164</span></a>                    <span class="c1">#    np.transpose(</span>
</span><span id="MultiDataset-165"><a href="#MultiDataset-165"><span class="linenos">165</span></a>                    <span class="c1">#        tmp[np.arange(NT)[:,None]-np.arange(self.num_lags), :], </span>
</span><span id="MultiDataset-166"><a href="#MultiDataset-166"><span class="linenos">166</span></a>                    <span class="c1">#        [0,2,1]),</span>
</span><span id="MultiDataset-167"><a href="#MultiDataset-167"><span class="linenos">167</span></a>                    <span class="c1">#    [NT, -1])</span>
</span><span id="MultiDataset-168"><a href="#MultiDataset-168"><span class="linenos">168</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">trange</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embedding</span><span class="p">(</span>
</span><span id="MultiDataset-169"><a href="#MultiDataset-169"><span class="linenos">169</span></a>                        <span class="n">stim</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">))</span>
</span><span id="MultiDataset-170"><a href="#MultiDataset-170"><span class="linenos">170</span></a>
</span><span id="MultiDataset-171"><a href="#MultiDataset-171"><span class="linenos">171</span></a>                <span class="c1"># Robs and DFs</span>
</span><span id="MultiDataset-172"><a href="#MultiDataset-172"><span class="linenos">172</span></a>                <span class="n">robs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiDataset-173"><a href="#MultiDataset-173"><span class="linenos">173</span></a>                <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiDataset-174"><a href="#MultiDataset-174"><span class="linenos">174</span></a>                <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">crange</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;robs&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="MultiDataset-175"><a href="#MultiDataset-175"><span class="linenos">175</span></a>                <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">crange</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;dfs&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="MultiDataset-176"><a href="#MultiDataset-176"><span class="linenos">176</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="MultiDataset-177"><a href="#MultiDataset-177"><span class="linenos">177</span></a>                    <span class="n">NMU</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;robsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiDataset-178"><a href="#MultiDataset-178"><span class="linenos">178</span></a>                    <span class="n">crange</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">ccount</span><span class="o">+</span><span class="n">NC</span><span class="p">,</span> <span class="n">ccount</span><span class="o">+</span><span class="n">NC</span><span class="o">+</span><span class="n">NMU</span><span class="p">)</span>
</span><span id="MultiDataset-179"><a href="#MultiDataset-179"><span class="linenos">179</span></a>                    <span class="n">NC</span> <span class="o">+=</span> <span class="n">NMU</span>
</span><span id="MultiDataset-180"><a href="#MultiDataset-180"><span class="linenos">180</span></a>                    <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">crange</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;robsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="MultiDataset-181"><a href="#MultiDataset-181"><span class="linenos">181</span></a>                    <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">crange</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;dfsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="MultiDataset-182"><a href="#MultiDataset-182"><span class="linenos">182</span></a>
</span><span id="MultiDataset-183"><a href="#MultiDataset-183"><span class="linenos">183</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">trange</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">robs_tmp</span><span class="p">)</span>
</span><span id="MultiDataset-184"><a href="#MultiDataset-184"><span class="linenos">184</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">trange</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dfs_tmp</span><span class="p">)</span>
</span><span id="MultiDataset-185"><a href="#MultiDataset-185"><span class="linenos">185</span></a>                <span class="n">tcount</span> <span class="o">+=</span> <span class="n">NT</span>
</span><span id="MultiDataset-186"><a href="#MultiDataset-186"><span class="linenos">186</span></a>                <span class="n">ccount</span> <span class="o">+=</span> <span class="n">NC</span>
</span><span id="MultiDataset-187"><a href="#MultiDataset-187"><span class="linenos">187</span></a>
</span><span id="MultiDataset-188"><a href="#MultiDataset-188"><span class="linenos">188</span></a>            <span class="c1"># Convert data to tensor</span>
</span><span id="MultiDataset-189"><a href="#MultiDataset-189"><span class="linenos">189</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">()</span>
</span><span id="MultiDataset-190"><a href="#MultiDataset-190"><span class="linenos">190</span></a>
</span><span id="MultiDataset-191"><a href="#MultiDataset-191"><span class="linenos">191</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SUs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiDataset-192"><a href="#MultiDataset-192"><span class="linenos">192</span></a>        <span class="c1"># Set average rates across dataset (so can be quickly accessed)</span>
</span><span id="MultiDataset-193"><a href="#MultiDataset-193"><span class="linenos">193</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># need to set to None so can will pre-calculate</span>
</span><span id="MultiDataset-194"><a href="#MultiDataset-194"><span class="linenos">194</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avrates</span><span class="p">()</span>
</span><span id="MultiDataset-195"><a href="#MultiDataset-195"><span class="linenos">195</span></a>
</span><span id="MultiDataset-196"><a href="#MultiDataset-196"><span class="linenos">196</span></a>        <span class="c1"># Make sure beginning of trial-blocks are not used to fit (with num_lags specified)</span>
</span><span id="MultiDataset-197"><a href="#MultiDataset-197"><span class="linenos">197</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiDataset-198"><a href="#MultiDataset-198"><span class="linenos">198</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">):</span>
</span><span id="MultiDataset-199"><a href="#MultiDataset-199"><span class="linenos">199</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="MultiDataset-200"><a href="#MultiDataset-200"><span class="linenos">200</span></a>
</span><span id="MultiDataset-201"><a href="#MultiDataset-201"><span class="linenos">201</span></a>        <span class="c1"># Generate drift matrix if selected</span>
</span><span id="MultiDataset-202"><a href="#MultiDataset-202"><span class="linenos">202</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">construct_drift_design_matrix</span><span class="p">()</span> 
</span><span id="MultiDataset-203"><a href="#MultiDataset-203"><span class="linenos">203</span></a>
</span><span id="MultiDataset-204"><a href="#MultiDataset-204"><span class="linenos">204</span></a>        <span class="c1"># Set up default cross-validation config</span>
</span><span id="MultiDataset-205"><a href="#MultiDataset-205"><span class="linenos">205</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crossval_setup</span><span class="p">()</span>
</span><span id="MultiDataset-206"><a href="#MultiDataset-206"><span class="linenos">206</span></a>    <span class="c1"># END MultiDataset.__init__</span>
</span><span id="MultiDataset-207"><a href="#MultiDataset-207"><span class="linenos">207</span></a>
</span><span id="MultiDataset-208"><a href="#MultiDataset-208"><span class="linenos">208</span></a>    <span class="k">def</span> <span class="nf">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="MultiDataset-209"><a href="#MultiDataset-209"><span class="linenos">209</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiDataset-210"><a href="#MultiDataset-210"><span class="linenos">210</span></a><span class="sd">        Convert all data to tensors</span>
</span><span id="MultiDataset-211"><a href="#MultiDataset-211"><span class="linenos">211</span></a>
</span><span id="MultiDataset-212"><a href="#MultiDataset-212"><span class="linenos">212</span></a><span class="sd">        Args:</span>
</span><span id="MultiDataset-213"><a href="#MultiDataset-213"><span class="linenos">213</span></a><span class="sd">            device: device to put the tensors on</span>
</span><span id="MultiDataset-214"><a href="#MultiDataset-214"><span class="linenos">214</span></a>
</span><span id="MultiDataset-215"><a href="#MultiDataset-215"><span class="linenos">215</span></a><span class="sd">        Returns:</span>
</span><span id="MultiDataset-216"><a href="#MultiDataset-216"><span class="linenos">216</span></a><span class="sd">            None</span>
</span><span id="MultiDataset-217"><a href="#MultiDataset-217"><span class="linenos">217</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiDataset-218"><a href="#MultiDataset-218"><span class="linenos">218</span></a>        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiDataset-219"><a href="#MultiDataset-219"><span class="linenos">219</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiDataset-220"><a href="#MultiDataset-220"><span class="linenos">220</span></a>                <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</span><span id="MultiDataset-221"><a href="#MultiDataset-221"><span class="linenos">221</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiDataset-222"><a href="#MultiDataset-222"><span class="linenos">222</span></a>                <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span>
</span><span id="MultiDataset-223"><a href="#MultiDataset-223"><span class="linenos">223</span></a>
</span><span id="MultiDataset-224"><a href="#MultiDataset-224"><span class="linenos">224</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span> <span class="o">!=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="MultiDataset-225"><a href="#MultiDataset-225"><span class="linenos">225</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="MultiDataset-226"><a href="#MultiDataset-226"><span class="linenos">226</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="MultiDataset-227"><a href="#MultiDataset-227"><span class="linenos">227</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="MultiDataset-228"><a href="#MultiDataset-228"><span class="linenos">228</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="MultiDataset-229"><a href="#MultiDataset-229"><span class="linenos">229</span></a>            <span class="c1"># Simply move to device:</span>
</span><span id="MultiDataset-230"><a href="#MultiDataset-230"><span class="linenos">230</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">to</span><span class="p">(</span> <span class="n">device</span> <span class="p">)</span>
</span><span id="MultiDataset-231"><a href="#MultiDataset-231"><span class="linenos">231</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span> <span class="n">device</span> <span class="p">)</span>
</span><span id="MultiDataset-232"><a href="#MultiDataset-232"><span class="linenos">232</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span> <span class="n">device</span> <span class="p">)</span>
</span><span id="MultiDataset-233"><a href="#MultiDataset-233"><span class="linenos">233</span></a>    <span class="c1"># END MultiDataset.to_tensor</span>
</span><span id="MultiDataset-234"><a href="#MultiDataset-234"><span class="linenos">234</span></a>
</span><span id="MultiDataset-235"><a href="#MultiDataset-235"><span class="linenos">235</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span><span id="MultiDataset-236"><a href="#MultiDataset-236"><span class="linenos">236</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiDataset-237"><a href="#MultiDataset-237"><span class="linenos">237</span></a><span class="sd">        Called by the DataLoader to build the batch up one item at a time.</span>
</span><span id="MultiDataset-238"><a href="#MultiDataset-238"><span class="linenos">238</span></a><span class="sd">        </span>
</span><span id="MultiDataset-239"><a href="#MultiDataset-239"><span class="linenos">239</span></a><span class="sd">        Args:</span>
</span><span id="MultiDataset-240"><a href="#MultiDataset-240"><span class="linenos">240</span></a><span class="sd">            index: index to use for this batch</span>
</span><span id="MultiDataset-241"><a href="#MultiDataset-241"><span class="linenos">241</span></a><span class="sd">        </span>
</span><span id="MultiDataset-242"><a href="#MultiDataset-242"><span class="linenos">242</span></a><span class="sd">        Returns:</span>
</span><span id="MultiDataset-243"><a href="#MultiDataset-243"><span class="linenos">243</span></a><span class="sd">            dictionary of tensors for this batch</span>
</span><span id="MultiDataset-244"><a href="#MultiDataset-244"><span class="linenos">244</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiDataset-245"><a href="#MultiDataset-245"><span class="linenos">245</span></a>        <span class="c1"># Convert trials to indices if trial-sample</span>
</span><span id="MultiDataset-246"><a href="#MultiDataset-246"><span class="linenos">246</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_sample</span><span class="p">:</span>
</span><span id="MultiDataset-247"><a href="#MultiDataset-247"><span class="linenos">247</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
</span><span id="MultiDataset-248"><a href="#MultiDataset-248"><span class="linenos">248</span></a>                <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span>  <span class="c1"># convert to array</span>
</span><span id="MultiDataset-249"><a href="#MultiDataset-249"><span class="linenos">249</span></a>
</span><span id="MultiDataset-250"><a href="#MultiDataset-250"><span class="linenos">250</span></a>            <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_int</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
</span><span id="MultiDataset-251"><a href="#MultiDataset-251"><span class="linenos">251</span></a>                <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="MultiDataset-252"><a href="#MultiDataset-252"><span class="linenos">252</span></a>
</span><span id="MultiDataset-253"><a href="#MultiDataset-253"><span class="linenos">253</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="MultiDataset-254"><a href="#MultiDataset-254"><span class="linenos">254</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span id="MultiDataset-255"><a href="#MultiDataset-255"><span class="linenos">255</span></a>                <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
</span><span id="MultiDataset-256"><a href="#MultiDataset-256"><span class="linenos">256</span></a>            <span class="n">index</span> <span class="o">=</span> <span class="n">ts</span>
</span><span id="MultiDataset-257"><a href="#MultiDataset-257"><span class="linenos">257</span></a>
</span><span id="MultiDataset-258"><a href="#MultiDataset-258"><span class="linenos">258</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="MultiDataset-259"><a href="#MultiDataset-259"><span class="linenos">259</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="MultiDataset-260"><a href="#MultiDataset-260"><span class="linenos">260</span></a>            <span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="MultiDataset-261"><a href="#MultiDataset-261"><span class="linenos">261</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="MultiDataset-262"><a href="#MultiDataset-262"><span class="linenos">262</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiDataset-263"><a href="#MultiDataset-263"><span class="linenos">263</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset-264"><a href="#MultiDataset-264"><span class="linenos">264</span></a>            <span class="n">robs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset-265"><a href="#MultiDataset-265"><span class="linenos">265</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset-266"><a href="#MultiDataset-266"><span class="linenos">266</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
</span><span id="MultiDataset-267"><a href="#MultiDataset-267"><span class="linenos">267</span></a>                <span class="n">inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="MultiDataset-268"><a href="#MultiDataset-268"><span class="linenos">268</span></a>                <span class="n">NT</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span>
</span><span id="MultiDataset-269"><a href="#MultiDataset-269"><span class="linenos">269</span></a>                <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_index</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="MultiDataset-270"><a href="#MultiDataset-270"><span class="linenos">270</span></a>
</span><span id="MultiDataset-271"><a href="#MultiDataset-271"><span class="linenos">271</span></a><span class="w">                </span><span class="sd">&quot;&quot;&quot; Stim &quot;&quot;&quot;</span>
</span><span id="MultiDataset-272"><a href="#MultiDataset-272"><span class="linenos">272</span></a>                <span class="n">stim_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;stim&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiDataset-273"><a href="#MultiDataset-273"><span class="linenos">273</span></a>
</span><span id="MultiDataset-274"><a href="#MultiDataset-274"><span class="linenos">274</span></a><span class="w">                </span><span class="sd">&quot;&quot;&quot; Spikes: needs padding so all are B x NC &quot;&quot;&quot;</span> 
</span><span id="MultiDataset-275"><a href="#MultiDataset-275"><span class="linenos">275</span></a>                <span class="n">robs_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;robs&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiDataset-276"><a href="#MultiDataset-276"><span class="linenos">276</span></a>                <span class="n">NCbefore</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">[:</span><span class="n">f</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</span><span id="MultiDataset-277"><a href="#MultiDataset-277"><span class="linenos">277</span></a>                <span class="n">NCafter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="p">[</span><span class="n">f</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</span><span id="MultiDataset-278"><a href="#MultiDataset-278"><span class="linenos">278</span></a>                <span class="n">robs_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="MultiDataset-279"><a href="#MultiDataset-279"><span class="linenos">279</span></a>                    <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">NCbefore</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
</span><span id="MultiDataset-280"><a href="#MultiDataset-280"><span class="linenos">280</span></a>                    <span class="n">robs_tmp</span><span class="p">,</span>
</span><span id="MultiDataset-281"><a href="#MultiDataset-281"><span class="linenos">281</span></a>                    <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">NCafter</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span>
</span><span id="MultiDataset-282"><a href="#MultiDataset-282"><span class="linenos">282</span></a>                    <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MultiDataset-283"><a href="#MultiDataset-283"><span class="linenos">283</span></a>
</span><span id="MultiDataset-284"><a href="#MultiDataset-284"><span class="linenos">284</span></a><span class="w">                </span><span class="sd">&quot;&quot;&quot; Datafilters: needs padding like robs &quot;&quot;&quot;</span>
</span><span id="MultiDataset-285"><a href="#MultiDataset-285"><span class="linenos">285</span></a>                <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;dfs&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">,:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiDataset-286"><a href="#MultiDataset-286"><span class="linenos">286</span></a>                <span class="n">dfs_tmp</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># invalidate the filter length</span>
</span><span id="MultiDataset-287"><a href="#MultiDataset-287"><span class="linenos">287</span></a>                <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="MultiDataset-288"><a href="#MultiDataset-288"><span class="linenos">288</span></a>                    <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">NCbefore</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
</span><span id="MultiDataset-289"><a href="#MultiDataset-289"><span class="linenos">289</span></a>                    <span class="n">dfs_tmp</span><span class="p">,</span>
</span><span id="MultiDataset-290"><a href="#MultiDataset-290"><span class="linenos">290</span></a>                    <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">NT</span><span class="p">,</span> <span class="n">NCafter</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span>
</span><span id="MultiDataset-291"><a href="#MultiDataset-291"><span class="linenos">291</span></a>                    <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MultiDataset-292"><a href="#MultiDataset-292"><span class="linenos">292</span></a>
</span><span id="MultiDataset-293"><a href="#MultiDataset-293"><span class="linenos">293</span></a>                <span class="n">stim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stim_tmp</span><span class="p">)</span>
</span><span id="MultiDataset-294"><a href="#MultiDataset-294"><span class="linenos">294</span></a>                <span class="n">robs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">robs_tmp</span><span class="p">)</span>
</span><span id="MultiDataset-295"><a href="#MultiDataset-295"><span class="linenos">295</span></a>                <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfs_tmp</span><span class="p">)</span>
</span><span id="MultiDataset-296"><a href="#MultiDataset-296"><span class="linenos">296</span></a>
</span><span id="MultiDataset-297"><a href="#MultiDataset-297"><span class="linenos">297</span></a>            <span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MultiDataset-298"><a href="#MultiDataset-298"><span class="linenos">298</span></a>            <span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">robs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MultiDataset-299"><a href="#MultiDataset-299"><span class="linenos">299</span></a>            <span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MultiDataset-300"><a href="#MultiDataset-300"><span class="linenos">300</span></a>
</span><span id="MultiDataset-301"><a href="#MultiDataset-301"><span class="linenos">301</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiDataset-302"><a href="#MultiDataset-302"><span class="linenos">302</span></a>            <span class="n">cells_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiDataset-303"><a href="#MultiDataset-303"><span class="linenos">303</span></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;DATASET: cells_out must be a non-zero length&quot;</span>
</span><span id="MultiDataset-304"><a href="#MultiDataset-304"><span class="linenos">304</span></a>            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="s2">&quot;DATASET: cells_out must be a non-zero length&quot;</span>
</span><span id="MultiDataset-305"><a href="#MultiDataset-305"><span class="linenos">305</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="n">stim</span><span class="p">,</span> <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="n">robs</span><span class="p">[:,</span> <span class="n">cells_out</span><span class="p">],</span> <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="n">dfs</span><span class="p">[:,</span> <span class="n">cells_out</span><span class="p">]}</span>
</span><span id="MultiDataset-306"><a href="#MultiDataset-306"><span class="linenos">306</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiDataset-307"><a href="#MultiDataset-307"><span class="linenos">307</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="n">stim</span><span class="p">,</span> <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="n">robs</span><span class="p">,</span> <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="n">dfs</span><span class="p">}</span>
</span><span id="MultiDataset-308"><a href="#MultiDataset-308"><span class="linenos">308</span></a>        
</span><span id="MultiDataset-309"><a href="#MultiDataset-309"><span class="linenos">309</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiDataset-310"><a href="#MultiDataset-310"><span class="linenos">310</span></a>            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Xdrift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xdrift</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="MultiDataset-311"><a href="#MultiDataset-311"><span class="linenos">311</span></a>        <span class="k">return</span> <span class="n">out</span>
</span><span id="MultiDataset-312"><a href="#MultiDataset-312"><span class="linenos">312</span></a>    <span class="c1"># END MultiDataset.__get_item__</span>
</span><span id="MultiDataset-313"><a href="#MultiDataset-313"><span class="linenos">313</span></a>
</span><span id="MultiDataset-314"><a href="#MultiDataset-314"><span class="linenos">314</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MultiDataset-315"><a href="#MultiDataset-315"><span class="linenos">315</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span>
</span><span id="MultiDataset-316"><a href="#MultiDataset-316"><span class="linenos">316</span></a>    
</span><span id="MultiDataset-317"><a href="#MultiDataset-317"><span class="linenos">317</span></a>    <span class="c1">###### Additional functions that might not be useful yet #####</span>
</span><span id="MultiDataset-318"><a href="#MultiDataset-318"><span class="linenos">318</span></a>    <span class="k">def</span> <span class="nf">avrates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="MultiDataset-319"><a href="#MultiDataset-319"><span class="linenos">319</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiDataset-320"><a href="#MultiDataset-320"><span class="linenos">320</span></a><span class="sd">        Calculates average firing probability across specified inds (or whole dataset)</span>
</span><span id="MultiDataset-321"><a href="#MultiDataset-321"><span class="linenos">321</span></a><span class="sd">        -- Note will respect datafilters</span>
</span><span id="MultiDataset-322"><a href="#MultiDataset-322"><span class="linenos">322</span></a><span class="sd">        -- will return precalc value to save time if already stored</span>
</span><span id="MultiDataset-323"><a href="#MultiDataset-323"><span class="linenos">323</span></a>
</span><span id="MultiDataset-324"><a href="#MultiDataset-324"><span class="linenos">324</span></a><span class="sd">        Args:</span>
</span><span id="MultiDataset-325"><a href="#MultiDataset-325"><span class="linenos">325</span></a><span class="sd">            inds: indices to calculate across</span>
</span><span id="MultiDataset-326"><a href="#MultiDataset-326"><span class="linenos">326</span></a>
</span><span id="MultiDataset-327"><a href="#MultiDataset-327"><span class="linenos">327</span></a><span class="sd">        Returns:</span>
</span><span id="MultiDataset-328"><a href="#MultiDataset-328"><span class="linenos">328</span></a><span class="sd">            avRs: average firing rates across the dataset</span>
</span><span id="MultiDataset-329"><a href="#MultiDataset-329"><span class="linenos">329</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiDataset-330"><a href="#MultiDataset-330"><span class="linenos">330</span></a>        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiDataset-331"><a href="#MultiDataset-331"><span class="linenos">331</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="MultiDataset-332"><a href="#MultiDataset-332"><span class="linenos">332</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="MultiDataset-333"><a href="#MultiDataset-333"><span class="linenos">333</span></a>            <span class="c1"># then calculate across whole dataset</span>
</span><span id="MultiDataset-334"><a href="#MultiDataset-334"><span class="linenos">334</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiDataset-335"><a href="#MultiDataset-335"><span class="linenos">335</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiDataset-336"><a href="#MultiDataset-336"><span class="linenos">336</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span>
</span><span id="MultiDataset-337"><a href="#MultiDataset-337"><span class="linenos">337</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avRs</span><span class="p">):</span>
</span><span id="MultiDataset-338"><a href="#MultiDataset-338"><span class="linenos">338</span></a>                    <span class="c1"># then precalculated and do not need to do</span>
</span><span id="MultiDataset-339"><a href="#MultiDataset-339"><span class="linenos">339</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span>
</span><span id="MultiDataset-340"><a href="#MultiDataset-340"><span class="linenos">340</span></a>
</span><span id="MultiDataset-341"><a href="#MultiDataset-341"><span class="linenos">341</span></a>        <span class="c1"># Otherwise calculate across all data</span>
</span><span id="MultiDataset-342"><a href="#MultiDataset-342"><span class="linenos">342</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="MultiDataset-343"><a href="#MultiDataset-343"><span class="linenos">343</span></a>            <span class="n">Reff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="MultiDataset-344"><a href="#MultiDataset-344"><span class="linenos">344</span></a>            <span class="n">Teff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="MultiDataset-345"><a href="#MultiDataset-345"><span class="linenos">345</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiDataset-346"><a href="#MultiDataset-346"><span class="linenos">346</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiDataset-347"><a href="#MultiDataset-347"><span class="linenos">347</span></a>                    <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span><span class="o">/</span><span class="n">Teff</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">])</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="MultiDataset-348"><a href="#MultiDataset-348"><span class="linenos">348</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="o">/</span><span class="n">Teff</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="MultiDataset-349"><a href="#MultiDataset-349"><span class="linenos">349</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiDataset-350"><a href="#MultiDataset-350"><span class="linenos">350</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Still need to implement avRs without preloading&#39;</span><span class="p">)</span>
</span><span id="MultiDataset-351"><a href="#MultiDataset-351"><span class="linenos">351</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="MultiDataset-352"><a href="#MultiDataset-352"><span class="linenos">352</span></a>    <span class="c1"># END MultiDatasset.avrates()</span>
</span><span id="MultiDataset-353"><a href="#MultiDataset-353"><span class="linenos">353</span></a>
</span><span id="MultiDataset-354"><a href="#MultiDataset-354"><span class="linenos">354</span></a>    <span class="k">def</span> <span class="nf">subset</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">indxs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="MultiDataset-355"><a href="#MultiDataset-355"><span class="linenos">355</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiDataset-356"><a href="#MultiDataset-356"><span class="linenos">356</span></a><span class="sd">        Subsets the dataset to only include the specified indices.</span>
</span><span id="MultiDataset-357"><a href="#MultiDataset-357"><span class="linenos">357</span></a>
</span><span id="MultiDataset-358"><a href="#MultiDataset-358"><span class="linenos">358</span></a><span class="sd">        Args:</span>
</span><span id="MultiDataset-359"><a href="#MultiDataset-359"><span class="linenos">359</span></a><span class="sd">            indxs: indices to subset the dataset to</span>
</span><span id="MultiDataset-360"><a href="#MultiDataset-360"><span class="linenos">360</span></a><span class="sd">            train: whether to subset the training set</span>
</span><span id="MultiDataset-361"><a href="#MultiDataset-361"><span class="linenos">361</span></a><span class="sd">            val: whether to subset the validation set</span>
</span><span id="MultiDataset-362"><a href="#MultiDataset-362"><span class="linenos">362</span></a><span class="sd">            device: device to put the tensors on</span>
</span><span id="MultiDataset-363"><a href="#MultiDataset-363"><span class="linenos">363</span></a>
</span><span id="MultiDataset-364"><a href="#MultiDataset-364"><span class="linenos">364</span></a><span class="sd">        Returns:</span>
</span><span id="MultiDataset-365"><a href="#MultiDataset-365"><span class="linenos">365</span></a><span class="sd">            None</span>
</span><span id="MultiDataset-366"><a href="#MultiDataset-366"><span class="linenos">366</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiDataset-367"><a href="#MultiDataset-367"><span class="linenos">367</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">,</span> <span class="s2">&quot;Need preloaded data for this to work&quot;</span>
</span><span id="MultiDataset-368"><a href="#MultiDataset-368"><span class="linenos">368</span></a>
</span><span id="MultiDataset-369"><a href="#MultiDataset-369"><span class="linenos">369</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MultiDataset-370"><a href="#MultiDataset-370"><span class="linenos">370</span></a>        <span class="k">if</span> <span class="n">indxs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiDataset-371"><a href="#MultiDataset-371"><span class="linenos">371</span></a>            <span class="k">if</span> <span class="n">train</span><span class="p">:</span>
</span><span id="MultiDataset-372"><a href="#MultiDataset-372"><span class="linenos">372</span></a>                <span class="k">assert</span> <span class="ow">not</span> <span class="n">val</span><span class="p">,</span> <span class="s2">&quot;Either train or val must be false.&quot;</span>
</span><span id="MultiDataset-373"><a href="#MultiDataset-373"><span class="linenos">373</span></a>                <span class="n">indxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span>
</span><span id="MultiDataset-374"><a href="#MultiDataset-374"><span class="linenos">374</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiDataset-375"><a href="#MultiDataset-375"><span class="linenos">375</span></a>                <span class="k">assert</span> <span class="n">val</span><span class="p">,</span> <span class="s2">&quot;Either train or val must be true&quot;</span>
</span><span id="MultiDataset-376"><a href="#MultiDataset-376"><span class="linenos">376</span></a>                <span class="n">indxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span>
</span><span id="MultiDataset-377"><a href="#MultiDataset-377"><span class="linenos">377</span></a>        
</span><span id="MultiDataset-378"><a href="#MultiDataset-378"><span class="linenos">378</span></a>        <span class="c1"># Crop all preloaded data down to indices</span>
</span><span id="MultiDataset-379"><a href="#MultiDataset-379"><span class="linenos">379</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MultiDataset-380"><a href="#MultiDataset-380"><span class="linenos">380</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MultiDataset-381"><a href="#MultiDataset-381"><span class="linenos">381</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">indxs</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiDataset-382"><a href="#MultiDataset-382"><span class="linenos">382</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">indxs</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="MultiDataset-383"><a href="#MultiDataset-383"><span class="linenos">383</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">indxs</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="MultiDataset-384"><a href="#MultiDataset-384"><span class="linenos">384</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indxs</span><span class="p">)</span>
</span><span id="MultiDataset-385"><a href="#MultiDataset-385"><span class="linenos">385</span></a>    <span class="c1"># End Subset</span>
</span><span id="MultiDataset-386"><a href="#MultiDataset-386"><span class="linenos">386</span></a>
</span><span id="MultiDataset-387"><a href="#MultiDataset-387"><span class="linenos">387</span></a>    <span class="k">def</span> <span class="nf">shift_stim_fixation</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
</span><span id="MultiDataset-388"><a href="#MultiDataset-388"><span class="linenos">388</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiDataset-389"><a href="#MultiDataset-389"><span class="linenos">389</span></a><span class="sd">        Simple shift by integer (rounded shift) and zero padded. Note that this is not in </span>
</span><span id="MultiDataset-390"><a href="#MultiDataset-390"><span class="linenos">390</span></a><span class="sd">        is in units of number of bars, rather than -1 to +1. It assumes the stim</span>
</span><span id="MultiDataset-391"><a href="#MultiDataset-391"><span class="linenos">391</span></a><span class="sd">        has a batch dimension (over a fixation), and shifts the whole stim by the same amount.</span>
</span><span id="MultiDataset-392"><a href="#MultiDataset-392"><span class="linenos">392</span></a><span class="sd">        </span>
</span><span id="MultiDataset-393"><a href="#MultiDataset-393"><span class="linenos">393</span></a><span class="sd">        Args:</span>
</span><span id="MultiDataset-394"><a href="#MultiDataset-394"><span class="linenos">394</span></a><span class="sd">            stim: stimulus tensor to shift</span>
</span><span id="MultiDataset-395"><a href="#MultiDataset-395"><span class="linenos">395</span></a><span class="sd">            shift: amount to shift the stimulus by</span>
</span><span id="MultiDataset-396"><a href="#MultiDataset-396"><span class="linenos">396</span></a>
</span><span id="MultiDataset-397"><a href="#MultiDataset-397"><span class="linenos">397</span></a><span class="sd">        Returns:</span>
</span><span id="MultiDataset-398"><a href="#MultiDataset-398"><span class="linenos">398</span></a><span class="sd">            shstim: shifted stimulus tensor</span>
</span><span id="MultiDataset-399"><a href="#MultiDataset-399"><span class="linenos">399</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiDataset-400"><a href="#MultiDataset-400"><span class="linenos">400</span></a>        <span class="n">sh</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span>
</span><span id="MultiDataset-401"><a href="#MultiDataset-401"><span class="linenos">401</span></a>        <span class="n">shstim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="MultiDataset-402"><a href="#MultiDataset-402"><span class="linenos">402</span></a>        <span class="k">if</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiDataset-403"><a href="#MultiDataset-403"><span class="linenos">403</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="o">-</span><span class="n">sh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="p">:</span><span class="n">sh</span><span class="p">]</span>
</span><span id="MultiDataset-404"><a href="#MultiDataset-404"><span class="linenos">404</span></a>        <span class="k">elif</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiDataset-405"><a href="#MultiDataset-405"><span class="linenos">405</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="n">sh</span><span class="p">:]</span>
</span><span id="MultiDataset-406"><a href="#MultiDataset-406"><span class="linenos">406</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiDataset-407"><a href="#MultiDataset-407"><span class="linenos">407</span></a>            <span class="n">shstim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="MultiDataset-408"><a href="#MultiDataset-408"><span class="linenos">408</span></a>
</span><span id="MultiDataset-409"><a href="#MultiDataset-409"><span class="linenos">409</span></a>        <span class="k">return</span> <span class="n">shstim</span>
</span><span id="MultiDataset-410"><a href="#MultiDataset-410"><span class="linenos">410</span></a>    <span class="c1"># END MultiDatasetFix.shift_stim_fixation</span>
</span><span id="MultiDataset-411"><a href="#MultiDataset-411"><span class="linenos">411</span></a>
</span><span id="MultiDataset-412"><a href="#MultiDataset-412"><span class="linenos">412</span></a>    <span class="k">def</span> <span class="nf">crossval_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test_set</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="MultiDataset-413"><a href="#MultiDataset-413"><span class="linenos">413</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiDataset-414"><a href="#MultiDataset-414"><span class="linenos">414</span></a><span class="sd">        This sets the cross-validation indices up We can add featuers here. Many ways to do this</span>
</span><span id="MultiDataset-415"><a href="#MultiDataset-415"><span class="linenos">415</span></a><span class="sd">        but will stick to some standard for now. It sets the internal indices, which can be read out</span>
</span><span id="MultiDataset-416"><a href="#MultiDataset-416"><span class="linenos">416</span></a><span class="sd">        directly or with helper functions. Perhaps helper_functions is the best way....</span>
</span><span id="MultiDataset-417"><a href="#MultiDataset-417"><span class="linenos">417</span></a><span class="sd">        </span>
</span><span id="MultiDataset-418"><a href="#MultiDataset-418"><span class="linenos">418</span></a><span class="sd">        Args:</span>
</span><span id="MultiDataset-419"><a href="#MultiDataset-419"><span class="linenos">419</span></a><span class="sd">            folds: number of folds to use for cross-validation</span>
</span><span id="MultiDataset-420"><a href="#MultiDataset-420"><span class="linenos">420</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="MultiDataset-421"><a href="#MultiDataset-421"><span class="linenos">421</span></a><span class="sd">            test_set: whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</span>
</span><span id="MultiDataset-422"><a href="#MultiDataset-422"><span class="linenos">422</span></a><span class="sd">        </span>
</span><span id="MultiDataset-423"><a href="#MultiDataset-423"><span class="linenos">423</span></a><span class="sd">        Returns:</span>
</span><span id="MultiDataset-424"><a href="#MultiDataset-424"><span class="linenos">424</span></a><span class="sd">            None: sets internal variables test_inds, train_inds, val_inds</span>
</span><span id="MultiDataset-425"><a href="#MultiDataset-425"><span class="linenos">425</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiDataset-426"><a href="#MultiDataset-426"><span class="linenos">426</span></a>
</span><span id="MultiDataset-427"><a href="#MultiDataset-427"><span class="linenos">427</span></a>        <span class="n">test_fixes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset-428"><a href="#MultiDataset-428"><span class="linenos">428</span></a>        <span class="n">tfixes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset-429"><a href="#MultiDataset-429"><span class="linenos">429</span></a>        <span class="n">vfixes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset-430"><a href="#MultiDataset-430"><span class="linenos">430</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_grouping</span><span class="p">)):</span>
</span><span id="MultiDataset-431"><a href="#MultiDataset-431"><span class="linenos">431</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_grouping</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="MultiDataset-432"><a href="#MultiDataset-432"><span class="linenos">432</span></a>            <span class="n">vfix1</span><span class="p">,</span> <span class="n">tfix1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="MultiDataset-433"><a href="#MultiDataset-433"><span class="linenos">433</span></a>            <span class="k">if</span> <span class="n">test_set</span><span class="p">:</span>
</span><span id="MultiDataset-434"><a href="#MultiDataset-434"><span class="linenos">434</span></a>                <span class="n">test_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">[</span><span class="n">vfix1</span><span class="p">])</span>
</span><span id="MultiDataset-435"><a href="#MultiDataset-435"><span class="linenos">435</span></a>                <span class="n">vfix2</span><span class="p">,</span> <span class="n">tfix2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tfix1</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="MultiDataset-436"><a href="#MultiDataset-436"><span class="linenos">436</span></a>                <span class="n">vfixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">[</span><span class="n">tfix1</span><span class="p">[</span><span class="n">vfix2</span><span class="p">]])</span>
</span><span id="MultiDataset-437"><a href="#MultiDataset-437"><span class="linenos">437</span></a>                <span class="n">tfixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">[</span><span class="n">tfix1</span><span class="p">[</span><span class="n">tfix2</span><span class="p">]])</span>
</span><span id="MultiDataset-438"><a href="#MultiDataset-438"><span class="linenos">438</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiDataset-439"><a href="#MultiDataset-439"><span class="linenos">439</span></a>                <span class="n">vfixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">[</span><span class="n">vfix1</span><span class="p">])</span>
</span><span id="MultiDataset-440"><a href="#MultiDataset-440"><span class="linenos">440</span></a>                <span class="n">tfixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">[</span><span class="n">tfix1</span><span class="p">])</span>
</span><span id="MultiDataset-441"><a href="#MultiDataset-441"><span class="linenos">441</span></a>
</span><span id="MultiDataset-442"><a href="#MultiDataset-442"><span class="linenos">442</span></a>        <span class="n">val_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vfixes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
</span><span id="MultiDataset-443"><a href="#MultiDataset-443"><span class="linenos">443</span></a>        <span class="n">train_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tfixes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
</span><span id="MultiDataset-444"><a href="#MultiDataset-444"><span class="linenos">444</span></a>        
</span><span id="MultiDataset-445"><a href="#MultiDataset-445"><span class="linenos">445</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">val_blks</span>
</span><span id="MultiDataset-446"><a href="#MultiDataset-446"><span class="linenos">446</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">train_blks</span>
</span><span id="MultiDataset-447"><a href="#MultiDataset-447"><span class="linenos">447</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="n">test_fixes</span>
</span><span id="MultiDataset-448"><a href="#MultiDataset-448"><span class="linenos">448</span></a>
</span><span id="MultiDataset-449"><a href="#MultiDataset-449"><span class="linenos">449</span></a>        <span class="c1"># Assign indexes based on validation by block</span>
</span><span id="MultiDataset-450"><a href="#MultiDataset-450"><span class="linenos">450</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset-451"><a href="#MultiDataset-451"><span class="linenos">451</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset-452"><a href="#MultiDataset-452"><span class="linenos">452</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset-453"><a href="#MultiDataset-453"><span class="linenos">453</span></a>        <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="n">train_blks</span><span class="p">:</span>
</span><span id="MultiDataset-454"><a href="#MultiDataset-454"><span class="linenos">454</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">])</span>
</span><span id="MultiDataset-455"><a href="#MultiDataset-455"><span class="linenos">455</span></a>        <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="n">val_blks</span><span class="p">:</span>
</span><span id="MultiDataset-456"><a href="#MultiDataset-456"><span class="linenos">456</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">])</span>
</span><span id="MultiDataset-457"><a href="#MultiDataset-457"><span class="linenos">457</span></a>        <span class="k">if</span> <span class="n">test_set</span><span class="p">:</span>
</span><span id="MultiDataset-458"><a href="#MultiDataset-458"><span class="linenos">458</span></a>            <span class="n">test_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_fixes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
</span><span id="MultiDataset-459"><a href="#MultiDataset-459"><span class="linenos">459</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="n">test_blks</span><span class="p">:</span>
</span><span id="MultiDataset-460"><a href="#MultiDataset-460"><span class="linenos">460</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">])</span>
</span><span id="MultiDataset-461"><a href="#MultiDataset-461"><span class="linenos">461</span></a>
</span><span id="MultiDataset-462"><a href="#MultiDataset-462"><span class="linenos">462</span></a>        <span class="c1"># finally convert to np.array</span>
</span><span id="MultiDataset-463"><a href="#MultiDataset-463"><span class="linenos">463</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">)</span>
</span><span id="MultiDataset-464"><a href="#MultiDataset-464"><span class="linenos">464</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">)</span>
</span><span id="MultiDataset-465"><a href="#MultiDataset-465"><span class="linenos">465</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span><span class="p">)</span>
</span><span id="MultiDataset-466"><a href="#MultiDataset-466"><span class="linenos">466</span></a>    <span class="c1"># END MultiDatasetFix.crossval_setup</span>
</span><span id="MultiDataset-467"><a href="#MultiDataset-467"><span class="linenos">467</span></a>
</span><span id="MultiDataset-468"><a href="#MultiDataset-468"><span class="linenos">468</span></a>    <span class="k">def</span> <span class="nf">fold_sample</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="MultiDataset-469"><a href="#MultiDataset-469"><span class="linenos">469</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiDataset-470"><a href="#MultiDataset-470"><span class="linenos">470</span></a><span class="sd">        This really should be a general method not associated with self.</span>
</span><span id="MultiDataset-471"><a href="#MultiDataset-471"><span class="linenos">471</span></a><span class="sd">        </span>
</span><span id="MultiDataset-472"><a href="#MultiDataset-472"><span class="linenos">472</span></a><span class="sd">        Args:</span>
</span><span id="MultiDataset-473"><a href="#MultiDataset-473"><span class="linenos">473</span></a><span class="sd">            num_items: number of items to fold</span>
</span><span id="MultiDataset-474"><a href="#MultiDataset-474"><span class="linenos">474</span></a><span class="sd">            folds: number of folds to use</span>
</span><span id="MultiDataset-475"><a href="#MultiDataset-475"><span class="linenos">475</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="MultiDataset-476"><a href="#MultiDataset-476"><span class="linenos">476</span></a>
</span><span id="MultiDataset-477"><a href="#MultiDataset-477"><span class="linenos">477</span></a><span class="sd">        Returns:</span>
</span><span id="MultiDataset-478"><a href="#MultiDataset-478"><span class="linenos">478</span></a><span class="sd">            val_items: indices for the validation set</span>
</span><span id="MultiDataset-479"><a href="#MultiDataset-479"><span class="linenos">479</span></a><span class="sd">            rem_items: indices for the remaining set</span>
</span><span id="MultiDataset-480"><a href="#MultiDataset-480"><span class="linenos">480</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiDataset-481"><a href="#MultiDataset-481"><span class="linenos">481</span></a>        <span class="k">if</span> <span class="n">random_gen</span><span class="p">:</span>
</span><span id="MultiDataset-482"><a href="#MultiDataset-482"><span class="linenos">482</span></a>            <span class="n">num_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_items</span><span class="o">/</span><span class="n">folds</span><span class="p">)</span>
</span><span id="MultiDataset-483"><a href="#MultiDataset-483"><span class="linenos">483</span></a>            <span class="n">tmp_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">num_items</span><span class="p">)</span>
</span><span id="MultiDataset-484"><a href="#MultiDataset-484"><span class="linenos">484</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[:</span><span class="n">num_val</span><span class="p">])</span>
</span><span id="MultiDataset-485"><a href="#MultiDataset-485"><span class="linenos">485</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[</span><span class="n">num_val</span><span class="p">:])</span>
</span><span id="MultiDataset-486"><a href="#MultiDataset-486"><span class="linenos">486</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiDataset-487"><a href="#MultiDataset-487"><span class="linenos">487</span></a>            <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">folds</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="MultiDataset-488"><a href="#MultiDataset-488"><span class="linenos">488</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
</span><span id="MultiDataset-489"><a href="#MultiDataset-489"><span class="linenos">489</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">),</span> <span class="n">val_items</span><span class="p">)</span>
</span><span id="MultiDataset-490"><a href="#MultiDataset-490"><span class="linenos">490</span></a>        <span class="k">return</span> <span class="n">val_items</span><span class="p">,</span> <span class="n">rem_items</span>
</span><span id="MultiDataset-491"><a href="#MultiDataset-491"><span class="linenos">491</span></a>
</span><span id="MultiDataset-492"><a href="#MultiDataset-492"><span class="linenos">492</span></a>    <span class="nd">@staticmethod</span>
</span><span id="MultiDataset-493"><a href="#MultiDataset-493"><span class="linenos">493</span></a>    <span class="k">def</span> <span class="nf">collate_blocks</span><span class="p">(</span> <span class="n">data</span> <span class="p">):</span>
</span><span id="MultiDataset-494"><a href="#MultiDataset-494"><span class="linenos">494</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Alternative to the collate function that attaches blocks labeled by one index together</span>
</span><span id="MultiDataset-495"><a href="#MultiDataset-495"><span class="linenos">495</span></a><span class="sd">        To explain: if you ask for one index (of a block) from the dataset like [1] and get back </span>
</span><span id="MultiDataset-496"><a href="#MultiDataset-496"><span class="linenos">496</span></a><span class="sd">        a block of data (B x M), the default collate_fn will still treat this as one data sample </span>
</span><span id="MultiDataset-497"><a href="#MultiDataset-497"><span class="linenos">497</span></a><span class="sd">        (1 x B x M) rather than the B data samples in the block. This is a simple flatten...</span>
</span><span id="MultiDataset-498"><a href="#MultiDataset-498"><span class="linenos">498</span></a><span class="sd">        Note: assumes that this is getting a dictionary, of course&quot;&quot;&quot;</span>
</span><span id="MultiDataset-499"><a href="#MultiDataset-499"><span class="linenos">499</span></a>        <span class="c1">#print(len(data))</span>
</span><span id="MultiDataset-500"><a href="#MultiDataset-500"><span class="linenos">500</span></a>        <span class="n">data_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MultiDataset-501"><a href="#MultiDataset-501"><span class="linenos">501</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
</span><span id="MultiDataset-502"><a href="#MultiDataset-502"><span class="linenos">502</span></a>            <span class="k">for</span> <span class="n">dsub</span> <span class="ow">in</span> <span class="n">data_out</span><span class="p">:</span>
</span><span id="MultiDataset-503"><a href="#MultiDataset-503"><span class="linenos">503</span></a>                <span class="n">data_out</span><span class="p">[</span><span class="n">dsub</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span> <span class="p">(</span><span class="n">data_out</span><span class="p">[</span><span class="n">dsub</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">dsub</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
</span><span id="MultiDataset-504"><a href="#MultiDataset-504"><span class="linenos">504</span></a>            <span class="c1"># if trainer concatentates batches incorrectly --- this is a kluge</span>
</span><span id="MultiDataset-505"><a href="#MultiDataset-505"><span class="linenos">505</span></a>            <span class="c1"># if len(data[dsub].shape) &gt; 2:  # more general without this &#39;if&#39;, assuming above</span>
</span><span id="MultiDataset-506"><a href="#MultiDataset-506"><span class="linenos">506</span></a>            <span class="c1">#print(dsub)</span>
</span><span id="MultiDataset-507"><a href="#MultiDataset-507"><span class="linenos">507</span></a>            <span class="c1">#print(data[dsub].shape)</span>
</span><span id="MultiDataset-508"><a href="#MultiDataset-508"><span class="linenos">508</span></a>            <span class="c1">#data[dsub] = data[dsub].flatten(end_dim=1) </span>
</span><span id="MultiDataset-509"><a href="#MultiDataset-509"><span class="linenos">509</span></a>        <span class="k">return</span> <span class="n">data</span>
</span></pre></div>


            <div class="docstring"><p>MULTIDATASET can load batches from multiple datasets</p>

<p>args specific to this init:
    filenames
    datadir
    num_lags: how many lags back will the presumed model require (for establishing DFs too)
kwargs handled by SensoryBase:
    drift_interval: to build drift terms (spacing based on trials)
    time_embed: whether to time-embed or not
    trial_sample: whether dataset returns time-contiguous trials for each index or individual time points 
    device</p>
</div>


                            <div id="MultiDataset.__init__" class="classattr">
                                        <input id="MultiDataset.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">MultiDataset</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">filenames</span>, </span><span class="param"><span class="n">datadir</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">num_lags</span><span class="o">=</span><span class="mi">8</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="MultiDataset.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiDataset.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiDataset.__init__-33"><a href="#MultiDataset.__init__-33"><span class="linenos"> 33</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="MultiDataset.__init__-34"><a href="#MultiDataset.__init__-34"><span class="linenos"> 34</span></a>        <span class="n">filenames</span><span class="p">,</span>
</span><span id="MultiDataset.__init__-35"><a href="#MultiDataset.__init__-35"><span class="linenos"> 35</span></a>        <span class="n">datadir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MultiDataset.__init__-36"><a href="#MultiDataset.__init__-36"><span class="linenos"> 36</span></a>        <span class="c1">#preload=False,</span>
</span><span id="MultiDataset.__init__-37"><a href="#MultiDataset.__init__-37"><span class="linenos"> 37</span></a>        <span class="n">num_lags</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="MultiDataset.__init__-38"><a href="#MultiDataset.__init__-38"><span class="linenos"> 38</span></a>        <span class="c1">#time_embed=True,</span>
</span><span id="MultiDataset.__init__-39"><a href="#MultiDataset.__init__-39"><span class="linenos"> 39</span></a>        <span class="c1">#includeMUs=False,</span>
</span><span id="MultiDataset.__init__-40"><a href="#MultiDataset.__init__-40"><span class="linenos"> 40</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="MultiDataset.__init__-41"><a href="#MultiDataset.__init__-41"><span class="linenos"> 41</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiDataset.__init__-42"><a href="#MultiDataset.__init__-42"><span class="linenos"> 42</span></a><span class="sd">        Initialize the MultiDataset class.</span>
</span><span id="MultiDataset.__init__-43"><a href="#MultiDataset.__init__-43"><span class="linenos"> 43</span></a>
</span><span id="MultiDataset.__init__-44"><a href="#MultiDataset.__init__-44"><span class="linenos"> 44</span></a><span class="sd">        Args:</span>
</span><span id="MultiDataset.__init__-45"><a href="#MultiDataset.__init__-45"><span class="linenos"> 45</span></a><span class="sd">            filenames: list of strings of the filenames (without extension) to load</span>
</span><span id="MultiDataset.__init__-46"><a href="#MultiDataset.__init__-46"><span class="linenos"> 46</span></a><span class="sd">            datadir: directory where the data is stored</span>
</span><span id="MultiDataset.__init__-47"><a href="#MultiDataset.__init__-47"><span class="linenos"> 47</span></a><span class="sd">            num_lags: how many lags back will the presumed model require (for establishing DFs too)</span>
</span><span id="MultiDataset.__init__-48"><a href="#MultiDataset.__init__-48"><span class="linenos"> 48</span></a><span class="sd">            time_embed: whether to time-embed or not</span>
</span><span id="MultiDataset.__init__-49"><a href="#MultiDataset.__init__-49"><span class="linenos"> 49</span></a><span class="sd">            trial_sample: whether dataset returns time-contiguous trials for each index or individual time points </span>
</span><span id="MultiDataset.__init__-50"><a href="#MultiDataset.__init__-50"><span class="linenos"> 50</span></a><span class="sd">            device: device to put the tensors on</span>
</span><span id="MultiDataset.__init__-51"><a href="#MultiDataset.__init__-51"><span class="linenos"> 51</span></a><span class="sd">            preload: whether to load all data into memory at once</span>
</span><span id="MultiDataset.__init__-52"><a href="#MultiDataset.__init__-52"><span class="linenos"> 52</span></a><span class="sd">            includeMUs: whether to include MUs in the dataset</span>
</span><span id="MultiDataset.__init__-53"><a href="#MultiDataset.__init__-53"><span class="linenos"> 53</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiDataset.__init__-54"><a href="#MultiDataset.__init__-54"><span class="linenos"> 54</span></a>
</span><span id="MultiDataset.__init__-55"><a href="#MultiDataset.__init__-55"><span class="linenos"> 55</span></a>        <span class="c1"># call parent constructor</span>
</span><span id="MultiDataset.__init__-56"><a href="#MultiDataset.__init__-56"><span class="linenos"> 56</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="MultiDataset.__init__-57"><a href="#MultiDataset.__init__-57"><span class="linenos"> 57</span></a>            <span class="n">filenames</span><span class="p">,</span> <span class="n">datadir</span><span class="o">=</span><span class="n">datadir</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">num_lags</span><span class="p">,</span> <span class="c1"># default to cut out of each trial block</span>
</span><span id="MultiDataset.__init__-58"><a href="#MultiDataset.__init__-58"><span class="linenos"> 58</span></a>            <span class="c1">#time_embed=time_embed,</span>
</span><span id="MultiDataset.__init__-59"><a href="#MultiDataset.__init__-59"><span class="linenos"> 59</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-60"><a href="#MultiDataset.__init__-60"><span class="linenos"> 60</span></a>        <span class="c1">#print( &quot;Loading&quot;, self.datadir + self.filenames)</span>
</span><span id="MultiDataset.__init__-61"><a href="#MultiDataset.__init__-61"><span class="linenos"> 61</span></a>
</span><span id="MultiDataset.__init__-62"><a href="#MultiDataset.__init__-62"><span class="linenos"> 62</span></a>        <span class="c1"># get hdf5 file handles</span>
</span><span id="MultiDataset.__init__-63"><a href="#MultiDataset.__init__-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">sess</span> <span class="o">+</span> <span class="s1">&#39;.hdf5&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>
</span><span id="MultiDataset.__init__-64"><a href="#MultiDataset.__init__-64"><span class="linenos"> 64</span></a>
</span><span id="MultiDataset.__init__-65"><a href="#MultiDataset.__init__-65"><span class="linenos"> 65</span></a>        <span class="c1"># build index map</span>
</span><span id="MultiDataset.__init__-66"><a href="#MultiDataset.__init__-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_index</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># which file the block corresponds to</span>
</span><span id="MultiDataset.__init__-67"><a href="#MultiDataset.__init__-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset.__init__-68"><a href="#MultiDataset.__init__-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NTfile</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset.__init__-69"><a href="#MultiDataset.__init__-69"><span class="linenos"> 69</span></a>
</span><span id="MultiDataset.__init__-70"><a href="#MultiDataset.__init__-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unit_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset.__init__-71"><a href="#MultiDataset.__init__-71"><span class="linenos"> 71</span></a>        <span class="c1">#self.includeMUs = include_MUs</span>
</span><span id="MultiDataset.__init__-72"><a href="#MultiDataset.__init__-72"><span class="linenos"> 72</span></a>        <span class="c1">#self.num_units, self.num_sus, self.num_mus = [], [], []</span>
</span><span id="MultiDataset.__init__-73"><a href="#MultiDataset.__init__-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dims_file</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset.__init__-74"><a href="#MultiDataset.__init__-74"><span class="linenos"> 74</span></a>
</span><span id="MultiDataset.__init__-75"><a href="#MultiDataset.__init__-75"><span class="linenos"> 75</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">):</span>
</span><span id="MultiDataset.__init__-76"><a href="#MultiDataset.__init__-76"><span class="linenos"> 76</span></a>            <span class="n">preload</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="MultiDataset.__init__-77"><a href="#MultiDataset.__init__-77"><span class="linenos"> 77</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: switching preload to True so device argument is meaningful.&quot;</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-78"><a href="#MultiDataset.__init__-78"><span class="linenos"> 78</span></a>        
</span><span id="MultiDataset.__init__-79"><a href="#MultiDataset.__init__-79"><span class="linenos"> 79</span></a>        <span class="c1">#self.preload = preload</span>
</span><span id="MultiDataset.__init__-80"><a href="#MultiDataset.__init__-80"><span class="linenos"> 80</span></a>        <span class="c1">#self.device = device</span>
</span><span id="MultiDataset.__init__-81"><a href="#MultiDataset.__init__-81"><span class="linenos"> 81</span></a>
</span><span id="MultiDataset.__init__-82"><a href="#MultiDataset.__init__-82"><span class="linenos"> 82</span></a>        <span class="c1">#self.NT = 0</span>
</span><span id="MultiDataset.__init__-83"><a href="#MultiDataset.__init__-83"><span class="linenos"> 83</span></a>        <span class="c1">#self.NC = 0</span>
</span><span id="MultiDataset.__init__-84"><a href="#MultiDataset.__init__-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiDataset.__init__-85"><a href="#MultiDataset.__init__-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_assign</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset.__init__-86"><a href="#MultiDataset.__init__-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block_grouping</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset.__init__-87"><a href="#MultiDataset.__init__-87"><span class="linenos"> 87</span></a>        <span class="n">nfiles</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MultiDataset.__init__-88"><a href="#MultiDataset.__init__-88"><span class="linenos"> 88</span></a>
</span><span id="MultiDataset.__init__-89"><a href="#MultiDataset.__init__-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trial_size</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MultiDataset.__init__-90"><a href="#MultiDataset.__init__-90"><span class="linenos"> 90</span></a>
</span><span id="MultiDataset.__init__-91"><a href="#MultiDataset.__init__-91"><span class="linenos"> 91</span></a>        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">fhandle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">):</span>
</span><span id="MultiDataset.__init__-92"><a href="#MultiDataset.__init__-92"><span class="linenos"> 92</span></a>            <span class="n">NTfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiDataset.__init__-93"><a href="#MultiDataset.__init__-93"><span class="linenos"> 93</span></a>            <span class="n">NCfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiDataset.__init__-94"><a href="#MultiDataset.__init__-94"><span class="linenos"> 94</span></a>            <span class="n">NMUfile</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;robsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiDataset.__init__-95"><a href="#MultiDataset.__init__-95"><span class="linenos"> 95</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_SUs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NCfile</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-96"><a href="#MultiDataset.__init__-96"><span class="linenos"> 96</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_MUs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NMUfile</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-97"><a href="#MultiDataset.__init__-97"><span class="linenos"> 97</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="o">+</span><span class="n">NCfile</span><span class="p">))</span>
</span><span id="MultiDataset.__init__-98"><a href="#MultiDataset.__init__-98"><span class="linenos"> 98</span></a>
</span><span id="MultiDataset.__init__-99"><a href="#MultiDataset.__init__-99"><span class="linenos"> 99</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims_file</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="MultiDataset.__init__-100"><a href="#MultiDataset.__init__-100"><span class="linenos">100</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="MultiDataset.__init__-101"><a href="#MultiDataset.__init__-101"><span class="linenos">101</span></a>                <span class="n">NCfile</span> <span class="o">+=</span> <span class="n">NMUfile</span>
</span><span id="MultiDataset.__init__-102"><a href="#MultiDataset.__init__-102"><span class="linenos">102</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">unit_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">NCfile</span><span class="p">)))</span>
</span><span id="MultiDataset.__init__-103"><a href="#MultiDataset.__init__-103"><span class="linenos">103</span></a>            
</span><span id="MultiDataset.__init__-104"><a href="#MultiDataset.__init__-104"><span class="linenos">104</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NCfile</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-105"><a href="#MultiDataset.__init__-105"><span class="linenos">105</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NTfile</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NTfile</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-106"><a href="#MultiDataset.__init__-106"><span class="linenos">106</span></a>
</span><span id="MultiDataset.__init__-107"><a href="#MultiDataset.__init__-107"><span class="linenos">107</span></a>            <span class="c1"># Pull blocks from data_filters</span>
</span><span id="MultiDataset.__init__-108"><a href="#MultiDataset.__init__-108"><span class="linenos">108</span></a>            <span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;dfs&#39;</span><span class="p">][:,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-109"><a href="#MultiDataset.__init__-109"><span class="linenos">109</span></a>            <span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># set invalid first sample</span>
</span><span id="MultiDataset.__init__-110"><a href="#MultiDataset.__init__-110"><span class="linenos">110</span></a>            <span class="n">blocks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># set invalid last sample</span>
</span><span id="MultiDataset.__init__-111"><a href="#MultiDataset.__init__-111"><span class="linenos">111</span></a>
</span><span id="MultiDataset.__init__-112"><a href="#MultiDataset.__init__-112"><span class="linenos">112</span></a>            <span class="n">blockstart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span><span class="o">==-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiDataset.__init__-113"><a href="#MultiDataset.__init__-113"><span class="linenos">113</span></a>            <span class="n">blockend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiDataset.__init__-114"><a href="#MultiDataset.__init__-114"><span class="linenos">114</span></a>            <span class="n">nblocks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">blockstart</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-115"><a href="#MultiDataset.__init__-115"><span class="linenos">115</span></a>
</span><span id="MultiDataset.__init__-116"><a href="#MultiDataset.__init__-116"><span class="linenos">116</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiDataset.__init__-117"><a href="#MultiDataset.__init__-117"><span class="linenos">117</span></a>                <span class="n">trsize_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset.__init__-118"><a href="#MultiDataset.__init__-118"><span class="linenos">118</span></a>                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="p">):</span>
</span><span id="MultiDataset.__init__-119"><a href="#MultiDataset.__init__-119"><span class="linenos">119</span></a>                    <span class="n">trsize_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blockend</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">-</span><span class="n">blockstart</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
</span><span id="MultiDataset.__init__-120"><a href="#MultiDataset.__init__-120"><span class="linenos">120</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">trial_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">trsize_list</span><span class="p">))</span>
</span><span id="MultiDataset.__init__-121"><a href="#MultiDataset.__init__-121"><span class="linenos">121</span></a>
</span><span id="MultiDataset.__init__-122"><a href="#MultiDataset.__init__-122"><span class="linenos">122</span></a>            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="p">):</span>
</span><span id="MultiDataset.__init__-123"><a href="#MultiDataset.__init__-123"><span class="linenos">123</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">file_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-124"><a href="#MultiDataset.__init__-124"><span class="linenos">124</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">blockstart</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">blockend</span><span class="p">[</span><span class="n">b</span><span class="p">]))</span>
</span><span id="MultiDataset.__init__-125"><a href="#MultiDataset.__init__-125"><span class="linenos">125</span></a>            
</span><span id="MultiDataset.__init__-126"><a href="#MultiDataset.__init__-126"><span class="linenos">126</span></a>            <span class="c1"># Assign each block to a file</span>
</span><span id="MultiDataset.__init__-127"><a href="#MultiDataset.__init__-127"><span class="linenos">127</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_assign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
</span><span id="MultiDataset.__init__-128"><a href="#MultiDataset.__init__-128"><span class="linenos">128</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_assign</span><span class="p">,</span> <span class="n">nfiles</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">NTfile</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-129"><a href="#MultiDataset.__init__-129"><span class="linenos">129</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">block_grouping</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nblocks</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="p">)</span>
</span><span id="MultiDataset.__init__-130"><a href="#MultiDataset.__init__-130"><span class="linenos">130</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">+=</span> <span class="n">NTfile</span>
</span><span id="MultiDataset.__init__-131"><a href="#MultiDataset.__init__-131"><span class="linenos">131</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">NC</span> <span class="o">+=</span> <span class="n">NCfile</span>
</span><span id="MultiDataset.__init__-132"><a href="#MultiDataset.__init__-132"><span class="linenos">132</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span> <span class="o">+=</span> <span class="n">nblocks</span>
</span><span id="MultiDataset.__init__-133"><a href="#MultiDataset.__init__-133"><span class="linenos">133</span></a>            <span class="n">nfiles</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MultiDataset.__init__-134"><a href="#MultiDataset.__init__-134"><span class="linenos">134</span></a>
</span><span id="MultiDataset.__init__-135"><a href="#MultiDataset.__init__-135"><span class="linenos">135</span></a>        <span class="c1"># Set overall dataset variables</span>
</span><span id="MultiDataset.__init__-136"><a href="#MultiDataset.__init__-136"><span class="linenos">136</span></a>        <span class="n">NX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dims_file</span><span class="p">))</span> <span class="c1"># assumes they&#39;re all the same</span>
</span><span id="MultiDataset.__init__-137"><a href="#MultiDataset.__init__-137"><span class="linenos">137</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">NX</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;problems&#39;</span>
</span><span id="MultiDataset.__init__-138"><a href="#MultiDataset.__init__-138"><span class="linenos">138</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">NX</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="MultiDataset.__init__-139"><a href="#MultiDataset.__init__-139"><span class="linenos">139</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span><span class="p">:</span>
</span><span id="MultiDataset.__init__-140"><a href="#MultiDataset.__init__-140"><span class="linenos">140</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span>
</span><span id="MultiDataset.__init__-141"><a href="#MultiDataset.__init__-141"><span class="linenos">141</span></a>        <span class="c1"># For now do this without using assemble_stimlus</span>
</span><span id="MultiDataset.__init__-142"><a href="#MultiDataset.__init__-142"><span class="linenos">142</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim_dims</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-143"><a href="#MultiDataset.__init__-143"><span class="linenos">143</span></a>
</span><span id="MultiDataset.__init__-144"><a href="#MultiDataset.__init__-144"><span class="linenos">144</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="MultiDataset.__init__-145"><a href="#MultiDataset.__init__-145"><span class="linenos">145</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-146"><a href="#MultiDataset.__init__-146"><span class="linenos">146</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-147"><a href="#MultiDataset.__init__-147"><span class="linenos">147</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-148"><a href="#MultiDataset.__init__-148"><span class="linenos">148</span></a>            <span class="n">tcount</span><span class="p">,</span> <span class="n">ccount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="MultiDataset.__init__-149"><a href="#MultiDataset.__init__-149"><span class="linenos">149</span></a>            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">fhandle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">):</span>
</span><span id="MultiDataset.__init__-150"><a href="#MultiDataset.__init__-150"><span class="linenos">150</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>
</span><span id="MultiDataset.__init__-151"><a href="#MultiDataset.__init__-151"><span class="linenos">151</span></a>                <span class="n">NT</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MultiDataset.__init__-152"><a href="#MultiDataset.__init__-152"><span class="linenos">152</span></a>                <span class="n">NC</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;robs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiDataset.__init__-153"><a href="#MultiDataset.__init__-153"><span class="linenos">153</span></a>                <span class="n">trange</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">tcount</span><span class="p">,</span> <span class="n">tcount</span><span class="o">+</span><span class="n">NT</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-154"><a href="#MultiDataset.__init__-154"><span class="linenos">154</span></a>                <span class="n">crange</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">ccount</span><span class="p">,</span> <span class="n">ccount</span><span class="o">+</span><span class="n">NC</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-155"><a href="#MultiDataset.__init__-155"><span class="linenos">155</span></a>                
</span><span id="MultiDataset.__init__-156"><a href="#MultiDataset.__init__-156"><span class="linenos">156</span></a>                <span class="c1"># Stimulus</span>
</span><span id="MultiDataset.__init__-157"><a href="#MultiDataset.__init__-157"><span class="linenos">157</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span><span class="p">:</span>
</span><span id="MultiDataset.__init__-158"><a href="#MultiDataset.__init__-158"><span class="linenos">158</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">trange</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-159"><a href="#MultiDataset.__init__-159"><span class="linenos">159</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MultiDataset.__init__-160"><a href="#MultiDataset.__init__-160"><span class="linenos">160</span></a>                    <span class="c1"># Time embed stimulus -- simple way</span>
</span><span id="MultiDataset.__init__-161"><a href="#MultiDataset.__init__-161"><span class="linenos">161</span></a>                    <span class="c1">#idx = np.arange(NT)</span>
</span><span id="MultiDataset.__init__-162"><a href="#MultiDataset.__init__-162"><span class="linenos">162</span></a>                    <span class="c1">#tmp = np.array(self.fhandles[f][&#39;stim&#39;], dtype=&#39;float32&#39;)</span>
</span><span id="MultiDataset.__init__-163"><a href="#MultiDataset.__init__-163"><span class="linenos">163</span></a>                    <span class="c1">#self.stim[trange, :] = np.reshape( </span>
</span><span id="MultiDataset.__init__-164"><a href="#MultiDataset.__init__-164"><span class="linenos">164</span></a>                    <span class="c1">#    np.transpose(</span>
</span><span id="MultiDataset.__init__-165"><a href="#MultiDataset.__init__-165"><span class="linenos">165</span></a>                    <span class="c1">#        tmp[np.arange(NT)[:,None]-np.arange(self.num_lags), :], </span>
</span><span id="MultiDataset.__init__-166"><a href="#MultiDataset.__init__-166"><span class="linenos">166</span></a>                    <span class="c1">#        [0,2,1]),</span>
</span><span id="MultiDataset.__init__-167"><a href="#MultiDataset.__init__-167"><span class="linenos">167</span></a>                    <span class="c1">#    [NT, -1])</span>
</span><span id="MultiDataset.__init__-168"><a href="#MultiDataset.__init__-168"><span class="linenos">168</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">trange</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embedding</span><span class="p">(</span>
</span><span id="MultiDataset.__init__-169"><a href="#MultiDataset.__init__-169"><span class="linenos">169</span></a>                        <span class="n">stim</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;stim&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">))</span>
</span><span id="MultiDataset.__init__-170"><a href="#MultiDataset.__init__-170"><span class="linenos">170</span></a>
</span><span id="MultiDataset.__init__-171"><a href="#MultiDataset.__init__-171"><span class="linenos">171</span></a>                <span class="c1"># Robs and DFs</span>
</span><span id="MultiDataset.__init__-172"><a href="#MultiDataset.__init__-172"><span class="linenos">172</span></a>                <span class="n">robs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-173"><a href="#MultiDataset.__init__-173"><span class="linenos">173</span></a>                <span class="n">dfs_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NC</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-174"><a href="#MultiDataset.__init__-174"><span class="linenos">174</span></a>                <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">crange</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;robs&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-175"><a href="#MultiDataset.__init__-175"><span class="linenos">175</span></a>                <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">crange</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;dfs&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-176"><a href="#MultiDataset.__init__-176"><span class="linenos">176</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_MUs</span><span class="p">:</span>
</span><span id="MultiDataset.__init__-177"><a href="#MultiDataset.__init__-177"><span class="linenos">177</span></a>                    <span class="n">NMU</span> <span class="o">=</span> <span class="n">fhandle</span><span class="p">[</span><span class="s1">&#39;robsMU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MultiDataset.__init__-178"><a href="#MultiDataset.__init__-178"><span class="linenos">178</span></a>                    <span class="n">crange</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">ccount</span><span class="o">+</span><span class="n">NC</span><span class="p">,</span> <span class="n">ccount</span><span class="o">+</span><span class="n">NC</span><span class="o">+</span><span class="n">NMU</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-179"><a href="#MultiDataset.__init__-179"><span class="linenos">179</span></a>                    <span class="n">NC</span> <span class="o">+=</span> <span class="n">NMU</span>
</span><span id="MultiDataset.__init__-180"><a href="#MultiDataset.__init__-180"><span class="linenos">180</span></a>                    <span class="n">robs_tmp</span><span class="p">[:,</span> <span class="n">crange</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;robsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-181"><a href="#MultiDataset.__init__-181"><span class="linenos">181</span></a>                    <span class="n">dfs_tmp</span><span class="p">[:,</span> <span class="n">crange</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;dfsMU&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-182"><a href="#MultiDataset.__init__-182"><span class="linenos">182</span></a>
</span><span id="MultiDataset.__init__-183"><a href="#MultiDataset.__init__-183"><span class="linenos">183</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">trange</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">robs_tmp</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-184"><a href="#MultiDataset.__init__-184"><span class="linenos">184</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">trange</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">dfs_tmp</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-185"><a href="#MultiDataset.__init__-185"><span class="linenos">185</span></a>                <span class="n">tcount</span> <span class="o">+=</span> <span class="n">NT</span>
</span><span id="MultiDataset.__init__-186"><a href="#MultiDataset.__init__-186"><span class="linenos">186</span></a>                <span class="n">ccount</span> <span class="o">+=</span> <span class="n">NC</span>
</span><span id="MultiDataset.__init__-187"><a href="#MultiDataset.__init__-187"><span class="linenos">187</span></a>
</span><span id="MultiDataset.__init__-188"><a href="#MultiDataset.__init__-188"><span class="linenos">188</span></a>            <span class="c1"># Convert data to tensor</span>
</span><span id="MultiDataset.__init__-189"><a href="#MultiDataset.__init__-189"><span class="linenos">189</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">()</span>
</span><span id="MultiDataset.__init__-190"><a href="#MultiDataset.__init__-190"><span class="linenos">190</span></a>
</span><span id="MultiDataset.__init__-191"><a href="#MultiDataset.__init__-191"><span class="linenos">191</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">SUs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SUs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="MultiDataset.__init__-192"><a href="#MultiDataset.__init__-192"><span class="linenos">192</span></a>        <span class="c1"># Set average rates across dataset (so can be quickly accessed)</span>
</span><span id="MultiDataset.__init__-193"><a href="#MultiDataset.__init__-193"><span class="linenos">193</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># need to set to None so can will pre-calculate</span>
</span><span id="MultiDataset.__init__-194"><a href="#MultiDataset.__init__-194"><span class="linenos">194</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avrates</span><span class="p">()</span>
</span><span id="MultiDataset.__init__-195"><a href="#MultiDataset.__init__-195"><span class="linenos">195</span></a>
</span><span id="MultiDataset.__init__-196"><a href="#MultiDataset.__init__-196"><span class="linenos">196</span></a>        <span class="c1"># Make sure beginning of trial-blocks are not used to fit (with num_lags specified)</span>
</span><span id="MultiDataset.__init__-197"><a href="#MultiDataset.__init__-197"><span class="linenos">197</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiDataset.__init__-198"><a href="#MultiDataset.__init__-198"><span class="linenos">198</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">):</span>
</span><span id="MultiDataset.__init__-199"><a href="#MultiDataset.__init__-199"><span class="linenos">199</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lags</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="MultiDataset.__init__-200"><a href="#MultiDataset.__init__-200"><span class="linenos">200</span></a>
</span><span id="MultiDataset.__init__-201"><a href="#MultiDataset.__init__-201"><span class="linenos">201</span></a>        <span class="c1"># Generate drift matrix if selected</span>
</span><span id="MultiDataset.__init__-202"><a href="#MultiDataset.__init__-202"><span class="linenos">202</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">construct_drift_design_matrix</span><span class="p">()</span> 
</span><span id="MultiDataset.__init__-203"><a href="#MultiDataset.__init__-203"><span class="linenos">203</span></a>
</span><span id="MultiDataset.__init__-204"><a href="#MultiDataset.__init__-204"><span class="linenos">204</span></a>        <span class="c1"># Set up default cross-validation config</span>
</span><span id="MultiDataset.__init__-205"><a href="#MultiDataset.__init__-205"><span class="linenos">205</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crossval_setup</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the MultiDataset class.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>filenames:</strong>  list of strings of the filenames (without extension) to load</li>
<li><strong>datadir:</strong>  directory where the data is stored</li>
<li><strong>num_lags:</strong>  how many lags back will the presumed model require (for establishing DFs too)</li>
<li><strong>time_embed:</strong>  whether to time-embed or not</li>
<li><strong>trial_sample:</strong>  whether dataset returns time-contiguous trials for each index or individual time points </li>
<li><strong>device:</strong>  device to put the tensors on</li>
<li><strong>preload:</strong>  whether to load all data into memory at once</li>
<li><strong>includeMUs:</strong>  whether to include MUs in the dataset</li>
</ul>
</div>


                            </div>
                            <div id="MultiDataset.fhandles" class="classattr">
                                <div class="attr variable">
            <span class="name">fhandles</span>

        
    </div>
    <a class="headerlink" href="#MultiDataset.fhandles"></a>
    
    

                            </div>
                            <div id="MultiDataset.file_index" class="classattr">
                                <div class="attr variable">
            <span class="name">file_index</span>

        
    </div>
    <a class="headerlink" href="#MultiDataset.file_index"></a>
    
    

                            </div>
                            <div id="MultiDataset.block_inds" class="classattr">
                                <div class="attr variable">
            <span class="name">block_inds</span>

        
    </div>
    <a class="headerlink" href="#MultiDataset.block_inds"></a>
    
    

                            </div>
                            <div id="MultiDataset.NTfile" class="classattr">
                                <div class="attr variable">
            <span class="name">NTfile</span>

        
    </div>
    <a class="headerlink" href="#MultiDataset.NTfile"></a>
    
    

                            </div>
                            <div id="MultiDataset.unit_ids" class="classattr">
                                <div class="attr variable">
            <span class="name">unit_ids</span>

        
    </div>
    <a class="headerlink" href="#MultiDataset.unit_ids"></a>
    
    

                            </div>
                            <div id="MultiDataset.dims_file" class="classattr">
                                <div class="attr variable">
            <span class="name">dims_file</span>

        
    </div>
    <a class="headerlink" href="#MultiDataset.dims_file"></a>
    
    

                            </div>
                            <div id="MultiDataset.num_blocks" class="classattr">
                                <div class="attr variable">
            <span class="name">num_blocks</span>

        
    </div>
    <a class="headerlink" href="#MultiDataset.num_blocks"></a>
    
    

                            </div>
                            <div id="MultiDataset.block_assign" class="classattr">
                                <div class="attr variable">
            <span class="name">block_assign</span>

        
    </div>
    <a class="headerlink" href="#MultiDataset.block_assign"></a>
    
    

                            </div>
                            <div id="MultiDataset.block_grouping" class="classattr">
                                <div class="attr variable">
            <span class="name">block_grouping</span>

        
    </div>
    <a class="headerlink" href="#MultiDataset.block_grouping"></a>
    
    

                            </div>
                            <div id="MultiDataset.trial_size" class="classattr">
                                <div class="attr variable">
            <span class="name">trial_size</span>

        
    </div>
    <a class="headerlink" href="#MultiDataset.trial_size"></a>
    
    

                            </div>
                            <div id="MultiDataset.dims" class="classattr">
                                <div class="attr variable">
            <span class="name">dims</span>

        
    </div>
    <a class="headerlink" href="#MultiDataset.dims"></a>
    
    

                            </div>
                            <div id="MultiDataset.stim_dims" class="classattr">
                                <div class="attr variable">
            <span class="name">stim_dims</span>

        
    </div>
    <a class="headerlink" href="#MultiDataset.stim_dims"></a>
    
    

                            </div>
                            <div id="MultiDataset.SUs" class="classattr">
                                <div class="attr variable">
            <span class="name">SUs</span>

        
    </div>
    <a class="headerlink" href="#MultiDataset.SUs"></a>
    
    

                            </div>
                            <div id="MultiDataset.avRs" class="classattr">
                                <div class="attr variable">
            <span class="name">avRs</span>

        
    </div>
    <a class="headerlink" href="#MultiDataset.avRs"></a>
    
    

                            </div>
                            <div id="MultiDataset.to_tensor" class="classattr">
                                        <input id="MultiDataset.to_tensor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">to_tensor</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">device</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiDataset.to_tensor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiDataset.to_tensor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiDataset.to_tensor-208"><a href="#MultiDataset.to_tensor-208"><span class="linenos">208</span></a>    <span class="k">def</span> <span class="nf">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="MultiDataset.to_tensor-209"><a href="#MultiDataset.to_tensor-209"><span class="linenos">209</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiDataset.to_tensor-210"><a href="#MultiDataset.to_tensor-210"><span class="linenos">210</span></a><span class="sd">        Convert all data to tensors</span>
</span><span id="MultiDataset.to_tensor-211"><a href="#MultiDataset.to_tensor-211"><span class="linenos">211</span></a>
</span><span id="MultiDataset.to_tensor-212"><a href="#MultiDataset.to_tensor-212"><span class="linenos">212</span></a><span class="sd">        Args:</span>
</span><span id="MultiDataset.to_tensor-213"><a href="#MultiDataset.to_tensor-213"><span class="linenos">213</span></a><span class="sd">            device: device to put the tensors on</span>
</span><span id="MultiDataset.to_tensor-214"><a href="#MultiDataset.to_tensor-214"><span class="linenos">214</span></a>
</span><span id="MultiDataset.to_tensor-215"><a href="#MultiDataset.to_tensor-215"><span class="linenos">215</span></a><span class="sd">        Returns:</span>
</span><span id="MultiDataset.to_tensor-216"><a href="#MultiDataset.to_tensor-216"><span class="linenos">216</span></a><span class="sd">            None</span>
</span><span id="MultiDataset.to_tensor-217"><a href="#MultiDataset.to_tensor-217"><span class="linenos">217</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiDataset.to_tensor-218"><a href="#MultiDataset.to_tensor-218"><span class="linenos">218</span></a>        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiDataset.to_tensor-219"><a href="#MultiDataset.to_tensor-219"><span class="linenos">219</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiDataset.to_tensor-220"><a href="#MultiDataset.to_tensor-220"><span class="linenos">220</span></a>                <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</span><span id="MultiDataset.to_tensor-221"><a href="#MultiDataset.to_tensor-221"><span class="linenos">221</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiDataset.to_tensor-222"><a href="#MultiDataset.to_tensor-222"><span class="linenos">222</span></a>                <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span>
</span><span id="MultiDataset.to_tensor-223"><a href="#MultiDataset.to_tensor-223"><span class="linenos">223</span></a>
</span><span id="MultiDataset.to_tensor-224"><a href="#MultiDataset.to_tensor-224"><span class="linenos">224</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span> <span class="o">!=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="MultiDataset.to_tensor-225"><a href="#MultiDataset.to_tensor-225"><span class="linenos">225</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="MultiDataset.to_tensor-226"><a href="#MultiDataset.to_tensor-226"><span class="linenos">226</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="MultiDataset.to_tensor-227"><a href="#MultiDataset.to_tensor-227"><span class="linenos">227</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="MultiDataset.to_tensor-228"><a href="#MultiDataset.to_tensor-228"><span class="linenos">228</span></a>        <span class="k">else</span><span class="p">:</span> 
</span><span id="MultiDataset.to_tensor-229"><a href="#MultiDataset.to_tensor-229"><span class="linenos">229</span></a>            <span class="c1"># Simply move to device:</span>
</span><span id="MultiDataset.to_tensor-230"><a href="#MultiDataset.to_tensor-230"><span class="linenos">230</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">to</span><span class="p">(</span> <span class="n">device</span> <span class="p">)</span>
</span><span id="MultiDataset.to_tensor-231"><a href="#MultiDataset.to_tensor-231"><span class="linenos">231</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span> <span class="n">device</span> <span class="p">)</span>
</span><span id="MultiDataset.to_tensor-232"><a href="#MultiDataset.to_tensor-232"><span class="linenos">232</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span> <span class="n">device</span> <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Convert all data to tensors</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>device:</strong>  device to put the tensors on</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiDataset.avrates" class="classattr">
                                        <input id="MultiDataset.avrates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">avrates</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">inds</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiDataset.avrates-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiDataset.avrates"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiDataset.avrates-318"><a href="#MultiDataset.avrates-318"><span class="linenos">318</span></a>    <span class="k">def</span> <span class="nf">avrates</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="MultiDataset.avrates-319"><a href="#MultiDataset.avrates-319"><span class="linenos">319</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiDataset.avrates-320"><a href="#MultiDataset.avrates-320"><span class="linenos">320</span></a><span class="sd">        Calculates average firing probability across specified inds (or whole dataset)</span>
</span><span id="MultiDataset.avrates-321"><a href="#MultiDataset.avrates-321"><span class="linenos">321</span></a><span class="sd">        -- Note will respect datafilters</span>
</span><span id="MultiDataset.avrates-322"><a href="#MultiDataset.avrates-322"><span class="linenos">322</span></a><span class="sd">        -- will return precalc value to save time if already stored</span>
</span><span id="MultiDataset.avrates-323"><a href="#MultiDataset.avrates-323"><span class="linenos">323</span></a>
</span><span id="MultiDataset.avrates-324"><a href="#MultiDataset.avrates-324"><span class="linenos">324</span></a><span class="sd">        Args:</span>
</span><span id="MultiDataset.avrates-325"><a href="#MultiDataset.avrates-325"><span class="linenos">325</span></a><span class="sd">            inds: indices to calculate across</span>
</span><span id="MultiDataset.avrates-326"><a href="#MultiDataset.avrates-326"><span class="linenos">326</span></a>
</span><span id="MultiDataset.avrates-327"><a href="#MultiDataset.avrates-327"><span class="linenos">327</span></a><span class="sd">        Returns:</span>
</span><span id="MultiDataset.avrates-328"><a href="#MultiDataset.avrates-328"><span class="linenos">328</span></a><span class="sd">            avRs: average firing rates across the dataset</span>
</span><span id="MultiDataset.avrates-329"><a href="#MultiDataset.avrates-329"><span class="linenos">329</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiDataset.avrates-330"><a href="#MultiDataset.avrates-330"><span class="linenos">330</span></a>        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiDataset.avrates-331"><a href="#MultiDataset.avrates-331"><span class="linenos">331</span></a>            <span class="n">inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="MultiDataset.avrates-332"><a href="#MultiDataset.avrates-332"><span class="linenos">332</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NT</span><span class="p">:</span>
</span><span id="MultiDataset.avrates-333"><a href="#MultiDataset.avrates-333"><span class="linenos">333</span></a>            <span class="c1"># then calculate across whole dataset</span>
</span><span id="MultiDataset.avrates-334"><a href="#MultiDataset.avrates-334"><span class="linenos">334</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiDataset.avrates-335"><a href="#MultiDataset.avrates-335"><span class="linenos">335</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiDataset.avrates-336"><a href="#MultiDataset.avrates-336"><span class="linenos">336</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span>
</span><span id="MultiDataset.avrates-337"><a href="#MultiDataset.avrates-337"><span class="linenos">337</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avRs</span><span class="p">):</span>
</span><span id="MultiDataset.avrates-338"><a href="#MultiDataset.avrates-338"><span class="linenos">338</span></a>                    <span class="c1"># then precalculated and do not need to do</span>
</span><span id="MultiDataset.avrates-339"><a href="#MultiDataset.avrates-339"><span class="linenos">339</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">avRs</span>
</span><span id="MultiDataset.avrates-340"><a href="#MultiDataset.avrates-340"><span class="linenos">340</span></a>
</span><span id="MultiDataset.avrates-341"><a href="#MultiDataset.avrates-341"><span class="linenos">341</span></a>        <span class="c1"># Otherwise calculate across all data</span>
</span><span id="MultiDataset.avrates-342"><a href="#MultiDataset.avrates-342"><span class="linenos">342</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
</span><span id="MultiDataset.avrates-343"><a href="#MultiDataset.avrates-343"><span class="linenos">343</span></a>            <span class="n">Reff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="MultiDataset.avrates-344"><a href="#MultiDataset.avrates-344"><span class="linenos">344</span></a>            <span class="n">Teff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="MultiDataset.avrates-345"><a href="#MultiDataset.avrates-345"><span class="linenos">345</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiDataset.avrates-346"><a href="#MultiDataset.avrates-346"><span class="linenos">346</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiDataset.avrates-347"><a href="#MultiDataset.avrates-347"><span class="linenos">347</span></a>                    <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">]</span><span class="o">/</span><span class="n">Teff</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_out</span><span class="p">])</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="MultiDataset.avrates-348"><a href="#MultiDataset.avrates-348"><span class="linenos">348</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">Reff</span><span class="o">/</span><span class="n">Teff</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="MultiDataset.avrates-349"><a href="#MultiDataset.avrates-349"><span class="linenos">349</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiDataset.avrates-350"><a href="#MultiDataset.avrates-350"><span class="linenos">350</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Still need to implement avRs without preloading&#39;</span><span class="p">)</span>
</span><span id="MultiDataset.avrates-351"><a href="#MultiDataset.avrates-351"><span class="linenos">351</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Calculates average firing probability across specified inds (or whole dataset)
-- Note will respect datafilters
-- will return precalc value to save time if already stored</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>inds:</strong>  indices to calculate across</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>avRs: average firing rates across the dataset</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiDataset.subset" class="classattr">
                                        <input id="MultiDataset.subset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">subset</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">indxs</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">train</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">val</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">device</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiDataset.subset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiDataset.subset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiDataset.subset-354"><a href="#MultiDataset.subset-354"><span class="linenos">354</span></a>    <span class="k">def</span> <span class="nf">subset</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">indxs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="MultiDataset.subset-355"><a href="#MultiDataset.subset-355"><span class="linenos">355</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiDataset.subset-356"><a href="#MultiDataset.subset-356"><span class="linenos">356</span></a><span class="sd">        Subsets the dataset to only include the specified indices.</span>
</span><span id="MultiDataset.subset-357"><a href="#MultiDataset.subset-357"><span class="linenos">357</span></a>
</span><span id="MultiDataset.subset-358"><a href="#MultiDataset.subset-358"><span class="linenos">358</span></a><span class="sd">        Args:</span>
</span><span id="MultiDataset.subset-359"><a href="#MultiDataset.subset-359"><span class="linenos">359</span></a><span class="sd">            indxs: indices to subset the dataset to</span>
</span><span id="MultiDataset.subset-360"><a href="#MultiDataset.subset-360"><span class="linenos">360</span></a><span class="sd">            train: whether to subset the training set</span>
</span><span id="MultiDataset.subset-361"><a href="#MultiDataset.subset-361"><span class="linenos">361</span></a><span class="sd">            val: whether to subset the validation set</span>
</span><span id="MultiDataset.subset-362"><a href="#MultiDataset.subset-362"><span class="linenos">362</span></a><span class="sd">            device: device to put the tensors on</span>
</span><span id="MultiDataset.subset-363"><a href="#MultiDataset.subset-363"><span class="linenos">363</span></a>
</span><span id="MultiDataset.subset-364"><a href="#MultiDataset.subset-364"><span class="linenos">364</span></a><span class="sd">        Returns:</span>
</span><span id="MultiDataset.subset-365"><a href="#MultiDataset.subset-365"><span class="linenos">365</span></a><span class="sd">            None</span>
</span><span id="MultiDataset.subset-366"><a href="#MultiDataset.subset-366"><span class="linenos">366</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiDataset.subset-367"><a href="#MultiDataset.subset-367"><span class="linenos">367</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">,</span> <span class="s2">&quot;Need preloaded data for this to work&quot;</span>
</span><span id="MultiDataset.subset-368"><a href="#MultiDataset.subset-368"><span class="linenos">368</span></a>
</span><span id="MultiDataset.subset-369"><a href="#MultiDataset.subset-369"><span class="linenos">369</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fhandles</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MultiDataset.subset-370"><a href="#MultiDataset.subset-370"><span class="linenos">370</span></a>        <span class="k">if</span> <span class="n">indxs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MultiDataset.subset-371"><a href="#MultiDataset.subset-371"><span class="linenos">371</span></a>            <span class="k">if</span> <span class="n">train</span><span class="p">:</span>
</span><span id="MultiDataset.subset-372"><a href="#MultiDataset.subset-372"><span class="linenos">372</span></a>                <span class="k">assert</span> <span class="ow">not</span> <span class="n">val</span><span class="p">,</span> <span class="s2">&quot;Either train or val must be false.&quot;</span>
</span><span id="MultiDataset.subset-373"><a href="#MultiDataset.subset-373"><span class="linenos">373</span></a>                <span class="n">indxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span>
</span><span id="MultiDataset.subset-374"><a href="#MultiDataset.subset-374"><span class="linenos">374</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiDataset.subset-375"><a href="#MultiDataset.subset-375"><span class="linenos">375</span></a>                <span class="k">assert</span> <span class="n">val</span><span class="p">,</span> <span class="s2">&quot;Either train or val must be true&quot;</span>
</span><span id="MultiDataset.subset-376"><a href="#MultiDataset.subset-376"><span class="linenos">376</span></a>                <span class="n">indxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span>
</span><span id="MultiDataset.subset-377"><a href="#MultiDataset.subset-377"><span class="linenos">377</span></a>        
</span><span id="MultiDataset.subset-378"><a href="#MultiDataset.subset-378"><span class="linenos">378</span></a>        <span class="c1"># Crop all preloaded data down to indices</span>
</span><span id="MultiDataset.subset-379"><a href="#MultiDataset.subset-379"><span class="linenos">379</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MultiDataset.subset-380"><a href="#MultiDataset.subset-380"><span class="linenos">380</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MultiDataset.subset-381"><a href="#MultiDataset.subset-381"><span class="linenos">381</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim</span><span class="p">[</span><span class="n">indxs</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="MultiDataset.subset-382"><a href="#MultiDataset.subset-382"><span class="linenos">382</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robs</span><span class="p">[</span><span class="n">indxs</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="MultiDataset.subset-383"><a href="#MultiDataset.subset-383"><span class="linenos">383</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="n">indxs</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="MultiDataset.subset-384"><a href="#MultiDataset.subset-384"><span class="linenos">384</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">NT</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indxs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Subsets the dataset to only include the specified indices.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>indxs:</strong>  indices to subset the dataset to</li>
<li><strong>train:</strong>  whether to subset the training set</li>
<li><strong>val:</strong>  whether to subset the validation set</li>
<li><strong>device:</strong>  device to put the tensors on</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiDataset.shift_stim_fixation" class="classattr">
                                        <input id="MultiDataset.shift_stim_fixation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">shift_stim_fixation</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">stim</span>, </span><span class="param"><span class="n">shift</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiDataset.shift_stim_fixation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiDataset.shift_stim_fixation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiDataset.shift_stim_fixation-387"><a href="#MultiDataset.shift_stim_fixation-387"><span class="linenos">387</span></a>    <span class="k">def</span> <span class="nf">shift_stim_fixation</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stim</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
</span><span id="MultiDataset.shift_stim_fixation-388"><a href="#MultiDataset.shift_stim_fixation-388"><span class="linenos">388</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiDataset.shift_stim_fixation-389"><a href="#MultiDataset.shift_stim_fixation-389"><span class="linenos">389</span></a><span class="sd">        Simple shift by integer (rounded shift) and zero padded. Note that this is not in </span>
</span><span id="MultiDataset.shift_stim_fixation-390"><a href="#MultiDataset.shift_stim_fixation-390"><span class="linenos">390</span></a><span class="sd">        is in units of number of bars, rather than -1 to +1. It assumes the stim</span>
</span><span id="MultiDataset.shift_stim_fixation-391"><a href="#MultiDataset.shift_stim_fixation-391"><span class="linenos">391</span></a><span class="sd">        has a batch dimension (over a fixation), and shifts the whole stim by the same amount.</span>
</span><span id="MultiDataset.shift_stim_fixation-392"><a href="#MultiDataset.shift_stim_fixation-392"><span class="linenos">392</span></a><span class="sd">        </span>
</span><span id="MultiDataset.shift_stim_fixation-393"><a href="#MultiDataset.shift_stim_fixation-393"><span class="linenos">393</span></a><span class="sd">        Args:</span>
</span><span id="MultiDataset.shift_stim_fixation-394"><a href="#MultiDataset.shift_stim_fixation-394"><span class="linenos">394</span></a><span class="sd">            stim: stimulus tensor to shift</span>
</span><span id="MultiDataset.shift_stim_fixation-395"><a href="#MultiDataset.shift_stim_fixation-395"><span class="linenos">395</span></a><span class="sd">            shift: amount to shift the stimulus by</span>
</span><span id="MultiDataset.shift_stim_fixation-396"><a href="#MultiDataset.shift_stim_fixation-396"><span class="linenos">396</span></a>
</span><span id="MultiDataset.shift_stim_fixation-397"><a href="#MultiDataset.shift_stim_fixation-397"><span class="linenos">397</span></a><span class="sd">        Returns:</span>
</span><span id="MultiDataset.shift_stim_fixation-398"><a href="#MultiDataset.shift_stim_fixation-398"><span class="linenos">398</span></a><span class="sd">            shstim: shifted stimulus tensor</span>
</span><span id="MultiDataset.shift_stim_fixation-399"><a href="#MultiDataset.shift_stim_fixation-399"><span class="linenos">399</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiDataset.shift_stim_fixation-400"><a href="#MultiDataset.shift_stim_fixation-400"><span class="linenos">400</span></a>        <span class="n">sh</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span>
</span><span id="MultiDataset.shift_stim_fixation-401"><a href="#MultiDataset.shift_stim_fixation-401"><span class="linenos">401</span></a>        <span class="n">shstim</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="MultiDataset.shift_stim_fixation-402"><a href="#MultiDataset.shift_stim_fixation-402"><span class="linenos">402</span></a>        <span class="k">if</span> <span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiDataset.shift_stim_fixation-403"><a href="#MultiDataset.shift_stim_fixation-403"><span class="linenos">403</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="o">-</span><span class="n">sh</span><span class="p">:]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="p">:</span><span class="n">sh</span><span class="p">]</span>
</span><span id="MultiDataset.shift_stim_fixation-404"><a href="#MultiDataset.shift_stim_fixation-404"><span class="linenos">404</span></a>        <span class="k">elif</span> <span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MultiDataset.shift_stim_fixation-405"><a href="#MultiDataset.shift_stim_fixation-405"><span class="linenos">405</span></a>            <span class="n">shstim</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim</span><span class="p">[:,</span> <span class="n">sh</span><span class="p">:]</span>
</span><span id="MultiDataset.shift_stim_fixation-406"><a href="#MultiDataset.shift_stim_fixation-406"><span class="linenos">406</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiDataset.shift_stim_fixation-407"><a href="#MultiDataset.shift_stim_fixation-407"><span class="linenos">407</span></a>            <span class="n">shstim</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
</span><span id="MultiDataset.shift_stim_fixation-408"><a href="#MultiDataset.shift_stim_fixation-408"><span class="linenos">408</span></a>
</span><span id="MultiDataset.shift_stim_fixation-409"><a href="#MultiDataset.shift_stim_fixation-409"><span class="linenos">409</span></a>        <span class="k">return</span> <span class="n">shstim</span>
</span></pre></div>


            <div class="docstring"><p>Simple shift by integer (rounded shift) and zero padded. Note that this is not in 
is in units of number of bars, rather than -1 to +1. It assumes the stim
has a batch dimension (over a fixation), and shifts the whole stim by the same amount.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>stim:</strong>  stimulus tensor to shift</li>
<li><strong>shift:</strong>  amount to shift the stimulus by</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>shstim: shifted stimulus tensor</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiDataset.crossval_setup" class="classattr">
                                        <input id="MultiDataset.crossval_setup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">crossval_setup</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">folds</span><span class="o">=</span><span class="mi">5</span>, </span><span class="param"><span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">test_set</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiDataset.crossval_setup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiDataset.crossval_setup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiDataset.crossval_setup-412"><a href="#MultiDataset.crossval_setup-412"><span class="linenos">412</span></a>    <span class="k">def</span> <span class="nf">crossval_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test_set</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="MultiDataset.crossval_setup-413"><a href="#MultiDataset.crossval_setup-413"><span class="linenos">413</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiDataset.crossval_setup-414"><a href="#MultiDataset.crossval_setup-414"><span class="linenos">414</span></a><span class="sd">        This sets the cross-validation indices up We can add featuers here. Many ways to do this</span>
</span><span id="MultiDataset.crossval_setup-415"><a href="#MultiDataset.crossval_setup-415"><span class="linenos">415</span></a><span class="sd">        but will stick to some standard for now. It sets the internal indices, which can be read out</span>
</span><span id="MultiDataset.crossval_setup-416"><a href="#MultiDataset.crossval_setup-416"><span class="linenos">416</span></a><span class="sd">        directly or with helper functions. Perhaps helper_functions is the best way....</span>
</span><span id="MultiDataset.crossval_setup-417"><a href="#MultiDataset.crossval_setup-417"><span class="linenos">417</span></a><span class="sd">        </span>
</span><span id="MultiDataset.crossval_setup-418"><a href="#MultiDataset.crossval_setup-418"><span class="linenos">418</span></a><span class="sd">        Args:</span>
</span><span id="MultiDataset.crossval_setup-419"><a href="#MultiDataset.crossval_setup-419"><span class="linenos">419</span></a><span class="sd">            folds: number of folds to use for cross-validation</span>
</span><span id="MultiDataset.crossval_setup-420"><a href="#MultiDataset.crossval_setup-420"><span class="linenos">420</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="MultiDataset.crossval_setup-421"><a href="#MultiDataset.crossval_setup-421"><span class="linenos">421</span></a><span class="sd">            test_set: whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</span>
</span><span id="MultiDataset.crossval_setup-422"><a href="#MultiDataset.crossval_setup-422"><span class="linenos">422</span></a><span class="sd">        </span>
</span><span id="MultiDataset.crossval_setup-423"><a href="#MultiDataset.crossval_setup-423"><span class="linenos">423</span></a><span class="sd">        Returns:</span>
</span><span id="MultiDataset.crossval_setup-424"><a href="#MultiDataset.crossval_setup-424"><span class="linenos">424</span></a><span class="sd">            None: sets internal variables test_inds, train_inds, val_inds</span>
</span><span id="MultiDataset.crossval_setup-425"><a href="#MultiDataset.crossval_setup-425"><span class="linenos">425</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiDataset.crossval_setup-426"><a href="#MultiDataset.crossval_setup-426"><span class="linenos">426</span></a>
</span><span id="MultiDataset.crossval_setup-427"><a href="#MultiDataset.crossval_setup-427"><span class="linenos">427</span></a>        <span class="n">test_fixes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset.crossval_setup-428"><a href="#MultiDataset.crossval_setup-428"><span class="linenos">428</span></a>        <span class="n">tfixes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset.crossval_setup-429"><a href="#MultiDataset.crossval_setup-429"><span class="linenos">429</span></a>        <span class="n">vfixes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset.crossval_setup-430"><a href="#MultiDataset.crossval_setup-430"><span class="linenos">430</span></a>        <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_grouping</span><span class="p">)):</span>
</span><span id="MultiDataset.crossval_setup-431"><a href="#MultiDataset.crossval_setup-431"><span class="linenos">431</span></a>            <span class="n">blk_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_grouping</span><span class="p">[</span><span class="n">ee</span><span class="p">]</span>
</span><span id="MultiDataset.crossval_setup-432"><a href="#MultiDataset.crossval_setup-432"><span class="linenos">432</span></a>            <span class="n">vfix1</span><span class="p">,</span> <span class="n">tfix1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="MultiDataset.crossval_setup-433"><a href="#MultiDataset.crossval_setup-433"><span class="linenos">433</span></a>            <span class="k">if</span> <span class="n">test_set</span><span class="p">:</span>
</span><span id="MultiDataset.crossval_setup-434"><a href="#MultiDataset.crossval_setup-434"><span class="linenos">434</span></a>                <span class="n">test_fixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">[</span><span class="n">vfix1</span><span class="p">])</span>
</span><span id="MultiDataset.crossval_setup-435"><a href="#MultiDataset.crossval_setup-435"><span class="linenos">435</span></a>                <span class="n">vfix2</span><span class="p">,</span> <span class="n">tfix2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tfix1</span><span class="p">),</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="n">random_gen</span><span class="p">)</span>
</span><span id="MultiDataset.crossval_setup-436"><a href="#MultiDataset.crossval_setup-436"><span class="linenos">436</span></a>                <span class="n">vfixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">[</span><span class="n">tfix1</span><span class="p">[</span><span class="n">vfix2</span><span class="p">]])</span>
</span><span id="MultiDataset.crossval_setup-437"><a href="#MultiDataset.crossval_setup-437"><span class="linenos">437</span></a>                <span class="n">tfixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">[</span><span class="n">tfix1</span><span class="p">[</span><span class="n">tfix2</span><span class="p">]])</span>
</span><span id="MultiDataset.crossval_setup-438"><a href="#MultiDataset.crossval_setup-438"><span class="linenos">438</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MultiDataset.crossval_setup-439"><a href="#MultiDataset.crossval_setup-439"><span class="linenos">439</span></a>                <span class="n">vfixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">[</span><span class="n">vfix1</span><span class="p">])</span>
</span><span id="MultiDataset.crossval_setup-440"><a href="#MultiDataset.crossval_setup-440"><span class="linenos">440</span></a>                <span class="n">tfixes</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">blk_inds</span><span class="p">[</span><span class="n">tfix1</span><span class="p">])</span>
</span><span id="MultiDataset.crossval_setup-441"><a href="#MultiDataset.crossval_setup-441"><span class="linenos">441</span></a>
</span><span id="MultiDataset.crossval_setup-442"><a href="#MultiDataset.crossval_setup-442"><span class="linenos">442</span></a>        <span class="n">val_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vfixes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
</span><span id="MultiDataset.crossval_setup-443"><a href="#MultiDataset.crossval_setup-443"><span class="linenos">443</span></a>        <span class="n">train_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tfixes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
</span><span id="MultiDataset.crossval_setup-444"><a href="#MultiDataset.crossval_setup-444"><span class="linenos">444</span></a>        
</span><span id="MultiDataset.crossval_setup-445"><a href="#MultiDataset.crossval_setup-445"><span class="linenos">445</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_blks</span> <span class="o">=</span> <span class="n">val_blks</span>
</span><span id="MultiDataset.crossval_setup-446"><a href="#MultiDataset.crossval_setup-446"><span class="linenos">446</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_blks</span> <span class="o">=</span> <span class="n">train_blks</span>
</span><span id="MultiDataset.crossval_setup-447"><a href="#MultiDataset.crossval_setup-447"><span class="linenos">447</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_blks</span> <span class="o">=</span> <span class="n">test_fixes</span>
</span><span id="MultiDataset.crossval_setup-448"><a href="#MultiDataset.crossval_setup-448"><span class="linenos">448</span></a>
</span><span id="MultiDataset.crossval_setup-449"><a href="#MultiDataset.crossval_setup-449"><span class="linenos">449</span></a>        <span class="c1"># Assign indexes based on validation by block</span>
</span><span id="MultiDataset.crossval_setup-450"><a href="#MultiDataset.crossval_setup-450"><span class="linenos">450</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset.crossval_setup-451"><a href="#MultiDataset.crossval_setup-451"><span class="linenos">451</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset.crossval_setup-452"><a href="#MultiDataset.crossval_setup-452"><span class="linenos">452</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MultiDataset.crossval_setup-453"><a href="#MultiDataset.crossval_setup-453"><span class="linenos">453</span></a>        <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="n">train_blks</span><span class="p">:</span>
</span><span id="MultiDataset.crossval_setup-454"><a href="#MultiDataset.crossval_setup-454"><span class="linenos">454</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">])</span>
</span><span id="MultiDataset.crossval_setup-455"><a href="#MultiDataset.crossval_setup-455"><span class="linenos">455</span></a>        <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="n">val_blks</span><span class="p">:</span>
</span><span id="MultiDataset.crossval_setup-456"><a href="#MultiDataset.crossval_setup-456"><span class="linenos">456</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">])</span>
</span><span id="MultiDataset.crossval_setup-457"><a href="#MultiDataset.crossval_setup-457"><span class="linenos">457</span></a>        <span class="k">if</span> <span class="n">test_set</span><span class="p">:</span>
</span><span id="MultiDataset.crossval_setup-458"><a href="#MultiDataset.crossval_setup-458"><span class="linenos">458</span></a>            <span class="n">test_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_fixes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
</span><span id="MultiDataset.crossval_setup-459"><a href="#MultiDataset.crossval_setup-459"><span class="linenos">459</span></a>            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="n">test_blks</span><span class="p">:</span>
</span><span id="MultiDataset.crossval_setup-460"><a href="#MultiDataset.crossval_setup-460"><span class="linenos">460</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_inds</span><span class="p">[</span><span class="n">bb</span><span class="p">])</span>
</span><span id="MultiDataset.crossval_setup-461"><a href="#MultiDataset.crossval_setup-461"><span class="linenos">461</span></a>
</span><span id="MultiDataset.crossval_setup-462"><a href="#MultiDataset.crossval_setup-462"><span class="linenos">462</span></a>        <span class="c1"># finally convert to np.array</span>
</span><span id="MultiDataset.crossval_setup-463"><a href="#MultiDataset.crossval_setup-463"><span class="linenos">463</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_inds</span><span class="p">)</span>
</span><span id="MultiDataset.crossval_setup-464"><a href="#MultiDataset.crossval_setup-464"><span class="linenos">464</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_inds</span><span class="p">)</span>
</span><span id="MultiDataset.crossval_setup-465"><a href="#MultiDataset.crossval_setup-465"><span class="linenos">465</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_inds</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This sets the cross-validation indices up We can add featuers here. Many ways to do this
but will stick to some standard for now. It sets the internal indices, which can be read out
directly or with helper functions. Perhaps helper_functions is the best way....</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>folds:</strong>  number of folds to use for cross-validation</li>
<li><strong>random_gen:</strong>  whether to pick random fixations for validation or uniformly distributed</li>
<li><strong>test_set:</strong>  whether to set aside first an n-fold test set, and then within the rest n-fold train/val sets</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: sets internal variables test_inds, train_inds, val_inds</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiDataset.fold_sample" class="classattr">
                                        <input id="MultiDataset.fold_sample-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fold_sample</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">num_items</span>, </span><span class="param"><span class="n">folds</span>, </span><span class="param"><span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiDataset.fold_sample-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiDataset.fold_sample"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiDataset.fold_sample-468"><a href="#MultiDataset.fold_sample-468"><span class="linenos">468</span></a>    <span class="k">def</span> <span class="nf">fold_sample</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">random_gen</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="MultiDataset.fold_sample-469"><a href="#MultiDataset.fold_sample-469"><span class="linenos">469</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MultiDataset.fold_sample-470"><a href="#MultiDataset.fold_sample-470"><span class="linenos">470</span></a><span class="sd">        This really should be a general method not associated with self.</span>
</span><span id="MultiDataset.fold_sample-471"><a href="#MultiDataset.fold_sample-471"><span class="linenos">471</span></a><span class="sd">        </span>
</span><span id="MultiDataset.fold_sample-472"><a href="#MultiDataset.fold_sample-472"><span class="linenos">472</span></a><span class="sd">        Args:</span>
</span><span id="MultiDataset.fold_sample-473"><a href="#MultiDataset.fold_sample-473"><span class="linenos">473</span></a><span class="sd">            num_items: number of items to fold</span>
</span><span id="MultiDataset.fold_sample-474"><a href="#MultiDataset.fold_sample-474"><span class="linenos">474</span></a><span class="sd">            folds: number of folds to use</span>
</span><span id="MultiDataset.fold_sample-475"><a href="#MultiDataset.fold_sample-475"><span class="linenos">475</span></a><span class="sd">            random_gen: whether to pick random fixations for validation or uniformly distributed</span>
</span><span id="MultiDataset.fold_sample-476"><a href="#MultiDataset.fold_sample-476"><span class="linenos">476</span></a>
</span><span id="MultiDataset.fold_sample-477"><a href="#MultiDataset.fold_sample-477"><span class="linenos">477</span></a><span class="sd">        Returns:</span>
</span><span id="MultiDataset.fold_sample-478"><a href="#MultiDataset.fold_sample-478"><span class="linenos">478</span></a><span class="sd">            val_items: indices for the validation set</span>
</span><span id="MultiDataset.fold_sample-479"><a href="#MultiDataset.fold_sample-479"><span class="linenos">479</span></a><span class="sd">            rem_items: indices for the remaining set</span>
</span><span id="MultiDataset.fold_sample-480"><a href="#MultiDataset.fold_sample-480"><span class="linenos">480</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MultiDataset.fold_sample-481"><a href="#MultiDataset.fold_sample-481"><span class="linenos">481</span></a>        <span class="k">if</span> <span class="n">random_gen</span><span class="p">:</span>
</span><span id="MultiDataset.fold_sample-482"><a href="#MultiDataset.fold_sample-482"><span class="linenos">482</span></a>            <span class="n">num_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_items</span><span class="o">/</span><span class="n">folds</span><span class="p">)</span>
</span><span id="MultiDataset.fold_sample-483"><a href="#MultiDataset.fold_sample-483"><span class="linenos">483</span></a>            <span class="n">tmp_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">num_items</span><span class="p">)</span>
</span><span id="MultiDataset.fold_sample-484"><a href="#MultiDataset.fold_sample-484"><span class="linenos">484</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[:</span><span class="n">num_val</span><span class="p">])</span>
</span><span id="MultiDataset.fold_sample-485"><a href="#MultiDataset.fold_sample-485"><span class="linenos">485</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tmp_seq</span><span class="p">[</span><span class="n">num_val</span><span class="p">:])</span>
</span><span id="MultiDataset.fold_sample-486"><a href="#MultiDataset.fold_sample-486"><span class="linenos">486</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MultiDataset.fold_sample-487"><a href="#MultiDataset.fold_sample-487"><span class="linenos">487</span></a>            <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">folds</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="MultiDataset.fold_sample-488"><a href="#MultiDataset.fold_sample-488"><span class="linenos">488</span></a>            <span class="n">val_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">num_items</span><span class="p">,</span> <span class="n">folds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
</span><span id="MultiDataset.fold_sample-489"><a href="#MultiDataset.fold_sample-489"><span class="linenos">489</span></a>            <span class="n">rem_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">),</span> <span class="n">val_items</span><span class="p">)</span>
</span><span id="MultiDataset.fold_sample-490"><a href="#MultiDataset.fold_sample-490"><span class="linenos">490</span></a>        <span class="k">return</span> <span class="n">val_items</span><span class="p">,</span> <span class="n">rem_items</span>
</span></pre></div>


            <div class="docstring"><p>This really should be a general method not associated with self.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>num_items:</strong>  number of items to fold</li>
<li><strong>folds:</strong>  number of folds to use</li>
<li><strong>random_gen:</strong>  whether to pick random fixations for validation or uniformly distributed</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>val_items: indices for the validation set
  rem_items: indices for the remaining set</p>
</blockquote>
</div>


                            </div>
                            <div id="MultiDataset.collate_blocks" class="classattr">
                                        <input id="MultiDataset.collate_blocks-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">collate_blocks</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">data</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MultiDataset.collate_blocks-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MultiDataset.collate_blocks"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MultiDataset.collate_blocks-492"><a href="#MultiDataset.collate_blocks-492"><span class="linenos">492</span></a>    <span class="nd">@staticmethod</span>
</span><span id="MultiDataset.collate_blocks-493"><a href="#MultiDataset.collate_blocks-493"><span class="linenos">493</span></a>    <span class="k">def</span> <span class="nf">collate_blocks</span><span class="p">(</span> <span class="n">data</span> <span class="p">):</span>
</span><span id="MultiDataset.collate_blocks-494"><a href="#MultiDataset.collate_blocks-494"><span class="linenos">494</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Alternative to the collate function that attaches blocks labeled by one index together</span>
</span><span id="MultiDataset.collate_blocks-495"><a href="#MultiDataset.collate_blocks-495"><span class="linenos">495</span></a><span class="sd">        To explain: if you ask for one index (of a block) from the dataset like [1] and get back </span>
</span><span id="MultiDataset.collate_blocks-496"><a href="#MultiDataset.collate_blocks-496"><span class="linenos">496</span></a><span class="sd">        a block of data (B x M), the default collate_fn will still treat this as one data sample </span>
</span><span id="MultiDataset.collate_blocks-497"><a href="#MultiDataset.collate_blocks-497"><span class="linenos">497</span></a><span class="sd">        (1 x B x M) rather than the B data samples in the block. This is a simple flatten...</span>
</span><span id="MultiDataset.collate_blocks-498"><a href="#MultiDataset.collate_blocks-498"><span class="linenos">498</span></a><span class="sd">        Note: assumes that this is getting a dictionary, of course&quot;&quot;&quot;</span>
</span><span id="MultiDataset.collate_blocks-499"><a href="#MultiDataset.collate_blocks-499"><span class="linenos">499</span></a>        <span class="c1">#print(len(data))</span>
</span><span id="MultiDataset.collate_blocks-500"><a href="#MultiDataset.collate_blocks-500"><span class="linenos">500</span></a>        <span class="n">data_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MultiDataset.collate_blocks-501"><a href="#MultiDataset.collate_blocks-501"><span class="linenos">501</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
</span><span id="MultiDataset.collate_blocks-502"><a href="#MultiDataset.collate_blocks-502"><span class="linenos">502</span></a>            <span class="k">for</span> <span class="n">dsub</span> <span class="ow">in</span> <span class="n">data_out</span><span class="p">:</span>
</span><span id="MultiDataset.collate_blocks-503"><a href="#MultiDataset.collate_blocks-503"><span class="linenos">503</span></a>                <span class="n">data_out</span><span class="p">[</span><span class="n">dsub</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span> <span class="p">(</span><span class="n">data_out</span><span class="p">[</span><span class="n">dsub</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">dsub</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
</span><span id="MultiDataset.collate_blocks-504"><a href="#MultiDataset.collate_blocks-504"><span class="linenos">504</span></a>            <span class="c1"># if trainer concatentates batches incorrectly --- this is a kluge</span>
</span><span id="MultiDataset.collate_blocks-505"><a href="#MultiDataset.collate_blocks-505"><span class="linenos">505</span></a>            <span class="c1"># if len(data[dsub].shape) &gt; 2:  # more general without this &#39;if&#39;, assuming above</span>
</span><span id="MultiDataset.collate_blocks-506"><a href="#MultiDataset.collate_blocks-506"><span class="linenos">506</span></a>            <span class="c1">#print(dsub)</span>
</span><span id="MultiDataset.collate_blocks-507"><a href="#MultiDataset.collate_blocks-507"><span class="linenos">507</span></a>            <span class="c1">#print(data[dsub].shape)</span>
</span><span id="MultiDataset.collate_blocks-508"><a href="#MultiDataset.collate_blocks-508"><span class="linenos">508</span></a>            <span class="c1">#data[dsub] = data[dsub].flatten(end_dim=1) </span>
</span><span id="MultiDataset.collate_blocks-509"><a href="#MultiDataset.collate_blocks-509"><span class="linenos">509</span></a>        <span class="k">return</span> <span class="n">data</span>
</span></pre></div>


            <div class="docstring"><p>Alternative to the collate function that attaches blocks labeled by one index together
To explain: if you ask for one index (of a block) from the dataset like [1] and get back 
a block of data (B x M), the default collate_fn will still treat this as one data sample 
(1 x B x M) rather than the B data samples in the block. This is a simple flatten...
Note: assumes that this is getting a dictionary, of course</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="../sensory_base.html#SensoryBase">NTdatasets.sensory_base.SensoryBase</a></dt>
                                <dd id="MultiDataset.datadir" class="variable"><a href="../sensory_base.html#SensoryBase.datadir">datadir</a></dd>
                <dd id="MultiDataset.filenames" class="variable"><a href="../sensory_base.html#SensoryBase.filenames">filenames</a></dd>
                <dd id="MultiDataset.device" class="variable"><a href="../sensory_base.html#SensoryBase.device">device</a></dd>
                <dd id="MultiDataset.trial_sample" class="variable"><a href="../sensory_base.html#SensoryBase.trial_sample">trial_sample</a></dd>
                <dd id="MultiDataset.num_lags" class="variable"><a href="../sensory_base.html#SensoryBase.num_lags">num_lags</a></dd>
                <dd id="MultiDataset.time_embed" class="variable"><a href="../sensory_base.html#SensoryBase.time_embed">time_embed</a></dd>
                <dd id="MultiDataset.preload" class="variable"><a href="../sensory_base.html#SensoryBase.preload">preload</a></dd>
                <dd id="MultiDataset.drift_interval" class="variable"><a href="../sensory_base.html#SensoryBase.drift_interval">drift_interval</a></dd>
                <dd id="MultiDataset.NC" class="variable"><a href="../sensory_base.html#SensoryBase.NC">NC</a></dd>
                <dd id="MultiDataset.block_filemapping" class="variable"><a href="../sensory_base.html#SensoryBase.block_filemapping">block_filemapping</a></dd>
                <dd id="MultiDataset.include_MUs" class="variable"><a href="../sensory_base.html#SensoryBase.include_MUs">include_MUs</a></dd>
                <dd id="MultiDataset.SUinds" class="variable"><a href="../sensory_base.html#SensoryBase.SUinds">SUinds</a></dd>
                <dd id="MultiDataset.MUinds" class="variable"><a href="../sensory_base.html#SensoryBase.MUinds">MUinds</a></dd>
                <dd id="MultiDataset.cells_out" class="variable"><a href="../sensory_base.html#SensoryBase.cells_out">cells_out</a></dd>
                <dd id="MultiDataset.robs_out" class="variable"><a href="../sensory_base.html#SensoryBase.robs_out">robs_out</a></dd>
                <dd id="MultiDataset.dfs_out" class="variable"><a href="../sensory_base.html#SensoryBase.dfs_out">dfs_out</a></dd>
                <dd id="MultiDataset.test_inds" class="variable"><a href="../sensory_base.html#SensoryBase.test_inds">test_inds</a></dd>
                <dd id="MultiDataset.val_inds" class="variable"><a href="../sensory_base.html#SensoryBase.val_inds">val_inds</a></dd>
                <dd id="MultiDataset.train_inds" class="variable"><a href="../sensory_base.html#SensoryBase.train_inds">train_inds</a></dd>
                <dd id="MultiDataset.test_blks" class="variable"><a href="../sensory_base.html#SensoryBase.test_blks">test_blks</a></dd>
                <dd id="MultiDataset.val_blks" class="variable"><a href="../sensory_base.html#SensoryBase.val_blks">val_blks</a></dd>
                <dd id="MultiDataset.train_blks" class="variable"><a href="../sensory_base.html#SensoryBase.train_blks">train_blks</a></dd>
                <dd id="MultiDataset.used_inds" class="variable"><a href="../sensory_base.html#SensoryBase.used_inds">used_inds</a></dd>
                <dd id="MultiDataset.speckled" class="variable"><a href="../sensory_base.html#SensoryBase.speckled">speckled</a></dd>
                <dd id="MultiDataset.Xdrift" class="variable"><a href="../sensory_base.html#SensoryBase.Xdrift">Xdrift</a></dd>
                <dd id="MultiDataset.stim" class="variable"><a href="../sensory_base.html#SensoryBase.stim">stim</a></dd>
                <dd id="MultiDataset.dfs" class="variable"><a href="../sensory_base.html#SensoryBase.dfs">dfs</a></dd>
                <dd id="MultiDataset.robs" class="variable"><a href="../sensory_base.html#SensoryBase.robs">robs</a></dd>
                <dd id="MultiDataset.NT" class="variable"><a href="../sensory_base.html#SensoryBase.NT">NT</a></dd>
                <dd id="MultiDataset.covariates" class="variable"><a href="../sensory_base.html#SensoryBase.covariates">covariates</a></dd>
                <dd id="MultiDataset.cov_dims" class="variable"><a href="../sensory_base.html#SensoryBase.cov_dims">cov_dims</a></dd>
                <dd id="MultiDataset.add_covariate" class="function"><a href="../sensory_base.html#SensoryBase.add_covariate">add_covariate</a></dd>
                <dd id="MultiDataset.append_covariates" class="function"><a href="../sensory_base.html#SensoryBase.append_covariates">append_covariates</a></dd>
                <dd id="MultiDataset.prepare_stim" class="function"><a href="../sensory_base.html#SensoryBase.prepare_stim">prepare_stim</a></dd>
                <dd id="MultiDataset.set_cells" class="function"><a href="../sensory_base.html#SensoryBase.set_cells">set_cells</a></dd>
                <dd id="MultiDataset.time_embedding" class="function"><a href="../sensory_base.html#SensoryBase.time_embedding">time_embedding</a></dd>
                <dd id="MultiDataset.construct_drift_design_matrix" class="function"><a href="../sensory_base.html#SensoryBase.construct_drift_design_matrix">construct_drift_design_matrix</a></dd>
                <dd id="MultiDataset.trial_psths" class="function"><a href="../sensory_base.html#SensoryBase.trial_psths">trial_psths</a></dd>
                <dd id="MultiDataset.construct_LVtents" class="function"><a href="../sensory_base.html#SensoryBase.construct_LVtents">construct_LVtents</a></dd>
                <dd id="MultiDataset.setup_trial_LVs" class="function"><a href="../sensory_base.html#SensoryBase.setup_trial_LVs">setup_trial_LVs</a></dd>
                <dd id="MultiDataset.setup_LVLayer_input" class="function"><a href="../sensory_base.html#SensoryBase.setup_LVLayer_input">setup_LVLayer_input</a></dd>
                <dd id="MultiDataset.design_matrix_drift" class="function"><a href="../sensory_base.html#SensoryBase.design_matrix_drift">design_matrix_drift</a></dd>
                <dd id="MultiDataset.construct_onehot_design_matrix" class="function"><a href="../sensory_base.html#SensoryBase.construct_onehot_design_matrix">construct_onehot_design_matrix</a></dd>
                <dd id="MultiDataset.speckledXV_setup" class="function"><a href="../sensory_base.html#SensoryBase.speckledXV_setup">speckledXV_setup</a></dd>
                <dd id="MultiDataset.set_speckledXV" class="function"><a href="../sensory_base.html#SensoryBase.set_speckledXV">set_speckledXV</a></dd>
                <dd id="MultiDataset.make_data_dicts" class="function"><a href="../sensory_base.html#SensoryBase.make_data_dicts">make_data_dicts</a></dd>
                <dd id="MultiDataset.get_max_samples" class="function"><a href="../sensory_base.html#SensoryBase.get_max_samples">get_max_samples</a></dd>
                <dd id="MultiDataset.assemble_stimulus" class="function"><a href="../sensory_base.html#SensoryBase.assemble_stimulus">assemble_stimulus</a></dd>
                <dd id="MultiDataset.is_int" class="function"><a href="../sensory_base.html#SensoryBase.is_int">is_int</a></dd>
                <dd id="MultiDataset.index_to_array" class="function"><a href="../sensory_base.html#SensoryBase.index_to_array">index_to_array</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="get_stim_url">
                            <input id="get_stim_url-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_stim_url</span><span class="signature pdoc-code condensed">(<span class="param"><span class="nb">id</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_stim_url-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_stim_url"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_stim_url-512"><a href="#get_stim_url-512"><span class="linenos">512</span></a><span class="k">def</span> <span class="nf">get_stim_url</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
</span><span id="get_stim_url-513"><a href="#get_stim_url-513"><span class="linenos">513</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_stim_url-514"><a href="#get_stim_url-514"><span class="linenos">514</span></a><span class="sd">    Get the stimulus URL for the specified experiment ID.</span>
</span><span id="get_stim_url-515"><a href="#get_stim_url-515"><span class="linenos">515</span></a>
</span><span id="get_stim_url-516"><a href="#get_stim_url-516"><span class="linenos">516</span></a><span class="sd">    Args:</span>
</span><span id="get_stim_url-517"><a href="#get_stim_url-517"><span class="linenos">517</span></a><span class="sd">        id: experiment ID</span>
</span><span id="get_stim_url-518"><a href="#get_stim_url-518"><span class="linenos">518</span></a>
</span><span id="get_stim_url-519"><a href="#get_stim_url-519"><span class="linenos">519</span></a><span class="sd">    Returns:</span>
</span><span id="get_stim_url-520"><a href="#get_stim_url-520"><span class="linenos">520</span></a><span class="sd">        URL for the specified experiment ID</span>
</span><span id="get_stim_url-521"><a href="#get_stim_url-521"><span class="linenos">521</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_stim_url-522"><a href="#get_stim_url-522"><span class="linenos">522</span></a>    <span class="n">urlpath</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="get_stim_url-523"><a href="#get_stim_url-523"><span class="linenos">523</span></a>            <span class="s1">&#39;expt01&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/mn70kyohmp3kjnl/expt01.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="get_stim_url-524"><a href="#get_stim_url-524"><span class="linenos">524</span></a>            <span class="s1">&#39;expt02&#39;</span><span class="p">:</span><span class="s1">&#39;https://www.dropbox.com/s/pods4w89tbu2x57/expt02.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="get_stim_url-525"><a href="#get_stim_url-525"><span class="linenos">525</span></a>            <span class="s1">&#39;expt03&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/p08375vcunrf9rh/expt03.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="get_stim_url-526"><a href="#get_stim_url-526"><span class="linenos">526</span></a>            <span class="s1">&#39;expt04&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/zs1vcaz3sm01ncn/expt04.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="get_stim_url-527"><a href="#get_stim_url-527"><span class="linenos">527</span></a>            <span class="s1">&#39;expt05&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/f3mpp3mlsrhof8k/expt05.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="get_stim_url-528"><a href="#get_stim_url-528"><span class="linenos">528</span></a>            <span class="s1">&#39;expt06&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/saqjo7yibc6y8ut/expt06.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="get_stim_url-529"><a href="#get_stim_url-529"><span class="linenos">529</span></a>            <span class="s1">&#39;expt07&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/op0rw7obzfvnm53/expt07.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="get_stim_url-530"><a href="#get_stim_url-530"><span class="linenos">530</span></a>            <span class="s1">&#39;expt08&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/fwmtdegmlcdk9wo/expt08.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="get_stim_url-531"><a href="#get_stim_url-531"><span class="linenos">531</span></a>            <span class="s1">&#39;expt09&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/yo8xo58ldiyrktm/expt09.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="get_stim_url-532"><a href="#get_stim_url-532"><span class="linenos">532</span></a>            <span class="s1">&#39;expt10&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/k2zldzv7zfe7x06/expt10.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="get_stim_url-533"><a href="#get_stim_url-533"><span class="linenos">533</span></a>            <span class="s1">&#39;expt11&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/rsc7h4njqntts39/expt11.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="get_stim_url-534"><a href="#get_stim_url-534"><span class="linenos">534</span></a>            <span class="s1">&#39;expt12&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/yf1mm805j53yaj2/expt12.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="get_stim_url-535"><a href="#get_stim_url-535"><span class="linenos">535</span></a>            <span class="s1">&#39;expt13&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/gidll8bgg5uie8h/expt13.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="get_stim_url-536"><a href="#get_stim_url-536"><span class="linenos">536</span></a>            <span class="s1">&#39;expt14&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/kfof5m08g1v3rfe/expt14.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="get_stim_url-537"><a href="#get_stim_url-537"><span class="linenos">537</span></a>            <span class="s1">&#39;expt15&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/zpcc7a2iy9bmkjd/expt15.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="get_stim_url-538"><a href="#get_stim_url-538"><span class="linenos">538</span></a>            <span class="s1">&#39;expt16&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.dropbox.com/s/b19kwdwy18d14hl/expt16.mat?dl=1&#39;</span><span class="p">,</span>
</span><span id="get_stim_url-539"><a href="#get_stim_url-539"><span class="linenos">539</span></a>        <span class="p">}</span>
</span><span id="get_stim_url-540"><a href="#get_stim_url-540"><span class="linenos">540</span></a>    
</span><span id="get_stim_url-541"><a href="#get_stim_url-541"><span class="linenos">541</span></a>    <span class="k">if</span> <span class="nb">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">urlpath</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="get_stim_url-542"><a href="#get_stim_url-542"><span class="linenos">542</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Stimulus URL not found&#39;</span><span class="p">)</span>
</span><span id="get_stim_url-543"><a href="#get_stim_url-543"><span class="linenos">543</span></a>    
</span><span id="get_stim_url-544"><a href="#get_stim_url-544"><span class="linenos">544</span></a>    <span class="k">return</span> <span class="n">urlpath</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Get the stimulus URL for the specified experiment ID.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>id:</strong>  experiment ID</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>URL for the specified experiment ID</p>
</blockquote>
</div>


                </section>
                <section id="download_set">
                            <input id="download_set-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">download_set</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">sessname</span>, </span><span class="param"><span class="n">fpath</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="download_set-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#download_set"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="download_set-546"><a href="#download_set-546"><span class="linenos">546</span></a><span class="k">def</span> <span class="nf">download_set</span><span class="p">(</span><span class="n">sessname</span><span class="p">,</span> <span class="n">fpath</span><span class="p">):</span>
</span><span id="download_set-547"><a href="#download_set-547"><span class="linenos">547</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="download_set-548"><a href="#download_set-548"><span class="linenos">548</span></a><span class="sd">    Download the specified data set.</span>
</span><span id="download_set-549"><a href="#download_set-549"><span class="linenos">549</span></a>
</span><span id="download_set-550"><a href="#download_set-550"><span class="linenos">550</span></a><span class="sd">    Args:</span>
</span><span id="download_set-551"><a href="#download_set-551"><span class="linenos">551</span></a><span class="sd">        sessname: name of the session</span>
</span><span id="download_set-552"><a href="#download_set-552"><span class="linenos">552</span></a><span class="sd">        fpath: path to save the data set</span>
</span><span id="download_set-553"><a href="#download_set-553"><span class="linenos">553</span></a>
</span><span id="download_set-554"><a href="#download_set-554"><span class="linenos">554</span></a><span class="sd">    Returns:</span>
</span><span id="download_set-555"><a href="#download_set-555"><span class="linenos">555</span></a><span class="sd">        None</span>
</span><span id="download_set-556"><a href="#download_set-556"><span class="linenos">556</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="download_set-557"><a href="#download_set-557"><span class="linenos">557</span></a>    <span class="n">ensure_dir</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
</span><span id="download_set-558"><a href="#download_set-558"><span class="linenos">558</span></a>
</span><span id="download_set-559"><a href="#download_set-559"><span class="linenos">559</span></a>    <span class="c1"># Download the data set</span>
</span><span id="download_set-560"><a href="#download_set-560"><span class="linenos">560</span></a>    <span class="n">url</span> <span class="o">=</span> <span class="n">get_stim_url</span><span class="p">(</span><span class="n">sessname</span><span class="p">)</span>
</span><span id="download_set-561"><a href="#download_set-561"><span class="linenos">561</span></a>    <span class="n">fout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">sessname</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span><span class="p">)</span>
</span><span id="download_set-562"><a href="#download_set-562"><span class="linenos">562</span></a>    <span class="n">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">fout</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Download the specified data set.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>sessname:</strong>  name of the session</li>
<li><strong>fpath:</strong>  path to save the data set</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                </section>
                <section id="time_in_blocks">
                            <input id="time_in_blocks-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">time_in_blocks</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">block_inds</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="time_in_blocks-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#time_in_blocks"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="time_in_blocks-565"><a href="#time_in_blocks-565"><span class="linenos">565</span></a><span class="k">def</span> <span class="nf">time_in_blocks</span><span class="p">(</span><span class="n">block_inds</span><span class="p">):</span>
</span><span id="time_in_blocks-566"><a href="#time_in_blocks-566"><span class="linenos">566</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="time_in_blocks-567"><a href="#time_in_blocks-567"><span class="linenos">567</span></a><span class="sd">    Calculate the total time in blocks.</span>
</span><span id="time_in_blocks-568"><a href="#time_in_blocks-568"><span class="linenos">568</span></a>
</span><span id="time_in_blocks-569"><a href="#time_in_blocks-569"><span class="linenos">569</span></a><span class="sd">    Args:</span>
</span><span id="time_in_blocks-570"><a href="#time_in_blocks-570"><span class="linenos">570</span></a><span class="sd">        block_inds: block indices</span>
</span><span id="time_in_blocks-571"><a href="#time_in_blocks-571"><span class="linenos">571</span></a>
</span><span id="time_in_blocks-572"><a href="#time_in_blocks-572"><span class="linenos">572</span></a><span class="sd">    Returns:</span>
</span><span id="time_in_blocks-573"><a href="#time_in_blocks-573"><span class="linenos">573</span></a><span class="sd">        total time in blocks</span>
</span><span id="time_in_blocks-574"><a href="#time_in_blocks-574"><span class="linenos">574</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="time_in_blocks-575"><a href="#time_in_blocks-575"><span class="linenos">575</span></a>    <span class="n">num_blocks</span> <span class="o">=</span> <span class="n">block_inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="time_in_blocks-576"><a href="#time_in_blocks-576"><span class="linenos">576</span></a>    <span class="c1">#print( &quot;%d number of blocks.&quot; %num_blocks)</span>
</span><span id="time_in_blocks-577"><a href="#time_in_blocks-577"><span class="linenos">577</span></a>    <span class="n">NT</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="time_in_blocks-578"><a href="#time_in_blocks-578"><span class="linenos">578</span></a>    <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_blocks</span><span class="p">):</span>
</span><span id="time_in_blocks-579"><a href="#time_in_blocks-579"><span class="linenos">579</span></a>        <span class="n">NT</span> <span class="o">+=</span> <span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">block_inds</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
</span><span id="time_in_blocks-580"><a href="#time_in_blocks-580"><span class="linenos">580</span></a>    <span class="k">return</span> <span class="n">NT</span>
</span></pre></div>


            <div class="docstring"><p>Calculate the total time in blocks.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>block_inds:</strong>  block indices</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>total time in blocks</p>
</blockquote>
</div>


                </section>
                <section id="make_block_inds">
                            <input id="make_block_inds-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">make_block_inds</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">block_lims</span>, </span><span class="param"><span class="n">gap</span><span class="o">=</span><span class="mi">20</span>, </span><span class="param"><span class="n">separate</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="make_block_inds-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#make_block_inds"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="make_block_inds-583"><a href="#make_block_inds-583"><span class="linenos">583</span></a><span class="k">def</span> <span class="nf">make_block_inds</span><span class="p">(</span> <span class="n">block_lims</span><span class="p">,</span> <span class="n">gap</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">separate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="make_block_inds-584"><a href="#make_block_inds-584"><span class="linenos">584</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="make_block_inds-585"><a href="#make_block_inds-585"><span class="linenos">585</span></a><span class="sd">    Make block indices from block limits.</span>
</span><span id="make_block_inds-586"><a href="#make_block_inds-586"><span class="linenos">586</span></a>
</span><span id="make_block_inds-587"><a href="#make_block_inds-587"><span class="linenos">587</span></a><span class="sd">    Args:</span>
</span><span id="make_block_inds-588"><a href="#make_block_inds-588"><span class="linenos">588</span></a><span class="sd">        block_lims: block limits</span>
</span><span id="make_block_inds-589"><a href="#make_block_inds-589"><span class="linenos">589</span></a><span class="sd">        gap: gap between blocks</span>
</span><span id="make_block_inds-590"><a href="#make_block_inds-590"><span class="linenos">590</span></a><span class="sd">        separate: whether to separate the blocks</span>
</span><span id="make_block_inds-591"><a href="#make_block_inds-591"><span class="linenos">591</span></a>
</span><span id="make_block_inds-592"><a href="#make_block_inds-592"><span class="linenos">592</span></a><span class="sd">    Returns:</span>
</span><span id="make_block_inds-593"><a href="#make_block_inds-593"><span class="linenos">593</span></a><span class="sd">        block indices</span>
</span><span id="make_block_inds-594"><a href="#make_block_inds-594"><span class="linenos">594</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="make_block_inds-595"><a href="#make_block_inds-595"><span class="linenos">595</span></a>    <span class="n">block_inds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="make_block_inds-596"><a href="#make_block_inds-596"><span class="linenos">596</span></a>    <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">block_lims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="make_block_inds-597"><a href="#make_block_inds-597"><span class="linenos">597</span></a>        <span class="k">if</span> <span class="n">separate</span><span class="p">:</span>
</span><span id="make_block_inds-598"><a href="#make_block_inds-598"><span class="linenos">598</span></a>            <span class="n">block_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">block_lims</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">gap</span><span class="p">,</span> <span class="n">block_lims</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
</span><span id="make_block_inds-599"><a href="#make_block_inds-599"><span class="linenos">599</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="make_block_inds-600"><a href="#make_block_inds-600"><span class="linenos">600</span></a>            <span class="n">block_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> 
</span><span id="make_block_inds-601"><a href="#make_block_inds-601"><span class="linenos">601</span></a>                <span class="p">(</span><span class="n">block_inds</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">block_lims</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">gap</span><span class="p">,</span> <span class="n">block_lims</span><span class="p">[</span><span class="n">nn</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="make_block_inds-602"><a href="#make_block_inds-602"><span class="linenos">602</span></a>    <span class="k">return</span> <span class="n">block_inds</span>
</span></pre></div>


            <div class="docstring"><p>Make block indices from block limits.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>block_lims:</strong>  block limits</li>
<li><strong>gap:</strong>  gap between blocks</li>
<li><strong>separate:</strong>  whether to separate the blocks</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>block indices</p>
</blockquote>
</div>


                </section>
                <section id="monocular_data_import">
                            <input id="monocular_data_import-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">monocular_data_import</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">datadir</span>, </span><span class="param"><span class="n">exptn</span>, </span><span class="param"><span class="n">num_lags</span><span class="o">=</span><span class="mi">20</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="monocular_data_import-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#monocular_data_import"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="monocular_data_import-605"><a href="#monocular_data_import-605"><span class="linenos">605</span></a><span class="k">def</span> <span class="nf">monocular_data_import</span><span class="p">(</span> <span class="n">datadir</span><span class="p">,</span> <span class="n">exptn</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="mi">20</span> <span class="p">):</span>
</span><span id="monocular_data_import-606"><a href="#monocular_data_import-606"><span class="linenos">606</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="monocular_data_import-607"><a href="#monocular_data_import-607"><span class="linenos">607</span></a><span class="sd">    Import monocular data.</span>
</span><span id="monocular_data_import-608"><a href="#monocular_data_import-608"><span class="linenos">608</span></a>
</span><span id="monocular_data_import-609"><a href="#monocular_data_import-609"><span class="linenos">609</span></a><span class="sd">    Args:</span>
</span><span id="monocular_data_import-610"><a href="#monocular_data_import-610"><span class="linenos">610</span></a><span class="sd">        datadir: directory where the data is stored</span>
</span><span id="monocular_data_import-611"><a href="#monocular_data_import-611"><span class="linenos">611</span></a><span class="sd">        exptn: experiment name</span>
</span><span id="monocular_data_import-612"><a href="#monocular_data_import-612"><span class="linenos">612</span></a><span class="sd">        num_lags: number of lags</span>
</span><span id="monocular_data_import-613"><a href="#monocular_data_import-613"><span class="linenos">613</span></a>
</span><span id="monocular_data_import-614"><a href="#monocular_data_import-614"><span class="linenos">614</span></a><span class="sd">    Returns:</span>
</span><span id="monocular_data_import-615"><a href="#monocular_data_import-615"><span class="linenos">615</span></a><span class="sd">        stim_all: stimulus</span>
</span><span id="monocular_data_import-616"><a href="#monocular_data_import-616"><span class="linenos">616</span></a><span class="sd">        Robs_all: response</span>
</span><span id="monocular_data_import-617"><a href="#monocular_data_import-617"><span class="linenos">617</span></a><span class="sd">        DFs_all: data filters</span>
</span><span id="monocular_data_import-618"><a href="#monocular_data_import-618"><span class="linenos">618</span></a><span class="sd">        Eadd_info: additional information</span>
</span><span id="monocular_data_import-619"><a href="#monocular_data_import-619"><span class="linenos">619</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="monocular_data_import-620"><a href="#monocular_data_import-620"><span class="linenos">620</span></a>    <span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
</span><span id="monocular_data_import-621"><a href="#monocular_data_import-621"><span class="linenos">621</span></a>
</span><span id="monocular_data_import-622"><a href="#monocular_data_import-622"><span class="linenos">622</span></a>    <span class="n">time_shift</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="monocular_data_import-623"><a href="#monocular_data_import-623"><span class="linenos">623</span></a>    <span class="n">filename</span> <span class="o">=</span> <span class="n">exptn</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span>
</span><span id="monocular_data_import-624"><a href="#monocular_data_import-624"><span class="linenos">624</span></a>    <span class="n">matdata</span> <span class="o">=</span> <span class="n">sio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span> <span class="p">)</span>
</span><span id="monocular_data_import-625"><a href="#monocular_data_import-625"><span class="linenos">625</span></a>
</span><span id="monocular_data_import-626"><a href="#monocular_data_import-626"><span class="linenos">626</span></a>    <span class="n">sus</span> <span class="o">=</span> <span class="n">matdata</span><span class="p">[</span><span class="s1">&#39;goodSUs&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># switch from matlab indexing</span>
</span><span id="monocular_data_import-627"><a href="#monocular_data_import-627"><span class="linenos">627</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SUs:&#39;</span><span class="p">,</span> <span class="n">sus</span><span class="p">)</span>
</span><span id="monocular_data_import-628"><a href="#monocular_data_import-628"><span class="linenos">628</span></a>    <span class="n">NC</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sus</span><span class="p">)</span>
</span><span id="monocular_data_import-629"><a href="#monocular_data_import-629"><span class="linenos">629</span></a>    <span class="n">layers</span> <span class="o">=</span> <span class="n">matdata</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:]</span>
</span><span id="monocular_data_import-630"><a href="#monocular_data_import-630"><span class="linenos">630</span></a>    <span class="n">block_list</span> <span class="o">=</span> <span class="n">matdata</span><span class="p">[</span><span class="s1">&#39;block_inds&#39;</span><span class="p">]</span> <span class="c1"># note matlab indexing</span>
</span><span id="monocular_data_import-631"><a href="#monocular_data_import-631"><span class="linenos">631</span></a>    <span class="n">stim_all</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">shift_mat_zpad</span><span class="p">(</span><span class="n">matdata</span><span class="p">[</span><span class="s1">&#39;stimulus&#39;</span><span class="p">],</span> <span class="n">time_shift</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="monocular_data_import-632"><a href="#monocular_data_import-632"><span class="linenos">632</span></a>    <span class="n">NTtot</span><span class="p">,</span> <span class="n">NX</span> <span class="o">=</span> <span class="n">stim_all</span><span class="o">.</span><span class="n">shape</span>
</span><span id="monocular_data_import-633"><a href="#monocular_data_import-633"><span class="linenos">633</span></a>    <span class="n">DFs_all</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">matdata</span><span class="p">[</span><span class="s1">&#39;data_filters&#39;</span><span class="p">][:,</span><span class="n">sus</span><span class="p">])</span>
</span><span id="monocular_data_import-634"><a href="#monocular_data_import-634"><span class="linenos">634</span></a>    <span class="n">Robs_all</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">matdata</span><span class="p">[</span><span class="s1">&#39;binned_SU&#39;</span><span class="p">][:,</span><span class="n">sus</span><span class="p">])</span>
</span><span id="monocular_data_import-635"><a href="#monocular_data_import-635"><span class="linenos">635</span></a>    
</span><span id="monocular_data_import-636"><a href="#monocular_data_import-636"><span class="linenos">636</span></a>    <span class="c1"># Break up into train and test blocks</span>
</span><span id="monocular_data_import-637"><a href="#monocular_data_import-637"><span class="linenos">637</span></a>    <span class="c1"># Assemble train and test indices based on BIlist</span>
</span><span id="monocular_data_import-638"><a href="#monocular_data_import-638"><span class="linenos">638</span></a>    <span class="n">NBL</span> <span class="o">=</span> <span class="n">block_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="monocular_data_import-639"><a href="#monocular_data_import-639"><span class="linenos">639</span></a>    <span class="n">Xb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">NBL</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># Every fifth trial is cross-validation</span>
</span><span id="monocular_data_import-640"><a href="#monocular_data_import-640"><span class="linenos">640</span></a>    <span class="n">Ub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">NBL</span><span class="p">)))</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">Xb</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
</span><span id="monocular_data_import-641"><a href="#monocular_data_import-641"><span class="linenos">641</span></a>    
</span><span id="monocular_data_import-642"><a href="#monocular_data_import-642"><span class="linenos">642</span></a>    <span class="n">used_inds</span> <span class="o">=</span> <span class="n">make_block_inds</span><span class="p">(</span> <span class="n">block_list</span><span class="p">,</span> <span class="n">gap</span><span class="o">=</span><span class="n">num_lags</span> <span class="p">)</span>
</span><span id="monocular_data_import-643"><a href="#monocular_data_import-643"><span class="linenos">643</span></a>    <span class="n">Ui</span><span class="p">,</span> <span class="n">Xi</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">generate_xv_folds</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">used_inds</span><span class="p">)</span> <span class="p">)</span>
</span><span id="monocular_data_import-644"><a href="#monocular_data_import-644"><span class="linenos">644</span></a>    <span class="n">TRinds</span><span class="p">,</span> <span class="n">TEinds</span> <span class="o">=</span> <span class="n">used_inds</span><span class="p">[</span><span class="n">Ui</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">used_inds</span><span class="p">[</span><span class="n">Xi</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="monocular_data_import-645"><a href="#monocular_data_import-645"><span class="linenos">645</span></a>
</span><span id="monocular_data_import-646"><a href="#monocular_data_import-646"><span class="linenos">646</span></a>    <span class="n">Eadd_info</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="monocular_data_import-647"><a href="#monocular_data_import-647"><span class="linenos">647</span></a>        <span class="s1">&#39;cortical_layer&#39;</span><span class="p">:</span><span class="n">layers</span><span class="p">,</span> <span class="s1">&#39;used_inds&#39;</span><span class="p">:</span> <span class="n">used_inds</span><span class="p">,</span> 
</span><span id="monocular_data_import-648"><a href="#monocular_data_import-648"><span class="linenos">648</span></a>        <span class="s1">&#39;TRinds&#39;</span><span class="p">:</span><span class="n">TRinds</span><span class="p">,</span> <span class="s1">&#39;TEinds&#39;</span><span class="p">:</span> <span class="n">TEinds</span><span class="p">,</span> <span class="c1">#&#39;TRinds&#39;: Ui, &#39;TEinds&#39;: Xi, </span>
</span><span id="monocular_data_import-649"><a href="#monocular_data_import-649"><span class="linenos">649</span></a>        <span class="s1">&#39;block_list&#39;</span><span class="p">:</span> <span class="n">block_list</span><span class="p">,</span> <span class="s1">&#39;TRblocks&#39;</span><span class="p">:</span> <span class="n">Ub</span><span class="p">,</span> <span class="s1">&#39;TEblocks&#39;</span><span class="p">:</span> <span class="n">Xb</span><span class="p">}</span>
</span><span id="monocular_data_import-650"><a href="#monocular_data_import-650"><span class="linenos">650</span></a>    <span class="k">return</span> <span class="n">stim_all</span><span class="p">,</span> <span class="n">Robs_all</span><span class="p">,</span> <span class="n">DFs_all</span><span class="p">,</span> <span class="n">Eadd_info</span>
</span></pre></div>


            <div class="docstring"><p>Import monocular data.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>datadir:</strong>  directory where the data is stored</li>
<li><strong>exptn:</strong>  experiment name</li>
<li><strong>num_lags:</strong>  number of lags</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>stim_all: stimulus
  Robs_all: response
  DFs_all: data filters
  Eadd_info: additional information</p>
</blockquote>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>
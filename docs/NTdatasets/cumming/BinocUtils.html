<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.6.0"/>
    <title>NTdatasets.cumming.BinocUtils API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../cumming.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;NTdatasets.cumming</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#varDF">varDF</a>
            </li>
            <li>
                    <a class="function" href="#explainable_variance">explainable_variance</a>
            </li>
            <li>
                    <a class="function" href="#predictive_power">predictive_power</a>
            </li>
            <li>
                    <a class="function" href="#disparity_matrix">disparity_matrix</a>
            </li>
            <li>
                    <a class="function" href="#disparity_tuning">disparity_tuning</a>
            </li>
            <li>
                    <a class="function" href="#disparity_predictions">disparity_predictions</a>
            </li>
            <li>
                    <a class="function" href="#binocular_model_performance">binocular_model_performance</a>
            </li>
            <li>
                    <a class="function" href="#compute_mfilters">compute_mfilters</a>
            </li>
            <li>
                    <a class="function" href="#compute_binocular_filters_old">compute_binocular_filters_old</a>
            </li>
            <li>
                    <a class="function" href="#plot_sico_readout">plot_sico_readout</a>
            </li>
            <li>
                    <a class="function" href="#dist_mean">dist_mean</a>
            </li>
            <li>
                    <a class="function" href="#compute_bfilters">compute_bfilters</a>
            </li>
            <li>
                    <a class="function" href="#plot_mfilters">plot_mfilters</a>
            </li>
            <li>
                    <a class="function" href="#plot_bfilters">plot_bfilters</a>
            </li>
            <li>
                    <a class="function" href="#clone_model_selection">clone_model_selection</a>
            </li>
            <li>
                    <a class="function" href="#reconstitute_bmodel">reconstitute_bmodel</a>
            </li>
            <li>
                    <a class="function" href="#bmp_check">bmp_check</a>
            </li>
            <li>
                    <a class="function" href="#subsample_mask">subsample_mask</a>
            </li>
            <li>
                    <a class="function" href="#EImask">EImask</a>
            </li>
            <li>
                    <a class="function" href="#convert2ST">convert2ST</a>
            </li>
            <li>
                    <a class="function" href="#bmodel_regpath">bmodel_regpath</a>
            </li>
            <li>
                    <a class="function" href="#sico_ffnetworks">sico_ffnetworks</a>
            </li>
            <li>
                    <a class="function" href="#clone_path_prepare_data">clone_path_prepare_data</a>
            </li>
            <li>
                    <a class="function" href="#spatiotemporal_box_std">spatiotemporal_box_std</a>
            </li>
            <li>
                    <a class="function" href="#spatiotemporal_std_display">spatiotemporal_std_display</a>
            </li>
            <li>
                    <a class="function" href="#smoothness_select">smoothness_select</a>
            </li>
            <li>
                    <a class="function" href="#binocular_filter_shift">binocular_filter_shift</a>
            </li>
            <li>
                    <a class="function" href="#monocular_filter_shift">monocular_filter_shift</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../NTdatasets.html">NTdatasets</a><wbr>.<a href="./../cumming.html">cumming</a><wbr>.BinocUtils    </h1>

                
                        <input id="mod-BinocUtils-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-BinocUtils-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">sio</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">import</span> <span class="nn">NDNT.utils</span> <span class="k">as</span> <span class="nn">utils</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">import</span> <span class="nn">NDNT.NDN</span> <span class="k">as</span> <span class="nn">NDN</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="k">def</span> <span class="nf">varDF</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mean_adj</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="sd">    Calculates variance over valid data. </span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="sd">    mean_adj means true variance, but take away and becomes average squared deviation.</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="sd">    </span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="sd">    Args:</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="sd">        s: signal to calculate variance over</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="sd">        df: data filter (if None, will use all data)</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="sd">        mean_adj: whether to subtract mean before squaring</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="sd">    Returns:</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="sd">        variance of signal</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a>    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a>    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a>    <span class="n">nrm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a>    <span class="k">assert</span> <span class="n">nrm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;df: no valid data&quot;</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>    <span class="k">if</span> <span class="n">mean_adj</span><span class="p">:</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a>        <span class="n">sbar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df</span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="o">/</span><span class="n">nrm</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a>        <span class="n">sbar</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="n">sbar</span><span class="p">)</span><span class="o">*</span><span class="n">df</span><span class="p">)</span><span class="o">/</span><span class="n">nrm</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a>     
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="k">def</span> <span class="nf">explainable_variance</span><span class="p">(</span> <span class="n">Edata</span><span class="p">,</span> <span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="sd">    Explainable variance calculation: binocular-specific because of the data structures</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="sd">    </span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="sd">    Args:</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="sd">        Edata: binocular dataset (one experiment with a certain number of cells recorded)</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="sd">        cell_n: cell number (in python numbering, i.e. starting with 0)</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a><span class="sd">        fr1or3: whether to use fr1==1, fr3==3, or both (leave as None) to calculate disparity. Should choose 1 or 3</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="sd">        inds (def: None): indices to calculate variances over, if None will use all inds</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="sd">            generally will pass in the fr3 indices, for example</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="sd">        verbose (def: True): self-explanatory</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="sd">    </span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a><span class="sd">    Returns:</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="sd">        totvar: literally the variance of the binned spike counts (resp) -- will be dom by spike stoch.</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="sd">        explvar: explainable variance: repeatable variance (small fraction of totvar)</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="sd">    Note: will return total variance (and a warning) if repeats not present in the dataset.&quot;&quot;&quot;</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>    <span class="k">assert</span> <span class="n">cell_n</span> <span class="o">&lt;</span> <span class="n">Edata</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="s2">&quot;cell_n is too large for this experiment (num cells = </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="n">Edata</span><span class="o">.</span><span class="n">NC</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>    <span class="n">resp</span> <span class="o">=</span> <span class="n">Edata</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>    
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>    <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>        <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Edata</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>        <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span> <span class="n">inds</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Edata</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">fr1or3</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fr1or3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>        <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Edata</span><span class="o">.</span><span class="n">frs</span> <span class="o">==</span> <span class="n">fr1or3</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>    <span class="k">if</span> <span class="n">Edata</span><span class="o">.</span><span class="n">rep_inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;No repeats in this dataset -- using total variance.&#39;</span><span class="p">)</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="n">inds</span><span class="p">])</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>            
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>    <span class="n">rep1inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="n">Edata</span><span class="o">.</span><span class="n">rep_inds</span><span class="p">[</span><span class="n">cell_n</span><span class="p">][:,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>    <span class="n">rep2inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="n">Edata</span><span class="o">.</span><span class="n">rep_inds</span><span class="p">[</span><span class="n">cell_n</span><span class="p">][:,</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>    <span class="n">allreps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">rep1inds</span><span class="p">,</span> <span class="n">rep2inds</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>    <span class="n">totvar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="n">allreps</span><span class="p">])</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>    <span class="n">explvar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="n">rep1inds</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="n">allreps</span><span class="p">]),</span> <span class="n">resp</span><span class="p">[</span><span class="n">rep2inds</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="n">allreps</span><span class="p">])))</span> 
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>    
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>    <span class="k">return</span> <span class="n">explvar</span><span class="p">,</span> <span class="n">totvar</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a><span class="k">def</span> <span class="nf">predictive_power</span><span class="p">(</span> <span class="n">pred</span><span class="p">,</span> <span class="n">Edata</span><span class="p">,</span> <span class="n">cell_n</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a><span class="sd">    Predictive power calculation (R2 adjusted by dividing by explainable (rather than total) variance</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a><span class="sd">    (binocular-specific because of the data structures)</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a><span class="sd">    </span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a><span class="sd">    Args:</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a><span class="sd">        pred: model prediction: must have same size as robs (unindexed)</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a><span class="sd">        Edata: binocular dataset (one experiment with a certain number of cells recorded)</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a><span class="sd">        cell_n: cell number (in python numbering, i.e. starting with 0)</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a><span class="sd">        inds (def: None): indices to calculate variances over, if None will use all inds</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a><span class="sd">            BUT it should pass in XVinds generally, and for example could also focus on fr3</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a><span class="sd">        verbose (def: True): self-explanatory</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a><span class="sd">    </span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a><span class="sd">    Returns: </span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a><span class="sd">        predictive power of cell</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>    <span class="k">assert</span> <span class="n">cell_n</span> <span class="o">&lt;</span> <span class="n">Edata</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="s2">&quot;cell_n is too large for this experiment (num cells = </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="n">Edata</span><span class="o">.</span><span class="n">NC</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>    <span class="n">pred</span><span class="o">=</span><span class="n">pred</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>        <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>    <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>        <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Edata</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>        <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span> <span class="n">inds</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Edata</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>    <span class="n">Robs</span> <span class="o">=</span> <span class="n">Edata</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>    <span class="n">mod_indxs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>    <span class="k">if</span> <span class="n">Edata</span><span class="o">.</span><span class="n">rep_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>        <span class="n">rep1inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="n">Edata</span><span class="o">.</span><span class="n">rep_inds</span><span class="p">[</span><span class="n">cell_n</span><span class="p">][:,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>        <span class="n">rep2inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="n">Edata</span><span class="o">.</span><span class="n">rep_inds</span><span class="p">[</span><span class="n">cell_n</span><span class="p">][:,</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>        <span class="n">allreps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">rep1inds</span><span class="p">,</span> <span class="n">rep2inds</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>        <span class="n">mod_indxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span> <span class="n">mod_indxs</span><span class="p">,</span> <span class="n">allreps</span> <span class="p">)</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>        <span class="n">r1a</span> <span class="o">=</span> <span class="n">Robs</span><span class="p">[</span><span class="n">rep1inds</span><span class="p">]</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>        <span class="n">r1b</span> <span class="o">=</span> <span class="n">Robs</span><span class="p">[</span><span class="n">rep2inds</span><span class="p">]</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>        <span class="n">r2</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">rep1inds</span><span class="p">]</span>  <span class="c1"># pred will be the same on both</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>        <span class="n">r1a</span> <span class="o">=</span> <span class="n">Robs</span><span class="p">[</span><span class="n">mod_indxs</span><span class="p">]</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>        <span class="n">r1b</span> <span class="o">=</span> <span class="n">r1a</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>        <span class="n">r2</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">mod_indxs</span><span class="p">]</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>    <span class="c1"># Now assuming that r (Robs) is length of indxs, and pred is full res</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>    <span class="n">expl_var</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">explainable_variance</span><span class="p">(</span> <span class="n">Edata</span><span class="p">,</span> <span class="n">cell_n</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">mod_indxs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span> <span class="p">)</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>    <span class="c1"># explained_power = np.var(r1)-np.mean(np.square(r1-r2))  # WOW I THINK THIS IS WRONG -- WAS ORIGINAL FORMULA</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>    <span class="n">explained_power</span> <span class="o">=</span> <span class="n">expl_var</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">r1a</span><span class="o">-</span><span class="n">r2</span><span class="p">,</span> <span class="n">r1b</span><span class="o">-</span><span class="n">r2</span><span class="p">))</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>    <span class="c1"># calculate other way</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>    <span class="c1">#crosscorr = np.mean(np.multiply(r1-np.mean(r1), r2-np.mean(r2)))</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>    <span class="c1">#print( (crosscorr**2/expl_var/np.var(r2)) )</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>    <span class="k">return</span> <span class="n">explained_power</span><span class="o">/</span><span class="n">expl_var</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a><span class="k">def</span> <span class="nf">disparity_matrix</span><span class="p">(</span> <span class="n">dispt</span><span class="p">,</span> <span class="n">corrt</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a><span class="sd">    Create one-hot representation of disparities: NT x 2*ND+2 (ND = num disparities)</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a><span class="sd">    -- Columns (0,ND-1):  correlated</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a><span class="sd">    -- Columns (ND, 2*ND-1): anticorrelated</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a><span class="sd">    -- Column -2: uncorrelated</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a><span class="sd">    -- Column -1: blank</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a><span class="sd">    Args:</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a><span class="sd">        dispt: disparity values</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a><span class="sd">        corrt: correlation values (if None, will not use)</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a><span class="sd">    Returns:</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a><span class="sd">        dmat: one-hot representation of disparities</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>    <span class="n">dlist_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dispt</span><span class="p">)</span> 
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">dlist_raw</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>        <span class="c1"># last two colums will be uncorrelated (-1005) and blank (-1009)</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>        <span class="n">dlist</span> <span class="o">=</span> <span class="n">dlist_raw</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>  <span class="c1"># this will exclude -1009 (blank) and -1005 (uncor)</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>        <span class="n">num_blanks</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>        <span class="n">dlist</span> <span class="o">=</span> <span class="n">dlist_raw</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>        <span class="n">num_blanks</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>    <span class="n">ND</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dlist</span><span class="p">)</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>    <span class="k">if</span> <span class="n">corrt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>        <span class="n">dmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dispt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ND</span><span class="o">+</span><span class="n">num_blanks</span><span class="p">])</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>        <span class="n">dmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dispt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="n">ND</span><span class="o">+</span><span class="n">num_blanks</span><span class="p">])</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>    <span class="k">if</span> <span class="n">num_blanks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>        <span class="n">dmat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dispt</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1009</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>        <span class="n">dmat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dispt</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1005</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>    <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dlist</span><span class="p">)):</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>        <span class="k">if</span> <span class="n">corrt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>            <span class="n">dmat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dispt</span> <span class="o">==</span> <span class="n">dlist</span><span class="p">[</span><span class="n">dd</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dd</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>            <span class="n">dmat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dispt</span> <span class="o">==</span> <span class="n">dlist</span><span class="p">[</span><span class="n">dd</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">corrt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dd</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>            <span class="n">dmat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dispt</span> <span class="o">==</span> <span class="n">dlist</span><span class="p">[</span><span class="n">dd</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">corrt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ND</span><span class="o">+</span><span class="n">dd</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>    <span class="k">return</span> <span class="n">dmat</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a><span class="k">def</span> <span class="nf">disparity_tuning</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_dlags</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">to_plot</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a><span class="sd">    Compute disparity tuning (disparity vs time) -- returned in dictionary object</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a><span class="sd">    -&gt; include cell_n to use data_filters from the actual cell</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a><span class="sd">    Args:</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a><span class="sd">        data: binocular dataset (NTdatasets.binocular.single)</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a><span class="sd">        r: response of the cell (or model) to use</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a><span class="sd">        cell_n: cell number (in python numbering, i.e. starting with 0)</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a><span class="sd">        num_dlags: number of lags to use in the time embedding</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a><span class="sd">        fr1or3: whether to use fr1==1, fr3==3, or both (leave as None) to calculate disparity. Should choose 1 or 3</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a><span class="sd">        to_plot: whether to plot the tuning curve</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a><span class="sd">    Returns:</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a><span class="sd">        Dinfo: dictionary with all the information about the disparity tuning curve</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>    <span class="kn">import</span> <span class="nn">torch</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>    <span class="n">dmat</span> <span class="o">=</span> <span class="n">disparity_matrix</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">dispt</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">corrt</span><span class="p">)</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>    <span class="n">ND</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>    <span class="c1"># Weight all by their frequency of occurance    </span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">fr1or3</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fr1or3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>        <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">frs</span> <span class="o">==</span> <span class="n">fr1or3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>        <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">frs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>    
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>    <span class="k">if</span> <span class="n">cell_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">data</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())[</span><span class="n">inds</span><span class="p">]</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">inds</span><span class="p">])</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>    <span class="n">resp</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>    <span class="n">dmatN</span> <span class="o">=</span> <span class="n">dmat</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dmat</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># will be stim rate</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>    <span class="c1"># if every stim resulted in 1 spk, the would be 1 as is</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>    <span class="c1">#nrms = np.mean(dmat[used_inds[to_use],:], axis=0) # number of stimuli of each type</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>    <span class="n">Xmat</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">create_time_embedding</span><span class="p">(</span> <span class="n">dmatN</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">ND</span><span class="o">*</span><span class="mi">2</span><span class="p">)],</span> <span class="n">num_dlags</span><span class="p">)[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>    <span class="c1"># uncorrelated response</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>    <span class="n">Umat</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">create_time_embedding</span><span class="p">(</span> <span class="n">dmatN</span><span class="p">[:,</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]],</span> <span class="n">num_dlags</span><span class="p">)[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>                          
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>    <span class="c1">#Nspks = np.sum(resp[to_use, :], axis=0)</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>    <span class="n">Nspks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># this will end up being number of spikes associated with each stim </span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>    <span class="c1"># at different lags, divided by number of time points used. (i.e. prob of spike per bin)</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>    <span class="n">Dsta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="n">Xmat</span><span class="o">.</span><span class="n">T</span><span class="nd">@resp</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ND</span><span class="p">,</span> <span class="n">num_dlags</span><span class="p">]</span> <span class="p">)</span> <span class="o">/</span> <span class="n">Nspks</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>    <span class="n">Usta</span> <span class="o">=</span> <span class="p">(</span><span class="n">Umat</span><span class="o">.</span><span class="n">T</span><span class="nd">@resp</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">Nspks</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>    
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>    <span class="c1"># Rudimentary analysis</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>    <span class="n">best_lag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Dsta</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">ND</span><span class="p">),:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>    <span class="n">Dtun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Dsta</span><span class="p">[:,</span> <span class="n">best_lag</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">ND</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>    <span class="n">uncor_resp</span> <span class="o">=</span> <span class="n">Usta</span><span class="p">[</span><span class="n">best_lag</span><span class="p">]</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>    
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>    <span class="n">Dinfo</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Dsta&#39;</span><span class="p">:</span><span class="n">Dsta</span><span class="p">,</span> <span class="s1">&#39;Dtun&#39;</span><span class="p">:</span> <span class="n">Dtun</span><span class="p">,</span> <span class="s1">&#39;uncor_resp&#39;</span><span class="p">:</span> <span class="n">uncor_resp</span><span class="p">,</span> 
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>            <span class="s1">&#39;best_lag&#39;</span><span class="p">:</span> <span class="n">best_lag</span><span class="p">,</span> <span class="s1">&#39;uncor_sta&#39;</span><span class="p">:</span> <span class="n">Usta</span><span class="p">,</span> <span class="s1">&#39;disp_list&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">disp_list</span><span class="p">[</span><span class="mi">2</span><span class="p">:]}</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>    <span class="k">if</span> <span class="n">to_plot</span><span class="p">:</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>        <span class="n">utils</span><span class="o">.</span><span class="n">subplot_setup</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">fig_width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">row_height</span><span class="o">=</span><span class="mf">2.8</span><span class="p">)</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>        <span class="n">utils</span><span class="o">.</span><span class="n">imagesc</span><span class="p">(</span><span class="n">Dsta</span><span class="o">-</span><span class="n">uncor_resp</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">)</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">ND</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">ND</span><span class="o">-</span><span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">num_dlags</span><span class="o">-</span><span class="mf">0.5</span><span class="p">],</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">ND</span><span class="o">-</span><span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="n">best_lag</span><span class="p">,</span> <span class="n">best_lag</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">)</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Dtun</span><span class="p">)</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">-</span><span class="n">Dtun</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">uncor_resp</span><span class="p">,</span><span class="s1">&#39;m--&#39;</span><span class="p">)</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">ND</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">uncor_resp</span><span class="p">,</span> <span class="n">uncor_resp</span><span class="p">],</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">ND</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>        
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>    <span class="k">return</span> <span class="n">Dinfo</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a><span class="c1">## Not  working yet ##</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a><span class="k">def</span> <span class="nf">disparity_predictions</span><span class="p">(</span> 
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>    <span class="n">data</span><span class="p">,</span> <span class="n">resp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>    <span class="n">fr1or3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indxs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>    <span class="n">num_dlags</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>  <span class="n">spiking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rectified</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a><span class="sd">    Calculates a prediction of the disparity (and timing) signals that can be inferred from the response</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a><span class="sd">    by the disparity input alone. This puts a lower bound on how much disparity is driving the response, although</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a><span class="sd">    practically speaking it generates the same disparity tuning curves for neurons.</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a><span class="sd">    </span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a><span class="sd">    Args:</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a><span class="sd">        data: dataset (NTdatasets.binocular.single)</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a><span class="sd">        resp: either Robs or predicted response across whole dataset -- leave blank if want neurons Robs</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a><span class="sd">        cell_n: cell number (in python numbering, i.e. starting with 0)</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a><span class="sd">        fr1or3: whether to use fr1==1, fr3==3, or both (leave as None) to calculate disparity. Should choose 1 or 3</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a><span class="sd">        indxs: subset of data -- probably will not use given dfs and fr1or3</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a><span class="sd">        num_dlags: how many lags to compute disparity/timing predictions using (default 8 is sufficient)</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a><span class="sd">        spiking: whether to use Poisson loss function (spiking data) or Gaussian (continuous prediction): default True</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a><span class="sd">        rectified: whether to rectify the predictions using softplus (since predicting spikes, generally)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a><span class="sd">    </span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a><span class="sd">    Returns: </span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a><span class="sd">        Dpred: full disparity+timing prediction</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a><span class="sd">        Tpred: prediction using just frame refresh and blanks</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a><span class="sd">        Note that both will predict over the whole dataset, even if only used 1 part to fit</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>    <span class="k">assert</span> <span class="n">cell_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to specify which neuron modeling for valid comparisons&quot;</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>    <span class="kn">import</span> <span class="nn">torch</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>    <span class="kn">from</span> <span class="nn">NTdatasets.generic</span> <span class="kn">import</span> <span class="n">GenericDataset</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>    <span class="kn">from</span> <span class="nn">NDNT.modules.layers</span> <span class="kn">import</span> <span class="n">NDNLayer</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>    <span class="c1"># use Robs if response is blank</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>    <span class="k">if</span> <span class="n">resp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">]</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>    <span class="c1"># Make sure response is formatted correctly</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">resp</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">resp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>    <span class="k">if</span> <span class="n">indxs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>        <span class="n">indxs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">fr1or3</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fr1or3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>        <span class="n">mod_indxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">indxs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">frs</span> <span class="o">==</span> <span class="n">fr1or3</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>        <span class="n">mod_indxs</span> <span class="o">=</span> <span class="n">indxs</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>    <span class="c1"># Process disparity into disparty and timing design matrix</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>    <span class="n">dmat</span> <span class="o">=</span> <span class="n">disparity_matrix</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">dispt</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">corrt</span> <span class="p">)</span>  <span class="c1"># all information about disparity</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>    
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>    <span class="c1"># This keeps track of changes in disparity (often every 3)</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>    <span class="n">switches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>    <span class="c1"># Switches are not relevant during FR1 -- would at best be constant offset</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>    <span class="n">switches</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">frs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>    
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>    <span class="c1"># Append switches to full disparity-oracle dataset</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>    <span class="n">dmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">switches</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>    <span class="n">ND2</span> <span class="o">=</span> <span class="n">dmat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># this includes uncorrelated (second to last) and blanks (last column</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>    <span class="n">blanks</span> <span class="o">=</span> <span class="n">dmat</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>    <span class="n">tmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">blanks</span><span class="p">,</span> <span class="n">switches</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>    <span class="c1"># Make models that use disparity to predict response, and timing alone</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>    <span class="n">Ddata</span> <span class="o">=</span> <span class="n">GenericDataset</span><span class="p">(</span> <span class="p">{</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>        <span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">create_time_embedding</span><span class="p">(</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">num_dlags</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>        <span class="s1">&#39;timing&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">create_time_embedding</span><span class="p">(</span> <span class="n">tmat</span><span class="p">,</span> <span class="n">num_dlags</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>        <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="n">resp</span><span class="p">,</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>        <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">]})</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>    <span class="n">lbfgs_pars</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">create_optimizer_params</span><span class="p">(</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>        <span class="n">optimizer_type</span><span class="o">=</span><span class="s1">&#39;lbfgs&#39;</span><span class="p">,</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>        <span class="n">tolerance_change</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">tolerance_grad</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>        <span class="n">history_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a> 
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>    <span class="k">if</span> <span class="n">rectified</span><span class="p">:</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>        <span class="n">nltype</span> <span class="o">=</span> <span class="s1">&#39;softplus&#39;</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>        <span class="n">nltype</span> <span class="o">=</span> <span class="s1">&#39;lin&#39;</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>    <span class="k">if</span> <span class="n">spiking</span><span class="p">:</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>        <span class="n">losstype</span> <span class="o">=</span> <span class="s1">&#39;poisson&#39;</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>        <span class="n">losstype</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>        
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>    <span class="n">dpred_layer</span> <span class="o">=</span> <span class="n">NDNLayer</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>        <span class="n">input_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ND2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">num_dlags</span><span class="p">],</span> <span class="n">num_filters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">NLtype</span><span class="o">=</span><span class="n">nltype</span><span class="p">)</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>    <span class="n">tpred_layer</span> <span class="o">=</span> <span class="n">NDNLayer</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>        <span class="n">input_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">num_dlags</span><span class="p">],</span> <span class="n">num_filters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">NLtype</span><span class="o">=</span><span class="n">nltype</span><span class="p">)</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>    <span class="n">dpredmod</span> <span class="o">=</span> <span class="n">NDN</span><span class="p">(</span> <span class="n">layer_list</span><span class="o">=</span><span class="p">[</span><span class="n">dpred_layer</span><span class="p">],</span> <span class="n">loss_type</span><span class="o">=</span><span class="n">losstype</span> <span class="p">)</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>    <span class="n">tpredmod</span> <span class="o">=</span> <span class="n">NDN</span><span class="p">(</span> <span class="n">layer_list</span><span class="o">=</span><span class="p">[</span><span class="n">tpred_layer</span><span class="p">],</span> <span class="n">loss_type</span><span class="o">=</span><span class="n">losstype</span> <span class="p">)</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>    <span class="n">tpredmod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xstim_n</span> <span class="o">=</span> <span class="s1">&#39;timing&#39;</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>    <span class="c1">#dpredmod.fit( Ddata, force_dict_training=True, train_inds=mod_indxs, val_inds=mod_indxs, </span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>    <span class="c1">#            **lbfgs_pars, verbose=0, version=1)</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>    <span class="n">utils</span><span class="o">.</span><span class="n">iterate_lbfgs</span><span class="p">(</span> <span class="n">dpredmod</span><span class="p">,</span> <span class="n">Ddata</span><span class="p">,</span> <span class="n">lbfgs_pars</span><span class="p">,</span> <span class="n">train_inds</span><span class="o">=</span><span class="n">mod_indxs</span><span class="p">,</span> <span class="n">val_inds</span><span class="o">=</span><span class="n">mod_indxs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>    <span class="n">utils</span><span class="o">.</span><span class="n">iterate_lbfgs</span><span class="p">(</span> <span class="n">tpredmod</span><span class="p">,</span> <span class="n">Ddata</span><span class="p">,</span> <span class="n">lbfgs_pars</span><span class="p">,</span> <span class="n">train_inds</span><span class="o">=</span><span class="n">mod_indxs</span><span class="p">,</span> <span class="n">val_inds</span><span class="o">=</span><span class="n">mod_indxs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>    <span class="c1">#tpredmod.fit( Ddata, force_dict_training=True, train_inds=mod_indxs, val_inds=mod_indxs, </span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>    <span class="c1">#            **lbfgs_pars, verbose=0, version=1)</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>    <span class="n">tpred</span> <span class="o">=</span> <span class="n">tpredmod</span><span class="p">(</span><span class="n">Ddata</span><span class="p">[:])</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>    <span class="n">dpred</span> <span class="o">=</span> <span class="n">dpredmod</span><span class="p">(</span><span class="n">Ddata</span><span class="p">[:])</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>    <span class="k">return</span> <span class="n">dpred</span><span class="p">,</span> <span class="n">tpred</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a><span class="k">def</span> <span class="nf">binocular_model_performance</span><span class="p">(</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Rpred</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">valset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a><span class="sd">    Current best-practices for generating prediction quality of neuron and binocular tuning. Currently we</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a><span class="sd">    are not worried about using cross-validation indices only (as they are based on much less data and tend to</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a><span class="sd">    otherwise be in agreement with full measures, but this option could be added in later versions.</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a><span class="sd">    valset can be None (use all val_inds, &#39;a&#39; or &#39;b&#39;: use subset)</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a><span class="sd">    </span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a><span class="sd">    Args:</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a><span class="sd">        data: binocular dataset (NTdatasets.binocular.single)</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a><span class="sd">        cell_n: cell number (in python numbering, i.e. starting with 0)</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a><span class="sd">        Rpred: predicted response of the model</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a><span class="sd">        valset: which validation set to use (None, &#39;a&#39;, &#39;b&#39;)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a><span class="sd">        verbose: whether to print out results</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a><span class="sd">    Returns:</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a><span class="sd">        BMP: dictionary with all the information about the binocular model performance</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>    <span class="k">assert</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Need to include dataset&#39;</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>    <span class="c1">#assert cell_n is not None, &#39;Must specify cell to check&#39;</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>    <span class="c1">#import torch</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>    <span class="c1">#if not isinstance( Rpred, torch.Tensor):</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>    <span class="c1">#    Rpred = torch.tensor( Rpred, dtype=torch.float32 )</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Rpred</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>        <span class="n">Rpred</span> <span class="o">=</span> <span class="n">Rpred</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>    
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>    <span class="c1">## GENERAL COMPUTATIONS on data (cell-specific but not yet model-specific, using as much data as can)</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>    <span class="c1"># make disparity predictions for all conditions</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>    <span class="n">dobs0</span><span class="p">,</span> <span class="n">tobs0</span> <span class="o">=</span> <span class="n">disparity_predictions</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">spiking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rectified</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>    <span class="n">dmod0</span><span class="p">,</span> <span class="n">tmod0</span> <span class="o">=</span> <span class="n">disparity_predictions</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">resp</span><span class="o">=</span><span class="n">Rpred</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">spiking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rectified</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>    <span class="n">dobs3</span><span class="p">,</span> <span class="n">tobs3</span> <span class="o">=</span> <span class="n">disparity_predictions</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">spiking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rectified</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>    <span class="n">dmod3</span><span class="p">,</span> <span class="n">tmod3</span> <span class="o">=</span> <span class="n">disparity_predictions</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">resp</span><span class="o">=</span><span class="n">Rpred</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">spiking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rectified</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>    <span class="n">dobs1</span><span class="p">,</span> <span class="n">tobs1</span> <span class="o">=</span> <span class="n">disparity_predictions</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">spiking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rectified</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>    <span class="n">dmod1</span><span class="p">,</span> <span class="n">tmod1</span> <span class="o">=</span> <span class="n">disparity_predictions</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">resp</span><span class="o">=</span><span class="n">Rpred</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">spiking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rectified</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>    <span class="c1"># This necessarily takes data-filters into account, but not cross-validation inds</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>    <span class="n">ev</span><span class="p">,</span> <span class="n">tv</span> <span class="o">=</span> <span class="n">explainable_variance</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span> <span class="p">)</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>    <span class="n">ev3</span><span class="p">,</span> <span class="n">tv3</span> <span class="o">=</span> <span class="n">explainable_variance</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span> <span class="p">)</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>    <span class="n">ev1</span><span class="p">,</span> <span class="n">tv1</span> <span class="o">=</span> <span class="n">explainable_variance</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span> <span class="p">)</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>    
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>    <span class="k">if</span> <span class="n">ev</span> <span class="o">==</span> <span class="n">tv</span><span class="p">:</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>        <span class="n">ev_valid</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>        <span class="n">ev_valid</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Overall explainable variance fraction: </span><span class="si">%0.3f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ev</span><span class="o">/</span><span class="n">tv</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>    <span class="c1">#### Model and data properties (not performance yet)</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>    <span class="n">indxs3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">frs</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>    <span class="n">indxs1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">frs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>    <span class="c1"># Have to use same (df) inds as overall explainable variance to make fractions directly valid</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>    <span class="n">dv_obs</span> <span class="o">=</span> <span class="n">varDF</span><span class="p">(</span><span class="n">dobs0</span><span class="o">-</span><span class="n">tobs0</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>    <span class="n">dv_obs3</span> <span class="o">=</span> <span class="n">varDF</span><span class="p">(</span><span class="n">dobs0</span><span class="p">[</span><span class="n">indxs3</span><span class="p">]</span><span class="o">-</span><span class="n">tobs0</span><span class="p">[</span><span class="n">indxs3</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">indxs3</span><span class="p">])</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>    <span class="n">dv_obs1</span> <span class="o">=</span> <span class="n">varDF</span><span class="p">(</span><span class="n">dobs0</span><span class="p">[</span><span class="n">indxs1</span><span class="p">]</span><span class="o">-</span><span class="n">tobs0</span><span class="p">[</span><span class="n">indxs1</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">indxs1</span><span class="p">])</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>    <span class="n">dv_pred</span> <span class="o">=</span> <span class="n">varDF</span><span class="p">(</span><span class="n">dmod0</span><span class="o">-</span><span class="n">tmod0</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>    <span class="n">dv_pred3</span> <span class="o">=</span> <span class="n">varDF</span><span class="p">(</span><span class="n">dmod3</span><span class="p">[</span><span class="n">indxs3</span><span class="p">]</span><span class="o">-</span><span class="n">tmod3</span><span class="p">[</span><span class="n">indxs3</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">indxs3</span><span class="p">])</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>    <span class="n">dv_pred1</span> <span class="o">=</span> <span class="n">varDF</span><span class="p">(</span><span class="n">dmod1</span><span class="p">[</span><span class="n">indxs1</span><span class="p">]</span><span class="o">-</span><span class="n">tmod1</span><span class="p">[</span><span class="n">indxs1</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">indxs1</span><span class="p">])</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>    
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Obs disparity variance fraction (DVF): </span><span class="si">%0.3f</span><span class="s2"> (FR3: </span><span class="si">%0.3f</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">dv_obs</span><span class="o">/</span><span class="n">ev</span><span class="p">,</span> <span class="n">dv_obs3</span><span class="o">/</span><span class="n">ev3</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>    <span class="n">vars_obs</span> <span class="o">=</span> <span class="p">[</span><span class="n">tv</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">dv_obs</span><span class="p">,</span> <span class="n">ev</span><span class="o">-</span><span class="n">dv_obs</span> <span class="p">]</span>  <span class="c1"># total, explainable, disp_var, pattern_var</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>    <span class="n">vars_obs_FR3</span> <span class="o">=</span> <span class="p">[</span><span class="n">tv3</span><span class="p">,</span> <span class="n">ev3</span><span class="p">,</span> <span class="n">dv_obs3</span><span class="p">,</span> <span class="n">ev3</span><span class="o">-</span><span class="n">dv_obs3</span> <span class="p">]</span>  <span class="c1"># total, explainable, disp_var, pattern_var</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>    <span class="n">DVfrac_obs</span> <span class="o">=</span> <span class="p">[</span><span class="n">dv_obs</span><span class="o">/</span><span class="n">ev</span><span class="p">,</span> <span class="n">dv_obs3</span><span class="o">/</span><span class="n">ev3</span><span class="p">,</span> <span class="n">dv_obs1</span><span class="o">/</span><span class="n">ev1</span> <span class="p">]</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>    <span class="c1"># use numpy version of Rpred from here on</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>    <span class="n">Rpred</span> <span class="o">=</span> <span class="n">Rpred</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>    <span class="n">var_pred</span> <span class="o">=</span> <span class="n">varDF</span><span class="p">(</span><span class="n">Rpred</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>    <span class="n">vars_mod</span> <span class="o">=</span> <span class="p">[</span><span class="n">varDF</span><span class="p">(</span><span class="n">Rpred</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">),</span> <span class="n">dv_pred</span><span class="p">,</span> <span class="n">var_pred</span><span class="o">-</span><span class="n">dv_pred</span><span class="p">]</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>    <span class="n">DVfrac_mod</span> <span class="o">=</span> <span class="p">[</span><span class="n">dv_pred</span><span class="o">/</span><span class="n">var_pred</span><span class="p">,</span> 
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>                  <span class="n">dv_pred3</span><span class="o">/</span><span class="n">varDF</span><span class="p">(</span><span class="n">Rpred</span><span class="p">[</span><span class="n">indxs3</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">indxs3</span><span class="p">]),</span> 
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>                  <span class="n">dv_pred1</span><span class="o">/</span><span class="n">varDF</span><span class="p">(</span><span class="n">Rpred</span><span class="p">[</span><span class="n">indxs1</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">indxs1</span><span class="p">])]</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>    <span class="c1">## Model-based performance measures - need cross-validation indices only</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>    <span class="k">if</span> <span class="n">valset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>        <span class="n">v_inds</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">val_inds</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>    <span class="k">elif</span> <span class="n">valset</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">]:</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>        <span class="n">v_inds</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">val_indsA</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>        <span class="c1">#print( &#39;  Using val set A&#39;)</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>        <span class="n">v_inds</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">val_indsB</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>        <span class="c1">#print( &#39;  Using val set B&#39;)</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>    <span class="c1">#indxs3xv = np.intersect1d( data.val_inds, indxs3 )</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>    <span class="c1">#indxs1xv = np.intersect1d( data.val_inds, indxs1 )</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">rep_inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>        <span class="n">allreps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>        <span class="n">rep1inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">v_inds</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">rep_inds</span><span class="p">[</span><span class="n">cell_n</span><span class="p">][:,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>        <span class="n">rep2inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">v_inds</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">rep_inds</span><span class="p">[</span><span class="n">cell_n</span><span class="p">][:,</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>        <span class="n">allreps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">rep1inds</span><span class="p">,</span> <span class="n">rep2inds</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>    <span class="n">indxs3xv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span> <span class="n">allreps</span><span class="p">,</span> <span class="n">indxs3</span> <span class="p">)</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>    <span class="n">indxs1xv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span> <span class="n">allreps</span><span class="p">,</span> <span class="n">indxs1</span> <span class="p">)</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>    <span class="c1">#DVfrac_mod_alt = [dv_mod/np.var(Rpred[indxs]), </span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>    <span class="c1">#                  dv_pred3b/np.var(Rpred[indxs3]), </span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>    <span class="c1">#                  dv_pred1b/np.var(Rpred[indxs1])]</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>    
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>    <span class="c1"># Predictive powers (model performance): full response, fr3, fr1</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>    <span class="n">pps</span> <span class="o">=</span> <span class="p">[</span><span class="n">predictive_power</span><span class="p">(</span> <span class="n">Rpred</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">allreps</span> <span class="p">),</span>  <span class="c1"># predict variance of full response</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>           <span class="n">predictive_power</span><span class="p">(</span> <span class="n">Rpred</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">indxs3xv</span> <span class="p">),</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>           <span class="n">predictive_power</span><span class="p">(</span> <span class="n">Rpred</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">indxs1xv</span> <span class="p">)]</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>    <span class="n">Dpps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>    <span class="c1">#Dpps[0] = 1-varDF(dobs0[data.val_inds]-dmod0[data.val_inds], df=df[data.val_inds]) / \</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>    <span class="c1">#    varDF(dobs0[data.val_inds], df=df[data.val_inds])</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>    <span class="c1">#Dpps[1] = 1-varDF(dobs3[indxs3xv]-dmod3[indxs3xv], df=df[indxs3xv]) / \</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>    <span class="c1">#    varDF(dobs3[indxs3xv], df=df[indxs3xv])</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>    <span class="c1">#Dpps[2] = 1-varDF(dobs1[indxs1xv]-dmod1[indxs1xv], df=df[indxs1xv]) / \</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>    <span class="c1">#    varDF(dobs1[indxs1xv], df=df[indxs1xv])</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>    <span class="n">dobs_only0</span> <span class="o">=</span> <span class="n">dobs0</span><span class="o">-</span><span class="n">tobs0</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>    <span class="n">dobs_only3</span> <span class="o">=</span> <span class="n">dobs3</span><span class="o">-</span><span class="n">tobs3</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>    <span class="n">dobs_only1</span> <span class="o">=</span> <span class="n">dobs1</span><span class="o">-</span><span class="n">tobs1</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>    <span class="n">dmod_only0</span> <span class="o">=</span> <span class="n">dmod0</span><span class="o">-</span><span class="n">tmod0</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>    <span class="n">dmod_only3</span> <span class="o">=</span> <span class="n">dmod3</span><span class="o">-</span><span class="n">tmod3</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>    <span class="n">dmod_only1</span> <span class="o">=</span> <span class="n">dmod1</span><span class="o">-</span><span class="n">tmod1</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>    <span class="n">Dpps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">varDF</span><span class="p">(</span><span class="n">dobs_only0</span><span class="p">[</span><span class="n">v_inds</span><span class="p">]</span><span class="o">-</span><span class="n">dmod_only0</span><span class="p">[</span><span class="n">v_inds</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">v_inds</span><span class="p">],</span> <span class="n">mean_adj</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">/</span> \
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>        <span class="n">varDF</span><span class="p">(</span><span class="n">dobs_only0</span><span class="p">[</span><span class="n">v_inds</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">v_inds</span><span class="p">])</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>    <span class="n">Dpps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">varDF</span><span class="p">(</span><span class="n">dobs_only3</span><span class="p">[</span><span class="n">indxs3xv</span><span class="p">]</span><span class="o">-</span><span class="n">dmod_only3</span><span class="p">[</span><span class="n">indxs3xv</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">indxs3xv</span><span class="p">],</span> <span class="n">mean_adj</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">/</span> \
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>        <span class="n">varDF</span><span class="p">(</span><span class="n">dobs_only3</span><span class="p">[</span><span class="n">indxs3xv</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">indxs3xv</span><span class="p">])</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>    <span class="n">Dpps</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">varDF</span><span class="p">(</span><span class="n">dobs_only1</span><span class="p">[</span><span class="n">indxs1xv</span><span class="p">]</span><span class="o">-</span><span class="n">dmod_only1</span><span class="p">[</span><span class="n">indxs1xv</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">indxs1xv</span><span class="p">],</span> <span class="n">mean_adj</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">/</span> \
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>        <span class="n">varDF</span><span class="p">(</span><span class="n">dobs_only1</span><span class="p">[</span><span class="n">indxs1xv</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">indxs1xv</span><span class="p">])</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Pred powers: </span><span class="si">%0.3f</span><span class="s2">  disp </span><span class="si">%0.3f</span><span class="s2"> (FR3 </span><span class="si">%0.3f</span><span class="s2">, FR1 </span><span class="si">%0.3f</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">pps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Dpps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Dpps</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Dpps</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>    <span class="c1"># Add general tuning of each</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>    <span class="n">Dtun_obs</span> <span class="o">=</span> <span class="p">[</span><span class="n">disparity_tuning</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">],</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">3</span> <span class="p">),</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>                     <span class="n">disparity_tuning</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">],</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">1</span> <span class="p">)]</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>    <span class="n">Dtun_pred</span> <span class="o">=</span> <span class="p">[</span><span class="n">disparity_tuning</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">Rpred</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>                      <span class="n">disparity_tuning</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">Rpred</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>    <span class="c1"># Tuning curve consistency</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>    <span class="n">DtuningR2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">Dtun_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Dtun&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">Dtun_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Dtun&#39;</span><span class="p">]))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">Dtun_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Dtun&#39;</span><span class="p">]),</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>                 <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">Dtun_obs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Dtun&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">Dtun_pred</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Dtun&#39;</span><span class="p">]))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">Dtun_obs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Dtun&#39;</span><span class="p">])]</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Tuning consistency R2s: FR3 </span><span class="si">%0.3f</span><span class="s2">  FR1 </span><span class="si">%0.3f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">DtuningR2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">DtuningR2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>    <span class="n">BMP</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;EVfrac&#39;</span><span class="p">:</span> <span class="n">ev</span><span class="o">/</span><span class="n">tv</span><span class="p">,</span> <span class="s1">&#39;EVvalid&#39;</span><span class="p">:</span> <span class="n">ev_valid</span><span class="p">,</span> 
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>           <span class="s1">&#39;vars_obs&#39;</span><span class="p">:</span> <span class="n">vars_obs</span><span class="p">,</span> <span class="s1">&#39;vars_mod&#39;</span><span class="p">:</span> <span class="n">vars_mod</span><span class="p">,</span> <span class="s1">&#39;vars_obs_FR3&#39;</span><span class="p">:</span> <span class="n">vars_obs_FR3</span><span class="p">,</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>           <span class="s1">&#39;DVfrac_obs&#39;</span><span class="p">:</span> <span class="n">DVfrac_obs</span><span class="p">,</span> <span class="s1">&#39;DVfrac_mod&#39;</span><span class="p">:</span> <span class="n">DVfrac_mod</span><span class="p">,</span> 
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>           <span class="s1">&#39;pred_powers&#39;</span><span class="p">:</span> <span class="n">pps</span><span class="p">,</span> <span class="s1">&#39;disp_pred_powers&#39;</span><span class="p">:</span> <span class="n">Dpps</span><span class="p">,</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>           <span class="s1">&#39;Dtun_obs&#39;</span><span class="p">:</span> <span class="n">Dtun_obs</span><span class="p">,</span> <span class="s1">&#39;Dtun_pred&#39;</span><span class="p">:</span> <span class="n">Dtun_pred</span><span class="p">,</span> <span class="s1">&#39;DtuningR2&#39;</span><span class="p">:</span> <span class="n">DtuningR2</span><span class="p">}</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>    
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>    <span class="k">return</span> <span class="n">BMP</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a><span class="c1">## Binocular model utilities</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a><span class="k">def</span> <span class="nf">compute_mfilters</span><span class="p">(</span> <span class="n">tkerns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">to_output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a><span class="sd">    Compute a spatiotemporal filter from temporal kernels convolved with second-layer filter</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a><span class="sd">    </span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a><span class="sd">    Args:</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a><span class="sd">        tkerns: temporal kernels (NT x num_kernels)</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a><span class="sd">        filts: second-layer filters (num_kernels x num_space x num_filters)</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a><span class="sd">        mod: model to extract weights from</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a><span class="sd">        to_plot: whether to plot the filter</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a><span class="sd">        to_output: whether to return the filter</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a><span class="sd">    Returns:</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a><span class="sd">        Mfilts: spatiotemporal filter</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>    <span class="k">if</span> <span class="n">mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>        <span class="n">tkerns</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(</span><span class="n">layer_target</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>        <span class="n">filts</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(</span><span class="n">layer_target</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>        <span class="k">assert</span> <span class="n">filts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Cant have everything be none&quot;</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>    <span class="n">ntks</span> <span class="o">=</span> <span class="n">tkerns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>    <span class="n">nfilts</span> <span class="o">=</span> <span class="n">filts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filts</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>        <span class="n">filts</span><span class="o">=</span><span class="n">filts</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">ntks</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">nfilts</span><span class="p">])</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>        <span class="k">assert</span> <span class="n">filts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ntks</span><span class="p">,</span> <span class="s2">&quot;Issue with filter shapes&quot;</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>    <span class="n">Mfilts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;tb,bxl-&gt;xtl&#39;</span><span class="p">,</span> <span class="n">tkerns</span><span class="p">,</span> <span class="n">filts</span><span class="p">)</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>    <span class="k">if</span> <span class="n">to_plot</span><span class="p">:</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>        <span class="n">nrows</span> <span class="o">=</span> <span class="p">(</span><span class="n">nfilts</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>        <span class="n">ncols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">nfilts</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>        <span class="n">utils</span><span class="o">.</span><span class="n">ss</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">rh</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nfilts</span><span class="p">):</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>            <span class="n">utils</span><span class="o">.</span><span class="n">imagesc</span><span class="p">(</span><span class="n">Mfilts</span><span class="p">[:,:,</span> <span class="n">ii</span><span class="p">])</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>    <span class="k">if</span> <span class="n">to_output</span><span class="p">:</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>        <span class="k">return</span> <span class="n">Mfilts</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a><span class="k">def</span> <span class="nf">compute_binocular_filters_old</span><span class="p">(</span><span class="n">binoc_mod</span><span class="p">,</span> <span class="n">to_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>                              <span class="n">num_space</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ffnet_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mfilters</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a><span class="sd">    Using standard binocular model, compute filters. defaults to first ffnet and</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a><span class="sd">    num_space = 36. Set num_space=None to go to minimum given convolutional constraints</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a><span class="sd">    -&gt; this is older function that might be outdated (see new function below)</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a><span class="sd">    </span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a><span class="sd">    Args:</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a><span class="sd">        binoc_mod: binocular model</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a><span class="sd">        to_plot: whether to plot the filters</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a><span class="sd">        cmap: colormap to use</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a><span class="sd">        time_reverse: whether to reverse the time axis</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a><span class="sd">        num_space: number of spatial dimensions to use</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a><span class="sd">        ffnet_n: which feed-forward network to use</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a><span class="sd">        mfilters: monocular filters to use (if None, will use first layer of model)</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a><span class="sd">    Returns:</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a><span class="sd">        bifilts: binocular filters</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>    <span class="c1"># Find binocular layer within desired (or whole) model</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>    <span class="kn">from</span> <span class="nn">NDNT.modules.layers</span> <span class="kn">import</span> <span class="n">BiConvLayer1D</span><span class="p">,</span> <span class="n">BiSTconv1D</span> <span class="c1">#, ChannelConvLayer</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>    <span class="k">if</span> <span class="n">ffnet_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>        <span class="n">networks_to_search</span> <span class="o">=</span> <span class="p">[</span><span class="n">ffnet_n</span><span class="p">]</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>        <span class="n">networks_to_search</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">binoc_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">))</span>        
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>    <span class="n">blayer</span><span class="p">,</span> <span class="n">bnet</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>    <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="n">networks_to_search</span><span class="p">:</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">binoc_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">)):</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binoc_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span> <span class="n">BiConvLayer1D</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binoc_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span> <span class="n">BiSTconv1D</span><span class="p">):</span> <span class="c1"># this is layer output to bi-layer</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>                <span class="k">if</span> <span class="n">nn</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">binoc_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>                    <span class="n">bnet</span><span class="p">,</span> <span class="n">blayer</span> <span class="o">=</span> <span class="n">mm</span><span class="p">,</span> <span class="n">nn</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>                <span class="k">elif</span> <span class="n">mm</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">binoc_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>                    <span class="n">bnet</span><span class="p">,</span> <span class="n">blayer</span> <span class="o">=</span> <span class="n">mm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>  <span class="c1"># split in hierarchical network</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>    <span class="k">assert</span> <span class="n">blayer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;biconv layer not found&#39;</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>    <span class="k">if</span> <span class="n">mfilters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">bnet</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">blayer</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span> <span class="c1"># then mfilters are just first layer</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>            <span class="n">mfilters</span> <span class="o">=</span> <span class="n">binoc_mod</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(</span><span class="n">time_reverse</span><span class="o">=</span><span class="n">time_reverse</span><span class="p">)</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># construct using tkerns</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>            <span class="n">mfilters</span> <span class="o">=</span> <span class="n">compute_mfilters</span><span class="p">(</span><span class="n">mod</span><span class="o">=</span><span class="n">binoc_mod</span><span class="p">,</span> <span class="n">to_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">to_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>            <span class="k">if</span> <span class="n">time_reverse</span><span class="p">:</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: time_reverse not implemented in this case.&#39;</span><span class="p">)</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>    <span class="n">NXM</span><span class="p">,</span> <span class="n">num_lags</span><span class="p">,</span> <span class="n">NF</span> <span class="o">=</span> <span class="n">mfilters</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>    <span class="c1">#print(NXM, num_lags, NF)</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>    <span class="n">ws</span> <span class="o">=</span> <span class="n">binoc_mod</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(</span><span class="n">ffnet_target</span><span class="o">=</span><span class="n">bnet</span><span class="p">,</span> <span class="n">layer_target</span><span class="o">=</span><span class="n">blayer</span><span class="p">)</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>    <span class="n">NF2</span><span class="p">,</span> <span class="n">NXC</span><span class="p">,</span> <span class="n">NBF</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">shape</span> 
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>    <span class="n">num_cspace</span> <span class="o">=</span> <span class="n">NXM</span><span class="o">+</span><span class="n">NXC</span><span class="o">-</span><span class="mi">1</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>    <span class="n">eye_filts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">num_cspace</span><span class="p">,</span> <span class="n">num_lags</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NBF</span><span class="p">])</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>    <span class="c1">#if isinstance(binoc_mod.networks[bnet].layers[blayer], ChannelConvLayer):</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>        <span class="c1">#print(&#39;Input filters:&#39;, NXM, NF)</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>        <span class="c1">#print(NF2, &#39;weights per binocular filter, LRLR -&gt;&#39;, NF2//2, &#39;monocular filters involved&#39;)</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>        <span class="c1">#print(NXM,NXC,num_cspace)</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>    <span class="c1">#    assert (NF2//2)*NBF == NF, &quot;ChannelConv monocular filter mismatch&quot;</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>    <span class="c1">#    for ff in range(NBF):</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>    <span class="c1">#        frange = (NF2//2)*ff + np.arange(NF2//2) </span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>    <span class="c1">#        for xx in range(NXC):</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>    <span class="c1">#            for eye in range(2):</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>    <span class="c1">#                eye_filts[np.arange(NXM)+xx, :, eye, ff] += np.einsum(</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>    <span class="c1">#                    &#39;xtm,m-&gt;xt&#39;, mfilters[:, :, frange], ws[np.arange(eye,NF2,2), xx, ff] )</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>                    <span class="c1">#eye_filts[np.arange(NXM)+xx, :, eye, ff] += mfilters[:, :, frange+eye] @ ws[np.arange(eye,NF2,2), xx, ff][:,None,None]</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>    <span class="c1">#else: # Standard</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>    <span class="k">assert</span> <span class="n">NF2</span> <span class="o">==</span> <span class="mi">2</span><span class="o">*</span><span class="n">NF</span><span class="p">,</span> <span class="s2">&quot;Monocular filter number mismatch&quot;</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>    <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NXC</span><span class="p">):</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>        <span class="k">for</span> <span class="n">eye</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>            <span class="n">eye_filts</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NXM</span><span class="p">)</span><span class="o">+</span><span class="n">xx</span><span class="p">,</span> <span class="p">:,</span> <span class="n">eye</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>                <span class="s1">&#39;xtm,mf-&gt;xtf&#39;</span><span class="p">,</span> <span class="n">mfilters</span><span class="p">,</span> <span class="n">ws</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">eye</span><span class="p">,</span><span class="n">NF2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">xx</span><span class="p">,</span> <span class="p">:]</span> <span class="p">)</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>                <span class="c1">#&#39;xtm,mf-&gt;xtf&#39;, mfilters, ws[np.arange(NF)+eye*NF, xx, :] )</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>    <span class="k">if</span> <span class="n">num_space</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>        <span class="c1"># Cast into desired num_space</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>        <span class="n">num_space</span> <span class="o">=</span> <span class="n">num_cspace</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>    <span class="k">if</span> <span class="n">num_space</span> <span class="o">==</span> <span class="n">num_cspace</span><span class="p">:</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>        <span class="n">Bfilts</span> <span class="o">=</span> <span class="n">eye_filts</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>    <span class="k">elif</span> <span class="n">num_space</span> <span class="o">&gt;</span> <span class="n">num_cspace</span><span class="p">:</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>        <span class="n">Bfilts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">num_space</span><span class="p">,</span> <span class="n">num_lags</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NBF</span><span class="p">])</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>        <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_space</span><span class="o">-</span><span class="n">num_cspace</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>        <span class="n">Bfilts</span><span class="p">[</span><span class="n">padding</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_cspace</span><span class="p">),</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">eye_filts</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>    <span class="k">else</span><span class="p">:</span>  <span class="c1"># crop</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>        <span class="n">unpadding</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_cspace</span><span class="o">-</span><span class="n">num_space</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>        <span class="n">Bfilts</span> <span class="o">=</span> <span class="n">eye_filts</span><span class="p">[</span><span class="n">unpadding</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_space</span><span class="p">),</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>    <span class="n">bifilts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Bfilts</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Bfilts</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>    <span class="k">if</span> <span class="n">to_plot</span><span class="p">:</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>        <span class="kn">from</span> <span class="nn">NDNT.utils</span> <span class="kn">import</span> <span class="n">plot_filters_ST1D</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binoc_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">bnet</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">blayer</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">BiSTconv1D</span><span class="p">):</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>            <span class="n">bifilts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">bifilts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Then time-reverse </span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>        <span class="n">plot_filters_ST1D</span><span class="p">(</span> <span class="n">bifilts</span><span class="p">,</span> <span class="n">num_cols</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="p">)</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>        <span class="k">return</span> <span class="n">bifilts</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a><span class="k">def</span> <span class="nf">plot_sico_readout</span><span class="p">(</span> <span class="n">sico</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">row_mult</span><span class="o">=</span><span class="mf">0.2</span> <span class="p">):</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a><span class="sd">    Plot the readout weights of the SICO model</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a><span class="sd">    Args:</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a><span class="sd">        sico: SICO model</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a><span class="sd">        cell_n: select which clone to plot if clone model (default: None, assumes single model)</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a><span class="sd">        rh: height of plot, overriding scaling-per line (row_mult) (default: None)</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a><span class="sd">        row_mult: normal way to determine depth of plot: inches per line (default: 0.4)</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a><span class="sd">    Returns:</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a><span class="sd">        None</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>    <span class="kn">from</span> <span class="nn">NDNT.utils</span> <span class="kn">import</span> <span class="n">imagesc</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>    <span class="k">if</span> <span class="n">cell_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">sico</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>        <span class="k">if</span> <span class="n">sico</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">sico</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="o">...</span><span class="p">,</span> <span class="n">cell_n</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>    <span class="n">NF</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>    <span class="n">NI</span> <span class="o">=</span> <span class="n">sico</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">num_inh</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>    <span class="n">NE</span> <span class="o">=</span> <span class="n">NF</span><span class="o">-</span><span class="n">NI</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>    <span class="n">w</span><span class="p">[:,</span> <span class="n">NE</span><span class="p">:]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>    <span class="k">if</span> <span class="n">rh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>        <span class="n">rh</span> <span class="o">=</span> <span class="n">row_mult</span><span class="o">*</span><span class="n">NF</span><span class="o">+</span><span class="mf">0.55</span> <span class="c1">#np.minimum(0.4*NF,2)</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>        <span class="c1"># added 0.55 is estimated size of x-axis ticks and other vertical space</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>    <span class="k">if</span> <span class="n">cell_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>        <span class="n">utils</span><span class="o">.</span><span class="n">subplot_setup</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">row_height</span><span class="o">=</span><span class="n">rh</span><span class="p">,</span> <span class="n">fig_width</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>    <span class="n">imagesc</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">balanced</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>    <span class="k">if</span> <span class="n">cell_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a><span class="c1"># END plot_sico_readout()</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a><span class="c1">### NEW FUNCTIONS ADDED 2024 ###</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a><span class="k">def</span> <span class="nf">compute_mfilters</span><span class="p">(</span> <span class="n">mod</span><span class="p">,</span> <span class="n">tkerns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a><span class="sd">    Calculates the filters of the first (monocular) stage of model given tkerns</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a><span class="sd">    Args: </span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a><span class="sd">        mod: binocular model with monocular subspace and implicit temporal basis embedded in stim</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a><span class="sd">        tkerns: temporal kernels, if none (default) than just returns first layer (but shouldn&#39;t)</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a><span class="sd">    Returns:</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a><span class="sd">        mfilts: 3-d array space x lags x number of filters</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>    <span class="k">assert</span> <span class="n">tkerns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;No temporal basis specified.&quot;</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>    <span class="n">k</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>    <span class="k">if</span> <span class="n">tkerns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>        <span class="n">mfilts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;tc,xcf-&gt;xtf&#39;</span><span class="p">,</span> <span class="n">tkerns</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>        <span class="nb">print</span><span class="p">(</span>  <span class="s2">&quot;Warning: no temporal kernels specified, just using get_weights()&quot;</span> <span class="p">)</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>        <span class="n">mfilts</span> <span class="o">=</span> <span class="n">k</span>    
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>    <span class="k">return</span> <span class="n">mfilts</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a><span class="c1"># END compute_mfilters()</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a><span class="k">def</span> <span class="nf">dist_mean</span><span class="p">(</span> <span class="n">p</span> <span class="p">):</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xs</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a><span class="k">def</span> <span class="nf">compute_bfilters</span><span class="p">(</span> <span class="n">binoc_mod</span><span class="p">,</span> <span class="n">tkerns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">newlags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_lags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a><span class="sd">    Calculates binocular filter array for monocular-subspace model, including accounting for temporal kernels</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a><span class="sd">    used to preprocess the input.</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a><span class="sd">    Adjusts for skip_lags, although must enter by hand (default=0)</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a><span class="sd">    </span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a><span class="sd">    Args:</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a><span class="sd">        binoc_mod: assumes temporal kernels processing input, and monocular subspace before binocular filters</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a><span class="sd">        tkerns: temporal kernels that pre-processed stimulus</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a><span class="sd">        width: how wide each monocular filter should be displayed: its convolutional so not set. Default</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a><span class="sd">               is based on model itself: monocular filter with plus what binocular convolutions brings</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a><span class="sd">        newlags: lags past what is given by filter (default none)</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a><span class="sd">        center: centers each binocular filter based on mean temporal power (since it will be convolved too)</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a><span class="sd">    </span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a><span class="sd">    Returns:</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a><span class="sd">        eye_filts: binocular filters by eye with dims [2, width, lags, num_filters]        </span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>    <span class="k">if</span> <span class="n">tkerns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>        <span class="n">mfilters</span> <span class="o">=</span> <span class="n">binoc_mod</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(</span><span class="n">layer_target</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>        <span class="k">if</span> <span class="n">skip_lags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>            <span class="n">mfilters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">mfilters</span><span class="p">,</span> <span class="n">skip_lags</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>        <span class="c1"># shift </span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>        <span class="k">if</span> <span class="n">skip_lags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>            <span class="n">tks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">tkerns</span><span class="p">,</span> <span class="n">skip_lags</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>            <span class="n">tks</span> <span class="o">=</span> <span class="n">tkerns</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>        <span class="n">mfilters</span> <span class="o">=</span> <span class="n">compute_mfilters</span><span class="p">(</span><span class="n">binoc_mod</span><span class="p">,</span> <span class="n">tkerns</span><span class="o">=</span><span class="n">tks</span><span class="p">)</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>    
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>    <span class="n">NXM</span><span class="p">,</span> <span class="n">num_lags</span><span class="p">,</span> <span class="n">NF</span> <span class="o">=</span> <span class="n">mfilters</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>    <span class="k">if</span> <span class="n">newlags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>        <span class="n">newlags</span> <span class="o">=</span> <span class="n">num_lags</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>    <span class="n">ws</span> <span class="o">=</span> <span class="n">binoc_mod</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(</span><span class="n">ffnet_target</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">layer_target</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>    <span class="n">NF2</span><span class="p">,</span> <span class="n">NXC</span><span class="p">,</span> <span class="n">NBF</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">shape</span> 
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>    <span class="n">num_cspace</span> <span class="o">=</span> <span class="n">NXM</span><span class="o">+</span><span class="n">NXC</span><span class="o">-</span><span class="mi">1</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>    <span class="c1">#print(&#39;top&#39;, NF2, NXC, NBF, num_cspace)</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>    <span class="c1">#print(mfilters.shape, tkerns.shape, NXM)</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>    <span class="n">eye_filts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">num_cspace</span><span class="p">,</span> <span class="n">newlags</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NBF</span><span class="p">])</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>    <span class="k">assert</span> <span class="n">NF2</span> <span class="o">==</span> <span class="mi">2</span><span class="o">*</span><span class="n">NF</span><span class="p">,</span> <span class="s2">&quot;Monocular filter number mismatch&quot;</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>    <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NXC</span><span class="p">):</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>        <span class="k">for</span> <span class="n">eye</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>            <span class="n">eye_filts</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NXM</span><span class="p">)</span><span class="o">+</span><span class="n">xx</span><span class="p">,</span> <span class="p">:,</span> <span class="n">eye</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>                <span class="s1">&#39;xtm,mf-&gt;xtf&#39;</span><span class="p">,</span> <span class="n">mfilters</span><span class="p">[:,:</span><span class="n">newlags</span><span class="p">,:],</span> <span class="n">ws</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">eye</span><span class="p">,</span><span class="n">NF2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">xx</span><span class="p">,</span> <span class="p">:]</span> <span class="p">)</span><span class="c1">#[:, :newlags]</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>    <span class="k">if</span> <span class="n">center</span><span class="p">:</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>        <span class="n">sp_maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">eye_filts</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NBF</span><span class="p">):</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>            <span class="n">sh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">num_cspace</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">dist_mean</span><span class="p">(</span><span class="n">sp_maps</span><span class="p">[:,</span><span class="n">ii</span><span class="p">])))</span>                
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>            <span class="n">eye_filts</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">eye_filts</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">sh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>    <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>        <span class="n">width</span> <span class="o">=</span> <span class="n">num_cspace</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>    <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="n">num_cspace</span><span class="p">:</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>        <span class="n">shrinky</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_cspace</span><span class="o">-</span><span class="n">width</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  shrinking width&#39;</span><span class="p">,</span> <span class="n">num_cspace</span><span class="p">,</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>        <span class="n">eye_filts</span> <span class="o">=</span> <span class="n">eye_filts</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">width</span><span class="p">)</span><span class="o">+</span><span class="n">shrinky</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>        <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">num_cspace</span><span class="p">:</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;width too large -- havent set up yet&#39;</span><span class="p">)</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>    
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>    <span class="k">return</span> <span class="n">eye_filts</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a><span class="k">def</span> <span class="nf">plot_mfilters</span><span class="p">(</span> <span class="n">model</span><span class="p">,</span> <span class="n">tkerns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_lags</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">rh</span><span class="o">=</span><span class="mi">2</span> <span class="p">):</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a><span class="sd">    Plots mfilters (first-layer monocular filters) of sico models, using compute_mfilters to calcuate. </span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a><span class="sd">    Inputs:</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a><span class="sd">        model: sico model to plot monocular filters of</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a><span class="sd">        tkerns: temporal kernels used in sico model (default: None assumes no temporal filters used)</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a><span class="sd">        flip: whether to have lag-0 at bottom and go up (default: flip=True) or opposite</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a><span class="sd">        axis_labels: whether to display axis_labels (default: False=No)</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a><span class="sd">        max_lags: number of lags to trim at (default: 12)</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a><span class="sd">        rh: row height in units of inches (default: 2) </span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>    <span class="n">mfilts</span> <span class="o">=</span> <span class="n">compute_mfilters</span><span class="p">(</span> <span class="n">model</span><span class="p">,</span> <span class="n">tkerns</span><span class="o">=</span><span class="n">tkerns</span><span class="p">)</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>    <span class="n">NF</span> <span class="o">=</span> <span class="n">mfilts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>    <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">NF</span><span class="o">/</span><span class="mi">6</span><span class="p">))</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>    <span class="n">utils</span><span class="o">.</span><span class="n">ss</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span> <span class="n">rh</span><span class="o">=</span><span class="n">rh</span><span class="p">)</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NF</span><span class="p">):</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>        <span class="k">if</span> <span class="n">flip</span><span class="p">:</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>            <span class="n">utils</span><span class="o">.</span><span class="n">imagesc</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">mfilts</span><span class="p">[:,</span> <span class="p">:</span><span class="n">max_lags</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis_labels</span><span class="o">=</span><span class="n">axis_labels</span><span class="p">)</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>            <span class="n">utils</span><span class="o">.</span><span class="n">imagesc</span><span class="p">(</span><span class="n">mfilts</span><span class="p">[:,</span> <span class="p">:</span><span class="n">max_lags</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">axis_labels</span><span class="o">=</span><span class="n">axis_labels</span><span class="p">)</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a><span class="c1"># END plot_mfilters()</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a><span class="k">def</span> <span class="nf">plot_bfilters</span><span class="p">(</span> <span class="n">model</span><span class="p">,</span> <span class="n">tkerns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_lags</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">rh</span><span class="o">=</span><span class="mi">2</span> <span class="p">):</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a><span class="sd">    Plots bfilters (second-layer binocular filters) of sico models, using compute_bfilters to calcuate. </span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a><span class="sd">    Inputs:</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a><span class="sd">        model: sico model to plot monocular filters of</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a><span class="sd">        tkerns: temporal kernels used in sico model (default: None assumes no temporal filters used)</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a><span class="sd">        flip: whether to have lag-0 at bottom and go up (default: flip=True) or opposite</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a><span class="sd">        axis_labels: whether to display axis_labels (default: False=No)</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a><span class="sd">        max_lags: number of lags to trim at (default: 12)</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a><span class="sd">        rh: row height in units of inches (default: 2) </span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>    <span class="n">kb</span> <span class="o">=</span> <span class="n">compute_bfilters</span><span class="p">(</span> <span class="n">model</span><span class="p">,</span> <span class="n">tkerns</span> <span class="p">)</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>    <span class="n">_</span><span class="p">,</span> <span class="n">fw</span><span class="p">,</span> <span class="n">nlags</span><span class="p">,</span> <span class="n">NF</span> <span class="o">=</span> <span class="n">kb</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>    <span class="n">nexc</span> <span class="o">=</span> <span class="n">NF</span><span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">num_inh</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>    <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">NF</span><span class="o">/</span><span class="mi">4</span><span class="p">))</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>    <span class="n">utils</span><span class="o">.</span><span class="n">ss</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="n">rh</span><span class="o">=</span><span class="n">rh</span><span class="p">)</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>    <span class="c1">#m = np.max(abs(kb))</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NF</span><span class="p">):</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>        <span class="k">if</span> <span class="n">flip</span><span class="p">:</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>            <span class="n">utils</span><span class="o">.</span><span class="n">imagesc</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">kb</span><span class="p">[:,:,:</span><span class="n">max_lags</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">max_lags</span><span class="p">])),</span> <span class="n">axis_labels</span><span class="o">=</span><span class="n">axis_labels</span> <span class="p">)</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>            <span class="n">utils</span><span class="o">.</span><span class="n">imagesc</span><span class="p">(</span> <span class="n">kb</span><span class="p">[:,:,:</span><span class="n">max_lags</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">max_lags</span><span class="p">])</span> <span class="p">)</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">fw</span><span class="o">-</span><span class="mf">0.5</span><span class="p">),[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">max_lags</span><span class="o">-</span><span class="mf">0.5</span><span class="p">],</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>        <span class="k">if</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">nexc</span><span class="p">:</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;EXC </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">ii</span><span class="p">)</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">: INH </span><span class="si">%d</span><span class="s2"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">ii</span><span class="o">-</span><span class="n">nexc</span><span class="p">))</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a><span class="c1"># END plot_bfilters()</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a><span class="c1">#### NEW CLONE UTILS ####</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a><span class="k">def</span> <span class="nf">clone_model_selection</span><span class="p">(</span> <span class="n">LLs</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">LLthresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a><span class="sd">    Model selection from regularization -- find smallest regularization value within thresh of max</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a><span class="sd">    This is made for first-stage clone-sico models that have an ordering (from small to big)</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a><span class="sd">    Choses earliest model that has LL greater than threshold</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a><span class="sd">    Input:</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a><span class="sd">        LLs: LL list for all the clones</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a><span class="sd">        thresh: fraction of max that threshold is selected for (default: 0.99)</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a><span class="sd">        LLthresh: explicit LL-threshold: overrides value of thresh, but default=None</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a><span class="sd">        verbose: to print inner workings or not</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a><span class="sd">    Returns:</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a><span class="sd">        selection: index of clone that fits criteria</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>    <span class="k">if</span> <span class="n">LLthresh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>        <span class="n">LLthresh</span> <span class="o">=</span> <span class="n">thresh</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">LLs</span><span class="p">)</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LLs</span> <span class="o">&gt;=</span> <span class="n">LLthresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>    <span class="n">selection</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%d</span><span class="s2"> LLs meet criteria (</span><span class="si">%0.5f</span><span class="s2"> out of </span><span class="si">%0.5f</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">LLthresh</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">LLs</span><span class="p">)))</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Using </span><span class="si">%d</span><span class="s2">: (max at </span><span class="si">%d</span><span class="s2"> out of </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">LLs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">LLs</span><span class="p">)))</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>    <span class="k">return</span> <span class="n">selection</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a><span class="c1"># END model_selection()</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a><span class="k">def</span> <span class="nf">reconstitute_bmodel</span><span class="p">(</span> <span class="n">clone_mod</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a><span class="sd">    SiCo-model specific: makes reduced single-neuron model from larger-scale clone model,</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a><span class="sd">    which generates many different instances of a single neuron model.</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a><span class="sd">    Args:</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a><span class="sd">        clone_mod: clone-sico model with many instances of single neuron models</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a><span class="sd">        cc: which clone to take</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a><span class="sd">        verbose: whether to suppress output (default: verbose=True)</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a><span class="sd">    </span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a><span class="sd">    Returns:</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a><span class="sd">        single_mod: sico single-neuron model</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>    <span class="c1">### start with exact copy </span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>    <span class="kn">import</span> <span class="nn">torch</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>    <span class="n">clone_mod</span> <span class="o">=</span> <span class="n">clone_mod</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">))</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>    <span class="n">num_networks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clone_mod</span><span class="o">.</span><span class="n">ffnet_list</span><span class="p">)</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>    <span class="n">stim_net</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">clone_mod</span><span class="o">.</span><span class="n">ffnet_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>    
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>    <span class="c1"># Reconstitute mask</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>    <span class="n">NF</span> <span class="o">=</span> <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>    <span class="n">NX</span> <span class="o">=</span> <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>    <span class="n">NXmod</span> <span class="o">=</span> <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>    <span class="n">NC</span> <span class="o">=</span> <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">output_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>    <span class="n">numE</span> <span class="o">=</span> <span class="n">NF</span> <span class="o">-</span> <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">num_inh</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>    <span class="n">mask</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NF</span><span class="p">,</span> <span class="n">NXmod</span><span class="p">,</span> <span class="n">NC</span><span class="p">])</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>    
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>    <span class="c1"># Extract how many filters getting pulled</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>    <span class="n">ne</span> <span class="o">=</span>  <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">[:</span><span class="n">numE</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cc</span><span class="p">]))</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>    <span class="n">ni</span> <span class="o">=</span>  <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">numE</span><span class="p">:,</span><span class="mi">0</span><span class="p">,</span><span class="n">cc</span><span class="p">]))</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Model extraction: </span><span class="si">%d</span><span class="s2"> exc, </span><span class="si">%d</span><span class="s2"> inh filters&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ne</span><span class="p">,</span> <span class="n">ni</span><span class="p">))</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>    <span class="c1"># modification of binocular layer</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>    <span class="n">stim_net</span><span class="p">[</span><span class="s1">&#39;layer_list&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;num_filters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ne</span><span class="o">+</span><span class="n">ni</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>    <span class="n">stim_net</span><span class="p">[</span><span class="s1">&#39;layer_list&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;num_inh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ni</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>    <span class="c1"># modification of readout layer</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>    <span class="n">stim_net</span><span class="p">[</span><span class="s1">&#39;layer_list&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;layer_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>    <span class="n">stim_net</span><span class="p">[</span><span class="s1">&#39;layer_list&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;num_filters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>    <span class="c1">#del stim_net[&#39;layer_list&#39;][2][&#39;mask&#39;]</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>    <span class="k">if</span> <span class="n">num_networks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>        <span class="n">single_mod</span> <span class="o">=</span> <span class="n">NDN</span><span class="p">(</span> <span class="n">ffnet_list</span><span class="o">=</span><span class="p">[</span><span class="n">stim_net</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>        
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>        <span class="n">drift_net</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">clone_mod</span><span class="o">.</span><span class="n">ffnet_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>        <span class="n">drift_net</span><span class="p">[</span><span class="s1">&#39;layer_list&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;num_filters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>        
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>        <span class="n">comb_net</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">clone_mod</span><span class="o">.</span><span class="n">ffnet_list</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>        <span class="n">comb_net</span><span class="p">[</span><span class="s1">&#39;layer_list&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;layer_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>        <span class="n">comb_net</span><span class="p">[</span><span class="s1">&#39;layer_list&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;num_filters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>    
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>        <span class="n">single_mod</span> <span class="o">=</span> <span class="n">NDN</span><span class="p">(</span> <span class="n">ffnet_list</span><span class="o">=</span><span class="p">[</span><span class="n">stim_net</span><span class="p">,</span> <span class="n">drift_net</span><span class="p">,</span> <span class="n">comb_net</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>        <span class="n">single_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>            <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>    <span class="c1"># Copy stim-processing in layer-0</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>    <span class="n">single_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>    <span class="c1"># Get relevant filters in layer-1</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>    <span class="n">non_zeroBs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="n">cc</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>    <span class="n">single_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>        <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">non_zeroBs</span><span class="p">])</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>    <span class="k">if</span> <span class="n">single_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_norm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>        <span class="n">single_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_norm</span><span class="o">.</span><span class="n">running_mean</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> \
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>            <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_norm</span><span class="o">.</span><span class="n">running_mean</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">non_zeroBs</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>        <span class="n">single_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_norm</span><span class="o">.</span><span class="n">running_var</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> \
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>            <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_norm</span><span class="o">.</span><span class="n">running_var</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">non_zeroBs</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>        <span class="n">single_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_norm</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> \
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>            <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_norm</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">non_zeroBs</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>        <span class="n">single_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_norm</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> \
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>            <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_norm</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">non_zeroBs</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>    <span class="c1"># get relevant input weights in readout</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>    <span class="n">bweights</span> <span class="o">=</span> <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NF</span><span class="p">,</span> <span class="n">NXmod</span><span class="p">,</span> <span class="n">NC</span><span class="p">])</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>    <span class="n">single_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">bweights</span><span class="p">[</span><span class="n">non_zeroBs</span><span class="p">,:,</span> <span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>    <span class="n">single_mod</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>    <span class="k">return</span> <span class="n">single_mod</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a><span class="c1"># END reconstitute_bmodel()</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a><span class="k">def</span> <span class="nf">bmp_check</span><span class="p">(</span> <span class="n">mod</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">LLs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">valset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cell_list</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a><span class="sd">    calculate binocular model performance (pred power and disparity power) for top num_cells in clone-model</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a><span class="sd">    it uses LLs to sort from top, but also can explicitly enter &#39;cell_list&#39;, which supercedes</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a><span class="sd">    cell_list trumps everything else</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a><span class="sd">    Args:</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a><span class="sd">        mod: clone binocular model with lots of outputs</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a><span class="sd">        dataset: dataset that can push through mod</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a><span class="sd">        LLs: LLs of the mod. Should be able to generate internally, but would need null models</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a><span class="sd">        num_cells: how many of the top cells/outputs to calculate with</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a><span class="sd">        valset: whether to use &#39;a&#39; or &#39;b&#39; (devault is &#39;b&#39;)</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a><span class="sd">        cell_list: superceded ordering by LLs, and just says which ccs to calculate performance for</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a><span class="sd">    Returns:</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a><span class="sd">        pps: predictive powers of whole clone array, but non-zero for only cells that were computed here</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a><span class="sd">        dps: disparity-predictive powers for same deal as pps</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a><span class="sd">        cell_order: list of cells that were probed</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>    <span class="kn">import</span> <span class="nn">torch</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>    <span class="k">if</span> <span class="n">valset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>        <span class="n">valset</span><span class="o">=</span><span class="s1">&#39;b&#39;</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>        <span class="c1">#print(&#39;  Testing valset b&#39;)</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>    <span class="n">mod</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">))</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>    <span class="n">NF</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>    <span class="n">NXmod</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>    <span class="n">NC</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">output_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>    <span class="n">numE</span> <span class="o">=</span> <span class="n">NF</span> <span class="o">-</span> <span class="n">mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">num_inh</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>    <span class="n">mask</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NF</span><span class="p">,</span> <span class="n">NXmod</span><span class="p">,</span> <span class="n">NC</span><span class="p">])</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>    
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>    <span class="k">if</span> <span class="n">num_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>        <span class="n">num_cells</span> <span class="o">=</span> <span class="n">NC</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>    <span class="k">if</span> <span class="n">cell_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>        <span class="k">assert</span> <span class="n">LLs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to pass in LLs&quot;</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">LLs</span><span class="p">)</span> <span class="o">==</span> <span class="n">NC</span><span class="p">,</span> <span class="s2">&quot;LLs size mismatch given model&quot;</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>        <span class="n">cell_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">LLs</span><span class="p">)[</span><span class="nb">range</span><span class="p">(</span><span class="n">NC</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)][:</span><span class="n">num_cells</span><span class="p">]</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>        <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_int</span><span class="p">(</span><span class="n">cell_list</span><span class="p">):</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>            <span class="n">cell_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell_list</span><span class="p">]</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>        <span class="n">cell_order</span> <span class="o">=</span> <span class="n">cell_list</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>        <span class="n">num_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_list</span><span class="p">)</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>        <span class="k">if</span> <span class="n">LLs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>            <span class="n">LLs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NC</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>    <span class="n">rs</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">dataset</span><span class="p">[:])</span>  <span class="c1"># predicted responses acriss time</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>    
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>    <span class="n">pps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NC</span><span class="p">])</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>    <span class="n">dps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NC</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>    
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_cells</span><span class="p">):</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>        <span class="n">cc</span> <span class="o">=</span> <span class="n">cell_order</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>        <span class="n">bmp</span> <span class="o">=</span> <span class="n">binocular_model_performance</span><span class="p">(</span> 
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>            <span class="n">data</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Rpred</span><span class="o">=</span><span class="n">rs</span><span class="p">[:,</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">valset</span><span class="o">=</span><span class="n">valset</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>        <span class="c1"># Compute aspects of this model</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>        <span class="n">ne</span> <span class="o">=</span>  <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">[:</span><span class="n">numE</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cc</span><span class="p">]))</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>        <span class="n">ni</span> <span class="o">=</span>  <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">numE</span><span class="p">:,</span><span class="mi">0</span><span class="p">,</span><span class="n">cc</span><span class="p">]))</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>        <span class="n">pps</span><span class="p">[</span><span class="n">cc</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmp</span><span class="p">[</span><span class="s1">&#39;pred_powers&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>        <span class="n">dps</span><span class="p">[</span><span class="n">cc</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">bmp</span><span class="p">[</span><span class="s1">&#39;disp_pred_powers&#39;</span><span class="p">][:</span><span class="mi">2</span><span class="p">])</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>        <span class="k">if</span> <span class="n">cell_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%3d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">):</span><span class="se">\t</span><span class="s2">pp = </span><span class="si">%6.4f</span><span class="s2">  dp3 = </span><span class="si">%6.4f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">ni</span><span class="p">,</span> <span class="n">pps</span><span class="p">[</span><span class="n">cc</span><span class="p">],</span> <span class="n">dps</span><span class="p">[</span><span class="n">cc</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%3d</span><span class="s2"> </span><span class="si">%7.5f</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">):</span><span class="se">\t</span><span class="s2">pp = </span><span class="si">%6.4f</span><span class="s2">  dp3 = </span><span class="si">%6.4f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">LLs</span><span class="p">[</span><span class="n">cc</span><span class="p">],</span> <span class="n">ne</span><span class="p">,</span> <span class="n">ni</span><span class="p">,</span> <span class="n">pps</span><span class="p">[</span><span class="n">cc</span><span class="p">],</span> <span class="n">dps</span><span class="p">[</span><span class="n">cc</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>    <span class="k">return</span> <span class="n">pps</span><span class="p">,</span> <span class="n">dps</span><span class="p">,</span> <span class="n">cell_order</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a><span class="k">def</span> <span class="nf">subsample_mask</span><span class="p">(</span> <span class="n">numM</span><span class="p">,</span> <span class="n">numB</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">conv_width</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">flatten</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a><span class="sd">    Generate mask to give binocular filters (numB) access to some number of monocular filters</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a><span class="sd">    Args</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a><span class="sd">        numM: size of monocular pool</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a><span class="sd">        numB: number of binocular filters</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a><span class="sd">        alpha: how many monocular filters each gets to sample </span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a><span class="sd">    </span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a><span class="sd">    Returns:</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a><span class="sd">        mask that is [numM, conv_width, numB] with alpha ones in each row (randomly selected)</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">numM</span><span class="p">,</span> <span class="n">conv_width</span><span class="p">,</span> <span class="n">numB</span><span class="p">])</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>    
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>    <span class="k">if</span> <span class="n">resample</span><span class="p">:</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numB</span><span class="p">):</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">numM</span><span class="p">))</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>            <span class="n">mask</span><span class="p">[</span><span class="n">a</span><span class="p">[:</span><span class="n">alpha</span><span class="p">],</span> <span class="p">:,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>    <span class="k">else</span><span class="p">:</span>  <span class="c1"># make more distributed by going through order explicitly once each time -- each filter used same amt</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>        <span class="n">filt_sample</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">alpha</span><span class="o">*</span><span class="n">numB</span><span class="o">/</span><span class="n">numM</span><span class="p">))):</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>            <span class="n">filt_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">filt_sample</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">numM</span><span class="p">))))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numB</span><span class="p">):</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>            <span class="n">mask</span><span class="p">[</span><span class="n">filt_sample</span><span class="p">[</span><span class="n">pos</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">alpha</span><span class="p">)],</span> <span class="p">:,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>            <span class="n">pos</span> <span class="o">+=</span> <span class="n">alpha</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>            
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>    <span class="k">if</span> <span class="n">flatten</span><span class="p">:</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>        <span class="k">return</span> <span class="n">mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numB</span><span class="p">])</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>        <span class="k">return</span> <span class="n">mask</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>    
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>    
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a><span class="k">def</span> <span class="nf">EImask</span><span class="p">(</span> <span class="n">numEIavail</span><span class="p">,</span> <span class="n">numE</span><span class="p">,</span> <span class="n">numI</span><span class="p">,</span> <span class="n">num_filters</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">flatten</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>    
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">numEIavail</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">num_filters</span><span class="p">])</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>    <span class="n">mask</span><span class="p">[:</span><span class="n">numEIavail</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">subsample_mask</span><span class="p">(</span> 
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>        <span class="n">numEIavail</span><span class="p">,</span> <span class="n">num_filters</span><span class="p">,</span> <span class="n">numE</span><span class="p">,</span> <span class="n">conv_width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">flatten</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">)</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>    <span class="k">if</span> <span class="n">numI</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>        <span class="n">mask</span><span class="p">[</span><span class="n">numEIavail</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">subsample_mask</span><span class="p">(</span> 
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>            <span class="n">numEIavail</span><span class="p">,</span> <span class="n">num_filters</span><span class="p">,</span> <span class="n">numI</span><span class="p">,</span> <span class="n">conv_width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">flatten</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">)</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>    <span class="k">if</span> <span class="n">flatten</span><span class="p">:</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>        <span class="k">return</span> <span class="n">mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_filters</span><span class="p">])</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>        <span class="k">return</span> <span class="n">mask</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>    
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>    
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a><span class="k">def</span> <span class="nf">convert2ST</span><span class="p">(</span> <span class="n">mod0</span><span class="p">,</span> <span class="n">temporal_basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">new_lags</span><span class="o">=</span><span class="mi">16</span> <span class="p">):</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a><span class="sd">    Convert temporal-basis-based model to spatiotemporal with new_lags</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>    <span class="kn">from</span> <span class="nn">NDNT.modules.layers.bilayers</span> <span class="kn">import</span> <span class="n">BiConvLayer1D</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>    <span class="kn">import</span> <span class="nn">torch</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>    <span class="k">assert</span> <span class="n">temporal_basis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;need to enter temporal basis&quot;</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>    <span class="n">converted_model</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">mod0</span><span class="p">)</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>    <span class="n">mks</span> <span class="o">=</span> <span class="n">compute_mfilters</span><span class="p">(</span> <span class="n">mod0</span><span class="p">,</span> <span class="n">temporal_basis</span> <span class="p">)</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>    <span class="c1">#print(mks.shape)</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>    <span class="n">mfilt_layer_pars</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">mod0</span><span class="o">.</span><span class="n">ffnet_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;layer_list&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>    <span class="n">mfilt_layer_pars</span><span class="p">[</span><span class="s1">&#39;input_dims&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_lags</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>    <span class="n">mfilt_layer_pars</span><span class="p">[</span><span class="s1">&#39;filter_dims&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_lags</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>    <span class="c1"># ALSO CONVERT relevant parts of ffnet_list</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>    <span class="n">converted_model</span><span class="o">.</span><span class="n">ffnet_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;layer_list&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;input_dims&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_lags</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>    <span class="n">converted_model</span><span class="o">.</span><span class="n">ffnet_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;layer_list&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;filter_dims&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_lags</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>    <span class="n">Mlayer</span> <span class="o">=</span> <span class="n">BiConvLayer1D</span><span class="p">(</span><span class="o">**</span><span class="n">mfilt_layer_pars</span><span class="p">)</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>    <span class="n">Mlayer</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">mks</span><span class="p">[:,:</span><span class="n">new_lags</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">mks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]))</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>    <span class="n">converted_model</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mlayer</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>    <span class="k">return</span> <span class="n">converted_model</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a><span class="k">def</span> <span class="nf">bmodel_regpath</span><span class="p">(</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>    <span class="n">model</span><span class="p">,</span> <span class="n">train_ds</span><span class="p">,</span> <span class="n">val_ds</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_vals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ffnet_target</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">layer_target</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>    <span class="n">nullLL</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">couple_xt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hard_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extended_loop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">average_pool</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a><span class="sd">    regularization-path for NDN model -- standard I think other than using specific details of the model</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a><span class="sd">    Args:</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a><span class="sd">        model: model to be regularized</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a><span class="sd">        train_ds: dataset to be used for training (generic, on device already)</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a><span class="sd">        val_ds: dataset for validation, complementary to train_ds</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a><span class="sd">        reg_type: type of regularization (required)</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a><span class="sd">        reg_vals: list of regularization values (default: [1e-6, 0.0001, 0.001, 0.01, 0.1])</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a><span class="sd">        ffnet_target: which ffnetwork that containes layer to regularize (default: 0)</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a><span class="sd">        layer_target: which layer to regularize (default 0)</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a><span class="sd">        nullLL: give LL-null of model so that can correctly compute LLs relative to null model. Default is</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a><span class="sd">            None, where it will use the embedded null_adjusted=True of eval_models</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a><span class="sd">        couple_xt: whether to make d2t=d2x/2 coupled to &#39;d2x&#39; when its the reg_type (default: True)</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a><span class="sd">        extended_loop: whether to continue with reg_vals of factors of 10 if best value is last (default: True)</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a><span class="sd">        hard_reset: when set to &#39;True&#39;: will zero out drift model to force model to fit longer (default: False)</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a><span class="sd">        average_pool: if population model, which fraction of LLs to average over to determine </span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a><span class="sd">            the best-reg (default: 1=all)</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a><span class="sd">        verbose: self-explanatory (default: True)</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a><span class="sd">        device: which device to use (default cuda:0)</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a><span class="sd">    Returns:</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a><span class="sd">        model_select: selected model</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a><span class="sd">        reg_val: selected reg value from the reg_vals list</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a><span class="sd">        export_dict: dictionary with detailed information of reg path</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>    <span class="kn">import</span> <span class="nn">torch</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>    <span class="kn">from</span> <span class="nn">NDNT.utils</span> <span class="kn">import</span> <span class="n">fit_lbfgs</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>    <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;ERROR: Must specify reg_type&quot;</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>    <span class="k">assert</span> <span class="n">average_pool</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;average_pool mis-set&quot;</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>    <span class="n">MAX_REGS</span> <span class="o">=</span> <span class="mi">16</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>    <span class="k">if</span> <span class="n">reg_vals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>        <span class="n">reg_vals</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>    <span class="n">num_regs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_vals</span><span class="p">)</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>    <span class="n">Rmods</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>    <span class="n">LLsR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_regs</span><span class="p">)</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>    <span class="n">LLcells</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Reg path </span><span class="si">%s</span><span class="s2">:&quot;</span><span class="o">%</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_vals</span><span class="p">)</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg_vals</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>        <span class="n">reg_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reg_vals</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>    <span class="c1">## This is a loop so that regularization path can be extended until LLs go down</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>    <span class="n">LLbest</span><span class="p">,</span> <span class="n">rr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>    <span class="c1">#for rr in range(num_regs):</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>    <span class="k">while</span> <span class="n">rr</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reg_vals</span><span class="p">),</span> <span class="n">MAX_REGS</span><span class="p">):</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>        <span class="n">sico_iter</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>        <span class="n">sico_iter</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">ffnet_target</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_target</span><span class="p">]</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="n">reg_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_vals</span><span class="p">[</span><span class="n">rr</span><span class="p">]</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>        
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;d2x&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">couple_xt</span><span class="p">:</span>  <span class="c1"># then couple d2t</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>            <span class="n">sico_iter</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">ffnet_target</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_target</span><span class="p">]</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;d2t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_vals</span><span class="p">[</span><span class="n">rr</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>            
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>        <span class="k">if</span> <span class="n">hard_reset</span><span class="p">:</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>            <span class="n">sico_iter</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>            
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>        <span class="n">sico_iter</span> <span class="o">=</span> <span class="n">sico_iter</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>        <span class="n">fit_lbfgs</span><span class="p">(</span> <span class="n">sico_iter</span><span class="p">,</span> <span class="n">train_ds</span><span class="p">[:],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>        
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>        <span class="k">if</span> <span class="n">nullLL</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>            <span class="n">LLs</span> <span class="o">=</span> <span class="n">sico_iter</span><span class="o">.</span><span class="n">eval_models</span><span class="p">(</span><span class="n">val_ds</span><span class="p">[:],</span> <span class="n">null_adjusted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>            <span class="n">LLs</span> <span class="o">=</span> <span class="n">nullLL</span><span class="o">-</span><span class="n">LLs</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>        <span class="n">sico_iter</span> <span class="o">=</span> <span class="n">sico_iter</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">))</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>        <span class="n">LLcells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">LLs</span><span class="p">))</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">LLs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>            <span class="n">LL</span> <span class="o">=</span> <span class="n">LLs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>            <span class="k">if</span> <span class="n">average_pool</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>                <span class="n">LL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">LLs</span><span class="p">)</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>                <span class="n">num_skip</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">LLs</span><span class="p">)</span><span class="o">*</span><span class="n">average_pool</span><span class="p">))</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>                <span class="n">LL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">LLs</span><span class="p">)[</span><span class="n">num_skip</span><span class="p">:])</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>                
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>        <span class="n">Rmods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sico_iter</span><span class="p">))</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>        <span class="n">LLsR</span><span class="p">[</span><span class="n">rr</span><span class="p">]</span> <span class="o">=</span> <span class="n">LL</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">LL</span> <span class="o">&gt;</span> <span class="n">LLbest</span><span class="p">):</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  </span><span class="si">%s</span><span class="s2">-</span><span class="si">%d</span><span class="s2">: </span><span class="si">%9.6f</span><span class="s2"> **&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">rr</span><span class="p">,</span> <span class="n">LL</span><span class="p">))</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>            <span class="c1">#BU.plot_mfilters(sico_iter, TB)</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>            <span class="n">LLbest</span> <span class="o">=</span> <span class="n">LL</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">rr</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_vals</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">extended_loop</span><span class="p">:</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>                <span class="n">reg_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">reg_vals</span><span class="p">,</span> <span class="p">[</span><span class="n">reg_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="p">])</span> <span class="p">)</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>                <span class="n">LLsR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">LLsR</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span> <span class="c1"># so loop continues, adding value</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>                    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;    Adding additional reg_val:&#39;</span><span class="p">,</span> <span class="n">reg_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  </span><span class="si">%s</span><span class="s2">-</span><span class="si">%d</span><span class="s2">: </span><span class="si">%9.6f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">rr</span><span class="p">,</span> <span class="n">LL</span><span class="p">))</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>        <span class="n">rr</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>    <span class="c1">#if thresh &lt; 1.0:</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>    <span class="c1">#    reg_select = model_selection( LLsR, thresh, verbose=verbose )</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>    <span class="c1">#else:</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>    <span class="n">reg_select</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">LLsR</span><span class="p">)</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>    <span class="n">reg_val</span> <span class="o">=</span> <span class="n">reg_vals</span><span class="p">[</span><span class="n">reg_select</span><span class="p">]</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>    <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Finished </span><span class="si">%s</span><span class="s2">: selected reg&quot;</span><span class="o">%</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">,</span> <span class="s2">&quot;(</span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="n">reg_select</span> <span class="p">)</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>    <span class="n">model_select</span> <span class="o">=</span> <span class="n">Rmods</span><span class="p">[</span><span class="n">reg_select</span><span class="p">]</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>    <span class="n">export_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>        <span class="s1">&#39;Rmods&#39;</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">Rmods</span><span class="p">),</span> <span class="s1">&#39;LLsR&#39;</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">LLsR</span><span class="p">),</span> <span class="s2">&quot;reg_vals&quot;</span><span class="p">:</span> <span class="n">reg_vals</span><span class="p">,</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>        <span class="s1">&#39;LLcells&#39;</span><span class="p">:</span> <span class="n">LLcells</span><span class="p">}</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>    <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">model_select</span><span class="p">),</span> <span class="n">reg_val</span><span class="p">,</span> <span class="n">export_dict</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a><span class="c1"># END bmodel_regpath()    </span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a><span class="k">def</span> <span class="nf">sico_ffnetworks</span><span class="p">(</span> 
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>        <span class="n">num_mfilters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_clones</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">numBE</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">numBI</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># must enter</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>        <span class="n">monoc_width</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">binoc_width</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">num_tkerns</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">NX</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">pos_constraint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># default values</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>        <span class="n">XregM</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">CregM</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">MregB</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">LOCregR</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>  <span class="c1"># regularization</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>    <span class="kn">from</span> <span class="nn">NDNT.modules.layers</span> <span class="kn">import</span> <span class="n">BiConvLayer1D</span><span class="p">,</span> <span class="n">NDNLayer</span><span class="p">,</span> <span class="n">ConvLayer</span><span class="p">,</span> <span class="n">MaskLayer</span><span class="p">,</span> <span class="n">ChannelLayer</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>    <span class="kn">from</span> <span class="nn">NDNT.networks</span> <span class="kn">import</span> <span class="n">FFnetwork</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>    <span class="n">monoc_basis_par</span> <span class="o">=</span> <span class="n">BiConvLayer1D</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span> 
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>        <span class="n">input_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">NX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_tkerns</span><span class="p">],</span> <span class="n">num_filters</span><span class="o">=</span><span class="n">num_mfilters</span><span class="p">,</span> 
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>        <span class="n">filter_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">monoc_width</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_tkerns</span><span class="p">],</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>        <span class="n">norm_type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initialize_center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;lin&#39;</span><span class="p">,</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>        <span class="c1">#output_norm=&#39;batch&#39;, window=&#39;hamming&#39;, </span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>        <span class="n">reg_vals</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;d2x&#39;</span><span class="p">:</span><span class="n">XregM</span><span class="p">,</span> <span class="s1">&#39;center&#39;</span><span class="p">:</span><span class="n">CregM</span> <span class="p">})</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>        <span class="c1">#reg_vals={&#39;d2x&#39;:XregM, &#39;d2t&#39;:TregM, &#39;center&#39;:CregM })</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>    <span class="n">bfilt_par</span> <span class="o">=</span> <span class="n">ConvLayer</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span> 
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>        <span class="n">num_filters</span><span class="o">=</span><span class="p">(</span><span class="n">numBE</span><span class="o">+</span><span class="n">numBI</span><span class="p">),</span> <span class="n">num_inh</span><span class="o">=</span><span class="n">numBI</span><span class="p">,</span> <span class="n">filter_dims</span><span class="o">=</span><span class="n">binoc_width</span><span class="p">,</span> 
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>        <span class="n">norm_type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pos_constraint</span><span class="o">=</span><span class="n">pos_constraint</span><span class="p">,</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>        <span class="n">window</span><span class="o">=</span><span class="s1">&#39;hamming&#39;</span><span class="p">,</span> <span class="c1">#output_norm=&#39;batch&#39;, #padding=&#39;valid&#39;,</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>        <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initialize_center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>        <span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">reg_vals</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;max_space&#39;</span><span class="p">:</span><span class="n">MregB</span><span class="p">})</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>        <span class="n">readout_par</span> <span class="o">=</span> <span class="n">NDNLayer</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>            <span class="n">num_filters</span><span class="o">=</span><span class="n">num_clones</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initialize_center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pos_constraint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>            <span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;lin&#39;</span><span class="p">,</span> <span class="n">reg_vals</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;glocalx&#39;</span><span class="p">:</span> <span class="n">LOCregR</span><span class="p">})</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>        <span class="n">readout_par</span> <span class="o">=</span> <span class="n">MaskLayer</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>            <span class="n">num_filters</span><span class="o">=</span><span class="n">num_clones</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initialize_center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pos_constraint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>            <span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;lin&#39;</span><span class="p">,</span> <span class="n">reg_vals</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;glocalx&#39;</span><span class="p">:</span> <span class="n">LOCregR</span><span class="p">})</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>    <span class="k">if</span> <span class="n">num_clones</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>        <span class="n">comb_layer</span> <span class="o">=</span> <span class="n">ChannelLayer</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span><span class="n">num_filters</span><span class="o">=</span><span class="n">num_clones</span><span class="p">,</span> <span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;softplus&#39;</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>    <span class="k">else</span><span class="p">:</span> 
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>        <span class="n">comb_layer</span> <span class="o">=</span> <span class="n">NDNLayer</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span><span class="n">num_filters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;softplus&#39;</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>    <span class="n">comb_layer</span><span class="p">[</span><span class="s1">&#39;weights_initializer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ones&#39;</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>    <span class="n">stim_net</span> <span class="o">=</span> <span class="n">FFnetwork</span><span class="o">.</span><span class="n">ffnet_dict</span><span class="p">(</span> <span class="n">xstim_n</span><span class="o">=</span><span class="s1">&#39;stim&#39;</span><span class="p">,</span> <span class="n">layer_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">monoc_basis_par</span><span class="p">,</span> <span class="n">bfilt_par</span><span class="p">,</span> <span class="n">readout_par</span><span class="p">])</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>    <span class="n">net_comb</span> <span class="o">=</span> <span class="n">FFnetwork</span><span class="o">.</span><span class="n">ffnet_dict</span><span class="p">(</span> <span class="n">xstim_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ffnet_n</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">layer_list</span><span class="o">=</span><span class="p">[</span><span class="n">comb_layer</span><span class="p">],</span> <span class="n">ffnet_type</span><span class="o">=</span><span class="s1">&#39;add&#39;</span><span class="p">)</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>    <span class="k">return</span> <span class="n">stim_net</span><span class="p">,</span> <span class="n">net_comb</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a><span class="k">def</span> <span class="nf">clone_path_prepare_data</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">TB</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">clone_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_clones</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_performance</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>                            <span class="n">dirname</span><span class="o">=</span><span class="p">[],</span> <span class="n">datadir</span><span class="o">=</span><span class="p">[],</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a><span class="sd">    Load dataset and clone model from respective directories for regularization</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a><span class="sd">    So also translates models into </span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a><span class="sd">    Uses already-defined datadir and dirname respectively</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a><span class="sd">    </span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a><span class="sd">    Args:</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a><span class="sd">        ee: expt number starting with zero</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a><span class="sd">        cc: cell number starting with zero</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a><span class="sd">        TB: temporal bases used to fit clones</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a><span class="sd">        </span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a><span class="sd">    Returns:</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a><span class="sd">        data_clone: dataset made to fit clone models</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a><span class="sd">        data1: dataset made to fit single copy of cell</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a><span class="sd">        clone_path_info: dictionary with the following info (if applicable)</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a><span class="sd">            LLnull: null model LL computed by fitting drift model</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a><span class="sd">            drift_terms: drift terms for number of clones specified</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a><span class="sd">            base_model: base clone model with spatiotemporal filters and nlags, if included</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a><span class="sd">            LLs: null-adjusted LLs of clone model, if included</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>    <span class="kn">import</span> <span class="nn">torch</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>    <span class="kn">from</span> <span class="nn">NTdatasets.generic</span> <span class="kn">import</span> <span class="n">GenericDataset</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>    <span class="kn">from</span> <span class="nn">NTdatasets.cumming.binocular</span> <span class="kn">import</span> <span class="n">binocular_single</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>    <span class="kn">from</span> <span class="nn">NDNT.modules.layers.ndnlayer</span> <span class="kn">import</span> <span class="n">NDNLayer</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>    
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>    <span class="n">Dreg</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>    <span class="k">if</span> <span class="n">clone_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>        <span class="k">if</span> <span class="n">num_clones</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># then assume its a file loading</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;E</span><span class="si">%s</span><span class="s2">c</span><span class="si">%s</span><span class="s2">clones.ndn&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">filename_num2str</span><span class="p">(</span><span class="n">ee</span><span class="p">),</span> <span class="n">utils</span><span class="o">.</span><span class="n">filename_num2str</span><span class="p">(</span><span class="n">cc</span><span class="p">))</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>            <span class="n">base_model</span> <span class="o">=</span> <span class="n">NDN</span><span class="o">.</span><span class="n">load_model_zip</span><span class="p">(</span><span class="n">dirname</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>            <span class="n">base_model</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">mask_is_set</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>            <span class="n">base_model</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>            <span class="n">NX</span> <span class="o">=</span> <span class="mi">36</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>        <span class="n">base_model</span> <span class="o">=</span> <span class="n">clone_model</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>    <span class="k">if</span> <span class="n">base_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>        <span class="n">num_clones</span> <span class="o">=</span> <span class="n">base_model</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">output_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>        <span class="n">NX</span> <span class="o">=</span> <span class="n">base_model</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>        
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>    <span class="n">old_nlags</span><span class="p">,</span> <span class="n">num_tk</span> <span class="o">=</span> <span class="n">TB</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>    <span class="c1"># Make datasets</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>    <span class="n">data_clone</span> <span class="o">=</span> <span class="n">binocular_single</span><span class="p">(</span> <span class="n">expt_num</span><span class="o">=</span><span class="n">ee</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">datadir</span><span class="o">=</span><span class="n">datadir</span><span class="p">,</span> <span class="n">time_embed</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">skip_lags</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">old_nlags</span> <span class="p">)</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>    <span class="k">if</span> <span class="n">nlags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>        <span class="n">data1</span> <span class="o">=</span> <span class="n">binocular_single</span><span class="p">(</span> <span class="n">expt_num</span><span class="o">=</span><span class="n">ee</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">datadir</span><span class="o">=</span><span class="n">datadir</span><span class="p">,</span> <span class="n">time_embed</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">skip_lags</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">nlags</span> <span class="p">)</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>        <span class="n">data1</span> <span class="o">=</span> <span class="n">binocular_single</span><span class="p">(</span> <span class="n">expt_num</span><span class="o">=</span><span class="n">ee</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">datadir</span><span class="o">=</span><span class="n">datadir</span><span class="p">,</span> <span class="n">time_embed</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">skip_lags</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">old_nlags</span> <span class="p">)</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>        
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>    <span class="n">robs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">data1</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>    <span class="n">dfs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">data1</span><span class="o">.</span><span class="n">dfs</span><span class="p">)</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>    <span class="n">data_clone</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">robs</span><span class="p">[:,[</span><span class="n">cc</span><span class="p">]]),</span> <span class="n">num_clones</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>    <span class="n">data_clone</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dfs</span><span class="p">[:,[</span><span class="n">cc</span><span class="p">]]),</span> <span class="n">num_clones</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>    <span class="n">data1</span><span class="o">.</span><span class="n">set_cells</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>    <span class="c1"># Add drift capacities and calc drift model</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>    <span class="n">block_length</span> <span class="o">=</span> <span class="mi">3600</span>  <span class="c1"># 60 sec</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>    <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">data_clone</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">block_length</span><span class="p">)</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>    <span class="n">drift_tents</span> <span class="o">=</span> <span class="n">data_clone</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>        <span class="n">data_clone</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zero_right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>    <span class="n">data_clone</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">drift_tents</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>    <span class="n">data1</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">drift_tents</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>    <span class="n">NA</span> <span class="o">=</span> <span class="n">drift_tents</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>    <span class="c1"># Make tent-basis stim for clone model LL extraction (with-tent-basis thing)</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">base_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">nlags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>        <span class="n">Xstim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bxt,tf-&gt;bxf&#39;</span><span class="p">,</span> 
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>                             <span class="n">data_clone</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">NX</span><span class="p">,</span><span class="n">old_nlags</span><span class="p">]),</span> 
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>                             <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">TB</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>        <span class="n">data_clone</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">Xstim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">data_clone</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>        <span class="n">data_clone</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_tk</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>    <span class="c1"># Calculate LLs because why-not: need it but dont need drift models after that</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>    <span class="n">train_ds</span> <span class="o">=</span> <span class="n">GenericDataset</span><span class="p">(</span><span class="n">data_clone</span><span class="p">[</span><span class="n">data_clone</span><span class="o">.</span><span class="n">train_inds</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>    <span class="n">drift_pars1N</span> <span class="o">=</span> <span class="n">NDNLayer</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span> 
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>        <span class="n">input_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">NA</span><span class="p">],</span> <span class="n">num_filters</span><span class="o">=</span><span class="n">num_clones</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>        <span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;softplus&#39;</span><span class="p">,</span> <span class="n">reg_vals</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;d2t&#39;</span><span class="p">:</span> <span class="n">Dreg</span><span class="p">,</span> <span class="s1">&#39;bcs&#39;</span><span class="p">:{</span><span class="s1">&#39;d2t&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>    <span class="n">drift_mod</span> <span class="o">=</span> <span class="n">NDN</span><span class="p">(</span><span class="n">layer_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">drift_pars1N</span><span class="p">],</span> <span class="n">loss_type</span><span class="o">=</span><span class="s1">&#39;poisson&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>    <span class="n">drift_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xstim_n</span> <span class="o">=</span> <span class="s1">&#39;Xdrift&#39;</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>    <span class="n">utils</span><span class="o">.</span><span class="n">fit_lbfgs</span><span class="p">(</span> <span class="n">drift_mod</span><span class="p">,</span> <span class="n">train_ds</span><span class="p">[:],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>    <span class="n">drift_mod</span> <span class="o">=</span> <span class="n">drift_mod</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>    <span class="n">LLnull</span> <span class="o">=</span> <span class="n">drift_mod</span><span class="o">.</span><span class="n">eval_models</span><span class="p">(</span><span class="n">data_clone</span><span class="p">[</span><span class="n">data1</span><span class="o">.</span><span class="n">val_indsA</span><span class="p">],</span> <span class="n">null_adjusted</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  c</span><span class="si">%d</span><span class="s1">: LLnull = </span><span class="si">%0.6f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">LLnull</span><span class="p">))</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>    <span class="n">drift_terms</span> <span class="o">=</span> <span class="n">drift_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>    <span class="n">clone_path_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;drift_terms&#39;</span><span class="p">:</span> <span class="n">drift_terms</span><span class="p">,</span> <span class="s1">&#39;LLnull&#39;</span><span class="p">:</span> <span class="n">LLnull</span><span class="p">,</span> <span class="s1">&#39;num_lags&#39;</span><span class="p">:</span> <span class="n">nlags</span><span class="p">}</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>    <span class="k">if</span> <span class="n">base_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>        <span class="c1"># Calculate LLs of original model before converting </span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>        <span class="n">LLs0</span> <span class="o">=</span> <span class="n">LLnull</span><span class="o">-</span><span class="n">base_model</span><span class="o">.</span><span class="n">eval_models</span><span class="p">(</span><span class="n">data_clone</span><span class="p">[</span><span class="n">data1</span><span class="o">.</span><span class="n">val_indsA</span><span class="p">],</span> <span class="n">null_adjusted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  LLs0 original clone mean:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">LLs0</span><span class="p">))</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>        <span class="k">del</span> <span class="n">train_ds</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>    
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>        
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>        <span class="k">if</span> <span class="n">check_performance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>            <span class="n">_</span> <span class="o">=</span> <span class="n">bmp_check</span><span class="p">(</span> <span class="n">base_model</span><span class="p">,</span> <span class="n">data_clone</span><span class="p">,</span> <span class="n">LLs0</span><span class="p">,</span> <span class="n">check_performance</span> <span class="p">)</span> 
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>        
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>        <span class="c1"># Convert dataset back to handle spatiotemporal</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>        <span class="k">if</span> <span class="n">nlags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>            <span class="n">data_clone</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">data1</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>            <span class="n">data_clone</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlags</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>            <span class="n">base_model</span> <span class="o">=</span> <span class="n">convert2ST</span><span class="p">(</span> <span class="n">base_model</span><span class="p">,</span> <span class="n">TB</span><span class="p">,</span> <span class="n">nlags</span> <span class="p">)</span>  <span class="c1"># note this will not be normalized correctly</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>        <span class="n">clone_path_info</span><span class="p">[</span><span class="s1">&#39;base_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_model</span> 
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>        <span class="n">clone_path_info</span><span class="p">[</span><span class="s1">&#39;LLs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LLs0</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>    
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>    <span class="k">return</span> <span class="n">data_clone</span><span class="p">,</span> <span class="n">data1</span><span class="p">,</span> <span class="n">clone_path_info</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a><span class="k">def</span> <span class="nf">spatiotemporal_box_std</span><span class="p">(</span> <span class="n">filts</span><span class="p">,</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">filt_ns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">display_cc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subplot_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>    <span class="n">nx</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">nf</span> <span class="o">=</span> <span class="n">filts</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>    <span class="k">if</span> <span class="n">filt_ns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>        <span class="n">filt_ns</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">nf</span><span class="p">)</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>    <span class="n">ks</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">filts</span><span class="p">[:,:,</span><span class="n">filt_ns</span><span class="p">])</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ks</span><span class="p">))</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>    <span class="n">tlags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nt</span><span class="o">-</span><span class="n">t_edge</span><span class="p">,</span> <span class="n">nt</span><span class="p">)</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>    <span class="c1">#print(tlags)</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>    <span class="n">box1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x_edge</span><span class="p">)</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>    <span class="n">box2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="n">x_edge</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>    <span class="c1">#print(box1,box2)</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>    <span class="n">stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ks</span><span class="p">[:,</span><span class="n">tlags</span><span class="p">,:][</span><span class="n">box1</span><span class="p">,:,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ks</span><span class="p">[:,</span><span class="n">tlags</span><span class="p">,:][</span><span class="n">box2</span><span class="p">,:,:])])</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>    <span class="c1">#print(stds,m)</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>    <span class="k">if</span> <span class="n">to_plot</span><span class="p">:</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>        <span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">patches</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>        <span class="k">if</span> <span class="n">display_cc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>            <span class="n">utils</span><span class="o">.</span><span class="n">ss</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filt_ns</span><span class="p">)):</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>                <span class="n">utils</span><span class="o">.</span><span class="n">imagesc</span><span class="p">(</span><span class="n">ks</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ii</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>                    <span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">tlags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">))</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>                    <span class="p">(</span><span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">tlags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">))</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>    <span class="k">return</span> <span class="n">stds</span><span class="o">/</span><span class="n">m</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a><span class="k">def</span> <span class="nf">spatiotemporal_std_display</span><span class="p">(</span> <span class="n">filt2d</span><span class="p">,</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">ax_handle</span><span class="p">,</span> <span class="n">display_norm</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>    <span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">patches</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>    <span class="k">if</span> <span class="n">display_norm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>        <span class="n">display_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">filt2d</span><span class="p">))</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>    <span class="n">nx</span><span class="p">,</span><span class="n">nt</span> <span class="o">=</span> <span class="n">filt2d</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>    <span class="n">tlags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nt</span><span class="o">-</span><span class="n">t_edge</span><span class="p">,</span> <span class="n">nt</span><span class="p">)</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>    <span class="n">box1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x_edge</span><span class="p">)</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>    <span class="n">box2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="n">x_edge</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>    <span class="n">utils</span><span class="o">.</span><span class="n">imagesc</span><span class="p">(</span><span class="n">filt2d</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">display_norm</span><span class="p">)</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>    <span class="n">ax_handle</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>        <span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">tlags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">))</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>    <span class="n">ax_handle</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>        <span class="p">(</span><span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">tlags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">))</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a><span class="k">def</span> <span class="nf">smoothness_select</span><span class="p">(</span> <span class="n">reg_info</span><span class="p">,</span> <span class="n">t_edge</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">x_edge</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">display_n</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a><span class="sd">    Selects best smoothness based on where transition occurs rather than maximizing LL </span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a><span class="sd">    &quot;&quot;&quot;</span>        
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>    <span class="n">num_regs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_info</span><span class="p">[</span><span class="s1">&#39;LLsR&#39;</span><span class="p">])</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>    <span class="n">stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_regs</span><span class="p">)</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>    <span class="n">ws</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_regs</span><span class="p">):</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>        <span class="n">ws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_info</span><span class="p">[</span><span class="s1">&#39;Rmods&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">get_weights</span><span class="p">())</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>        <span class="n">stds</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">spatiotemporal_box_std</span><span class="p">(</span><span class="n">ws</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">to_plot</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span> 
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>    <span class="n">thresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="n">stds</span><span class="p">),</span><span class="nb">min</span><span class="p">(</span><span class="n">stds</span><span class="p">)])</span> 
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>    <span class="n">reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stds</span> <span class="o">&lt;</span> <span class="n">thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>    <span class="n">Xreg</span> <span class="o">=</span> <span class="n">reg_info</span><span class="p">[</span><span class="s1">&#39;reg_vals&#39;</span><span class="p">][</span><span class="n">reg</span><span class="p">]</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>    
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>    <span class="c1"># STATUS DISPLAY</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>    <span class="k">if</span> <span class="n">display_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>        <span class="n">NF</span> <span class="o">=</span> <span class="n">ws</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>        <span class="n">utils</span><span class="o">.</span><span class="n">ss</span><span class="p">(</span><span class="n">NF</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">rh</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NF</span><span class="p">):</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">NF</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="n">ii</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>            <span class="n">spatiotemporal_std_display</span><span class="p">(</span> <span class="n">ws</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">display_n</span><span class="p">],</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">ax</span> <span class="p">)</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Lowest d2x-reg&#39;</span><span class="p">)</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">NF</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>            <span class="n">spatiotemporal_std_display</span><span class="p">(</span> <span class="n">ws</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">display_n</span><span class="p">],</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">ax</span> <span class="p">)</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Highest d2x-reg&#39;</span><span class="p">)</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">NF</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="o">+</span><span class="n">ii</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>            <span class="n">spatiotemporal_std_display</span><span class="p">(</span> <span class="n">ws</span><span class="p">[</span><span class="n">reg</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">display_n</span><span class="p">],</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">ax</span> <span class="p">)</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Chosen d2x-reg&#39;</span><span class="p">)</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>        <span class="n">utils</span><span class="o">.</span><span class="n">ss</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">rh</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>        <span class="n">spatiotemporal_std_display</span><span class="p">(</span> <span class="n">ws</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">display_n</span><span class="p">],</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">ax</span> <span class="p">)</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Lowest d2x-reg&#39;</span><span class="p">)</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>        <span class="n">spatiotemporal_std_display</span><span class="p">(</span> <span class="n">ws</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">display_n</span><span class="p">],</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">ax</span> <span class="p">)</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Highest d2x-reg&#39;</span><span class="p">)</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>        <span class="n">spatiotemporal_std_display</span><span class="p">(</span> <span class="n">ws</span><span class="p">[</span><span class="n">reg</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">display_n</span><span class="p">],</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">ax</span> <span class="p">)</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Chosen d2x-reg&#39;</span><span class="p">)</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>        <span class="n">NF</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">NF</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stds</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stds</span><span class="p">,</span><span class="s1">&#39;b.&#39;</span><span class="p">)</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span><span class="n">stds</span><span class="p">[</span><span class="n">reg</span><span class="p">],</span><span class="s1">&#39;go&#39;</span><span class="p">)</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>    <span class="n">xs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">thresh</span><span class="p">,</span><span class="s1">&#39;r--&#39;</span><span class="p">)</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Box stdevs&#39;</span><span class="p">)</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">NF</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">reg_info</span><span class="p">[</span><span class="s1">&#39;LLsR&#39;</span><span class="p">],</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">reg_info</span><span class="p">[</span><span class="s1">&#39;LLsR&#39;</span><span class="p">],</span><span class="s1">&#39;b.&#39;</span><span class="p">)</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">reg_info</span><span class="p">[</span><span class="s1">&#39;LLsR&#39;</span><span class="p">][</span><span class="n">reg</span><span class="p">],</span><span class="s1">&#39;go&#39;</span><span class="p">)</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;LLs&#39;</span><span class="p">)</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>    <span class="n">xs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;d2xt reg:&#39;</span><span class="p">,</span> <span class="n">Xreg</span><span class="p">)</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a>    <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">reg_info</span><span class="p">[</span><span class="s1">&#39;Rmods&#39;</span><span class="p">][</span><span class="n">reg</span><span class="p">])</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a><span class="k">def</span> <span class="nf">binocular_filter_shift</span><span class="p">(</span> <span class="n">sico0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>    <span class="kn">import</span> <span class="nn">torch</span>    
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>    <span class="n">wB</span> <span class="o">=</span> <span class="n">sico0</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(</span><span class="n">layer_target</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>    <span class="n">ni</span><span class="p">,</span> <span class="n">fw</span><span class="p">,</span> <span class="n">NBF</span> <span class="o">=</span> <span class="n">wB</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>    <span class="n">Nout</span> <span class="o">=</span> <span class="n">sico0</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>    <span class="c1">#clrs=&#39;bgr&#39;</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>    <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NBF</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="c1">#[0,0,0]</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NBF</span><span class="p">):</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">wB</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ii</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>        <span class="n">shifts</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">fw</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dist</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dist</span><span class="p">)))</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Binocular shifts:&#39;</span><span class="p">,</span> <span class="n">shifts</span><span class="p">)</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>    
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>    <span class="c1"># Move the torch-weights</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>    <span class="n">wB</span> <span class="o">=</span> <span class="n">sico0</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">ni</span><span class="p">,</span> <span class="n">fw</span><span class="p">,</span> <span class="n">NBF</span><span class="p">])</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>    <span class="n">wB2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">wB</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NBF</span><span class="p">):</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>        <span class="n">wB2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">wB</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="n">shifts</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>    <span class="n">wR</span> <span class="o">=</span> <span class="n">sico0</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NBF</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nout</span><span class="p">])</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>    <span class="n">wR2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">wR</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NBF</span><span class="p">):</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>        <span class="n">wR2</span><span class="p">[</span><span class="n">ii</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">wR</span><span class="p">[</span><span class="n">ii</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">clone</span><span class="p">()),</span> <span class="o">-</span><span class="n">shifts</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>        
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>    <span class="n">sico1</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sico0</span><span class="p">)</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>    <span class="n">sico1</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">wB2</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">NBF</span><span class="p">])</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>    <span class="n">sico1</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">wR2</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">Nout</span><span class="p">])</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>    <span class="k">return</span> <span class="n">sico1</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a><span class="c1"># END binocular_filter_shift()</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a><span class="k">def</span> <span class="nf">monocular_filter_shift</span><span class="p">(</span> <span class="n">sico0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a><span class="sd">    Shifts the filters in the monocular layer, and adjusts the filters in the binocular layer as a result.</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>    <span class="kn">import</span> <span class="nn">torch</span>    
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>    <span class="n">wM</span> <span class="o">=</span> <span class="n">sico0</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(</span><span class="n">layer_target</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>    <span class="n">fw</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">NMF</span> <span class="o">=</span> <span class="n">wM</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>    <span class="n">Nout</span> <span class="o">=</span> <span class="n">sico0</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>    <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NMF</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="c1">#[0,0,0]</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NMF</span><span class="p">):</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">wM</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ii</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>        <span class="n">shifts</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">fw</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dist</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dist</span><span class="p">)))</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Monocular shifts:&#39;</span><span class="p">,</span> <span class="n">shifts</span><span class="p">)</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>    
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>    <span class="c1"># Move the torch-weights</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>    <span class="n">wM</span> <span class="o">=</span> <span class="n">sico0</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">fw</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">NMF</span><span class="p">])</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>    <span class="n">wM2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">wM</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NMF</span><span class="p">):</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>        <span class="n">wM2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">wM</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="n">shifts</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>    <span class="n">wB</span> <span class="o">=</span> <span class="n">sico0</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NMF</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nout</span><span class="p">])</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>    <span class="n">wB2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">wB</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NMF</span><span class="p">):</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>        <span class="n">wB2</span><span class="p">[</span><span class="n">ii</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">wB</span><span class="p">[</span><span class="n">ii</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">clone</span><span class="p">()),</span> <span class="o">-</span><span class="n">shifts</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>        
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>    <span class="n">sico1</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sico0</span><span class="p">)</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>    <span class="n">sico1</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">wM2</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">NMF</span><span class="p">])</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>    <span class="n">sico1</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">wB2</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nout</span><span class="p">])</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>    <span class="k">return</span> <span class="n">sico1</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a><span class="c1"># END monocular_filter_shift()</span>
</span></pre></div>


            </section>
                <section id="varDF">
                            <input id="varDF-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">varDF</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span>, </span><span class="param"><span class="n">df</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">mean_adj</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="varDF-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#varDF"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="varDF-11"><a href="#varDF-11"><span class="linenos">11</span></a><span class="k">def</span> <span class="nf">varDF</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mean_adj</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="varDF-12"><a href="#varDF-12"><span class="linenos">12</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="varDF-13"><a href="#varDF-13"><span class="linenos">13</span></a><span class="sd">    Calculates variance over valid data. </span>
</span><span id="varDF-14"><a href="#varDF-14"><span class="linenos">14</span></a><span class="sd">    mean_adj means true variance, but take away and becomes average squared deviation.</span>
</span><span id="varDF-15"><a href="#varDF-15"><span class="linenos">15</span></a><span class="sd">    </span>
</span><span id="varDF-16"><a href="#varDF-16"><span class="linenos">16</span></a><span class="sd">    Args:</span>
</span><span id="varDF-17"><a href="#varDF-17"><span class="linenos">17</span></a><span class="sd">        s: signal to calculate variance over</span>
</span><span id="varDF-18"><a href="#varDF-18"><span class="linenos">18</span></a><span class="sd">        df: data filter (if None, will use all data)</span>
</span><span id="varDF-19"><a href="#varDF-19"><span class="linenos">19</span></a><span class="sd">        mean_adj: whether to subtract mean before squaring</span>
</span><span id="varDF-20"><a href="#varDF-20"><span class="linenos">20</span></a>
</span><span id="varDF-21"><a href="#varDF-21"><span class="linenos">21</span></a><span class="sd">    Returns:</span>
</span><span id="varDF-22"><a href="#varDF-22"><span class="linenos">22</span></a><span class="sd">        variance of signal</span>
</span><span id="varDF-23"><a href="#varDF-23"><span class="linenos">23</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="varDF-24"><a href="#varDF-24"><span class="linenos">24</span></a>
</span><span id="varDF-25"><a href="#varDF-25"><span class="linenos">25</span></a>    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="varDF-26"><a href="#varDF-26"><span class="linenos">26</span></a>    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="varDF-27"><a href="#varDF-27"><span class="linenos">27</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="varDF-28"><a href="#varDF-28"><span class="linenos">28</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="varDF-29"><a href="#varDF-29"><span class="linenos">29</span></a>    <span class="n">nrm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="varDF-30"><a href="#varDF-30"><span class="linenos">30</span></a>    <span class="k">assert</span> <span class="n">nrm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;df: no valid data&quot;</span>
</span><span id="varDF-31"><a href="#varDF-31"><span class="linenos">31</span></a>
</span><span id="varDF-32"><a href="#varDF-32"><span class="linenos">32</span></a>    <span class="k">if</span> <span class="n">mean_adj</span><span class="p">:</span>
</span><span id="varDF-33"><a href="#varDF-33"><span class="linenos">33</span></a>        <span class="n">sbar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df</span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="o">/</span><span class="n">nrm</span>
</span><span id="varDF-34"><a href="#varDF-34"><span class="linenos">34</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="varDF-35"><a href="#varDF-35"><span class="linenos">35</span></a>        <span class="n">sbar</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="varDF-36"><a href="#varDF-36"><span class="linenos">36</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="n">sbar</span><span class="p">)</span><span class="o">*</span><span class="n">df</span><span class="p">)</span><span class="o">/</span><span class="n">nrm</span>
</span></pre></div>


            <div class="docstring"><p>Calculates variance over valid data. 
mean_adj means true variance, but take away and becomes average squared deviation.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>s:</strong>  signal to calculate variance over</li>
<li><strong>df:</strong>  data filter (if None, will use all data)</li>
<li><strong>mean_adj:</strong>  whether to subtract mean before squaring</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>variance of signal</p>
</blockquote>
</div>


                </section>
                <section id="explainable_variance">
                            <input id="explainable_variance-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">explainable_variance</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">Edata</span>, </span><span class="param"><span class="n">cell_n</span>, </span><span class="param"><span class="n">fr1or3</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">inds</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="explainable_variance-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#explainable_variance"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="explainable_variance-39"><a href="#explainable_variance-39"><span class="linenos">39</span></a><span class="k">def</span> <span class="nf">explainable_variance</span><span class="p">(</span> <span class="n">Edata</span><span class="p">,</span> <span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="explainable_variance-40"><a href="#explainable_variance-40"><span class="linenos">40</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="explainable_variance-41"><a href="#explainable_variance-41"><span class="linenos">41</span></a><span class="sd">    Explainable variance calculation: binocular-specific because of the data structures</span>
</span><span id="explainable_variance-42"><a href="#explainable_variance-42"><span class="linenos">42</span></a><span class="sd">    </span>
</span><span id="explainable_variance-43"><a href="#explainable_variance-43"><span class="linenos">43</span></a><span class="sd">    Args:</span>
</span><span id="explainable_variance-44"><a href="#explainable_variance-44"><span class="linenos">44</span></a><span class="sd">        Edata: binocular dataset (one experiment with a certain number of cells recorded)</span>
</span><span id="explainable_variance-45"><a href="#explainable_variance-45"><span class="linenos">45</span></a><span class="sd">        cell_n: cell number (in python numbering, i.e. starting with 0)</span>
</span><span id="explainable_variance-46"><a href="#explainable_variance-46"><span class="linenos">46</span></a><span class="sd">        fr1or3: whether to use fr1==1, fr3==3, or both (leave as None) to calculate disparity. Should choose 1 or 3</span>
</span><span id="explainable_variance-47"><a href="#explainable_variance-47"><span class="linenos">47</span></a><span class="sd">        inds (def: None): indices to calculate variances over, if None will use all inds</span>
</span><span id="explainable_variance-48"><a href="#explainable_variance-48"><span class="linenos">48</span></a><span class="sd">            generally will pass in the fr3 indices, for example</span>
</span><span id="explainable_variance-49"><a href="#explainable_variance-49"><span class="linenos">49</span></a><span class="sd">        verbose (def: True): self-explanatory</span>
</span><span id="explainable_variance-50"><a href="#explainable_variance-50"><span class="linenos">50</span></a><span class="sd">    </span>
</span><span id="explainable_variance-51"><a href="#explainable_variance-51"><span class="linenos">51</span></a><span class="sd">    Returns:</span>
</span><span id="explainable_variance-52"><a href="#explainable_variance-52"><span class="linenos">52</span></a><span class="sd">        totvar: literally the variance of the binned spike counts (resp) -- will be dom by spike stoch.</span>
</span><span id="explainable_variance-53"><a href="#explainable_variance-53"><span class="linenos">53</span></a><span class="sd">        explvar: explainable variance: repeatable variance (small fraction of totvar)</span>
</span><span id="explainable_variance-54"><a href="#explainable_variance-54"><span class="linenos">54</span></a>
</span><span id="explainable_variance-55"><a href="#explainable_variance-55"><span class="linenos">55</span></a><span class="sd">    Note: will return total variance (and a warning) if repeats not present in the dataset.&quot;&quot;&quot;</span>
</span><span id="explainable_variance-56"><a href="#explainable_variance-56"><span class="linenos">56</span></a>
</span><span id="explainable_variance-57"><a href="#explainable_variance-57"><span class="linenos">57</span></a>    <span class="k">assert</span> <span class="n">cell_n</span> <span class="o">&lt;</span> <span class="n">Edata</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="s2">&quot;cell_n is too large for this experiment (num cells = </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="n">Edata</span><span class="o">.</span><span class="n">NC</span>
</span><span id="explainable_variance-58"><a href="#explainable_variance-58"><span class="linenos">58</span></a>
</span><span id="explainable_variance-59"><a href="#explainable_variance-59"><span class="linenos">59</span></a>    <span class="n">resp</span> <span class="o">=</span> <span class="n">Edata</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="explainable_variance-60"><a href="#explainable_variance-60"><span class="linenos">60</span></a>    
</span><span id="explainable_variance-61"><a href="#explainable_variance-61"><span class="linenos">61</span></a>    <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="explainable_variance-62"><a href="#explainable_variance-62"><span class="linenos">62</span></a>        <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Edata</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="explainable_variance-63"><a href="#explainable_variance-63"><span class="linenos">63</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="explainable_variance-64"><a href="#explainable_variance-64"><span class="linenos">64</span></a>        <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span> <span class="n">inds</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Edata</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
</span><span id="explainable_variance-65"><a href="#explainable_variance-65"><span class="linenos">65</span></a>
</span><span id="explainable_variance-66"><a href="#explainable_variance-66"><span class="linenos">66</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">fr1or3</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fr1or3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="explainable_variance-67"><a href="#explainable_variance-67"><span class="linenos">67</span></a>        <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Edata</span><span class="o">.</span><span class="n">frs</span> <span class="o">==</span> <span class="n">fr1or3</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="explainable_variance-68"><a href="#explainable_variance-68"><span class="linenos">68</span></a>
</span><span id="explainable_variance-69"><a href="#explainable_variance-69"><span class="linenos">69</span></a>    <span class="k">if</span> <span class="n">Edata</span><span class="o">.</span><span class="n">rep_inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="explainable_variance-70"><a href="#explainable_variance-70"><span class="linenos">70</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="explainable_variance-71"><a href="#explainable_variance-71"><span class="linenos">71</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;No repeats in this dataset -- using total variance.&#39;</span><span class="p">)</span>
</span><span id="explainable_variance-72"><a href="#explainable_variance-72"><span class="linenos">72</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="n">inds</span><span class="p">])</span>
</span><span id="explainable_variance-73"><a href="#explainable_variance-73"><span class="linenos">73</span></a>            
</span><span id="explainable_variance-74"><a href="#explainable_variance-74"><span class="linenos">74</span></a>    <span class="n">rep1inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="n">Edata</span><span class="o">.</span><span class="n">rep_inds</span><span class="p">[</span><span class="n">cell_n</span><span class="p">][:,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="explainable_variance-75"><a href="#explainable_variance-75"><span class="linenos">75</span></a>    <span class="n">rep2inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="n">Edata</span><span class="o">.</span><span class="n">rep_inds</span><span class="p">[</span><span class="n">cell_n</span><span class="p">][:,</span><span class="mi">1</span><span class="p">])</span>
</span><span id="explainable_variance-76"><a href="#explainable_variance-76"><span class="linenos">76</span></a>    <span class="n">allreps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">rep1inds</span><span class="p">,</span> <span class="n">rep2inds</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="explainable_variance-77"><a href="#explainable_variance-77"><span class="linenos">77</span></a>
</span><span id="explainable_variance-78"><a href="#explainable_variance-78"><span class="linenos">78</span></a>    <span class="n">totvar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="n">allreps</span><span class="p">])</span>
</span><span id="explainable_variance-79"><a href="#explainable_variance-79"><span class="linenos">79</span></a>    <span class="n">explvar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="n">rep1inds</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="n">allreps</span><span class="p">]),</span> <span class="n">resp</span><span class="p">[</span><span class="n">rep2inds</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="n">allreps</span><span class="p">])))</span> 
</span><span id="explainable_variance-80"><a href="#explainable_variance-80"><span class="linenos">80</span></a>    
</span><span id="explainable_variance-81"><a href="#explainable_variance-81"><span class="linenos">81</span></a>    <span class="k">return</span> <span class="n">explvar</span><span class="p">,</span> <span class="n">totvar</span>
</span></pre></div>


            <div class="docstring"><p>Explainable variance calculation: binocular-specific because of the data structures</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>Edata:</strong>  binocular dataset (one experiment with a certain number of cells recorded)</li>
<li><strong>cell_n:</strong>  cell number (in python numbering, i.e. starting with 0)</li>
<li><strong>fr1or3:</strong>  whether to use fr1==1, fr3==3, or both (leave as None) to calculate disparity. Should choose 1 or 3</li>
<li><strong>inds (def:</strong>  None): indices to calculate variances over, if None will use all inds
generally will pass in the fr3 indices, for example</li>
<li><strong>verbose (def:</strong>  True): self-explanatory</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>totvar: literally the variance of the binned spike counts (resp) -- will be dom by spike stoch.
  explvar: explainable variance: repeatable variance (small fraction of totvar)</p>
</blockquote>

<p>Note: will return total variance (and a warning) if repeats not present in the dataset.</p>
</div>


                </section>
                <section id="predictive_power">
                            <input id="predictive_power-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">predictive_power</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">pred</span>, </span><span class="param"><span class="n">Edata</span>, </span><span class="param"><span class="n">cell_n</span>, </span><span class="param"><span class="n">inds</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="predictive_power-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#predictive_power"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="predictive_power-84"><a href="#predictive_power-84"><span class="linenos"> 84</span></a><span class="k">def</span> <span class="nf">predictive_power</span><span class="p">(</span> <span class="n">pred</span><span class="p">,</span> <span class="n">Edata</span><span class="p">,</span> <span class="n">cell_n</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="predictive_power-85"><a href="#predictive_power-85"><span class="linenos"> 85</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="predictive_power-86"><a href="#predictive_power-86"><span class="linenos"> 86</span></a><span class="sd">    Predictive power calculation (R2 adjusted by dividing by explainable (rather than total) variance</span>
</span><span id="predictive_power-87"><a href="#predictive_power-87"><span class="linenos"> 87</span></a><span class="sd">    (binocular-specific because of the data structures)</span>
</span><span id="predictive_power-88"><a href="#predictive_power-88"><span class="linenos"> 88</span></a><span class="sd">    </span>
</span><span id="predictive_power-89"><a href="#predictive_power-89"><span class="linenos"> 89</span></a><span class="sd">    Args:</span>
</span><span id="predictive_power-90"><a href="#predictive_power-90"><span class="linenos"> 90</span></a><span class="sd">        pred: model prediction: must have same size as robs (unindexed)</span>
</span><span id="predictive_power-91"><a href="#predictive_power-91"><span class="linenos"> 91</span></a><span class="sd">        Edata: binocular dataset (one experiment with a certain number of cells recorded)</span>
</span><span id="predictive_power-92"><a href="#predictive_power-92"><span class="linenos"> 92</span></a><span class="sd">        cell_n: cell number (in python numbering, i.e. starting with 0)</span>
</span><span id="predictive_power-93"><a href="#predictive_power-93"><span class="linenos"> 93</span></a><span class="sd">        inds (def: None): indices to calculate variances over, if None will use all inds</span>
</span><span id="predictive_power-94"><a href="#predictive_power-94"><span class="linenos"> 94</span></a><span class="sd">            BUT it should pass in XVinds generally, and for example could also focus on fr3</span>
</span><span id="predictive_power-95"><a href="#predictive_power-95"><span class="linenos"> 95</span></a><span class="sd">        verbose (def: True): self-explanatory</span>
</span><span id="predictive_power-96"><a href="#predictive_power-96"><span class="linenos"> 96</span></a><span class="sd">    </span>
</span><span id="predictive_power-97"><a href="#predictive_power-97"><span class="linenos"> 97</span></a><span class="sd">    Returns: </span>
</span><span id="predictive_power-98"><a href="#predictive_power-98"><span class="linenos"> 98</span></a><span class="sd">        predictive power of cell</span>
</span><span id="predictive_power-99"><a href="#predictive_power-99"><span class="linenos"> 99</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="predictive_power-100"><a href="#predictive_power-100"><span class="linenos">100</span></a>
</span><span id="predictive_power-101"><a href="#predictive_power-101"><span class="linenos">101</span></a>    <span class="k">assert</span> <span class="n">cell_n</span> <span class="o">&lt;</span> <span class="n">Edata</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span> <span class="s2">&quot;cell_n is too large for this experiment (num cells = </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="n">Edata</span><span class="o">.</span><span class="n">NC</span>
</span><span id="predictive_power-102"><a href="#predictive_power-102"><span class="linenos">102</span></a>    <span class="n">pred</span><span class="o">=</span><span class="n">pred</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="predictive_power-103"><a href="#predictive_power-103"><span class="linenos">103</span></a>
</span><span id="predictive_power-104"><a href="#predictive_power-104"><span class="linenos">104</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="predictive_power-105"><a href="#predictive_power-105"><span class="linenos">105</span></a>        <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="predictive_power-106"><a href="#predictive_power-106"><span class="linenos">106</span></a>
</span><span id="predictive_power-107"><a href="#predictive_power-107"><span class="linenos">107</span></a>    <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="predictive_power-108"><a href="#predictive_power-108"><span class="linenos">108</span></a>        <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Edata</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="predictive_power-109"><a href="#predictive_power-109"><span class="linenos">109</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="predictive_power-110"><a href="#predictive_power-110"><span class="linenos">110</span></a>        <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span> <span class="n">inds</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Edata</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
</span><span id="predictive_power-111"><a href="#predictive_power-111"><span class="linenos">111</span></a>
</span><span id="predictive_power-112"><a href="#predictive_power-112"><span class="linenos">112</span></a>    <span class="n">Robs</span> <span class="o">=</span> <span class="n">Edata</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="predictive_power-113"><a href="#predictive_power-113"><span class="linenos">113</span></a>    <span class="n">mod_indxs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span>
</span><span id="predictive_power-114"><a href="#predictive_power-114"><span class="linenos">114</span></a>    <span class="k">if</span> <span class="n">Edata</span><span class="o">.</span><span class="n">rep_inds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="predictive_power-115"><a href="#predictive_power-115"><span class="linenos">115</span></a>        <span class="n">rep1inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="n">Edata</span><span class="o">.</span><span class="n">rep_inds</span><span class="p">[</span><span class="n">cell_n</span><span class="p">][:,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="predictive_power-116"><a href="#predictive_power-116"><span class="linenos">116</span></a>        <span class="n">rep2inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="n">Edata</span><span class="o">.</span><span class="n">rep_inds</span><span class="p">[</span><span class="n">cell_n</span><span class="p">][:,</span><span class="mi">1</span><span class="p">])</span>
</span><span id="predictive_power-117"><a href="#predictive_power-117"><span class="linenos">117</span></a>        <span class="n">allreps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">rep1inds</span><span class="p">,</span> <span class="n">rep2inds</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="predictive_power-118"><a href="#predictive_power-118"><span class="linenos">118</span></a>        <span class="n">mod_indxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span> <span class="n">mod_indxs</span><span class="p">,</span> <span class="n">allreps</span> <span class="p">)</span>
</span><span id="predictive_power-119"><a href="#predictive_power-119"><span class="linenos">119</span></a>        <span class="n">r1a</span> <span class="o">=</span> <span class="n">Robs</span><span class="p">[</span><span class="n">rep1inds</span><span class="p">]</span>
</span><span id="predictive_power-120"><a href="#predictive_power-120"><span class="linenos">120</span></a>        <span class="n">r1b</span> <span class="o">=</span> <span class="n">Robs</span><span class="p">[</span><span class="n">rep2inds</span><span class="p">]</span>
</span><span id="predictive_power-121"><a href="#predictive_power-121"><span class="linenos">121</span></a>        <span class="n">r2</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">rep1inds</span><span class="p">]</span>  <span class="c1"># pred will be the same on both</span>
</span><span id="predictive_power-122"><a href="#predictive_power-122"><span class="linenos">122</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="predictive_power-123"><a href="#predictive_power-123"><span class="linenos">123</span></a>        <span class="n">r1a</span> <span class="o">=</span> <span class="n">Robs</span><span class="p">[</span><span class="n">mod_indxs</span><span class="p">]</span>
</span><span id="predictive_power-124"><a href="#predictive_power-124"><span class="linenos">124</span></a>        <span class="n">r1b</span> <span class="o">=</span> <span class="n">r1a</span>
</span><span id="predictive_power-125"><a href="#predictive_power-125"><span class="linenos">125</span></a>        <span class="n">r2</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">mod_indxs</span><span class="p">]</span>
</span><span id="predictive_power-126"><a href="#predictive_power-126"><span class="linenos">126</span></a>
</span><span id="predictive_power-127"><a href="#predictive_power-127"><span class="linenos">127</span></a>    <span class="c1"># Now assuming that r (Robs) is length of indxs, and pred is full res</span>
</span><span id="predictive_power-128"><a href="#predictive_power-128"><span class="linenos">128</span></a>    <span class="n">expl_var</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">explainable_variance</span><span class="p">(</span> <span class="n">Edata</span><span class="p">,</span> <span class="n">cell_n</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">mod_indxs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span> <span class="p">)</span>
</span><span id="predictive_power-129"><a href="#predictive_power-129"><span class="linenos">129</span></a>
</span><span id="predictive_power-130"><a href="#predictive_power-130"><span class="linenos">130</span></a>    <span class="c1"># explained_power = np.var(r1)-np.mean(np.square(r1-r2))  # WOW I THINK THIS IS WRONG -- WAS ORIGINAL FORMULA</span>
</span><span id="predictive_power-131"><a href="#predictive_power-131"><span class="linenos">131</span></a>    <span class="n">explained_power</span> <span class="o">=</span> <span class="n">expl_var</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">r1a</span><span class="o">-</span><span class="n">r2</span><span class="p">,</span> <span class="n">r1b</span><span class="o">-</span><span class="n">r2</span><span class="p">))</span>
</span><span id="predictive_power-132"><a href="#predictive_power-132"><span class="linenos">132</span></a>
</span><span id="predictive_power-133"><a href="#predictive_power-133"><span class="linenos">133</span></a>    <span class="c1"># calculate other way</span>
</span><span id="predictive_power-134"><a href="#predictive_power-134"><span class="linenos">134</span></a>    <span class="c1">#crosscorr = np.mean(np.multiply(r1-np.mean(r1), r2-np.mean(r2)))</span>
</span><span id="predictive_power-135"><a href="#predictive_power-135"><span class="linenos">135</span></a>    <span class="c1">#print( (crosscorr**2/expl_var/np.var(r2)) )</span>
</span><span id="predictive_power-136"><a href="#predictive_power-136"><span class="linenos">136</span></a>
</span><span id="predictive_power-137"><a href="#predictive_power-137"><span class="linenos">137</span></a>    <span class="k">return</span> <span class="n">explained_power</span><span class="o">/</span><span class="n">expl_var</span>
</span></pre></div>


            <div class="docstring"><p>Predictive power calculation (R2 adjusted by dividing by explainable (rather than total) variance
(binocular-specific because of the data structures)</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>pred:</strong>  model prediction: must have same size as robs (unindexed)</li>
<li><strong>Edata:</strong>  binocular dataset (one experiment with a certain number of cells recorded)</li>
<li><strong>cell_n:</strong>  cell number (in python numbering, i.e. starting with 0)</li>
<li><strong>inds (def:</strong>  None): indices to calculate variances over, if None will use all inds
BUT it should pass in XVinds generally, and for example could also focus on fr3</li>
<li><strong>verbose (def:</strong>  True): self-explanatory</li>
</ul>

<p>Returns: 
    predictive power of cell</p>
</div>


                </section>
                <section id="disparity_matrix">
                            <input id="disparity_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">disparity_matrix</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">dispt</span>, </span><span class="param"><span class="n">corrt</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="disparity_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#disparity_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="disparity_matrix-140"><a href="#disparity_matrix-140"><span class="linenos">140</span></a><span class="k">def</span> <span class="nf">disparity_matrix</span><span class="p">(</span> <span class="n">dispt</span><span class="p">,</span> <span class="n">corrt</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="disparity_matrix-141"><a href="#disparity_matrix-141"><span class="linenos">141</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="disparity_matrix-142"><a href="#disparity_matrix-142"><span class="linenos">142</span></a><span class="sd">    Create one-hot representation of disparities: NT x 2*ND+2 (ND = num disparities)</span>
</span><span id="disparity_matrix-143"><a href="#disparity_matrix-143"><span class="linenos">143</span></a><span class="sd">    -- Columns (0,ND-1):  correlated</span>
</span><span id="disparity_matrix-144"><a href="#disparity_matrix-144"><span class="linenos">144</span></a><span class="sd">    -- Columns (ND, 2*ND-1): anticorrelated</span>
</span><span id="disparity_matrix-145"><a href="#disparity_matrix-145"><span class="linenos">145</span></a><span class="sd">    -- Column -2: uncorrelated</span>
</span><span id="disparity_matrix-146"><a href="#disparity_matrix-146"><span class="linenos">146</span></a><span class="sd">    -- Column -1: blank</span>
</span><span id="disparity_matrix-147"><a href="#disparity_matrix-147"><span class="linenos">147</span></a>
</span><span id="disparity_matrix-148"><a href="#disparity_matrix-148"><span class="linenos">148</span></a><span class="sd">    Args:</span>
</span><span id="disparity_matrix-149"><a href="#disparity_matrix-149"><span class="linenos">149</span></a><span class="sd">        dispt: disparity values</span>
</span><span id="disparity_matrix-150"><a href="#disparity_matrix-150"><span class="linenos">150</span></a><span class="sd">        corrt: correlation values (if None, will not use)</span>
</span><span id="disparity_matrix-151"><a href="#disparity_matrix-151"><span class="linenos">151</span></a>
</span><span id="disparity_matrix-152"><a href="#disparity_matrix-152"><span class="linenos">152</span></a><span class="sd">    Returns:</span>
</span><span id="disparity_matrix-153"><a href="#disparity_matrix-153"><span class="linenos">153</span></a><span class="sd">        dmat: one-hot representation of disparities</span>
</span><span id="disparity_matrix-154"><a href="#disparity_matrix-154"><span class="linenos">154</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="disparity_matrix-155"><a href="#disparity_matrix-155"><span class="linenos">155</span></a>    <span class="n">dlist_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dispt</span><span class="p">)</span> 
</span><span id="disparity_matrix-156"><a href="#disparity_matrix-156"><span class="linenos">156</span></a>    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">dlist_raw</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
</span><span id="disparity_matrix-157"><a href="#disparity_matrix-157"><span class="linenos">157</span></a>        <span class="c1"># last two colums will be uncorrelated (-1005) and blank (-1009)</span>
</span><span id="disparity_matrix-158"><a href="#disparity_matrix-158"><span class="linenos">158</span></a>        <span class="n">dlist</span> <span class="o">=</span> <span class="n">dlist_raw</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>  <span class="c1"># this will exclude -1009 (blank) and -1005 (uncor)</span>
</span><span id="disparity_matrix-159"><a href="#disparity_matrix-159"><span class="linenos">159</span></a>        <span class="n">num_blanks</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="disparity_matrix-160"><a href="#disparity_matrix-160"><span class="linenos">160</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="disparity_matrix-161"><a href="#disparity_matrix-161"><span class="linenos">161</span></a>        <span class="n">dlist</span> <span class="o">=</span> <span class="n">dlist_raw</span>
</span><span id="disparity_matrix-162"><a href="#disparity_matrix-162"><span class="linenos">162</span></a>        <span class="n">num_blanks</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="disparity_matrix-163"><a href="#disparity_matrix-163"><span class="linenos">163</span></a>
</span><span id="disparity_matrix-164"><a href="#disparity_matrix-164"><span class="linenos">164</span></a>    <span class="n">ND</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dlist</span><span class="p">)</span>
</span><span id="disparity_matrix-165"><a href="#disparity_matrix-165"><span class="linenos">165</span></a>    <span class="k">if</span> <span class="n">corrt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="disparity_matrix-166"><a href="#disparity_matrix-166"><span class="linenos">166</span></a>        <span class="n">dmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dispt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ND</span><span class="o">+</span><span class="n">num_blanks</span><span class="p">])</span>
</span><span id="disparity_matrix-167"><a href="#disparity_matrix-167"><span class="linenos">167</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="disparity_matrix-168"><a href="#disparity_matrix-168"><span class="linenos">168</span></a>        <span class="n">dmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dispt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="n">ND</span><span class="o">+</span><span class="n">num_blanks</span><span class="p">])</span>
</span><span id="disparity_matrix-169"><a href="#disparity_matrix-169"><span class="linenos">169</span></a>
</span><span id="disparity_matrix-170"><a href="#disparity_matrix-170"><span class="linenos">170</span></a>    <span class="k">if</span> <span class="n">num_blanks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="disparity_matrix-171"><a href="#disparity_matrix-171"><span class="linenos">171</span></a>        <span class="n">dmat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dispt</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1009</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="disparity_matrix-172"><a href="#disparity_matrix-172"><span class="linenos">172</span></a>        <span class="n">dmat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dispt</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1005</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="disparity_matrix-173"><a href="#disparity_matrix-173"><span class="linenos">173</span></a>
</span><span id="disparity_matrix-174"><a href="#disparity_matrix-174"><span class="linenos">174</span></a>    <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dlist</span><span class="p">)):</span>
</span><span id="disparity_matrix-175"><a href="#disparity_matrix-175"><span class="linenos">175</span></a>        <span class="k">if</span> <span class="n">corrt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="disparity_matrix-176"><a href="#disparity_matrix-176"><span class="linenos">176</span></a>            <span class="n">dmat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dispt</span> <span class="o">==</span> <span class="n">dlist</span><span class="p">[</span><span class="n">dd</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dd</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="disparity_matrix-177"><a href="#disparity_matrix-177"><span class="linenos">177</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="disparity_matrix-178"><a href="#disparity_matrix-178"><span class="linenos">178</span></a>            <span class="n">dmat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dispt</span> <span class="o">==</span> <span class="n">dlist</span><span class="p">[</span><span class="n">dd</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">corrt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dd</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="disparity_matrix-179"><a href="#disparity_matrix-179"><span class="linenos">179</span></a>            <span class="n">dmat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dispt</span> <span class="o">==</span> <span class="n">dlist</span><span class="p">[</span><span class="n">dd</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">corrt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ND</span><span class="o">+</span><span class="n">dd</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="disparity_matrix-180"><a href="#disparity_matrix-180"><span class="linenos">180</span></a>
</span><span id="disparity_matrix-181"><a href="#disparity_matrix-181"><span class="linenos">181</span></a>    <span class="k">return</span> <span class="n">dmat</span>
</span></pre></div>


            <div class="docstring"><p>Create one-hot representation of disparities: NT x 2<em>ND+2 (ND = num disparities)
-- Columns (0,ND-1):  correlated
-- Columns (ND, 2</em>ND-1): anticorrelated
-- Column -2: uncorrelated
-- Column -1: blank</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>dispt:</strong>  disparity values</li>
<li><strong>corrt:</strong>  correlation values (if None, will not use)</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>dmat: one-hot representation of disparities</p>
</blockquote>
</div>


                </section>
                <section id="disparity_tuning">
                            <input id="disparity_tuning-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">disparity_tuning</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">data</span>, </span><span class="param"><span class="n">r</span>, </span><span class="param"><span class="n">cell_n</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">num_dlags</span><span class="o">=</span><span class="mi">8</span>, </span><span class="param"><span class="n">fr1or3</span><span class="o">=</span><span class="mi">3</span>, </span><span class="param"><span class="n">to_plot</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="disparity_tuning-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#disparity_tuning"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="disparity_tuning-184"><a href="#disparity_tuning-184"><span class="linenos">184</span></a><span class="k">def</span> <span class="nf">disparity_tuning</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_dlags</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">to_plot</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="disparity_tuning-185"><a href="#disparity_tuning-185"><span class="linenos">185</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="disparity_tuning-186"><a href="#disparity_tuning-186"><span class="linenos">186</span></a><span class="sd">    Compute disparity tuning (disparity vs time) -- returned in dictionary object</span>
</span><span id="disparity_tuning-187"><a href="#disparity_tuning-187"><span class="linenos">187</span></a><span class="sd">    -&gt; include cell_n to use data_filters from the actual cell</span>
</span><span id="disparity_tuning-188"><a href="#disparity_tuning-188"><span class="linenos">188</span></a>
</span><span id="disparity_tuning-189"><a href="#disparity_tuning-189"><span class="linenos">189</span></a><span class="sd">    Args:</span>
</span><span id="disparity_tuning-190"><a href="#disparity_tuning-190"><span class="linenos">190</span></a><span class="sd">        data: binocular dataset (NTdatasets.binocular.single)</span>
</span><span id="disparity_tuning-191"><a href="#disparity_tuning-191"><span class="linenos">191</span></a><span class="sd">        r: response of the cell (or model) to use</span>
</span><span id="disparity_tuning-192"><a href="#disparity_tuning-192"><span class="linenos">192</span></a><span class="sd">        cell_n: cell number (in python numbering, i.e. starting with 0)</span>
</span><span id="disparity_tuning-193"><a href="#disparity_tuning-193"><span class="linenos">193</span></a><span class="sd">        num_dlags: number of lags to use in the time embedding</span>
</span><span id="disparity_tuning-194"><a href="#disparity_tuning-194"><span class="linenos">194</span></a><span class="sd">        fr1or3: whether to use fr1==1, fr3==3, or both (leave as None) to calculate disparity. Should choose 1 or 3</span>
</span><span id="disparity_tuning-195"><a href="#disparity_tuning-195"><span class="linenos">195</span></a><span class="sd">        to_plot: whether to plot the tuning curve</span>
</span><span id="disparity_tuning-196"><a href="#disparity_tuning-196"><span class="linenos">196</span></a>
</span><span id="disparity_tuning-197"><a href="#disparity_tuning-197"><span class="linenos">197</span></a><span class="sd">    Returns:</span>
</span><span id="disparity_tuning-198"><a href="#disparity_tuning-198"><span class="linenos">198</span></a><span class="sd">        Dinfo: dictionary with all the information about the disparity tuning curve</span>
</span><span id="disparity_tuning-199"><a href="#disparity_tuning-199"><span class="linenos">199</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="disparity_tuning-200"><a href="#disparity_tuning-200"><span class="linenos">200</span></a>    <span class="kn">import</span> <span class="nn">torch</span>
</span><span id="disparity_tuning-201"><a href="#disparity_tuning-201"><span class="linenos">201</span></a>
</span><span id="disparity_tuning-202"><a href="#disparity_tuning-202"><span class="linenos">202</span></a>    <span class="n">dmat</span> <span class="o">=</span> <span class="n">disparity_matrix</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">dispt</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">corrt</span><span class="p">)</span>
</span><span id="disparity_tuning-203"><a href="#disparity_tuning-203"><span class="linenos">203</span></a>    <span class="n">ND</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="disparity_tuning-204"><a href="#disparity_tuning-204"><span class="linenos">204</span></a>
</span><span id="disparity_tuning-205"><a href="#disparity_tuning-205"><span class="linenos">205</span></a>    <span class="c1"># Weight all by their frequency of occurance    </span>
</span><span id="disparity_tuning-206"><a href="#disparity_tuning-206"><span class="linenos">206</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">fr1or3</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fr1or3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="disparity_tuning-207"><a href="#disparity_tuning-207"><span class="linenos">207</span></a>        <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">frs</span> <span class="o">==</span> <span class="n">fr1or3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="disparity_tuning-208"><a href="#disparity_tuning-208"><span class="linenos">208</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="disparity_tuning-209"><a href="#disparity_tuning-209"><span class="linenos">209</span></a>        <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">frs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="disparity_tuning-210"><a href="#disparity_tuning-210"><span class="linenos">210</span></a>
</span><span id="disparity_tuning-211"><a href="#disparity_tuning-211"><span class="linenos">211</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="disparity_tuning-212"><a href="#disparity_tuning-212"><span class="linenos">212</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="disparity_tuning-213"><a href="#disparity_tuning-213"><span class="linenos">213</span></a>    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="disparity_tuning-214"><a href="#disparity_tuning-214"><span class="linenos">214</span></a>    
</span><span id="disparity_tuning-215"><a href="#disparity_tuning-215"><span class="linenos">215</span></a>    <span class="k">if</span> <span class="n">cell_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="disparity_tuning-216"><a href="#disparity_tuning-216"><span class="linenos">216</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">data</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())[</span><span class="n">inds</span><span class="p">]</span>
</span><span id="disparity_tuning-217"><a href="#disparity_tuning-217"><span class="linenos">217</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="disparity_tuning-218"><a href="#disparity_tuning-218"><span class="linenos">218</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">inds</span><span class="p">])</span>
</span><span id="disparity_tuning-219"><a href="#disparity_tuning-219"><span class="linenos">219</span></a>
</span><span id="disparity_tuning-220"><a href="#disparity_tuning-220"><span class="linenos">220</span></a>    <span class="n">resp</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="disparity_tuning-221"><a href="#disparity_tuning-221"><span class="linenos">221</span></a>    <span class="n">dmatN</span> <span class="o">=</span> <span class="n">dmat</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dmat</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># will be stim rate</span>
</span><span id="disparity_tuning-222"><a href="#disparity_tuning-222"><span class="linenos">222</span></a>
</span><span id="disparity_tuning-223"><a href="#disparity_tuning-223"><span class="linenos">223</span></a>    <span class="c1"># if every stim resulted in 1 spk, the would be 1 as is</span>
</span><span id="disparity_tuning-224"><a href="#disparity_tuning-224"><span class="linenos">224</span></a>    <span class="c1">#nrms = np.mean(dmat[used_inds[to_use],:], axis=0) # number of stimuli of each type</span>
</span><span id="disparity_tuning-225"><a href="#disparity_tuning-225"><span class="linenos">225</span></a>    <span class="n">Xmat</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">create_time_embedding</span><span class="p">(</span> <span class="n">dmatN</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="n">ND</span><span class="o">*</span><span class="mi">2</span><span class="p">)],</span> <span class="n">num_dlags</span><span class="p">)[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="disparity_tuning-226"><a href="#disparity_tuning-226"><span class="linenos">226</span></a>    <span class="c1"># uncorrelated response</span>
</span><span id="disparity_tuning-227"><a href="#disparity_tuning-227"><span class="linenos">227</span></a>    <span class="n">Umat</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">create_time_embedding</span><span class="p">(</span> <span class="n">dmatN</span><span class="p">[:,</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]],</span> <span class="n">num_dlags</span><span class="p">)[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="disparity_tuning-228"><a href="#disparity_tuning-228"><span class="linenos">228</span></a>                          
</span><span id="disparity_tuning-229"><a href="#disparity_tuning-229"><span class="linenos">229</span></a>    <span class="c1">#Nspks = np.sum(resp[to_use, :], axis=0)</span>
</span><span id="disparity_tuning-230"><a href="#disparity_tuning-230"><span class="linenos">230</span></a>    <span class="n">Nspks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># this will end up being number of spikes associated with each stim </span>
</span><span id="disparity_tuning-231"><a href="#disparity_tuning-231"><span class="linenos">231</span></a>    <span class="c1"># at different lags, divided by number of time points used. (i.e. prob of spike per bin)</span>
</span><span id="disparity_tuning-232"><a href="#disparity_tuning-232"><span class="linenos">232</span></a>
</span><span id="disparity_tuning-233"><a href="#disparity_tuning-233"><span class="linenos">233</span></a>    <span class="n">Dsta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="n">Xmat</span><span class="o">.</span><span class="n">T</span><span class="nd">@resp</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ND</span><span class="p">,</span> <span class="n">num_dlags</span><span class="p">]</span> <span class="p">)</span> <span class="o">/</span> <span class="n">Nspks</span>
</span><span id="disparity_tuning-234"><a href="#disparity_tuning-234"><span class="linenos">234</span></a>    <span class="n">Usta</span> <span class="o">=</span> <span class="p">(</span><span class="n">Umat</span><span class="o">.</span><span class="n">T</span><span class="nd">@resp</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">Nspks</span>
</span><span id="disparity_tuning-235"><a href="#disparity_tuning-235"><span class="linenos">235</span></a>    
</span><span id="disparity_tuning-236"><a href="#disparity_tuning-236"><span class="linenos">236</span></a>    <span class="c1"># Rudimentary analysis</span>
</span><span id="disparity_tuning-237"><a href="#disparity_tuning-237"><span class="linenos">237</span></a>    <span class="n">best_lag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Dsta</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">ND</span><span class="p">),:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</span><span id="disparity_tuning-238"><a href="#disparity_tuning-238"><span class="linenos">238</span></a>    <span class="n">Dtun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Dsta</span><span class="p">[:,</span> <span class="n">best_lag</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">ND</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
</span><span id="disparity_tuning-239"><a href="#disparity_tuning-239"><span class="linenos">239</span></a>    <span class="n">uncor_resp</span> <span class="o">=</span> <span class="n">Usta</span><span class="p">[</span><span class="n">best_lag</span><span class="p">]</span>
</span><span id="disparity_tuning-240"><a href="#disparity_tuning-240"><span class="linenos">240</span></a>    
</span><span id="disparity_tuning-241"><a href="#disparity_tuning-241"><span class="linenos">241</span></a>    <span class="n">Dinfo</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Dsta&#39;</span><span class="p">:</span><span class="n">Dsta</span><span class="p">,</span> <span class="s1">&#39;Dtun&#39;</span><span class="p">:</span> <span class="n">Dtun</span><span class="p">,</span> <span class="s1">&#39;uncor_resp&#39;</span><span class="p">:</span> <span class="n">uncor_resp</span><span class="p">,</span> 
</span><span id="disparity_tuning-242"><a href="#disparity_tuning-242"><span class="linenos">242</span></a>            <span class="s1">&#39;best_lag&#39;</span><span class="p">:</span> <span class="n">best_lag</span><span class="p">,</span> <span class="s1">&#39;uncor_sta&#39;</span><span class="p">:</span> <span class="n">Usta</span><span class="p">,</span> <span class="s1">&#39;disp_list&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">disp_list</span><span class="p">[</span><span class="mi">2</span><span class="p">:]}</span>
</span><span id="disparity_tuning-243"><a href="#disparity_tuning-243"><span class="linenos">243</span></a>
</span><span id="disparity_tuning-244"><a href="#disparity_tuning-244"><span class="linenos">244</span></a>    <span class="k">if</span> <span class="n">to_plot</span><span class="p">:</span>
</span><span id="disparity_tuning-245"><a href="#disparity_tuning-245"><span class="linenos">245</span></a>        <span class="n">utils</span><span class="o">.</span><span class="n">subplot_setup</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">fig_width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">row_height</span><span class="o">=</span><span class="mf">2.8</span><span class="p">)</span>
</span><span id="disparity_tuning-246"><a href="#disparity_tuning-246"><span class="linenos">246</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="disparity_tuning-247"><a href="#disparity_tuning-247"><span class="linenos">247</span></a>        <span class="n">utils</span><span class="o">.</span><span class="n">imagesc</span><span class="p">(</span><span class="n">Dsta</span><span class="o">-</span><span class="n">uncor_resp</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">)</span>
</span><span id="disparity_tuning-248"><a href="#disparity_tuning-248"><span class="linenos">248</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">ND</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">ND</span><span class="o">-</span><span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">num_dlags</span><span class="o">-</span><span class="mf">0.5</span><span class="p">],</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
</span><span id="disparity_tuning-249"><a href="#disparity_tuning-249"><span class="linenos">249</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">ND</span><span class="o">-</span><span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="n">best_lag</span><span class="p">,</span> <span class="n">best_lag</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">)</span>
</span><span id="disparity_tuning-250"><a href="#disparity_tuning-250"><span class="linenos">250</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span id="disparity_tuning-251"><a href="#disparity_tuning-251"><span class="linenos">251</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Dtun</span><span class="p">)</span>
</span><span id="disparity_tuning-252"><a href="#disparity_tuning-252"><span class="linenos">252</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">-</span><span class="n">Dtun</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">uncor_resp</span><span class="p">,</span><span class="s1">&#39;m--&#39;</span><span class="p">)</span>
</span><span id="disparity_tuning-253"><a href="#disparity_tuning-253"><span class="linenos">253</span></a>
</span><span id="disparity_tuning-254"><a href="#disparity_tuning-254"><span class="linenos">254</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">ND</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">uncor_resp</span><span class="p">,</span> <span class="n">uncor_resp</span><span class="p">],</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
</span><span id="disparity_tuning-255"><a href="#disparity_tuning-255"><span class="linenos">255</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">ND</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="disparity_tuning-256"><a href="#disparity_tuning-256"><span class="linenos">256</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="disparity_tuning-257"><a href="#disparity_tuning-257"><span class="linenos">257</span></a>        
</span><span id="disparity_tuning-258"><a href="#disparity_tuning-258"><span class="linenos">258</span></a>    <span class="k">return</span> <span class="n">Dinfo</span>
</span></pre></div>


            <div class="docstring"><p>Compute disparity tuning (disparity vs time) -- returned in dictionary object
-> include cell_n to use data_filters from the actual cell</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>data:</strong>  binocular dataset (NTdatasets.binocular.single)</li>
<li><strong>r:</strong>  response of the cell (or model) to use</li>
<li><strong>cell_n:</strong>  cell number (in python numbering, i.e. starting with 0)</li>
<li><strong>num_dlags:</strong>  number of lags to use in the time embedding</li>
<li><strong>fr1or3:</strong>  whether to use fr1==1, fr3==3, or both (leave as None) to calculate disparity. Should choose 1 or 3</li>
<li><strong>to_plot:</strong>  whether to plot the tuning curve</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Dinfo: dictionary with all the information about the disparity tuning curve</p>
</blockquote>
</div>


                </section>
                <section id="disparity_predictions">
                            <input id="disparity_predictions-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">disparity_predictions</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">data</span>,</span><span class="param">	<span class="n">resp</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">cell_n</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">fr1or3</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">indxs</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">num_dlags</span><span class="o">=</span><span class="mi">8</span>,</span><span class="param">	<span class="n">spiking</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">rectified</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="disparity_predictions-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#disparity_predictions"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="disparity_predictions-262"><a href="#disparity_predictions-262"><span class="linenos">262</span></a><span class="k">def</span> <span class="nf">disparity_predictions</span><span class="p">(</span> 
</span><span id="disparity_predictions-263"><a href="#disparity_predictions-263"><span class="linenos">263</span></a>    <span class="n">data</span><span class="p">,</span> <span class="n">resp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="disparity_predictions-264"><a href="#disparity_predictions-264"><span class="linenos">264</span></a>    <span class="n">fr1or3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indxs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="disparity_predictions-265"><a href="#disparity_predictions-265"><span class="linenos">265</span></a>    <span class="n">num_dlags</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>  <span class="n">spiking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rectified</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="disparity_predictions-266"><a href="#disparity_predictions-266"><span class="linenos">266</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="disparity_predictions-267"><a href="#disparity_predictions-267"><span class="linenos">267</span></a><span class="sd">    Calculates a prediction of the disparity (and timing) signals that can be inferred from the response</span>
</span><span id="disparity_predictions-268"><a href="#disparity_predictions-268"><span class="linenos">268</span></a><span class="sd">    by the disparity input alone. This puts a lower bound on how much disparity is driving the response, although</span>
</span><span id="disparity_predictions-269"><a href="#disparity_predictions-269"><span class="linenos">269</span></a><span class="sd">    practically speaking it generates the same disparity tuning curves for neurons.</span>
</span><span id="disparity_predictions-270"><a href="#disparity_predictions-270"><span class="linenos">270</span></a><span class="sd">    </span>
</span><span id="disparity_predictions-271"><a href="#disparity_predictions-271"><span class="linenos">271</span></a><span class="sd">    Args:</span>
</span><span id="disparity_predictions-272"><a href="#disparity_predictions-272"><span class="linenos">272</span></a><span class="sd">        data: dataset (NTdatasets.binocular.single)</span>
</span><span id="disparity_predictions-273"><a href="#disparity_predictions-273"><span class="linenos">273</span></a><span class="sd">        resp: either Robs or predicted response across whole dataset -- leave blank if want neurons Robs</span>
</span><span id="disparity_predictions-274"><a href="#disparity_predictions-274"><span class="linenos">274</span></a><span class="sd">        cell_n: cell number (in python numbering, i.e. starting with 0)</span>
</span><span id="disparity_predictions-275"><a href="#disparity_predictions-275"><span class="linenos">275</span></a><span class="sd">        fr1or3: whether to use fr1==1, fr3==3, or both (leave as None) to calculate disparity. Should choose 1 or 3</span>
</span><span id="disparity_predictions-276"><a href="#disparity_predictions-276"><span class="linenos">276</span></a><span class="sd">        indxs: subset of data -- probably will not use given dfs and fr1or3</span>
</span><span id="disparity_predictions-277"><a href="#disparity_predictions-277"><span class="linenos">277</span></a><span class="sd">        num_dlags: how many lags to compute disparity/timing predictions using (default 8 is sufficient)</span>
</span><span id="disparity_predictions-278"><a href="#disparity_predictions-278"><span class="linenos">278</span></a><span class="sd">        spiking: whether to use Poisson loss function (spiking data) or Gaussian (continuous prediction): default True</span>
</span><span id="disparity_predictions-279"><a href="#disparity_predictions-279"><span class="linenos">279</span></a><span class="sd">        rectified: whether to rectify the predictions using softplus (since predicting spikes, generally)</span>
</span><span id="disparity_predictions-280"><a href="#disparity_predictions-280"><span class="linenos">280</span></a><span class="sd">    </span>
</span><span id="disparity_predictions-281"><a href="#disparity_predictions-281"><span class="linenos">281</span></a><span class="sd">    Returns: </span>
</span><span id="disparity_predictions-282"><a href="#disparity_predictions-282"><span class="linenos">282</span></a><span class="sd">        Dpred: full disparity+timing prediction</span>
</span><span id="disparity_predictions-283"><a href="#disparity_predictions-283"><span class="linenos">283</span></a><span class="sd">        Tpred: prediction using just frame refresh and blanks</span>
</span><span id="disparity_predictions-284"><a href="#disparity_predictions-284"><span class="linenos">284</span></a><span class="sd">        Note that both will predict over the whole dataset, even if only used 1 part to fit</span>
</span><span id="disparity_predictions-285"><a href="#disparity_predictions-285"><span class="linenos">285</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="disparity_predictions-286"><a href="#disparity_predictions-286"><span class="linenos">286</span></a>
</span><span id="disparity_predictions-287"><a href="#disparity_predictions-287"><span class="linenos">287</span></a>    <span class="k">assert</span> <span class="n">cell_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to specify which neuron modeling for valid comparisons&quot;</span>
</span><span id="disparity_predictions-288"><a href="#disparity_predictions-288"><span class="linenos">288</span></a>
</span><span id="disparity_predictions-289"><a href="#disparity_predictions-289"><span class="linenos">289</span></a>    <span class="kn">import</span> <span class="nn">torch</span>
</span><span id="disparity_predictions-290"><a href="#disparity_predictions-290"><span class="linenos">290</span></a>    <span class="kn">from</span> <span class="nn">NTdatasets.generic</span> <span class="kn">import</span> <span class="n">GenericDataset</span>
</span><span id="disparity_predictions-291"><a href="#disparity_predictions-291"><span class="linenos">291</span></a>    <span class="kn">from</span> <span class="nn">NDNT.modules.layers</span> <span class="kn">import</span> <span class="n">NDNLayer</span>
</span><span id="disparity_predictions-292"><a href="#disparity_predictions-292"><span class="linenos">292</span></a>
</span><span id="disparity_predictions-293"><a href="#disparity_predictions-293"><span class="linenos">293</span></a>    <span class="c1"># use Robs if response is blank</span>
</span><span id="disparity_predictions-294"><a href="#disparity_predictions-294"><span class="linenos">294</span></a>    <span class="k">if</span> <span class="n">resp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="disparity_predictions-295"><a href="#disparity_predictions-295"><span class="linenos">295</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">]</span>
</span><span id="disparity_predictions-296"><a href="#disparity_predictions-296"><span class="linenos">296</span></a>    <span class="c1"># Make sure response is formatted correctly</span>
</span><span id="disparity_predictions-297"><a href="#disparity_predictions-297"><span class="linenos">297</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">resp</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="disparity_predictions-298"><a href="#disparity_predictions-298"><span class="linenos">298</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">resp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span> <span class="p">)</span>
</span><span id="disparity_predictions-299"><a href="#disparity_predictions-299"><span class="linenos">299</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="disparity_predictions-300"><a href="#disparity_predictions-300"><span class="linenos">300</span></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="disparity_predictions-301"><a href="#disparity_predictions-301"><span class="linenos">301</span></a>
</span><span id="disparity_predictions-302"><a href="#disparity_predictions-302"><span class="linenos">302</span></a>    <span class="k">if</span> <span class="n">indxs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="disparity_predictions-303"><a href="#disparity_predictions-303"><span class="linenos">303</span></a>        <span class="n">indxs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="disparity_predictions-304"><a href="#disparity_predictions-304"><span class="linenos">304</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">fr1or3</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fr1or3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="disparity_predictions-305"><a href="#disparity_predictions-305"><span class="linenos">305</span></a>        <span class="n">mod_indxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">indxs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">frs</span> <span class="o">==</span> <span class="n">fr1or3</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="disparity_predictions-306"><a href="#disparity_predictions-306"><span class="linenos">306</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="disparity_predictions-307"><a href="#disparity_predictions-307"><span class="linenos">307</span></a>        <span class="n">mod_indxs</span> <span class="o">=</span> <span class="n">indxs</span>
</span><span id="disparity_predictions-308"><a href="#disparity_predictions-308"><span class="linenos">308</span></a>
</span><span id="disparity_predictions-309"><a href="#disparity_predictions-309"><span class="linenos">309</span></a>    <span class="c1"># Process disparity into disparty and timing design matrix</span>
</span><span id="disparity_predictions-310"><a href="#disparity_predictions-310"><span class="linenos">310</span></a>    <span class="n">dmat</span> <span class="o">=</span> <span class="n">disparity_matrix</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">dispt</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">corrt</span> <span class="p">)</span>  <span class="c1"># all information about disparity</span>
</span><span id="disparity_predictions-311"><a href="#disparity_predictions-311"><span class="linenos">311</span></a>    
</span><span id="disparity_predictions-312"><a href="#disparity_predictions-312"><span class="linenos">312</span></a>    <span class="c1"># This keeps track of changes in disparity (often every 3)</span>
</span><span id="disparity_predictions-313"><a href="#disparity_predictions-313"><span class="linenos">313</span></a>    <span class="n">switches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="disparity_predictions-314"><a href="#disparity_predictions-314"><span class="linenos">314</span></a>    <span class="c1"># Switches are not relevant during FR1 -- would at best be constant offset</span>
</span><span id="disparity_predictions-315"><a href="#disparity_predictions-315"><span class="linenos">315</span></a>    <span class="n">switches</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">frs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="disparity_predictions-316"><a href="#disparity_predictions-316"><span class="linenos">316</span></a>    
</span><span id="disparity_predictions-317"><a href="#disparity_predictions-317"><span class="linenos">317</span></a>    <span class="c1"># Append switches to full disparity-oracle dataset</span>
</span><span id="disparity_predictions-318"><a href="#disparity_predictions-318"><span class="linenos">318</span></a>    <span class="n">dmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">switches</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>
</span><span id="disparity_predictions-319"><a href="#disparity_predictions-319"><span class="linenos">319</span></a>    <span class="n">ND2</span> <span class="o">=</span> <span class="n">dmat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># this includes uncorrelated (second to last) and blanks (last column</span>
</span><span id="disparity_predictions-320"><a href="#disparity_predictions-320"><span class="linenos">320</span></a>
</span><span id="disparity_predictions-321"><a href="#disparity_predictions-321"><span class="linenos">321</span></a>    <span class="n">blanks</span> <span class="o">=</span> <span class="n">dmat</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="disparity_predictions-322"><a href="#disparity_predictions-322"><span class="linenos">322</span></a>    <span class="n">tmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">blanks</span><span class="p">,</span> <span class="n">switches</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>
</span><span id="disparity_predictions-323"><a href="#disparity_predictions-323"><span class="linenos">323</span></a>
</span><span id="disparity_predictions-324"><a href="#disparity_predictions-324"><span class="linenos">324</span></a>    <span class="c1"># Make models that use disparity to predict response, and timing alone</span>
</span><span id="disparity_predictions-325"><a href="#disparity_predictions-325"><span class="linenos">325</span></a>    <span class="n">Ddata</span> <span class="o">=</span> <span class="n">GenericDataset</span><span class="p">(</span> <span class="p">{</span>
</span><span id="disparity_predictions-326"><a href="#disparity_predictions-326"><span class="linenos">326</span></a>        <span class="s1">&#39;stim&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">create_time_embedding</span><span class="p">(</span> <span class="n">dmat</span><span class="p">,</span> <span class="n">num_dlags</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
</span><span id="disparity_predictions-327"><a href="#disparity_predictions-327"><span class="linenos">327</span></a>        <span class="s1">&#39;timing&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">create_time_embedding</span><span class="p">(</span> <span class="n">tmat</span><span class="p">,</span> <span class="n">num_dlags</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
</span><span id="disparity_predictions-328"><a href="#disparity_predictions-328"><span class="linenos">328</span></a>        <span class="s1">&#39;robs&#39;</span><span class="p">:</span> <span class="n">resp</span><span class="p">,</span>
</span><span id="disparity_predictions-329"><a href="#disparity_predictions-329"><span class="linenos">329</span></a>        <span class="s1">&#39;dfs&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">]})</span>
</span><span id="disparity_predictions-330"><a href="#disparity_predictions-330"><span class="linenos">330</span></a>
</span><span id="disparity_predictions-331"><a href="#disparity_predictions-331"><span class="linenos">331</span></a>    <span class="n">lbfgs_pars</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">create_optimizer_params</span><span class="p">(</span>
</span><span id="disparity_predictions-332"><a href="#disparity_predictions-332"><span class="linenos">332</span></a>        <span class="n">optimizer_type</span><span class="o">=</span><span class="s1">&#39;lbfgs&#39;</span><span class="p">,</span>
</span><span id="disparity_predictions-333"><a href="#disparity_predictions-333"><span class="linenos">333</span></a>        <span class="n">tolerance_change</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">tolerance_grad</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
</span><span id="disparity_predictions-334"><a href="#disparity_predictions-334"><span class="linenos">334</span></a>        <span class="n">history_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</span><span id="disparity_predictions-335"><a href="#disparity_predictions-335"><span class="linenos">335</span></a> 
</span><span id="disparity_predictions-336"><a href="#disparity_predictions-336"><span class="linenos">336</span></a>    <span class="k">if</span> <span class="n">rectified</span><span class="p">:</span>
</span><span id="disparity_predictions-337"><a href="#disparity_predictions-337"><span class="linenos">337</span></a>        <span class="n">nltype</span> <span class="o">=</span> <span class="s1">&#39;softplus&#39;</span>
</span><span id="disparity_predictions-338"><a href="#disparity_predictions-338"><span class="linenos">338</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="disparity_predictions-339"><a href="#disparity_predictions-339"><span class="linenos">339</span></a>        <span class="n">nltype</span> <span class="o">=</span> <span class="s1">&#39;lin&#39;</span>
</span><span id="disparity_predictions-340"><a href="#disparity_predictions-340"><span class="linenos">340</span></a>    <span class="k">if</span> <span class="n">spiking</span><span class="p">:</span>
</span><span id="disparity_predictions-341"><a href="#disparity_predictions-341"><span class="linenos">341</span></a>        <span class="n">losstype</span> <span class="o">=</span> <span class="s1">&#39;poisson&#39;</span>
</span><span id="disparity_predictions-342"><a href="#disparity_predictions-342"><span class="linenos">342</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="disparity_predictions-343"><a href="#disparity_predictions-343"><span class="linenos">343</span></a>        <span class="n">losstype</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
</span><span id="disparity_predictions-344"><a href="#disparity_predictions-344"><span class="linenos">344</span></a>        
</span><span id="disparity_predictions-345"><a href="#disparity_predictions-345"><span class="linenos">345</span></a>    <span class="n">dpred_layer</span> <span class="o">=</span> <span class="n">NDNLayer</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span>
</span><span id="disparity_predictions-346"><a href="#disparity_predictions-346"><span class="linenos">346</span></a>        <span class="n">input_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ND2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">num_dlags</span><span class="p">],</span> <span class="n">num_filters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">NLtype</span><span class="o">=</span><span class="n">nltype</span><span class="p">)</span>
</span><span id="disparity_predictions-347"><a href="#disparity_predictions-347"><span class="linenos">347</span></a>
</span><span id="disparity_predictions-348"><a href="#disparity_predictions-348"><span class="linenos">348</span></a>    <span class="n">tpred_layer</span> <span class="o">=</span> <span class="n">NDNLayer</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span>
</span><span id="disparity_predictions-349"><a href="#disparity_predictions-349"><span class="linenos">349</span></a>        <span class="n">input_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">num_dlags</span><span class="p">],</span> <span class="n">num_filters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">NLtype</span><span class="o">=</span><span class="n">nltype</span><span class="p">)</span>
</span><span id="disparity_predictions-350"><a href="#disparity_predictions-350"><span class="linenos">350</span></a>
</span><span id="disparity_predictions-351"><a href="#disparity_predictions-351"><span class="linenos">351</span></a>    <span class="n">dpredmod</span> <span class="o">=</span> <span class="n">NDN</span><span class="p">(</span> <span class="n">layer_list</span><span class="o">=</span><span class="p">[</span><span class="n">dpred_layer</span><span class="p">],</span> <span class="n">loss_type</span><span class="o">=</span><span class="n">losstype</span> <span class="p">)</span>
</span><span id="disparity_predictions-352"><a href="#disparity_predictions-352"><span class="linenos">352</span></a>    <span class="n">tpredmod</span> <span class="o">=</span> <span class="n">NDN</span><span class="p">(</span> <span class="n">layer_list</span><span class="o">=</span><span class="p">[</span><span class="n">tpred_layer</span><span class="p">],</span> <span class="n">loss_type</span><span class="o">=</span><span class="n">losstype</span> <span class="p">)</span>
</span><span id="disparity_predictions-353"><a href="#disparity_predictions-353"><span class="linenos">353</span></a>    <span class="n">tpredmod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xstim_n</span> <span class="o">=</span> <span class="s1">&#39;timing&#39;</span>
</span><span id="disparity_predictions-354"><a href="#disparity_predictions-354"><span class="linenos">354</span></a>
</span><span id="disparity_predictions-355"><a href="#disparity_predictions-355"><span class="linenos">355</span></a>    <span class="c1">#dpredmod.fit( Ddata, force_dict_training=True, train_inds=mod_indxs, val_inds=mod_indxs, </span>
</span><span id="disparity_predictions-356"><a href="#disparity_predictions-356"><span class="linenos">356</span></a>    <span class="c1">#            **lbfgs_pars, verbose=0, version=1)</span>
</span><span id="disparity_predictions-357"><a href="#disparity_predictions-357"><span class="linenos">357</span></a>    <span class="n">utils</span><span class="o">.</span><span class="n">iterate_lbfgs</span><span class="p">(</span> <span class="n">dpredmod</span><span class="p">,</span> <span class="n">Ddata</span><span class="p">,</span> <span class="n">lbfgs_pars</span><span class="p">,</span> <span class="n">train_inds</span><span class="o">=</span><span class="n">mod_indxs</span><span class="p">,</span> <span class="n">val_inds</span><span class="o">=</span><span class="n">mod_indxs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
</span><span id="disparity_predictions-358"><a href="#disparity_predictions-358"><span class="linenos">358</span></a>    <span class="n">utils</span><span class="o">.</span><span class="n">iterate_lbfgs</span><span class="p">(</span> <span class="n">tpredmod</span><span class="p">,</span> <span class="n">Ddata</span><span class="p">,</span> <span class="n">lbfgs_pars</span><span class="p">,</span> <span class="n">train_inds</span><span class="o">=</span><span class="n">mod_indxs</span><span class="p">,</span> <span class="n">val_inds</span><span class="o">=</span><span class="n">mod_indxs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
</span><span id="disparity_predictions-359"><a href="#disparity_predictions-359"><span class="linenos">359</span></a>    <span class="c1">#tpredmod.fit( Ddata, force_dict_training=True, train_inds=mod_indxs, val_inds=mod_indxs, </span>
</span><span id="disparity_predictions-360"><a href="#disparity_predictions-360"><span class="linenos">360</span></a>    <span class="c1">#            **lbfgs_pars, verbose=0, version=1)</span>
</span><span id="disparity_predictions-361"><a href="#disparity_predictions-361"><span class="linenos">361</span></a>
</span><span id="disparity_predictions-362"><a href="#disparity_predictions-362"><span class="linenos">362</span></a>    <span class="n">tpred</span> <span class="o">=</span> <span class="n">tpredmod</span><span class="p">(</span><span class="n">Ddata</span><span class="p">[:])</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="disparity_predictions-363"><a href="#disparity_predictions-363"><span class="linenos">363</span></a>    <span class="n">dpred</span> <span class="o">=</span> <span class="n">dpredmod</span><span class="p">(</span><span class="n">Ddata</span><span class="p">[:])</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="disparity_predictions-364"><a href="#disparity_predictions-364"><span class="linenos">364</span></a>
</span><span id="disparity_predictions-365"><a href="#disparity_predictions-365"><span class="linenos">365</span></a>    <span class="k">return</span> <span class="n">dpred</span><span class="p">,</span> <span class="n">tpred</span>
</span></pre></div>


            <div class="docstring"><p>Calculates a prediction of the disparity (and timing) signals that can be inferred from the response
by the disparity input alone. This puts a lower bound on how much disparity is driving the response, although
practically speaking it generates the same disparity tuning curves for neurons.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>data:</strong>  dataset (NTdatasets.binocular.single)</li>
<li><strong>resp:</strong>  either Robs or predicted response across whole dataset -- leave blank if want neurons Robs</li>
<li><strong>cell_n:</strong>  cell number (in python numbering, i.e. starting with 0)</li>
<li><strong>fr1or3:</strong>  whether to use fr1==1, fr3==3, or both (leave as None) to calculate disparity. Should choose 1 or 3</li>
<li><strong>indxs:</strong>  subset of data -- probably will not use given dfs and fr1or3</li>
<li><strong>num_dlags:</strong>  how many lags to compute disparity/timing predictions using (default 8 is sufficient)</li>
<li><strong>spiking:</strong>  whether to use Poisson loss function (spiking data) or Gaussian (continuous prediction): default True</li>
<li><strong>rectified:</strong>  whether to rectify the predictions using softplus (since predicting spikes, generally)</li>
</ul>

<p>Returns: 
    Dpred: full disparity+timing prediction
    Tpred: prediction using just frame refresh and blanks
    Note that both will predict over the whole dataset, even if only used 1 part to fit</p>
</div>


                </section>
                <section id="binocular_model_performance">
                            <input id="binocular_model_performance-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">binocular_model_performance</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">data</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">cell_n</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">Rpred</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">valset</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="binocular_model_performance-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#binocular_model_performance"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="binocular_model_performance-368"><a href="#binocular_model_performance-368"><span class="linenos">368</span></a><span class="k">def</span> <span class="nf">binocular_model_performance</span><span class="p">(</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Rpred</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">valset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="binocular_model_performance-369"><a href="#binocular_model_performance-369"><span class="linenos">369</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="binocular_model_performance-370"><a href="#binocular_model_performance-370"><span class="linenos">370</span></a><span class="sd">    Current best-practices for generating prediction quality of neuron and binocular tuning. Currently we</span>
</span><span id="binocular_model_performance-371"><a href="#binocular_model_performance-371"><span class="linenos">371</span></a><span class="sd">    are not worried about using cross-validation indices only (as they are based on much less data and tend to</span>
</span><span id="binocular_model_performance-372"><a href="#binocular_model_performance-372"><span class="linenos">372</span></a><span class="sd">    otherwise be in agreement with full measures, but this option could be added in later versions.</span>
</span><span id="binocular_model_performance-373"><a href="#binocular_model_performance-373"><span class="linenos">373</span></a><span class="sd">    valset can be None (use all val_inds, &#39;a&#39; or &#39;b&#39;: use subset)</span>
</span><span id="binocular_model_performance-374"><a href="#binocular_model_performance-374"><span class="linenos">374</span></a><span class="sd">    </span>
</span><span id="binocular_model_performance-375"><a href="#binocular_model_performance-375"><span class="linenos">375</span></a><span class="sd">    Args:</span>
</span><span id="binocular_model_performance-376"><a href="#binocular_model_performance-376"><span class="linenos">376</span></a><span class="sd">        data: binocular dataset (NTdatasets.binocular.single)</span>
</span><span id="binocular_model_performance-377"><a href="#binocular_model_performance-377"><span class="linenos">377</span></a><span class="sd">        cell_n: cell number (in python numbering, i.e. starting with 0)</span>
</span><span id="binocular_model_performance-378"><a href="#binocular_model_performance-378"><span class="linenos">378</span></a><span class="sd">        Rpred: predicted response of the model</span>
</span><span id="binocular_model_performance-379"><a href="#binocular_model_performance-379"><span class="linenos">379</span></a><span class="sd">        valset: which validation set to use (None, &#39;a&#39;, &#39;b&#39;)</span>
</span><span id="binocular_model_performance-380"><a href="#binocular_model_performance-380"><span class="linenos">380</span></a><span class="sd">        verbose: whether to print out results</span>
</span><span id="binocular_model_performance-381"><a href="#binocular_model_performance-381"><span class="linenos">381</span></a>
</span><span id="binocular_model_performance-382"><a href="#binocular_model_performance-382"><span class="linenos">382</span></a><span class="sd">    Returns:</span>
</span><span id="binocular_model_performance-383"><a href="#binocular_model_performance-383"><span class="linenos">383</span></a><span class="sd">        BMP: dictionary with all the information about the binocular model performance</span>
</span><span id="binocular_model_performance-384"><a href="#binocular_model_performance-384"><span class="linenos">384</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="binocular_model_performance-385"><a href="#binocular_model_performance-385"><span class="linenos">385</span></a>
</span><span id="binocular_model_performance-386"><a href="#binocular_model_performance-386"><span class="linenos">386</span></a>    <span class="k">assert</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Need to include dataset&#39;</span>
</span><span id="binocular_model_performance-387"><a href="#binocular_model_performance-387"><span class="linenos">387</span></a>    <span class="c1">#assert cell_n is not None, &#39;Must specify cell to check&#39;</span>
</span><span id="binocular_model_performance-388"><a href="#binocular_model_performance-388"><span class="linenos">388</span></a>
</span><span id="binocular_model_performance-389"><a href="#binocular_model_performance-389"><span class="linenos">389</span></a>    <span class="c1">#import torch</span>
</span><span id="binocular_model_performance-390"><a href="#binocular_model_performance-390"><span class="linenos">390</span></a>    <span class="c1">#if not isinstance( Rpred, torch.Tensor):</span>
</span><span id="binocular_model_performance-391"><a href="#binocular_model_performance-391"><span class="linenos">391</span></a>    <span class="c1">#    Rpred = torch.tensor( Rpred, dtype=torch.float32 )</span>
</span><span id="binocular_model_performance-392"><a href="#binocular_model_performance-392"><span class="linenos">392</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Rpred</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="binocular_model_performance-393"><a href="#binocular_model_performance-393"><span class="linenos">393</span></a>        <span class="n">Rpred</span> <span class="o">=</span> <span class="n">Rpred</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="binocular_model_performance-394"><a href="#binocular_model_performance-394"><span class="linenos">394</span></a>    
</span><span id="binocular_model_performance-395"><a href="#binocular_model_performance-395"><span class="linenos">395</span></a>    <span class="c1">## GENERAL COMPUTATIONS on data (cell-specific but not yet model-specific, using as much data as can)</span>
</span><span id="binocular_model_performance-396"><a href="#binocular_model_performance-396"><span class="linenos">396</span></a>    <span class="c1"># make disparity predictions for all conditions</span>
</span><span id="binocular_model_performance-397"><a href="#binocular_model_performance-397"><span class="linenos">397</span></a>    <span class="n">dobs0</span><span class="p">,</span> <span class="n">tobs0</span> <span class="o">=</span> <span class="n">disparity_predictions</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">spiking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rectified</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
</span><span id="binocular_model_performance-398"><a href="#binocular_model_performance-398"><span class="linenos">398</span></a>    <span class="n">dmod0</span><span class="p">,</span> <span class="n">tmod0</span> <span class="o">=</span> <span class="n">disparity_predictions</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">resp</span><span class="o">=</span><span class="n">Rpred</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">spiking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rectified</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
</span><span id="binocular_model_performance-399"><a href="#binocular_model_performance-399"><span class="linenos">399</span></a>
</span><span id="binocular_model_performance-400"><a href="#binocular_model_performance-400"><span class="linenos">400</span></a>    <span class="n">dobs3</span><span class="p">,</span> <span class="n">tobs3</span> <span class="o">=</span> <span class="n">disparity_predictions</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">spiking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rectified</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
</span><span id="binocular_model_performance-401"><a href="#binocular_model_performance-401"><span class="linenos">401</span></a>    <span class="n">dmod3</span><span class="p">,</span> <span class="n">tmod3</span> <span class="o">=</span> <span class="n">disparity_predictions</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">resp</span><span class="o">=</span><span class="n">Rpred</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">spiking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rectified</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
</span><span id="binocular_model_performance-402"><a href="#binocular_model_performance-402"><span class="linenos">402</span></a>
</span><span id="binocular_model_performance-403"><a href="#binocular_model_performance-403"><span class="linenos">403</span></a>    <span class="n">dobs1</span><span class="p">,</span> <span class="n">tobs1</span> <span class="o">=</span> <span class="n">disparity_predictions</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">spiking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rectified</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
</span><span id="binocular_model_performance-404"><a href="#binocular_model_performance-404"><span class="linenos">404</span></a>    <span class="n">dmod1</span><span class="p">,</span> <span class="n">tmod1</span> <span class="o">=</span> <span class="n">disparity_predictions</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">resp</span><span class="o">=</span><span class="n">Rpred</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">spiking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rectified</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
</span><span id="binocular_model_performance-405"><a href="#binocular_model_performance-405"><span class="linenos">405</span></a>
</span><span id="binocular_model_performance-406"><a href="#binocular_model_performance-406"><span class="linenos">406</span></a>    <span class="c1"># This necessarily takes data-filters into account, but not cross-validation inds</span>
</span><span id="binocular_model_performance-407"><a href="#binocular_model_performance-407"><span class="linenos">407</span></a>    <span class="n">ev</span><span class="p">,</span> <span class="n">tv</span> <span class="o">=</span> <span class="n">explainable_variance</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span> <span class="p">)</span>
</span><span id="binocular_model_performance-408"><a href="#binocular_model_performance-408"><span class="linenos">408</span></a>    <span class="n">ev3</span><span class="p">,</span> <span class="n">tv3</span> <span class="o">=</span> <span class="n">explainable_variance</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span> <span class="p">)</span>
</span><span id="binocular_model_performance-409"><a href="#binocular_model_performance-409"><span class="linenos">409</span></a>    <span class="n">ev1</span><span class="p">,</span> <span class="n">tv1</span> <span class="o">=</span> <span class="n">explainable_variance</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span> <span class="p">)</span>
</span><span id="binocular_model_performance-410"><a href="#binocular_model_performance-410"><span class="linenos">410</span></a>    
</span><span id="binocular_model_performance-411"><a href="#binocular_model_performance-411"><span class="linenos">411</span></a>    <span class="k">if</span> <span class="n">ev</span> <span class="o">==</span> <span class="n">tv</span><span class="p">:</span>
</span><span id="binocular_model_performance-412"><a href="#binocular_model_performance-412"><span class="linenos">412</span></a>        <span class="n">ev_valid</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="binocular_model_performance-413"><a href="#binocular_model_performance-413"><span class="linenos">413</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="binocular_model_performance-414"><a href="#binocular_model_performance-414"><span class="linenos">414</span></a>        <span class="n">ev_valid</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="binocular_model_performance-415"><a href="#binocular_model_performance-415"><span class="linenos">415</span></a>
</span><span id="binocular_model_performance-416"><a href="#binocular_model_performance-416"><span class="linenos">416</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="binocular_model_performance-417"><a href="#binocular_model_performance-417"><span class="linenos">417</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Overall explainable variance fraction: </span><span class="si">%0.3f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ev</span><span class="o">/</span><span class="n">tv</span><span class="p">)</span> <span class="p">)</span>
</span><span id="binocular_model_performance-418"><a href="#binocular_model_performance-418"><span class="linenos">418</span></a>
</span><span id="binocular_model_performance-419"><a href="#binocular_model_performance-419"><span class="linenos">419</span></a>    <span class="c1">#### Model and data properties (not performance yet)</span>
</span><span id="binocular_model_performance-420"><a href="#binocular_model_performance-420"><span class="linenos">420</span></a>    <span class="n">indxs3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">frs</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="binocular_model_performance-421"><a href="#binocular_model_performance-421"><span class="linenos">421</span></a>    <span class="n">indxs1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">frs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="binocular_model_performance-422"><a href="#binocular_model_performance-422"><span class="linenos">422</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dfs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="binocular_model_performance-423"><a href="#binocular_model_performance-423"><span class="linenos">423</span></a>
</span><span id="binocular_model_performance-424"><a href="#binocular_model_performance-424"><span class="linenos">424</span></a>    <span class="c1"># Have to use same (df) inds as overall explainable variance to make fractions directly valid</span>
</span><span id="binocular_model_performance-425"><a href="#binocular_model_performance-425"><span class="linenos">425</span></a>    <span class="n">dv_obs</span> <span class="o">=</span> <span class="n">varDF</span><span class="p">(</span><span class="n">dobs0</span><span class="o">-</span><span class="n">tobs0</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
</span><span id="binocular_model_performance-426"><a href="#binocular_model_performance-426"><span class="linenos">426</span></a>    <span class="n">dv_obs3</span> <span class="o">=</span> <span class="n">varDF</span><span class="p">(</span><span class="n">dobs0</span><span class="p">[</span><span class="n">indxs3</span><span class="p">]</span><span class="o">-</span><span class="n">tobs0</span><span class="p">[</span><span class="n">indxs3</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">indxs3</span><span class="p">])</span>
</span><span id="binocular_model_performance-427"><a href="#binocular_model_performance-427"><span class="linenos">427</span></a>    <span class="n">dv_obs1</span> <span class="o">=</span> <span class="n">varDF</span><span class="p">(</span><span class="n">dobs0</span><span class="p">[</span><span class="n">indxs1</span><span class="p">]</span><span class="o">-</span><span class="n">tobs0</span><span class="p">[</span><span class="n">indxs1</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">indxs1</span><span class="p">])</span>
</span><span id="binocular_model_performance-428"><a href="#binocular_model_performance-428"><span class="linenos">428</span></a>
</span><span id="binocular_model_performance-429"><a href="#binocular_model_performance-429"><span class="linenos">429</span></a>    <span class="n">dv_pred</span> <span class="o">=</span> <span class="n">varDF</span><span class="p">(</span><span class="n">dmod0</span><span class="o">-</span><span class="n">tmod0</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
</span><span id="binocular_model_performance-430"><a href="#binocular_model_performance-430"><span class="linenos">430</span></a>    <span class="n">dv_pred3</span> <span class="o">=</span> <span class="n">varDF</span><span class="p">(</span><span class="n">dmod3</span><span class="p">[</span><span class="n">indxs3</span><span class="p">]</span><span class="o">-</span><span class="n">tmod3</span><span class="p">[</span><span class="n">indxs3</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">indxs3</span><span class="p">])</span>
</span><span id="binocular_model_performance-431"><a href="#binocular_model_performance-431"><span class="linenos">431</span></a>    <span class="n">dv_pred1</span> <span class="o">=</span> <span class="n">varDF</span><span class="p">(</span><span class="n">dmod1</span><span class="p">[</span><span class="n">indxs1</span><span class="p">]</span><span class="o">-</span><span class="n">tmod1</span><span class="p">[</span><span class="n">indxs1</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">indxs1</span><span class="p">])</span>
</span><span id="binocular_model_performance-432"><a href="#binocular_model_performance-432"><span class="linenos">432</span></a>    
</span><span id="binocular_model_performance-433"><a href="#binocular_model_performance-433"><span class="linenos">433</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="binocular_model_performance-434"><a href="#binocular_model_performance-434"><span class="linenos">434</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Obs disparity variance fraction (DVF): </span><span class="si">%0.3f</span><span class="s2"> (FR3: </span><span class="si">%0.3f</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">dv_obs</span><span class="o">/</span><span class="n">ev</span><span class="p">,</span> <span class="n">dv_obs3</span><span class="o">/</span><span class="n">ev3</span><span class="p">)</span> <span class="p">)</span>
</span><span id="binocular_model_performance-435"><a href="#binocular_model_performance-435"><span class="linenos">435</span></a>    <span class="n">vars_obs</span> <span class="o">=</span> <span class="p">[</span><span class="n">tv</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">dv_obs</span><span class="p">,</span> <span class="n">ev</span><span class="o">-</span><span class="n">dv_obs</span> <span class="p">]</span>  <span class="c1"># total, explainable, disp_var, pattern_var</span>
</span><span id="binocular_model_performance-436"><a href="#binocular_model_performance-436"><span class="linenos">436</span></a>    <span class="n">vars_obs_FR3</span> <span class="o">=</span> <span class="p">[</span><span class="n">tv3</span><span class="p">,</span> <span class="n">ev3</span><span class="p">,</span> <span class="n">dv_obs3</span><span class="p">,</span> <span class="n">ev3</span><span class="o">-</span><span class="n">dv_obs3</span> <span class="p">]</span>  <span class="c1"># total, explainable, disp_var, pattern_var</span>
</span><span id="binocular_model_performance-437"><a href="#binocular_model_performance-437"><span class="linenos">437</span></a>    <span class="n">DVfrac_obs</span> <span class="o">=</span> <span class="p">[</span><span class="n">dv_obs</span><span class="o">/</span><span class="n">ev</span><span class="p">,</span> <span class="n">dv_obs3</span><span class="o">/</span><span class="n">ev3</span><span class="p">,</span> <span class="n">dv_obs1</span><span class="o">/</span><span class="n">ev1</span> <span class="p">]</span>
</span><span id="binocular_model_performance-438"><a href="#binocular_model_performance-438"><span class="linenos">438</span></a>
</span><span id="binocular_model_performance-439"><a href="#binocular_model_performance-439"><span class="linenos">439</span></a>    <span class="c1"># use numpy version of Rpred from here on</span>
</span><span id="binocular_model_performance-440"><a href="#binocular_model_performance-440"><span class="linenos">440</span></a>    <span class="n">Rpred</span> <span class="o">=</span> <span class="n">Rpred</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="binocular_model_performance-441"><a href="#binocular_model_performance-441"><span class="linenos">441</span></a>    <span class="n">var_pred</span> <span class="o">=</span> <span class="n">varDF</span><span class="p">(</span><span class="n">Rpred</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
</span><span id="binocular_model_performance-442"><a href="#binocular_model_performance-442"><span class="linenos">442</span></a>    <span class="n">vars_mod</span> <span class="o">=</span> <span class="p">[</span><span class="n">varDF</span><span class="p">(</span><span class="n">Rpred</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">),</span> <span class="n">dv_pred</span><span class="p">,</span> <span class="n">var_pred</span><span class="o">-</span><span class="n">dv_pred</span><span class="p">]</span>
</span><span id="binocular_model_performance-443"><a href="#binocular_model_performance-443"><span class="linenos">443</span></a>    <span class="n">DVfrac_mod</span> <span class="o">=</span> <span class="p">[</span><span class="n">dv_pred</span><span class="o">/</span><span class="n">var_pred</span><span class="p">,</span> 
</span><span id="binocular_model_performance-444"><a href="#binocular_model_performance-444"><span class="linenos">444</span></a>                  <span class="n">dv_pred3</span><span class="o">/</span><span class="n">varDF</span><span class="p">(</span><span class="n">Rpred</span><span class="p">[</span><span class="n">indxs3</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">indxs3</span><span class="p">]),</span> 
</span><span id="binocular_model_performance-445"><a href="#binocular_model_performance-445"><span class="linenos">445</span></a>                  <span class="n">dv_pred1</span><span class="o">/</span><span class="n">varDF</span><span class="p">(</span><span class="n">Rpred</span><span class="p">[</span><span class="n">indxs1</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">indxs1</span><span class="p">])]</span>
</span><span id="binocular_model_performance-446"><a href="#binocular_model_performance-446"><span class="linenos">446</span></a>
</span><span id="binocular_model_performance-447"><a href="#binocular_model_performance-447"><span class="linenos">447</span></a>
</span><span id="binocular_model_performance-448"><a href="#binocular_model_performance-448"><span class="linenos">448</span></a>    <span class="c1">## Model-based performance measures - need cross-validation indices only</span>
</span><span id="binocular_model_performance-449"><a href="#binocular_model_performance-449"><span class="linenos">449</span></a>    <span class="k">if</span> <span class="n">valset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="binocular_model_performance-450"><a href="#binocular_model_performance-450"><span class="linenos">450</span></a>        <span class="n">v_inds</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">val_inds</span>
</span><span id="binocular_model_performance-451"><a href="#binocular_model_performance-451"><span class="linenos">451</span></a>    <span class="k">elif</span> <span class="n">valset</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">]:</span>
</span><span id="binocular_model_performance-452"><a href="#binocular_model_performance-452"><span class="linenos">452</span></a>        <span class="n">v_inds</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">val_indsA</span>
</span><span id="binocular_model_performance-453"><a href="#binocular_model_performance-453"><span class="linenos">453</span></a>        <span class="c1">#print( &#39;  Using val set A&#39;)</span>
</span><span id="binocular_model_performance-454"><a href="#binocular_model_performance-454"><span class="linenos">454</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="binocular_model_performance-455"><a href="#binocular_model_performance-455"><span class="linenos">455</span></a>        <span class="n">v_inds</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">val_indsB</span>
</span><span id="binocular_model_performance-456"><a href="#binocular_model_performance-456"><span class="linenos">456</span></a>        <span class="c1">#print( &#39;  Using val set B&#39;)</span>
</span><span id="binocular_model_performance-457"><a href="#binocular_model_performance-457"><span class="linenos">457</span></a>
</span><span id="binocular_model_performance-458"><a href="#binocular_model_performance-458"><span class="linenos">458</span></a>    <span class="c1">#indxs3xv = np.intersect1d( data.val_inds, indxs3 )</span>
</span><span id="binocular_model_performance-459"><a href="#binocular_model_performance-459"><span class="linenos">459</span></a>    <span class="c1">#indxs1xv = np.intersect1d( data.val_inds, indxs1 )</span>
</span><span id="binocular_model_performance-460"><a href="#binocular_model_performance-460"><span class="linenos">460</span></a>    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">rep_inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="binocular_model_performance-461"><a href="#binocular_model_performance-461"><span class="linenos">461</span></a>        <span class="n">allreps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">NT</span><span class="p">)</span>
</span><span id="binocular_model_performance-462"><a href="#binocular_model_performance-462"><span class="linenos">462</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="binocular_model_performance-463"><a href="#binocular_model_performance-463"><span class="linenos">463</span></a>        <span class="n">rep1inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">v_inds</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">rep_inds</span><span class="p">[</span><span class="n">cell_n</span><span class="p">][:,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="binocular_model_performance-464"><a href="#binocular_model_performance-464"><span class="linenos">464</span></a>        <span class="n">rep2inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">v_inds</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">rep_inds</span><span class="p">[</span><span class="n">cell_n</span><span class="p">][:,</span><span class="mi">1</span><span class="p">])</span>
</span><span id="binocular_model_performance-465"><a href="#binocular_model_performance-465"><span class="linenos">465</span></a>        <span class="n">allreps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">rep1inds</span><span class="p">,</span> <span class="n">rep2inds</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="binocular_model_performance-466"><a href="#binocular_model_performance-466"><span class="linenos">466</span></a>
</span><span id="binocular_model_performance-467"><a href="#binocular_model_performance-467"><span class="linenos">467</span></a>    <span class="n">indxs3xv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span> <span class="n">allreps</span><span class="p">,</span> <span class="n">indxs3</span> <span class="p">)</span>
</span><span id="binocular_model_performance-468"><a href="#binocular_model_performance-468"><span class="linenos">468</span></a>    <span class="n">indxs1xv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span> <span class="n">allreps</span><span class="p">,</span> <span class="n">indxs1</span> <span class="p">)</span>
</span><span id="binocular_model_performance-469"><a href="#binocular_model_performance-469"><span class="linenos">469</span></a>
</span><span id="binocular_model_performance-470"><a href="#binocular_model_performance-470"><span class="linenos">470</span></a>    <span class="c1">#DVfrac_mod_alt = [dv_mod/np.var(Rpred[indxs]), </span>
</span><span id="binocular_model_performance-471"><a href="#binocular_model_performance-471"><span class="linenos">471</span></a>    <span class="c1">#                  dv_pred3b/np.var(Rpred[indxs3]), </span>
</span><span id="binocular_model_performance-472"><a href="#binocular_model_performance-472"><span class="linenos">472</span></a>    <span class="c1">#                  dv_pred1b/np.var(Rpred[indxs1])]</span>
</span><span id="binocular_model_performance-473"><a href="#binocular_model_performance-473"><span class="linenos">473</span></a>    
</span><span id="binocular_model_performance-474"><a href="#binocular_model_performance-474"><span class="linenos">474</span></a>    <span class="c1"># Predictive powers (model performance): full response, fr3, fr1</span>
</span><span id="binocular_model_performance-475"><a href="#binocular_model_performance-475"><span class="linenos">475</span></a>    <span class="n">pps</span> <span class="o">=</span> <span class="p">[</span><span class="n">predictive_power</span><span class="p">(</span> <span class="n">Rpred</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">allreps</span> <span class="p">),</span>  <span class="c1"># predict variance of full response</span>
</span><span id="binocular_model_performance-476"><a href="#binocular_model_performance-476"><span class="linenos">476</span></a>           <span class="n">predictive_power</span><span class="p">(</span> <span class="n">Rpred</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">indxs3xv</span> <span class="p">),</span>
</span><span id="binocular_model_performance-477"><a href="#binocular_model_performance-477"><span class="linenos">477</span></a>           <span class="n">predictive_power</span><span class="p">(</span> <span class="n">Rpred</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">indxs1xv</span> <span class="p">)]</span>
</span><span id="binocular_model_performance-478"><a href="#binocular_model_performance-478"><span class="linenos">478</span></a>
</span><span id="binocular_model_performance-479"><a href="#binocular_model_performance-479"><span class="linenos">479</span></a>    <span class="n">Dpps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="binocular_model_performance-480"><a href="#binocular_model_performance-480"><span class="linenos">480</span></a>    <span class="c1">#Dpps[0] = 1-varDF(dobs0[data.val_inds]-dmod0[data.val_inds], df=df[data.val_inds]) / \</span>
</span><span id="binocular_model_performance-481"><a href="#binocular_model_performance-481"><span class="linenos">481</span></a>    <span class="c1">#    varDF(dobs0[data.val_inds], df=df[data.val_inds])</span>
</span><span id="binocular_model_performance-482"><a href="#binocular_model_performance-482"><span class="linenos">482</span></a>    <span class="c1">#Dpps[1] = 1-varDF(dobs3[indxs3xv]-dmod3[indxs3xv], df=df[indxs3xv]) / \</span>
</span><span id="binocular_model_performance-483"><a href="#binocular_model_performance-483"><span class="linenos">483</span></a>    <span class="c1">#    varDF(dobs3[indxs3xv], df=df[indxs3xv])</span>
</span><span id="binocular_model_performance-484"><a href="#binocular_model_performance-484"><span class="linenos">484</span></a>    <span class="c1">#Dpps[2] = 1-varDF(dobs1[indxs1xv]-dmod1[indxs1xv], df=df[indxs1xv]) / \</span>
</span><span id="binocular_model_performance-485"><a href="#binocular_model_performance-485"><span class="linenos">485</span></a>    <span class="c1">#    varDF(dobs1[indxs1xv], df=df[indxs1xv])</span>
</span><span id="binocular_model_performance-486"><a href="#binocular_model_performance-486"><span class="linenos">486</span></a>    <span class="n">dobs_only0</span> <span class="o">=</span> <span class="n">dobs0</span><span class="o">-</span><span class="n">tobs0</span>
</span><span id="binocular_model_performance-487"><a href="#binocular_model_performance-487"><span class="linenos">487</span></a>    <span class="n">dobs_only3</span> <span class="o">=</span> <span class="n">dobs3</span><span class="o">-</span><span class="n">tobs3</span>
</span><span id="binocular_model_performance-488"><a href="#binocular_model_performance-488"><span class="linenos">488</span></a>    <span class="n">dobs_only1</span> <span class="o">=</span> <span class="n">dobs1</span><span class="o">-</span><span class="n">tobs1</span>
</span><span id="binocular_model_performance-489"><a href="#binocular_model_performance-489"><span class="linenos">489</span></a>    <span class="n">dmod_only0</span> <span class="o">=</span> <span class="n">dmod0</span><span class="o">-</span><span class="n">tmod0</span>
</span><span id="binocular_model_performance-490"><a href="#binocular_model_performance-490"><span class="linenos">490</span></a>    <span class="n">dmod_only3</span> <span class="o">=</span> <span class="n">dmod3</span><span class="o">-</span><span class="n">tmod3</span>
</span><span id="binocular_model_performance-491"><a href="#binocular_model_performance-491"><span class="linenos">491</span></a>    <span class="n">dmod_only1</span> <span class="o">=</span> <span class="n">dmod1</span><span class="o">-</span><span class="n">tmod1</span>
</span><span id="binocular_model_performance-492"><a href="#binocular_model_performance-492"><span class="linenos">492</span></a>
</span><span id="binocular_model_performance-493"><a href="#binocular_model_performance-493"><span class="linenos">493</span></a>    <span class="n">Dpps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">varDF</span><span class="p">(</span><span class="n">dobs_only0</span><span class="p">[</span><span class="n">v_inds</span><span class="p">]</span><span class="o">-</span><span class="n">dmod_only0</span><span class="p">[</span><span class="n">v_inds</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">v_inds</span><span class="p">],</span> <span class="n">mean_adj</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">/</span> \
</span><span id="binocular_model_performance-494"><a href="#binocular_model_performance-494"><span class="linenos">494</span></a>        <span class="n">varDF</span><span class="p">(</span><span class="n">dobs_only0</span><span class="p">[</span><span class="n">v_inds</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">v_inds</span><span class="p">])</span>
</span><span id="binocular_model_performance-495"><a href="#binocular_model_performance-495"><span class="linenos">495</span></a>    <span class="n">Dpps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">varDF</span><span class="p">(</span><span class="n">dobs_only3</span><span class="p">[</span><span class="n">indxs3xv</span><span class="p">]</span><span class="o">-</span><span class="n">dmod_only3</span><span class="p">[</span><span class="n">indxs3xv</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">indxs3xv</span><span class="p">],</span> <span class="n">mean_adj</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">/</span> \
</span><span id="binocular_model_performance-496"><a href="#binocular_model_performance-496"><span class="linenos">496</span></a>        <span class="n">varDF</span><span class="p">(</span><span class="n">dobs_only3</span><span class="p">[</span><span class="n">indxs3xv</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">indxs3xv</span><span class="p">])</span>
</span><span id="binocular_model_performance-497"><a href="#binocular_model_performance-497"><span class="linenos">497</span></a>    <span class="n">Dpps</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">varDF</span><span class="p">(</span><span class="n">dobs_only1</span><span class="p">[</span><span class="n">indxs1xv</span><span class="p">]</span><span class="o">-</span><span class="n">dmod_only1</span><span class="p">[</span><span class="n">indxs1xv</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">indxs1xv</span><span class="p">],</span> <span class="n">mean_adj</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">/</span> \
</span><span id="binocular_model_performance-498"><a href="#binocular_model_performance-498"><span class="linenos">498</span></a>        <span class="n">varDF</span><span class="p">(</span><span class="n">dobs_only1</span><span class="p">[</span><span class="n">indxs1xv</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">indxs1xv</span><span class="p">])</span>
</span><span id="binocular_model_performance-499"><a href="#binocular_model_performance-499"><span class="linenos">499</span></a>
</span><span id="binocular_model_performance-500"><a href="#binocular_model_performance-500"><span class="linenos">500</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="binocular_model_performance-501"><a href="#binocular_model_performance-501"><span class="linenos">501</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Pred powers: </span><span class="si">%0.3f</span><span class="s2">  disp </span><span class="si">%0.3f</span><span class="s2"> (FR3 </span><span class="si">%0.3f</span><span class="s2">, FR1 </span><span class="si">%0.3f</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">pps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Dpps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Dpps</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Dpps</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span><span id="binocular_model_performance-502"><a href="#binocular_model_performance-502"><span class="linenos">502</span></a>
</span><span id="binocular_model_performance-503"><a href="#binocular_model_performance-503"><span class="linenos">503</span></a>    <span class="c1"># Add general tuning of each</span>
</span><span id="binocular_model_performance-504"><a href="#binocular_model_performance-504"><span class="linenos">504</span></a>    <span class="n">Dtun_obs</span> <span class="o">=</span> <span class="p">[</span><span class="n">disparity_tuning</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">],</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">3</span> <span class="p">),</span>
</span><span id="binocular_model_performance-505"><a href="#binocular_model_performance-505"><span class="linenos">505</span></a>                     <span class="n">disparity_tuning</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">robs</span><span class="p">[:,</span> <span class="n">cell_n</span><span class="p">],</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">1</span> <span class="p">)]</span>
</span><span id="binocular_model_performance-506"><a href="#binocular_model_performance-506"><span class="linenos">506</span></a>    <span class="n">Dtun_pred</span> <span class="o">=</span> <span class="p">[</span><span class="n">disparity_tuning</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">Rpred</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
</span><span id="binocular_model_performance-507"><a href="#binocular_model_performance-507"><span class="linenos">507</span></a>                      <span class="n">disparity_tuning</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">Rpred</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="n">cell_n</span><span class="p">,</span> <span class="n">fr1or3</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="binocular_model_performance-508"><a href="#binocular_model_performance-508"><span class="linenos">508</span></a>    <span class="c1"># Tuning curve consistency</span>
</span><span id="binocular_model_performance-509"><a href="#binocular_model_performance-509"><span class="linenos">509</span></a>    <span class="n">DtuningR2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">Dtun_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Dtun&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">Dtun_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Dtun&#39;</span><span class="p">]))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">Dtun_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Dtun&#39;</span><span class="p">]),</span>
</span><span id="binocular_model_performance-510"><a href="#binocular_model_performance-510"><span class="linenos">510</span></a>                 <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">Dtun_obs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Dtun&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">Dtun_pred</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Dtun&#39;</span><span class="p">]))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">Dtun_obs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Dtun&#39;</span><span class="p">])]</span>
</span><span id="binocular_model_performance-511"><a href="#binocular_model_performance-511"><span class="linenos">511</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="binocular_model_performance-512"><a href="#binocular_model_performance-512"><span class="linenos">512</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  Tuning consistency R2s: FR3 </span><span class="si">%0.3f</span><span class="s2">  FR1 </span><span class="si">%0.3f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">DtuningR2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">DtuningR2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="binocular_model_performance-513"><a href="#binocular_model_performance-513"><span class="linenos">513</span></a>
</span><span id="binocular_model_performance-514"><a href="#binocular_model_performance-514"><span class="linenos">514</span></a>    <span class="n">BMP</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;EVfrac&#39;</span><span class="p">:</span> <span class="n">ev</span><span class="o">/</span><span class="n">tv</span><span class="p">,</span> <span class="s1">&#39;EVvalid&#39;</span><span class="p">:</span> <span class="n">ev_valid</span><span class="p">,</span> 
</span><span id="binocular_model_performance-515"><a href="#binocular_model_performance-515"><span class="linenos">515</span></a>           <span class="s1">&#39;vars_obs&#39;</span><span class="p">:</span> <span class="n">vars_obs</span><span class="p">,</span> <span class="s1">&#39;vars_mod&#39;</span><span class="p">:</span> <span class="n">vars_mod</span><span class="p">,</span> <span class="s1">&#39;vars_obs_FR3&#39;</span><span class="p">:</span> <span class="n">vars_obs_FR3</span><span class="p">,</span>
</span><span id="binocular_model_performance-516"><a href="#binocular_model_performance-516"><span class="linenos">516</span></a>           <span class="s1">&#39;DVfrac_obs&#39;</span><span class="p">:</span> <span class="n">DVfrac_obs</span><span class="p">,</span> <span class="s1">&#39;DVfrac_mod&#39;</span><span class="p">:</span> <span class="n">DVfrac_mod</span><span class="p">,</span> 
</span><span id="binocular_model_performance-517"><a href="#binocular_model_performance-517"><span class="linenos">517</span></a>           <span class="s1">&#39;pred_powers&#39;</span><span class="p">:</span> <span class="n">pps</span><span class="p">,</span> <span class="s1">&#39;disp_pred_powers&#39;</span><span class="p">:</span> <span class="n">Dpps</span><span class="p">,</span>
</span><span id="binocular_model_performance-518"><a href="#binocular_model_performance-518"><span class="linenos">518</span></a>           <span class="s1">&#39;Dtun_obs&#39;</span><span class="p">:</span> <span class="n">Dtun_obs</span><span class="p">,</span> <span class="s1">&#39;Dtun_pred&#39;</span><span class="p">:</span> <span class="n">Dtun_pred</span><span class="p">,</span> <span class="s1">&#39;DtuningR2&#39;</span><span class="p">:</span> <span class="n">DtuningR2</span><span class="p">}</span>
</span><span id="binocular_model_performance-519"><a href="#binocular_model_performance-519"><span class="linenos">519</span></a>    
</span><span id="binocular_model_performance-520"><a href="#binocular_model_performance-520"><span class="linenos">520</span></a>    <span class="k">return</span> <span class="n">BMP</span>
</span></pre></div>


            <div class="docstring"><p>Current best-practices for generating prediction quality of neuron and binocular tuning. Currently we
are not worried about using cross-validation indices only (as they are based on much less data and tend to
otherwise be in agreement with full measures, but this option could be added in later versions.
valset can be None (use all val_inds, 'a' or 'b': use subset)</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>data:</strong>  binocular dataset (NTdatasets.binocular.single)</li>
<li><strong>cell_n:</strong>  cell number (in python numbering, i.e. starting with 0)</li>
<li><strong>Rpred:</strong>  predicted response of the model</li>
<li><strong>valset:</strong>  which validation set to use (None, 'a', 'b')</li>
<li><strong>verbose:</strong>  whether to print out results</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>BMP: dictionary with all the information about the binocular model performance</p>
</blockquote>
</div>


                </section>
                <section id="compute_mfilters">
                            <input id="compute_mfilters-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_mfilters</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">mod</span>, </span><span class="param"><span class="n">tkerns</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="compute_mfilters-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#compute_mfilters"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="compute_mfilters-694"><a href="#compute_mfilters-694"><span class="linenos">694</span></a><span class="k">def</span> <span class="nf">compute_mfilters</span><span class="p">(</span> <span class="n">mod</span><span class="p">,</span> <span class="n">tkerns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="compute_mfilters-695"><a href="#compute_mfilters-695"><span class="linenos">695</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="compute_mfilters-696"><a href="#compute_mfilters-696"><span class="linenos">696</span></a><span class="sd">    Calculates the filters of the first (monocular) stage of model given tkerns</span>
</span><span id="compute_mfilters-697"><a href="#compute_mfilters-697"><span class="linenos">697</span></a>
</span><span id="compute_mfilters-698"><a href="#compute_mfilters-698"><span class="linenos">698</span></a><span class="sd">    Args: </span>
</span><span id="compute_mfilters-699"><a href="#compute_mfilters-699"><span class="linenos">699</span></a><span class="sd">        mod: binocular model with monocular subspace and implicit temporal basis embedded in stim</span>
</span><span id="compute_mfilters-700"><a href="#compute_mfilters-700"><span class="linenos">700</span></a><span class="sd">        tkerns: temporal kernels, if none (default) than just returns first layer (but shouldn&#39;t)</span>
</span><span id="compute_mfilters-701"><a href="#compute_mfilters-701"><span class="linenos">701</span></a>
</span><span id="compute_mfilters-702"><a href="#compute_mfilters-702"><span class="linenos">702</span></a><span class="sd">    Returns:</span>
</span><span id="compute_mfilters-703"><a href="#compute_mfilters-703"><span class="linenos">703</span></a><span class="sd">        mfilts: 3-d array space x lags x number of filters</span>
</span><span id="compute_mfilters-704"><a href="#compute_mfilters-704"><span class="linenos">704</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="compute_mfilters-705"><a href="#compute_mfilters-705"><span class="linenos">705</span></a>    <span class="k">assert</span> <span class="n">tkerns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;No temporal basis specified.&quot;</span>
</span><span id="compute_mfilters-706"><a href="#compute_mfilters-706"><span class="linenos">706</span></a>    <span class="n">k</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
</span><span id="compute_mfilters-707"><a href="#compute_mfilters-707"><span class="linenos">707</span></a>    <span class="k">if</span> <span class="n">tkerns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="compute_mfilters-708"><a href="#compute_mfilters-708"><span class="linenos">708</span></a>        <span class="n">mfilts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;tc,xcf-&gt;xtf&#39;</span><span class="p">,</span> <span class="n">tkerns</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</span><span id="compute_mfilters-709"><a href="#compute_mfilters-709"><span class="linenos">709</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="compute_mfilters-710"><a href="#compute_mfilters-710"><span class="linenos">710</span></a>        <span class="nb">print</span><span class="p">(</span>  <span class="s2">&quot;Warning: no temporal kernels specified, just using get_weights()&quot;</span> <span class="p">)</span>
</span><span id="compute_mfilters-711"><a href="#compute_mfilters-711"><span class="linenos">711</span></a>        <span class="n">mfilts</span> <span class="o">=</span> <span class="n">k</span>    
</span><span id="compute_mfilters-712"><a href="#compute_mfilters-712"><span class="linenos">712</span></a>    <span class="k">return</span> <span class="n">mfilts</span>
</span></pre></div>


            <div class="docstring"><p>Calculates the filters of the first (monocular) stage of model given tkerns</p>

<p>Args: 
    mod: binocular model with monocular subspace and implicit temporal basis embedded in stim
    tkerns: temporal kernels, if none (default) than just returns first layer (but shouldn't)</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>mfilts: 3-d array space x lags x number of filters</p>
</blockquote>
</div>


                </section>
                <section id="compute_binocular_filters_old">
                            <input id="compute_binocular_filters_old-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_binocular_filters_old</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">binoc_mod</span>,</span><span class="param">	<span class="n">to_plot</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">cmap</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">time_reverse</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">num_space</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">ffnet_n</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">mfilters</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="compute_binocular_filters_old-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#compute_binocular_filters_old"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="compute_binocular_filters_old-562"><a href="#compute_binocular_filters_old-562"><span class="linenos">562</span></a><span class="k">def</span> <span class="nf">compute_binocular_filters_old</span><span class="p">(</span><span class="n">binoc_mod</span><span class="p">,</span> <span class="n">to_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="compute_binocular_filters_old-563"><a href="#compute_binocular_filters_old-563"><span class="linenos">563</span></a>                              <span class="n">num_space</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ffnet_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mfilters</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="compute_binocular_filters_old-564"><a href="#compute_binocular_filters_old-564"><span class="linenos">564</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="compute_binocular_filters_old-565"><a href="#compute_binocular_filters_old-565"><span class="linenos">565</span></a><span class="sd">    Using standard binocular model, compute filters. defaults to first ffnet and</span>
</span><span id="compute_binocular_filters_old-566"><a href="#compute_binocular_filters_old-566"><span class="linenos">566</span></a><span class="sd">    num_space = 36. Set num_space=None to go to minimum given convolutional constraints</span>
</span><span id="compute_binocular_filters_old-567"><a href="#compute_binocular_filters_old-567"><span class="linenos">567</span></a><span class="sd">    -&gt; this is older function that might be outdated (see new function below)</span>
</span><span id="compute_binocular_filters_old-568"><a href="#compute_binocular_filters_old-568"><span class="linenos">568</span></a><span class="sd">    </span>
</span><span id="compute_binocular_filters_old-569"><a href="#compute_binocular_filters_old-569"><span class="linenos">569</span></a><span class="sd">    Args:</span>
</span><span id="compute_binocular_filters_old-570"><a href="#compute_binocular_filters_old-570"><span class="linenos">570</span></a><span class="sd">        binoc_mod: binocular model</span>
</span><span id="compute_binocular_filters_old-571"><a href="#compute_binocular_filters_old-571"><span class="linenos">571</span></a><span class="sd">        to_plot: whether to plot the filters</span>
</span><span id="compute_binocular_filters_old-572"><a href="#compute_binocular_filters_old-572"><span class="linenos">572</span></a><span class="sd">        cmap: colormap to use</span>
</span><span id="compute_binocular_filters_old-573"><a href="#compute_binocular_filters_old-573"><span class="linenos">573</span></a><span class="sd">        time_reverse: whether to reverse the time axis</span>
</span><span id="compute_binocular_filters_old-574"><a href="#compute_binocular_filters_old-574"><span class="linenos">574</span></a><span class="sd">        num_space: number of spatial dimensions to use</span>
</span><span id="compute_binocular_filters_old-575"><a href="#compute_binocular_filters_old-575"><span class="linenos">575</span></a><span class="sd">        ffnet_n: which feed-forward network to use</span>
</span><span id="compute_binocular_filters_old-576"><a href="#compute_binocular_filters_old-576"><span class="linenos">576</span></a><span class="sd">        mfilters: monocular filters to use (if None, will use first layer of model)</span>
</span><span id="compute_binocular_filters_old-577"><a href="#compute_binocular_filters_old-577"><span class="linenos">577</span></a>
</span><span id="compute_binocular_filters_old-578"><a href="#compute_binocular_filters_old-578"><span class="linenos">578</span></a><span class="sd">    Returns:</span>
</span><span id="compute_binocular_filters_old-579"><a href="#compute_binocular_filters_old-579"><span class="linenos">579</span></a><span class="sd">        bifilts: binocular filters</span>
</span><span id="compute_binocular_filters_old-580"><a href="#compute_binocular_filters_old-580"><span class="linenos">580</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="compute_binocular_filters_old-581"><a href="#compute_binocular_filters_old-581"><span class="linenos">581</span></a>
</span><span id="compute_binocular_filters_old-582"><a href="#compute_binocular_filters_old-582"><span class="linenos">582</span></a>    <span class="c1"># Find binocular layer within desired (or whole) model</span>
</span><span id="compute_binocular_filters_old-583"><a href="#compute_binocular_filters_old-583"><span class="linenos">583</span></a>    <span class="kn">from</span> <span class="nn">NDNT.modules.layers</span> <span class="kn">import</span> <span class="n">BiConvLayer1D</span><span class="p">,</span> <span class="n">BiSTconv1D</span> <span class="c1">#, ChannelConvLayer</span>
</span><span id="compute_binocular_filters_old-584"><a href="#compute_binocular_filters_old-584"><span class="linenos">584</span></a>
</span><span id="compute_binocular_filters_old-585"><a href="#compute_binocular_filters_old-585"><span class="linenos">585</span></a>    <span class="k">if</span> <span class="n">ffnet_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="compute_binocular_filters_old-586"><a href="#compute_binocular_filters_old-586"><span class="linenos">586</span></a>        <span class="n">networks_to_search</span> <span class="o">=</span> <span class="p">[</span><span class="n">ffnet_n</span><span class="p">]</span>
</span><span id="compute_binocular_filters_old-587"><a href="#compute_binocular_filters_old-587"><span class="linenos">587</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="compute_binocular_filters_old-588"><a href="#compute_binocular_filters_old-588"><span class="linenos">588</span></a>        <span class="n">networks_to_search</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">binoc_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">))</span>        
</span><span id="compute_binocular_filters_old-589"><a href="#compute_binocular_filters_old-589"><span class="linenos">589</span></a>    <span class="n">blayer</span><span class="p">,</span> <span class="n">bnet</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="compute_binocular_filters_old-590"><a href="#compute_binocular_filters_old-590"><span class="linenos">590</span></a>    <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="n">networks_to_search</span><span class="p">:</span>
</span><span id="compute_binocular_filters_old-591"><a href="#compute_binocular_filters_old-591"><span class="linenos">591</span></a>        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">binoc_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">)):</span>
</span><span id="compute_binocular_filters_old-592"><a href="#compute_binocular_filters_old-592"><span class="linenos">592</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binoc_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span> <span class="n">BiConvLayer1D</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binoc_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span> <span class="n">BiSTconv1D</span><span class="p">):</span> <span class="c1"># this is layer output to bi-layer</span>
</span><span id="compute_binocular_filters_old-593"><a href="#compute_binocular_filters_old-593"><span class="linenos">593</span></a>                <span class="k">if</span> <span class="n">nn</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">binoc_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="compute_binocular_filters_old-594"><a href="#compute_binocular_filters_old-594"><span class="linenos">594</span></a>                    <span class="n">bnet</span><span class="p">,</span> <span class="n">blayer</span> <span class="o">=</span> <span class="n">mm</span><span class="p">,</span> <span class="n">nn</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="compute_binocular_filters_old-595"><a href="#compute_binocular_filters_old-595"><span class="linenos">595</span></a>                <span class="k">elif</span> <span class="n">mm</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">binoc_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="compute_binocular_filters_old-596"><a href="#compute_binocular_filters_old-596"><span class="linenos">596</span></a>                    <span class="n">bnet</span><span class="p">,</span> <span class="n">blayer</span> <span class="o">=</span> <span class="n">mm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>  <span class="c1"># split in hierarchical network</span>
</span><span id="compute_binocular_filters_old-597"><a href="#compute_binocular_filters_old-597"><span class="linenos">597</span></a>    <span class="k">assert</span> <span class="n">blayer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;biconv layer not found&#39;</span>
</span><span id="compute_binocular_filters_old-598"><a href="#compute_binocular_filters_old-598"><span class="linenos">598</span></a>
</span><span id="compute_binocular_filters_old-599"><a href="#compute_binocular_filters_old-599"><span class="linenos">599</span></a>    <span class="k">if</span> <span class="n">mfilters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="compute_binocular_filters_old-600"><a href="#compute_binocular_filters_old-600"><span class="linenos">600</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">bnet</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">blayer</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span> <span class="c1"># then mfilters are just first layer</span>
</span><span id="compute_binocular_filters_old-601"><a href="#compute_binocular_filters_old-601"><span class="linenos">601</span></a>            <span class="n">mfilters</span> <span class="o">=</span> <span class="n">binoc_mod</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(</span><span class="n">time_reverse</span><span class="o">=</span><span class="n">time_reverse</span><span class="p">)</span>
</span><span id="compute_binocular_filters_old-602"><a href="#compute_binocular_filters_old-602"><span class="linenos">602</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># construct using tkerns</span>
</span><span id="compute_binocular_filters_old-603"><a href="#compute_binocular_filters_old-603"><span class="linenos">603</span></a>            <span class="n">mfilters</span> <span class="o">=</span> <span class="n">compute_mfilters</span><span class="p">(</span><span class="n">mod</span><span class="o">=</span><span class="n">binoc_mod</span><span class="p">,</span> <span class="n">to_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">to_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
</span><span id="compute_binocular_filters_old-604"><a href="#compute_binocular_filters_old-604"><span class="linenos">604</span></a>            <span class="k">if</span> <span class="n">time_reverse</span><span class="p">:</span>
</span><span id="compute_binocular_filters_old-605"><a href="#compute_binocular_filters_old-605"><span class="linenos">605</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: time_reverse not implemented in this case.&#39;</span><span class="p">)</span>
</span><span id="compute_binocular_filters_old-606"><a href="#compute_binocular_filters_old-606"><span class="linenos">606</span></a>    <span class="n">NXM</span><span class="p">,</span> <span class="n">num_lags</span><span class="p">,</span> <span class="n">NF</span> <span class="o">=</span> <span class="n">mfilters</span><span class="o">.</span><span class="n">shape</span>
</span><span id="compute_binocular_filters_old-607"><a href="#compute_binocular_filters_old-607"><span class="linenos">607</span></a>    <span class="c1">#print(NXM, num_lags, NF)</span>
</span><span id="compute_binocular_filters_old-608"><a href="#compute_binocular_filters_old-608"><span class="linenos">608</span></a>    <span class="n">ws</span> <span class="o">=</span> <span class="n">binoc_mod</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(</span><span class="n">ffnet_target</span><span class="o">=</span><span class="n">bnet</span><span class="p">,</span> <span class="n">layer_target</span><span class="o">=</span><span class="n">blayer</span><span class="p">)</span>
</span><span id="compute_binocular_filters_old-609"><a href="#compute_binocular_filters_old-609"><span class="linenos">609</span></a>    <span class="n">NF2</span><span class="p">,</span> <span class="n">NXC</span><span class="p">,</span> <span class="n">NBF</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">shape</span> 
</span><span id="compute_binocular_filters_old-610"><a href="#compute_binocular_filters_old-610"><span class="linenos">610</span></a>    <span class="n">num_cspace</span> <span class="o">=</span> <span class="n">NXM</span><span class="o">+</span><span class="n">NXC</span><span class="o">-</span><span class="mi">1</span>
</span><span id="compute_binocular_filters_old-611"><a href="#compute_binocular_filters_old-611"><span class="linenos">611</span></a>
</span><span id="compute_binocular_filters_old-612"><a href="#compute_binocular_filters_old-612"><span class="linenos">612</span></a>    <span class="n">eye_filts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">num_cspace</span><span class="p">,</span> <span class="n">num_lags</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NBF</span><span class="p">])</span>
</span><span id="compute_binocular_filters_old-613"><a href="#compute_binocular_filters_old-613"><span class="linenos">613</span></a>
</span><span id="compute_binocular_filters_old-614"><a href="#compute_binocular_filters_old-614"><span class="linenos">614</span></a>    <span class="c1">#if isinstance(binoc_mod.networks[bnet].layers[blayer], ChannelConvLayer):</span>
</span><span id="compute_binocular_filters_old-615"><a href="#compute_binocular_filters_old-615"><span class="linenos">615</span></a>        <span class="c1">#print(&#39;Input filters:&#39;, NXM, NF)</span>
</span><span id="compute_binocular_filters_old-616"><a href="#compute_binocular_filters_old-616"><span class="linenos">616</span></a>        <span class="c1">#print(NF2, &#39;weights per binocular filter, LRLR -&gt;&#39;, NF2//2, &#39;monocular filters involved&#39;)</span>
</span><span id="compute_binocular_filters_old-617"><a href="#compute_binocular_filters_old-617"><span class="linenos">617</span></a>        <span class="c1">#print(NXM,NXC,num_cspace)</span>
</span><span id="compute_binocular_filters_old-618"><a href="#compute_binocular_filters_old-618"><span class="linenos">618</span></a>    <span class="c1">#    assert (NF2//2)*NBF == NF, &quot;ChannelConv monocular filter mismatch&quot;</span>
</span><span id="compute_binocular_filters_old-619"><a href="#compute_binocular_filters_old-619"><span class="linenos">619</span></a>    <span class="c1">#    for ff in range(NBF):</span>
</span><span id="compute_binocular_filters_old-620"><a href="#compute_binocular_filters_old-620"><span class="linenos">620</span></a>    <span class="c1">#        frange = (NF2//2)*ff + np.arange(NF2//2) </span>
</span><span id="compute_binocular_filters_old-621"><a href="#compute_binocular_filters_old-621"><span class="linenos">621</span></a>    <span class="c1">#        for xx in range(NXC):</span>
</span><span id="compute_binocular_filters_old-622"><a href="#compute_binocular_filters_old-622"><span class="linenos">622</span></a>    <span class="c1">#            for eye in range(2):</span>
</span><span id="compute_binocular_filters_old-623"><a href="#compute_binocular_filters_old-623"><span class="linenos">623</span></a>    <span class="c1">#                eye_filts[np.arange(NXM)+xx, :, eye, ff] += np.einsum(</span>
</span><span id="compute_binocular_filters_old-624"><a href="#compute_binocular_filters_old-624"><span class="linenos">624</span></a>    <span class="c1">#                    &#39;xtm,m-&gt;xt&#39;, mfilters[:, :, frange], ws[np.arange(eye,NF2,2), xx, ff] )</span>
</span><span id="compute_binocular_filters_old-625"><a href="#compute_binocular_filters_old-625"><span class="linenos">625</span></a>                    <span class="c1">#eye_filts[np.arange(NXM)+xx, :, eye, ff] += mfilters[:, :, frange+eye] @ ws[np.arange(eye,NF2,2), xx, ff][:,None,None]</span>
</span><span id="compute_binocular_filters_old-626"><a href="#compute_binocular_filters_old-626"><span class="linenos">626</span></a>    <span class="c1">#else: # Standard</span>
</span><span id="compute_binocular_filters_old-627"><a href="#compute_binocular_filters_old-627"><span class="linenos">627</span></a>    <span class="k">assert</span> <span class="n">NF2</span> <span class="o">==</span> <span class="mi">2</span><span class="o">*</span><span class="n">NF</span><span class="p">,</span> <span class="s2">&quot;Monocular filter number mismatch&quot;</span>
</span><span id="compute_binocular_filters_old-628"><a href="#compute_binocular_filters_old-628"><span class="linenos">628</span></a>    <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NXC</span><span class="p">):</span>
</span><span id="compute_binocular_filters_old-629"><a href="#compute_binocular_filters_old-629"><span class="linenos">629</span></a>        <span class="k">for</span> <span class="n">eye</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="compute_binocular_filters_old-630"><a href="#compute_binocular_filters_old-630"><span class="linenos">630</span></a>            <span class="n">eye_filts</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NXM</span><span class="p">)</span><span class="o">+</span><span class="n">xx</span><span class="p">,</span> <span class="p">:,</span> <span class="n">eye</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span>
</span><span id="compute_binocular_filters_old-631"><a href="#compute_binocular_filters_old-631"><span class="linenos">631</span></a>                <span class="s1">&#39;xtm,mf-&gt;xtf&#39;</span><span class="p">,</span> <span class="n">mfilters</span><span class="p">,</span> <span class="n">ws</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">eye</span><span class="p">,</span><span class="n">NF2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">xx</span><span class="p">,</span> <span class="p">:]</span> <span class="p">)</span>
</span><span id="compute_binocular_filters_old-632"><a href="#compute_binocular_filters_old-632"><span class="linenos">632</span></a>                <span class="c1">#&#39;xtm,mf-&gt;xtf&#39;, mfilters, ws[np.arange(NF)+eye*NF, xx, :] )</span>
</span><span id="compute_binocular_filters_old-633"><a href="#compute_binocular_filters_old-633"><span class="linenos">633</span></a>    <span class="k">if</span> <span class="n">num_space</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="compute_binocular_filters_old-634"><a href="#compute_binocular_filters_old-634"><span class="linenos">634</span></a>        <span class="c1"># Cast into desired num_space</span>
</span><span id="compute_binocular_filters_old-635"><a href="#compute_binocular_filters_old-635"><span class="linenos">635</span></a>        <span class="n">num_space</span> <span class="o">=</span> <span class="n">num_cspace</span>
</span><span id="compute_binocular_filters_old-636"><a href="#compute_binocular_filters_old-636"><span class="linenos">636</span></a>    <span class="k">if</span> <span class="n">num_space</span> <span class="o">==</span> <span class="n">num_cspace</span><span class="p">:</span>
</span><span id="compute_binocular_filters_old-637"><a href="#compute_binocular_filters_old-637"><span class="linenos">637</span></a>        <span class="n">Bfilts</span> <span class="o">=</span> <span class="n">eye_filts</span>
</span><span id="compute_binocular_filters_old-638"><a href="#compute_binocular_filters_old-638"><span class="linenos">638</span></a>    <span class="k">elif</span> <span class="n">num_space</span> <span class="o">&gt;</span> <span class="n">num_cspace</span><span class="p">:</span>
</span><span id="compute_binocular_filters_old-639"><a href="#compute_binocular_filters_old-639"><span class="linenos">639</span></a>        <span class="n">Bfilts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">num_space</span><span class="p">,</span> <span class="n">num_lags</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NBF</span><span class="p">])</span>
</span><span id="compute_binocular_filters_old-640"><a href="#compute_binocular_filters_old-640"><span class="linenos">640</span></a>        <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_space</span><span class="o">-</span><span class="n">num_cspace</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="compute_binocular_filters_old-641"><a href="#compute_binocular_filters_old-641"><span class="linenos">641</span></a>        <span class="n">Bfilts</span><span class="p">[</span><span class="n">padding</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_cspace</span><span class="p">),</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">eye_filts</span>
</span><span id="compute_binocular_filters_old-642"><a href="#compute_binocular_filters_old-642"><span class="linenos">642</span></a>    <span class="k">else</span><span class="p">:</span>  <span class="c1"># crop</span>
</span><span id="compute_binocular_filters_old-643"><a href="#compute_binocular_filters_old-643"><span class="linenos">643</span></a>        <span class="n">unpadding</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_cspace</span><span class="o">-</span><span class="n">num_space</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="compute_binocular_filters_old-644"><a href="#compute_binocular_filters_old-644"><span class="linenos">644</span></a>        <span class="n">Bfilts</span> <span class="o">=</span> <span class="n">eye_filts</span><span class="p">[</span><span class="n">unpadding</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_space</span><span class="p">),</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="compute_binocular_filters_old-645"><a href="#compute_binocular_filters_old-645"><span class="linenos">645</span></a>
</span><span id="compute_binocular_filters_old-646"><a href="#compute_binocular_filters_old-646"><span class="linenos">646</span></a>    <span class="n">bifilts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Bfilts</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Bfilts</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="compute_binocular_filters_old-647"><a href="#compute_binocular_filters_old-647"><span class="linenos">647</span></a>    <span class="k">if</span> <span class="n">to_plot</span><span class="p">:</span>
</span><span id="compute_binocular_filters_old-648"><a href="#compute_binocular_filters_old-648"><span class="linenos">648</span></a>        <span class="kn">from</span> <span class="nn">NDNT.utils</span> <span class="kn">import</span> <span class="n">plot_filters_ST1D</span>
</span><span id="compute_binocular_filters_old-649"><a href="#compute_binocular_filters_old-649"><span class="linenos">649</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binoc_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">bnet</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">blayer</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">BiSTconv1D</span><span class="p">):</span>
</span><span id="compute_binocular_filters_old-650"><a href="#compute_binocular_filters_old-650"><span class="linenos">650</span></a>            <span class="n">bifilts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">bifilts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Then time-reverse </span>
</span><span id="compute_binocular_filters_old-651"><a href="#compute_binocular_filters_old-651"><span class="linenos">651</span></a>        <span class="n">plot_filters_ST1D</span><span class="p">(</span> <span class="n">bifilts</span><span class="p">,</span> <span class="n">num_cols</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="p">)</span>
</span><span id="compute_binocular_filters_old-652"><a href="#compute_binocular_filters_old-652"><span class="linenos">652</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="compute_binocular_filters_old-653"><a href="#compute_binocular_filters_old-653"><span class="linenos">653</span></a>        <span class="k">return</span> <span class="n">bifilts</span>
</span></pre></div>


            <div class="docstring"><p>Using standard binocular model, compute filters. defaults to first ffnet and
num_space = 36. Set num_space=None to go to minimum given convolutional constraints
-> this is older function that might be outdated (see new function below)</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>binoc_mod:</strong>  binocular model</li>
<li><strong>to_plot:</strong>  whether to plot the filters</li>
<li><strong>cmap:</strong>  colormap to use</li>
<li><strong>time_reverse:</strong>  whether to reverse the time axis</li>
<li><strong>num_space:</strong>  number of spatial dimensions to use</li>
<li><strong>ffnet_n:</strong>  which feed-forward network to use</li>
<li><strong>mfilters:</strong>  monocular filters to use (if None, will use first layer of model)</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>bifilts: binocular filters</p>
</blockquote>
</div>


                </section>
                <section id="plot_sico_readout">
                            <input id="plot_sico_readout-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_sico_readout</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">sico</span>, </span><span class="param"><span class="n">cell_n</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">rh</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">row_mult</span><span class="o">=</span><span class="mf">0.2</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="plot_sico_readout-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_sico_readout"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_sico_readout-656"><a href="#plot_sico_readout-656"><span class="linenos">656</span></a><span class="k">def</span> <span class="nf">plot_sico_readout</span><span class="p">(</span> <span class="n">sico</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">row_mult</span><span class="o">=</span><span class="mf">0.2</span> <span class="p">):</span>
</span><span id="plot_sico_readout-657"><a href="#plot_sico_readout-657"><span class="linenos">657</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="plot_sico_readout-658"><a href="#plot_sico_readout-658"><span class="linenos">658</span></a><span class="sd">    Plot the readout weights of the SICO model</span>
</span><span id="plot_sico_readout-659"><a href="#plot_sico_readout-659"><span class="linenos">659</span></a>
</span><span id="plot_sico_readout-660"><a href="#plot_sico_readout-660"><span class="linenos">660</span></a><span class="sd">    Args:</span>
</span><span id="plot_sico_readout-661"><a href="#plot_sico_readout-661"><span class="linenos">661</span></a><span class="sd">        sico: SICO model</span>
</span><span id="plot_sico_readout-662"><a href="#plot_sico_readout-662"><span class="linenos">662</span></a><span class="sd">        cell_n: select which clone to plot if clone model (default: None, assumes single model)</span>
</span><span id="plot_sico_readout-663"><a href="#plot_sico_readout-663"><span class="linenos">663</span></a><span class="sd">        rh: height of plot, overriding scaling-per line (row_mult) (default: None)</span>
</span><span id="plot_sico_readout-664"><a href="#plot_sico_readout-664"><span class="linenos">664</span></a><span class="sd">        row_mult: normal way to determine depth of plot: inches per line (default: 0.4)</span>
</span><span id="plot_sico_readout-665"><a href="#plot_sico_readout-665"><span class="linenos">665</span></a>
</span><span id="plot_sico_readout-666"><a href="#plot_sico_readout-666"><span class="linenos">666</span></a><span class="sd">    Returns:</span>
</span><span id="plot_sico_readout-667"><a href="#plot_sico_readout-667"><span class="linenos">667</span></a><span class="sd">        None</span>
</span><span id="plot_sico_readout-668"><a href="#plot_sico_readout-668"><span class="linenos">668</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="plot_sico_readout-669"><a href="#plot_sico_readout-669"><span class="linenos">669</span></a>    <span class="kn">from</span> <span class="nn">NDNT.utils</span> <span class="kn">import</span> <span class="n">imagesc</span>
</span><span id="plot_sico_readout-670"><a href="#plot_sico_readout-670"><span class="linenos">670</span></a>    <span class="k">if</span> <span class="n">cell_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="plot_sico_readout-671"><a href="#plot_sico_readout-671"><span class="linenos">671</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">sico</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</span><span id="plot_sico_readout-672"><a href="#plot_sico_readout-672"><span class="linenos">672</span></a>        <span class="k">if</span> <span class="n">sico</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="plot_sico_readout-673"><a href="#plot_sico_readout-673"><span class="linenos">673</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span>
</span><span id="plot_sico_readout-674"><a href="#plot_sico_readout-674"><span class="linenos">674</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="plot_sico_readout-675"><a href="#plot_sico_readout-675"><span class="linenos">675</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">sico</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="o">...</span><span class="p">,</span> <span class="n">cell_n</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
</span><span id="plot_sico_readout-676"><a href="#plot_sico_readout-676"><span class="linenos">676</span></a>    <span class="n">NF</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="plot_sico_readout-677"><a href="#plot_sico_readout-677"><span class="linenos">677</span></a>    <span class="n">NI</span> <span class="o">=</span> <span class="n">sico</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">num_inh</span>
</span><span id="plot_sico_readout-678"><a href="#plot_sico_readout-678"><span class="linenos">678</span></a>    <span class="n">NE</span> <span class="o">=</span> <span class="n">NF</span><span class="o">-</span><span class="n">NI</span>
</span><span id="plot_sico_readout-679"><a href="#plot_sico_readout-679"><span class="linenos">679</span></a>    <span class="n">w</span><span class="p">[:,</span> <span class="n">NE</span><span class="p">:]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="plot_sico_readout-680"><a href="#plot_sico_readout-680"><span class="linenos">680</span></a>
</span><span id="plot_sico_readout-681"><a href="#plot_sico_readout-681"><span class="linenos">681</span></a>    <span class="k">if</span> <span class="n">rh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="plot_sico_readout-682"><a href="#plot_sico_readout-682"><span class="linenos">682</span></a>        <span class="n">rh</span> <span class="o">=</span> <span class="n">row_mult</span><span class="o">*</span><span class="n">NF</span><span class="o">+</span><span class="mf">0.55</span> <span class="c1">#np.minimum(0.4*NF,2)</span>
</span><span id="plot_sico_readout-683"><a href="#plot_sico_readout-683"><span class="linenos">683</span></a>        <span class="c1"># added 0.55 is estimated size of x-axis ticks and other vertical space</span>
</span><span id="plot_sico_readout-684"><a href="#plot_sico_readout-684"><span class="linenos">684</span></a>    <span class="k">if</span> <span class="n">cell_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="plot_sico_readout-685"><a href="#plot_sico_readout-685"><span class="linenos">685</span></a>        <span class="n">utils</span><span class="o">.</span><span class="n">subplot_setup</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">row_height</span><span class="o">=</span><span class="n">rh</span><span class="p">,</span> <span class="n">fig_width</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</span><span id="plot_sico_readout-686"><a href="#plot_sico_readout-686"><span class="linenos">686</span></a>
</span><span id="plot_sico_readout-687"><a href="#plot_sico_readout-687"><span class="linenos">687</span></a>    <span class="n">imagesc</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">balanced</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="plot_sico_readout-688"><a href="#plot_sico_readout-688"><span class="linenos">688</span></a>    <span class="k">if</span> <span class="n">cell_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="plot_sico_readout-689"><a href="#plot_sico_readout-689"><span class="linenos">689</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Plot the readout weights of the SICO model</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>sico:</strong>  SICO model</li>
<li><strong>cell_n:</strong>  select which clone to plot if clone model (default: None, assumes single model)</li>
<li><strong>rh:</strong>  height of plot, overriding scaling-per line (row_mult) (default: None)</li>
<li><strong>row_mult:</strong>  normal way to determine depth of plot: inches per line (default: 0.4)</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                </section>
                <section id="dist_mean">
                            <input id="dist_mean-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">dist_mean</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">p</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="dist_mean-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#dist_mean"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="dist_mean-716"><a href="#dist_mean-716"><span class="linenos">716</span></a><span class="k">def</span> <span class="nf">dist_mean</span><span class="p">(</span> <span class="n">p</span> <span class="p">):</span>
</span><span id="dist_mean-717"><a href="#dist_mean-717"><span class="linenos">717</span></a>    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</span><span id="dist_mean-718"><a href="#dist_mean-718"><span class="linenos">718</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xs</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="compute_bfilters">
                            <input id="compute_bfilters-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_bfilters</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">binoc_mod</span>,</span><span class="param">	<span class="n">tkerns</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">width</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">newlags</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">skip_lags</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">center</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="compute_bfilters-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#compute_bfilters"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="compute_bfilters-721"><a href="#compute_bfilters-721"><span class="linenos">721</span></a><span class="k">def</span> <span class="nf">compute_bfilters</span><span class="p">(</span> <span class="n">binoc_mod</span><span class="p">,</span> <span class="n">tkerns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">newlags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_lags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="compute_bfilters-722"><a href="#compute_bfilters-722"><span class="linenos">722</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="compute_bfilters-723"><a href="#compute_bfilters-723"><span class="linenos">723</span></a><span class="sd">    Calculates binocular filter array for monocular-subspace model, including accounting for temporal kernels</span>
</span><span id="compute_bfilters-724"><a href="#compute_bfilters-724"><span class="linenos">724</span></a><span class="sd">    used to preprocess the input.</span>
</span><span id="compute_bfilters-725"><a href="#compute_bfilters-725"><span class="linenos">725</span></a><span class="sd">    Adjusts for skip_lags, although must enter by hand (default=0)</span>
</span><span id="compute_bfilters-726"><a href="#compute_bfilters-726"><span class="linenos">726</span></a><span class="sd">    </span>
</span><span id="compute_bfilters-727"><a href="#compute_bfilters-727"><span class="linenos">727</span></a><span class="sd">    Args:</span>
</span><span id="compute_bfilters-728"><a href="#compute_bfilters-728"><span class="linenos">728</span></a><span class="sd">        binoc_mod: assumes temporal kernels processing input, and monocular subspace before binocular filters</span>
</span><span id="compute_bfilters-729"><a href="#compute_bfilters-729"><span class="linenos">729</span></a><span class="sd">        tkerns: temporal kernels that pre-processed stimulus</span>
</span><span id="compute_bfilters-730"><a href="#compute_bfilters-730"><span class="linenos">730</span></a><span class="sd">        width: how wide each monocular filter should be displayed: its convolutional so not set. Default</span>
</span><span id="compute_bfilters-731"><a href="#compute_bfilters-731"><span class="linenos">731</span></a><span class="sd">               is based on model itself: monocular filter with plus what binocular convolutions brings</span>
</span><span id="compute_bfilters-732"><a href="#compute_bfilters-732"><span class="linenos">732</span></a><span class="sd">        newlags: lags past what is given by filter (default none)</span>
</span><span id="compute_bfilters-733"><a href="#compute_bfilters-733"><span class="linenos">733</span></a><span class="sd">        center: centers each binocular filter based on mean temporal power (since it will be convolved too)</span>
</span><span id="compute_bfilters-734"><a href="#compute_bfilters-734"><span class="linenos">734</span></a><span class="sd">    </span>
</span><span id="compute_bfilters-735"><a href="#compute_bfilters-735"><span class="linenos">735</span></a><span class="sd">    Returns:</span>
</span><span id="compute_bfilters-736"><a href="#compute_bfilters-736"><span class="linenos">736</span></a><span class="sd">        eye_filts: binocular filters by eye with dims [2, width, lags, num_filters]        </span>
</span><span id="compute_bfilters-737"><a href="#compute_bfilters-737"><span class="linenos">737</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="compute_bfilters-738"><a href="#compute_bfilters-738"><span class="linenos">738</span></a>
</span><span id="compute_bfilters-739"><a href="#compute_bfilters-739"><span class="linenos">739</span></a>    <span class="k">if</span> <span class="n">tkerns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="compute_bfilters-740"><a href="#compute_bfilters-740"><span class="linenos">740</span></a>        <span class="n">mfilters</span> <span class="o">=</span> <span class="n">binoc_mod</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(</span><span class="n">layer_target</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="compute_bfilters-741"><a href="#compute_bfilters-741"><span class="linenos">741</span></a>        <span class="k">if</span> <span class="n">skip_lags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="compute_bfilters-742"><a href="#compute_bfilters-742"><span class="linenos">742</span></a>            <span class="n">mfilters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">mfilters</span><span class="p">,</span> <span class="n">skip_lags</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="compute_bfilters-743"><a href="#compute_bfilters-743"><span class="linenos">743</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="compute_bfilters-744"><a href="#compute_bfilters-744"><span class="linenos">744</span></a>        <span class="c1"># shift </span>
</span><span id="compute_bfilters-745"><a href="#compute_bfilters-745"><span class="linenos">745</span></a>        <span class="k">if</span> <span class="n">skip_lags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="compute_bfilters-746"><a href="#compute_bfilters-746"><span class="linenos">746</span></a>            <span class="n">tks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">tkerns</span><span class="p">,</span> <span class="n">skip_lags</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="compute_bfilters-747"><a href="#compute_bfilters-747"><span class="linenos">747</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="compute_bfilters-748"><a href="#compute_bfilters-748"><span class="linenos">748</span></a>            <span class="n">tks</span> <span class="o">=</span> <span class="n">tkerns</span>
</span><span id="compute_bfilters-749"><a href="#compute_bfilters-749"><span class="linenos">749</span></a>        <span class="n">mfilters</span> <span class="o">=</span> <span class="n">compute_mfilters</span><span class="p">(</span><span class="n">binoc_mod</span><span class="p">,</span> <span class="n">tkerns</span><span class="o">=</span><span class="n">tks</span><span class="p">)</span>
</span><span id="compute_bfilters-750"><a href="#compute_bfilters-750"><span class="linenos">750</span></a>    
</span><span id="compute_bfilters-751"><a href="#compute_bfilters-751"><span class="linenos">751</span></a>    <span class="n">NXM</span><span class="p">,</span> <span class="n">num_lags</span><span class="p">,</span> <span class="n">NF</span> <span class="o">=</span> <span class="n">mfilters</span><span class="o">.</span><span class="n">shape</span>
</span><span id="compute_bfilters-752"><a href="#compute_bfilters-752"><span class="linenos">752</span></a>    <span class="k">if</span> <span class="n">newlags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="compute_bfilters-753"><a href="#compute_bfilters-753"><span class="linenos">753</span></a>        <span class="n">newlags</span> <span class="o">=</span> <span class="n">num_lags</span>
</span><span id="compute_bfilters-754"><a href="#compute_bfilters-754"><span class="linenos">754</span></a>
</span><span id="compute_bfilters-755"><a href="#compute_bfilters-755"><span class="linenos">755</span></a>    <span class="n">ws</span> <span class="o">=</span> <span class="n">binoc_mod</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(</span><span class="n">ffnet_target</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">layer_target</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="compute_bfilters-756"><a href="#compute_bfilters-756"><span class="linenos">756</span></a>    <span class="n">NF2</span><span class="p">,</span> <span class="n">NXC</span><span class="p">,</span> <span class="n">NBF</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">shape</span> 
</span><span id="compute_bfilters-757"><a href="#compute_bfilters-757"><span class="linenos">757</span></a>    <span class="n">num_cspace</span> <span class="o">=</span> <span class="n">NXM</span><span class="o">+</span><span class="n">NXC</span><span class="o">-</span><span class="mi">1</span>
</span><span id="compute_bfilters-758"><a href="#compute_bfilters-758"><span class="linenos">758</span></a>    <span class="c1">#print(&#39;top&#39;, NF2, NXC, NBF, num_cspace)</span>
</span><span id="compute_bfilters-759"><a href="#compute_bfilters-759"><span class="linenos">759</span></a>    <span class="c1">#print(mfilters.shape, tkerns.shape, NXM)</span>
</span><span id="compute_bfilters-760"><a href="#compute_bfilters-760"><span class="linenos">760</span></a>    <span class="n">eye_filts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">num_cspace</span><span class="p">,</span> <span class="n">newlags</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NBF</span><span class="p">])</span>
</span><span id="compute_bfilters-761"><a href="#compute_bfilters-761"><span class="linenos">761</span></a>    <span class="k">assert</span> <span class="n">NF2</span> <span class="o">==</span> <span class="mi">2</span><span class="o">*</span><span class="n">NF</span><span class="p">,</span> <span class="s2">&quot;Monocular filter number mismatch&quot;</span>
</span><span id="compute_bfilters-762"><a href="#compute_bfilters-762"><span class="linenos">762</span></a>    <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NXC</span><span class="p">):</span>
</span><span id="compute_bfilters-763"><a href="#compute_bfilters-763"><span class="linenos">763</span></a>        <span class="k">for</span> <span class="n">eye</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="compute_bfilters-764"><a href="#compute_bfilters-764"><span class="linenos">764</span></a>            <span class="n">eye_filts</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NXM</span><span class="p">)</span><span class="o">+</span><span class="n">xx</span><span class="p">,</span> <span class="p">:,</span> <span class="n">eye</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span>
</span><span id="compute_bfilters-765"><a href="#compute_bfilters-765"><span class="linenos">765</span></a>                <span class="s1">&#39;xtm,mf-&gt;xtf&#39;</span><span class="p">,</span> <span class="n">mfilters</span><span class="p">[:,:</span><span class="n">newlags</span><span class="p">,:],</span> <span class="n">ws</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">eye</span><span class="p">,</span><span class="n">NF2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">xx</span><span class="p">,</span> <span class="p">:]</span> <span class="p">)</span><span class="c1">#[:, :newlags]</span>
</span><span id="compute_bfilters-766"><a href="#compute_bfilters-766"><span class="linenos">766</span></a>
</span><span id="compute_bfilters-767"><a href="#compute_bfilters-767"><span class="linenos">767</span></a>    <span class="k">if</span> <span class="n">center</span><span class="p">:</span>
</span><span id="compute_bfilters-768"><a href="#compute_bfilters-768"><span class="linenos">768</span></a>        <span class="n">sp_maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">eye_filts</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="compute_bfilters-769"><a href="#compute_bfilters-769"><span class="linenos">769</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NBF</span><span class="p">):</span>
</span><span id="compute_bfilters-770"><a href="#compute_bfilters-770"><span class="linenos">770</span></a>            <span class="n">sh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">num_cspace</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">dist_mean</span><span class="p">(</span><span class="n">sp_maps</span><span class="p">[:,</span><span class="n">ii</span><span class="p">])))</span>                
</span><span id="compute_bfilters-771"><a href="#compute_bfilters-771"><span class="linenos">771</span></a>            <span class="n">eye_filts</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">eye_filts</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">sh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="compute_bfilters-772"><a href="#compute_bfilters-772"><span class="linenos">772</span></a>
</span><span id="compute_bfilters-773"><a href="#compute_bfilters-773"><span class="linenos">773</span></a>    <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="compute_bfilters-774"><a href="#compute_bfilters-774"><span class="linenos">774</span></a>        <span class="n">width</span> <span class="o">=</span> <span class="n">num_cspace</span>
</span><span id="compute_bfilters-775"><a href="#compute_bfilters-775"><span class="linenos">775</span></a>    <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="n">num_cspace</span><span class="p">:</span>
</span><span id="compute_bfilters-776"><a href="#compute_bfilters-776"><span class="linenos">776</span></a>        <span class="n">shrinky</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_cspace</span><span class="o">-</span><span class="n">width</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
</span><span id="compute_bfilters-777"><a href="#compute_bfilters-777"><span class="linenos">777</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  shrinking width&#39;</span><span class="p">,</span> <span class="n">num_cspace</span><span class="p">,</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
</span><span id="compute_bfilters-778"><a href="#compute_bfilters-778"><span class="linenos">778</span></a>        <span class="n">eye_filts</span> <span class="o">=</span> <span class="n">eye_filts</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">width</span><span class="p">)</span><span class="o">+</span><span class="n">shrinky</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</span><span id="compute_bfilters-779"><a href="#compute_bfilters-779"><span class="linenos">779</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="compute_bfilters-780"><a href="#compute_bfilters-780"><span class="linenos">780</span></a>        <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">num_cspace</span><span class="p">:</span>
</span><span id="compute_bfilters-781"><a href="#compute_bfilters-781"><span class="linenos">781</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;width too large -- havent set up yet&#39;</span><span class="p">)</span>
</span><span id="compute_bfilters-782"><a href="#compute_bfilters-782"><span class="linenos">782</span></a>    
</span><span id="compute_bfilters-783"><a href="#compute_bfilters-783"><span class="linenos">783</span></a>    <span class="k">return</span> <span class="n">eye_filts</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Calculates binocular filter array for monocular-subspace model, including accounting for temporal kernels
used to preprocess the input.
Adjusts for skip_lags, although must enter by hand (default=0)</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>binoc_mod:</strong>  assumes temporal kernels processing input, and monocular subspace before binocular filters</li>
<li><strong>tkerns:</strong>  temporal kernels that pre-processed stimulus</li>
<li><strong>width:</strong>  how wide each monocular filter should be displayed: its convolutional so not set. Default
is based on model itself: monocular filter with plus what binocular convolutions brings</li>
<li><strong>newlags:</strong>  lags past what is given by filter (default none)</li>
<li><strong>center:</strong>  centers each binocular filter based on mean temporal power (since it will be convolved too)</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>eye_filts: binocular filters by eye with dims [2, width, lags, num_filters]</p>
</blockquote>
</div>


                </section>
                <section id="plot_mfilters">
                            <input id="plot_mfilters-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_mfilters</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">model</span>, </span><span class="param"><span class="n">tkerns</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">flip</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">axis_labels</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">max_lags</span><span class="o">=</span><span class="mi">12</span>, </span><span class="param"><span class="n">rh</span><span class="o">=</span><span class="mi">2</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="plot_mfilters-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_mfilters"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_mfilters-786"><a href="#plot_mfilters-786"><span class="linenos">786</span></a><span class="k">def</span> <span class="nf">plot_mfilters</span><span class="p">(</span> <span class="n">model</span><span class="p">,</span> <span class="n">tkerns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_lags</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">rh</span><span class="o">=</span><span class="mi">2</span> <span class="p">):</span>
</span><span id="plot_mfilters-787"><a href="#plot_mfilters-787"><span class="linenos">787</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="plot_mfilters-788"><a href="#plot_mfilters-788"><span class="linenos">788</span></a><span class="sd">    Plots mfilters (first-layer monocular filters) of sico models, using compute_mfilters to calcuate. </span>
</span><span id="plot_mfilters-789"><a href="#plot_mfilters-789"><span class="linenos">789</span></a>
</span><span id="plot_mfilters-790"><a href="#plot_mfilters-790"><span class="linenos">790</span></a><span class="sd">    Inputs:</span>
</span><span id="plot_mfilters-791"><a href="#plot_mfilters-791"><span class="linenos">791</span></a><span class="sd">        model: sico model to plot monocular filters of</span>
</span><span id="plot_mfilters-792"><a href="#plot_mfilters-792"><span class="linenos">792</span></a><span class="sd">        tkerns: temporal kernels used in sico model (default: None assumes no temporal filters used)</span>
</span><span id="plot_mfilters-793"><a href="#plot_mfilters-793"><span class="linenos">793</span></a><span class="sd">        flip: whether to have lag-0 at bottom and go up (default: flip=True) or opposite</span>
</span><span id="plot_mfilters-794"><a href="#plot_mfilters-794"><span class="linenos">794</span></a><span class="sd">        axis_labels: whether to display axis_labels (default: False=No)</span>
</span><span id="plot_mfilters-795"><a href="#plot_mfilters-795"><span class="linenos">795</span></a><span class="sd">        max_lags: number of lags to trim at (default: 12)</span>
</span><span id="plot_mfilters-796"><a href="#plot_mfilters-796"><span class="linenos">796</span></a><span class="sd">        rh: row height in units of inches (default: 2) </span>
</span><span id="plot_mfilters-797"><a href="#plot_mfilters-797"><span class="linenos">797</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="plot_mfilters-798"><a href="#plot_mfilters-798"><span class="linenos">798</span></a>    <span class="n">mfilts</span> <span class="o">=</span> <span class="n">compute_mfilters</span><span class="p">(</span> <span class="n">model</span><span class="p">,</span> <span class="n">tkerns</span><span class="o">=</span><span class="n">tkerns</span><span class="p">)</span>
</span><span id="plot_mfilters-799"><a href="#plot_mfilters-799"><span class="linenos">799</span></a>    <span class="n">NF</span> <span class="o">=</span> <span class="n">mfilts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="plot_mfilters-800"><a href="#plot_mfilters-800"><span class="linenos">800</span></a>
</span><span id="plot_mfilters-801"><a href="#plot_mfilters-801"><span class="linenos">801</span></a>    <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">NF</span><span class="o">/</span><span class="mi">6</span><span class="p">))</span>
</span><span id="plot_mfilters-802"><a href="#plot_mfilters-802"><span class="linenos">802</span></a>    <span class="n">utils</span><span class="o">.</span><span class="n">ss</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span> <span class="n">rh</span><span class="o">=</span><span class="n">rh</span><span class="p">)</span>
</span><span id="plot_mfilters-803"><a href="#plot_mfilters-803"><span class="linenos">803</span></a>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NF</span><span class="p">):</span>
</span><span id="plot_mfilters-804"><a href="#plot_mfilters-804"><span class="linenos">804</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="plot_mfilters-805"><a href="#plot_mfilters-805"><span class="linenos">805</span></a>        <span class="k">if</span> <span class="n">flip</span><span class="p">:</span>
</span><span id="plot_mfilters-806"><a href="#plot_mfilters-806"><span class="linenos">806</span></a>            <span class="n">utils</span><span class="o">.</span><span class="n">imagesc</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">mfilts</span><span class="p">[:,</span> <span class="p">:</span><span class="n">max_lags</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis_labels</span><span class="o">=</span><span class="n">axis_labels</span><span class="p">)</span>
</span><span id="plot_mfilters-807"><a href="#plot_mfilters-807"><span class="linenos">807</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="plot_mfilters-808"><a href="#plot_mfilters-808"><span class="linenos">808</span></a>            <span class="n">utils</span><span class="o">.</span><span class="n">imagesc</span><span class="p">(</span><span class="n">mfilts</span><span class="p">[:,</span> <span class="p">:</span><span class="n">max_lags</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">axis_labels</span><span class="o">=</span><span class="n">axis_labels</span><span class="p">)</span>
</span><span id="plot_mfilters-809"><a href="#plot_mfilters-809"><span class="linenos">809</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Plots mfilters (first-layer monocular filters) of sico models, using compute_mfilters to calcuate. </p>

<h6 id="inputs">Inputs:</h6>

<blockquote>
  <p>model: sico model to plot monocular filters of
  tkerns: temporal kernels used in sico model (default: None assumes no temporal filters used)
  flip: whether to have lag-0 at bottom and go up (default: flip=True) or opposite
  axis_labels: whether to display axis_labels (default: False=No)
  max_lags: number of lags to trim at (default: 12)
  rh: row height in units of inches (default: 2)</p>
</blockquote>
</div>


                </section>
                <section id="plot_bfilters">
                            <input id="plot_bfilters-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_bfilters</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">model</span>, </span><span class="param"><span class="n">tkerns</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">flip</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">axis_labels</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">max_lags</span><span class="o">=</span><span class="mi">12</span>, </span><span class="param"><span class="n">rh</span><span class="o">=</span><span class="mi">2</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="plot_bfilters-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#plot_bfilters"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="plot_bfilters-813"><a href="#plot_bfilters-813"><span class="linenos">813</span></a><span class="k">def</span> <span class="nf">plot_bfilters</span><span class="p">(</span> <span class="n">model</span><span class="p">,</span> <span class="n">tkerns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_lags</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">rh</span><span class="o">=</span><span class="mi">2</span> <span class="p">):</span>
</span><span id="plot_bfilters-814"><a href="#plot_bfilters-814"><span class="linenos">814</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="plot_bfilters-815"><a href="#plot_bfilters-815"><span class="linenos">815</span></a><span class="sd">    Plots bfilters (second-layer binocular filters) of sico models, using compute_bfilters to calcuate. </span>
</span><span id="plot_bfilters-816"><a href="#plot_bfilters-816"><span class="linenos">816</span></a>
</span><span id="plot_bfilters-817"><a href="#plot_bfilters-817"><span class="linenos">817</span></a><span class="sd">    Inputs:</span>
</span><span id="plot_bfilters-818"><a href="#plot_bfilters-818"><span class="linenos">818</span></a><span class="sd">        model: sico model to plot monocular filters of</span>
</span><span id="plot_bfilters-819"><a href="#plot_bfilters-819"><span class="linenos">819</span></a><span class="sd">        tkerns: temporal kernels used in sico model (default: None assumes no temporal filters used)</span>
</span><span id="plot_bfilters-820"><a href="#plot_bfilters-820"><span class="linenos">820</span></a><span class="sd">        flip: whether to have lag-0 at bottom and go up (default: flip=True) or opposite</span>
</span><span id="plot_bfilters-821"><a href="#plot_bfilters-821"><span class="linenos">821</span></a><span class="sd">        axis_labels: whether to display axis_labels (default: False=No)</span>
</span><span id="plot_bfilters-822"><a href="#plot_bfilters-822"><span class="linenos">822</span></a><span class="sd">        max_lags: number of lags to trim at (default: 12)</span>
</span><span id="plot_bfilters-823"><a href="#plot_bfilters-823"><span class="linenos">823</span></a><span class="sd">        rh: row height in units of inches (default: 2) </span>
</span><span id="plot_bfilters-824"><a href="#plot_bfilters-824"><span class="linenos">824</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="plot_bfilters-825"><a href="#plot_bfilters-825"><span class="linenos">825</span></a>
</span><span id="plot_bfilters-826"><a href="#plot_bfilters-826"><span class="linenos">826</span></a>    <span class="n">kb</span> <span class="o">=</span> <span class="n">compute_bfilters</span><span class="p">(</span> <span class="n">model</span><span class="p">,</span> <span class="n">tkerns</span> <span class="p">)</span>
</span><span id="plot_bfilters-827"><a href="#plot_bfilters-827"><span class="linenos">827</span></a>    <span class="n">_</span><span class="p">,</span> <span class="n">fw</span><span class="p">,</span> <span class="n">nlags</span><span class="p">,</span> <span class="n">NF</span> <span class="o">=</span> <span class="n">kb</span><span class="o">.</span><span class="n">shape</span>
</span><span id="plot_bfilters-828"><a href="#plot_bfilters-828"><span class="linenos">828</span></a>    <span class="n">nexc</span> <span class="o">=</span> <span class="n">NF</span><span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">num_inh</span>
</span><span id="plot_bfilters-829"><a href="#plot_bfilters-829"><span class="linenos">829</span></a>
</span><span id="plot_bfilters-830"><a href="#plot_bfilters-830"><span class="linenos">830</span></a>    <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">NF</span><span class="o">/</span><span class="mi">4</span><span class="p">))</span>
</span><span id="plot_bfilters-831"><a href="#plot_bfilters-831"><span class="linenos">831</span></a>    <span class="n">utils</span><span class="o">.</span><span class="n">ss</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="n">rh</span><span class="o">=</span><span class="n">rh</span><span class="p">)</span>
</span><span id="plot_bfilters-832"><a href="#plot_bfilters-832"><span class="linenos">832</span></a>    <span class="c1">#m = np.max(abs(kb))</span>
</span><span id="plot_bfilters-833"><a href="#plot_bfilters-833"><span class="linenos">833</span></a>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NF</span><span class="p">):</span>
</span><span id="plot_bfilters-834"><a href="#plot_bfilters-834"><span class="linenos">834</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="plot_bfilters-835"><a href="#plot_bfilters-835"><span class="linenos">835</span></a>        <span class="k">if</span> <span class="n">flip</span><span class="p">:</span>
</span><span id="plot_bfilters-836"><a href="#plot_bfilters-836"><span class="linenos">836</span></a>            <span class="n">utils</span><span class="o">.</span><span class="n">imagesc</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">kb</span><span class="p">[:,:,:</span><span class="n">max_lags</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">max_lags</span><span class="p">])),</span> <span class="n">axis_labels</span><span class="o">=</span><span class="n">axis_labels</span> <span class="p">)</span>
</span><span id="plot_bfilters-837"><a href="#plot_bfilters-837"><span class="linenos">837</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="plot_bfilters-838"><a href="#plot_bfilters-838"><span class="linenos">838</span></a>            <span class="n">utils</span><span class="o">.</span><span class="n">imagesc</span><span class="p">(</span> <span class="n">kb</span><span class="p">[:,:,:</span><span class="n">max_lags</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">max_lags</span><span class="p">])</span> <span class="p">)</span>
</span><span id="plot_bfilters-839"><a href="#plot_bfilters-839"><span class="linenos">839</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">fw</span><span class="o">-</span><span class="mf">0.5</span><span class="p">),[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">max_lags</span><span class="o">-</span><span class="mf">0.5</span><span class="p">],</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
</span><span id="plot_bfilters-840"><a href="#plot_bfilters-840"><span class="linenos">840</span></a>        <span class="k">if</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">nexc</span><span class="p">:</span>
</span><span id="plot_bfilters-841"><a href="#plot_bfilters-841"><span class="linenos">841</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;EXC </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">ii</span><span class="p">)</span>
</span><span id="plot_bfilters-842"><a href="#plot_bfilters-842"><span class="linenos">842</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="plot_bfilters-843"><a href="#plot_bfilters-843"><span class="linenos">843</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">: INH </span><span class="si">%d</span><span class="s2"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">ii</span><span class="o">-</span><span class="n">nexc</span><span class="p">))</span>
</span><span id="plot_bfilters-844"><a href="#plot_bfilters-844"><span class="linenos">844</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Plots bfilters (second-layer binocular filters) of sico models, using compute_bfilters to calcuate. </p>

<h6 id="inputs">Inputs:</h6>

<blockquote>
  <p>model: sico model to plot monocular filters of
  tkerns: temporal kernels used in sico model (default: None assumes no temporal filters used)
  flip: whether to have lag-0 at bottom and go up (default: flip=True) or opposite
  axis_labels: whether to display axis_labels (default: False=No)
  max_lags: number of lags to trim at (default: 12)
  rh: row height in units of inches (default: 2)</p>
</blockquote>
</div>


                </section>
                <section id="clone_model_selection">
                            <input id="clone_model_selection-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clone_model_selection</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">LLs</span>, </span><span class="param"><span class="n">thresh</span><span class="o">=</span><span class="mf">0.99</span>, </span><span class="param"><span class="n">LLthresh</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="clone_model_selection-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#clone_model_selection"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="clone_model_selection-849"><a href="#clone_model_selection-849"><span class="linenos">849</span></a><span class="k">def</span> <span class="nf">clone_model_selection</span><span class="p">(</span> <span class="n">LLs</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">LLthresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="clone_model_selection-850"><a href="#clone_model_selection-850"><span class="linenos">850</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="clone_model_selection-851"><a href="#clone_model_selection-851"><span class="linenos">851</span></a><span class="sd">    Model selection from regularization -- find smallest regularization value within thresh of max</span>
</span><span id="clone_model_selection-852"><a href="#clone_model_selection-852"><span class="linenos">852</span></a><span class="sd">    This is made for first-stage clone-sico models that have an ordering (from small to big)</span>
</span><span id="clone_model_selection-853"><a href="#clone_model_selection-853"><span class="linenos">853</span></a><span class="sd">    Choses earliest model that has LL greater than threshold</span>
</span><span id="clone_model_selection-854"><a href="#clone_model_selection-854"><span class="linenos">854</span></a>
</span><span id="clone_model_selection-855"><a href="#clone_model_selection-855"><span class="linenos">855</span></a><span class="sd">    Input:</span>
</span><span id="clone_model_selection-856"><a href="#clone_model_selection-856"><span class="linenos">856</span></a><span class="sd">        LLs: LL list for all the clones</span>
</span><span id="clone_model_selection-857"><a href="#clone_model_selection-857"><span class="linenos">857</span></a><span class="sd">        thresh: fraction of max that threshold is selected for (default: 0.99)</span>
</span><span id="clone_model_selection-858"><a href="#clone_model_selection-858"><span class="linenos">858</span></a><span class="sd">        LLthresh: explicit LL-threshold: overrides value of thresh, but default=None</span>
</span><span id="clone_model_selection-859"><a href="#clone_model_selection-859"><span class="linenos">859</span></a><span class="sd">        verbose: to print inner workings or not</span>
</span><span id="clone_model_selection-860"><a href="#clone_model_selection-860"><span class="linenos">860</span></a><span class="sd">    Returns:</span>
</span><span id="clone_model_selection-861"><a href="#clone_model_selection-861"><span class="linenos">861</span></a><span class="sd">        selection: index of clone that fits criteria</span>
</span><span id="clone_model_selection-862"><a href="#clone_model_selection-862"><span class="linenos">862</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="clone_model_selection-863"><a href="#clone_model_selection-863"><span class="linenos">863</span></a>    <span class="k">if</span> <span class="n">LLthresh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="clone_model_selection-864"><a href="#clone_model_selection-864"><span class="linenos">864</span></a>        <span class="n">LLthresh</span> <span class="o">=</span> <span class="n">thresh</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">LLs</span><span class="p">)</span>
</span><span id="clone_model_selection-865"><a href="#clone_model_selection-865"><span class="linenos">865</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LLs</span> <span class="o">&gt;=</span> <span class="n">LLthresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="clone_model_selection-866"><a href="#clone_model_selection-866"><span class="linenos">866</span></a>    <span class="n">selection</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span id="clone_model_selection-867"><a href="#clone_model_selection-867"><span class="linenos">867</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="clone_model_selection-868"><a href="#clone_model_selection-868"><span class="linenos">868</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%d</span><span class="s2"> LLs meet criteria (</span><span class="si">%0.5f</span><span class="s2"> out of </span><span class="si">%0.5f</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">LLthresh</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">LLs</span><span class="p">)))</span>
</span><span id="clone_model_selection-869"><a href="#clone_model_selection-869"><span class="linenos">869</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Using </span><span class="si">%d</span><span class="s2">: (max at </span><span class="si">%d</span><span class="s2"> out of </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">LLs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">LLs</span><span class="p">)))</span>
</span><span id="clone_model_selection-870"><a href="#clone_model_selection-870"><span class="linenos">870</span></a>    <span class="k">return</span> <span class="n">selection</span>
</span></pre></div>


            <div class="docstring"><p>Model selection from regularization -- find smallest regularization value within thresh of max
This is made for first-stage clone-sico models that have an ordering (from small to big)
Choses earliest model that has LL greater than threshold</p>

<h6 id="input">Input:</h6>

<blockquote>
  <p>LLs: LL list for all the clones
  thresh: fraction of max that threshold is selected for (default: 0.99)
  LLthresh: explicit LL-threshold: overrides value of thresh, but default=None
  verbose: to print inner workings or not</p>
</blockquote>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>selection: index of clone that fits criteria</p>
</blockquote>
</div>


                </section>
                <section id="reconstitute_bmodel">
                            <input id="reconstitute_bmodel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reconstitute_bmodel</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">clone_mod</span>, </span><span class="param"><span class="n">cc</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="reconstitute_bmodel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#reconstitute_bmodel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="reconstitute_bmodel-874"><a href="#reconstitute_bmodel-874"><span class="linenos">874</span></a><span class="k">def</span> <span class="nf">reconstitute_bmodel</span><span class="p">(</span> <span class="n">clone_mod</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="reconstitute_bmodel-875"><a href="#reconstitute_bmodel-875"><span class="linenos">875</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="reconstitute_bmodel-876"><a href="#reconstitute_bmodel-876"><span class="linenos">876</span></a><span class="sd">    SiCo-model specific: makes reduced single-neuron model from larger-scale clone model,</span>
</span><span id="reconstitute_bmodel-877"><a href="#reconstitute_bmodel-877"><span class="linenos">877</span></a><span class="sd">    which generates many different instances of a single neuron model.</span>
</span><span id="reconstitute_bmodel-878"><a href="#reconstitute_bmodel-878"><span class="linenos">878</span></a>
</span><span id="reconstitute_bmodel-879"><a href="#reconstitute_bmodel-879"><span class="linenos">879</span></a><span class="sd">    Args:</span>
</span><span id="reconstitute_bmodel-880"><a href="#reconstitute_bmodel-880"><span class="linenos">880</span></a><span class="sd">        clone_mod: clone-sico model with many instances of single neuron models</span>
</span><span id="reconstitute_bmodel-881"><a href="#reconstitute_bmodel-881"><span class="linenos">881</span></a><span class="sd">        cc: which clone to take</span>
</span><span id="reconstitute_bmodel-882"><a href="#reconstitute_bmodel-882"><span class="linenos">882</span></a><span class="sd">        verbose: whether to suppress output (default: verbose=True)</span>
</span><span id="reconstitute_bmodel-883"><a href="#reconstitute_bmodel-883"><span class="linenos">883</span></a><span class="sd">    </span>
</span><span id="reconstitute_bmodel-884"><a href="#reconstitute_bmodel-884"><span class="linenos">884</span></a><span class="sd">    Returns:</span>
</span><span id="reconstitute_bmodel-885"><a href="#reconstitute_bmodel-885"><span class="linenos">885</span></a><span class="sd">        single_mod: sico single-neuron model</span>
</span><span id="reconstitute_bmodel-886"><a href="#reconstitute_bmodel-886"><span class="linenos">886</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="reconstitute_bmodel-887"><a href="#reconstitute_bmodel-887"><span class="linenos">887</span></a>    <span class="c1">### start with exact copy </span>
</span><span id="reconstitute_bmodel-888"><a href="#reconstitute_bmodel-888"><span class="linenos">888</span></a>    <span class="kn">import</span> <span class="nn">torch</span>
</span><span id="reconstitute_bmodel-889"><a href="#reconstitute_bmodel-889"><span class="linenos">889</span></a>    <span class="n">clone_mod</span> <span class="o">=</span> <span class="n">clone_mod</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">))</span>
</span><span id="reconstitute_bmodel-890"><a href="#reconstitute_bmodel-890"><span class="linenos">890</span></a>    <span class="n">num_networks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clone_mod</span><span class="o">.</span><span class="n">ffnet_list</span><span class="p">)</span>
</span><span id="reconstitute_bmodel-891"><a href="#reconstitute_bmodel-891"><span class="linenos">891</span></a>    <span class="n">stim_net</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">clone_mod</span><span class="o">.</span><span class="n">ffnet_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="reconstitute_bmodel-892"><a href="#reconstitute_bmodel-892"><span class="linenos">892</span></a>    
</span><span id="reconstitute_bmodel-893"><a href="#reconstitute_bmodel-893"><span class="linenos">893</span></a>    <span class="c1"># Reconstitute mask</span>
</span><span id="reconstitute_bmodel-894"><a href="#reconstitute_bmodel-894"><span class="linenos">894</span></a>    <span class="n">NF</span> <span class="o">=</span> <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="reconstitute_bmodel-895"><a href="#reconstitute_bmodel-895"><span class="linenos">895</span></a>    <span class="n">NX</span> <span class="o">=</span> <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="reconstitute_bmodel-896"><a href="#reconstitute_bmodel-896"><span class="linenos">896</span></a>    <span class="n">NXmod</span> <span class="o">=</span> <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="reconstitute_bmodel-897"><a href="#reconstitute_bmodel-897"><span class="linenos">897</span></a>    <span class="n">NC</span> <span class="o">=</span> <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">output_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="reconstitute_bmodel-898"><a href="#reconstitute_bmodel-898"><span class="linenos">898</span></a>    <span class="n">numE</span> <span class="o">=</span> <span class="n">NF</span> <span class="o">-</span> <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">num_inh</span>
</span><span id="reconstitute_bmodel-899"><a href="#reconstitute_bmodel-899"><span class="linenos">899</span></a>    <span class="n">mask</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NF</span><span class="p">,</span> <span class="n">NXmod</span><span class="p">,</span> <span class="n">NC</span><span class="p">])</span>
</span><span id="reconstitute_bmodel-900"><a href="#reconstitute_bmodel-900"><span class="linenos">900</span></a>    
</span><span id="reconstitute_bmodel-901"><a href="#reconstitute_bmodel-901"><span class="linenos">901</span></a>    <span class="c1"># Extract how many filters getting pulled</span>
</span><span id="reconstitute_bmodel-902"><a href="#reconstitute_bmodel-902"><span class="linenos">902</span></a>    <span class="n">ne</span> <span class="o">=</span>  <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">[:</span><span class="n">numE</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cc</span><span class="p">]))</span>
</span><span id="reconstitute_bmodel-903"><a href="#reconstitute_bmodel-903"><span class="linenos">903</span></a>    <span class="n">ni</span> <span class="o">=</span>  <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">numE</span><span class="p">:,</span><span class="mi">0</span><span class="p">,</span><span class="n">cc</span><span class="p">]))</span>
</span><span id="reconstitute_bmodel-904"><a href="#reconstitute_bmodel-904"><span class="linenos">904</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="reconstitute_bmodel-905"><a href="#reconstitute_bmodel-905"><span class="linenos">905</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Model extraction: </span><span class="si">%d</span><span class="s2"> exc, </span><span class="si">%d</span><span class="s2"> inh filters&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ne</span><span class="p">,</span> <span class="n">ni</span><span class="p">))</span>
</span><span id="reconstitute_bmodel-906"><a href="#reconstitute_bmodel-906"><span class="linenos">906</span></a>
</span><span id="reconstitute_bmodel-907"><a href="#reconstitute_bmodel-907"><span class="linenos">907</span></a>    <span class="c1"># modification of binocular layer</span>
</span><span id="reconstitute_bmodel-908"><a href="#reconstitute_bmodel-908"><span class="linenos">908</span></a>    <span class="n">stim_net</span><span class="p">[</span><span class="s1">&#39;layer_list&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;num_filters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ne</span><span class="o">+</span><span class="n">ni</span>
</span><span id="reconstitute_bmodel-909"><a href="#reconstitute_bmodel-909"><span class="linenos">909</span></a>    <span class="n">stim_net</span><span class="p">[</span><span class="s1">&#39;layer_list&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;num_inh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ni</span>
</span><span id="reconstitute_bmodel-910"><a href="#reconstitute_bmodel-910"><span class="linenos">910</span></a>
</span><span id="reconstitute_bmodel-911"><a href="#reconstitute_bmodel-911"><span class="linenos">911</span></a>    <span class="c1"># modification of readout layer</span>
</span><span id="reconstitute_bmodel-912"><a href="#reconstitute_bmodel-912"><span class="linenos">912</span></a>    <span class="n">stim_net</span><span class="p">[</span><span class="s1">&#39;layer_list&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;layer_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span>
</span><span id="reconstitute_bmodel-913"><a href="#reconstitute_bmodel-913"><span class="linenos">913</span></a>    <span class="n">stim_net</span><span class="p">[</span><span class="s1">&#39;layer_list&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;num_filters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="reconstitute_bmodel-914"><a href="#reconstitute_bmodel-914"><span class="linenos">914</span></a>    <span class="c1">#del stim_net[&#39;layer_list&#39;][2][&#39;mask&#39;]</span>
</span><span id="reconstitute_bmodel-915"><a href="#reconstitute_bmodel-915"><span class="linenos">915</span></a>    <span class="k">if</span> <span class="n">num_networks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="reconstitute_bmodel-916"><a href="#reconstitute_bmodel-916"><span class="linenos">916</span></a>        
</span><span id="reconstitute_bmodel-917"><a href="#reconstitute_bmodel-917"><span class="linenos">917</span></a>        <span class="n">single_mod</span> <span class="o">=</span> <span class="n">NDN</span><span class="p">(</span> <span class="n">ffnet_list</span><span class="o">=</span><span class="p">[</span><span class="n">stim_net</span><span class="p">]</span> <span class="p">)</span>
</span><span id="reconstitute_bmodel-918"><a href="#reconstitute_bmodel-918"><span class="linenos">918</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="reconstitute_bmodel-919"><a href="#reconstitute_bmodel-919"><span class="linenos">919</span></a>        
</span><span id="reconstitute_bmodel-920"><a href="#reconstitute_bmodel-920"><span class="linenos">920</span></a>        <span class="n">drift_net</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">clone_mod</span><span class="o">.</span><span class="n">ffnet_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="reconstitute_bmodel-921"><a href="#reconstitute_bmodel-921"><span class="linenos">921</span></a>        <span class="n">drift_net</span><span class="p">[</span><span class="s1">&#39;layer_list&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;num_filters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="reconstitute_bmodel-922"><a href="#reconstitute_bmodel-922"><span class="linenos">922</span></a>        
</span><span id="reconstitute_bmodel-923"><a href="#reconstitute_bmodel-923"><span class="linenos">923</span></a>        <span class="n">comb_net</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">clone_mod</span><span class="o">.</span><span class="n">ffnet_list</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="reconstitute_bmodel-924"><a href="#reconstitute_bmodel-924"><span class="linenos">924</span></a>        <span class="n">comb_net</span><span class="p">[</span><span class="s1">&#39;layer_list&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;layer_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span>
</span><span id="reconstitute_bmodel-925"><a href="#reconstitute_bmodel-925"><span class="linenos">925</span></a>        <span class="n">comb_net</span><span class="p">[</span><span class="s1">&#39;layer_list&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;num_filters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="reconstitute_bmodel-926"><a href="#reconstitute_bmodel-926"><span class="linenos">926</span></a>    
</span><span id="reconstitute_bmodel-927"><a href="#reconstitute_bmodel-927"><span class="linenos">927</span></a>        <span class="n">single_mod</span> <span class="o">=</span> <span class="n">NDN</span><span class="p">(</span> <span class="n">ffnet_list</span><span class="o">=</span><span class="p">[</span><span class="n">stim_net</span><span class="p">,</span> <span class="n">drift_net</span><span class="p">,</span> <span class="n">comb_net</span><span class="p">]</span> <span class="p">)</span>
</span><span id="reconstitute_bmodel-928"><a href="#reconstitute_bmodel-928"><span class="linenos">928</span></a>        <span class="n">single_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="reconstitute_bmodel-929"><a href="#reconstitute_bmodel-929"><span class="linenos">929</span></a>            <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="reconstitute_bmodel-930"><a href="#reconstitute_bmodel-930"><span class="linenos">930</span></a>
</span><span id="reconstitute_bmodel-931"><a href="#reconstitute_bmodel-931"><span class="linenos">931</span></a>    <span class="c1"># Copy stim-processing in layer-0</span>
</span><span id="reconstitute_bmodel-932"><a href="#reconstitute_bmodel-932"><span class="linenos">932</span></a>    <span class="n">single_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="reconstitute_bmodel-933"><a href="#reconstitute_bmodel-933"><span class="linenos">933</span></a>    <span class="c1"># Get relevant filters in layer-1</span>
</span><span id="reconstitute_bmodel-934"><a href="#reconstitute_bmodel-934"><span class="linenos">934</span></a>    <span class="n">non_zeroBs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="n">cc</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="reconstitute_bmodel-935"><a href="#reconstitute_bmodel-935"><span class="linenos">935</span></a>    <span class="n">single_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span>
</span><span id="reconstitute_bmodel-936"><a href="#reconstitute_bmodel-936"><span class="linenos">936</span></a>        <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">non_zeroBs</span><span class="p">])</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="reconstitute_bmodel-937"><a href="#reconstitute_bmodel-937"><span class="linenos">937</span></a>    <span class="k">if</span> <span class="n">single_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_norm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="reconstitute_bmodel-938"><a href="#reconstitute_bmodel-938"><span class="linenos">938</span></a>        <span class="n">single_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_norm</span><span class="o">.</span><span class="n">running_mean</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> \
</span><span id="reconstitute_bmodel-939"><a href="#reconstitute_bmodel-939"><span class="linenos">939</span></a>            <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_norm</span><span class="o">.</span><span class="n">running_mean</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">non_zeroBs</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="reconstitute_bmodel-940"><a href="#reconstitute_bmodel-940"><span class="linenos">940</span></a>        <span class="n">single_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_norm</span><span class="o">.</span><span class="n">running_var</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> \
</span><span id="reconstitute_bmodel-941"><a href="#reconstitute_bmodel-941"><span class="linenos">941</span></a>            <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_norm</span><span class="o">.</span><span class="n">running_var</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">non_zeroBs</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="reconstitute_bmodel-942"><a href="#reconstitute_bmodel-942"><span class="linenos">942</span></a>        <span class="n">single_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_norm</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> \
</span><span id="reconstitute_bmodel-943"><a href="#reconstitute_bmodel-943"><span class="linenos">943</span></a>            <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_norm</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">non_zeroBs</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="reconstitute_bmodel-944"><a href="#reconstitute_bmodel-944"><span class="linenos">944</span></a>        <span class="n">single_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_norm</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> \
</span><span id="reconstitute_bmodel-945"><a href="#reconstitute_bmodel-945"><span class="linenos">945</span></a>            <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_norm</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">non_zeroBs</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="reconstitute_bmodel-946"><a href="#reconstitute_bmodel-946"><span class="linenos">946</span></a>    <span class="c1"># get relevant input weights in readout</span>
</span><span id="reconstitute_bmodel-947"><a href="#reconstitute_bmodel-947"><span class="linenos">947</span></a>    <span class="n">bweights</span> <span class="o">=</span> <span class="n">clone_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NF</span><span class="p">,</span> <span class="n">NXmod</span><span class="p">,</span> <span class="n">NC</span><span class="p">])</span>
</span><span id="reconstitute_bmodel-948"><a href="#reconstitute_bmodel-948"><span class="linenos">948</span></a>    <span class="n">single_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">bweights</span><span class="p">[</span><span class="n">non_zeroBs</span><span class="p">,:,</span> <span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="reconstitute_bmodel-949"><a href="#reconstitute_bmodel-949"><span class="linenos">949</span></a>    <span class="n">single_mod</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="reconstitute_bmodel-950"><a href="#reconstitute_bmodel-950"><span class="linenos">950</span></a>    <span class="k">return</span> <span class="n">single_mod</span>
</span></pre></div>


            <div class="docstring"><p>SiCo-model specific: makes reduced single-neuron model from larger-scale clone model,
which generates many different instances of a single neuron model.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>clone_mod:</strong>  clone-sico model with many instances of single neuron models</li>
<li><strong>cc:</strong>  which clone to take</li>
<li><strong>verbose:</strong>  whether to suppress output (default: verbose=True)</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>single_mod: sico single-neuron model</p>
</blockquote>
</div>


                </section>
                <section id="bmp_check">
                            <input id="bmp_check-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">bmp_check</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">mod</span>, </span><span class="param"><span class="n">dataset</span>, </span><span class="param"><span class="n">LLs</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">valset</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">cell_list</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="bmp_check-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#bmp_check"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="bmp_check-954"><a href="#bmp_check-954"><span class="linenos"> 954</span></a><span class="k">def</span> <span class="nf">bmp_check</span><span class="p">(</span> <span class="n">mod</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">LLs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">valset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cell_list</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="bmp_check-955"><a href="#bmp_check-955"><span class="linenos"> 955</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="bmp_check-956"><a href="#bmp_check-956"><span class="linenos"> 956</span></a><span class="sd">    calculate binocular model performance (pred power and disparity power) for top num_cells in clone-model</span>
</span><span id="bmp_check-957"><a href="#bmp_check-957"><span class="linenos"> 957</span></a><span class="sd">    it uses LLs to sort from top, but also can explicitly enter &#39;cell_list&#39;, which supercedes</span>
</span><span id="bmp_check-958"><a href="#bmp_check-958"><span class="linenos"> 958</span></a><span class="sd">    cell_list trumps everything else</span>
</span><span id="bmp_check-959"><a href="#bmp_check-959"><span class="linenos"> 959</span></a>
</span><span id="bmp_check-960"><a href="#bmp_check-960"><span class="linenos"> 960</span></a><span class="sd">    Args:</span>
</span><span id="bmp_check-961"><a href="#bmp_check-961"><span class="linenos"> 961</span></a><span class="sd">        mod: clone binocular model with lots of outputs</span>
</span><span id="bmp_check-962"><a href="#bmp_check-962"><span class="linenos"> 962</span></a><span class="sd">        dataset: dataset that can push through mod</span>
</span><span id="bmp_check-963"><a href="#bmp_check-963"><span class="linenos"> 963</span></a><span class="sd">        LLs: LLs of the mod. Should be able to generate internally, but would need null models</span>
</span><span id="bmp_check-964"><a href="#bmp_check-964"><span class="linenos"> 964</span></a><span class="sd">        num_cells: how many of the top cells/outputs to calculate with</span>
</span><span id="bmp_check-965"><a href="#bmp_check-965"><span class="linenos"> 965</span></a><span class="sd">        valset: whether to use &#39;a&#39; or &#39;b&#39; (devault is &#39;b&#39;)</span>
</span><span id="bmp_check-966"><a href="#bmp_check-966"><span class="linenos"> 966</span></a><span class="sd">        cell_list: superceded ordering by LLs, and just says which ccs to calculate performance for</span>
</span><span id="bmp_check-967"><a href="#bmp_check-967"><span class="linenos"> 967</span></a>
</span><span id="bmp_check-968"><a href="#bmp_check-968"><span class="linenos"> 968</span></a><span class="sd">    Returns:</span>
</span><span id="bmp_check-969"><a href="#bmp_check-969"><span class="linenos"> 969</span></a><span class="sd">        pps: predictive powers of whole clone array, but non-zero for only cells that were computed here</span>
</span><span id="bmp_check-970"><a href="#bmp_check-970"><span class="linenos"> 970</span></a><span class="sd">        dps: disparity-predictive powers for same deal as pps</span>
</span><span id="bmp_check-971"><a href="#bmp_check-971"><span class="linenos"> 971</span></a><span class="sd">        cell_order: list of cells that were probed</span>
</span><span id="bmp_check-972"><a href="#bmp_check-972"><span class="linenos"> 972</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="bmp_check-973"><a href="#bmp_check-973"><span class="linenos"> 973</span></a>    <span class="kn">import</span> <span class="nn">torch</span>
</span><span id="bmp_check-974"><a href="#bmp_check-974"><span class="linenos"> 974</span></a>
</span><span id="bmp_check-975"><a href="#bmp_check-975"><span class="linenos"> 975</span></a>    <span class="k">if</span> <span class="n">valset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="bmp_check-976"><a href="#bmp_check-976"><span class="linenos"> 976</span></a>        <span class="n">valset</span><span class="o">=</span><span class="s1">&#39;b&#39;</span>
</span><span id="bmp_check-977"><a href="#bmp_check-977"><span class="linenos"> 977</span></a>        <span class="c1">#print(&#39;  Testing valset b&#39;)</span>
</span><span id="bmp_check-978"><a href="#bmp_check-978"><span class="linenos"> 978</span></a>    <span class="n">mod</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">))</span>
</span><span id="bmp_check-979"><a href="#bmp_check-979"><span class="linenos"> 979</span></a>    <span class="n">NF</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="bmp_check-980"><a href="#bmp_check-980"><span class="linenos"> 980</span></a>    <span class="n">NXmod</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="bmp_check-981"><a href="#bmp_check-981"><span class="linenos"> 981</span></a>    <span class="n">NC</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">output_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="bmp_check-982"><a href="#bmp_check-982"><span class="linenos"> 982</span></a>    <span class="n">numE</span> <span class="o">=</span> <span class="n">NF</span> <span class="o">-</span> <span class="n">mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">num_inh</span>
</span><span id="bmp_check-983"><a href="#bmp_check-983"><span class="linenos"> 983</span></a>    <span class="n">mask</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NF</span><span class="p">,</span> <span class="n">NXmod</span><span class="p">,</span> <span class="n">NC</span><span class="p">])</span>
</span><span id="bmp_check-984"><a href="#bmp_check-984"><span class="linenos"> 984</span></a>    
</span><span id="bmp_check-985"><a href="#bmp_check-985"><span class="linenos"> 985</span></a>    <span class="k">if</span> <span class="n">num_cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="bmp_check-986"><a href="#bmp_check-986"><span class="linenos"> 986</span></a>        <span class="n">num_cells</span> <span class="o">=</span> <span class="n">NC</span>
</span><span id="bmp_check-987"><a href="#bmp_check-987"><span class="linenos"> 987</span></a>    <span class="k">if</span> <span class="n">cell_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="bmp_check-988"><a href="#bmp_check-988"><span class="linenos"> 988</span></a>        <span class="k">assert</span> <span class="n">LLs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to pass in LLs&quot;</span>
</span><span id="bmp_check-989"><a href="#bmp_check-989"><span class="linenos"> 989</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">LLs</span><span class="p">)</span> <span class="o">==</span> <span class="n">NC</span><span class="p">,</span> <span class="s2">&quot;LLs size mismatch given model&quot;</span>
</span><span id="bmp_check-990"><a href="#bmp_check-990"><span class="linenos"> 990</span></a>        <span class="n">cell_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">LLs</span><span class="p">)[</span><span class="nb">range</span><span class="p">(</span><span class="n">NC</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)][:</span><span class="n">num_cells</span><span class="p">]</span>
</span><span id="bmp_check-991"><a href="#bmp_check-991"><span class="linenos"> 991</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="bmp_check-992"><a href="#bmp_check-992"><span class="linenos"> 992</span></a>        <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_int</span><span class="p">(</span><span class="n">cell_list</span><span class="p">):</span>
</span><span id="bmp_check-993"><a href="#bmp_check-993"><span class="linenos"> 993</span></a>            <span class="n">cell_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell_list</span><span class="p">]</span>
</span><span id="bmp_check-994"><a href="#bmp_check-994"><span class="linenos"> 994</span></a>        <span class="n">cell_order</span> <span class="o">=</span> <span class="n">cell_list</span>
</span><span id="bmp_check-995"><a href="#bmp_check-995"><span class="linenos"> 995</span></a>        <span class="n">num_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_list</span><span class="p">)</span>
</span><span id="bmp_check-996"><a href="#bmp_check-996"><span class="linenos"> 996</span></a>        <span class="k">if</span> <span class="n">LLs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="bmp_check-997"><a href="#bmp_check-997"><span class="linenos"> 997</span></a>            <span class="n">LLs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NC</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
</span><span id="bmp_check-998"><a href="#bmp_check-998"><span class="linenos"> 998</span></a>    <span class="n">rs</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">dataset</span><span class="p">[:])</span>  <span class="c1"># predicted responses acriss time</span>
</span><span id="bmp_check-999"><a href="#bmp_check-999"><span class="linenos"> 999</span></a>    
</span><span id="bmp_check-1000"><a href="#bmp_check-1000"><span class="linenos">1000</span></a>    <span class="n">pps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NC</span><span class="p">])</span>
</span><span id="bmp_check-1001"><a href="#bmp_check-1001"><span class="linenos">1001</span></a>    <span class="n">dps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NC</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
</span><span id="bmp_check-1002"><a href="#bmp_check-1002"><span class="linenos">1002</span></a>    
</span><span id="bmp_check-1003"><a href="#bmp_check-1003"><span class="linenos">1003</span></a>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_cells</span><span class="p">):</span>
</span><span id="bmp_check-1004"><a href="#bmp_check-1004"><span class="linenos">1004</span></a>        <span class="n">cc</span> <span class="o">=</span> <span class="n">cell_order</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="bmp_check-1005"><a href="#bmp_check-1005"><span class="linenos">1005</span></a>        <span class="n">bmp</span> <span class="o">=</span> <span class="n">binocular_model_performance</span><span class="p">(</span> 
</span><span id="bmp_check-1006"><a href="#bmp_check-1006"><span class="linenos">1006</span></a>            <span class="n">data</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span> <span class="n">cell_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Rpred</span><span class="o">=</span><span class="n">rs</span><span class="p">[:,</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">valset</span><span class="o">=</span><span class="n">valset</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
</span><span id="bmp_check-1007"><a href="#bmp_check-1007"><span class="linenos">1007</span></a>        <span class="c1"># Compute aspects of this model</span>
</span><span id="bmp_check-1008"><a href="#bmp_check-1008"><span class="linenos">1008</span></a>        <span class="n">ne</span> <span class="o">=</span>  <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">[:</span><span class="n">numE</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cc</span><span class="p">]))</span>
</span><span id="bmp_check-1009"><a href="#bmp_check-1009"><span class="linenos">1009</span></a>        <span class="n">ni</span> <span class="o">=</span>  <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">numE</span><span class="p">:,</span><span class="mi">0</span><span class="p">,</span><span class="n">cc</span><span class="p">]))</span>
</span><span id="bmp_check-1010"><a href="#bmp_check-1010"><span class="linenos">1010</span></a>        <span class="n">pps</span><span class="p">[</span><span class="n">cc</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmp</span><span class="p">[</span><span class="s1">&#39;pred_powers&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="bmp_check-1011"><a href="#bmp_check-1011"><span class="linenos">1011</span></a>        <span class="n">dps</span><span class="p">[</span><span class="n">cc</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">bmp</span><span class="p">[</span><span class="s1">&#39;disp_pred_powers&#39;</span><span class="p">][:</span><span class="mi">2</span><span class="p">])</span>
</span><span id="bmp_check-1012"><a href="#bmp_check-1012"><span class="linenos">1012</span></a>        <span class="k">if</span> <span class="n">cell_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="bmp_check-1013"><a href="#bmp_check-1013"><span class="linenos">1013</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%3d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">):</span><span class="se">\t</span><span class="s2">pp = </span><span class="si">%6.4f</span><span class="s2">  dp3 = </span><span class="si">%6.4f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">ni</span><span class="p">,</span> <span class="n">pps</span><span class="p">[</span><span class="n">cc</span><span class="p">],</span> <span class="n">dps</span><span class="p">[</span><span class="n">cc</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="bmp_check-1014"><a href="#bmp_check-1014"><span class="linenos">1014</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="bmp_check-1015"><a href="#bmp_check-1015"><span class="linenos">1015</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%3d</span><span class="s2"> </span><span class="si">%7.5f</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">):</span><span class="se">\t</span><span class="s2">pp = </span><span class="si">%6.4f</span><span class="s2">  dp3 = </span><span class="si">%6.4f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">LLs</span><span class="p">[</span><span class="n">cc</span><span class="p">],</span> <span class="n">ne</span><span class="p">,</span> <span class="n">ni</span><span class="p">,</span> <span class="n">pps</span><span class="p">[</span><span class="n">cc</span><span class="p">],</span> <span class="n">dps</span><span class="p">[</span><span class="n">cc</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="bmp_check-1016"><a href="#bmp_check-1016"><span class="linenos">1016</span></a>    <span class="k">return</span> <span class="n">pps</span><span class="p">,</span> <span class="n">dps</span><span class="p">,</span> <span class="n">cell_order</span>
</span></pre></div>


            <div class="docstring"><p>calculate binocular model performance (pred power and disparity power) for top num_cells in clone-model
it uses LLs to sort from top, but also can explicitly enter 'cell_list', which supercedes
cell_list trumps everything else</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>mod:</strong>  clone binocular model with lots of outputs</li>
<li><strong>dataset:</strong>  dataset that can push through mod</li>
<li><strong>LLs:</strong>  LLs of the mod. Should be able to generate internally, but would need null models</li>
<li><strong>num_cells:</strong>  how many of the top cells/outputs to calculate with</li>
<li><strong>valset:</strong>  whether to use 'a' or 'b' (devault is 'b')</li>
<li><strong>cell_list:</strong>  superceded ordering by LLs, and just says which ccs to calculate performance for</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>pps: predictive powers of whole clone array, but non-zero for only cells that were computed here
  dps: disparity-predictive powers for same deal as pps
  cell_order: list of cells that were probed</p>
</blockquote>
</div>


                </section>
                <section id="subsample_mask">
                            <input id="subsample_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">subsample_mask</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">numM</span>, </span><span class="param"><span class="n">numB</span>, </span><span class="param"><span class="n">alpha</span>, </span><span class="param"><span class="n">conv_width</span><span class="o">=</span><span class="mi">21</span>, </span><span class="param"><span class="n">flatten</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">resample</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="subsample_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#subsample_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="subsample_mask-1019"><a href="#subsample_mask-1019"><span class="linenos">1019</span></a><span class="k">def</span> <span class="nf">subsample_mask</span><span class="p">(</span> <span class="n">numM</span><span class="p">,</span> <span class="n">numB</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">conv_width</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">flatten</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="subsample_mask-1020"><a href="#subsample_mask-1020"><span class="linenos">1020</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="subsample_mask-1021"><a href="#subsample_mask-1021"><span class="linenos">1021</span></a><span class="sd">    Generate mask to give binocular filters (numB) access to some number of monocular filters</span>
</span><span id="subsample_mask-1022"><a href="#subsample_mask-1022"><span class="linenos">1022</span></a><span class="sd">    Args</span>
</span><span id="subsample_mask-1023"><a href="#subsample_mask-1023"><span class="linenos">1023</span></a><span class="sd">        numM: size of monocular pool</span>
</span><span id="subsample_mask-1024"><a href="#subsample_mask-1024"><span class="linenos">1024</span></a><span class="sd">        numB: number of binocular filters</span>
</span><span id="subsample_mask-1025"><a href="#subsample_mask-1025"><span class="linenos">1025</span></a><span class="sd">        alpha: how many monocular filters each gets to sample </span>
</span><span id="subsample_mask-1026"><a href="#subsample_mask-1026"><span class="linenos">1026</span></a><span class="sd">    </span>
</span><span id="subsample_mask-1027"><a href="#subsample_mask-1027"><span class="linenos">1027</span></a><span class="sd">    Returns:</span>
</span><span id="subsample_mask-1028"><a href="#subsample_mask-1028"><span class="linenos">1028</span></a><span class="sd">        mask that is [numM, conv_width, numB] with alpha ones in each row (randomly selected)</span>
</span><span id="subsample_mask-1029"><a href="#subsample_mask-1029"><span class="linenos">1029</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="subsample_mask-1030"><a href="#subsample_mask-1030"><span class="linenos">1030</span></a>    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">numM</span><span class="p">,</span> <span class="n">conv_width</span><span class="p">,</span> <span class="n">numB</span><span class="p">])</span>
</span><span id="subsample_mask-1031"><a href="#subsample_mask-1031"><span class="linenos">1031</span></a>    
</span><span id="subsample_mask-1032"><a href="#subsample_mask-1032"><span class="linenos">1032</span></a>    <span class="k">if</span> <span class="n">resample</span><span class="p">:</span>
</span><span id="subsample_mask-1033"><a href="#subsample_mask-1033"><span class="linenos">1033</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numB</span><span class="p">):</span>
</span><span id="subsample_mask-1034"><a href="#subsample_mask-1034"><span class="linenos">1034</span></a>            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">numM</span><span class="p">))</span>
</span><span id="subsample_mask-1035"><a href="#subsample_mask-1035"><span class="linenos">1035</span></a>            <span class="n">mask</span><span class="p">[</span><span class="n">a</span><span class="p">[:</span><span class="n">alpha</span><span class="p">],</span> <span class="p">:,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="subsample_mask-1036"><a href="#subsample_mask-1036"><span class="linenos">1036</span></a>    <span class="k">else</span><span class="p">:</span>  <span class="c1"># make more distributed by going through order explicitly once each time -- each filter used same amt</span>
</span><span id="subsample_mask-1037"><a href="#subsample_mask-1037"><span class="linenos">1037</span></a>        <span class="n">filt_sample</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="subsample_mask-1038"><a href="#subsample_mask-1038"><span class="linenos">1038</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">alpha</span><span class="o">*</span><span class="n">numB</span><span class="o">/</span><span class="n">numM</span><span class="p">))):</span>
</span><span id="subsample_mask-1039"><a href="#subsample_mask-1039"><span class="linenos">1039</span></a>            <span class="n">filt_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">filt_sample</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">numM</span><span class="p">))))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="subsample_mask-1040"><a href="#subsample_mask-1040"><span class="linenos">1040</span></a>        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="subsample_mask-1041"><a href="#subsample_mask-1041"><span class="linenos">1041</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numB</span><span class="p">):</span>
</span><span id="subsample_mask-1042"><a href="#subsample_mask-1042"><span class="linenos">1042</span></a>            <span class="n">mask</span><span class="p">[</span><span class="n">filt_sample</span><span class="p">[</span><span class="n">pos</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">alpha</span><span class="p">)],</span> <span class="p">:,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="subsample_mask-1043"><a href="#subsample_mask-1043"><span class="linenos">1043</span></a>            <span class="n">pos</span> <span class="o">+=</span> <span class="n">alpha</span>
</span><span id="subsample_mask-1044"><a href="#subsample_mask-1044"><span class="linenos">1044</span></a>            
</span><span id="subsample_mask-1045"><a href="#subsample_mask-1045"><span class="linenos">1045</span></a>    <span class="k">if</span> <span class="n">flatten</span><span class="p">:</span>
</span><span id="subsample_mask-1046"><a href="#subsample_mask-1046"><span class="linenos">1046</span></a>        <span class="k">return</span> <span class="n">mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numB</span><span class="p">])</span>
</span><span id="subsample_mask-1047"><a href="#subsample_mask-1047"><span class="linenos">1047</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="subsample_mask-1048"><a href="#subsample_mask-1048"><span class="linenos">1048</span></a>        <span class="k">return</span> <span class="n">mask</span>
</span></pre></div>


            <div class="docstring"><p>Generate mask to give binocular filters (numB) access to some number of monocular filters
Args
    numM: size of monocular pool
    numB: number of binocular filters
    alpha: how many monocular filters each gets to sample </p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>mask that is [numM, conv_width, numB] with alpha ones in each row (randomly selected)</p>
</blockquote>
</div>


                </section>
                <section id="EImask">
                            <input id="EImask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">EImask</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">numEIavail</span>,</span><span class="param">	<span class="n">numE</span>,</span><span class="param">	<span class="n">numI</span>,</span><span class="param">	<span class="n">num_filters</span>,</span><span class="param">	<span class="n">width</span><span class="o">=</span><span class="mi">36</span>,</span><span class="param">	<span class="n">flatten</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">resample</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="EImask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EImask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EImask-1051"><a href="#EImask-1051"><span class="linenos">1051</span></a><span class="k">def</span> <span class="nf">EImask</span><span class="p">(</span> <span class="n">numEIavail</span><span class="p">,</span> <span class="n">numE</span><span class="p">,</span> <span class="n">numI</span><span class="p">,</span> <span class="n">num_filters</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">flatten</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="EImask-1052"><a href="#EImask-1052"><span class="linenos">1052</span></a>    
</span><span id="EImask-1053"><a href="#EImask-1053"><span class="linenos">1053</span></a>    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">numEIavail</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">num_filters</span><span class="p">])</span>
</span><span id="EImask-1054"><a href="#EImask-1054"><span class="linenos">1054</span></a>    <span class="n">mask</span><span class="p">[:</span><span class="n">numEIavail</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">subsample_mask</span><span class="p">(</span> 
</span><span id="EImask-1055"><a href="#EImask-1055"><span class="linenos">1055</span></a>        <span class="n">numEIavail</span><span class="p">,</span> <span class="n">num_filters</span><span class="p">,</span> <span class="n">numE</span><span class="p">,</span> <span class="n">conv_width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">flatten</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">)</span>
</span><span id="EImask-1056"><a href="#EImask-1056"><span class="linenos">1056</span></a>    <span class="k">if</span> <span class="n">numI</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EImask-1057"><a href="#EImask-1057"><span class="linenos">1057</span></a>        <span class="n">mask</span><span class="p">[</span><span class="n">numEIavail</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">subsample_mask</span><span class="p">(</span> 
</span><span id="EImask-1058"><a href="#EImask-1058"><span class="linenos">1058</span></a>            <span class="n">numEIavail</span><span class="p">,</span> <span class="n">num_filters</span><span class="p">,</span> <span class="n">numI</span><span class="p">,</span> <span class="n">conv_width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">flatten</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">)</span>
</span><span id="EImask-1059"><a href="#EImask-1059"><span class="linenos">1059</span></a>
</span><span id="EImask-1060"><a href="#EImask-1060"><span class="linenos">1060</span></a>    <span class="k">if</span> <span class="n">flatten</span><span class="p">:</span>
</span><span id="EImask-1061"><a href="#EImask-1061"><span class="linenos">1061</span></a>        <span class="k">return</span> <span class="n">mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_filters</span><span class="p">])</span>
</span><span id="EImask-1062"><a href="#EImask-1062"><span class="linenos">1062</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="EImask-1063"><a href="#EImask-1063"><span class="linenos">1063</span></a>        <span class="k">return</span> <span class="n">mask</span>
</span></pre></div>


    

                </section>
                <section id="convert2ST">
                            <input id="convert2ST-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">convert2ST</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">mod0</span>, </span><span class="param"><span class="n">temporal_basis</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">new_lags</span><span class="o">=</span><span class="mi">16</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="convert2ST-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#convert2ST"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="convert2ST-1066"><a href="#convert2ST-1066"><span class="linenos">1066</span></a><span class="k">def</span> <span class="nf">convert2ST</span><span class="p">(</span> <span class="n">mod0</span><span class="p">,</span> <span class="n">temporal_basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">new_lags</span><span class="o">=</span><span class="mi">16</span> <span class="p">):</span>
</span><span id="convert2ST-1067"><a href="#convert2ST-1067"><span class="linenos">1067</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="convert2ST-1068"><a href="#convert2ST-1068"><span class="linenos">1068</span></a><span class="sd">    Convert temporal-basis-based model to spatiotemporal with new_lags</span>
</span><span id="convert2ST-1069"><a href="#convert2ST-1069"><span class="linenos">1069</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="convert2ST-1070"><a href="#convert2ST-1070"><span class="linenos">1070</span></a>    <span class="kn">from</span> <span class="nn">NDNT.modules.layers.bilayers</span> <span class="kn">import</span> <span class="n">BiConvLayer1D</span>
</span><span id="convert2ST-1071"><a href="#convert2ST-1071"><span class="linenos">1071</span></a>    <span class="kn">import</span> <span class="nn">torch</span>
</span><span id="convert2ST-1072"><a href="#convert2ST-1072"><span class="linenos">1072</span></a>
</span><span id="convert2ST-1073"><a href="#convert2ST-1073"><span class="linenos">1073</span></a>    <span class="k">assert</span> <span class="n">temporal_basis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;need to enter temporal basis&quot;</span>
</span><span id="convert2ST-1074"><a href="#convert2ST-1074"><span class="linenos">1074</span></a>    <span class="n">converted_model</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">mod0</span><span class="p">)</span>
</span><span id="convert2ST-1075"><a href="#convert2ST-1075"><span class="linenos">1075</span></a>    <span class="n">mks</span> <span class="o">=</span> <span class="n">compute_mfilters</span><span class="p">(</span> <span class="n">mod0</span><span class="p">,</span> <span class="n">temporal_basis</span> <span class="p">)</span>
</span><span id="convert2ST-1076"><a href="#convert2ST-1076"><span class="linenos">1076</span></a>    <span class="c1">#print(mks.shape)</span>
</span><span id="convert2ST-1077"><a href="#convert2ST-1077"><span class="linenos">1077</span></a>    <span class="n">mfilt_layer_pars</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">mod0</span><span class="o">.</span><span class="n">ffnet_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;layer_list&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="convert2ST-1078"><a href="#convert2ST-1078"><span class="linenos">1078</span></a>    <span class="n">mfilt_layer_pars</span><span class="p">[</span><span class="s1">&#39;input_dims&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_lags</span>
</span><span id="convert2ST-1079"><a href="#convert2ST-1079"><span class="linenos">1079</span></a>    <span class="n">mfilt_layer_pars</span><span class="p">[</span><span class="s1">&#39;filter_dims&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_lags</span>
</span><span id="convert2ST-1080"><a href="#convert2ST-1080"><span class="linenos">1080</span></a>    <span class="c1"># ALSO CONVERT relevant parts of ffnet_list</span>
</span><span id="convert2ST-1081"><a href="#convert2ST-1081"><span class="linenos">1081</span></a>    <span class="n">converted_model</span><span class="o">.</span><span class="n">ffnet_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;layer_list&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;input_dims&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_lags</span>
</span><span id="convert2ST-1082"><a href="#convert2ST-1082"><span class="linenos">1082</span></a>    <span class="n">converted_model</span><span class="o">.</span><span class="n">ffnet_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;layer_list&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;filter_dims&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_lags</span>
</span><span id="convert2ST-1083"><a href="#convert2ST-1083"><span class="linenos">1083</span></a>
</span><span id="convert2ST-1084"><a href="#convert2ST-1084"><span class="linenos">1084</span></a>    <span class="n">Mlayer</span> <span class="o">=</span> <span class="n">BiConvLayer1D</span><span class="p">(</span><span class="o">**</span><span class="n">mfilt_layer_pars</span><span class="p">)</span>
</span><span id="convert2ST-1085"><a href="#convert2ST-1085"><span class="linenos">1085</span></a>    <span class="n">Mlayer</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">mks</span><span class="p">[:,:</span><span class="n">new_lags</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">mks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]))</span>
</span><span id="convert2ST-1086"><a href="#convert2ST-1086"><span class="linenos">1086</span></a>    <span class="n">converted_model</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mlayer</span>
</span><span id="convert2ST-1087"><a href="#convert2ST-1087"><span class="linenos">1087</span></a>    <span class="k">return</span> <span class="n">converted_model</span>
</span></pre></div>


            <div class="docstring"><p>Convert temporal-basis-based model to spatiotemporal with new_lags</p>
</div>


                </section>
                <section id="bmodel_regpath">
                            <input id="bmodel_regpath-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">bmodel_regpath</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">model</span>,</span><span class="param">	<span class="n">train_ds</span>,</span><span class="param">	<span class="n">val_ds</span>,</span><span class="param">	<span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">reg_vals</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">ffnet_target</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">layer_target</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">nullLL</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">couple_xt</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">hard_reset</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">extended_loop</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">average_pool</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">device</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="bmodel_regpath-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#bmodel_regpath"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="bmodel_regpath-1090"><a href="#bmodel_regpath-1090"><span class="linenos">1090</span></a><span class="k">def</span> <span class="nf">bmodel_regpath</span><span class="p">(</span>
</span><span id="bmodel_regpath-1091"><a href="#bmodel_regpath-1091"><span class="linenos">1091</span></a>    <span class="n">model</span><span class="p">,</span> <span class="n">train_ds</span><span class="p">,</span> <span class="n">val_ds</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_vals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ffnet_target</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">layer_target</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
</span><span id="bmodel_regpath-1092"><a href="#bmodel_regpath-1092"><span class="linenos">1092</span></a>    <span class="n">nullLL</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">couple_xt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hard_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extended_loop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">average_pool</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="bmodel_regpath-1093"><a href="#bmodel_regpath-1093"><span class="linenos">1093</span></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="bmodel_regpath-1094"><a href="#bmodel_regpath-1094"><span class="linenos">1094</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="bmodel_regpath-1095"><a href="#bmodel_regpath-1095"><span class="linenos">1095</span></a><span class="sd">    regularization-path for NDN model -- standard I think other than using specific details of the model</span>
</span><span id="bmodel_regpath-1096"><a href="#bmodel_regpath-1096"><span class="linenos">1096</span></a>
</span><span id="bmodel_regpath-1097"><a href="#bmodel_regpath-1097"><span class="linenos">1097</span></a><span class="sd">    Args:</span>
</span><span id="bmodel_regpath-1098"><a href="#bmodel_regpath-1098"><span class="linenos">1098</span></a><span class="sd">        model: model to be regularized</span>
</span><span id="bmodel_regpath-1099"><a href="#bmodel_regpath-1099"><span class="linenos">1099</span></a><span class="sd">        train_ds: dataset to be used for training (generic, on device already)</span>
</span><span id="bmodel_regpath-1100"><a href="#bmodel_regpath-1100"><span class="linenos">1100</span></a><span class="sd">        val_ds: dataset for validation, complementary to train_ds</span>
</span><span id="bmodel_regpath-1101"><a href="#bmodel_regpath-1101"><span class="linenos">1101</span></a><span class="sd">        reg_type: type of regularization (required)</span>
</span><span id="bmodel_regpath-1102"><a href="#bmodel_regpath-1102"><span class="linenos">1102</span></a><span class="sd">        reg_vals: list of regularization values (default: [1e-6, 0.0001, 0.001, 0.01, 0.1])</span>
</span><span id="bmodel_regpath-1103"><a href="#bmodel_regpath-1103"><span class="linenos">1103</span></a><span class="sd">        ffnet_target: which ffnetwork that containes layer to regularize (default: 0)</span>
</span><span id="bmodel_regpath-1104"><a href="#bmodel_regpath-1104"><span class="linenos">1104</span></a><span class="sd">        layer_target: which layer to regularize (default 0)</span>
</span><span id="bmodel_regpath-1105"><a href="#bmodel_regpath-1105"><span class="linenos">1105</span></a><span class="sd">        nullLL: give LL-null of model so that can correctly compute LLs relative to null model. Default is</span>
</span><span id="bmodel_regpath-1106"><a href="#bmodel_regpath-1106"><span class="linenos">1106</span></a><span class="sd">            None, where it will use the embedded null_adjusted=True of eval_models</span>
</span><span id="bmodel_regpath-1107"><a href="#bmodel_regpath-1107"><span class="linenos">1107</span></a><span class="sd">        couple_xt: whether to make d2t=d2x/2 coupled to &#39;d2x&#39; when its the reg_type (default: True)</span>
</span><span id="bmodel_regpath-1108"><a href="#bmodel_regpath-1108"><span class="linenos">1108</span></a><span class="sd">        extended_loop: whether to continue with reg_vals of factors of 10 if best value is last (default: True)</span>
</span><span id="bmodel_regpath-1109"><a href="#bmodel_regpath-1109"><span class="linenos">1109</span></a><span class="sd">        hard_reset: when set to &#39;True&#39;: will zero out drift model to force model to fit longer (default: False)</span>
</span><span id="bmodel_regpath-1110"><a href="#bmodel_regpath-1110"><span class="linenos">1110</span></a><span class="sd">        average_pool: if population model, which fraction of LLs to average over to determine </span>
</span><span id="bmodel_regpath-1111"><a href="#bmodel_regpath-1111"><span class="linenos">1111</span></a><span class="sd">            the best-reg (default: 1=all)</span>
</span><span id="bmodel_regpath-1112"><a href="#bmodel_regpath-1112"><span class="linenos">1112</span></a><span class="sd">        verbose: self-explanatory (default: True)</span>
</span><span id="bmodel_regpath-1113"><a href="#bmodel_regpath-1113"><span class="linenos">1113</span></a><span class="sd">        device: which device to use (default cuda:0)</span>
</span><span id="bmodel_regpath-1114"><a href="#bmodel_regpath-1114"><span class="linenos">1114</span></a>
</span><span id="bmodel_regpath-1115"><a href="#bmodel_regpath-1115"><span class="linenos">1115</span></a><span class="sd">    Returns:</span>
</span><span id="bmodel_regpath-1116"><a href="#bmodel_regpath-1116"><span class="linenos">1116</span></a><span class="sd">        model_select: selected model</span>
</span><span id="bmodel_regpath-1117"><a href="#bmodel_regpath-1117"><span class="linenos">1117</span></a><span class="sd">        reg_val: selected reg value from the reg_vals list</span>
</span><span id="bmodel_regpath-1118"><a href="#bmodel_regpath-1118"><span class="linenos">1118</span></a><span class="sd">        export_dict: dictionary with detailed information of reg path</span>
</span><span id="bmodel_regpath-1119"><a href="#bmodel_regpath-1119"><span class="linenos">1119</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="bmodel_regpath-1120"><a href="#bmodel_regpath-1120"><span class="linenos">1120</span></a>    <span class="kn">import</span> <span class="nn">torch</span>
</span><span id="bmodel_regpath-1121"><a href="#bmodel_regpath-1121"><span class="linenos">1121</span></a>    <span class="kn">from</span> <span class="nn">NDNT.utils</span> <span class="kn">import</span> <span class="n">fit_lbfgs</span>
</span><span id="bmodel_regpath-1122"><a href="#bmodel_regpath-1122"><span class="linenos">1122</span></a>
</span><span id="bmodel_regpath-1123"><a href="#bmodel_regpath-1123"><span class="linenos">1123</span></a>    <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;ERROR: Must specify reg_type&quot;</span>
</span><span id="bmodel_regpath-1124"><a href="#bmodel_regpath-1124"><span class="linenos">1124</span></a>    <span class="k">assert</span> <span class="n">average_pool</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;average_pool mis-set&quot;</span>
</span><span id="bmodel_regpath-1125"><a href="#bmodel_regpath-1125"><span class="linenos">1125</span></a>    <span class="n">MAX_REGS</span> <span class="o">=</span> <span class="mi">16</span>
</span><span id="bmodel_regpath-1126"><a href="#bmodel_regpath-1126"><span class="linenos">1126</span></a>
</span><span id="bmodel_regpath-1127"><a href="#bmodel_regpath-1127"><span class="linenos">1127</span></a>    <span class="k">if</span> <span class="n">reg_vals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="bmodel_regpath-1128"><a href="#bmodel_regpath-1128"><span class="linenos">1128</span></a>        <span class="n">reg_vals</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]</span>
</span><span id="bmodel_regpath-1129"><a href="#bmodel_regpath-1129"><span class="linenos">1129</span></a>    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="bmodel_regpath-1130"><a href="#bmodel_regpath-1130"><span class="linenos">1130</span></a>        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
</span><span id="bmodel_regpath-1131"><a href="#bmodel_regpath-1131"><span class="linenos">1131</span></a>
</span><span id="bmodel_regpath-1132"><a href="#bmodel_regpath-1132"><span class="linenos">1132</span></a>    <span class="n">num_regs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_vals</span><span class="p">)</span>
</span><span id="bmodel_regpath-1133"><a href="#bmodel_regpath-1133"><span class="linenos">1133</span></a>    <span class="n">Rmods</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="bmodel_regpath-1134"><a href="#bmodel_regpath-1134"><span class="linenos">1134</span></a>    <span class="n">LLsR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_regs</span><span class="p">)</span>
</span><span id="bmodel_regpath-1135"><a href="#bmodel_regpath-1135"><span class="linenos">1135</span></a>    <span class="n">LLcells</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="bmodel_regpath-1136"><a href="#bmodel_regpath-1136"><span class="linenos">1136</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="bmodel_regpath-1137"><a href="#bmodel_regpath-1137"><span class="linenos">1137</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Reg path </span><span class="si">%s</span><span class="s2">:&quot;</span><span class="o">%</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_vals</span><span class="p">)</span>
</span><span id="bmodel_regpath-1138"><a href="#bmodel_regpath-1138"><span class="linenos">1138</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg_vals</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="bmodel_regpath-1139"><a href="#bmodel_regpath-1139"><span class="linenos">1139</span></a>        <span class="n">reg_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reg_vals</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="bmodel_regpath-1140"><a href="#bmodel_regpath-1140"><span class="linenos">1140</span></a>
</span><span id="bmodel_regpath-1141"><a href="#bmodel_regpath-1141"><span class="linenos">1141</span></a>    <span class="c1">## This is a loop so that regularization path can be extended until LLs go down</span>
</span><span id="bmodel_regpath-1142"><a href="#bmodel_regpath-1142"><span class="linenos">1142</span></a>    <span class="n">LLbest</span><span class="p">,</span> <span class="n">rr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="bmodel_regpath-1143"><a href="#bmodel_regpath-1143"><span class="linenos">1143</span></a>    <span class="c1">#for rr in range(num_regs):</span>
</span><span id="bmodel_regpath-1144"><a href="#bmodel_regpath-1144"><span class="linenos">1144</span></a>    <span class="k">while</span> <span class="n">rr</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reg_vals</span><span class="p">),</span> <span class="n">MAX_REGS</span><span class="p">):</span>
</span><span id="bmodel_regpath-1145"><a href="#bmodel_regpath-1145"><span class="linenos">1145</span></a>
</span><span id="bmodel_regpath-1146"><a href="#bmodel_regpath-1146"><span class="linenos">1146</span></a>        <span class="n">sico_iter</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="bmodel_regpath-1147"><a href="#bmodel_regpath-1147"><span class="linenos">1147</span></a>        <span class="n">sico_iter</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">ffnet_target</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_target</span><span class="p">]</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="n">reg_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_vals</span><span class="p">[</span><span class="n">rr</span><span class="p">]</span>
</span><span id="bmodel_regpath-1148"><a href="#bmodel_regpath-1148"><span class="linenos">1148</span></a>        
</span><span id="bmodel_regpath-1149"><a href="#bmodel_regpath-1149"><span class="linenos">1149</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;d2x&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">couple_xt</span><span class="p">:</span>  <span class="c1"># then couple d2t</span>
</span><span id="bmodel_regpath-1150"><a href="#bmodel_regpath-1150"><span class="linenos">1150</span></a>            <span class="n">sico_iter</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">ffnet_target</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_target</span><span class="p">]</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;d2t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_vals</span><span class="p">[</span><span class="n">rr</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
</span><span id="bmodel_regpath-1151"><a href="#bmodel_regpath-1151"><span class="linenos">1151</span></a>            
</span><span id="bmodel_regpath-1152"><a href="#bmodel_regpath-1152"><span class="linenos">1152</span></a>        <span class="k">if</span> <span class="n">hard_reset</span><span class="p">:</span>
</span><span id="bmodel_regpath-1153"><a href="#bmodel_regpath-1153"><span class="linenos">1153</span></a>            <span class="n">sico_iter</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="bmodel_regpath-1154"><a href="#bmodel_regpath-1154"><span class="linenos">1154</span></a>            
</span><span id="bmodel_regpath-1155"><a href="#bmodel_regpath-1155"><span class="linenos">1155</span></a>        <span class="n">sico_iter</span> <span class="o">=</span> <span class="n">sico_iter</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="bmodel_regpath-1156"><a href="#bmodel_regpath-1156"><span class="linenos">1156</span></a>        <span class="n">fit_lbfgs</span><span class="p">(</span> <span class="n">sico_iter</span><span class="p">,</span> <span class="n">train_ds</span><span class="p">[:],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="bmodel_regpath-1157"><a href="#bmodel_regpath-1157"><span class="linenos">1157</span></a>        
</span><span id="bmodel_regpath-1158"><a href="#bmodel_regpath-1158"><span class="linenos">1158</span></a>        <span class="k">if</span> <span class="n">nullLL</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="bmodel_regpath-1159"><a href="#bmodel_regpath-1159"><span class="linenos">1159</span></a>            <span class="n">LLs</span> <span class="o">=</span> <span class="n">sico_iter</span><span class="o">.</span><span class="n">eval_models</span><span class="p">(</span><span class="n">val_ds</span><span class="p">[:],</span> <span class="n">null_adjusted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="bmodel_regpath-1160"><a href="#bmodel_regpath-1160"><span class="linenos">1160</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="bmodel_regpath-1161"><a href="#bmodel_regpath-1161"><span class="linenos">1161</span></a>            <span class="n">LLs</span> <span class="o">=</span> <span class="n">nullLL</span><span class="o">-</span><span class="n">LLs</span>
</span><span id="bmodel_regpath-1162"><a href="#bmodel_regpath-1162"><span class="linenos">1162</span></a>        <span class="n">sico_iter</span> <span class="o">=</span> <span class="n">sico_iter</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">))</span>
</span><span id="bmodel_regpath-1163"><a href="#bmodel_regpath-1163"><span class="linenos">1163</span></a>        <span class="n">LLcells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">LLs</span><span class="p">))</span>
</span><span id="bmodel_regpath-1164"><a href="#bmodel_regpath-1164"><span class="linenos">1164</span></a>
</span><span id="bmodel_regpath-1165"><a href="#bmodel_regpath-1165"><span class="linenos">1165</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">LLs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="bmodel_regpath-1166"><a href="#bmodel_regpath-1166"><span class="linenos">1166</span></a>            <span class="n">LL</span> <span class="o">=</span> <span class="n">LLs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="bmodel_regpath-1167"><a href="#bmodel_regpath-1167"><span class="linenos">1167</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="bmodel_regpath-1168"><a href="#bmodel_regpath-1168"><span class="linenos">1168</span></a>            <span class="k">if</span> <span class="n">average_pool</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="bmodel_regpath-1169"><a href="#bmodel_regpath-1169"><span class="linenos">1169</span></a>                <span class="n">LL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">LLs</span><span class="p">)</span>
</span><span id="bmodel_regpath-1170"><a href="#bmodel_regpath-1170"><span class="linenos">1170</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="bmodel_regpath-1171"><a href="#bmodel_regpath-1171"><span class="linenos">1171</span></a>                <span class="n">num_skip</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">LLs</span><span class="p">)</span><span class="o">*</span><span class="n">average_pool</span><span class="p">))</span>
</span><span id="bmodel_regpath-1172"><a href="#bmodel_regpath-1172"><span class="linenos">1172</span></a>                <span class="n">LL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">LLs</span><span class="p">)[</span><span class="n">num_skip</span><span class="p">:])</span>
</span><span id="bmodel_regpath-1173"><a href="#bmodel_regpath-1173"><span class="linenos">1173</span></a>                
</span><span id="bmodel_regpath-1174"><a href="#bmodel_regpath-1174"><span class="linenos">1174</span></a>        <span class="n">Rmods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sico_iter</span><span class="p">))</span>
</span><span id="bmodel_regpath-1175"><a href="#bmodel_regpath-1175"><span class="linenos">1175</span></a>        <span class="n">LLsR</span><span class="p">[</span><span class="n">rr</span><span class="p">]</span> <span class="o">=</span> <span class="n">LL</span>
</span><span id="bmodel_regpath-1176"><a href="#bmodel_regpath-1176"><span class="linenos">1176</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">LL</span> <span class="o">&gt;</span> <span class="n">LLbest</span><span class="p">):</span>
</span><span id="bmodel_regpath-1177"><a href="#bmodel_regpath-1177"><span class="linenos">1177</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  </span><span class="si">%s</span><span class="s2">-</span><span class="si">%d</span><span class="s2">: </span><span class="si">%9.6f</span><span class="s2"> **&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">rr</span><span class="p">,</span> <span class="n">LL</span><span class="p">))</span>
</span><span id="bmodel_regpath-1178"><a href="#bmodel_regpath-1178"><span class="linenos">1178</span></a>            <span class="c1">#BU.plot_mfilters(sico_iter, TB)</span>
</span><span id="bmodel_regpath-1179"><a href="#bmodel_regpath-1179"><span class="linenos">1179</span></a>            <span class="n">LLbest</span> <span class="o">=</span> <span class="n">LL</span>
</span><span id="bmodel_regpath-1180"><a href="#bmodel_regpath-1180"><span class="linenos">1180</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">rr</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_vals</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">extended_loop</span><span class="p">:</span>
</span><span id="bmodel_regpath-1181"><a href="#bmodel_regpath-1181"><span class="linenos">1181</span></a>                <span class="n">reg_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">reg_vals</span><span class="p">,</span> <span class="p">[</span><span class="n">reg_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="p">])</span> <span class="p">)</span>
</span><span id="bmodel_regpath-1182"><a href="#bmodel_regpath-1182"><span class="linenos">1182</span></a>                <span class="n">LLsR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">LLsR</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span> <span class="c1"># so loop continues, adding value</span>
</span><span id="bmodel_regpath-1183"><a href="#bmodel_regpath-1183"><span class="linenos">1183</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="bmodel_regpath-1184"><a href="#bmodel_regpath-1184"><span class="linenos">1184</span></a>                    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;    Adding additional reg_val:&#39;</span><span class="p">,</span> <span class="n">reg_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="bmodel_regpath-1185"><a href="#bmodel_regpath-1185"><span class="linenos">1185</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="bmodel_regpath-1186"><a href="#bmodel_regpath-1186"><span class="linenos">1186</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;  </span><span class="si">%s</span><span class="s2">-</span><span class="si">%d</span><span class="s2">: </span><span class="si">%9.6f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">rr</span><span class="p">,</span> <span class="n">LL</span><span class="p">))</span>
</span><span id="bmodel_regpath-1187"><a href="#bmodel_regpath-1187"><span class="linenos">1187</span></a>        <span class="n">rr</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="bmodel_regpath-1188"><a href="#bmodel_regpath-1188"><span class="linenos">1188</span></a>
</span><span id="bmodel_regpath-1189"><a href="#bmodel_regpath-1189"><span class="linenos">1189</span></a>    <span class="c1">#if thresh &lt; 1.0:</span>
</span><span id="bmodel_regpath-1190"><a href="#bmodel_regpath-1190"><span class="linenos">1190</span></a>    <span class="c1">#    reg_select = model_selection( LLsR, thresh, verbose=verbose )</span>
</span><span id="bmodel_regpath-1191"><a href="#bmodel_regpath-1191"><span class="linenos">1191</span></a>    <span class="c1">#else:</span>
</span><span id="bmodel_regpath-1192"><a href="#bmodel_regpath-1192"><span class="linenos">1192</span></a>    <span class="n">reg_select</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">LLsR</span><span class="p">)</span>
</span><span id="bmodel_regpath-1193"><a href="#bmodel_regpath-1193"><span class="linenos">1193</span></a>
</span><span id="bmodel_regpath-1194"><a href="#bmodel_regpath-1194"><span class="linenos">1194</span></a>    <span class="n">reg_val</span> <span class="o">=</span> <span class="n">reg_vals</span><span class="p">[</span><span class="n">reg_select</span><span class="p">]</span>
</span><span id="bmodel_regpath-1195"><a href="#bmodel_regpath-1195"><span class="linenos">1195</span></a>    <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Finished </span><span class="si">%s</span><span class="s2">: selected reg&quot;</span><span class="o">%</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">,</span> <span class="s2">&quot;(</span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="n">reg_select</span> <span class="p">)</span>
</span><span id="bmodel_regpath-1196"><a href="#bmodel_regpath-1196"><span class="linenos">1196</span></a>    <span class="n">model_select</span> <span class="o">=</span> <span class="n">Rmods</span><span class="p">[</span><span class="n">reg_select</span><span class="p">]</span>
</span><span id="bmodel_regpath-1197"><a href="#bmodel_regpath-1197"><span class="linenos">1197</span></a>    <span class="n">export_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="bmodel_regpath-1198"><a href="#bmodel_regpath-1198"><span class="linenos">1198</span></a>        <span class="s1">&#39;Rmods&#39;</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">Rmods</span><span class="p">),</span> <span class="s1">&#39;LLsR&#39;</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">LLsR</span><span class="p">),</span> <span class="s2">&quot;reg_vals&quot;</span><span class="p">:</span> <span class="n">reg_vals</span><span class="p">,</span>
</span><span id="bmodel_regpath-1199"><a href="#bmodel_regpath-1199"><span class="linenos">1199</span></a>        <span class="s1">&#39;LLcells&#39;</span><span class="p">:</span> <span class="n">LLcells</span><span class="p">}</span>
</span><span id="bmodel_regpath-1200"><a href="#bmodel_regpath-1200"><span class="linenos">1200</span></a>    <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">model_select</span><span class="p">),</span> <span class="n">reg_val</span><span class="p">,</span> <span class="n">export_dict</span>
</span></pre></div>


            <div class="docstring"><p>regularization-path for NDN model -- standard I think other than using specific details of the model</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>model:</strong>  model to be regularized</li>
<li><strong>train_ds:</strong>  dataset to be used for training (generic, on device already)</li>
<li><strong>val_ds:</strong>  dataset for validation, complementary to train_ds</li>
<li><strong>reg_type:</strong>  type of regularization (required)</li>
<li><strong>reg_vals:</strong>  list of regularization values (default: [1e-6, 0.0001, 0.001, 0.01, 0.1])</li>
<li><strong>ffnet_target:</strong>  which ffnetwork that containes layer to regularize (default: 0)</li>
<li><strong>layer_target:</strong>  which layer to regularize (default 0)</li>
<li><strong>nullLL:</strong>  give LL-null of model so that can correctly compute LLs relative to null model. Default is
None, where it will use the embedded null_adjusted=True of eval_models</li>
<li><strong>couple_xt:</strong>  whether to make d2t=d2x/2 coupled to 'd2x' when its the reg_type (default: True)</li>
<li><strong>extended_loop:</strong>  whether to continue with reg_vals of factors of 10 if best value is last (default: True)</li>
<li><strong>hard_reset:</strong>  when set to 'True': will zero out drift model to force model to fit longer (default: False)</li>
<li><strong>average_pool:</strong>  if population model, which fraction of LLs to average over to determine 
the best-reg (default: 1=all)</li>
<li><strong>verbose:</strong>  self-explanatory (default: True)</li>
<li><strong>device:</strong>  which device to use (default cuda:0)</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>model_select: selected model
  reg_val: selected reg value from the reg_vals list
  export_dict: dictionary with detailed information of reg path</p>
</blockquote>
</div>


                </section>
                <section id="sico_ffnetworks">
                            <input id="sico_ffnetworks-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sico_ffnetworks</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">num_mfilters</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">num_clones</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">numBE</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">numBI</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">mask</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">monoc_width</span><span class="o">=</span><span class="mi">21</span>,</span><span class="param">	<span class="n">binoc_width</span><span class="o">=</span><span class="mi">13</span>,</span><span class="param">	<span class="n">num_tkerns</span><span class="o">=</span><span class="mi">8</span>,</span><span class="param">	<span class="n">NX</span><span class="o">=</span><span class="mi">36</span>,</span><span class="param">	<span class="n">pos_constraint</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">XregM</span><span class="o">=</span><span class="mf">0.0001</span>,</span><span class="param">	<span class="n">CregM</span><span class="o">=</span><span class="mf">0.001</span>,</span><span class="param">	<span class="n">MregB</span><span class="o">=</span><span class="mf">0.001</span>,</span><span class="param">	<span class="n">LOCregR</span><span class="o">=</span><span class="mf">0.1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="sico_ffnetworks-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#sico_ffnetworks"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="sico_ffnetworks-1204"><a href="#sico_ffnetworks-1204"><span class="linenos">1204</span></a><span class="k">def</span> <span class="nf">sico_ffnetworks</span><span class="p">(</span> 
</span><span id="sico_ffnetworks-1205"><a href="#sico_ffnetworks-1205"><span class="linenos">1205</span></a>        <span class="n">num_mfilters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_clones</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">numBE</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">numBI</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># must enter</span>
</span><span id="sico_ffnetworks-1206"><a href="#sico_ffnetworks-1206"><span class="linenos">1206</span></a>        <span class="n">monoc_width</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">binoc_width</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">num_tkerns</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">NX</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">pos_constraint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># default values</span>
</span><span id="sico_ffnetworks-1207"><a href="#sico_ffnetworks-1207"><span class="linenos">1207</span></a>        <span class="n">XregM</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">CregM</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">MregB</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">LOCregR</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>  <span class="c1"># regularization</span>
</span><span id="sico_ffnetworks-1208"><a href="#sico_ffnetworks-1208"><span class="linenos">1208</span></a>
</span><span id="sico_ffnetworks-1209"><a href="#sico_ffnetworks-1209"><span class="linenos">1209</span></a>    <span class="kn">from</span> <span class="nn">NDNT.modules.layers</span> <span class="kn">import</span> <span class="n">BiConvLayer1D</span><span class="p">,</span> <span class="n">NDNLayer</span><span class="p">,</span> <span class="n">ConvLayer</span><span class="p">,</span> <span class="n">MaskLayer</span><span class="p">,</span> <span class="n">ChannelLayer</span>
</span><span id="sico_ffnetworks-1210"><a href="#sico_ffnetworks-1210"><span class="linenos">1210</span></a>    <span class="kn">from</span> <span class="nn">NDNT.networks</span> <span class="kn">import</span> <span class="n">FFnetwork</span>
</span><span id="sico_ffnetworks-1211"><a href="#sico_ffnetworks-1211"><span class="linenos">1211</span></a>
</span><span id="sico_ffnetworks-1212"><a href="#sico_ffnetworks-1212"><span class="linenos">1212</span></a>    <span class="n">monoc_basis_par</span> <span class="o">=</span> <span class="n">BiConvLayer1D</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span> 
</span><span id="sico_ffnetworks-1213"><a href="#sico_ffnetworks-1213"><span class="linenos">1213</span></a>        <span class="n">input_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">NX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_tkerns</span><span class="p">],</span> <span class="n">num_filters</span><span class="o">=</span><span class="n">num_mfilters</span><span class="p">,</span> 
</span><span id="sico_ffnetworks-1214"><a href="#sico_ffnetworks-1214"><span class="linenos">1214</span></a>        <span class="n">filter_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">monoc_width</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_tkerns</span><span class="p">],</span>
</span><span id="sico_ffnetworks-1215"><a href="#sico_ffnetworks-1215"><span class="linenos">1215</span></a>        <span class="n">norm_type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initialize_center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;lin&#39;</span><span class="p">,</span>
</span><span id="sico_ffnetworks-1216"><a href="#sico_ffnetworks-1216"><span class="linenos">1216</span></a>        <span class="c1">#output_norm=&#39;batch&#39;, window=&#39;hamming&#39;, </span>
</span><span id="sico_ffnetworks-1217"><a href="#sico_ffnetworks-1217"><span class="linenos">1217</span></a>        <span class="n">reg_vals</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;d2x&#39;</span><span class="p">:</span><span class="n">XregM</span><span class="p">,</span> <span class="s1">&#39;center&#39;</span><span class="p">:</span><span class="n">CregM</span> <span class="p">})</span>
</span><span id="sico_ffnetworks-1218"><a href="#sico_ffnetworks-1218"><span class="linenos">1218</span></a>        <span class="c1">#reg_vals={&#39;d2x&#39;:XregM, &#39;d2t&#39;:TregM, &#39;center&#39;:CregM })</span>
</span><span id="sico_ffnetworks-1219"><a href="#sico_ffnetworks-1219"><span class="linenos">1219</span></a>
</span><span id="sico_ffnetworks-1220"><a href="#sico_ffnetworks-1220"><span class="linenos">1220</span></a>    <span class="n">bfilt_par</span> <span class="o">=</span> <span class="n">ConvLayer</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span> 
</span><span id="sico_ffnetworks-1221"><a href="#sico_ffnetworks-1221"><span class="linenos">1221</span></a>        <span class="n">num_filters</span><span class="o">=</span><span class="p">(</span><span class="n">numBE</span><span class="o">+</span><span class="n">numBI</span><span class="p">),</span> <span class="n">num_inh</span><span class="o">=</span><span class="n">numBI</span><span class="p">,</span> <span class="n">filter_dims</span><span class="o">=</span><span class="n">binoc_width</span><span class="p">,</span> 
</span><span id="sico_ffnetworks-1222"><a href="#sico_ffnetworks-1222"><span class="linenos">1222</span></a>        <span class="n">norm_type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pos_constraint</span><span class="o">=</span><span class="n">pos_constraint</span><span class="p">,</span>
</span><span id="sico_ffnetworks-1223"><a href="#sico_ffnetworks-1223"><span class="linenos">1223</span></a>        <span class="n">window</span><span class="o">=</span><span class="s1">&#39;hamming&#39;</span><span class="p">,</span> <span class="c1">#output_norm=&#39;batch&#39;, #padding=&#39;valid&#39;,</span>
</span><span id="sico_ffnetworks-1224"><a href="#sico_ffnetworks-1224"><span class="linenos">1224</span></a>        <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initialize_center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="sico_ffnetworks-1225"><a href="#sico_ffnetworks-1225"><span class="linenos">1225</span></a>        <span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">reg_vals</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;max_space&#39;</span><span class="p">:</span><span class="n">MregB</span><span class="p">})</span>
</span><span id="sico_ffnetworks-1226"><a href="#sico_ffnetworks-1226"><span class="linenos">1226</span></a>
</span><span id="sico_ffnetworks-1227"><a href="#sico_ffnetworks-1227"><span class="linenos">1227</span></a>    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="sico_ffnetworks-1228"><a href="#sico_ffnetworks-1228"><span class="linenos">1228</span></a>        <span class="n">readout_par</span> <span class="o">=</span> <span class="n">NDNLayer</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span>
</span><span id="sico_ffnetworks-1229"><a href="#sico_ffnetworks-1229"><span class="linenos">1229</span></a>            <span class="n">num_filters</span><span class="o">=</span><span class="n">num_clones</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initialize_center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pos_constraint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="sico_ffnetworks-1230"><a href="#sico_ffnetworks-1230"><span class="linenos">1230</span></a>            <span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;lin&#39;</span><span class="p">,</span> <span class="n">reg_vals</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;glocalx&#39;</span><span class="p">:</span> <span class="n">LOCregR</span><span class="p">})</span>
</span><span id="sico_ffnetworks-1231"><a href="#sico_ffnetworks-1231"><span class="linenos">1231</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="sico_ffnetworks-1232"><a href="#sico_ffnetworks-1232"><span class="linenos">1232</span></a>        <span class="n">readout_par</span> <span class="o">=</span> <span class="n">MaskLayer</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span>
</span><span id="sico_ffnetworks-1233"><a href="#sico_ffnetworks-1233"><span class="linenos">1233</span></a>            <span class="n">num_filters</span><span class="o">=</span><span class="n">num_clones</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initialize_center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pos_constraint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="sico_ffnetworks-1234"><a href="#sico_ffnetworks-1234"><span class="linenos">1234</span></a>            <span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;lin&#39;</span><span class="p">,</span> <span class="n">reg_vals</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;glocalx&#39;</span><span class="p">:</span> <span class="n">LOCregR</span><span class="p">})</span>
</span><span id="sico_ffnetworks-1235"><a href="#sico_ffnetworks-1235"><span class="linenos">1235</span></a>
</span><span id="sico_ffnetworks-1236"><a href="#sico_ffnetworks-1236"><span class="linenos">1236</span></a>    <span class="k">if</span> <span class="n">num_clones</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="sico_ffnetworks-1237"><a href="#sico_ffnetworks-1237"><span class="linenos">1237</span></a>        <span class="n">comb_layer</span> <span class="o">=</span> <span class="n">ChannelLayer</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span><span class="n">num_filters</span><span class="o">=</span><span class="n">num_clones</span><span class="p">,</span> <span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;softplus&#39;</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="sico_ffnetworks-1238"><a href="#sico_ffnetworks-1238"><span class="linenos">1238</span></a>    <span class="k">else</span><span class="p">:</span> 
</span><span id="sico_ffnetworks-1239"><a href="#sico_ffnetworks-1239"><span class="linenos">1239</span></a>        <span class="n">comb_layer</span> <span class="o">=</span> <span class="n">NDNLayer</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span><span class="n">num_filters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;softplus&#39;</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="sico_ffnetworks-1240"><a href="#sico_ffnetworks-1240"><span class="linenos">1240</span></a>    <span class="n">comb_layer</span><span class="p">[</span><span class="s1">&#39;weights_initializer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ones&#39;</span>
</span><span id="sico_ffnetworks-1241"><a href="#sico_ffnetworks-1241"><span class="linenos">1241</span></a>
</span><span id="sico_ffnetworks-1242"><a href="#sico_ffnetworks-1242"><span class="linenos">1242</span></a>    <span class="n">stim_net</span> <span class="o">=</span> <span class="n">FFnetwork</span><span class="o">.</span><span class="n">ffnet_dict</span><span class="p">(</span> <span class="n">xstim_n</span><span class="o">=</span><span class="s1">&#39;stim&#39;</span><span class="p">,</span> <span class="n">layer_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">monoc_basis_par</span><span class="p">,</span> <span class="n">bfilt_par</span><span class="p">,</span> <span class="n">readout_par</span><span class="p">])</span>
</span><span id="sico_ffnetworks-1243"><a href="#sico_ffnetworks-1243"><span class="linenos">1243</span></a>    <span class="n">net_comb</span> <span class="o">=</span> <span class="n">FFnetwork</span><span class="o">.</span><span class="n">ffnet_dict</span><span class="p">(</span> <span class="n">xstim_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ffnet_n</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">layer_list</span><span class="o">=</span><span class="p">[</span><span class="n">comb_layer</span><span class="p">],</span> <span class="n">ffnet_type</span><span class="o">=</span><span class="s1">&#39;add&#39;</span><span class="p">)</span>
</span><span id="sico_ffnetworks-1244"><a href="#sico_ffnetworks-1244"><span class="linenos">1244</span></a>
</span><span id="sico_ffnetworks-1245"><a href="#sico_ffnetworks-1245"><span class="linenos">1245</span></a>    <span class="k">return</span> <span class="n">stim_net</span><span class="p">,</span> <span class="n">net_comb</span>
</span></pre></div>


    

                </section>
                <section id="clone_path_prepare_data">
                            <input id="clone_path_prepare_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clone_path_prepare_data</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">ee</span>,</span><span class="param">	<span class="n">cc</span>,</span><span class="param">	<span class="n">TB</span>,</span><span class="param">	<span class="n">nlags</span><span class="o">=</span><span class="mi">12</span>,</span><span class="param">	<span class="n">clone_model</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">num_clones</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">check_performance</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">dirname</span><span class="o">=</span><span class="p">[]</span>,</span><span class="param">	<span class="n">datadir</span><span class="o">=</span><span class="p">[]</span>,</span><span class="param">	<span class="n">device</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="clone_path_prepare_data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#clone_path_prepare_data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="clone_path_prepare_data-1248"><a href="#clone_path_prepare_data-1248"><span class="linenos">1248</span></a><span class="k">def</span> <span class="nf">clone_path_prepare_data</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">TB</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">clone_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_clones</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_performance</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
</span><span id="clone_path_prepare_data-1249"><a href="#clone_path_prepare_data-1249"><span class="linenos">1249</span></a>                            <span class="n">dirname</span><span class="o">=</span><span class="p">[],</span> <span class="n">datadir</span><span class="o">=</span><span class="p">[],</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="clone_path_prepare_data-1250"><a href="#clone_path_prepare_data-1250"><span class="linenos">1250</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="clone_path_prepare_data-1251"><a href="#clone_path_prepare_data-1251"><span class="linenos">1251</span></a><span class="sd">    Load dataset and clone model from respective directories for regularization</span>
</span><span id="clone_path_prepare_data-1252"><a href="#clone_path_prepare_data-1252"><span class="linenos">1252</span></a><span class="sd">    So also translates models into </span>
</span><span id="clone_path_prepare_data-1253"><a href="#clone_path_prepare_data-1253"><span class="linenos">1253</span></a><span class="sd">    Uses already-defined datadir and dirname respectively</span>
</span><span id="clone_path_prepare_data-1254"><a href="#clone_path_prepare_data-1254"><span class="linenos">1254</span></a><span class="sd">    </span>
</span><span id="clone_path_prepare_data-1255"><a href="#clone_path_prepare_data-1255"><span class="linenos">1255</span></a><span class="sd">    Args:</span>
</span><span id="clone_path_prepare_data-1256"><a href="#clone_path_prepare_data-1256"><span class="linenos">1256</span></a><span class="sd">        ee: expt number starting with zero</span>
</span><span id="clone_path_prepare_data-1257"><a href="#clone_path_prepare_data-1257"><span class="linenos">1257</span></a><span class="sd">        cc: cell number starting with zero</span>
</span><span id="clone_path_prepare_data-1258"><a href="#clone_path_prepare_data-1258"><span class="linenos">1258</span></a><span class="sd">        TB: temporal bases used to fit clones</span>
</span><span id="clone_path_prepare_data-1259"><a href="#clone_path_prepare_data-1259"><span class="linenos">1259</span></a><span class="sd">        </span>
</span><span id="clone_path_prepare_data-1260"><a href="#clone_path_prepare_data-1260"><span class="linenos">1260</span></a><span class="sd">    Returns:</span>
</span><span id="clone_path_prepare_data-1261"><a href="#clone_path_prepare_data-1261"><span class="linenos">1261</span></a><span class="sd">        data_clone: dataset made to fit clone models</span>
</span><span id="clone_path_prepare_data-1262"><a href="#clone_path_prepare_data-1262"><span class="linenos">1262</span></a><span class="sd">        data1: dataset made to fit single copy of cell</span>
</span><span id="clone_path_prepare_data-1263"><a href="#clone_path_prepare_data-1263"><span class="linenos">1263</span></a><span class="sd">        clone_path_info: dictionary with the following info (if applicable)</span>
</span><span id="clone_path_prepare_data-1264"><a href="#clone_path_prepare_data-1264"><span class="linenos">1264</span></a><span class="sd">            LLnull: null model LL computed by fitting drift model</span>
</span><span id="clone_path_prepare_data-1265"><a href="#clone_path_prepare_data-1265"><span class="linenos">1265</span></a><span class="sd">            drift_terms: drift terms for number of clones specified</span>
</span><span id="clone_path_prepare_data-1266"><a href="#clone_path_prepare_data-1266"><span class="linenos">1266</span></a><span class="sd">            base_model: base clone model with spatiotemporal filters and nlags, if included</span>
</span><span id="clone_path_prepare_data-1267"><a href="#clone_path_prepare_data-1267"><span class="linenos">1267</span></a><span class="sd">            LLs: null-adjusted LLs of clone model, if included</span>
</span><span id="clone_path_prepare_data-1268"><a href="#clone_path_prepare_data-1268"><span class="linenos">1268</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="clone_path_prepare_data-1269"><a href="#clone_path_prepare_data-1269"><span class="linenos">1269</span></a>    <span class="kn">import</span> <span class="nn">torch</span>
</span><span id="clone_path_prepare_data-1270"><a href="#clone_path_prepare_data-1270"><span class="linenos">1270</span></a>    <span class="kn">from</span> <span class="nn">NTdatasets.generic</span> <span class="kn">import</span> <span class="n">GenericDataset</span>
</span><span id="clone_path_prepare_data-1271"><a href="#clone_path_prepare_data-1271"><span class="linenos">1271</span></a>    <span class="kn">from</span> <span class="nn">NTdatasets.cumming.binocular</span> <span class="kn">import</span> <span class="n">binocular_single</span>
</span><span id="clone_path_prepare_data-1272"><a href="#clone_path_prepare_data-1272"><span class="linenos">1272</span></a>    <span class="kn">from</span> <span class="nn">NDNT.modules.layers.ndnlayer</span> <span class="kn">import</span> <span class="n">NDNLayer</span>
</span><span id="clone_path_prepare_data-1273"><a href="#clone_path_prepare_data-1273"><span class="linenos">1273</span></a>    
</span><span id="clone_path_prepare_data-1274"><a href="#clone_path_prepare_data-1274"><span class="linenos">1274</span></a>    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="clone_path_prepare_data-1275"><a href="#clone_path_prepare_data-1275"><span class="linenos">1275</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</span><span id="clone_path_prepare_data-1276"><a href="#clone_path_prepare_data-1276"><span class="linenos">1276</span></a>
</span><span id="clone_path_prepare_data-1277"><a href="#clone_path_prepare_data-1277"><span class="linenos">1277</span></a>    <span class="n">Dreg</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="clone_path_prepare_data-1278"><a href="#clone_path_prepare_data-1278"><span class="linenos">1278</span></a>    <span class="k">if</span> <span class="n">clone_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="clone_path_prepare_data-1279"><a href="#clone_path_prepare_data-1279"><span class="linenos">1279</span></a>        <span class="k">if</span> <span class="n">num_clones</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># then assume its a file loading</span>
</span><span id="clone_path_prepare_data-1280"><a href="#clone_path_prepare_data-1280"><span class="linenos">1280</span></a>            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;E</span><span class="si">%s</span><span class="s2">c</span><span class="si">%s</span><span class="s2">clones.ndn&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">filename_num2str</span><span class="p">(</span><span class="n">ee</span><span class="p">),</span> <span class="n">utils</span><span class="o">.</span><span class="n">filename_num2str</span><span class="p">(</span><span class="n">cc</span><span class="p">))</span>
</span><span id="clone_path_prepare_data-1281"><a href="#clone_path_prepare_data-1281"><span class="linenos">1281</span></a>            <span class="n">base_model</span> <span class="o">=</span> <span class="n">NDN</span><span class="o">.</span><span class="n">load_model_zip</span><span class="p">(</span><span class="n">dirname</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span>
</span><span id="clone_path_prepare_data-1282"><a href="#clone_path_prepare_data-1282"><span class="linenos">1282</span></a>            <span class="n">base_model</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">mask_is_set</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="clone_path_prepare_data-1283"><a href="#clone_path_prepare_data-1283"><span class="linenos">1283</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="clone_path_prepare_data-1284"><a href="#clone_path_prepare_data-1284"><span class="linenos">1284</span></a>            <span class="n">base_model</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="clone_path_prepare_data-1285"><a href="#clone_path_prepare_data-1285"><span class="linenos">1285</span></a>            <span class="n">NX</span> <span class="o">=</span> <span class="mi">36</span>
</span><span id="clone_path_prepare_data-1286"><a href="#clone_path_prepare_data-1286"><span class="linenos">1286</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="clone_path_prepare_data-1287"><a href="#clone_path_prepare_data-1287"><span class="linenos">1287</span></a>        <span class="n">base_model</span> <span class="o">=</span> <span class="n">clone_model</span>
</span><span id="clone_path_prepare_data-1288"><a href="#clone_path_prepare_data-1288"><span class="linenos">1288</span></a>    <span class="k">if</span> <span class="n">base_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="clone_path_prepare_data-1289"><a href="#clone_path_prepare_data-1289"><span class="linenos">1289</span></a>        <span class="n">num_clones</span> <span class="o">=</span> <span class="n">base_model</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">output_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="clone_path_prepare_data-1290"><a href="#clone_path_prepare_data-1290"><span class="linenos">1290</span></a>        <span class="n">NX</span> <span class="o">=</span> <span class="n">base_model</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="clone_path_prepare_data-1291"><a href="#clone_path_prepare_data-1291"><span class="linenos">1291</span></a>        
</span><span id="clone_path_prepare_data-1292"><a href="#clone_path_prepare_data-1292"><span class="linenos">1292</span></a>    <span class="n">old_nlags</span><span class="p">,</span> <span class="n">num_tk</span> <span class="o">=</span> <span class="n">TB</span><span class="o">.</span><span class="n">shape</span>
</span><span id="clone_path_prepare_data-1293"><a href="#clone_path_prepare_data-1293"><span class="linenos">1293</span></a>
</span><span id="clone_path_prepare_data-1294"><a href="#clone_path_prepare_data-1294"><span class="linenos">1294</span></a>    <span class="c1"># Make datasets</span>
</span><span id="clone_path_prepare_data-1295"><a href="#clone_path_prepare_data-1295"><span class="linenos">1295</span></a>    <span class="n">data_clone</span> <span class="o">=</span> <span class="n">binocular_single</span><span class="p">(</span> <span class="n">expt_num</span><span class="o">=</span><span class="n">ee</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">datadir</span><span class="o">=</span><span class="n">datadir</span><span class="p">,</span> <span class="n">time_embed</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">skip_lags</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">old_nlags</span> <span class="p">)</span>
</span><span id="clone_path_prepare_data-1296"><a href="#clone_path_prepare_data-1296"><span class="linenos">1296</span></a>    <span class="k">if</span> <span class="n">nlags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="clone_path_prepare_data-1297"><a href="#clone_path_prepare_data-1297"><span class="linenos">1297</span></a>        <span class="n">data1</span> <span class="o">=</span> <span class="n">binocular_single</span><span class="p">(</span> <span class="n">expt_num</span><span class="o">=</span><span class="n">ee</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">datadir</span><span class="o">=</span><span class="n">datadir</span><span class="p">,</span> <span class="n">time_embed</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">skip_lags</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">nlags</span> <span class="p">)</span>
</span><span id="clone_path_prepare_data-1298"><a href="#clone_path_prepare_data-1298"><span class="linenos">1298</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="clone_path_prepare_data-1299"><a href="#clone_path_prepare_data-1299"><span class="linenos">1299</span></a>        <span class="n">data1</span> <span class="o">=</span> <span class="n">binocular_single</span><span class="p">(</span> <span class="n">expt_num</span><span class="o">=</span><span class="n">ee</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">datadir</span><span class="o">=</span><span class="n">datadir</span><span class="p">,</span> <span class="n">time_embed</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">skip_lags</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_lags</span><span class="o">=</span><span class="n">old_nlags</span> <span class="p">)</span>
</span><span id="clone_path_prepare_data-1300"><a href="#clone_path_prepare_data-1300"><span class="linenos">1300</span></a>        
</span><span id="clone_path_prepare_data-1301"><a href="#clone_path_prepare_data-1301"><span class="linenos">1301</span></a>    <span class="n">robs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">data1</span><span class="o">.</span><span class="n">robs</span><span class="p">)</span>
</span><span id="clone_path_prepare_data-1302"><a href="#clone_path_prepare_data-1302"><span class="linenos">1302</span></a>    <span class="n">dfs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">data1</span><span class="o">.</span><span class="n">dfs</span><span class="p">)</span>
</span><span id="clone_path_prepare_data-1303"><a href="#clone_path_prepare_data-1303"><span class="linenos">1303</span></a>    <span class="n">data_clone</span><span class="o">.</span><span class="n">robs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">robs</span><span class="p">[:,[</span><span class="n">cc</span><span class="p">]]),</span> <span class="n">num_clones</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="clone_path_prepare_data-1304"><a href="#clone_path_prepare_data-1304"><span class="linenos">1304</span></a>    <span class="n">data_clone</span><span class="o">.</span><span class="n">dfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dfs</span><span class="p">[:,[</span><span class="n">cc</span><span class="p">]]),</span> <span class="n">num_clones</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="clone_path_prepare_data-1305"><a href="#clone_path_prepare_data-1305"><span class="linenos">1305</span></a>    <span class="n">data1</span><span class="o">.</span><span class="n">set_cells</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
</span><span id="clone_path_prepare_data-1306"><a href="#clone_path_prepare_data-1306"><span class="linenos">1306</span></a>
</span><span id="clone_path_prepare_data-1307"><a href="#clone_path_prepare_data-1307"><span class="linenos">1307</span></a>    <span class="c1"># Add drift capacities and calc drift model</span>
</span><span id="clone_path_prepare_data-1308"><a href="#clone_path_prepare_data-1308"><span class="linenos">1308</span></a>    <span class="n">block_length</span> <span class="o">=</span> <span class="mi">3600</span>  <span class="c1"># 60 sec</span>
</span><span id="clone_path_prepare_data-1309"><a href="#clone_path_prepare_data-1309"><span class="linenos">1309</span></a>    <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">data_clone</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">block_length</span><span class="p">)</span>
</span><span id="clone_path_prepare_data-1310"><a href="#clone_path_prepare_data-1310"><span class="linenos">1310</span></a>    <span class="n">drift_tents</span> <span class="o">=</span> <span class="n">data_clone</span><span class="o">.</span><span class="n">design_matrix_drift</span><span class="p">(</span>
</span><span id="clone_path_prepare_data-1311"><a href="#clone_path_prepare_data-1311"><span class="linenos">1311</span></a>        <span class="n">data_clone</span><span class="o">.</span><span class="n">NT</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">zero_left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zero_right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">const_right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="clone_path_prepare_data-1312"><a href="#clone_path_prepare_data-1312"><span class="linenos">1312</span></a>    <span class="n">data_clone</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">drift_tents</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="clone_path_prepare_data-1313"><a href="#clone_path_prepare_data-1313"><span class="linenos">1313</span></a>    <span class="n">data1</span><span class="o">.</span><span class="n">Xdrift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">drift_tents</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="clone_path_prepare_data-1314"><a href="#clone_path_prepare_data-1314"><span class="linenos">1314</span></a>    <span class="n">NA</span> <span class="o">=</span> <span class="n">drift_tents</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="clone_path_prepare_data-1315"><a href="#clone_path_prepare_data-1315"><span class="linenos">1315</span></a>
</span><span id="clone_path_prepare_data-1316"><a href="#clone_path_prepare_data-1316"><span class="linenos">1316</span></a>    <span class="c1"># Make tent-basis stim for clone model LL extraction (with-tent-basis thing)</span>
</span><span id="clone_path_prepare_data-1317"><a href="#clone_path_prepare_data-1317"><span class="linenos">1317</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">base_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">nlags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="clone_path_prepare_data-1318"><a href="#clone_path_prepare_data-1318"><span class="linenos">1318</span></a>        <span class="n">Xstim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bxt,tf-&gt;bxf&#39;</span><span class="p">,</span> 
</span><span id="clone_path_prepare_data-1319"><a href="#clone_path_prepare_data-1319"><span class="linenos">1319</span></a>                             <span class="n">data_clone</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">NX</span><span class="p">,</span><span class="n">old_nlags</span><span class="p">]),</span> 
</span><span id="clone_path_prepare_data-1320"><a href="#clone_path_prepare_data-1320"><span class="linenos">1320</span></a>                             <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">TB</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="p">)</span>
</span><span id="clone_path_prepare_data-1321"><a href="#clone_path_prepare_data-1321"><span class="linenos">1321</span></a>        <span class="n">data_clone</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">Xstim</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">data_clone</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="clone_path_prepare_data-1322"><a href="#clone_path_prepare_data-1322"><span class="linenos">1322</span></a>        <span class="n">data_clone</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_tk</span>
</span><span id="clone_path_prepare_data-1323"><a href="#clone_path_prepare_data-1323"><span class="linenos">1323</span></a>
</span><span id="clone_path_prepare_data-1324"><a href="#clone_path_prepare_data-1324"><span class="linenos">1324</span></a>    <span class="c1"># Calculate LLs because why-not: need it but dont need drift models after that</span>
</span><span id="clone_path_prepare_data-1325"><a href="#clone_path_prepare_data-1325"><span class="linenos">1325</span></a>    <span class="n">train_ds</span> <span class="o">=</span> <span class="n">GenericDataset</span><span class="p">(</span><span class="n">data_clone</span><span class="p">[</span><span class="n">data_clone</span><span class="o">.</span><span class="n">train_inds</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="clone_path_prepare_data-1326"><a href="#clone_path_prepare_data-1326"><span class="linenos">1326</span></a>
</span><span id="clone_path_prepare_data-1327"><a href="#clone_path_prepare_data-1327"><span class="linenos">1327</span></a>    <span class="n">drift_pars1N</span> <span class="o">=</span> <span class="n">NDNLayer</span><span class="o">.</span><span class="n">layer_dict</span><span class="p">(</span> 
</span><span id="clone_path_prepare_data-1328"><a href="#clone_path_prepare_data-1328"><span class="linenos">1328</span></a>        <span class="n">input_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">NA</span><span class="p">],</span> <span class="n">num_filters</span><span class="o">=</span><span class="n">num_clones</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
</span><span id="clone_path_prepare_data-1329"><a href="#clone_path_prepare_data-1329"><span class="linenos">1329</span></a>        <span class="n">NLtype</span><span class="o">=</span><span class="s1">&#39;softplus&#39;</span><span class="p">,</span> <span class="n">reg_vals</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;d2t&#39;</span><span class="p">:</span> <span class="n">Dreg</span><span class="p">,</span> <span class="s1">&#39;bcs&#39;</span><span class="p">:{</span><span class="s1">&#39;d2t&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</span><span id="clone_path_prepare_data-1330"><a href="#clone_path_prepare_data-1330"><span class="linenos">1330</span></a>    <span class="n">drift_mod</span> <span class="o">=</span> <span class="n">NDN</span><span class="p">(</span><span class="n">layer_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">drift_pars1N</span><span class="p">],</span> <span class="n">loss_type</span><span class="o">=</span><span class="s1">&#39;poisson&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="clone_path_prepare_data-1331"><a href="#clone_path_prepare_data-1331"><span class="linenos">1331</span></a>    <span class="n">drift_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xstim_n</span> <span class="o">=</span> <span class="s1">&#39;Xdrift&#39;</span>
</span><span id="clone_path_prepare_data-1332"><a href="#clone_path_prepare_data-1332"><span class="linenos">1332</span></a>    <span class="n">utils</span><span class="o">.</span><span class="n">fit_lbfgs</span><span class="p">(</span> <span class="n">drift_mod</span><span class="p">,</span> <span class="n">train_ds</span><span class="p">[:],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="clone_path_prepare_data-1333"><a href="#clone_path_prepare_data-1333"><span class="linenos">1333</span></a>    <span class="n">drift_mod</span> <span class="o">=</span> <span class="n">drift_mod</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="clone_path_prepare_data-1334"><a href="#clone_path_prepare_data-1334"><span class="linenos">1334</span></a>    <span class="n">LLnull</span> <span class="o">=</span> <span class="n">drift_mod</span><span class="o">.</span><span class="n">eval_models</span><span class="p">(</span><span class="n">data_clone</span><span class="p">[</span><span class="n">data1</span><span class="o">.</span><span class="n">val_indsA</span><span class="p">],</span> <span class="n">null_adjusted</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="clone_path_prepare_data-1335"><a href="#clone_path_prepare_data-1335"><span class="linenos">1335</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  c</span><span class="si">%d</span><span class="s1">: LLnull = </span><span class="si">%0.6f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">LLnull</span><span class="p">))</span>
</span><span id="clone_path_prepare_data-1336"><a href="#clone_path_prepare_data-1336"><span class="linenos">1336</span></a>    <span class="n">drift_terms</span> <span class="o">=</span> <span class="n">drift_mod</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="clone_path_prepare_data-1337"><a href="#clone_path_prepare_data-1337"><span class="linenos">1337</span></a>
</span><span id="clone_path_prepare_data-1338"><a href="#clone_path_prepare_data-1338"><span class="linenos">1338</span></a>    <span class="n">clone_path_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;drift_terms&#39;</span><span class="p">:</span> <span class="n">drift_terms</span><span class="p">,</span> <span class="s1">&#39;LLnull&#39;</span><span class="p">:</span> <span class="n">LLnull</span><span class="p">,</span> <span class="s1">&#39;num_lags&#39;</span><span class="p">:</span> <span class="n">nlags</span><span class="p">}</span>
</span><span id="clone_path_prepare_data-1339"><a href="#clone_path_prepare_data-1339"><span class="linenos">1339</span></a>    <span class="k">if</span> <span class="n">base_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="clone_path_prepare_data-1340"><a href="#clone_path_prepare_data-1340"><span class="linenos">1340</span></a>        <span class="c1"># Calculate LLs of original model before converting </span>
</span><span id="clone_path_prepare_data-1341"><a href="#clone_path_prepare_data-1341"><span class="linenos">1341</span></a>        <span class="n">LLs0</span> <span class="o">=</span> <span class="n">LLnull</span><span class="o">-</span><span class="n">base_model</span><span class="o">.</span><span class="n">eval_models</span><span class="p">(</span><span class="n">data_clone</span><span class="p">[</span><span class="n">data1</span><span class="o">.</span><span class="n">val_indsA</span><span class="p">],</span> <span class="n">null_adjusted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="clone_path_prepare_data-1342"><a href="#clone_path_prepare_data-1342"><span class="linenos">1342</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  LLs0 original clone mean:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">LLs0</span><span class="p">))</span>
</span><span id="clone_path_prepare_data-1343"><a href="#clone_path_prepare_data-1343"><span class="linenos">1343</span></a>        <span class="k">del</span> <span class="n">train_ds</span>
</span><span id="clone_path_prepare_data-1344"><a href="#clone_path_prepare_data-1344"><span class="linenos">1344</span></a>        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>    
</span><span id="clone_path_prepare_data-1345"><a href="#clone_path_prepare_data-1345"><span class="linenos">1345</span></a>        
</span><span id="clone_path_prepare_data-1346"><a href="#clone_path_prepare_data-1346"><span class="linenos">1346</span></a>        <span class="k">if</span> <span class="n">check_performance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="clone_path_prepare_data-1347"><a href="#clone_path_prepare_data-1347"><span class="linenos">1347</span></a>            <span class="n">_</span> <span class="o">=</span> <span class="n">bmp_check</span><span class="p">(</span> <span class="n">base_model</span><span class="p">,</span> <span class="n">data_clone</span><span class="p">,</span> <span class="n">LLs0</span><span class="p">,</span> <span class="n">check_performance</span> <span class="p">)</span> 
</span><span id="clone_path_prepare_data-1348"><a href="#clone_path_prepare_data-1348"><span class="linenos">1348</span></a>        
</span><span id="clone_path_prepare_data-1349"><a href="#clone_path_prepare_data-1349"><span class="linenos">1349</span></a>        <span class="c1"># Convert dataset back to handle spatiotemporal</span>
</span><span id="clone_path_prepare_data-1350"><a href="#clone_path_prepare_data-1350"><span class="linenos">1350</span></a>        <span class="k">if</span> <span class="n">nlags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="clone_path_prepare_data-1351"><a href="#clone_path_prepare_data-1351"><span class="linenos">1351</span></a>            <span class="n">data_clone</span><span class="o">.</span><span class="n">stim</span> <span class="o">=</span> <span class="n">data1</span><span class="o">.</span><span class="n">stim</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="clone_path_prepare_data-1352"><a href="#clone_path_prepare_data-1352"><span class="linenos">1352</span></a>            <span class="n">data_clone</span><span class="o">.</span><span class="n">stim_dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlags</span>
</span><span id="clone_path_prepare_data-1353"><a href="#clone_path_prepare_data-1353"><span class="linenos">1353</span></a>
</span><span id="clone_path_prepare_data-1354"><a href="#clone_path_prepare_data-1354"><span class="linenos">1354</span></a>            <span class="n">base_model</span> <span class="o">=</span> <span class="n">convert2ST</span><span class="p">(</span> <span class="n">base_model</span><span class="p">,</span> <span class="n">TB</span><span class="p">,</span> <span class="n">nlags</span> <span class="p">)</span>  <span class="c1"># note this will not be normalized correctly</span>
</span><span id="clone_path_prepare_data-1355"><a href="#clone_path_prepare_data-1355"><span class="linenos">1355</span></a>
</span><span id="clone_path_prepare_data-1356"><a href="#clone_path_prepare_data-1356"><span class="linenos">1356</span></a>        <span class="n">clone_path_info</span><span class="p">[</span><span class="s1">&#39;base_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_model</span> 
</span><span id="clone_path_prepare_data-1357"><a href="#clone_path_prepare_data-1357"><span class="linenos">1357</span></a>        <span class="n">clone_path_info</span><span class="p">[</span><span class="s1">&#39;LLs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LLs0</span>
</span><span id="clone_path_prepare_data-1358"><a href="#clone_path_prepare_data-1358"><span class="linenos">1358</span></a>    
</span><span id="clone_path_prepare_data-1359"><a href="#clone_path_prepare_data-1359"><span class="linenos">1359</span></a>    <span class="k">return</span> <span class="n">data_clone</span><span class="p">,</span> <span class="n">data1</span><span class="p">,</span> <span class="n">clone_path_info</span>
</span></pre></div>


            <div class="docstring"><p>Load dataset and clone model from respective directories for regularization
So also translates models into 
Uses already-defined datadir and dirname respectively</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>ee:</strong>  expt number starting with zero</li>
<li><strong>cc:</strong>  cell number starting with zero</li>
<li><strong>TB:</strong>  temporal bases used to fit clones</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>data_clone: dataset made to fit clone models
  data1: dataset made to fit single copy of cell
  clone_path_info: dictionary with the following info (if applicable)
      LLnull: null model LL computed by fitting drift model
      drift_terms: drift terms for number of clones specified
      base_model: base clone model with spatiotemporal filters and nlags, if included
      LLs: null-adjusted LLs of clone model, if included</p>
</blockquote>
</div>


                </section>
                <section id="spatiotemporal_box_std">
                            <input id="spatiotemporal_box_std-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">spatiotemporal_box_std</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">filts</span>,</span><span class="param">	<span class="n">t_edge</span>,</span><span class="param">	<span class="n">x_edge</span>,</span><span class="param">	<span class="n">filt_ns</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">to_plot</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">display_cc</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">subplot_info</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="spatiotemporal_box_std-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#spatiotemporal_box_std"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="spatiotemporal_box_std-1362"><a href="#spatiotemporal_box_std-1362"><span class="linenos">1362</span></a><span class="k">def</span> <span class="nf">spatiotemporal_box_std</span><span class="p">(</span> <span class="n">filts</span><span class="p">,</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">filt_ns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">display_cc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subplot_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="spatiotemporal_box_std-1363"><a href="#spatiotemporal_box_std-1363"><span class="linenos">1363</span></a>    <span class="n">nx</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">nf</span> <span class="o">=</span> <span class="n">filts</span><span class="o">.</span><span class="n">shape</span>
</span><span id="spatiotemporal_box_std-1364"><a href="#spatiotemporal_box_std-1364"><span class="linenos">1364</span></a>    <span class="k">if</span> <span class="n">filt_ns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="spatiotemporal_box_std-1365"><a href="#spatiotemporal_box_std-1365"><span class="linenos">1365</span></a>        <span class="n">filt_ns</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">nf</span><span class="p">)</span>
</span><span id="spatiotemporal_box_std-1366"><a href="#spatiotemporal_box_std-1366"><span class="linenos">1366</span></a>    <span class="n">ks</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">filts</span><span class="p">[:,:,</span><span class="n">filt_ns</span><span class="p">])</span>
</span><span id="spatiotemporal_box_std-1367"><a href="#spatiotemporal_box_std-1367"><span class="linenos">1367</span></a>    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ks</span><span class="p">))</span>
</span><span id="spatiotemporal_box_std-1368"><a href="#spatiotemporal_box_std-1368"><span class="linenos">1368</span></a>    <span class="n">tlags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nt</span><span class="o">-</span><span class="n">t_edge</span><span class="p">,</span> <span class="n">nt</span><span class="p">)</span>
</span><span id="spatiotemporal_box_std-1369"><a href="#spatiotemporal_box_std-1369"><span class="linenos">1369</span></a>    <span class="c1">#print(tlags)</span>
</span><span id="spatiotemporal_box_std-1370"><a href="#spatiotemporal_box_std-1370"><span class="linenos">1370</span></a>    <span class="n">box1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x_edge</span><span class="p">)</span>
</span><span id="spatiotemporal_box_std-1371"><a href="#spatiotemporal_box_std-1371"><span class="linenos">1371</span></a>    <span class="n">box2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="n">x_edge</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
</span><span id="spatiotemporal_box_std-1372"><a href="#spatiotemporal_box_std-1372"><span class="linenos">1372</span></a>    <span class="c1">#print(box1,box2)</span>
</span><span id="spatiotemporal_box_std-1373"><a href="#spatiotemporal_box_std-1373"><span class="linenos">1373</span></a>    <span class="n">stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ks</span><span class="p">[:,</span><span class="n">tlags</span><span class="p">,:][</span><span class="n">box1</span><span class="p">,:,:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ks</span><span class="p">[:,</span><span class="n">tlags</span><span class="p">,:][</span><span class="n">box2</span><span class="p">,:,:])])</span>
</span><span id="spatiotemporal_box_std-1374"><a href="#spatiotemporal_box_std-1374"><span class="linenos">1374</span></a>    <span class="c1">#print(stds,m)</span>
</span><span id="spatiotemporal_box_std-1375"><a href="#spatiotemporal_box_std-1375"><span class="linenos">1375</span></a>    <span class="k">if</span> <span class="n">to_plot</span><span class="p">:</span>
</span><span id="spatiotemporal_box_std-1376"><a href="#spatiotemporal_box_std-1376"><span class="linenos">1376</span></a>        <span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">patches</span>
</span><span id="spatiotemporal_box_std-1377"><a href="#spatiotemporal_box_std-1377"><span class="linenos">1377</span></a>        <span class="k">if</span> <span class="n">display_cc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="spatiotemporal_box_std-1378"><a href="#spatiotemporal_box_std-1378"><span class="linenos">1378</span></a>            <span class="n">utils</span><span class="o">.</span><span class="n">ss</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
</span><span id="spatiotemporal_box_std-1379"><a href="#spatiotemporal_box_std-1379"><span class="linenos">1379</span></a>            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filt_ns</span><span class="p">)):</span>
</span><span id="spatiotemporal_box_std-1380"><a href="#spatiotemporal_box_std-1380"><span class="linenos">1380</span></a>                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="spatiotemporal_box_std-1381"><a href="#spatiotemporal_box_std-1381"><span class="linenos">1381</span></a>                <span class="n">utils</span><span class="o">.</span><span class="n">imagesc</span><span class="p">(</span><span class="n">ks</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ii</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
</span><span id="spatiotemporal_box_std-1382"><a href="#spatiotemporal_box_std-1382"><span class="linenos">1382</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
</span><span id="spatiotemporal_box_std-1383"><a href="#spatiotemporal_box_std-1383"><span class="linenos">1383</span></a>                    <span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">tlags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">))</span>
</span><span id="spatiotemporal_box_std-1384"><a href="#spatiotemporal_box_std-1384"><span class="linenos">1384</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
</span><span id="spatiotemporal_box_std-1385"><a href="#spatiotemporal_box_std-1385"><span class="linenos">1385</span></a>                    <span class="p">(</span><span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">tlags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">))</span>
</span><span id="spatiotemporal_box_std-1386"><a href="#spatiotemporal_box_std-1386"><span class="linenos">1386</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="spatiotemporal_box_std-1387"><a href="#spatiotemporal_box_std-1387"><span class="linenos">1387</span></a>
</span><span id="spatiotemporal_box_std-1388"><a href="#spatiotemporal_box_std-1388"><span class="linenos">1388</span></a>    <span class="k">return</span> <span class="n">stds</span><span class="o">/</span><span class="n">m</span>
</span></pre></div>


    

                </section>
                <section id="spatiotemporal_std_display">
                            <input id="spatiotemporal_std_display-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">spatiotemporal_std_display</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">filt2d</span>, </span><span class="param"><span class="n">t_edge</span>, </span><span class="param"><span class="n">x_edge</span>, </span><span class="param"><span class="n">ax_handle</span>, </span><span class="param"><span class="n">display_norm</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="spatiotemporal_std_display-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#spatiotemporal_std_display"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="spatiotemporal_std_display-1391"><a href="#spatiotemporal_std_display-1391"><span class="linenos">1391</span></a><span class="k">def</span> <span class="nf">spatiotemporal_std_display</span><span class="p">(</span> <span class="n">filt2d</span><span class="p">,</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">ax_handle</span><span class="p">,</span> <span class="n">display_norm</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="spatiotemporal_std_display-1392"><a href="#spatiotemporal_std_display-1392"><span class="linenos">1392</span></a>    <span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">patches</span>
</span><span id="spatiotemporal_std_display-1393"><a href="#spatiotemporal_std_display-1393"><span class="linenos">1393</span></a>    <span class="k">if</span> <span class="n">display_norm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="spatiotemporal_std_display-1394"><a href="#spatiotemporal_std_display-1394"><span class="linenos">1394</span></a>        <span class="n">display_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">filt2d</span><span class="p">))</span>
</span><span id="spatiotemporal_std_display-1395"><a href="#spatiotemporal_std_display-1395"><span class="linenos">1395</span></a>    <span class="n">nx</span><span class="p">,</span><span class="n">nt</span> <span class="o">=</span> <span class="n">filt2d</span><span class="o">.</span><span class="n">shape</span>
</span><span id="spatiotemporal_std_display-1396"><a href="#spatiotemporal_std_display-1396"><span class="linenos">1396</span></a>    <span class="n">tlags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nt</span><span class="o">-</span><span class="n">t_edge</span><span class="p">,</span> <span class="n">nt</span><span class="p">)</span>
</span><span id="spatiotemporal_std_display-1397"><a href="#spatiotemporal_std_display-1397"><span class="linenos">1397</span></a>    <span class="n">box1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x_edge</span><span class="p">)</span>
</span><span id="spatiotemporal_std_display-1398"><a href="#spatiotemporal_std_display-1398"><span class="linenos">1398</span></a>    <span class="n">box2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="n">x_edge</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
</span><span id="spatiotemporal_std_display-1399"><a href="#spatiotemporal_std_display-1399"><span class="linenos">1399</span></a>
</span><span id="spatiotemporal_std_display-1400"><a href="#spatiotemporal_std_display-1400"><span class="linenos">1400</span></a>    <span class="n">utils</span><span class="o">.</span><span class="n">imagesc</span><span class="p">(</span><span class="n">filt2d</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">display_norm</span><span class="p">)</span>
</span><span id="spatiotemporal_std_display-1401"><a href="#spatiotemporal_std_display-1401"><span class="linenos">1401</span></a>    <span class="n">ax_handle</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
</span><span id="spatiotemporal_std_display-1402"><a href="#spatiotemporal_std_display-1402"><span class="linenos">1402</span></a>        <span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">tlags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">))</span>
</span><span id="spatiotemporal_std_display-1403"><a href="#spatiotemporal_std_display-1403"><span class="linenos">1403</span></a>    <span class="n">ax_handle</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
</span><span id="spatiotemporal_std_display-1404"><a href="#spatiotemporal_std_display-1404"><span class="linenos">1404</span></a>        <span class="p">(</span><span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">tlags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">))</span>
</span></pre></div>


    

                </section>
                <section id="smoothness_select">
                            <input id="smoothness_select-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">smoothness_select</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">reg_info</span>, </span><span class="param"><span class="n">t_edge</span><span class="o">=</span><span class="mi">6</span>, </span><span class="param"><span class="n">x_edge</span><span class="o">=</span><span class="mi">6</span>, </span><span class="param"><span class="n">display_n</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="smoothness_select-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#smoothness_select"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="smoothness_select-1407"><a href="#smoothness_select-1407"><span class="linenos">1407</span></a><span class="k">def</span> <span class="nf">smoothness_select</span><span class="p">(</span> <span class="n">reg_info</span><span class="p">,</span> <span class="n">t_edge</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">x_edge</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">display_n</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="smoothness_select-1408"><a href="#smoothness_select-1408"><span class="linenos">1408</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="smoothness_select-1409"><a href="#smoothness_select-1409"><span class="linenos">1409</span></a><span class="sd">    Selects best smoothness based on where transition occurs rather than maximizing LL </span>
</span><span id="smoothness_select-1410"><a href="#smoothness_select-1410"><span class="linenos">1410</span></a><span class="sd">    &quot;&quot;&quot;</span>        
</span><span id="smoothness_select-1411"><a href="#smoothness_select-1411"><span class="linenos">1411</span></a>    <span class="n">num_regs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_info</span><span class="p">[</span><span class="s1">&#39;LLsR&#39;</span><span class="p">])</span>
</span><span id="smoothness_select-1412"><a href="#smoothness_select-1412"><span class="linenos">1412</span></a>    <span class="n">stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_regs</span><span class="p">)</span>
</span><span id="smoothness_select-1413"><a href="#smoothness_select-1413"><span class="linenos">1413</span></a>    <span class="n">ws</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="smoothness_select-1414"><a href="#smoothness_select-1414"><span class="linenos">1414</span></a>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_regs</span><span class="p">):</span>
</span><span id="smoothness_select-1415"><a href="#smoothness_select-1415"><span class="linenos">1415</span></a>        <span class="n">ws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_info</span><span class="p">[</span><span class="s1">&#39;Rmods&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">get_weights</span><span class="p">())</span>
</span><span id="smoothness_select-1416"><a href="#smoothness_select-1416"><span class="linenos">1416</span></a>        <span class="n">stds</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">spatiotemporal_box_std</span><span class="p">(</span><span class="n">ws</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">to_plot</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span> 
</span><span id="smoothness_select-1417"><a href="#smoothness_select-1417"><span class="linenos">1417</span></a>    <span class="n">thresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="n">stds</span><span class="p">),</span><span class="nb">min</span><span class="p">(</span><span class="n">stds</span><span class="p">)])</span> 
</span><span id="smoothness_select-1418"><a href="#smoothness_select-1418"><span class="linenos">1418</span></a>    <span class="n">reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stds</span> <span class="o">&lt;</span> <span class="n">thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="smoothness_select-1419"><a href="#smoothness_select-1419"><span class="linenos">1419</span></a>    <span class="n">Xreg</span> <span class="o">=</span> <span class="n">reg_info</span><span class="p">[</span><span class="s1">&#39;reg_vals&#39;</span><span class="p">][</span><span class="n">reg</span><span class="p">]</span>
</span><span id="smoothness_select-1420"><a href="#smoothness_select-1420"><span class="linenos">1420</span></a>    
</span><span id="smoothness_select-1421"><a href="#smoothness_select-1421"><span class="linenos">1421</span></a>    <span class="c1"># STATUS DISPLAY</span>
</span><span id="smoothness_select-1422"><a href="#smoothness_select-1422"><span class="linenos">1422</span></a>    <span class="k">if</span> <span class="n">display_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="smoothness_select-1423"><a href="#smoothness_select-1423"><span class="linenos">1423</span></a>        <span class="n">NF</span> <span class="o">=</span> <span class="n">ws</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="smoothness_select-1424"><a href="#smoothness_select-1424"><span class="linenos">1424</span></a>        <span class="n">utils</span><span class="o">.</span><span class="n">ss</span><span class="p">(</span><span class="n">NF</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">rh</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="smoothness_select-1425"><a href="#smoothness_select-1425"><span class="linenos">1425</span></a>        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NF</span><span class="p">):</span>
</span><span id="smoothness_select-1426"><a href="#smoothness_select-1426"><span class="linenos">1426</span></a>            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">NF</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="n">ii</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
</span><span id="smoothness_select-1427"><a href="#smoothness_select-1427"><span class="linenos">1427</span></a>            <span class="n">spatiotemporal_std_display</span><span class="p">(</span> <span class="n">ws</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">display_n</span><span class="p">],</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">ax</span> <span class="p">)</span>
</span><span id="smoothness_select-1428"><a href="#smoothness_select-1428"><span class="linenos">1428</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Lowest d2x-reg&#39;</span><span class="p">)</span>
</span><span id="smoothness_select-1429"><a href="#smoothness_select-1429"><span class="linenos">1429</span></a>            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">NF</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="o">+</span><span class="n">ii</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
</span><span id="smoothness_select-1430"><a href="#smoothness_select-1430"><span class="linenos">1430</span></a>            <span class="n">spatiotemporal_std_display</span><span class="p">(</span> <span class="n">ws</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">display_n</span><span class="p">],</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">ax</span> <span class="p">)</span>
</span><span id="smoothness_select-1431"><a href="#smoothness_select-1431"><span class="linenos">1431</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Highest d2x-reg&#39;</span><span class="p">)</span>
</span><span id="smoothness_select-1432"><a href="#smoothness_select-1432"><span class="linenos">1432</span></a>            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">NF</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="o">+</span><span class="n">ii</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
</span><span id="smoothness_select-1433"><a href="#smoothness_select-1433"><span class="linenos">1433</span></a>            <span class="n">spatiotemporal_std_display</span><span class="p">(</span> <span class="n">ws</span><span class="p">[</span><span class="n">reg</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">display_n</span><span class="p">],</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">ax</span> <span class="p">)</span>
</span><span id="smoothness_select-1434"><a href="#smoothness_select-1434"><span class="linenos">1434</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Chosen d2x-reg&#39;</span><span class="p">)</span>
</span><span id="smoothness_select-1435"><a href="#smoothness_select-1435"><span class="linenos">1435</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="smoothness_select-1436"><a href="#smoothness_select-1436"><span class="linenos">1436</span></a>        <span class="n">utils</span><span class="o">.</span><span class="n">ss</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">rh</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="smoothness_select-1437"><a href="#smoothness_select-1437"><span class="linenos">1437</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="smoothness_select-1438"><a href="#smoothness_select-1438"><span class="linenos">1438</span></a>        <span class="n">spatiotemporal_std_display</span><span class="p">(</span> <span class="n">ws</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">display_n</span><span class="p">],</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">ax</span> <span class="p">)</span>
</span><span id="smoothness_select-1439"><a href="#smoothness_select-1439"><span class="linenos">1439</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Lowest d2x-reg&#39;</span><span class="p">)</span>
</span><span id="smoothness_select-1440"><a href="#smoothness_select-1440"><span class="linenos">1440</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span id="smoothness_select-1441"><a href="#smoothness_select-1441"><span class="linenos">1441</span></a>        <span class="n">spatiotemporal_std_display</span><span class="p">(</span> <span class="n">ws</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">display_n</span><span class="p">],</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">ax</span> <span class="p">)</span>
</span><span id="smoothness_select-1442"><a href="#smoothness_select-1442"><span class="linenos">1442</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Highest d2x-reg&#39;</span><span class="p">)</span>
</span><span id="smoothness_select-1443"><a href="#smoothness_select-1443"><span class="linenos">1443</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span><span id="smoothness_select-1444"><a href="#smoothness_select-1444"><span class="linenos">1444</span></a>        <span class="n">spatiotemporal_std_display</span><span class="p">(</span> <span class="n">ws</span><span class="p">[</span><span class="n">reg</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">display_n</span><span class="p">],</span> <span class="n">t_edge</span><span class="p">,</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">ax</span> <span class="p">)</span>
</span><span id="smoothness_select-1445"><a href="#smoothness_select-1445"><span class="linenos">1445</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Chosen d2x-reg&#39;</span><span class="p">)</span>
</span><span id="smoothness_select-1446"><a href="#smoothness_select-1446"><span class="linenos">1446</span></a>        <span class="n">NF</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="smoothness_select-1447"><a href="#smoothness_select-1447"><span class="linenos">1447</span></a>
</span><span id="smoothness_select-1448"><a href="#smoothness_select-1448"><span class="linenos">1448</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">NF</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span><span id="smoothness_select-1449"><a href="#smoothness_select-1449"><span class="linenos">1449</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stds</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
</span><span id="smoothness_select-1450"><a href="#smoothness_select-1450"><span class="linenos">1450</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stds</span><span class="p">,</span><span class="s1">&#39;b.&#39;</span><span class="p">)</span>
</span><span id="smoothness_select-1451"><a href="#smoothness_select-1451"><span class="linenos">1451</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span><span class="n">stds</span><span class="p">[</span><span class="n">reg</span><span class="p">],</span><span class="s1">&#39;go&#39;</span><span class="p">)</span>
</span><span id="smoothness_select-1452"><a href="#smoothness_select-1452"><span class="linenos">1452</span></a>    <span class="n">xs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()</span>
</span><span id="smoothness_select-1453"><a href="#smoothness_select-1453"><span class="linenos">1453</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">thresh</span><span class="p">,</span><span class="s1">&#39;r--&#39;</span><span class="p">)</span>
</span><span id="smoothness_select-1454"><a href="#smoothness_select-1454"><span class="linenos">1454</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Box stdevs&#39;</span><span class="p">)</span>
</span><span id="smoothness_select-1455"><a href="#smoothness_select-1455"><span class="linenos">1455</span></a>
</span><span id="smoothness_select-1456"><a href="#smoothness_select-1456"><span class="linenos">1456</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">NF</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</span><span id="smoothness_select-1457"><a href="#smoothness_select-1457"><span class="linenos">1457</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">reg_info</span><span class="p">[</span><span class="s1">&#39;LLsR&#39;</span><span class="p">],</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
</span><span id="smoothness_select-1458"><a href="#smoothness_select-1458"><span class="linenos">1458</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">reg_info</span><span class="p">[</span><span class="s1">&#39;LLsR&#39;</span><span class="p">],</span><span class="s1">&#39;b.&#39;</span><span class="p">)</span>
</span><span id="smoothness_select-1459"><a href="#smoothness_select-1459"><span class="linenos">1459</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">reg_info</span><span class="p">[</span><span class="s1">&#39;LLsR&#39;</span><span class="p">][</span><span class="n">reg</span><span class="p">],</span><span class="s1">&#39;go&#39;</span><span class="p">)</span>
</span><span id="smoothness_select-1460"><a href="#smoothness_select-1460"><span class="linenos">1460</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;LLs&#39;</span><span class="p">)</span>
</span><span id="smoothness_select-1461"><a href="#smoothness_select-1461"><span class="linenos">1461</span></a>    <span class="n">xs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()</span>
</span><span id="smoothness_select-1462"><a href="#smoothness_select-1462"><span class="linenos">1462</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="smoothness_select-1463"><a href="#smoothness_select-1463"><span class="linenos">1463</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;d2xt reg:&#39;</span><span class="p">,</span> <span class="n">Xreg</span><span class="p">)</span>
</span><span id="smoothness_select-1464"><a href="#smoothness_select-1464"><span class="linenos">1464</span></a>    <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">reg_info</span><span class="p">[</span><span class="s1">&#39;Rmods&#39;</span><span class="p">][</span><span class="n">reg</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Selects best smoothness based on where transition occurs rather than maximizing LL</p>
</div>


                </section>
                <section id="binocular_filter_shift">
                            <input id="binocular_filter_shift-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">binocular_filter_shift</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">sico0</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="binocular_filter_shift-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#binocular_filter_shift"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="binocular_filter_shift-1467"><a href="#binocular_filter_shift-1467"><span class="linenos">1467</span></a><span class="k">def</span> <span class="nf">binocular_filter_shift</span><span class="p">(</span> <span class="n">sico0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="binocular_filter_shift-1468"><a href="#binocular_filter_shift-1468"><span class="linenos">1468</span></a>    <span class="kn">import</span> <span class="nn">torch</span>    
</span><span id="binocular_filter_shift-1469"><a href="#binocular_filter_shift-1469"><span class="linenos">1469</span></a>    <span class="n">wB</span> <span class="o">=</span> <span class="n">sico0</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(</span><span class="n">layer_target</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="binocular_filter_shift-1470"><a href="#binocular_filter_shift-1470"><span class="linenos">1470</span></a>    <span class="n">ni</span><span class="p">,</span> <span class="n">fw</span><span class="p">,</span> <span class="n">NBF</span> <span class="o">=</span> <span class="n">wB</span><span class="o">.</span><span class="n">shape</span>
</span><span id="binocular_filter_shift-1471"><a href="#binocular_filter_shift-1471"><span class="linenos">1471</span></a>    <span class="n">Nout</span> <span class="o">=</span> <span class="n">sico0</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="binocular_filter_shift-1472"><a href="#binocular_filter_shift-1472"><span class="linenos">1472</span></a>
</span><span id="binocular_filter_shift-1473"><a href="#binocular_filter_shift-1473"><span class="linenos">1473</span></a>    <span class="c1">#clrs=&#39;bgr&#39;</span>
</span><span id="binocular_filter_shift-1474"><a href="#binocular_filter_shift-1474"><span class="linenos">1474</span></a>    <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NBF</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="c1">#[0,0,0]</span>
</span><span id="binocular_filter_shift-1475"><a href="#binocular_filter_shift-1475"><span class="linenos">1475</span></a>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NBF</span><span class="p">):</span>
</span><span id="binocular_filter_shift-1476"><a href="#binocular_filter_shift-1476"><span class="linenos">1476</span></a>        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">wB</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ii</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="binocular_filter_shift-1477"><a href="#binocular_filter_shift-1477"><span class="linenos">1477</span></a>        <span class="n">shifts</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">fw</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dist</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dist</span><span class="p">)))</span>
</span><span id="binocular_filter_shift-1478"><a href="#binocular_filter_shift-1478"><span class="linenos">1478</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="binocular_filter_shift-1479"><a href="#binocular_filter_shift-1479"><span class="linenos">1479</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Binocular shifts:&#39;</span><span class="p">,</span> <span class="n">shifts</span><span class="p">)</span>
</span><span id="binocular_filter_shift-1480"><a href="#binocular_filter_shift-1480"><span class="linenos">1480</span></a>    
</span><span id="binocular_filter_shift-1481"><a href="#binocular_filter_shift-1481"><span class="linenos">1481</span></a>    <span class="c1"># Move the torch-weights</span>
</span><span id="binocular_filter_shift-1482"><a href="#binocular_filter_shift-1482"><span class="linenos">1482</span></a>    <span class="n">wB</span> <span class="o">=</span> <span class="n">sico0</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">ni</span><span class="p">,</span> <span class="n">fw</span><span class="p">,</span> <span class="n">NBF</span><span class="p">])</span>
</span><span id="binocular_filter_shift-1483"><a href="#binocular_filter_shift-1483"><span class="linenos">1483</span></a>    <span class="n">wB2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">wB</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="binocular_filter_shift-1484"><a href="#binocular_filter_shift-1484"><span class="linenos">1484</span></a>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NBF</span><span class="p">):</span>
</span><span id="binocular_filter_shift-1485"><a href="#binocular_filter_shift-1485"><span class="linenos">1485</span></a>        <span class="n">wB2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">wB</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="n">shifts</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="binocular_filter_shift-1486"><a href="#binocular_filter_shift-1486"><span class="linenos">1486</span></a>
</span><span id="binocular_filter_shift-1487"><a href="#binocular_filter_shift-1487"><span class="linenos">1487</span></a>    <span class="n">wR</span> <span class="o">=</span> <span class="n">sico0</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NBF</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nout</span><span class="p">])</span>
</span><span id="binocular_filter_shift-1488"><a href="#binocular_filter_shift-1488"><span class="linenos">1488</span></a>    <span class="n">wR2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">wR</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="binocular_filter_shift-1489"><a href="#binocular_filter_shift-1489"><span class="linenos">1489</span></a>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NBF</span><span class="p">):</span>
</span><span id="binocular_filter_shift-1490"><a href="#binocular_filter_shift-1490"><span class="linenos">1490</span></a>        <span class="n">wR2</span><span class="p">[</span><span class="n">ii</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">wR</span><span class="p">[</span><span class="n">ii</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">clone</span><span class="p">()),</span> <span class="o">-</span><span class="n">shifts</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="binocular_filter_shift-1491"><a href="#binocular_filter_shift-1491"><span class="linenos">1491</span></a>        
</span><span id="binocular_filter_shift-1492"><a href="#binocular_filter_shift-1492"><span class="linenos">1492</span></a>    <span class="n">sico1</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sico0</span><span class="p">)</span>
</span><span id="binocular_filter_shift-1493"><a href="#binocular_filter_shift-1493"><span class="linenos">1493</span></a>    <span class="n">sico1</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">wB2</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">NBF</span><span class="p">])</span>
</span><span id="binocular_filter_shift-1494"><a href="#binocular_filter_shift-1494"><span class="linenos">1494</span></a>    <span class="n">sico1</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">wR2</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">Nout</span><span class="p">])</span>
</span><span id="binocular_filter_shift-1495"><a href="#binocular_filter_shift-1495"><span class="linenos">1495</span></a>    <span class="k">return</span> <span class="n">sico1</span>
</span></pre></div>


    

                </section>
                <section id="monocular_filter_shift">
                            <input id="monocular_filter_shift-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">monocular_filter_shift</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">sico0</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="monocular_filter_shift-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#monocular_filter_shift"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="monocular_filter_shift-1499"><a href="#monocular_filter_shift-1499"><span class="linenos">1499</span></a><span class="k">def</span> <span class="nf">monocular_filter_shift</span><span class="p">(</span> <span class="n">sico0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="monocular_filter_shift-1500"><a href="#monocular_filter_shift-1500"><span class="linenos">1500</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="monocular_filter_shift-1501"><a href="#monocular_filter_shift-1501"><span class="linenos">1501</span></a><span class="sd">    Shifts the filters in the monocular layer, and adjusts the filters in the binocular layer as a result.</span>
</span><span id="monocular_filter_shift-1502"><a href="#monocular_filter_shift-1502"><span class="linenos">1502</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="monocular_filter_shift-1503"><a href="#monocular_filter_shift-1503"><span class="linenos">1503</span></a>    <span class="kn">import</span> <span class="nn">torch</span>    
</span><span id="monocular_filter_shift-1504"><a href="#monocular_filter_shift-1504"><span class="linenos">1504</span></a>    <span class="n">wM</span> <span class="o">=</span> <span class="n">sico0</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(</span><span class="n">layer_target</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="monocular_filter_shift-1505"><a href="#monocular_filter_shift-1505"><span class="linenos">1505</span></a>    <span class="n">fw</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">NMF</span> <span class="o">=</span> <span class="n">wM</span><span class="o">.</span><span class="n">shape</span>
</span><span id="monocular_filter_shift-1506"><a href="#monocular_filter_shift-1506"><span class="linenos">1506</span></a>    <span class="n">Nout</span> <span class="o">=</span> <span class="n">sico0</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="monocular_filter_shift-1507"><a href="#monocular_filter_shift-1507"><span class="linenos">1507</span></a>
</span><span id="monocular_filter_shift-1508"><a href="#monocular_filter_shift-1508"><span class="linenos">1508</span></a>    <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NMF</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="c1">#[0,0,0]</span>
</span><span id="monocular_filter_shift-1509"><a href="#monocular_filter_shift-1509"><span class="linenos">1509</span></a>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NMF</span><span class="p">):</span>
</span><span id="monocular_filter_shift-1510"><a href="#monocular_filter_shift-1510"><span class="linenos">1510</span></a>        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">wM</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ii</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="monocular_filter_shift-1511"><a href="#monocular_filter_shift-1511"><span class="linenos">1511</span></a>        <span class="n">shifts</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">fw</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dist</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dist</span><span class="p">)))</span>
</span><span id="monocular_filter_shift-1512"><a href="#monocular_filter_shift-1512"><span class="linenos">1512</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="monocular_filter_shift-1513"><a href="#monocular_filter_shift-1513"><span class="linenos">1513</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Monocular shifts:&#39;</span><span class="p">,</span> <span class="n">shifts</span><span class="p">)</span>
</span><span id="monocular_filter_shift-1514"><a href="#monocular_filter_shift-1514"><span class="linenos">1514</span></a>    
</span><span id="monocular_filter_shift-1515"><a href="#monocular_filter_shift-1515"><span class="linenos">1515</span></a>    <span class="c1"># Move the torch-weights</span>
</span><span id="monocular_filter_shift-1516"><a href="#monocular_filter_shift-1516"><span class="linenos">1516</span></a>    <span class="n">wM</span> <span class="o">=</span> <span class="n">sico0</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">fw</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">NMF</span><span class="p">])</span>
</span><span id="monocular_filter_shift-1517"><a href="#monocular_filter_shift-1517"><span class="linenos">1517</span></a>    <span class="n">wM2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">wM</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="monocular_filter_shift-1518"><a href="#monocular_filter_shift-1518"><span class="linenos">1518</span></a>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NMF</span><span class="p">):</span>
</span><span id="monocular_filter_shift-1519"><a href="#monocular_filter_shift-1519"><span class="linenos">1519</span></a>        <span class="n">wM2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">wM</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="n">shifts</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="monocular_filter_shift-1520"><a href="#monocular_filter_shift-1520"><span class="linenos">1520</span></a>
</span><span id="monocular_filter_shift-1521"><a href="#monocular_filter_shift-1521"><span class="linenos">1521</span></a>    <span class="n">wB</span> <span class="o">=</span> <span class="n">sico0</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">NMF</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nout</span><span class="p">])</span>
</span><span id="monocular_filter_shift-1522"><a href="#monocular_filter_shift-1522"><span class="linenos">1522</span></a>    <span class="n">wB2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">wB</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="monocular_filter_shift-1523"><a href="#monocular_filter_shift-1523"><span class="linenos">1523</span></a>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NMF</span><span class="p">):</span>
</span><span id="monocular_filter_shift-1524"><a href="#monocular_filter_shift-1524"><span class="linenos">1524</span></a>        <span class="n">wB2</span><span class="p">[</span><span class="n">ii</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">wB</span><span class="p">[</span><span class="n">ii</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">clone</span><span class="p">()),</span> <span class="o">-</span><span class="n">shifts</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="monocular_filter_shift-1525"><a href="#monocular_filter_shift-1525"><span class="linenos">1525</span></a>        
</span><span id="monocular_filter_shift-1526"><a href="#monocular_filter_shift-1526"><span class="linenos">1526</span></a>    <span class="n">sico1</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sico0</span><span class="p">)</span>
</span><span id="monocular_filter_shift-1527"><a href="#monocular_filter_shift-1527"><span class="linenos">1527</span></a>    <span class="n">sico1</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">wM2</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">NMF</span><span class="p">])</span>
</span><span id="monocular_filter_shift-1528"><a href="#monocular_filter_shift-1528"><span class="linenos">1528</span></a>    <span class="n">sico1</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">wB2</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nout</span><span class="p">])</span>
</span><span id="monocular_filter_shift-1529"><a href="#monocular_filter_shift-1529"><span class="linenos">1529</span></a>    <span class="k">return</span> <span class="n">sico1</span>
</span></pre></div>


            <div class="docstring"><p>Shifts the filters in the monocular layer, and adjusts the filters in the binocular layer as a result.</p>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>